<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"weiborao.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="This guide provides the steps on how to install CSR1000v&#x2F;Catalyst 8000v on KVM, the setting of SRIOV and KVM tuning.">
<meta property="og:type" content="article">
<meta property="og:title" content="Cisco CSR1000v KVM SRIOV Setting Guide on Ubuntu 20.04 With NetworkManager">
<meta property="og:url" content="https://weiborao.github.io/csr1kv-kvm-Ubuntu20-04-md.html">
<meta property="og:site_name" content="Rao Weibo的博客">
<meta property="og:description" content="This guide provides the steps on how to install CSR1000v&#x2F;Catalyst 8000v on KVM, the setting of SRIOV and KVM tuning.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://weiborao.github.io/csr1kv-kvm-Ubuntu20-04-md/pic1-sriov-pool.png">
<meta property="og:image" content="https://weiborao.github.io/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step1.png">
<meta property="og:image" content="https://weiborao.github.io/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step2.png">
<meta property="og:image" content="https://weiborao.github.io/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step2-2.png">
<meta property="og:image" content="https://weiborao.github.io/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step3.png">
<meta property="og:image" content="https://weiborao.github.io/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step4.png">
<meta property="og:image" content="https://weiborao.github.io/csr1kv-kvm-Ubuntu20-04-md/add-sriov-pool.png">
<meta property="og:image" content="https://weiborao.github.io/csr1kv-kvm-Ubuntu20-04-md/line-chart.png">
<meta property="article:published_time" content="2021-02-03T14:37:33.000Z">
<meta property="article:modified_time" content="2021-02-08T03:38:30.670Z">
<meta property="article:author" content="Rao Weibo">
<meta property="article:tag" content="CSR1000v">
<meta property="article:tag" content="KVM">
<meta property="article:tag" content="SRIOV">
<meta property="article:tag" content="NetworkManager">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://weiborao.github.io/csr1kv-kvm-Ubuntu20-04-md/pic1-sriov-pool.png">

<link rel="canonical" href="https://weiborao.github.io/csr1kv-kvm-Ubuntu20-04-md.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Cisco CSR1000v KVM SRIOV Setting Guide on Ubuntu 20.04 With NetworkManager | Rao Weibo的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Rao Weibo的博客" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Rao Weibo的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/weiborao" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://weiborao.github.io/csr1kv-kvm-Ubuntu20-04-md.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rao Weibo">
      <meta itemprop="description" content="记录一些工作、学习相关的笔记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rao Weibo的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Cisco CSR1000v KVM SRIOV Setting Guide on Ubuntu 20.04 With NetworkManager
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-02-03 22:37:33" itemprop="dateCreated datePublished" datetime="2021-02-03T22:37:33+08:00">2021-02-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-08 11:38:30" itemprop="dateModified" datetime="2021-02-08T11:38:30+08:00">2021-02-08</time>
              </span>

          
            <div class="post-description">This guide provides the steps on how to install CSR1000v/Catalyst 8000v on KVM, the setting of SRIOV and KVM tuning.</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>Last Update: February 3, 2021</p>
<p>Author: Rao Weibo</p>
<p>Version: 1.0</p>
<p>This guide provides the steps on how to install CSR1000v/Catalyst 8000v on KVM, the setting of SRIOV and KVM tuning.</p>
<h1 id="Ubuntu-20-04-Installation-and-Settings"><a href="#Ubuntu-20-04-Installation-and-Settings" class="headerlink" title="Ubuntu 20.04 Installation and Settings"></a>Ubuntu 20.04 Installation and Settings</h1><h2 id="1-BIOS-settings"><a href="#1-BIOS-settings" class="headerlink" title="(1) BIOS settings"></a>(1) BIOS settings</h2><table>
<thead>
<tr>
<th>Configuration</th>
<th>Recommended Setting</th>
</tr>
</thead>
<tbody><tr>
<td>Intel Hyper-Threading  Technology</td>
<td>Disabled</td>
</tr>
<tr>
<td>Number of Enable Cores</td>
<td>ALL</td>
</tr>
<tr>
<td>Execute Disable</td>
<td>Enabled</td>
</tr>
<tr>
<td><strong>Intel VT</strong></td>
<td><strong>Enabled</strong></td>
</tr>
<tr>
<td><strong>Intel VT-D</strong></td>
<td><strong>Enabled</strong></td>
</tr>
<tr>
<td>Intel VT-D coherency support</td>
<td>Enabled</td>
</tr>
<tr>
<td>Intel VT-D ATS support</td>
<td>Enabled</td>
</tr>
<tr>
<td>CPU Performance</td>
<td>High throughput</td>
</tr>
<tr>
<td>Hardware Perfetcher</td>
<td>Disabled</td>
</tr>
<tr>
<td>Adjacent Cache Line Prefetcher</td>
<td>Disabled</td>
</tr>
<tr>
<td>DCU Streamer Prefetch</td>
<td>Disable</td>
</tr>
<tr>
<td>Power Technology</td>
<td>Custom</td>
</tr>
<tr>
<td>Enhanced Intel Speedstep  Technology</td>
<td>Disabled</td>
</tr>
<tr>
<td>Intel Turbo Boost Technology</td>
<td>Enabled</td>
</tr>
<tr>
<td>Processor Power State C6</td>
<td>Disabled</td>
</tr>
<tr>
<td>Processor Power State C1 Enhanced</td>
<td>Disabled</td>
</tr>
<tr>
<td>Frequency Poor Override</td>
<td>Enabled</td>
</tr>
<tr>
<td>P-State Coordination</td>
<td>HW_ALL</td>
</tr>
<tr>
<td>Energy Performance</td>
<td>Performance</td>
</tr>
</tbody></table>
<p>The above settings are from the Installation guide from <a target="_blank" rel="noopener" href="https://www.cisco.com/c/en/us/td/docs/routers/csr1000/software/configuration/b_CSR1000v_Configuration_Guide/b_CSR1000v_Configuration_Guide_chapter_0101.html#con_1313827">Cisco CSR 1000v and Cisco ISRv Software Configuration Guide</a>.<br>Note: some platform such as <strong>Cisco NFVIS</strong>, does not disable the Hyper-Threading.</p>
<h2 id="2-Ubuntu-20-04-installation-tips"><a href="#2-Ubuntu-20-04-installation-tips" class="headerlink" title="(2) Ubuntu 20.04 installation tips"></a>(2) Ubuntu 20.04 installation tips</h2><p>If you need the Gnome GUI, you can install the Ubuntu 20.04 Desktop.<br>After the system bootup, <strong>‘apparmor’</strong> is recommended to be disabled, otherwise, you may meet <strong>permission denied</strong> when you assign SRIOV devices to the CSR1kV. You need to reboot to take effect.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl disable apparmor</span><br><span class="line">egrep -o &#x27;(vmx|svm)&#x27; /proc/cpuinfo | sort | uniq</span><br></pre></td></tr></table></figure>
<p>You can find the <strong>vmx</strong> on Intel platform, or <strong>svm</strong> on AMD platform.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop ufw</span><br><span class="line">systemctl disable ufw</span><br></pre></td></tr></table></figure>
<p><code>cat /etc/sysctl.conf</code></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 0</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 0</span><br><span class="line">net.bridge.bridge-nf-call-arptables = 0</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo apt install qemu-kvm libvirt-clients libvirt-daemon-system bridge-utils virt-manager numactl virt-top</span></span><br></pre></td></tr></table></figure>
<p>After installation, you can check the version</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ libvirtd -V</span><br><span class="line">libvirtd (libvirt) 6.0.0</span><br><span class="line">ubuntu@ubuntu-kvm:~$ qemu-system-x86_64 --version</span><br><span class="line">QEMU emulator version 4.2.1 (Debian 1:4.2-3ubuntu6.11)</span><br><span class="line">Copyright (c) 2003-2019 Fabrice Bellard and the QEMU Project developers</span><br><span class="line">ubuntu@ubuntu-kvm:~$ virt-manager --version</span><br><span class="line">2.2.1</span><br><span class="line">ubuntu@ubuntu-kvm:~$ modinfo kvm-intel</span><br><span class="line">filename:       /lib/modules/5.4.0-62-generic/kernel/arch/x86/kvm/kvm-intel.ko</span><br><span class="line">ubuntu@ubuntu-kvm:~$ modinfo i40evf</span><br><span class="line">filename:       /lib/modules/5.4.0-62-generic/kernel/drivers/net/ethernet/intel/iavf/iavf.ko</span><br><span class="line">version:        3.2.3-k</span><br></pre></td></tr></table></figure>
<h2 id="3-NIC-Setting"><a href="#3-NIC-Setting" class="headerlink" title="(3) NIC Setting"></a>(3) NIC Setting</h2><p>In Ubuntu 20.04, we use NetworkManager to config the NIC, you can use nmtui on the terminal, or nmcli.<br>First, check the netplan.</p>
<p><code>cat /etc/netplan/ 00-installer-config.yaml</code></p>
<p>Edit the yaml file:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Let NetworkManager manage all devices on this system</span></span><br><span class="line"><span class="attr">network:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">renderer:</span> <span class="string">NetworkManager</span></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo netplan apply</span><br></pre></td></tr></table></figure>
<p>Then you can set the network config with nmcli or nmtui.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ sudo nmcli connection modify netplan-eno1 ipv4.method manual ipv4.addresses 10.75.59.50/24 ipv4.gateway 10.75.59.1 ipv4.dns 64.104.123.245</span><br><span class="line">ubuntu@ubuntu-kvm:~$ sudo nmcli connection modify netplan-eno1 connection.id eno1</span><br><span class="line">ubuntu@ubuntu-kvm:~$ sudo nmcli connection up eno1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Change the connections name to the devices name.</span></span><br><span class="line"></span><br><span class="line">sudo nmcli connection</span><br><span class="line">ubuntu@ubuntu-kvm:~$ sudo nmcli connection</span><br><span class="line">NAME        UUID                                  TYPE      DEVICE</span><br><span class="line">eno1        10838d80-caeb-349e-ba73-08ed16d4d666  ethernet  eno1</span><br><span class="line">enp216s0f0  6556c191-c253-3a5e-b440-c5b071ec29a4  ethernet  enp216s0f0</span><br><span class="line">enp216s0f1  8080672c-5784-375f-8eb9-a6ef57cbd4f7  ethernet  enp216s0f1</span><br><span class="line">ens1f0      58fb5b1f-c10a-3e7a-9ab9-a8c449840ce6  ethernet  ens1f0</span><br><span class="line">ens1f1      2a06a9d9-b761-3bdf-aa0b-3d44fff2158f  ethernet  ens1f1</span><br><span class="line">virbr0      ca7d1e11-a82f-429c-9d91-fc985776232c  bridge    virbr0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">Set the MTU and <span class="built_in">disable</span> ipv4 <span class="keyword">for</span> the NIC to <span class="built_in">enable</span> SRIOV.</span> </span><br><span class="line"></span><br><span class="line">sudo nmcli connection modify ens1f0 ethernet.mtu 9216</span><br><span class="line">sudo nmcli connection modify ens1f0 ipv4.method disabled</span><br><span class="line">sudo nmcli connection up ens1f0</span><br><span class="line">sudo ip link show ens1f0</span><br><span class="line">2: ens1f0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9216 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class="line">link/ether 40:a6:b7:0f:a7:74 brd ff:ff:ff:ff:ff:ff</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Note: This value 9216 of MTU is derived from Cisco NFVIS.</span></span><br><span class="line"><span class="meta">CSP5228-1#</span><span class="bash"> show pnic-detail mtu</span></span><br><span class="line">Name          MTU</span><br><span class="line">=============================</span><br><span class="line">eth0-1        9216</span><br><span class="line">eth0-2        9216</span><br><span class="line">eth1-1        9216</span><br><span class="line">eth1-2        9216</span><br></pre></td></tr></table></figure>
<h1 id="SR-IOV-Configuration"><a href="#SR-IOV-Configuration" class="headerlink" title="SR-IOV Configuration"></a>SR-IOV Configuration</h1><h2 id="1-Check-the-NIC-to-support-SR-IOV"><a href="#1-Check-the-NIC-to-support-SR-IOV" class="headerlink" title="(1) Check the NIC to support SR-IOV"></a>(1) Check the NIC to support SR-IOV</h2><p>Check the NIC hardware infor.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sudo lshw -c network -businfo</span><br><span class="line"></span><br><span class="line">Bus info          Device      Class          Description</span><br><span class="line">========================================================</span><br><span class="line"></span><br><span class="line">pci@0000:3b:00.0  eno1        network        Ethernet Controller 10G X550T</span><br><span class="line">pci@0000:3b:00.1  eno2        network        Ethernet Controller 10G X550T</span><br><span class="line">pci@0000:5e:00.0  ens1f0      network        Ethernet Controller XXV710 for 25GbE SFP28</span><br><span class="line">pci@0000:5e:00.1  ens1f1      network        Ethernet Controller XXV710 for 25GbE SFP28</span><br><span class="line">pci@0000:d8:00.0  enp216s0f0  network        Ethernet Controller XXV710 for 25GbE SFP28</span><br><span class="line">pci@0000:d8:00.1  enp216s0f1  network        Ethernet Controller XXV710 for 25GbE SFP28</span><br></pre></td></tr></table></figure>
<p>Check the capabilities of NIC</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo lspci -vv -s 5e:00.0 | grep -A 5 -i SR-IOV</span><br><span class="line">    Capabilities: [160 v1] Single Root I/O Virtualization (SR-IOV)</span><br><span class="line">        IOVCap: Migration-, Interrupt Message Number: 000</span><br><span class="line">        IOVCtl: Enable+ Migration- Interrupt- MSE+ ARIHierarchy+</span><br><span class="line">        IOVSta: Migration-</span><br><span class="line">        Initial VFs: 64, Total VFs: 64, Number of VFs: 2, Function Dependency Link: 00</span><br><span class="line">        VF offset: 16, stride: 1, Device ID: 154c</span><br></pre></td></tr></table></figure>
<h2 id="2-Change-the-GRUB-parameters"><a href="#2-Change-the-GRUB-parameters" class="headerlink" title="(2) Change the GRUB parameters"></a>(2) Change the GRUB parameters</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/default/grub </span><br><span class="line">GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet hugepagesz=1G hugepages=64 default_hugepagesz=1G intel_iommu=on iommu=pt isolcpus=1-8,45-52&quot;</span><br></pre></td></tr></table></figure>
<p><strong>Note：The hugepages should be no more than the physical memory, otherwise, it will fail to bootup.</strong></p>
<ul>
<li><strong>default_hugepagesz=1G hugepagesz=1G hugepages=64</strong> will allocate 64 1GB huge pages at boot, which are <strong>static huge pages</strong>. CSR 1000v will use these static huge pages for best performance.</li>
<li><strong>isolcpus=1-8,45-52</strong> will isolate the CPUs cores reserved for CSR 1000v, prevent other processes running on these cores, this can reduce latency for CSR 1000v. You can refer to   [Check the capability of the platform][1]  to get the CPU information.</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo update-grub</span><br></pre></td></tr></table></figure>
<p>After reboot, check the /proc/cmdline.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/cmdline |grep intel_iommu=on</span><br><span class="line">dmesg |grep -e DMAR -e IOMMU</span><br><span class="line">dmesg | grep -e DMAR -e IOMMU -e AMD-Vi</span><br><span class="line">ubuntu@ubuntu-kvm:~$ cat /proc/cmdline |grep intel_iommu=on</span><br><span class="line">BOOT_IMAGE=/vmlinuz-5.4.0-62-generic root=/dev/mapper/ubuntu--vg-ubuntu--lv ro quiet hugepagesz=1G hugepages=64 default_hugepagesz=1G intel_iommu=on iommu=pt isolcpus=1-8,45-52</span><br><span class="line"></span><br><span class="line">ubuntu@ubuntu-kvm:~ $ dmesg |grep -e DMAR -e IOMMU</span><br><span class="line">[    0.020313] ACPI: DMAR 0x000000005DA8EB80 000270 (v01 Cisco0 CiscoUCS 00000001 INTL 20091013)</span><br><span class="line">[    1.954441] DMAR: IOMMU enabled</span><br></pre></td></tr></table></figure>
<p>Check the CPU info, all the CPU cores and isolated CPU cores.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ cat /sys/devices/system/cpu/isolated</span><br><span class="line">1-8,45-52</span><br><span class="line">ubuntu@ubuntu-kvm:~$ cat /sys/devices/system/cpu/present</span><br><span class="line">0-87</span><br></pre></td></tr></table></figure>
<h2 id="3-VFs-Persistence"><a href="#3-VFs-Persistence" class="headerlink" title="(3) VFs Persistence"></a>(3) VFs Persistence</h2><p><strong>NetworkManager way:</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> nmcli can <span class="built_in">set</span> the SRIOV, as follow:</span></span><br><span class="line">sudo nmcli connection modify ens1f0 sriov.total-vfs 2</span><br><span class="line">sudo nmcli connection modify ens1f1 sriov.total-vfs 2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> We can <span class="built_in">set</span> the MAC address and <span class="built_in">set</span> the trust on:</span></span><br><span class="line">sudo nmcli connection modify ens1f0 sriov.vfs &#x27;0 mac=b6:4f:02:37:5a:d8 trust=true, 1 mac=26:04:1d:1f:3d:a9 trust=true&#x27;</span><br><span class="line">sudo nmcli connection modify ens1f1 sriov.vfs &#x27;0 mac=76:6c:4e:16:7f:e2 trust=true, 1 mac=6a:f2:bd:97:71:65 trust=true&#x27;</span><br><span class="line">sudo nmcli connection up ens1f0</span><br><span class="line">sudo nmcli connection up ens1f1</span><br></pre></td></tr></table></figure>
<p>After reboot, check the dmesg.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sudo dmesg | grep -i vf</span><br><span class="line">[    6.599304] i40e 0000:5e:00.0: Allocating 2 VFs.</span><br><span class="line">[    6.680111] i40e 0000:5e:00.1: Allocating 2 VFs.</span><br><span class="line">[    6.730167] iavf: Intel(R) Ethernet Adaptive Virtual Function Network Driver - version 3.2.3-k</span><br><span class="line">&lt;&lt; snip &gt;&gt;</span><br><span class="line">[   17.931493] i40e 0000:5e:00.0: Setting MAC b6:4f:02:37:5a:d8 on VF 0</span><br><span class="line">[   18.111781] i40e 0000:5e:00.0: VF 0 is now trusted</span><br><span class="line">[   18.112559] i40e 0000:5e:00.0: Setting MAC 26:04:1d:1f:3d:a9 on VF 1</span><br><span class="line">[   18.291464] i40e 0000:5e:00.0: VF 1 is now trusted</span><br><span class="line">[   18.292231] i40e 0000:5e:00.1: Setting MAC 76:6c:4e:16:7f:e2 on VF 0</span><br><span class="line">[   18.475259] i40e 0000:5e:00.1: VF 0 is now trusted</span><br><span class="line">[   18.475929] i40e 0000:5e:00.1: Setting MAC 6a:f2:bd:97:71:65 on VF 1</span><br><span class="line">[   18.659465] i40e 0000:5e:00.1: VF 1 is now trusted</span><br><span class="line">[   18.728124] iavf 0000:5e:02.0 ens1f0v0: NIC Link is Up Speed is 25 Gbps Full Duplex</span><br><span class="line">[   18.752275] iavf 0000:5e:02.1 ens1f0v1: NIC Link is Up Speed is 25 Gbps Full Duplex</span><br><span class="line">[   18.776329] iavf 0000:5e:0a.0 ens1f1v0: NIC Link is Up Speed is 25 Gbps Full Duplex</span><br><span class="line">[   18.800569] iavf 0000:5e:0a.1 ens1f1v1: NIC Link is Up Speed is 25 Gbps Full Duplex</span><br></pre></td></tr></table></figure>
<h2 id="4-Check-the-VFs"><a href="#4-Check-the-VFs" class="headerlink" title="(4) Check the VFs"></a>(4) Check the VFs</h2><p>You can check the VFs from lspci or ip link commands.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ sudo lspci | grep -i Virtual</span><br><span class="line">ubuntu@ubuntu-kvm:~$ sudo ip link show | grep -B2 vf</span><br></pre></td></tr></table></figure>
<p>Good news is that the VFs names are well related to the physical NICs. For example, <strong>ens1f0v1</strong> is one of the VFs of the physical NIC <strong>ens1f0</strong> .</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ ip link show | grep -E ens1f[0,1]v[0,1] -A 1</span><br><span class="line">9: ens1f0v1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether 26:04:1d:1f:3d:a9 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">10: ens1f1v1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether 6a:f2:bd:97:71:65 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">15: ens1f0v0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether b6:4f:02:37:5a:d8 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">16: ens1f1v0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class="line">link/ether 76:6c:4e:16:7f:e2 brd ff:ff:ff:ff:ff:ff</span><br></pre></td></tr></table></figure>
<p>We can change the MTU to <strong>9216</strong> (or you may not need 9216, 1504 is enough).</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo nmcli connection modify ens1f0v0 ethernet.mtu 9216 ipv4.method disabled</span><br><span class="line">sudo nmcli connection modify ens1f0v1 ethernet.mtu 9216 ipv4.method disabled</span><br><span class="line">sudo nmcli connection modify ens1f1v0 ethernet.mtu 9216 ipv4.method disabled</span><br><span class="line">sudo nmcli connection modify ens1f1v1 ethernet.mtu 9216 ipv4.method disabled</span><br><span class="line">sudo nmcli connection up ens1f0v0 </span><br><span class="line">sudo nmcli connection up ens1f0v1</span><br><span class="line">sudo nmcli connection up ens1f1v0</span><br><span class="line">sudo nmcli connection up ens1f1v1</span><br></pre></td></tr></table></figure>
<p>The above configs will survive after reboot.</p>
<h1 id="Create-SR-IOV-Virtual-Network-Adapter-Pool"><a href="#Create-SR-IOV-Virtual-Network-Adapter-Pool" class="headerlink" title="Create SR-IOV Virtual Network Adapter Pool"></a>Create SR-IOV Virtual Network Adapter Pool</h1><p>Using this method, KVM creates a pool of network devices that can be inserted into VMs, and the size of that pool is determined by how many VFs were created on the physical function when they were initialized.</p>
<h2 id="1-Create-an-xml-file"><a href="#1-Create-an-xml-file" class="headerlink" title="(1) Create an xml file"></a>(1) Create an xml file</h2><p>ubuntu@ubuntu-kvm:~/kvm$ cat ens1f0_sriov_pool.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">network</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">name</span>&gt;</span>ens1f0_sriov_pool<span class="tag">&lt;/<span class="name">name</span>&gt;</span> <span class="comment">&lt;!-- This is the name of the file you created --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">forward</span> <span class="attr">mode</span>=<span class="string">&#x27;hostdev&#x27;</span> <span class="attr">managed</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">pf</span> <span class="attr">dev</span>=<span class="string">&#x27;ens1f0&#x27;</span>/&gt;</span>  <span class="comment">&lt;!-- Use the netdev name of your SR-IOV devices PF here --&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">forward</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">network</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="2-Define-a-network-and-set-to-auto-start"><a href="#2-Define-a-network-and-set-to-auto-start" class="headerlink" title="(2) Define a network and set to auto start."></a>(2) Define a network and set to auto start.</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">virsh net-define ens1f0_sriov_pool.xml</span><br><span class="line">Sleep 1</span><br><span class="line">virsh net-start ens1f0_sriov_pool</span><br><span class="line">virsh net-autostart ens1f0_sriov_pool</span><br></pre></td></tr></table></figure>
<p>ubuntu@ubuntu-kvm:~/kvm$ virsh net-dumpxml ens1f0_sriov_pool</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">network</span> <span class="attr">connections</span>=<span class="string">&#x27;1&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>ens1f0_sriov_pool<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>9125a600-6620-4ab6-9a47-8844a61b0918<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">forward</span> <span class="attr">mode</span>=<span class="string">&#x27;hostdev&#x27;</span> <span class="attr">managed</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pf</span> <span class="attr">dev</span>=<span class="string">&#x27;ens1f0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x5e&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x5e&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x1&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">forward</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">network</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="3-Select-the-virtual-adapter-from-the-pool"><a href="#3-Select-the-virtual-adapter-from-the-pool" class="headerlink" title="(3) Select the virtual adapter from the pool"></a>(3) Select the virtual adapter from the pool</h2><p>It is simple to add an SR-IOV NIC, as follow:</p>
<img src="/csr1kv-kvm-Ubuntu20-04-md/pic1-sriov-pool.png" class="" title="SRIOV Adapter Pool">

<p>This is equivalent to the following XML:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;network&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;52:54:00:0b:a5:2e&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">source</span> <span class="attr">network</span>=<span class="string">&#x27;ens1f0_sriov_pool&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>After the VM powered on, the network info is as follow:<br>virsh dumpxml CSR1KV-1</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;hostdev&#x27;</span> <span class="attr">managed</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;52:54:00:0b:a5:2e&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;vfio&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x5e&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;hostdev0&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="Create-the-CSR1KV-VM-from-virt-manager"><a href="#Create-the-CSR1KV-VM-from-virt-manager" class="headerlink" title="Create the CSR1KV VM from virt-manager"></a>Create the CSR1KV VM from virt-manager</h1><p>From the virt-manager, create a CSR1KV virtual machine step by step, and choose the virtual network interface from the SR-IOV pool.</p>
<img src="/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step1.png" class="" title="Virt-manager step 1">

<img src="/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step2.png" class="" title="Virt-manager Step 2">

<img src="/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step2-2.png" class="" title="Virt-manager Step2-2">

<img src="/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step3.png" class="" title="Virt-manager Step 3">

<img src="/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step4.png" class="" title="Virt-manager Step 4">

<p>Note: The first interface of csr1kv-1 is configured to <strong>macvtap Bridge mode</strong>, so you do not need to create a Linux bridge. However, csr1kv-1 can not communicate to the Linux host through this interface, but it can go out of the Linux host through the eno1. This is a known issue with macvtap.</p>
<img src="/csr1kv-kvm-Ubuntu20-04-md/add-sriov-pool.png" class="" title="Virt-manager Step 5">

<p>After select the Virtual Network Interface, click the <strong>Begin Installation</strong>, and you can shut down the virtual machine.<br>The actions above will create the <strong>csr1kv-1.xml</strong> file under the directory: <strong>/etc/libvirtd/qemu/</strong></p>
<h1 id="KVM-Performance-Tunning"><a href="#KVM-Performance-Tunning" class="headerlink" title="KVM Performance Tunning"></a>KVM Performance Tunning</h1><p>KVM performance tuning are related to NUMA, Memory Hugepage and vCPU pinning. The main reference is Redhat Linux 7 PERFORMANCE TUNING GUIDE</p>
<p>We will use <strong>virsh edit csr1kv-1</strong> to do the performance tuning.</p>
<h2 id="1-Check-the-capability-of-the-platform"><a href="#1-Check-the-capability-of-the-platform" class="headerlink" title="(1) Check the capability of the platform"></a>(1) Check the capability of the platform</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ virsh nodeinfo</span><br><span class="line">CPU model:           x86_64</span><br><span class="line">CPU(s):              88</span><br><span class="line">CPU frequency:       1000 MHz</span><br><span class="line">CPU socket(s):       1</span><br><span class="line">Core(s) per socket:  22</span><br><span class="line">Thread(s) per core:  2</span><br><span class="line">NUMA cell(s):        2</span><br><span class="line">Memory size:         394929928 KiB</span><br></pre></td></tr></table></figure>
<p>[1]:ubuntu@ubuntu-kvm:~$ virsh capabilities</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">capabilities</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">host</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>a24f9760-48f1-f34e-a001-a848f08df7bb<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">cpu</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">arch</span>&gt;</span>x86_64<span class="tag">&lt;/<span class="name">arch</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span>&gt;</span>Cascadelake-Server-noTSX<span class="tag">&lt;/<span class="name">model</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">vendor</span>&gt;</span>Intel<span class="tag">&lt;/<span class="name">vendor</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">microcode</span> <span class="attr">version</span>=<span class="string">&#x27;83898371&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">counter</span> <span class="attr">name</span>=<span class="string">&#x27;tsc&#x27;</span> <span class="attr">frequency</span>=<span class="string">&#x27;2095078000&#x27;</span> <span class="attr">scaling</span>=<span class="string">&#x27;no&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">topology</span> <span class="attr">sockets</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">cores</span>=<span class="string">&#x27;22&#x27;</span> <span class="attr">threads</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>From the outputs, we can get the cores of CPU, the NUMA info and the hugepages.</p>
<h2 id="2-NUMA-Info"><a href="#2-NUMA-Info" class="headerlink" title="(2) NUMA Info"></a>(2) NUMA Info</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ numactl --hardware</span><br><span class="line">available: 2 nodes (0-1)</span><br><span class="line">node 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65</span><br><span class="line">node 0 size: 192172 MB</span><br><span class="line">node 0 free: 152956 MB</span><br><span class="line">node 1 cpus: 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87</span><br><span class="line">node 1 size: 193500 MB</span><br><span class="line">node 1 free: 158037 MB</span><br><span class="line">node distances:</span><br><span class="line">node   0   1</span><br><span class="line">  0:  10  21</span><br><span class="line">  1:  21  10 </span><br></pre></td></tr></table></figure>
<p>Two CPUs, each has 192GB memory, the NUMA node are node 0 and node 1.</p>
<p>You can also check the NUMA info of the NIC, as follow:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ sudo lspci -vv | grep Ethernet -A 6</span><br><span class="line">5e:00.0 Ethernet controller: Intel Corporation Ethernet Controller XXV710 for 25GbE SFP28 (rev 02)</span><br><span class="line">    Subsystem: Cisco Systems Inc Ethernet Network Adapter XXV710</span><br><span class="line">    Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr+ Stepping- SERR+ FastB2B- DisINTx+</span><br><span class="line">    Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx-</span><br><span class="line">    Latency: 0, Cache Line Size: 32 bytes</span><br><span class="line">    Interrupt: pin A routed to IRQ 137</span><br><span class="line">    NUMA node: 0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">Or you can find the numa infor from udevadm.</span></span><br><span class="line">ubuntu@ubuntu-kvm:~$ sudo udevadm info -ap /sys/class/net/ens1f0 | grep numa</span><br><span class="line">    ATTRS&#123;numa_node&#125;==&quot;0&quot;</span><br><span class="line">    ATTRS&#123;numa_node&#125;==&quot;0&quot;</span><br></pre></td></tr></table></figure>
<p>If the memory and NICs are all on numa_node 0, that would be more efficient. Please check the server’s PCI-E slots mapping with the CPU slots.</p>
<h2 id="3-HugePage-and-Transparent-Hugepage"><a href="#3-HugePage-and-Transparent-Hugepage" class="headerlink" title="(3) HugePage and Transparent Hugepage"></a>(3) HugePage and Transparent Hugepage</h2><p>To check the memory info</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ cat /proc/meminfo | grep Huge</span><br><span class="line">AnonHugePages:    133120 kB</span><br><span class="line">ShmemHugePages:        0 kB</span><br><span class="line">FileHugePages:         0 kB</span><br><span class="line">HugePages_Total:      64</span><br><span class="line">HugePages_Free:       56</span><br><span class="line">HugePages_Rsvd:        0</span><br><span class="line">HugePages_Surp:        0</span><br><span class="line">Hugepagesize:    1048576 kB</span><br><span class="line">Hugetlb:        67108864 kB</span><br></pre></td></tr></table></figure>
<p>You can change the hugepages on the run time：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ cat /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages</span><br><span class="line">32</span><br><span class="line">sudo su -     // switch to root user.</span><br><span class="line">root@ubuntu-kvm:~# echo 64 &gt; /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages</span><br><span class="line">root@ubuntu-kvm:~# echo 64 &gt; /sys/devices/system/node/node1/hugepages/hugepages-1048576kB/nr_hugepages</span><br></pre></td></tr></table></figure>
<p>Check and configure the transparent_hugepage:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-kvm:~# echo always &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line">cat /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line">[always] madvise never</span><br></pre></td></tr></table></figure>
<h2 id="4-vCPU-Pinning"><a href="#4-vCPU-Pinning" class="headerlink" title="(4) vCPU Pinning"></a>(4) vCPU Pinning</h2><p>vCPU pinning can improve the cache meet rate and improve the performance.<br>You can check the vcpu pinning.<br><strong>virsh vcpuinfo csr1kv-1</strong></p>
<h2 id="5-Edit-the-XML-file-of-the-CSR1KV"><a href="#5-Edit-the-XML-file-of-the-CSR1KV" class="headerlink" title="(5) Edit the XML file of the CSR1KV"></a>(5) Edit the XML file of the CSR1KV</h2><p>Run virsh edit csr1kv-1 to edit the parameters.<br>Please pay attention to the following texts, other parameters might be different.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">memoryBacking</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">hugepages</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">page</span> <span class="attr">size</span>=<span class="string">&#x27;1048576&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">hugepages</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">locked</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">nosharepages</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">memoryBacking</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">vcpu</span> <span class="attr">placement</span>=<span class="string">&#x27;static&#x27;</span>&gt;</span>8<span class="tag">&lt;/<span class="name">vcpu</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">cputune</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;3&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;4&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;5&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;5&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;6&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;6&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;7&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;7&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;8&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">emulatorpin</span> <span class="attr">cpuset</span>=<span class="string">&#x27;45-52&#x27;</span>/&gt;</span> <span class="comment">&lt;!-- If Hyper-threading were enabled --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cputune</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">numatune</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">memory</span> <span class="attr">mode</span>=<span class="string">&#x27;strict&#x27;</span> <span class="attr">nodeset</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">numatune</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">cpu</span> <span class="attr">mode</span>=<span class="string">&#x27;host-passthrough&#x27;</span> <span class="attr">check</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">memballoon</span> <span class="attr">model</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>Please note that, if hyper-threading is enabled in BIOS setting, the parameter “emulatorpin” should be set, the cpuset are from the “virsh capabilities”, for example, siblings=’1,45’. When the core 1 is pinned, core 45 should be set in emulatorpin.</p>
<p>From the guide <a target="_blank" rel="noopener" href="https://libvirt.org/formatdomain.html">https://libvirt.org/formatdomain.html</a> and <a target="_blank" rel="noopener" href="https://libvirt.org/kbase/kvm-realtime.html">https://libvirt.org/kbase/kvm-realtime.html</a> we set the CPU and memory tuning parameters as the highlighted text.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">domain</span> <span class="attr">type</span>=<span class="string">&#x27;kvm&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>csr1kv-1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>83f90c1c-f0ea-4298-bcdf-3d676de2aeb4<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">metadata</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">libosinfo:libosinfo</span> <span class="attr">xmlns:libosinfo</span>=<span class="string">&quot;http://libosinfo.org/xmlns/libvirt/domain/1.0&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">libosinfo:os</span> <span class="attr">id</span>=<span class="string">&quot;http://centos.org/centos/7.0&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">libosinfo:libosinfo</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">metadata</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">memory</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>&gt;</span>8388608<span class="tag">&lt;/<span class="name">memory</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">currentMemory</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>&gt;</span>8388608<span class="tag">&lt;/<span class="name">currentMemory</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">memoryBacking</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hugepages</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">page</span> <span class="attr">size</span>=<span class="string">&#x27;1048576&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">hugepages</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">locked</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">nosharepages</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">memoryBacking</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpu</span> <span class="attr">placement</span>=<span class="string">&#x27;static&#x27;</span>&gt;</span>8<span class="tag">&lt;/<span class="name">vcpu</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">cputune</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;3&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;4&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;5&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;5&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;6&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;6&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;7&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;7&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;8&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">emulatorpin</span> <span class="attr">cpuset</span>=<span class="string">&#x27;45-52&#x27;</span>/&gt;</span> <span class="comment">&lt;!-- If Hyper-threading were enabled --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">cputune</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">numatune</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">memory</span> <span class="attr">mode</span>=<span class="string">&#x27;strict&#x27;</span> <span class="attr">nodeset</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">numatune</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">os</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span> <span class="attr">arch</span>=<span class="string">&#x27;x86_64&#x27;</span> <span class="attr">machine</span>=<span class="string">&#x27;pc-q35-4.2&#x27;</span>&gt;</span>hvm<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">boot</span> <span class="attr">dev</span>=<span class="string">&#x27;hd&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">os</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">features</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">acpi</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">apic</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vmport</span> <span class="attr">state</span>=<span class="string">&#x27;off&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">features</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">cpu</span> <span class="attr">mode</span>=<span class="string">&#x27;host-passthrough&#x27;</span> <span class="attr">check</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">clock</span> <span class="attr">offset</span>=<span class="string">&#x27;utc&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">timer</span> <span class="attr">name</span>=<span class="string">&#x27;rtc&#x27;</span> <span class="attr">tickpolicy</span>=<span class="string">&#x27;catchup&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">timer</span> <span class="attr">name</span>=<span class="string">&#x27;pit&#x27;</span> <span class="attr">tickpolicy</span>=<span class="string">&#x27;delay&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">timer</span> <span class="attr">name</span>=<span class="string">&#x27;hpet&#x27;</span> <span class="attr">present</span>=<span class="string">&#x27;no&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">clock</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">on_poweroff</span>&gt;</span>destroy<span class="tag">&lt;/<span class="name">on_poweroff</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">on_reboot</span>&gt;</span>restart<span class="tag">&lt;/<span class="name">on_reboot</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">on_crash</span>&gt;</span>destroy<span class="tag">&lt;/<span class="name">on_crash</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">pm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">suspend-to-mem</span> <span class="attr">enabled</span>=<span class="string">&#x27;no&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">suspend-to-disk</span> <span class="attr">enabled</span>=<span class="string">&#x27;no&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">pm</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">devices</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">emulator</span>&gt;</span>/usr/bin/qemu-system-x86_64<span class="tag">&lt;/<span class="name">emulator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;file&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;disk&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;qcow2&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">&#x27;/var/lib/libvirt/images/csr1000v-universalk9.17.02.01v.qcow2&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;vda&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x05&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;qemu-xhci&#x27;</span> <span class="attr">ports</span>=<span class="string">&#x27;15&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x03&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;sata&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x1f&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pcie-root&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">chassis</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0x10&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span> <span class="attr">multifunction</span>=<span class="string">&#x27;on&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">chassis</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0x11&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">chassis</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0x12&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">chassis</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0x13&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x3&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;5&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">chassis</span>=<span class="string">&#x27;5&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0x14&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x4&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;6&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">chassis</span>=<span class="string">&#x27;6&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0x15&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x5&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;7&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">chassis</span>=<span class="string">&#x27;7&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0x16&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x6&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;8&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">chassis</span>=<span class="string">&#x27;8&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0x17&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x7&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;virtio-serial&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x04&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;direct&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;52:54:00:69:ec:73&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">dev</span>=<span class="string">&#x27;eno1&#x27;</span> <span class="attr">mode</span>=<span class="string">&#x27;bridge&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x01&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;network&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;52:54:00:0b:a5:2e&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">network</span>=<span class="string">&#x27;ens1f0_sriov_pool&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;network&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;52:54:00:bd:9f:54&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">network</span>=<span class="string">&#x27;ens1f1_sriov_pool&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x08&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">serial</span> <span class="attr">type</span>=<span class="string">&#x27;pty&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;isa-serial&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;isa-serial&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">serial</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">console</span> <span class="attr">type</span>=<span class="string">&#x27;pty&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;serial&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">console</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">channel</span> <span class="attr">type</span>=<span class="string">&#x27;unix&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;org.qemu.guest_agent.0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;virtio-serial&#x27;</span> <span class="attr">controller</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">channel</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">channel</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;com.redhat.spice.0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;virtio-serial&#x27;</span> <span class="attr">controller</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">channel</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;mouse&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;ps2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;keyboard&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;ps2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">graphics</span> <span class="attr">type</span>=<span class="string">&#x27;spice&#x27;</span> <span class="attr">autoport</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">listen</span> <span class="attr">type</span>=<span class="string">&#x27;address&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">image</span> <span class="attr">compression</span>=<span class="string">&#x27;off&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">graphics</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">video</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;qxl&#x27;</span> <span class="attr">ram</span>=<span class="string">&#x27;65536&#x27;</span> <span class="attr">vram</span>=<span class="string">&#x27;65536&#x27;</span> <span class="attr">vgamem</span>=<span class="string">&#x27;16384&#x27;</span> <span class="attr">heads</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">primary</span>=<span class="string">&#x27;yes&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x01&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;3&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">memballoon</span> <span class="attr">model</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">devices</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>The parameters are from <a target="_blank" rel="noopener" href="https://www.cisco.com/c/en/us/td/docs/routers/csr1000/software/configuration/b_CSR1000v_Configuration_Guide/b_CSR1000v_Configuration_Guide_chapter_0101.html#con_1313827">Cisco CSR 1000v and Cisco ISRv Software Configuration Guide</a><br>After you install the CSR1000v, and edit the XML file, you can run virsh to create the csr1kv.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/libvirtd/qemu</span><br><span class="line">virsh define csr1kv-1.xml</span><br><span class="line">virsh start csr1kv-1</span><br></pre></td></tr></table></figure>
<h2 id="6-Check-CSR1000v’s-tunning"><a href="#6-Check-CSR1000v’s-tunning" class="headerlink" title="(6) Check CSR1000v’s tunning"></a>(6) Check CSR1000v’s tunning</h2><p>ubuntu@ubuntu-kvm:/etc/libvirt/qemu$ virsh list</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"> Id   Name       State</span><br><span class="line">--------------------------</span><br><span class="line"></span><br><span class="line"> 1    csr1kv-1   running</span><br><span class="line"></span><br><span class="line">ubuntu@ubuntu-kvm:/etc/libvirt/qemu$ virsh vcpuinfo 1</span><br><span class="line">VCPU:           0</span><br><span class="line">CPU:            1</span><br><span class="line">State:          running</span><br><span class="line">CPU time:       167.0s</span><br><span class="line">CPU Affinity:   -y--------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">VCPU:           1</span><br><span class="line">CPU:            2</span><br><span class="line">State:          running</span><br><span class="line">CPU time:       193.3s</span><br><span class="line">CPU Affinity:   --y-------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">VCPU:           2</span><br><span class="line">CPU:            3</span><br><span class="line">State:          running</span><br><span class="line">CPU time:       152.5s</span><br><span class="line">CPU Affinity:   ---y------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">VCPU:           3</span><br><span class="line">CPU:            4</span><br><span class="line">State:          running</span><br><span class="line">CPU time:       174.3s</span><br><span class="line">CPU Affinity:   ----y-----------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">VCPU:           4</span><br><span class="line">CPU:            5</span><br><span class="line">State:          running</span><br><span class="line">CPU time:       260.6s</span><br><span class="line">CPU Affinity:   -----y----------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">VCPU:           5</span><br><span class="line">CPU:            6</span><br><span class="line">State:          running</span><br><span class="line">CPU time:       386.0s</span><br><span class="line">CPU Affinity:   ------y---------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">VCPU:           6</span><br><span class="line">CPU:            7</span><br><span class="line">State:          running</span><br><span class="line">CPU time:       2189.9s</span><br><span class="line">CPU Affinity:   -------y--------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">VCPU:           7</span><br><span class="line">CPU:            8</span><br><span class="line">State:          running</span><br><span class="line">CPU time:       2192.2s</span><br><span class="line">CPU Affinity:   --------y-------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>From the above outputs, we can find that the vCPUa are pinned to NO. 1 to 8 CPU cores.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ sudo numastat -c qemu</span><br><span class="line">Per-node process memory usage (in MBs)</span><br><span class="line">PID              Node 0 Node 1 Total</span><br><span class="line"></span><br><span class="line">---------------  ------ ------ -----</span><br><span class="line"></span><br><span class="line">4391 (qemu-syste   8373      0  8373</span><br><span class="line">5891 (sudo)           4      1     5</span><br><span class="line"></span><br><span class="line">---------------  ------ ------ -----</span><br><span class="line"></span><br><span class="line">Total              8377      1  8377</span><br><span class="line"></span><br><span class="line">ubuntu@ubuntu-kvm:~$ sudo numastat -p 4391</span><br><span class="line">Per-node process memory usage (in MBs) for PID 4391 (qemu-system-x86)</span><br><span class="line">                           Node 0          Node 1           Total</span><br><span class="line">                  --------------- --------------- ---------------</span><br><span class="line">Huge                      8192.00            0.00         8192.00</span><br><span class="line">Heap                        10.00            0.00           10.00</span><br><span class="line">Stack                        0.03            0.00            0.03</span><br><span class="line">Private                    170.70            0.15          170.85</span><br><span class="line"></span><br><span class="line">----------------  --------------- --------------- ---------------</span><br><span class="line"></span><br><span class="line">Total                     8372.73            0.16         8372.88</span><br></pre></td></tr></table></figure>

<p>From the above outputs, the csr1kv-1 are using the memories from node 0.</p>
<h2 id="7-Check-the-vNIC-in-CSR1KV"><a href="#7-Check-the-vNIC-in-CSR1KV" class="headerlink" title="(7) Check the vNIC in CSR1KV"></a>(7) Check the vNIC in CSR1KV</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">csr1kv-1#show platform software vnic-if interface-mapping</span><br><span class="line">-------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"> Interface Name        Driver Name         Mac Addr</span><br><span class="line">-------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"> GigabitEthernet3       net_i40e_vf        5254.00bd.9f54</span><br><span class="line"> GigabitEthernet2       net_i40e_vf        5254.000b.a52e</span><br><span class="line"> GigabitEthernet1       net_virtio         5254.0069.ec73</span><br></pre></td></tr></table></figure>
<p>The Driver Name net_i40e_vf indicates that the vNIC is a VF from the SR-IOV pool.</p>
<h1 id="CSR-1000v-initial-configuration-and-Smart-License-registration"><a href="#CSR-1000v-initial-configuration-and-Smart-License-registration" class="headerlink" title="CSR 1000v initial configuration and Smart License registration"></a>CSR 1000v initial configuration and Smart License registration</h1><h2 id="1-CSR-1000v-initial-config-example"><a href="#1-CSR-1000v-initial-config-example" class="headerlink" title="(1) CSR 1000v initial config example"></a>(1) CSR 1000v initial config example</h2><p>Part of the configuration:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">CSR1000v-1#show sdwan running-config</span><br><span class="line">system</span><br><span class="line"> system-ip             1.1.10.1</span><br><span class="line"> site-id               101</span><br><span class="line"> sp-organization-name  CiscoBJ</span><br><span class="line"> organization-name     CiscoBJ</span><br><span class="line"> vbond 10.75.58.51 port 12346</span><br><span class="line">!</span><br><span class="line">hostname CSR1000v-1</span><br><span class="line">username admin privilege 15 secret 9 $9$4&#x2F;QL2V2K4&#x2F;6H1k$XUmRNf.T7t3KDOj&#x2F;FmoNexpEypCxr482dExXHDnohSI</span><br><span class="line">ip name-server 64.104.123.245</span><br><span class="line">ip route 0.0.0.0 0.0.0.0 10.75.59.1</span><br><span class="line"></span><br><span class="line">interface GigabitEthernet1</span><br><span class="line"> no shutdown</span><br><span class="line"> arp timeout 1200</span><br><span class="line"> ip address 10.75.59.35 255.255.255.0</span><br><span class="line"> no ip redirects</span><br><span class="line"> ip mtu    1500</span><br><span class="line"> mtu 1500</span><br><span class="line"> negotiation auto</span><br><span class="line">exit</span><br><span class="line"></span><br><span class="line">interface Tunnel1</span><br><span class="line"> no shutdown</span><br><span class="line"> ip unnumbered GigabitEthernet1</span><br><span class="line"> no ip redirects</span><br><span class="line"> ipv6 unnumbered GigabitEthernet1</span><br><span class="line"> no ipv6 redirects</span><br><span class="line"> tunnel source GigabitEthernet1</span><br><span class="line"> tunnel mode sdwan</span><br><span class="line">exit</span><br><span class="line"></span><br><span class="line">clock timezone CST 8 0</span><br><span class="line">ntp server x.x.x.x version 4</span><br><span class="line"></span><br><span class="line">sdwan</span><br><span class="line"> interface GigabitEthernet1</span><br><span class="line">  tunnel-interface</span><br><span class="line">   encapsulation ipsec</span><br><span class="line">   allow-service sshd</span><br><span class="line">  exit</span><br></pre></td></tr></table></figure>
<h2 id="2-Commands-to-check-the-status"><a href="#2-Commands-to-check-the-status" class="headerlink" title="(2) Commands to check the status"></a>(2) Commands to check the status</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">show sdwan control local-properties</span><br><span class="line">show sdwan control connections</span><br><span class="line">show sdwan control connection-history</span><br><span class="line">show sdwan running-config</span><br><span class="line">show sdwan bfd sessions</span><br><span class="line">show sdwan omp peers</span><br><span class="line">show sdwan omp routes</span><br></pre></td></tr></table></figure>
<h2 id="3-CSR-1000v-Smart-License-Registration"><a href="#3-CSR-1000v-Smart-License-Registration" class="headerlink" title="(3) CSR 1000v Smart License Registration"></a>(3) CSR 1000v Smart License Registration</h2><p>Before Smart License registration, you need ：</p>
<ol>
<li>CSR 1000v’s control connections are up；</li>
<li>Configure ip http client source-interface GigabitEthernet2</li>
<li>If the version is 16.12.x and bellow, you need to allow service all<br><code>sdwan interface GigabitEthernet2 tunnel-interface allow-service all </code><br>In the 17.2.x and above versions, there is an allow-service https</li>
<li>CSR 1000v can access URL：<a target="_blank" rel="noopener" href="https://tools.cisco.com/its/service/oddce/services/DDCEService">https://tools.cisco.com/its/service/oddce/services/DDCEService</a><br>The command license smart register idtoken xxxxxx will do the registration.<br>You can find the idtoken from your Smart Account smart license inventory.<br>show license status to check the status.</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CSR1000v-1#show platform hardware throughput level</span><br><span class="line">The current throughput level is 200000000 kb&#x2F;s</span><br></pre></td></tr></table></figure>
<h1 id="Performances-and-limitations"><a href="#Performances-and-limitations" class="headerlink" title="Performances and limitations"></a>Performances and limitations</h1><h2 id="1-The-performance-of-the-SR-IOV"><a href="#1-The-performance-of-the-SR-IOV" class="headerlink" title="(1) The performance of the SR-IOV"></a>(1) The performance of the SR-IOV</h2><p>A performance test was done after the SR-IOV setup, the CSR1KV was configured as 8vCPU and 8G Memory, the packet drop rate was 0%.</p>
<table>
<thead>
<tr>
<th>Packet Site</th>
<th>SDWAN Performance (Mbps)</th>
<th>CEF Performance (Mbps)</th>
</tr>
</thead>
<tbody><tr>
<td>128Bytes</td>
<td>800</td>
<td>2843.75</td>
</tr>
<tr>
<td>256Bytes</td>
<td>1431.26</td>
<td>6500.00</td>
</tr>
<tr>
<td>512Bytes</td>
<td>2581.26</td>
<td>10578.13</td>
</tr>
<tr>
<td>1024Bytes</td>
<td>3731.26</td>
<td>15500.00</td>
</tr>
<tr>
<td>1400Bytes</td>
<td>4306.26</td>
<td>18171.88</td>
</tr>
</tbody></table>
<img src="/csr1kv-kvm-Ubuntu20-04-md/line-chart.png" class="" title="Performance Line Chart">

<p>Note: <strong>These test results are not to represent the official performance data. Different servers and network cards may have different test results. The above data is for demo only.</strong></p>
<h2 id="2-The-limitation-of-the-SR-IOV"><a href="#2-The-limitation-of-the-SR-IOV" class="headerlink" title="(2) The limitation of the SR-IOV"></a>(2) The limitation of the SR-IOV</h2><p>The main limitation of the SR-IOV is the number of VLANs on each VF, the maximum VLAN of an VF is limited to 63 in ixgbevf.<br>So, the active number of sub-interfaces on an interface of the CSR1KV that uses the SRIOV VFs is limited to 63.<br>There is some notes in the Cisco CSR 1000v and Cisco ISRv Software Configuration Guide:</p>
<blockquote>
<p>SR-IOV (ixgbevf)<br>Maximum VLANs: The maximum number of VLANs supported on PF is 64. Together, all VFs can have a total of 64 VLANs. (Intel limitation.)</p>
<p>SR-IOV (i40evf)<br>Maximum VLANs: The maximum number of VLANs supported on PF is 512. Together, all VFs can have a total of 512 VLANs. (Intel limitation.) Per-VF resources are managed by the PF (host) device driver.</p>
</blockquote>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/performance_tuning_guide/index">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/performance_tuning_guide/index</a></p>
<p><a target="_blank" rel="noopener" href="https://computingforgeeks.com/how-to-create-and-configure-bridge-networking-for-kvm-in-linux/">https://computingforgeeks.com/how-to-create-and-configure-bridge-networking-for-kvm-in-linux/</a></p>
<p><a target="_blank" rel="noopener" href="https://software.intel.com/content/www/us/en/develop/articles/configure-sr-iov-network-virtual-functions-in-linux-kvm.html">https://software.intel.com/content/www/us/en/develop/articles/configure-sr-iov-network-virtual-functions-in-linux-kvm.html</a></p>
<p><a target="_blank" rel="noopener" href="https://linuxconfig.org/install-and-set-up-kvm-on-ubuntu-20-04-focal-fossa-linux">https://linuxconfig.org/install-and-set-up-kvm-on-ubuntu-20-04-focal-fossa-linux</a></p>
<p><a target="_blank" rel="noopener" href="https://kifarunix.com/how-to-fix-qemu-kvm-not-connected-error-on-ubuntu-20-04/">https://kifarunix.com/how-to-fix-qemu-kvm-not-connected-error-on-ubuntu-20-04/</a></p>
<p><a target="_blank" rel="noopener" href="https://linuxconfig.org/how-to-disable-apparmor-on-ubuntu-20-04-focal-fossa-linux">https://linuxconfig.org/how-to-disable-apparmor-on-ubuntu-20-04-focal-fossa-linux</a></p>
<p><strong>CSR1000v SD-WAN Installation on KVM</strong> by Jean-Marc Barozet</p>
<h1 id="Scripts-and-XML-Example-Files"><a href="#Scripts-and-XML-Example-Files" class="headerlink" title="Scripts and XML Example Files"></a>Scripts and XML Example Files</h1><ol>
<li><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/main/kvm/1.2-install-ubuntu-kvm.sh">Ubuntu and KVM installation and setting</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/1.3-nic-settings.sh">NIC Settings with nmcli</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/2.1-check-nic-sriov.sh">Check NIC SRIOV Capabilities</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/2.2-change-grub.sh">GRUB Settings</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/2.3-sriov-setting.sh">SRIOV Settings</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/2.4-check-vfs.sh">Check VFs</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/3.0-create-sriov-pool.sh">Create SRIOV Adapter Pool</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/4.0-kvm-tuning.sh">KVM Tuning</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/4.1-check-csr1kv.sh">Check CSR1000v Tuning</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/ens1f0_sriov_pool.xml">ens1f0_sriov_pool.xml</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/csr1kv-1.xml">csr1kv-1.xml</a></li>
</ol>

    </div>

    
    
    
        <div class="reward-container">
  <div></div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.png" alt="Rao Weibo 微信支付">
        <p>微信支付</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/CSR1000v/" rel="tag"># CSR1000v</a>
              <a href="/tags/KVM/" rel="tag"># KVM</a>
              <a href="/tags/SRIOV/" rel="tag"># SRIOV</a>
              <a href="/tags/NetworkManager/" rel="tag"># NetworkManager</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/csr1kv-kvm-CentOS7.html" rel="prev" title="CSR 1000v KVM SRIOV CentOS 7安装设置指南">
      <i class="fa fa-chevron-left"></i> CSR 1000v KVM SRIOV CentOS 7安装设置指南
    </a></div>
      <div class="post-nav-item">
    <a href="/hexo-setup-log-md.html" rel="next" title="Hexo 安装设置遇到的问题及解决办法">
      Hexo 安装设置遇到的问题及解决办法 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Ubuntu-20-04-Installation-and-Settings"><span class="nav-number">1.</span> <span class="nav-text">Ubuntu 20.04 Installation and Settings</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-BIOS-settings"><span class="nav-number">1.1.</span> <span class="nav-text">(1) BIOS settings</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Ubuntu-20-04-installation-tips"><span class="nav-number">1.2.</span> <span class="nav-text">(2) Ubuntu 20.04 installation tips</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-NIC-Setting"><span class="nav-number">1.3.</span> <span class="nav-text">(3) NIC Setting</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SR-IOV-Configuration"><span class="nav-number">2.</span> <span class="nav-text">SR-IOV Configuration</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Check-the-NIC-to-support-SR-IOV"><span class="nav-number">2.1.</span> <span class="nav-text">(1) Check the NIC to support SR-IOV</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Change-the-GRUB-parameters"><span class="nav-number">2.2.</span> <span class="nav-text">(2) Change the GRUB parameters</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-VFs-Persistence"><span class="nav-number">2.3.</span> <span class="nav-text">(3) VFs Persistence</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Check-the-VFs"><span class="nav-number">2.4.</span> <span class="nav-text">(4) Check the VFs</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Create-SR-IOV-Virtual-Network-Adapter-Pool"><span class="nav-number">3.</span> <span class="nav-text">Create SR-IOV Virtual Network Adapter Pool</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Create-an-xml-file"><span class="nav-number">3.1.</span> <span class="nav-text">(1) Create an xml file</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Define-a-network-and-set-to-auto-start"><span class="nav-number">3.2.</span> <span class="nav-text">(2) Define a network and set to auto start.</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Select-the-virtual-adapter-from-the-pool"><span class="nav-number">3.3.</span> <span class="nav-text">(3) Select the virtual adapter from the pool</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Create-the-CSR1KV-VM-from-virt-manager"><span class="nav-number">4.</span> <span class="nav-text">Create the CSR1KV VM from virt-manager</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#KVM-Performance-Tunning"><span class="nav-number">5.</span> <span class="nav-text">KVM Performance Tunning</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Check-the-capability-of-the-platform"><span class="nav-number">5.1.</span> <span class="nav-text">(1) Check the capability of the platform</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-NUMA-Info"><span class="nav-number">5.2.</span> <span class="nav-text">(2) NUMA Info</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-HugePage-and-Transparent-Hugepage"><span class="nav-number">5.3.</span> <span class="nav-text">(3) HugePage and Transparent Hugepage</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-vCPU-Pinning"><span class="nav-number">5.4.</span> <span class="nav-text">(4) vCPU Pinning</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-Edit-the-XML-file-of-the-CSR1KV"><span class="nav-number">5.5.</span> <span class="nav-text">(5) Edit the XML file of the CSR1KV</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-Check-CSR1000v%E2%80%99s-tunning"><span class="nav-number">5.6.</span> <span class="nav-text">(6) Check CSR1000v’s tunning</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-Check-the-vNIC-in-CSR1KV"><span class="nav-number">5.7.</span> <span class="nav-text">(7) Check the vNIC in CSR1KV</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CSR-1000v-initial-configuration-and-Smart-License-registration"><span class="nav-number">6.</span> <span class="nav-text">CSR 1000v initial configuration and Smart License registration</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-CSR-1000v-initial-config-example"><span class="nav-number">6.1.</span> <span class="nav-text">(1) CSR 1000v initial config example</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Commands-to-check-the-status"><span class="nav-number">6.2.</span> <span class="nav-text">(2) Commands to check the status</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-CSR-1000v-Smart-License-Registration"><span class="nav-number">6.3.</span> <span class="nav-text">(3) CSR 1000v Smart License Registration</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Performances-and-limitations"><span class="nav-number">7.</span> <span class="nav-text">Performances and limitations</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-The-performance-of-the-SR-IOV"><span class="nav-number">7.1.</span> <span class="nav-text">(1) The performance of the SR-IOV</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-The-limitation-of-the-SR-IOV"><span class="nav-number">7.2.</span> <span class="nav-text">(2) The limitation of the SR-IOV</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#References"><span class="nav-number">8.</span> <span class="nav-text">References</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Scripts-and-XML-Example-Files"><span class="nav-number">9.</span> <span class="nav-text">Scripts and XML Example Files</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Rao Weibo</p>
  <div class="site-description" itemprop="description">记录一些工作、学习相关的笔记</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">7</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/weiborao" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;weiborao" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:weiborao@gmail.com" title="E-Mail → mailto:weiborao@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Rao Weibo</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
