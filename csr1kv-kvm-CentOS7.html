<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"weiborao.link","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.7.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="本文提供在 CentOS 7 版本上安装 KVM，并安装和设置 CSR 1000v&#x2F;Catalyst 8000v 的指南，内容包括 SRIOV，KVM 调优以及 CSR1KV 初始化配置等内容。">
<meta property="og:type" content="article">
<meta property="og:title" content="CSR 1000v KVM SRIOV CentOS 7安装设置指南">
<meta property="og:url" content="https://weiborao.link/csr1kv-kvm-CentOS7.html">
<meta property="og:site_name" content="Rao Weibo的博客">
<meta property="og:description" content="本文提供在 CentOS 7 版本上安装 KVM，并安装和设置 CSR 1000v&#x2F;Catalyst 8000v 的指南，内容包括 SRIOV，KVM 调优以及 CSR1KV 初始化配置等内容。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://weiborao.link/csr1kv-kvm-CentOS7/sriov-pool-001.png">
<meta property="og:image" content="https://weiborao.link/csr1kv-kvm-CentOS7/virt-manager-1.png">
<meta property="og:image" content="https://weiborao.link/csr1kv-kvm-CentOS7/virt-manager-2.png">
<meta property="og:image" content="https://weiborao.link/csr1kv-kvm-CentOS7/virt-manager-3.png">
<meta property="og:image" content="https://weiborao.link/csr1kv-kvm-CentOS7/virt-manager-3.png">
<meta property="og:image" content="https://weiborao.link/csr1kv-kvm-CentOS7/virt-manager-5.png">
<meta property="og:image" content="https://weiborao.link/csr1kv-kvm-CentOS7/virt-manager-6.png">
<meta property="og:image" content="https://weiborao.link/csr1kv-kvm-CentOS7/virt-manager-7.png">
<meta property="og:image" content="https://weiborao.link/csr1kv-kvm-CentOS7/line-chart-009.png">
<meta property="og:image" content="https://weiborao.link/csr1kv-kvm-CentOS7/macvtap-ibm.png">
<meta property="og:image" content="https://weiborao.link/csr1kv-kvm-CentOS7/nic-type-010.png">
<meta property="og:image" content="https://weiborao.link/csr1kv-kvm-CentOS7/pstree-011.png">
<meta property="og:image" content="https://weiborao.link/csr1kv-kvm-CentOS7/virt-top-012.png">
<meta property="article:published_time" content="2021-02-03T05:58:32.000Z">
<meta property="article:modified_time" content="2021-02-05T05:57:29.431Z">
<meta property="article:author" content="Rao Weibo">
<meta property="article:tag" content="CSR1000v">
<meta property="article:tag" content="KVM">
<meta property="article:tag" content="SRIOV">
<meta property="article:tag" content="NetworkManager">
<meta property="article:tag" content="Cisco">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://weiborao.link/csr1kv-kvm-CentOS7/sriov-pool-001.png">


<link rel="canonical" href="https://weiborao.link/csr1kv-kvm-CentOS7.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://weiborao.link/csr1kv-kvm-CentOS7.html","path":"csr1kv-kvm-CentOS7.html","title":"CSR 1000v KVM SRIOV CentOS 7安装设置指南"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>CSR 1000v KVM SRIOV CentOS 7安装设置指南 | Rao Weibo的博客</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Rao Weibo的博客" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Rao Weibo的博客</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#CentOS7-%E5%AE%89%E8%A3%85%E5%8F%8A%E8%AE%BE%E7%BD%AE"><span class="nav-number">1.</span> <span class="nav-text">CentOS7 安装及设置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%881%EF%BC%89BIOS-%E8%AE%BE%E7%BD%AE%E5%BB%BA%E8%AE%AE"><span class="nav-number">1.1.</span> <span class="nav-text">（1）BIOS 设置建议</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%882%EF%BC%89CentOS-7-%E7%9A%84%E5%AE%89%E8%A3%85"><span class="nav-number">1.2.</span> <span class="nav-text">（2）CentOS 7 的安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E5%88%9B%E5%BB%BA%E6%9C%AC%E5%9C%B0-Yum-%E6%BA%90%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89"><span class="nav-number">1.3.</span> <span class="nav-text">（3）创建本地 Yum 源（可选）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%884%EF%BC%89%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BD%91%E5%8D%A1%E9%85%8D%E7%BD%AE%E2%80%94NetworkManager-%E9%85%8D%E7%BD%AE"><span class="nav-number">1.4.</span> <span class="nav-text">（4）服务器网卡配置—NetworkManager 配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%885%EF%BC%89%E9%85%8D%E7%BD%AE-Linux-%E7%BD%91%E6%A1%A5-%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89"><span class="nav-number">1.5.</span> <span class="nav-text">（5）配置 Linux 网桥 （可选）</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE-SR-IOV"><span class="nav-number">2.</span> <span class="nav-text">配置 SR-IOV</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E6%A3%80%E6%9F%A5%E7%BD%91%E5%8D%A1%E5%AF%B9-SR-IOV-%E7%9A%84%E6%94%AF%E6%8C%81%EF%BC%8C%E5%B9%B6%E9%85%8D%E7%BD%AE%E7%BD%91%E5%8D%A1"><span class="nav-number">2.1.</span> <span class="nav-text">（1）检查网卡对 SR-IOV 的支持，并配置网卡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E8%AE%BE%E7%BD%AE%E5%90%AF%E5%8A%A8%E5%8F%82%E6%95%B0"><span class="nav-number">2.2.</span> <span class="nav-text">（2）设置启动参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E9%80%9A%E8%BF%87-nmcli-%E6%8C%81%E4%B9%85%E5%8C%96-VFs-%E9%85%8D%E7%BD%AE"><span class="nav-number">2.3.</span> <span class="nav-text">（3）通过 nmcli 持久化 VFs 配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%884%EF%BC%89%E6%A3%80%E6%9F%A5-VF"><span class="nav-number">2.4.</span> <span class="nav-text">（4）检查 VF</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-KVM-%E7%9A%84%E8%99%9A%E6%8B%9F%E7%BD%91%E7%BB%9C%E9%80%82%E9%85%8D%E5%99%A8%E6%B1%A0"><span class="nav-number">3.</span> <span class="nav-text">使用 KVM 的虚拟网络适配器池</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA-xml-%E6%96%87%E4%BB%B6%E3%80%82"><span class="nav-number">3.1.</span> <span class="nav-text">（1）创建一个 xml 文件。</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E6%A0%B9%E6%8D%AE-xml-%E5%AE%9A%E4%B9%89%E4%B8%80%E4%B8%AA%E7%BD%91%E7%BB%9C%EF%BC%8C%E5%B9%B6%E8%AE%BE%E7%BD%AE%E4%B8%BA%E8%87%AA%E5%8A%A8%E9%87%8D%E5%90%AF"><span class="nav-number">3.2.</span> <span class="nav-text">（2）根据 xml 定义一个网络，并设置为自动重启</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E4%BB%8E%E7%BD%91%E7%BB%9C%E9%80%82%E9%85%8D%E5%99%A8%E6%B1%A0%E4%B8%AD%E5%88%86%E9%85%8D%E7%BD%91%E5%8D%A1%E7%BB%99%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="nav-number">3.3.</span> <span class="nav-text">（3）从网络适配器池中分配网卡给虚拟机</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-Virt-manager-%E5%AE%89%E8%A3%85-CSR1000v"><span class="nav-number">4.</span> <span class="nav-text">使用 Virt-manager 安装 CSR1000v</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#KVM-%E8%B0%83%E4%BC%98%E9%85%8D%E7%BD%AE"><span class="nav-number">5.</span> <span class="nav-text">KVM 调优配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E6%A3%80%E6%9F%A5%E5%B9%B3%E5%8F%B0%E7%9A%84%E8%83%BD%E5%8A%9B"><span class="nav-number">5.1.</span> <span class="nav-text">（1）检查平台的能力</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%882%EF%BC%89NUMA-%E8%B0%83%E4%BC%98"><span class="nav-number">5.2.</span> <span class="nav-text">（2）NUMA 调优</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E5%86%85%E5%AD%98%E5%A4%A7%E9%A1%B5-HugePage-%E4%BB%A5%E5%8F%8A%E9%80%8F%E6%98%8E%E5%A4%A7%E9%A1%B5"><span class="nav-number">5.3.</span> <span class="nav-text">（3）内存大页 HugePage 以及透明大页</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%884%EF%BC%89vCPU-%E9%92%89%E9%80%89"><span class="nav-number">5.4.</span> <span class="nav-text">（4）vCPU 钉选</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%885%EF%BC%89%E7%BC%96%E8%BE%91-CSR-1000v-%E7%9A%84-XML-%E8%B0%83%E4%BC%98%E5%8F%82%E6%95%B0"><span class="nav-number">5.5.</span> <span class="nav-text">（5）编辑 CSR 1000v 的 XML 调优参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%886%EF%BC%89%E5%9C%A8-KVM-%E4%B8%BB%E6%9C%BA%E4%B8%8A%E8%AE%BF%E9%97%AE-CSR1000v-%E7%9A%84-Console"><span class="nav-number">5.6.</span> <span class="nav-text">（6）在 KVM 主机上访问 CSR1000v 的 Console</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%887%EF%BC%89%E6%A3%80%E9%AA%8C-CSR1000v-%E7%9A%84%E8%B0%83%E4%BC%98%E9%85%8D%E7%BD%AE"><span class="nav-number">5.7.</span> <span class="nav-text">（7）检验 CSR1000v 的调优配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%888%EF%BC%89%E5%9C%A8-CSR1KV-%E4%B8%8A%E6%A3%80%E6%9F%A5%E8%99%9A%E6%8B%9F%E7%BD%91%E5%8D%A1"><span class="nav-number">5.8.</span> <span class="nav-text">（8）在 CSR1KV 上检查虚拟网卡</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Linux-%E4%B8%8A%E6%8A%93%E5%8F%96%E8%99%9A%E6%8B%9F%E7%BD%91%E5%8D%A1%E7%9A%84%E6%8A%A5%E6%96%87%EF%BC%88%E5%8F%82%E8%80%83%EF%BC%89"><span class="nav-number">6.</span> <span class="nav-text">Linux 上抓取虚拟网卡的报文（参考）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CSR-1000v-%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E9%85%8D%E7%BD%AE%E5%8F%8A-Smart-License-%E6%B3%A8%E5%86%8C"><span class="nav-number">7.</span> <span class="nav-text">CSR 1000v 的初始化配置及 Smart License 注册</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%881%EF%BC%89CSR-1000v-%E5%88%9D%E5%A7%8B%E5%8C%96%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="nav-number">7.1.</span> <span class="nav-text">（1）CSR 1000v 初始化配置示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="nav-number">7.2.</span> <span class="nav-text">（2）常用命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%883%EF%BC%89CSR-1000v-Smart-License-%E6%B3%A8%E5%86%8C"><span class="nav-number">7.3.</span> <span class="nav-text">（3）CSR 1000v Smart License 注册</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E5%92%8C%E7%9B%B8%E5%85%B3%E9%99%90%E5%88%B6"><span class="nav-number">8.</span> <span class="nav-text">性能和相关限制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%881%EF%BC%89SRIOV-%E7%9A%84%E6%80%A7%E8%83%BD"><span class="nav-number">8.1.</span> <span class="nav-text">（1）SRIOV 的性能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%882%EF%BC%89SRIOV-%E7%9A%84%E9%99%90%E5%88%B6"><span class="nav-number">8.2.</span> <span class="nav-text">（2）SRIOV 的限制</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%99%84%E5%BD%95"><span class="nav-number">9.</span> <span class="nav-text">附录</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%881%EF%BC%89Virt-manager-%E8%AE%BE%E7%BD%AE%E8%99%9A%E6%9C%BA%E7%9A%84-CPU-%E6%A8%A1%E5%BC%8F%E8%AF%B4%E6%98%8E"><span class="nav-number">9.1.</span> <span class="nav-text">（1）Virt-manager 设置虚机的 CPU 模式说明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E6%9C%89%E5%85%B3%E7%BD%91%E5%8D%A1%E6%A8%A1%E5%BC%8F%E7%9A%84%E8%AF%B4%E6%98%8E"><span class="nav-number">9.2.</span> <span class="nav-text">（2）有关网卡模式的说明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E6%9C%89%E5%85%B3-MACVTAP"><span class="nav-number">9.3.</span> <span class="nav-text">（3）有关 MACVTAP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%884%EF%BC%89SR-IOV-%E4%BB%8B%E7%BB%8D"><span class="nav-number">9.4.</span> <span class="nav-text">（4）SR-IOV 介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%EF%BC%885%EF%BC%89%E6%8E%A2%E7%B4%A2%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%BF%9B%E7%A8%8B"><span class="nav-number">9.5.</span> <span class="nav-text">（5）探索虚拟机进程</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99%E8%BF%9E%E6%8E%A5"><span class="nav-number">10.</span> <span class="nav-text">参考资料连接</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Rao Weibo</p>
  <div class="site-description" itemprop="description">记录一些工作、学习相关的笔记</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">10</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/weiborao" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;weiborao" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:raoweibo@gmail.com" title="E-Mail → mailto:raoweibo@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://weiborao.link/csr1kv-kvm-CentOS7.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rao Weibo">
      <meta itemprop="description" content="记录一些工作、学习相关的笔记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rao Weibo的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          CSR 1000v KVM SRIOV CentOS 7安装设置指南
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-03 13:58:32" itemprop="dateCreated datePublished" datetime="2021-02-03T13:58:32+08:00">2021-02-03</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-02-05 13:57:29" itemprop="dateModified" datetime="2021-02-05T13:57:29+08:00">2021-02-05</time>
      </span>

  
</div>

            <div class="post-description">本文提供在 CentOS 7 版本上安装 KVM，并安装和设置 CSR 1000v/Catalyst 8000v 的指南，内容包括 SRIOV，KVM 调优以及 CSR1KV 初始化配置等内容。</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>作者：Rao Weibo</p>
<p>版本：1.0</p>
<p>更新日期：20210203</p>
<p>本文提供在 CentOS 7 版本上安装 KVM，并安装和设置 CSR 1000v/Catalyst 8000v 的指南，内容包括 SRIOV，KVM 调优以及 CSR1KV 初始化配置等内容。</p>
<h1 id="CentOS7-安装及设置"><a href="#CentOS7-安装及设置" class="headerlink" title="CentOS7 安装及设置"></a>CentOS7 安装及设置</h1><h2 id="（1）BIOS-设置建议"><a href="#（1）BIOS-设置建议" class="headerlink" title="（1）BIOS 设置建议"></a>（1）BIOS 设置建议</h2><table>
<thead>
<tr>
<th align="left">Configuration</th>
<th align="left">Recommended Setting</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Intel Hyper-Threading Technology</td>
<td align="left">Disabled</td>
</tr>
<tr>
<td align="left">Number of Enable Cores</td>
<td align="left">ALL</td>
</tr>
<tr>
<td align="left">Execute Disable</td>
<td align="left">Enabled</td>
</tr>
<tr>
<td align="left">Intel VT</td>
<td align="left">Enabled</td>
</tr>
<tr>
<td align="left">Intel VT-D</td>
<td align="left">Enabled</td>
</tr>
<tr>
<td align="left">Intel VT-D coherency support</td>
<td align="left">Enabled</td>
</tr>
<tr>
<td align="left">Intel VT-D ATS support</td>
<td align="left">Enabled</td>
</tr>
<tr>
<td align="left">CPU Performance</td>
<td align="left">High throughput</td>
</tr>
<tr>
<td align="left">Hardware Perfetcher</td>
<td align="left">Disabled</td>
</tr>
<tr>
<td align="left">Adjacent Cache Line Prefetcher</td>
<td align="left">Disabled</td>
</tr>
<tr>
<td align="left">DCU Streamer Prefetch</td>
<td align="left">Disable</td>
</tr>
<tr>
<td align="left">Power Technology</td>
<td align="left">Custom</td>
</tr>
<tr>
<td align="left">Enhanced Intel Speedstep Technology</td>
<td align="left">Disabled</td>
</tr>
<tr>
<td align="left">Intel Turbo Boost Technology</td>
<td align="left">Enabled</td>
</tr>
<tr>
<td align="left">Processor Power State C6</td>
<td align="left">Disabled</td>
</tr>
<tr>
<td align="left">Processor Power State C1 Enhanced</td>
<td align="left">Disabled</td>
</tr>
<tr>
<td align="left">Frequency Poor Override</td>
<td align="left">Enabled</td>
</tr>
<tr>
<td align="left">P-State Coordination</td>
<td align="left">HW_ALL</td>
</tr>
<tr>
<td align="left">Energy Performance</td>
<td align="left">Performance</td>
</tr>
</tbody></table>
<p>以上建议来自 CSR 1000v 的安装指南。</p>
<h2 id="（2）CentOS-7-的安装"><a href="#（2）CentOS-7-的安装" class="headerlink" title="（2）CentOS 7 的安装"></a>（2）CentOS 7 的安装</h2><p>在安装的时候选择</p>
<ul>
<li>Server with GUI</li>
<li>Virtualization Client</li>
<li>Virtualization Hypervisor</li>
<li>Virtualization Tools</li>
</ul>
<p>启动完毕以后关闭 selinux，重启生效。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config</span><br><span class="line"></span><br><span class="line">getenforce		//结果为：Enforcing（开启状态）disabled(关闭状态)</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装完后，SSH登录可能显示中文，可修改 .bash_profile</span></span><br><span class="line"></span><br><span class="line">LANG=&quot;en_US.UTF-8&quot;</span><br><span class="line"></span><br><span class="line">export LANG</span><br><span class="line"></span><br><span class="line">source .bash_profile</span><br><span class="line"></span><br><span class="line">egrep -o &#x27;(vmx|svm)&#x27; /proc/cpuinfo | sort | uniq</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注：在生产环境中，需要在服务器连接的交换机以及出口防火墙上做好安全策略。</span></span><br><span class="line"></span><br><span class="line">systemctl stop firewalld</span><br><span class="line"></span><br><span class="line">systemctl disable firewalld</span><br></pre></td></tr></table></figure>
<p>本文档采用 NetworkManager 配置，故在此并不停用 NetworkManager。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/sysctl.conf</span><br><span class="line"></span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line"></span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 0</span><br><span class="line"></span><br><span class="line">net.bridge.bridge-nf-call-iptables = 0</span><br><span class="line"></span><br><span class="line">net.bridge.bridge-nf-call-arptables = 0</span><br></pre></td></tr></table></figure>
<p>检查 KVM 组件版本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# libvirtd -V</span><br><span class="line"></span><br><span class="line">libvirtd (libvirt) 4.5.0</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# /usr/libexec/qemu-kvm --version</span><br><span class="line"></span><br><span class="line">QEMU emulator version 1.5.3 (qemu-kvm-1.5.3-173.el7_8.3), Copyright (c) 2003-2008 Fabrice Bellard</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# virt-manager --version</span><br><span class="line"></span><br><span class="line">1.5.0</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# modinfo kvm-intel</span><br><span class="line"></span><br><span class="line">filename:       /lib/modules/3.10.0-1127.18.2.el7.x86_64/kernel/arch/x86/kvm/kvm-intel.ko.xz</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# modinfo ixgbevf</span><br><span class="line"></span><br><span class="line">filename:       /lib/modules/3.10.0-1127.18.2.el7.x86_64/kernel/drivers/net/ethernet/intel/ixgbevf/ixgbevf.ko.xz</span><br><span class="line"></span><br><span class="line">version:        4.1.0-k-rh7.7</span><br></pre></td></tr></table></figure>
<h2 id="（3）创建本地-Yum-源（可选）"><a href="#（3）创建本地-Yum-源（可选）" class="headerlink" title="（3）创建本地 Yum 源（可选）"></a>（3）创建本地 Yum 源（可选）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1、备份本地/etc/yum.repos.d 目录下的yum源</span></span><br><span class="line"></span><br><span class="line">cd /etc/yum.repos.d/</span><br><span class="line"></span><br><span class="line">mkdir bak</span><br><span class="line"></span><br><span class="line">mv C* bak/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2、上传CentOS-7-x86_64-Everything-2009.iso镜像到/opt</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3、挂载镜像</span></span><br><span class="line"></span><br><span class="line">mkdir -p /media/cdrom</span><br><span class="line"></span><br><span class="line">mount -t iso9660 -o loop /opt/CentOS-7-x86_64-Everything-2009.iso /media/cdrom/</span><br><span class="line"></span><br><span class="line">mount		//查看挂载信息</span><br><span class="line"></span><br><span class="line">df -h</span><br><span class="line"></span><br><span class="line">vi /etc/fstab</span><br><span class="line"></span><br><span class="line">/opt/CentOS-7-x86_64-Everything-2009.iso    /media/cdrom    iso9660 loop 0 0</span><br><span class="line"></span><br><span class="line">tail -1 /etc/fstab		//查看是否写入/etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 4、配置本地yum源</span></span><br><span class="line"></span><br><span class="line">cd /etc/yum.repos.d/</span><br><span class="line"></span><br><span class="line">vi local.repo</span><br><span class="line"></span><br><span class="line">[local]</span><br><span class="line"></span><br><span class="line">name=local</span><br><span class="line"></span><br><span class="line">baseurl=file:///media/cdrom	   //前面的file://是协议,后面的/media/cdrom是光盘挂载点</span><br><span class="line"></span><br><span class="line">gpgcheck=0		//1使用公钥验证rpm包的正确性,0不验证</span><br><span class="line"></span><br><span class="line">enabled=1		//1启用yum源,0禁用yum源</span><br><span class="line"></span><br><span class="line">yum install -y numactl telnet</span><br></pre></td></tr></table></figure>
<p>运行 virt-manager 启动图形化界面。</p>
<p>如果对 virsh CLI 命令熟悉，可以使用 virsh 命令创建虚拟机。</p>
<h2 id="（4）服务器网卡配置—NetworkManager-配置"><a href="#（4）服务器网卡配置—NetworkManager-配置" class="headerlink" title="（4）服务器网卡配置—NetworkManager 配置"></a>（4）服务器网卡配置—NetworkManager 配置</h2><p>在终端界面，可以通过 nmtui 打开图形化界面进行设置；以下使用 nmcli 进行设置。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection add con-name eno1 type ethernet autoconnect yes ifname eno1</span><br><span class="line"></span><br><span class="line">nmcli connection modify eno1 ipv4.method manual ipv4.addresses 10.75.58.43/24 ipv4.gateway 10.75.58.1 ipv4.dns 64.104.123.245</span><br><span class="line"></span><br><span class="line">nmcli connection up eno1</span><br><span class="line"></span><br><span class="line">nmcli connection show eno1</span><br><span class="line"></span><br><span class="line">ping 10.75.58.1</span><br></pre></td></tr></table></figure>
<p>上述命令完成后，在/etc/sysconfig/network-scripts 中会生成网卡的 ifcfg 配置文件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/sysconfig/network-scripts/ifcfg-eno1</span><br><span class="line"></span><br><span class="line">HWADDR=70:7D:B9:59:5B:AE</span><br><span class="line"></span><br><span class="line">TYPE=Ethernet</span><br><span class="line"></span><br><span class="line">PROXY_METHOD=none</span><br><span class="line"></span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line"></span><br><span class="line">BOOTPROTO=none</span><br><span class="line"></span><br><span class="line">IPADDR=10.75.58.43</span><br><span class="line"></span><br><span class="line">PREFIX=24</span><br><span class="line"></span><br><span class="line">GATEWAY=10.75.58.1</span><br><span class="line"></span><br><span class="line">DNS1=64.104.123.245</span><br><span class="line"></span><br><span class="line">DEFROUTE=yes</span><br><span class="line"></span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line"></span><br><span class="line">IPV6INIT=yes</span><br><span class="line"></span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line"></span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line"></span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line"></span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line"></span><br><span class="line">NAME=eno1</span><br><span class="line"></span><br><span class="line">UUID=2a1c8b39-7f44-321b-a65f-a93e70ab0616</span><br><span class="line"></span><br><span class="line">ONBOOT=yes</span><br><span class="line"></span><br><span class="line">AUTOCONNECT_PRIORITY=-999</span><br><span class="line"></span><br><span class="line">DEVICE=eno1</span><br></pre></td></tr></table></figure>
<p>此时，可以将 network.service 停止和关闭。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop network</span><br><span class="line"></span><br><span class="line">systemctl disable network</span><br></pre></td></tr></table></figure>
<p>注意，如果 NetworkManager 未设置妥当，执行 systemctl stop network 后，会导致服务器无法管理。</p>
<p>准备开启 SRIOV 的网卡设置，以 eno2 为例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection add con-name eno2 <span class="built_in">type</span> ethernet autoconnect yes ifname eno2</span><br><span class="line"></span><br><span class="line">nmcli connection modify eno2 ethernet.mtu 9216 ipv4.method disabled</span><br><span class="line"></span><br><span class="line">nmcli connection up eno2</span><br><span class="line"></span><br><span class="line">nmcli connection show eno2</span><br><span class="line"></span><br><span class="line">ip link show dev eno2</span><br></pre></td></tr></table></figure>
<p>注：上述 MTU 值设置为 9216 是借鉴自 Cisco NFVIS 平台，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">CSP5228-1# show pnic-detail mtu</span><br><span class="line"></span><br><span class="line">Name          MTU</span><br><span class="line"></span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">eth0-1        9216</span><br><span class="line"></span><br><span class="line">eth0-2        9216</span><br><span class="line"></span><br><span class="line">eth1-1        9216</span><br><span class="line"></span><br><span class="line">eth1-2        9216</span><br></pre></td></tr></table></figure>
<h2 id="（5）配置-Linux-网桥-（可选）"><a href="#（5）配置-Linux-网桥-（可选）" class="headerlink" title="（5）配置 Linux 网桥 （可选）"></a>（5）配置 Linux 网桥 （可选）</h2><p>网桥 br1 配置示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection add con-name br1 <span class="built_in">type</span> bridge autoconnect yes ipv4.method disabled ethernet.mtu 9216 ifname br1</span><br><span class="line"></span><br><span class="line">nmcli connection up br1</span><br><span class="line"></span><br><span class="line">ip link show dev br1</span><br></pre></td></tr></table></figure>
<p>网桥 br1 的物理网卡配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection add con-name eno5 <span class="built_in">type</span> ethernet autoconnect yes ifname eno5</span><br><span class="line"></span><br><span class="line">nmcli connection modify eno5 ethernet.mtu 9216 ipv4.method disabled master br1</span><br><span class="line"></span><br><span class="line">nmcli connection up eno5</span><br><span class="line"></span><br><span class="line">ip link show dev eno5</span><br></pre></td></tr></table></figure>
<p>创建 net-br1 网络</p>
<p>[root@centos7 ~]# cat net-br1.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">network</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">name</span>&gt;</span>net-br1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">forward</span> <span class="attr">mode</span>=<span class="string">&quot;bridge&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">name</span>=<span class="string">&quot;br1&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">network</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># virsh net-define net-br1.xml</span></span><br><span class="line"></span><br><span class="line">Network net-br1 defined from net-br1.xml</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># virsh net-start net-br1</span></span><br><span class="line"></span><br><span class="line">Network net-br1 started</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># virsh net-autostart net-br1</span></span><br><span class="line"></span><br><span class="line">Network net-br1 marked as autostarted</span><br></pre></td></tr></table></figure>
<h1 id="配置-SR-IOV"><a href="#配置-SR-IOV" class="headerlink" title="配置 SR-IOV"></a>配置 SR-IOV</h1><h2 id="（1）检查网卡对-SR-IOV-的支持，并配置网卡"><a href="#（1）检查网卡对-SR-IOV-的支持，并配置网卡" class="headerlink" title="（1）检查网卡对 SR-IOV 的支持，并配置网卡"></a>（1）检查网卡对 SR-IOV 的支持，并配置网卡</h2><p>可使用 lshw 和 lspci 检查网卡对 SR-IOV 的支持</p>
<p>lshw -c network -businfo</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Bus info          Device      Class          Description</span><br><span class="line"></span><br><span class="line">========================================================</span><br><span class="line"></span><br><span class="line">pci@0000:1d:00.0  eno5        network        VIC Ethernet NIC</span><br><span class="line"></span><br><span class="line">pci@0000:1d:00.1  eno6        network        VIC Ethernet NIC</span><br><span class="line"></span><br><span class="line">pci@0000:1d:00.2  eno7        network        VIC Ethernet NIC</span><br><span class="line"></span><br><span class="line">pci@0000:1d:00.3  eno8        network        VIC Ethernet NIC</span><br><span class="line"></span><br><span class="line">pci@0000:3b:00.0  eno1        network        Ethernet Controller 10G X550T</span><br><span class="line"></span><br><span class="line">pci@0000:3b:00.1  eno2        network        Ethernet Controller 10G X550T</span><br></pre></td></tr></table></figure>
<p>lspci -vv -s 3b:00.1 | grep -A 5 -i SR-IOV</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Capabilities: [160 v1] Single Root I/O Virtualization (SR-IOV)</span><br><span class="line"></span><br><span class="line">  IOVCap:	Migration-, Interrupt Message Number: 000</span><br><span class="line"></span><br><span class="line">	IOVCtl:	Enable+ Migration- Interrupt- MSE+ ARIHierarchy-</span><br><span class="line"></span><br><span class="line">	IOVSta:	Migration-</span><br><span class="line"></span><br><span class="line">	Initial VFs: 64, Total VFs: 64, Number of VFs: 8, Function Dependency Link: 01</span><br><span class="line"></span><br><span class="line">	VF offset: 128, stride: 2, Device ID: 1565</span><br></pre></td></tr></table></figure>
<h2 id="（2）设置启动参数"><a href="#（2）设置启动参数" class="headerlink" title="（2）设置启动参数"></a>（2）设置启动参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/default/grub</span><br><span class="line"></span><br><span class="line">GRUB_CMDLINE_LINUX=&quot;crashkernel=auto spectre_v2=retpoline rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet hugepagesz=1G hugepages=32 default_hugepagesz=1G intel_iommu=on iommu=pt isolcpus=1-8,37-44&quot;</span><br><span class="line"></span><br><span class="line">注：页面数字不要过大，不然启动失败，如果后续不够，可以在运行时添加。</span><br><span class="line"></span><br><span class="line">grub2-mkconfig -o /boot/grub2/grub.cfg</span><br><span class="line"></span><br><span class="line">grub2-mkconfig -o /boot/efi/EFI/centos/grub.cfg</span><br><span class="line"></span><br><span class="line">iommu=pt 参数是将SRIOV设备支持PCI Passthrough</span><br></pre></td></tr></table></figure>
<p>重启后验证</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/cmdline |grep intel_iommu=on</span><br><span class="line"></span><br><span class="line">dmesg |grep -e DMAR -e IOMMU</span><br><span class="line"></span><br><span class="line">dmesg | grep -e DMAR -e IOMMU -e AMD-Vi</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>default_hugepagesz=1G hugepagesz=1G hugepages=32</strong> 参数设置主机在启动时分配 32 个 1GB 的内存大页，这些是静态内存大页。 CSR 1000v 虚拟机将试用这些静态大页以获得最优性能。</li>
<li><strong>isolcpus=1-8,37-44</strong> 参数设置的作用是隔离 1-8，37-44 的 CPU 核，使其独立于内核的平衡调度算法，也就是内核本身不会将进程分配到被隔离的 CPU。之后我们可将指定的进程 CSR 1000v 虚拟机绑定到被隔离的 CPU 上运行，让进程独占 CPU，使其实时性可得到一定程度的提高。</li>
</ul>
<p>可参考 这个章节获取主机 CPU 核的相关信息。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@centos7 ~]# cat /proc/cmdline |grep intel_iommu=on</span><br><span class="line"></span><br><span class="line">BOOT_IMAGE=/vmlinuz-3.10.0-1127.el7.x86_64 root=/dev/mapper/centos-root ro crashkernel=auto spectre_v2=retpoline rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet hugepagesz=1G hugepages=32 default_hugepagesz=1G intel_iommu=on iommu=pt LANG=en_US.UTF-8</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# dmesg |grep -e DMAR -e IOMMU</span><br><span class="line"></span><br><span class="line">[    0.000000] ACPI: DMAR 000000005d6f5d70 00250 (v01 Cisco0 CiscoUCS 00000001 INTL 20091013)</span><br><span class="line"></span><br><span class="line">[    0.000000] DMAR: IOMMU enabled</span><br></pre></td></tr></table></figure>
<p>查看隔离的 CPU 核以及所有的 CPU 核。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cat /sys/devices/system/cpu/isolated</span></span><br><span class="line"></span><br><span class="line">1-8,37-44</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># cat /sys/devices/system/cpu/present</span></span><br><span class="line"></span><br><span class="line">0-71</span><br></pre></td></tr></table></figure>
<h2 id="（3）通过-nmcli-持久化-VFs-配置"><a href="#（3）通过-nmcli-持久化-VFs-配置" class="headerlink" title="（3）通过 nmcli 持久化 VFs 配置"></a>（3）通过 nmcli 持久化 VFs 配置</h2><p>nmcli 可以设置网卡的 sriov 参数，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection modify eno2 sriov.total-vfs 4</span><br></pre></td></tr></table></figure>
<p>还可以设置每一个 VF 设备的 MAC 地址，便于管理：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection modify eno2 sriov.vfs <span class="string">&#x27;0 mac=8E:DF:08:C1:D1:DE trust=true, 1 mac=5A:B9:2F:99:A6:CE trust=true, 2 mac=46:78:69:E3:71:3D trust=true, 3 mac=7E:A7:DB:3B:1B:B3 trust=true&#x27;</span></span><br></pre></td></tr></table></figure>
<p>执行上述命令后：</p>
<p>cat /etc/sysconfig/network-scripts/ifcfg-eno2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">TYPE=Ethernet</span><br><span class="line"></span><br><span class="line">NAME=eno2</span><br><span class="line"></span><br><span class="line">UUID=64ffa204-0158-40c8-ba86-2b7aebf27619</span><br><span class="line"></span><br><span class="line">DEVICE=eno2</span><br><span class="line"></span><br><span class="line">ONBOOT=yes</span><br><span class="line"></span><br><span class="line">MTU=9216</span><br><span class="line"></span><br><span class="line">HWADDR=70:7D:B9:59:5B:AF</span><br><span class="line"></span><br><span class="line">PROXY_METHOD=none</span><br><span class="line"></span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line"></span><br><span class="line">IPV6INIT=no</span><br><span class="line"></span><br><span class="line">SRIOV_TOTAL_VFS=4</span><br><span class="line"></span><br><span class="line">SRIOV_VF0=<span class="string">&quot;mac=8E:DF:08:C1:D1:DE trust=true&quot;</span></span><br><span class="line"></span><br><span class="line">SRIOV_VF1=<span class="string">&quot;mac=5A:B9:2F:99:A6:CE trust=true&quot;</span></span><br><span class="line"></span><br><span class="line">SRIOV_VF2=<span class="string">&quot;mac=46:78:69:E3:71:3D trust=true&quot;</span></span><br><span class="line"></span><br><span class="line">SRIOV_VF3=<span class="string">&quot;mac=7E:A7:DB:3B:1B:B3 trust=true&quot;</span></span><br></pre></td></tr></table></figure>
<p>重启后，检查 dmesg：</p>
<p>dmesg | grep -i vf | grep -i eno2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[   11.953333] ixgbe 0000:3b:00.1 eno2: SR-IOV enabled with 4 VFs</span><br><span class="line"></span><br><span class="line">[   12.541801] ixgbe 0000:3b:00.1: setting MAC 8e:df:08:c1:d1:de on VF 0</span><br><span class="line"></span><br><span class="line">[   12.541805] ixgbe 0000:3b:00.1: Reload the VF driver to make this change effective.</span><br><span class="line"></span><br><span class="line">[   12.541841] ixgbe 0000:3b:00.1 eno2: VF 0 is trusted</span><br><span class="line"></span><br><span class="line">[   12.541846] ixgbe 0000:3b:00.1: setting MAC 5a:b9:2f:99:a6:ce on VF 1</span><br><span class="line"></span><br><span class="line">[   12.541850] ixgbe 0000:3b:00.1: Reload the VF driver to make this change effective.</span><br><span class="line"></span><br><span class="line">[   12.541883] ixgbe 0000:3b:00.1 eno2: VF 1 is trusted</span><br><span class="line"></span><br><span class="line">[   12.541887] ixgbe 0000:3b:00.1: setting MAC 46:78:69:e3:71:3d on VF 2</span><br><span class="line"></span><br><span class="line">[   12.541891] ixgbe 0000:3b:00.1: Reload the VF driver to make this change effective.</span><br><span class="line"></span><br><span class="line">[   12.541923] ixgbe 0000:3b:00.1 eno2: VF 2 is trusted</span><br><span class="line"></span><br><span class="line">[   12.541928] ixgbe 0000:3b:00.1: setting MAC 7e:a7:db:3b:1b:b3 on VF 3</span><br><span class="line"></span><br><span class="line">[   12.541932] ixgbe 0000:3b:00.1: Reload the VF driver to make this change effective.</span><br><span class="line"></span><br><span class="line">[   12.541965] ixgbe 0000:3b:00.1 eno2: VF 3 is trusted</span><br></pre></td></tr></table></figure>
<h2 id="（4）检查-VF"><a href="#（4）检查-VF" class="headerlink" title="（4）检查 VF"></a>（4）检查 VF</h2><p>可通过 lspci 和 ip link 检查 VF，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># lspci | grep -i Virtual</span></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># ip link show | grep -B2 vf</span></span><br></pre></td></tr></table></figure>
<p>寻找 Physical Function 和 Virtual Function 之间的对应关系：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># ls -l /sys/class/net/eno1/device/ | grep virtfn</span></span><br></pre></td></tr></table></figure>
<p>VF 被创建后，NetworkManager 自动给新的设备创建 Connection，可以修改名称，如下：</p>
<p>nmcli connection</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">NAME        UUID                                  TYPE      DEVICE</span><br><span class="line"></span><br><span class="line">eno1        2a1c8b39-7f44-321b-a65f-a93e70ab0616  ethernet  eno1</span><br><span class="line"></span><br><span class="line">eno2        64ffa204-0158-40c8-ba86-2b7aebf27619  ethernet  eno2</span><br><span class="line"></span><br><span class="line">enp59s16f1  19c28a93-aa36-38e6-a556-55a922a0a332  ethernet  enp59s16f1</span><br><span class="line"></span><br><span class="line">enp59s16f3  428d9707-1515-3475-b356-7eb229c3f937  ethernet  enp59s16f3</span><br><span class="line"></span><br><span class="line">enp59s16f5  21a8dd5f-239f-37b2-9b09-24ce0e7413bc  ethernet  enp59s16f5</span><br><span class="line"></span><br><span class="line">enp59s16f7  0ca0da65-64c4-314d-89a4-4213f9e4f478  ethernet  enp59s16f7</span><br></pre></td></tr></table></figure>
<p>修改名称：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection modify uuid 19c28a93-aa36-38e6-a556-55a922a0a332 connection.id enp59s16f1</span><br></pre></td></tr></table></figure>
<p>修改 MTU 值，并禁用 IPv4 和 IPv6，网卡启动更快</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection modify enp59s16f1 ifname enp59s16f1 ipv4.method disabled ipv6.method ignore ethernet.mtu 9216 ethernet.mac-address <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">nmcli connection up enp59s16f1</span><br><span class="line"></span><br><span class="line">nmcli connection show enp59s16f1</span><br></pre></td></tr></table></figure>
<p>上述命令生成的 ifcfg 配置文件如下：</p>
<p>[root@centos7 ~]# cat /etc/sysconfig/network-scripts/ifcfg-enp59s16f1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">TYPE=Ethernet</span><br><span class="line"></span><br><span class="line">PROXY_METHOD=none</span><br><span class="line"></span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line"></span><br><span class="line">DEFROUTE=yes</span><br><span class="line"></span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line"></span><br><span class="line">IPV6INIT=no</span><br><span class="line"></span><br><span class="line">IPV6_AUTOCONF=no</span><br><span class="line"></span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line"></span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line"></span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line"></span><br><span class="line">NAME=enp59s16f1</span><br><span class="line"></span><br><span class="line">UUID=19c28a93-aa36-38e6-a556-55a922a0a332</span><br><span class="line"></span><br><span class="line">ONBOOT=yes</span><br><span class="line"></span><br><span class="line">AUTOCONNECT_PRIORITY=-999</span><br><span class="line"></span><br><span class="line">DEVICE=enp59s16f1</span><br><span class="line"></span><br><span class="line">MTU=9216</span><br></pre></td></tr></table></figure>
<p>这样，即便系统重启，上述配置依然能生效。</p>
<h1 id="使用-KVM-的虚拟网络适配器池"><a href="#使用-KVM-的虚拟网络适配器池" class="headerlink" title="使用 KVM 的虚拟网络适配器池"></a>使用 KVM 的虚拟网络适配器池</h1><p>主机上创建一个 VF 网络设备的资源池，资源池内的设备可以自动地分配给虚拟机使用。</p>
<h2 id="（1）创建一个-xml-文件。"><a href="#（1）创建一个-xml-文件。" class="headerlink" title="（1）创建一个 xml 文件。"></a>（1）创建一个 xml 文件。</h2><p>[root@centos7 ~]# cat eno2_sriov_pool.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">network</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>eno2_sriov_pool<span class="tag">&lt;/<span class="name">name</span>&gt;</span> <span class="comment">&lt;!-- This is the name of the file you created --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">forward</span> <span class="attr">mode</span>=<span class="string">&#x27;hostdev&#x27;</span> <span class="attr">managed</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">pf</span> <span class="attr">dev</span>=<span class="string">&#x27;eno2&#x27;</span>/&gt;</span> <span class="comment">&lt;!-- Use the netdev name of your SR-IOV devices PF here --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">forward</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">network</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="（2）根据-xml-定义一个网络，并设置为自动重启"><a href="#（2）根据-xml-定义一个网络，并设置为自动重启" class="headerlink" title="（2）根据 xml 定义一个网络，并设置为自动重启"></a>（2）根据 xml 定义一个网络，并设置为自动重启</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">virsh net-define eno2_sriov_pool.xml</span><br><span class="line"></span><br><span class="line">virsh net-start eno2_sriov_pool</span><br><span class="line"></span><br><span class="line">virsh net-autostart eno2_sriov_pool</span><br></pre></td></tr></table></figure>
<p>[root@centos7 ~]# virsh net-dumpxml eno2_sriov_pool</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">network</span> <span class="attr">connections</span>=<span class="string">&#x27;1&#x27;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">name</span>&gt;</span>eno2_sriov_pool<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>e0842451-0137-4255-8783-305ca27f082d<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">forward</span> <span class="attr">mode</span>=<span class="string">&#x27;hostdev&#x27;</span> <span class="attr">managed</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">pf</span> <span class="attr">dev</span>=<span class="string">&#x27;eno2&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x3b&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x10&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x1&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x3b&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x10&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x3&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x3b&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x10&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x5&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x3b&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x10&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x7&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;/<span class="name">forward</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">network</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="（3）从网络适配器池中分配网卡给虚拟机"><a href="#（3）从网络适配器池中分配网卡给虚拟机" class="headerlink" title="（3）从网络适配器池中分配网卡给虚拟机"></a>（3）从网络适配器池中分配网卡给虚拟机</h2><p>用这种方法添加 SRIOV 网卡比较简单：</p>
<img src="/csr1kv-kvm-CentOS7/sriov-pool-001.png" class="" title="SRIOV Adapter Pool">

<p>按照如上方法添加网卡，等同于以下 xml 配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;network&#x27;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;52:54:00:2d:87:99&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">source</span> <span class="attr">network</span>=<span class="string">&#x27;eno2_sriov_pool&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x04&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>开机后 dumpxml 如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">  <span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;hostdev&#x27;</span> <span class="attr">managed</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;52:54:00:2d:87:99&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;vfio&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">source</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x3b&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x10&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x1&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;hostdev0&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x0f&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="使用-Virt-manager-安装-CSR1000v"><a href="#使用-Virt-manager-安装-CSR1000v" class="headerlink" title="使用 Virt-manager 安装 CSR1000v"></a>使用 Virt-manager 安装 CSR1000v</h1><p>在 CentOS 图形界面中，打开 Terminal，运行 virt-manager，按照以下步骤创建 CSR1000v；添加网卡，并选择 en2_sriov_pool。</p>
<img src="/csr1kv-kvm-CentOS7/virt-manager-1.png" class="" title="Step 1">

<img src="/csr1kv-kvm-CentOS7/virt-manager-2.png" class="" title="选择镜像">

<img src="/csr1kv-kvm-CentOS7/virt-manager-3.png" class="" title="Step 2">

<img src="/csr1kv-kvm-CentOS7/virt-manager-3.png" class="" title="Step 3">

<img src="/csr1kv-kvm-CentOS7/virt-manager-5.png" class="" title="Step 4">

<p>注：csr1kv-1 的第一个网口选择<strong>macvtap Bridge</strong>模式，这样就无需创建一个 Linux 网桥。但是，csr1kv-1 启动以后不能通过该接口与 Linux 主机进行通信，仅能通过该接口访问 Linux 主机外的网络。</p>
<img src="/csr1kv-kvm-CentOS7/virt-manager-6.png" class="" title="Step 5">

<img src="/csr1kv-kvm-CentOS7/virt-manager-7.png" class="" title="Step 6">

<p>添加完网卡后，点击开始安装，然后就可以关闭虚拟机了。上述操作完成后，virt-manager 会在**/etc/libvirtd/qemu/<strong>目录下创建</strong>csr1kv-1.xml**。</p>
<h1 id="KVM-调优配置"><a href="#KVM-调优配置" class="headerlink" title="KVM 调优配置"></a>KVM 调优配置</h1><p>KVM 的调优比较复杂，主要是 NUMA、内存大页、vCPU PIN 等，参考资料为 Redhat Linux 7 PERFORMANCE TUNING GUIDE。</p>
<h2 id="（1）检查平台的能力"><a href="#（1）检查平台的能力" class="headerlink" title="（1）检查平台的能力"></a>（1）检查平台的能力</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># virsh nodeinfo</span></span><br><span class="line"></span><br><span class="line">CPU model:           x86_64</span><br><span class="line"></span><br><span class="line">CPU(s):              72</span><br><span class="line"></span><br><span class="line">CPU frequency:       999 MHz</span><br><span class="line"></span><br><span class="line">CPU socket(s):       1</span><br><span class="line"></span><br><span class="line">Core(s) per socket:  18</span><br><span class="line"></span><br><span class="line">Thread(s) per core:  2</span><br><span class="line"></span><br><span class="line">NUMA cell(s):        2</span><br><span class="line"></span><br><span class="line">Memory size:         263665612 KiB</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># virsh capabilities</span></span><br><span class="line"></span><br><span class="line">&lt;capabilities&gt;</span><br><span class="line"></span><br><span class="line"> &lt;host&gt;</span><br><span class="line"></span><br><span class="line">  &lt;uuid&gt;4e53df1f-5b36-6842-99ee-1369d7c68730&lt;/uuid&gt;</span><br><span class="line"></span><br><span class="line">  &lt;cpu&gt;</span><br><span class="line"></span><br><span class="line">   &lt;arch&gt;x86_64&lt;/arch&gt;</span><br><span class="line"></span><br><span class="line">   &lt;model&gt;Skylake-Server-IBRS&lt;/model&gt;</span><br><span class="line"></span><br><span class="line">   &lt;vendor&gt;Intel&lt;/vendor&gt;</span><br><span class="line"></span><br><span class="line">   &lt;microcode version=<span class="string">&#x27;33581318&#x27;</span>/&gt;</span><br><span class="line"></span><br><span class="line">   &lt;counter name=<span class="string">&#x27;tsc&#x27;</span> frequency=<span class="string">&#x27;2294597000&#x27;</span> scaling=<span class="string">&#x27;yes&#x27;</span>/&gt;</span><br><span class="line"></span><br><span class="line">   &lt;topology sockets=<span class="string">&#x27;1&#x27;</span> cores=<span class="string">&#x27;18&#x27;</span> threads=<span class="string">&#x27;2&#x27;</span>/&gt;</span><br><span class="line"></span><br><span class="line">……</span><br></pre></td></tr></table></figure>
<p>可检查平台的 CPU 核数、分布，内存的 NUMA 分布等。</p>
<h2 id="（2）NUMA-调优"><a href="#（2）NUMA-调优" class="headerlink" title="（2）NUMA 调优"></a>（2）NUMA 调优</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># numactl --hardware</span></span><br><span class="line"></span><br><span class="line">available: 2 nodes (0-1)</span><br><span class="line"></span><br><span class="line">node 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53</span><br><span class="line"></span><br><span class="line">node 0 size: 128491 MB</span><br><span class="line"></span><br><span class="line">node 0 free: 112157 MB</span><br><span class="line"></span><br><span class="line">node 1 cpus: 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71</span><br><span class="line"></span><br><span class="line">node 1 size: 128994 MB</span><br><span class="line"></span><br><span class="line">node 1 free: 124120 MB</span><br><span class="line"></span><br><span class="line">node distances:</span><br><span class="line"></span><br><span class="line">node  0  1</span><br><span class="line"></span><br><span class="line"> 0: 10 21</span><br><span class="line"></span><br><span class="line"> 1: 21 10</span><br></pre></td></tr></table></figure>
<p>两颗 CPU，每颗 CPU 各有 128GB 内存，分别是 node 0 和 node 1。</p>
<h2 id="（3）内存大页-HugePage-以及透明大页"><a href="#（3）内存大页-HugePage-以及透明大页" class="headerlink" title="（3）内存大页 HugePage 以及透明大页"></a>（3）内存大页 HugePage 以及透明大页</h2><p><code> </code>cat /proc/meminfo | grep HugePages 查看当前系统有多少个大页：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cat /proc/meminfo | grep Huge</span></span><br><span class="line"></span><br><span class="line">AnonHugePages:   1685504 kB</span><br><span class="line"></span><br><span class="line">HugePages_Total:      64</span><br><span class="line"></span><br><span class="line">HugePages_Free:       60</span><br><span class="line"></span><br><span class="line">HugePages_Rsvd:        0</span><br><span class="line"></span><br><span class="line">HugePages_Surp:        0</span><br><span class="line"></span><br><span class="line">Hugepagesize:    1048576 kB</span><br></pre></td></tr></table></figure>
<p>在系统运行时修改大页数量：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cat /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages</span></span><br><span class="line"></span><br><span class="line">16</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># echo 32 &gt; /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages</span></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># echo 32 &gt; /sys/devices/system/node/node1/hugepages/hugepages-1048576kB/nr_hugepages</span></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment">#</span></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># numastat -cm | egrep &#x27;Node|Huge&#x27;</span></span><br><span class="line"></span><br><span class="line">`                 `Node 0 Node 1  Total</span><br><span class="line"></span><br><span class="line">AnonHugePages     10962   1528  12490</span><br><span class="line"></span><br><span class="line">HugePages_Total   32768  32768  65536</span><br><span class="line"></span><br><span class="line">HugePages_Free    32768  32768  65536</span><br><span class="line"></span><br><span class="line">HugePages_Surp        0      0      0</span><br></pre></td></tr></table></figure>
<p>检查透明大页参数，在 CentOS7 上缺省开启；开启了透明大页，不影响静态大页的使用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line"></span><br><span class="line">[always] madvise never</span><br></pre></td></tr></table></figure>
<h2 id="（4）vCPU-钉选"><a href="#（4）vCPU-钉选" class="headerlink" title="（4）vCPU 钉选"></a>（4）vCPU 钉选</h2><p>设置 CPU Affinity 的好处是提高 CPU 缓存效率，避免进程在多个 CPU 核之间跳跃，切换 CPU 核均会导致缓存中的数据无效，缓存命中率大幅降低，导致数据获取的开销居高不下，损失性能。</p>
<p><strong>virsh vcpuinfo csr1kv-1</strong> 可以查看 vCPU 的分配。</p>
<h2 id="（5）编辑-CSR-1000v-的-XML-调优参数"><a href="#（5）编辑-CSR-1000v-的-XML-调优参数" class="headerlink" title="（5）编辑 CSR 1000v 的 XML 调优参数"></a>（5）编辑 CSR 1000v 的 XML 调优参数</h2><p>virsh edit csr1kv-1 可以编辑 XML 的参数，如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">memoryBacking</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">hugepages</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">page</span> <span class="attr">size</span>=<span class="string">&#x27;1048576&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">hugepages</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">locked</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">nosharepages</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">memoryBacking</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">vcpu</span> <span class="attr">placement</span>=<span class="string">&#x27;static&#x27;</span>&gt;</span>8<span class="tag">&lt;/<span class="name">vcpu</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">cputune</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;3&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;4&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;5&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;5&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;6&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;6&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;7&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;7&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;8&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">emulatorpin</span> <span class="attr">cpuset</span>=<span class="string">&#x27;45-52&#x27;</span>/&gt;</span> <span class="comment">&lt;!-- If Hyper-threading were enabled --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cputune</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">numatune</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">memory</span> <span class="attr">mode</span>=<span class="string">&#x27;strict&#x27;</span> <span class="attr">nodeset</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">numatune</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">cpu</span> <span class="attr">mode</span>=<span class="string">&#x27;host-passthrough&#x27;</span> <span class="attr">check</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">memballoon</span> <span class="attr">model</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>注：**<emulatorpin cpuset='37-44'/>** 参数，仅当 Hyper-Threating 开启时使用；有一些平台并未关闭超线程，例如 Cisco 专门的 NFV 平台 CSP。通过 virsh chapabilities 查看 siblings=’1,37’，当 core 1 设置为 vcpupin 时，core 37 应设置到 emulatorpin cpuset 中。</p>
<p>以下关于 CPU 和内存的参数设定建议来自于<a target="_blank" rel="noopener" href="https://libvirt.org/formatdomain.html">https://libvirt.org/formatdomain.html</a> 和 <a target="_blank" rel="noopener" href="https://libvirt.org/kbase/kvm-realtime.html">https://libvirt.org/kbase/kvm-realtime.html</a></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">domain</span> <span class="attr">type</span>=<span class="string">&#x27;kvm&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>csr1kv-1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>59581018-6387-49df-ab09-2bcf40fc12ba<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">memory</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>&gt;</span>8388608<span class="tag">&lt;/<span class="name">memory</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">currentMemory</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>&gt;</span>8388608<span class="tag">&lt;/<span class="name">currentMemory</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">memoryBacking</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hugepages</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">page</span> <span class="attr">size</span>=<span class="string">&#x27;1048576&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">hugepages</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">locked</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">nosharepages</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">memoryBacking</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpu</span> <span class="attr">placement</span>=<span class="string">&#x27;static&#x27;</span>&gt;</span>8<span class="tag">&lt;/<span class="name">vcpu</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">cputune</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;3&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;4&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;5&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;5&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;6&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;6&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;7&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;7&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;8&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">emulatorpin</span> <span class="attr">cpuset</span>=<span class="string">&#x27;37-44&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">cputune</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">numatune</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">memory</span> <span class="attr">mode</span>=<span class="string">&#x27;strict&#x27;</span> <span class="attr">nodeset</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">numatune</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">os</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span> <span class="attr">arch</span>=<span class="string">&#x27;x86_64&#x27;</span> <span class="attr">machine</span>=<span class="string">&#x27;pc-i440fx-rhel7.0.0&#x27;</span>&gt;</span>hvm<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">boot</span> <span class="attr">dev</span>=<span class="string">&#x27;hd&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">os</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">features</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">acpi</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">apic</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">features</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">cpu</span> <span class="attr">mode</span>=<span class="string">&#x27;host-passthrough&#x27;</span> <span class="attr">check</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">clock</span> <span class="attr">offset</span>=<span class="string">&#x27;utc&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">timer</span> <span class="attr">name</span>=<span class="string">&#x27;rtc&#x27;</span> <span class="attr">tickpolicy</span>=<span class="string">&#x27;catchup&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">timer</span> <span class="attr">name</span>=<span class="string">&#x27;pit&#x27;</span> <span class="attr">tickpolicy</span>=<span class="string">&#x27;delay&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">timer</span> <span class="attr">name</span>=<span class="string">&#x27;hpet&#x27;</span> <span class="attr">present</span>=<span class="string">&#x27;no&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">clock</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">on_poweroff</span>&gt;</span>destroy<span class="tag">&lt;/<span class="name">on_poweroff</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">on_reboot</span>&gt;</span>restart<span class="tag">&lt;/<span class="name">on_reboot</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">on_crash</span>&gt;</span>destroy<span class="tag">&lt;/<span class="name">on_crash</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">pm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">suspend-to-mem</span> <span class="attr">enabled</span>=<span class="string">&#x27;no&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">suspend-to-disk</span> <span class="attr">enabled</span>=<span class="string">&#x27;no&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">pm</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">devices</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">emulator</span>&gt;</span>/usr/libexec/qemu-kvm<span class="tag">&lt;/<span class="name">emulator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;file&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;disk&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;qcow2&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">&#x27;/home/root/images/csr1000v-universalk9.17.02.01v.qcow2&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;vda&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x07&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;ich9-ehci1&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x05&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x7&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;ich9-uhci1&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">master</span> <span class="attr">startport</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x05&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span> <span class="attr">multifunction</span>=<span class="string">&#x27;on&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;ich9-uhci2&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">master</span> <span class="attr">startport</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x05&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;ich9-uhci3&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">master</span> <span class="attr">startport</span>=<span class="string">&#x27;4&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x05&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pci-root&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;virtio-serial&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x06&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;direct&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;52:54:00:36:95:f0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">dev</span>=<span class="string">&#x27;eno1&#x27;</span> <span class="attr">mode</span>=<span class="string">&#x27;bridge&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x03&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;network&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;52:54:00:2d:87:99&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">network</span>=<span class="string">&#x27;eno2_sriov_pool&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x04&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">serial</span> <span class="attr">type</span>=<span class="string">&#x27;pty&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;isa-serial&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;isa-serial&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">serial</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">console</span> <span class="attr">type</span>=<span class="string">&#x27;pty&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;serial&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">console</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">channel</span> <span class="attr">type</span>=<span class="string">&#x27;unix&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;org.qemu.guest_agent.0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;virtio-serial&#x27;</span> <span class="attr">controller</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">channel</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">channel</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;com.redhat.spice.0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;virtio-serial&#x27;</span> <span class="attr">controller</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">channel</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;tablet&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;mouse&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;ps2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;keyboard&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;ps2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">graphics</span> <span class="attr">type</span>=<span class="string">&#x27;spice&#x27;</span> <span class="attr">autoport</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">listen</span> <span class="attr">type</span>=<span class="string">&#x27;address&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">image</span> <span class="attr">compression</span>=<span class="string">&#x27;off&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">graphics</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">video</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;qxl&#x27;</span> <span class="attr">ram</span>=<span class="string">&#x27;65536&#x27;</span> <span class="attr">vram</span>=<span class="string">&#x27;65536&#x27;</span> <span class="attr">vgamem</span>=<span class="string">&#x27;16384&#x27;</span> <span class="attr">heads</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">primary</span>=<span class="string">&#x27;yes&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;3&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">memballoon</span> <span class="attr">model</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rng</span> <span class="attr">model</span>=<span class="string">&#x27;virtio&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">backend</span> <span class="attr">model</span>=<span class="string">&#x27;random&#x27;</span>&gt;</span>/dev/urandom<span class="tag">&lt;/<span class="name">backend</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x09&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rng</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">devices</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>上述参数整理自<a target="_blank" rel="noopener" href="https://www.cisco.com/c/en/us/td/docs/routers/csr1000/software/configuration/b_CSR1000v_Configuration_Guide/b_CSR1000v_Configuration_Guide_chapter_0101.html">《Cisco CSR 1000v and Cisco ISRv Software Configuration Guide》</a></p>
<p>完成上述 XML 文件的编辑后，执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/libvirtd/qemu</span><br><span class="line"></span><br><span class="line">virsh define csr1kv-1.xml</span><br><span class="line"></span><br><span class="line">virsh start csr1kv-1</span><br></pre></td></tr></table></figure>
<h2 id="（6）在-KVM-主机上访问-CSR1000v-的-Console"><a href="#（6）在-KVM-主机上访问-CSR1000v-的-Console" class="headerlink" title="（6）在 KVM 主机上访问 CSR1000v 的 Console"></a>（6）在 KVM 主机上访问 CSR1000v 的 Console</h2><p>在 virt-manager 创建 CSR1000v 虚拟机的时候，缺省会添加一个 Serial Device。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 qemu]<span class="comment"># virsh console 20</span></span><br><span class="line"></span><br><span class="line">Connected to domain CSR1000v-1</span><br><span class="line"></span><br><span class="line">Escape character is ^]</span><br></pre></td></tr></table></figure>
<p>CSR 1000v 暂时不能通过 Console 配置，需要通过 virt-manager 的图形化界面进行初始化配置。</p>
<p>vCloud 的 Console 访问正常。</p>
<h2 id="（7）检验-CSR1000v-的调优配置"><a href="#（7）检验-CSR1000v-的调优配置" class="headerlink" title="（7）检验 CSR1000v 的调优配置"></a>（7）检验 CSR1000v 的调优配置</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# virsh list</span><br><span class="line"></span><br><span class="line">Id  Name              State</span><br><span class="line"></span><br><span class="line">----------------------------------------------------</span><br><span class="line"></span><br><span class="line"> 6   csr1kv-1            running</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# virsh vcpuinfo 6</span><br><span class="line"></span><br><span class="line">VCPU:      0</span><br><span class="line"></span><br><span class="line">CPU:      1</span><br><span class="line"></span><br><span class="line">State:     running</span><br><span class="line"></span><br><span class="line">CPU time:    34.5s</span><br><span class="line"></span><br><span class="line">CPU Affinity:  -y----------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VCPU:      1</span><br><span class="line"></span><br><span class="line">CPU:      2</span><br><span class="line"></span><br><span class="line">State:     running</span><br><span class="line"></span><br><span class="line">CPU time:    32.0s</span><br><span class="line"></span><br><span class="line">CPU Affinity:  --y---------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VCPU:      2</span><br><span class="line"></span><br><span class="line">CPU:      3</span><br><span class="line"></span><br><span class="line">State:     running</span><br><span class="line"></span><br><span class="line">CPU time:    23.8s</span><br><span class="line"></span><br><span class="line">CPU Affinity:  ---y--------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VCPU:      3</span><br><span class="line"></span><br><span class="line">CPU:      4</span><br><span class="line"></span><br><span class="line">State:     running</span><br><span class="line"></span><br><span class="line">CPU time:    19.8s</span><br><span class="line"></span><br><span class="line">CPU Affinity:  ----y-------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VCPU:      4</span><br><span class="line"></span><br><span class="line">CPU:      5</span><br><span class="line"></span><br><span class="line">State:     running</span><br><span class="line"></span><br><span class="line">CPU time:    23.0s</span><br><span class="line"></span><br><span class="line">CPU Affinity:  -----y------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VCPU:      5</span><br><span class="line"></span><br><span class="line">CPU:      6</span><br><span class="line"></span><br><span class="line">State:     running</span><br><span class="line"></span><br><span class="line">CPU time:    23.4s</span><br><span class="line"></span><br><span class="line">CPU Affinity:  ------y-----------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VCPU:      6</span><br><span class="line"></span><br><span class="line">CPU:      7</span><br><span class="line"></span><br><span class="line">State:     running</span><br><span class="line"></span><br><span class="line">CPU time:    28.5s</span><br><span class="line"></span><br><span class="line">CPU Affinity:  -------y----------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VCPU:      7</span><br><span class="line"></span><br><span class="line">CPU:      8</span><br><span class="line"></span><br><span class="line">State:     running</span><br><span class="line"></span><br><span class="line">CPU time:    28.2s</span><br><span class="line"></span><br><span class="line">CPU Affinity:  --------y---------------------------------------------------------------</span><br></pre></td></tr></table></figure>
<p>以上显示 CSR1000v 虚拟机的 CPU 亲和性在 1-8 核上。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># numastat -c qemu-kvm</span></span><br><span class="line"></span><br><span class="line">Per-node process memory usage (<span class="keyword">in</span> MBs) <span class="keyword">for</span> PID 46895 (qemu-kvm)</span><br><span class="line"></span><br><span class="line">     Node 0 Node 1 Total</span><br><span class="line"></span><br><span class="line">     ------ ------ -----</span><br><span class="line"></span><br><span class="line">Huge    8192   0 8192</span><br><span class="line"></span><br><span class="line">Heap    118   0  118</span><br><span class="line"></span><br><span class="line">Stack     0   0   0</span><br><span class="line"></span><br><span class="line">Private   144   7  151</span><br><span class="line"></span><br><span class="line">------- ------ ------ -----</span><br><span class="line"></span><br><span class="line">Total   8455   7 8461</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>以上显示，内存主要使用 Node 0。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># numastat -vm -p 13428 | grep HugePage</span></span><br><span class="line"></span><br><span class="line">AnonHugePages       956.00     494.00     1450.00</span><br><span class="line"></span><br><span class="line">HugePages_Total     16384.00    16384.00    32768.00</span><br><span class="line"></span><br><span class="line">HugePages_Free      8192.00    16384.00    24576.00</span><br><span class="line"></span><br><span class="line">HugePages_Surp       0.00       0.00      0.00</span><br></pre></td></tr></table></figure>
<h2 id="（8）在-CSR1KV-上检查虚拟网卡"><a href="#（8）在-CSR1KV-上检查虚拟网卡" class="headerlink" title="（8）在 CSR1KV 上检查虚拟网卡"></a>（8）在 CSR1KV 上检查虚拟网卡</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">csr1kv-1#show platform software vnic-if interface-mapping</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"> Interface Name    Driver Name     Mac Addr</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"> GigabitEthernet2    net_ixgbe_vf    5254.002d.8799</span><br><span class="line"></span><br><span class="line"> GigabitEthernet1    net_virtio     5254.0036.95f0</span><br></pre></td></tr></table></figure>
<p>上述驱动名显示为 net_ixgbe_vf 表明该虚拟网卡是一个 SR-IOV 池中分配的 VF 设备。</p>
<h1 id="Linux-上抓取虚拟网卡的报文（参考）"><a href="#Linux-上抓取虚拟网卡的报文（参考）" class="headerlink" title="Linux 上抓取虚拟网卡的报文（参考）"></a>Linux 上抓取虚拟网卡的报文（参考）</h1><p>查找虚拟机的网卡列表</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># virsh domiflist 10</span></span><br><span class="line"></span><br><span class="line">Interface Type    Source   Model    MAC</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------</span><br><span class="line"></span><br><span class="line">vnet0   network  default  virtio   52:54:00:38:71:4a</span><br><span class="line"></span><br><span class="line">macvtap0  direct   eno1    virtio   52:54:00:b2:70:90</span><br><span class="line"></span><br><span class="line">vnet5   bridge   net-br1  virtio   52:54:00:69:93:23</span><br></pre></td></tr></table></figure>
<p>抓取 vnet5 的报文</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># tcpdump -i vnet5 -w ping.pcap</span></span><br><span class="line"></span><br><span class="line">tcpdump: listening on vnet5, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line"></span><br><span class="line">^C49 packets captured</span><br><span class="line"></span><br><span class="line">51 packets received by filter</span><br><span class="line"></span><br><span class="line">0 packets dropped by kernel</span><br></pre></td></tr></table></figure>
<p>注：VF 如果被分配给虚拟机，那么在 Linux 主机里，通过 ip link 则查看不到该设备，无法通过上述办法抓包。</p>
<h1 id="CSR-1000v-的初始化配置及-Smart-License-注册"><a href="#CSR-1000v-的初始化配置及-Smart-License-注册" class="headerlink" title="CSR 1000v 的初始化配置及 Smart License 注册"></a>CSR 1000v 的初始化配置及 Smart License 注册</h1><h2 id="（1）CSR-1000v-初始化配置示例"><a href="#（1）CSR-1000v-初始化配置示例" class="headerlink" title="（1）CSR 1000v 初始化配置示例"></a>（1）CSR 1000v 初始化配置示例</h2><p>部分节略，其他为缺省配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">CSR1000v-1#show sdwan running-config</span><br><span class="line"></span><br><span class="line">system</span><br><span class="line"></span><br><span class="line"> system-ip       1.1.10.1</span><br><span class="line"></span><br><span class="line"> site-id        101</span><br><span class="line"></span><br><span class="line"> sp-organization-name CiscoBJ</span><br><span class="line"></span><br><span class="line"> organization-name   CiscoBJ</span><br><span class="line"></span><br><span class="line"> vbond 10.75.58.51 port 12346</span><br><span class="line"></span><br><span class="line">!</span><br><span class="line"></span><br><span class="line">hostname CSR1000v-1</span><br><span class="line"></span><br><span class="line">username admin privilege 15 secret 9 $9$4&#x2F;QL2V2K4&#x2F;6H1k$XUmRNf.T7t3KDOj&#x2F;FmoNexpEypCxr482dExXHDnohSI</span><br><span class="line"></span><br><span class="line">ip name-server 64.104.123.245</span><br><span class="line"></span><br><span class="line">ip route 0.0.0.0 0.0.0.0 10.75.59.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">interface GigabitEthernet1</span><br><span class="line"></span><br><span class="line"> no shutdown</span><br><span class="line"></span><br><span class="line"> arp timeout 1200</span><br><span class="line"></span><br><span class="line"> ip address 10.75.59.35 255.255.255.0</span><br><span class="line"></span><br><span class="line"> no ip redirects</span><br><span class="line"></span><br><span class="line"> ip mtu  1500</span><br><span class="line"></span><br><span class="line"> mtu 1500</span><br><span class="line"></span><br><span class="line"> negotiation auto</span><br><span class="line"></span><br><span class="line">exit</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">interface Tunnel1</span><br><span class="line"></span><br><span class="line"> no shutdown</span><br><span class="line"></span><br><span class="line"> ip unnumbered GigabitEthernet1</span><br><span class="line"></span><br><span class="line"> no ip redirects</span><br><span class="line"></span><br><span class="line"> ipv6 unnumbered GigabitEthernet1</span><br><span class="line"></span><br><span class="line"> no ipv6 redirects</span><br><span class="line"></span><br><span class="line"> tunnel source GigabitEthernet1</span><br><span class="line"></span><br><span class="line"> tunnel mode sdwan</span><br><span class="line"></span><br><span class="line">exit</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">clock timezone CST 8 0</span><br><span class="line"></span><br><span class="line">ntp server 10.75.58.1 version 4</span><br><span class="line"></span><br><span class="line">sdwan</span><br><span class="line"></span><br><span class="line"> interface GigabitEthernet1</span><br><span class="line"></span><br><span class="line"> tunnel-interface</span><br><span class="line"></span><br><span class="line">  encapsulation ipsec</span><br><span class="line"></span><br><span class="line">  allow-service sshd</span><br><span class="line"></span><br><span class="line"> exit</span><br></pre></td></tr></table></figure>
<h2 id="（2）常用命令"><a href="#（2）常用命令" class="headerlink" title="（2）常用命令"></a>（2）常用命令</h2><ul>
<li>show sdwan control local-properties</li>
<li>show sdwan control connections</li>
<li>show sdwan control connection-history</li>
<li>show sdwan running-config</li>
<li>show sdwan bfd sessions</li>
<li>show sdwan omp peers</li>
<li>show sdwan omp routes</li>
</ul>
<h2 id="（3）CSR-1000v-Smart-License-注册"><a href="#（3）CSR-1000v-Smart-License-注册" class="headerlink" title="（3）CSR 1000v Smart License 注册"></a>（3）CSR 1000v Smart License 注册</h2><p>CSR 1000v 默认限速为 250Mbps，需要注册 Smart License 才可解开限速。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CSR1000v-2#show platform hardware throughput level</span><br><span class="line"></span><br><span class="line">The current throughput level is 250000 kb&#x2F;s</span><br></pre></td></tr></table></figure>
<p>注册 Smart License 需要满足以下条件：</p>
<p>1、 CSR 1000v 已经注册到 vManage，控制面连接正常；</p>
<p>2、 配置 ip http client source-interface GigabitEthernet2</p>
<p>3、 sdwan interface GigabitEthernet2 tunnel-interface allow-service all —针对 16.12.x 版本；在新版本中仅需要 allow https</p>
<p>4、 CSR 1000v 可以访问 URL：<a target="_blank" rel="noopener" href="https://tools.cisco.com/its/service/oddce/services/DDCEService">https://tools.cisco.com/its/service/oddce/services/DDCEService</a></p>
<p>允许访问 114.114.114.114，CSR 1000v 可解析域名 tools.cisco.com</p>
<p>替代办法，增加一条命令 ip host tools.cisco.com 72.163.4.38</p>
<p>执行 license smart register idtoken xxxxxx 进行注册</p>
<p>show license status 查看注册结果</p>
<p>注册完成后，系统解开限速：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CSR1000v-1#show platform hardware throughput level</span><br><span class="line"></span><br><span class="line">The current throughput level is 200000000 kb&#x2F;s</span><br></pre></td></tr></table></figure>
<h1 id="性能和相关限制"><a href="#性能和相关限制" class="headerlink" title="性能和相关限制"></a>性能和相关限制</h1><h2 id="（1）SRIOV-的性能"><a href="#（1）SRIOV-的性能" class="headerlink" title="（1）SRIOV 的性能"></a>（1）SRIOV 的性能</h2><p>在上述 CSR1KV-1 安装好后，使用测试仪进行性能测试，测试条件中，设置丢包率为 0%，其性能如下：</p>
<table>
<thead>
<tr>
<th align="left">Packet Site</th>
<th align="center">SDWAN Performance (Mbps)</th>
<th align="center">CEF Performance (Mbps)</th>
</tr>
</thead>
<tbody><tr>
<td align="left">128Byte</td>
<td align="center">800</td>
<td align="center">2843.75</td>
</tr>
<tr>
<td align="left">256Byte</td>
<td align="center">1431.26</td>
<td align="center">6500.00</td>
</tr>
<tr>
<td align="left">512Byte</td>
<td align="center">2581.26</td>
<td align="center">10578.13</td>
</tr>
<tr>
<td align="left">1024Byte</td>
<td align="center">3731.26</td>
<td align="center">15500.00</td>
</tr>
<tr>
<td align="left">1400Byte</td>
<td align="center">4306.26</td>
<td align="center">18171.88</td>
</tr>
</tbody></table>
<img src="/csr1kv-kvm-CentOS7/line-chart-009.png" class="" title="性能现状图表">

<p>注：上述测试结果非官方结果，不同服务器和网卡可能测试结果有区别，上述性能数据仅供参考。</p>
<h2 id="（2）SRIOV-的限制"><a href="#（2）SRIOV-的限制" class="headerlink" title="（2）SRIOV 的限制"></a>（2）SRIOV 的限制</h2><p>SRIOV 的主要限制是每一个 VF 设备支持的 VLAN 数，ixgbevf 所支持的最大 VLAN 数为 64；因此，在 CSR1KV 中对应的虚拟接口配置的活跃子接口数最大为 64。</p>
<p>配置指南中有关于 SRIOV 子接口限制的说明：</p>
<p><code> </code><a target="_blank" rel="noopener" href="https://www.cisco.com/c/en/us/td/docs/routers/csr1000/software/configuration/b_CSR1000v_Configuration_Guide/b_CSR1000v_Configuration_Guide_chapter_0101.html">Cisco CSR 1000v and Cisco ISRv Software Configuration Guide</a>:</p>
<blockquote>
<p>SR-IOV (ixgbevf)</p>
<p>Maximum VLANs: The maximum number of VLANs supported on PF is 64. Together, all VFs can have a total of 64 VLANs. (Intel limitation.)</p>
<p>SR-IOV (i40evf)</p>
<p>Maximum VLANs: The maximum number of VLANs supported on PF is 512. Together, all VFs can have a total of 512 VLANs. (Intel limitation.) Per-VF resources are managed by the PF (host) device driver.</p>
</blockquote>
<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><h2 id="（1）Virt-manager-设置虚机的-CPU-模式说明"><a href="#（1）Virt-manager-设置虚机的-CPU-模式说明" class="headerlink" title="（1）Virt-manager 设置虚机的 CPU 模式说明"></a>（1）Virt-manager 设置虚机的 CPU 模式说明</h2><p>Libvirt 主要支持三种 CPU mode：</p>
<ul>
<li>host-passthrough: libvirt 令 KVM 把宿主机的 CPU 指令集全部透传给虚拟机。因此虚拟机能够最大限度的使用宿主机 CPU 指令集，故性能是最好的。但是在热迁移时，它要求目的节点的 CPU 和源节点的一致。</li>
<li>host-model: libvirt 根据当前宿主机 CPU 指令集从配置文件 /usr/share/libvirt/cpu_map.xml 选择一种最相配的 CPU 型号。在这种 mode 下，虚拟机的指令集往往比宿主机少，性能相对 host-passthrough 要差一点，但是热迁移时，它允许目的节点 CPU 和源节点的存在一定的差异。</li>
<li>custom: 这种模式下虚拟机 CPU 指令集数最少，故性能相对最差，但是它在热迁移时跨不同型号 CPU 的能力最强。此外，custom 模式下支持用户添加额外的指令集。</li>
</ul>
<p>三种 mode 的性能排序是：host-passthrough &gt; host-model &gt; custom</p>
<p>实际性能差异不大：100%&gt; 95.84%&gt;94.73%</p>
<p>引自：<a target="_blank" rel="noopener" href="http://wsfdl.com/openstack/2018/01/02/libvirt_cpu_mode.html">http://wsfdl.com/openstack/2018/01/02/libvirt_cpu_mode.html</a></p>
<h2 id="（2）有关网卡模式的说明"><a href="#（2）有关网卡模式的说明" class="headerlink" title="（2）有关网卡模式的说明"></a>（2）有关网卡模式的说明</h2><p>使用 virt-manager 创建虚拟机，在添加网卡时，有 3 中选择，分别是 e1000, rtl8139, virtio。</p>
<p>“rtl8139”这个网卡模式是 qemu-kvm 默认的模拟网卡类型，RTL8139 是 Realtek 半导体公司的一个 10/100M 网卡系列，是曾经非常流行（当然现在看来有点古老）且兼容性好的网卡，几乎所有的现代操作系统都对 RTL8139 网卡驱动的提供支持。</p>
<p>“e1000”系列提供 Intel e1000 系列的网卡模拟，纯的 QEMU（非 qemu-kvm）默认就是提供 Intel e1000 系列的虚拟网卡。</p>
<p>“virtio” 类型是 qemu-kvm 对半虚拟化 IO（virtio）驱动的支持。</p>
<p>这三个网卡的最大区别(此处指最需要关注的地方)是速度：</p>
<ul>
<li><p>rtl8139 10/100Mb/s</p>
</li>
<li><p>e1000 1Gb/s</p>
</li>
<li><p>virtio 10Gb/s</p>
</li>
</ul>
<p>注意 virtio 是唯一可以达到 10Gb/s 的。</p>
<p>virtio 是一种 I/O 半虚拟化解决方案，是一套通用 I/O 设备虚拟化的程序，是对半虚拟化 Hypervisor 中的一组通用 I/O 设备的抽象。提供了一套上层应用与各 Hypervisor 虚拟化设备（KVM，Xen，VMware 等）之间的通信框架和编程接口，减少跨平台所带来的兼容性问题，大大提高驱动程序开发效率。</p>
<h2 id="（3）有关-MACVTAP"><a href="#（3）有关-MACVTAP" class="headerlink" title="（3）有关 MACVTAP"></a>（3）有关 MACVTAP</h2><p>以下内容来自：<a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/cn/linux/1312_xiawc_linuxvirtnet/index.html">https://www.ibm.com/developerworks/cn/linux/1312_xiawc_linuxvirtnet/index.html</a></p>
<p>MACVTAP 的实现基于传统的 MACVLAN。和 TAP 设备一样，每一个 MACVTAP 设备拥有一个对应的 Linux 字符设备，并拥有和 TAP 设备一样的 IOCTL 接口，因此能直接被 KVM/Qemu 使用，方便地完成网络数据交换工作。引入 MACVTAP 设备的目标是：简化虚拟化环境中的交换网络，代替传统的 Linux TAP 设备加 Bridge 设备组合，同时支持新的虚拟化网络技术，如 802.1 Qbg。</p>
<p>MACVTAP 设备和 VLAN 设备类似，是以一对多的母子关系出现的。在一个母设备上可以创建多个 MACVTAP 子设备，一个 MACVTAP 设备只有一个母设备，MACVTAP 子设备可以做为母设备，再一次嵌套的创建 MACVTAP 子设备。母子设备之间被隐含的桥接起来，母设备相当于现实世界中的交换机 TRUNK 口。实际上当 MACVTAP 设备被创建并且模式不为 Passthrough 时，内核隐含的创建了 MACVLAN 网络，完成转发功能。MACVTAP 设备有四种工作模式：Bridge、VEPA、Private，Passthrough。</p>
<p>Bridge 模式下，它完成与 Bridge 设备类似功能，数据可以在属于同一个母设备的子设备间交换转发，虚拟机相当于简单接入了一个交换机。当前的 Linux 实现有一个缺陷，此模式下 MACVTAP 子设备无法和 Linux Host 通讯，即虚拟机无法和 Host 通讯。—-经验证，属实。</p>
<p>Passthrough 模式下，内核的 MACVLAN 数据处理逻辑被跳过，硬件决定数据如何处理，从而释放了 Host CPU 资源。</p>
<img src="/csr1kv-kvm-CentOS7/macvtap-ibm.png" class="" title="MACVTAP 直通 vs PCI 直通">

<p>MACVTAP Passthrough 概念与 PCI Passthrough 概念不同，上图详细解释了两种情况的区别。</p>
<p>PCI Passthrough 针对的是任意 PCI 设备，不一定是网络设备，目的是让 Guest OS 直接使用 Host 上的 PCI 硬件以提高效率。以 X86 平台为例，数据将通过需要硬件支持的 VT-D 技术从 Guest OS 直接传递到 Host 硬件上。这样做固然效率很高，但因为模拟器失去了对虚拟硬件的控制，难以同步不同 Host 上的硬件状态，因此当前在使用 PCI Passthrough 的情况下难以做动态迁移。</p>
<p>MACVTAP Passthrough 仅仅针对 MACVTAP 网络设备，目的是绕过内核里 MACVTAP 的部分软件处理过程，转而交给硬件处理。在虚拟化条件下，数据还是会先到达模拟器 I/O 层，再转发到硬件上。这样做效率有损失，但模拟器仍然控制虚拟硬件的状态及数据的走向，可以做动态迁移。</p>
<h2 id="（4）SR-IOV-介绍"><a href="#（4）SR-IOV-介绍" class="headerlink" title="（4）SR-IOV 介绍"></a>（4）SR-IOV 介绍</h2><p>如果网卡支持 SRIOV，请使用 SRIOV PCI Passthrough。</p>
<img src="/csr1kv-kvm-CentOS7/nic-type-010.png" class="" title="nic-type-010">

<p>软件模拟是通过 Hypervisor 层模拟虚拟网卡，实现与物理设备完全一样的接口，虚拟机操作系统无须修改就能直接驱动虚拟网卡，其最大的缺点是性能相对较差；</p>
<p>网卡直通支持虚拟机绕过 Hypervisor 层，直接访问物理 I/O 设备，具有最高的性能，但是在同一时刻物理 I/O 设备只能被一个虚拟机独享；</p>
<p>SR-IOV 是 Intel 在 2007 年提出的解决虚拟化网络 I/O 的硬件技术方案，该技术不仅能够继承网卡直通的高性能优势，而且同时支持物理 I/O 设备的跨虚拟机共享，具有较好的应用前景。</p>
<p>原文链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/lsz137105/article/details/100752930">https://blog.csdn.net/lsz137105/article/details/100752930</a></p>
<p>SR-IOV（Single Root I/O Virtualization）是一个将 PCIe 设备（如网卡）共享给虚拟机的标准，通过为虚拟机提供独立的内存空间、中断、DMA 流，来绕过 VMM 实现数据访问。</p>
<p>SR-IOV 引入了两种 PCIe functions：</p>
<ul>
<li>PF（Physical Function）：包含完整的 PCIe 功能，包括 SR-IOV 的扩张能力，该功能用于 SR-IOV 的配置和管理。</li>
<li>VF（Virtual Function）：包含轻量级的 PCIe 功能。每一个 VF 有它自己独享的 PCI 配置区域，并且可能与其他 VF 共享着同一个物理资源。</li>
</ul>
<p>SR-IOV 网卡通过将 SR-IOV 功能集成到物理网卡上，将单一的物理网卡虚拟成多个 VF 接口，每个 VF 接口都有单独的虚拟 PCIe 通道，这些虚拟的 PCIe 通道共用物理网卡的 PCIe 通道。每个虚拟机可占用一个或多个 VF 接口，这样虚拟机就可以直接访问自己的 VF 接口，而不需要 Hypervisor 的协调干预，从而大幅提升网络吞吐性能。</p>
<h2 id="（5）探索虚拟机进程"><a href="#（5）探索虚拟机进程" class="headerlink" title="（5）探索虚拟机进程"></a>（5）探索虚拟机进程</h2><p>每一个客户机就是宿主机中的一个 QEMU 进程，而一个客户机的多个 vCPU 就是一个 QEMU 进程中的多个线程。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># ps -ef | grep qemu</span></span><br><span class="line"></span><br><span class="line">qemu      52595      1 99 10:37 ?        01:24:12 /usr/libexec/qemu-kvm -name csr1kv-1 -S -machine pc-i440fx-rhel7.0.0,accel=kvm,usb=off,dump-guest-core=off,mem-merge=off -cpu host -m 8192 -mem-prealloc -mem-path /dev/hugepages/libvirt/qemu/7-csr1kv-1 -realtime mlock=on -smp 8,sockets=8,cores=1,threads=1 -uuid 59581018-6387-49df-ab09-2bcf40fc12ba -no-user-config -nodefaults -chardev socket,id=charmonitor,path=/var/lib/libvirt/qemu/domain-7-csr1kv-1/monitor.sock,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=utc,driftfix=slew -global kvm-pit.lost_tick_policy=delay -no-hpet -no-shutdown -global PIIX4_PM.disable_s3=1 -global PIIX4_PM.disable_s4=1 -boot strict=on -device piix3-usb-uhci,id=usb,bus=pci.0,addr=0x1.0x2 -device virtio-serial-pci,id=virtio-serial0,bus=pci.0,addr=0x6 -drive file=/home/root/images/csr1000v-universalk9.17.02.01v.qcow2,format=qcow2,<span class="keyword">if</span>=none,id=drive-virtio-disk0 -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x7,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 -netdev tap,fd=26,id=hostnet0,vhost=on,vhostfd=28 -device virtio-net-pci,netdev=hostnet0,id=net0,mac=52:54:00:36:95:f0,bus=pci.0,addr=0x3 -chardev pty,id=charserial0 -device isa-serial,chardev=charserial0,id=serial0 -chardev socket,id=charchannel0,path=/var/lib/libvirt/qemu/channel/target/domain-7-csr1kv-1/org.qemu.guest_agent.0,server,nowait -device virtserialport,bus=virtio-serial0.0,nr=1,chardev=charchannel0,id=channel0,name=org.qemu.guest_agent.0 -chardev spicevmc,id=charchannel1,name=vdagent -device virtserialport,bus=virtio-serial0.0,nr=2,chardev=charchannel1,id=channel1,name=com.redhat.spice.0 -spice port=5900,addr=127.0.0.1,disable-ticketing,image-compression=off,seamless-migration=on -vga qxl -global qxl-vga.ram_size=67108864 -global qxl-vga.vram_size=67108864 -global qxl-vga.vgamem_mb=16 -global qxl-vga.max_outputs=1 -device vfio-pci,host=1d:00.0,id=hostdev1,bus=pci.0,addr=0x8 -device vfio-pci,host=3b:10.1,id=hostdev0,bus=pci.0,addr=0x4 -msg timestamp=on</span><br></pre></td></tr></table></figure>
<p>使用 virsh 命令或 virt-manager 开启虚拟机，是通过调用/usr/libexec/qemu-kvm 并附带虚拟配置的参数，来开启 qemu-kvm 的进程。可以看到上述的参数是非常复杂的，libvirt 提供 XML 参数进行简化。</p>
<p>ps -efL | grep qemu 可以列出所有的线程，但是输出篇幅很长，不在此列出；使用 pstree 可列出其父进程、线程关系，如下：</p>
<img src="/csr1kv-kvm-CentOS7/pstree-011.png" class="" title="Pstree">

<p>virt-top 可查看虚机运行状态和资源利用率：</p>
<p>[root@centos7 ~]# virt-top -1</p>
<img src="/csr1kv-kvm-CentOS7/virt-top-012.png" class="" title="Virt-top">

<h1 id="参考资料连接"><a href="#参考资料连接" class="headerlink" title="参考资料连接"></a>参考资料连接</h1><ul>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1703094">https://cloud.tencent.com/developer/article/1703094</a></li>
<li><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/performance_tuning_guide/index">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/performance_tuning_guide/index</a></li>
<li><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html-single/virtualization_tuning_and_optimization_guide/index">https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html-single/virtualization_tuning_and_optimization_guide/index</a></li>
<li><a target="_blank" rel="noopener" href="https://computingforgeeks.com/how-to-create-and-configure-bridge-networking-for-kvm-in-linux/">https://computingforgeeks.com/how-to-create-and-configure-bridge-networking-for-kvm-in-linux/</a></li>
<li><a target="_blank" rel="noopener" href="https://software.intel.com/content/www/us/en/develop/articles/configure-sr-iov-network-virtual-functions-in-linux-kvm.html">https://software.intel.com/content/www/us/en/develop/articles/configure-sr-iov-network-virtual-functions-in-linux-kvm.html</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/CSR1000v/" rel="tag"># CSR1000v</a>
              <a href="/tags/KVM/" rel="tag"># KVM</a>
              <a href="/tags/SRIOV/" rel="tag"># SRIOV</a>
              <a href="/tags/NetworkManager/" rel="tag"># NetworkManager</a>
              <a href="/tags/Cisco/" rel="tag"># Cisco</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
            </div>
            <div class="post-nav-item">
                <a href="/csr1kv-kvm-Ubuntu20-04-md.html" rel="next" title="Cisco CSR1000v KVM SRIOV Setting Guide on Ubuntu 20.04 With NetworkManager">
                  Cisco CSR1000v KVM SRIOV Setting Guide on Ubuntu 20.04 With NetworkManager <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Rao Weibo</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
