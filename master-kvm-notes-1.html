<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"weiborao.link","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.7.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="Mastering KVM Virtualization 学习笔记，自用，本篇主要记录第三章到第五章。">
<meta property="og:type" content="article">
<meta property="og:title" content="Mastering KVM Virtualization 学习笔记(1)">
<meta property="og:url" content="https://weiborao.link/master-kvm-notes-1.html">
<meta property="og:site_name" content="Rao Weibo的博客">
<meta property="og:description" content="Mastering KVM Virtualization 学习笔记，自用，本篇主要记录第三章到第五章。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-02-22T06:23:47.000Z">
<meta property="article:modified_time" content="2021-02-22T06:30:40.658Z">
<meta property="article:author" content="Rao Weibo">
<meta property="article:tag" content="kvm">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://weiborao.link/master-kvm-notes-1.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://weiborao.link/master-kvm-notes-1.html","path":"master-kvm-notes-1.html","title":"Mastering KVM Virtualization 学习笔记(1)"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Mastering KVM Virtualization 学习笔记(1) | Rao Weibo的博客</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Rao Weibo的博客" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Rao Weibo的博客</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter-3-KVM%E3%80%81virsh%E3%80%81oVirt%E7%AD%89"><span class="nav-number">1.</span> <span class="nav-text">Chapter 3 KVM、virsh、oVirt等</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CentOS-8-%E7%9A%84KVM%E5%AE%89%E8%A3%85"><span class="nav-number">1.1.</span> <span class="nav-text">CentOS 8 的KVM安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E5%AE%8C%E5%90%8E%EF%BC%8C%E4%BD%BF%E7%94%A8virt-host-validate%E9%AA%8C%E8%AF%81"><span class="nav-number">1.2.</span> <span class="nav-text">安装完后，使用virt-host-validate验证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8virt-install-%E5%AE%89%E8%A3%85%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="nav-number">1.3.</span> <span class="nav-text">使用virt-install 安装虚拟机</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#oVirt"><span class="nav-number">1.4.</span> <span class="nav-text">oVirt</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A2%E7%B4%A2%E8%99%9A%E6%8B%9F%E6%9C%BAQemu-kvm%E8%BF%9B%E7%A8%8B"><span class="nav-number">1.5.</span> <span class="nav-text">探索虚拟机Qemu-kvm进程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter-4-KVM-%E7%BD%91%E7%BB%9C"><span class="nav-number">2.</span> <span class="nav-text">Chapter 4 KVM 网络</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter-5-KVM-%E5%AD%98%E5%82%A8"><span class="nav-number">3.</span> <span class="nav-text">Chapter 5 KVM 存储</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E8%B5%84%E6%BA%90%E6%B1%A0"><span class="nav-number">3.1.</span> <span class="nav-text">存储资源池</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%AC%E5%9C%B0%E5%AD%98%E5%82%A8%E6%B1%A0"><span class="nav-number">3.2.</span> <span class="nav-text">本地存储池</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Libvirt-Storage-Pool"><span class="nav-number">3.3.</span> <span class="nav-text">Libvirt Storage Pool</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NFS-Storage-Pool"><span class="nav-number">3.4.</span> <span class="nav-text">NFS Storage Pool</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#iSCIS-%E5%92%8C-SAN-%E5%AD%98%E5%82%A8"><span class="nav-number">3.5.</span> <span class="nav-text">iSCIS 和 SAN 存储</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#LUN%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="nav-number">3.5.1.</span> <span class="nav-text">LUN的概念</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Storage-redundancy-and-multipathing"><span class="nav-number">3.6.</span> <span class="nav-text">Storage redundancy and multipathing</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Gluster"><span class="nav-number">3.7.</span> <span class="nav-text">Gluster</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ceph"><span class="nav-number">3.8.</span> <span class="nav-text">Ceph</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%99%9A%E6%8B%9F%E7%A3%81%E7%9B%98%E9%95%9C%E5%83%8F%E5%92%8CKVM%E5%AD%98%E5%82%A8%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="nav-number">3.9.</span> <span class="nav-text">虚拟磁盘镜像和KVM存储基本操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#qemu-img-%E5%91%BD%E4%BB%A4"><span class="nav-number">3.9.1.</span> <span class="nav-text">qemu-img 命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8virsh%E5%91%BD%E4%BB%A4%E5%8A%A0%E8%BD%BD%E7%A1%AC%E7%9B%98"><span class="nav-number">3.9.2.</span> <span class="nav-text">使用virsh命令加载硬盘</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%89%E5%85%B3NVMe%E5%92%8CNVMe-over-Fabric"><span class="nav-number">3.9.3.</span> <span class="nav-text">有关NVMe和NVMe over Fabric</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Rao Weibo</p>
  <div class="site-description" itemprop="description">记录一些工作、学习相关的笔记</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">10</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/weiborao" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;weiborao" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:raoweibo@gmail.com" title="E-Mail → mailto:raoweibo@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://weiborao.link/master-kvm-notes-1.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rao Weibo">
      <meta itemprop="description" content="记录一些工作、学习相关的笔记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rao Weibo的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Mastering KVM Virtualization 学习笔记(1)
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-02-22 14:23:47 / 修改时间：14:30:40" itemprop="dateCreated datePublished" datetime="2021-02-22T14:23:47+08:00">2021-02-22</time>
    </span>

  
</div>

            <div class="post-description">Mastering KVM Virtualization 学习笔记，自用，本篇主要记录第三章到第五章。</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>第一章和第二章之前快速阅读过了，没有笔记，等回头再回来整理。</p>
<h2 id="Chapter-3-KVM、virsh、oVirt等"><a href="#Chapter-3-KVM、virsh、oVirt等" class="headerlink" title="Chapter 3 KVM、virsh、oVirt等"></a>Chapter 3 KVM、virsh、oVirt等</h2><h3 id="CentOS-8-的KVM安装"><a href="#CentOS-8-的KVM安装" class="headerlink" title="CentOS 8 的KVM安装"></a>CentOS 8 的KVM安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum module install virt</span><br><span class="line">dnf install qemu-img qemu-kvm libvirt libvirt-client virt-manager \</span><br><span class="line">virt-install virt-viewer -y</span><br></pre></td></tr></table></figure>
<h3 id="安装完后，使用virt-host-validate验证"><a href="#安装完后，使用virt-host-validate验证" class="headerlink" title="安装完后，使用virt-host-validate验证"></a>安装完后，使用virt-host-validate验证</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># virt-host-validate</span></span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> hardware virtualization                                 : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">if</span> device /dev/kvm exists                                   : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">if</span> device /dev/kvm is accessible                            : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">if</span> device /dev/vhost-net exists                             : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">if</span> device /dev/net/tun exists                               : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;memory&#x27;</span> controller support                      : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;memory&#x27;</span> controller mount-point                  : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpu&#x27;</span> controller support                         : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpu&#x27;</span> controller mount-point                     : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpuacct&#x27;</span> controller support                     : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpuacct&#x27;</span> controller mount-point                 : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpuset&#x27;</span> controller support                      : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpuset&#x27;</span> controller mount-point                  : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;devices&#x27;</span> controller support                     : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;devices&#x27;</span> controller mount-point                 : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;blkio&#x27;</span> controller support                       : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;blkio&#x27;</span> controller mount-point                   : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> device assignment IOMMU support                         : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">if</span> IOMMU is enabled by kernel                               : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> Linux &gt;= 2.6.26                                         : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> namespace ipc                                           : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> namespace mnt                                           : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> namespace pid                                           : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> namespace uts                                           : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> namespace net                                           : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> namespace user                                          : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;memory&#x27;</span> controller support                      : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;memory&#x27;</span> controller mount-point                  : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpu&#x27;</span> controller support                         : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpu&#x27;</span> controller mount-point                     : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpuacct&#x27;</span> controller support                     : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpuacct&#x27;</span> controller mount-point                 : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpuset&#x27;</span> controller support                      : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpuset&#x27;</span> controller mount-point                  : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;devices&#x27;</span> controller support                     : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;devices&#x27;</span> controller mount-point                 : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;blkio&#x27;</span> controller support                       : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;blkio&#x27;</span> controller mount-point                   : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">if</span> device /sys/fs/fuse/connections exists                   : PASS</span><br></pre></td></tr></table></figure>
<h3 id="使用virt-install-安装虚拟机"><a href="#使用virt-install-安装虚拟机" class="headerlink" title="使用virt-install 安装虚拟机"></a>使用virt-install 安装虚拟机</h3><p>编辑anaconda-ks.cfg文件，使用以下参数可以实现虚机部署的静默安装。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">virt-install --virt-type=kvm --name=MasteringKVM02 --ram=4096</span><br><span class="line">--vcpus=4 --os-variant=rhel8.0 --location=/var/lib/libvirt/</span><br><span class="line">images/ CentOS-8-x86_64-1905-dvd1.iso --network=default</span><br><span class="line">--graphics vnc --disk size=16 -x <span class="string">&quot;ks=http://10.10.48.1/ks.cfg&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="oVirt"><a href="#oVirt" class="headerlink" title="oVirt"></a>oVirt</h3><p>oVirt（Open Virtualization Manager）是一款免费开源虚拟化软件，是RedHat商业版本虚拟化软件RHEV的开源版本。</p>
<p>oVirt基于kvm，并整合使用了libvirt、gluster、patternfly、ansible等一系列优秀的开源软件。</p>
<h3 id="探索虚拟机Qemu-kvm进程"><a href="#探索虚拟机Qemu-kvm进程" class="headerlink" title="探索虚拟机Qemu-kvm进程"></a>探索虚拟机Qemu-kvm进程</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-kvm:/home/ubuntu<span class="comment"># ps aux | grep qemu</span></span><br><span class="line">libvirt+    8526  255  0.1 13876708 653744 ?     SLl  Feb01 61850:36 /usr/bin/qemu-system-x86_64 -name guest=csr1kv-1,debug-threads=on -S -object secret,id=masterKey0,format=raw,file=/var/lib/libvirt/qemu/domain-4-csr1kv-1/master-key.aes -machine pc-q35-4.2,accel=kvm,usb=off,vmport=off,dump-guest-core=off,mem-merge=off -cpu host -m 8192 -mem-prealloc -mem-path /dev/hugepages/libvirt/qemu/4-csr1kv-1 -overcommit mem-lock=on -smp 8,sockets=8,cores=1,threads=1 -uuid 83f90c1c-f0ea-4298-bcdf-3d676de2aeb4 -no-user-config -nodefaults -chardev socket,id=charmonitor,fd=31,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=utc,driftfix=slew -global kvm-pit.lost_tick_policy=delay -no-hpet -no-shutdown -global ICH9-LPC.disable_s3=1 -global ICH9-LPC.disable_s4=1 -boot strict=on -device pcie-root-port,port=0x10,chassis=1,id=pci.1,bus=pcie.0,multifunction=on,addr=0x2 -device pcie-root-port,port=0x11,chassis=2,id=pci.2,bus=pcie.0,addr=0x2.0x1 -device pcie-root-port,port=0x12,chassis=3,id=pci.3,bus=pcie.0,addr=0x2.0x2 -device pcie-root-port,port=0x13,chassis=4,id=pci.4,bus=pcie.0,addr=0x2.0x3 -device pcie-root-port,port=0x14,chassis=5,id=pci.5,bus=pcie.0,addr=0x2.0x4 -device pcie-root-port,port=0x15,chassis=6,id=pci.6,bus=pcie.0,addr=0x2.0x5 -device pcie-root-port,port=0x16,chassis=7,id=pci.7,bus=pcie.0,addr=0x2.0x6 -device pcie-root-port,port=0x17,chassis=8,id=pci.8,bus=pcie.0,addr=0x2.0x7 -device qemu-xhci,p2=15,p3=15,id=usb,bus=pci.3,addr=0x0 -device virtio-serial-pci,id=virtio-serial0,bus=pci.4,addr=0x0 -blockdev &#123;<span class="string">&quot;driver&quot;</span>:<span class="string">&quot;file&quot;</span>,<span class="string">&quot;filename&quot;</span>:<span class="string">&quot;/var/lib/libvirt/images/csr1000v-universalk9.17.02.01v.qcow2&quot;</span>,<span class="string">&quot;node-name&quot;</span>:<span class="string">&quot;libvirt-1-storage&quot;</span>,<span class="string">&quot;auto-read-only&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;discard&quot;</span>:<span class="string">&quot;unmap&quot;</span>&#125; -blockdev &#123;<span class="string">&quot;node-name&quot;</span>:<span class="string">&quot;libvirt-1-format&quot;</span>,<span class="string">&quot;read-only&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;driver&quot;</span>:<span class="string">&quot;qcow2&quot;</span>,<span class="string">&quot;file&quot;</span>:<span class="string">&quot;libvirt-1-storage&quot;</span>,<span class="string">&quot;backing&quot;</span>:null&#125; -device virtio-blk-pci,scsi=off,bus=pci.5,addr=0x0,drive=libvirt-1-format,id=virtio-disk0,bootindex=1 -netdev tap,fd=33,id=hostnet0,vhost=on,vhostfd=34 -device virtio-net-pci,netdev=hostnet0,id=net0,mac=52:54:00:69:ec:73,bus=pci.1,addr=0x0 -chardev pty,id=charserial0 -device isa-serial,chardev=charserial0,id=serial0 -chardev socket,id=charchannel0,fd=35,server,nowait -device virtserialport,bus=virtio-serial0.0,nr=1,chardev=charchannel0,id=channel0,name=org.qemu.guest_agent.0 -chardev spicevmc,id=charchannel1,name=vdagent -device virtserialport,bus=virtio-serial0.0,nr=2,chardev=charchannel1,id=channel1,name=com.redhat.spice.0 -spice port=5900,addr=127.0.0.1,disable-ticketing,image-compression=off,seamless-migration=on -device qxl-vga,id=video0,ram_size=67108864,vram_size=67108864,vram64_size_mb=0,vgamem_mb=16,max_outputs=1,bus=pcie.0,addr=0x1 -device vfio-pci,host=0000:5e:02.0,id=hostdev0,bus=pci.2,addr=0x0 -device vfio-pci,host=0000:5e:0a.0,id=hostdev1,bus=pci.8,addr=0x0 -sandbox on,obsolete=deny,elevateprivileges=deny,spawn=deny,resourcecontrol=deny -msg timestamp=on</span><br></pre></td></tr></table></figure>
<p>使用pstree检查线程信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-kvm:/home/ubuntu<span class="comment"># pstree -p 8526</span></span><br><span class="line">qemu-system-x86(8526)─┬─&#123;qemu-system-x86&#125;(8530)</span><br><span class="line">                      ├─&#123;qemu-system-x86&#125;(8534)</span><br><span class="line">                      ├─&#123;qemu-system-x86&#125;(8535)</span><br><span class="line">                      ├─&#123;qemu-system-x86&#125;(8536)</span><br><span class="line">                      ├─&#123;qemu-system-x86&#125;(8537)</span><br><span class="line">                      ├─&#123;qemu-system-x86&#125;(8538)</span><br><span class="line">                      ├─&#123;qemu-system-x86&#125;(8539)</span><br><span class="line">                      ├─&#123;qemu-system-x86&#125;(8540)</span><br><span class="line">                      ├─&#123;qemu-system-x86&#125;(8541)</span><br><span class="line">                      ├─&#123;qemu-system-x86&#125;(8542)</span><br><span class="line">                      ├─&#123;qemu-system-x86&#125;(8552)</span><br></pre></td></tr></table></figure>
<p>使用gbd 调试进程，这里参考<a target="_blank" rel="noopener" href="https://www.cnblogs.com/hukey/p/11138768.html">https://www.cnblogs.com/hukey/p/11138768.html</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-kvm:/home/ubuntu<span class="comment"># gdb attach 8526</span></span><br><span class="line">GNU gdb (Ubuntu 9.2-0ubuntu1~20.04) 9.2</span><br><span class="line">Copyright (C) 2020 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br><span class="line">Type <span class="string">&quot;show copying&quot;</span> and <span class="string">&quot;show warranty&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">&quot;x86_64-linux-gnu&quot;</span>.</span><br><span class="line">Type <span class="string">&quot;show configuration&quot;</span> <span class="keyword">for</span> configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">    &lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class="line"></span><br><span class="line">For <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">&quot;help&quot;</span>.</span><br><span class="line">Type <span class="string">&quot;apropos word&quot;</span> to search <span class="keyword">for</span> commands related to <span class="string">&quot;word&quot;</span>.</span><br><span class="line">Attaching to process 8526</span><br><span class="line">[New LWP 8530]</span><br><span class="line">[New LWP 8534]</span><br><span class="line">[New LWP 8535]</span><br><span class="line">[New LWP 8536]</span><br><span class="line">[New LWP 8537]</span><br><span class="line">[New LWP 8538]</span><br><span class="line">[New LWP 8539]</span><br><span class="line">[New LWP 8540]</span><br><span class="line">[New LWP 8541]</span><br><span class="line">[New LWP 8542]</span><br><span class="line">[New LWP 8552]</span><br><span class="line">[New LWP 250213]</span><br><span class="line"></span><br><span class="line">warning: <span class="string">&quot;target:/usr/bin/qemu-system-x86_64 (deleted)&quot;</span>: could not open as an executable file: No such file or directory.</span><br><span class="line"></span><br><span class="line">warning: `target:/usr/bin/qemu-system-x86_64 (deleted)<span class="string">&#x27;: can&#x27;</span>t open to <span class="built_in">read</span> symbols: No such file or directory.</span><br><span class="line"></span><br><span class="line">warning: Could not load vsyscall page because no executable was specified</span><br><span class="line">0x00007fdcda986bf6 <span class="keyword">in</span> ?? ()</span><br><span class="line">(gdb) info threads</span><br><span class="line">  Id   Target Id                  Frame</span><br><span class="line">* 1    LWP 8526 <span class="string">&quot;qemu-system-x86&quot;</span> 0x00007fdcda986bf6 <span class="keyword">in</span> ?? ()</span><br><span class="line">  2    LWP 8530 <span class="string">&quot;call_rcu&quot;</span>        0x00007fdcda98c89d <span class="keyword">in</span> ?? ()</span><br><span class="line">  3    LWP 8534 <span class="string">&quot;IO mon_iothread&quot;</span> 0x00007fdcda986aff <span class="keyword">in</span> ?? ()</span><br><span class="line">  4    LWP 8535 <span class="string">&quot;CPU 0/KVM&quot;</span>       0x00007fdcda98850b <span class="keyword">in</span> ?? ()</span><br><span class="line">  5    LWP 8536 <span class="string">&quot;CPU 1/KVM&quot;</span>       0x00007fdcda98850b <span class="keyword">in</span> ?? ()</span><br><span class="line">  6    LWP 8537 <span class="string">&quot;CPU 2/KVM&quot;</span>       0x00007fdcda98850b <span class="keyword">in</span> ?? ()</span><br><span class="line">  7    LWP 8538 <span class="string">&quot;CPU 3/KVM&quot;</span>       0x00007fdcda98850b <span class="keyword">in</span> ?? ()</span><br><span class="line">  8    LWP 8539 <span class="string">&quot;CPU 4/KVM&quot;</span>       0x00007fdcda98850b <span class="keyword">in</span> ?? ()</span><br><span class="line">  9    LWP 8540 <span class="string">&quot;CPU 5/KVM&quot;</span>       0x00007fdcda98850b <span class="keyword">in</span> ?? ()</span><br><span class="line">  10   LWP 8541 <span class="string">&quot;CPU 6/KVM&quot;</span>       0x00007fdcda98850b <span class="keyword">in</span> ?? ()</span><br><span class="line">  11   LWP 8542 <span class="string">&quot;CPU 7/KVM&quot;</span>       0x00007fdcda98850b <span class="keyword">in</span> ?? ()</span><br><span class="line">  12   LWP 8552 <span class="string">&quot;SPICE Worker&quot;</span>    0x00007fdcda986aff <span class="keyword">in</span> ?? ()</span><br><span class="line">  13   LWP 250213 <span class="string">&quot;worker&quot;</span>        0x00007fdcdaa76618 <span class="keyword">in</span> ?? ()</span><br></pre></td></tr></table></figure>
<h2 id="Chapter-4-KVM-网络"><a href="#Chapter-4-KVM-网络" class="headerlink" title="Chapter 4 KVM 网络"></a>Chapter 4 KVM 网络</h2><p>本章节介绍了以下内容</p>
<ul>
<li>Virtual Network – 阐述为什么需要虚拟网络。从虚拟交换机开始，设想一下如果没有虚拟交换机，有20个虚拟机需要20个物理接口连接至20个物理交换机的端口。引入虚拟交换机，减少服务器的物理接口和物理交换机的接口需求。</li>
<li>Libvirt 的三类网络：NAT、Routed(Bridged)、Isolated；使用virsh net-dumpxml default输出xml文件。</li>
<li>TUN/TAP设备：属于用户空间的设备，an application can open /dev/net/tun and use an ioctl() function to register a network device in the kernel, which, in turn, presents itself as a tunXX or tapXX device.  TUN设备是一个3层设备，TAP设备是一个2层设备。</li>
<li>简单介绍了Linux Bridge，此处可以使用ip link 命令替代brctl命令，并使用NetworkManager来持久化配置。</li>
<li>Open vSwitch简单介绍</li>
<li>SR-IOV的介绍：此处可以参考我自己的文档。</li>
<li>MACVTAP介绍：It’s a newer driver that should simplify our virtualized networking by completely removing tun/tap and bridge drivers with a single module.  有四种模式，VEPA，Bridge，Private和Pass-through。</li>
</ul>
<h2 id="Chapter-5-KVM-存储"><a href="#Chapter-5-KVM-存储" class="headerlink" title="Chapter 5 KVM 存储"></a>Chapter 5 KVM 存储</h2><p>本章属于囫囵吞枣的看完了，一知半解的记录一下，大致了解了一些存储方面的概念和存储的最新发展。</p>
<h3 id="存储资源池"><a href="#存储资源池" class="headerlink" title="存储资源池"></a>存储资源池</h3><p>CentOS支持的存储池种类如下：</p>
<ul>
<li>Logical Volume Manager (LVM)-based storage pools</li>
<li>Directory-based storage pools</li>
<li>Partition-based storage pools</li>
<li>GlusterFS-based storage pools</li>
<li>iSCSI-based storage pools</li>
<li>Disk-based storage pools</li>
<li>HBA-based storage pools, which use SCSI devices</li>
</ul>
<p>对于libvirt来说，存储资源池可能是一个目录，一个存储设备，或者是一个文件。</p>
<p>介绍了两种文件系统：</p>
<ul>
<li><strong>Brtfs</strong> is a type of filesystem that supports snapshots, RAID and LVM-like functionality, compression, defragmentation, online resizing, and many other advanced features. It was deprecated after it was discovered that its RAID5/6 can easily lead to a loss of data. –这里说的是Red Hat</li>
<li><strong>ZFS</strong> is a type of filesystem that supports everything that Brtfs does, plus read and write caching. <strong>ZFS is not a part of the Linux kernel.</strong></li>
</ul>
<h3 id="本地存储池"><a href="#本地存储池" class="headerlink" title="本地存储池"></a>本地存储池</h3><p>Stratis是随RHEL 8引入的本地管理存储解决方案，它使系统管理员可以配置高级存储功能：</p>
<ol>
<li>Pool-based management</li>
<li>Thin provisioning</li>
<li>File system snapshots</li>
<li>Monitoring</li>
</ol>
<p>Stratis使用示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mdadm --create /dev/md0 --verbose --level=10 --raid-devices=4 /dev/sdb /dev/sdc /dev/sdd /dev/sde --spare-devices=1 /dev/sdf2</span><br><span class="line">stratis pool create PacktStratisPool01 /dev/md0</span><br><span class="line">stratis pool add-cache PacktStratisPool01 /dev/sdg</span><br><span class="line">stratis fs create PackStratisPool01 PacktStratisXFS01</span><br><span class="line">mkdir /mnt/packtStratisXFS01</span><br><span class="line">mount /stratis/PacktStratisPool01/PacktStratisXFS01 /mnt/packtStratisXFS01</span><br></pre></td></tr></table></figure>
<h3 id="Libvirt-Storage-Pool"><a href="#Libvirt-Storage-Pool" class="headerlink" title="Libvirt Storage Pool"></a>Libvirt Storage Pool</h3><p>Libvirt 支持多种Storage Pool，详见<a target="_blank" rel="noopener" href="https://libvirt.org/storage.html">https://libvirt.org/storage.html</a></p>
<ul>
<li>Directory pool</li>
<li>Filesystem pool</li>
<li>Network filesystem pool</li>
<li>Logical volume pool</li>
<li>Disk pool</li>
<li>iSCSI pool</li>
<li>iSCSI direct pool</li>
<li>SCSI pool</li>
<li>Multipath pool</li>
<li>RBD pool</li>
<li>Sheepdog pool</li>
<li>Gluster pool</li>
<li>ZFS pool</li>
<li>Vstorage pool</li>
</ul>
<h3 id="NFS-Storage-Pool"><a href="#NFS-Storage-Pool" class="headerlink" title="NFS Storage Pool"></a>NFS Storage Pool</h3><p>NFS自上世纪80年代就出现了，至今依然活跃，尤其是4.2版本以后增强了不少功能；VMware Virtual Volume 6.0 可以提供基于Block和NFS的两种存储访问。</p>
<p>Libvirt 使用NFS Storage Pool示例，也可以使用virt-manager 图形界面创建：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">pool</span> <span class="attr">type</span>=<span class="string">&#x27;netfs&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>NFSpooll<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">host</span> <span class="attr">name</span>=<span class="string">&#x27;192.168.159.144&#x27;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dir</span> <span class="attr">path</span>=<span class="string">&#x27;/mnt/packtStratisXF501&#x27;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">format</span> <span class="attr">type</span>=<span class="string">&#x27;auto&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">path</span>&gt;</span>/var/lib/libvirt/images/NFSpooll<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">permissions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">mode</span>&gt;</span>0755<span class="tag">&lt;/<span class="name">mode</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">owner</span>&gt;</span>0<span class="tag">&lt;/<span class="name">owner</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">group</span>&gt;</span>0<span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span>&gt;</span>system_u:object r:nfs t:s0<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">permissions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">pool</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="iSCIS-和-SAN-存储"><a href="#iSCIS-和-SAN-存储" class="headerlink" title="iSCIS 和 SAN 存储"></a>iSCIS 和 SAN 存储</h3><p>iSCIS协议有两个主要原因影响其高效性：</p>
<ul>
<li><strong>IP协议封装</strong> iSCSI encapsulates SCSI commands into regular IP packages, which means segmentation and overhead as IP packages have a pretty large header, which means less efficiency.</li>
<li><strong>基于TCP传输</strong> Even worse, it’s TCP-based, which means that there are sequence numbers and retransmissions, which can lead to queueing and latency, and the bigger the environment is, the more you usually feel these effects affect your virtual machine performance.</li>
</ul>
<p>The iSCSI and FC architectures are very similar—they both need a target (an iSCSI target and an FC target) and an initiator (an iSCS initiator and an FC initiator)，the initiator connects to a target to get access to block storage that’s presented via that target.</p>
<h4 id="LUN的概念"><a href="#LUN的概念" class="headerlink" title="LUN的概念"></a>LUN的概念</h4><p>LUNs are just raw, block capacities that we export via an iSCSI target toward initiators. LUNs are indexed, or numbered, usually from 0 onward. Every LUN number represents a different storage capacity that an initiator can connect to.</p>
<p>For example, we can have an iSCSI target with three different LUNs—LUN0 with 20 GB, LUN1 with 40 GB, and LUN2 with 60 GB. These will all be hosted on the same storage system’s iSCSI target. We can then configure the iSCSI target to accept an IQN to see all the LUNs, another IQN to only see LUN1, and another IQN to only see LUN1 and LUN2. </p>
<p>使用 targetcli命令创建iSCIS target，步骤简要说明如下：</p>
<ol>
<li>创建/dev/sdb1分区和XFS文件系统，并mount /dev/sdb1 /LUN0，用targetcli创建一个fileio 类型的target后端</li>
<li>创建/dev/sdc1分区，并直接使用targetcli创建一个block类型的target后端</li>
<li>基于/dev/sdd创建LVM，并使用targetcli创建一个block类型的target后端</li>
<li>在KVM主机上设置好iscsi的initiator参数</li>
<li>回到iSCSI上，创建ACL，允许KVM host，基于1~3创建的target发布LUNs</li>
<li>在KVM Host上定义Storage Pool的XML文件，用virsh pool-define创建Storage Pool</li>
</ol>
<h3 id="Storage-redundancy-and-multipathing"><a href="#Storage-redundancy-and-multipathing" class="headerlink" title="Storage redundancy and multipathing"></a>Storage redundancy and multipathing</h3><p>避免单点故障SPOF，网卡、线缆、交换机、存储控制器等等。</p>
<p>KVM Host基于iSCSI做冗余和多路径的配置较为复杂，并且缺少支持，文章建议使用oVirt或者RHEV-H(Red Hat Enterprise Virtualization Hypervisor. )</p>
<p>使用oVirt 创建一个iSCSI Bond来实现冗余和多路径。</p>
<h3 id="Gluster"><a href="#Gluster" class="headerlink" title="Gluster"></a>Gluster</h3><p>Gluster 是一个分布式文件系统，其突出优势是可扩展性，数据复制和快照功能；注意Gluster是一个文件存储服务。</p>
<p>生产环境中，Gluster至少配置三台服务器。</p>
<p>配置步骤简要说明如下：</p>
<ol>
<li><p>创建磁盘分区以及文件系统 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkfs.xfs /dev/sdb</span><br><span class="line">mkdir /gluster/bricks/1 -p</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;/dev/sdb /gluster/bricks/1 xfs defaults 0 0&#x27;</span> &gt;&gt; /etc/</span><br><span class="line">fstab</span><br><span class="line">mount -a</span><br><span class="line">mkdir /gluster/bricks/1/brick</span><br></pre></td></tr></table></figure></li>
<li><p>创建Gluster分布式文件系统</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gluster volume create kvmgluster replica 3 \ gluster1:/gluster/</span><br><span class="line">bricks/1/brick gluster2:/gluster/bricks/1/brick \ gluster3:/</span><br><span class="line">gluster/bricks/1/brick</span><br><span class="line">gluster volume start kvmgluster</span><br><span class="line">gluster volume <span class="built_in">set</span> kvmgluster auth.allow 192.168.159.0/24</span><br><span class="line">gluster volume <span class="built_in">set</span> kvmgluster allow-insecure on</span><br><span class="line">gluster volume <span class="built_in">set</span> kvmgluster storage.owner-uid 107</span><br><span class="line">gluster volume <span class="built_in">set</span> kvmgluster storage.owner-gid 107</span><br></pre></td></tr></table></figure></li>
<li><p>挂在Gluster文件系统为NFS服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;localhost:/kvmgluster /mnt glusterfs \ defaults,_</span></span><br><span class="line"><span class="string">netdev,backupvolfile-server=localhost 0 0&#x27;</span> &gt;&gt; /etc/fstab</span><br><span class="line">mount.glusterfs localhost:/kvmgluster /mnt</span><br></pre></td></tr></table></figure></li>
<li><p>在KVM主机上挂在Gluster</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget \ https://download.gluster.org/pub/gluster/glusterfs/6/</span><br><span class="line">LATEST/CentOS/gl\ usterfs-rhel8.repo -P /etc/yum.repos.d</span><br><span class="line">yum install glusterfs glusterfs-fuse attr -y</span><br><span class="line">mount -t glusterfs -o context=<span class="string">&quot;system_u:object_r:virt_</span></span><br><span class="line"><span class="string">image_t:s0&quot;</span> \ gluster1:/kvmgluster /var/lib/libvirt/images/</span><br><span class="line">GlusterFS</span><br></pre></td></tr></table></figure></li>
<li><p>在KVM上定义存储资源池：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">pool</span> <span class="attr">type</span>=<span class="string">&#x27;dir&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>glusterfs-pool<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">path</span>&gt;</span>/var/lib/libvirt/images/GlusterFS<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">permissions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">mode</span>&gt;</span>0755<span class="tag">&lt;/<span class="name">mode</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">owner</span>&gt;</span>107<span class="tag">&lt;/<span class="name">owner</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">group</span>&gt;</span>107<span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span>&gt;</span>system_u:object_r:virt_image_t:s0<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">permissions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">pool</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">virsh pool-define --file gluster.xml</span><br><span class="line">virsh pool-start --pool glusterfs-pool</span><br><span class="line">virsh pool-autostart --pool glusterfs-pool</span><br></pre></td></tr></table></figure>
<p>将Gluster挂在为目录，可以避免Libvirt在使用Gluster的两个问题：</p>
</li>
</ol>
<ul>
<li><p>We can use Gluster’s failover capability, which will be managed automatically by the</p>
<p>Gluster utilities that we installed directly, as libvirt doesn’t support them yet.</p>
</li>
<li><p>We will avoid creating virtual machine disks <em>manually</em>, which is another limitation of libvirt’s implementation of Gluster support, while directory-based storage pools support it without any issues.</p>
</li>
</ul>
<h3 id="Ceph"><a href="#Ceph" class="headerlink" title="Ceph"></a>Ceph</h3><p>Ceph offers block and object-based storage. Object-based storage for block-based devices means direct, binary storage, directly to a LUN. There are no filesystems involved, which theoretically means less overhead as there’s no filesystem, filesystem tables, and other constructs that might slow the I/O process down.</p>
<p>Architecture-wise, Ceph has three main services:</p>
<ul>
<li>ceph-mon : Used for cluster monitoring, CRUSH maps, and Object Storage Daemon (OSD) maps.</li>
<li>ceph-osd: This handles actual data storage, replication, and recovery. It requires at least two nodes; we’ll use three for clustering reasons.</li>
<li>ceph-mds: Metadata server, used when Ceph needs filesystem access.</li>
</ul>
<p>Ceph 集群中，所有的数据节点要求采用相同的硬件配置，相同的CPU、内存、硬盘，不适用RAID控制器，仅仅使用HBA。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy install ceph-admin ceph-monitor ceph-osd1 ceph-osd2</span><br><span class="line">ceph-osd3</span><br><span class="line">ceph-deploy mon create-initial</span><br><span class="line">ceph-deploy gatherkeys ceph-monitor</span><br><span class="line">ceph-deploy disk list ceph-osd1 ceph-osd2 ceph-osd3</span><br><span class="line">ceph-deploy disk zap ceph-osd1:/dev/sdb  ceph-osd2:/dev/sdb</span><br><span class="line">ceph-osd3:/dev/sdb</span><br><span class="line">ceph-deploy osd prepare ceph-osd1:/dev/sdb ceph-osd2:/dev/sdb</span><br><span class="line">ceph-osd3:/dev/sdb</span><br><span class="line">ceph-deploy osd activate ceph-osd1:/dev/sdb1 ceph-osd2:/dev/</span><br><span class="line">sdb1 ceph-osd3:/dev/sdb1</span><br></pre></td></tr></table></figure>
<p>对上述命令的说明：</p>
<ul>
<li><p>The first command starts the actual deployment process—for the admin, monitor, and OSD nodes, with the installation of all the necessary packages.</p>
</li>
<li><p>The second and third commands configure the monitor host so that it’s ready to accept external connections.</p>
</li>
<li><p>The two disk commands are all about disk preparation—Ceph will clear the disks that we assigned to it (/dev/sdb per OSD host) and create two partitions on them, one for Ceph data and one for the Ceph journal.</p>
</li>
<li><p>The last two commands prepare these filesystems for use and activate Ceph. If at any time your ceph-deploy script stops, check your DNS and /etc/hosts and firewalld configuration, as that’s where the problems usually are.</p>
</li>
</ul>
<p>使用以下命令将Ceph存储发布给KVM主机作为存储池：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph osd pool create KVMpool 128 128</span><br></pre></td></tr></table></figure>
<p>还需要几个步骤来实现安全的访问，为Ceph的访问增加密码验证。</p>
<ol>
<li><p>Ceph生成验证的密码 Key</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ceph auth get-or-create client.KVMpool mon <span class="string">&#x27;allow r&#x27;</span> osd <span class="string">&#x27;allow</span></span><br><span class="line"><span class="string">rwx pool=KVMpool&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#It&#x27;s going to throw us a status message, something like this:</span></span><br><span class="line">key = AQB9p8RdqS09CBAA1DHsiZJbehb7ZBffhfmFJQ==</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>定义一个Secret</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">secret</span> <span class="attr">ephemeral</span>=<span class="string">&#x27;no&#x27;</span> <span class="attr">private</span>=<span class="string">&#x27;no&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">usage</span> <span class="attr">type</span>=<span class="string">&#x27;ceph&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>client.KVMpool secret<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">usage</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">secret</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>将Secret的UUID与Ceph生成的Key进行关联。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">virsh secret-define --file secret.xml</span><br><span class="line"></span><br><span class="line">Secret 95b1ed29-16aa-4e95-9917-c2cd4f3b2791 created</span><br><span class="line"></span><br><span class="line">virsh secret-set-value 95b1ed29-16aa-4e95-9917-c2cd4f3b2791</span><br><span class="line">AQB9p8RdqS09CBAA1DHsiZJbehb7ZBffhfmFJQ==</span><br></pre></td></tr></table></figure></li>
<li><p>定义Ceph存储池</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">pool</span> <span class="attr">type</span>=<span class="string">&quot;rbd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>KVMpool<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">host</span> <span class="attr">name</span>=<span class="string">&#x27;192.168.159.151&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;6789&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">auth</span> <span class="attr">username</span>=<span class="string">&#x27;KVMpool&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;ceph&#x27;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">secret</span> <span class="attr">uuid</span>=<span class="string">&#x27;95b1ed29-16aa-4e95-9917-c2cd4f3b2791&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">auth</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">pool</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">virsh pool-define --file ceph.xml</span><br><span class="line">virsh pool-start KVMpool</span><br><span class="line">virsh pool-autostart KVMpool</span><br><span class="line">virsh pool-list --details</span><br></pre></td></tr></table></figure>
<h3 id="虚拟磁盘镜像和KVM存储基本操作"><a href="#虚拟磁盘镜像和KVM存储基本操作" class="headerlink" title="虚拟磁盘镜像和KVM存储基本操作"></a>虚拟磁盘镜像和KVM存储基本操作</h3></li>
</ol>
<p>文章介绍了使用dd命令生成磁盘镜像文件，如下：</p>
<p>生成10G的预分配磁盘文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd <span class="keyword">if</span>=/dev/zero of=/vms/dbvm_disk2.img bs=1G count=10</span><br></pre></td></tr></table></figure>
<p>生成10G的磁盘文件，使用seek关键字，不做预分配</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd <span class="keyword">if</span>=/dev/zero of=/vms/dbvm_disk2_seek.imgbs=1G seek=10 count=0</span><br></pre></td></tr></table></figure>
<h4 id="qemu-img-命令"><a href="#qemu-img-命令" class="headerlink" title="qemu-img 命令"></a>qemu-img 命令</h4><p>使用qemu-img info查看磁盘文件的信息，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># qemu-img info /vms/dbvm_disk2.img</span></span><br><span class="line">image: /vms/dbvm_disk2.img</span><br><span class="line">file format: raw</span><br><span class="line">virtual size: 10G (10737418240 bytes)</span><br><span class="line">disk size: 10G</span><br><span class="line"><span class="comment"># qemu-img info /vms/dbvm_disk2_seek.img</span></span><br><span class="line">image: /vms/dbvm_disk2_seek.img</span><br><span class="line">file format: raw</span><br><span class="line">virtual size: 10G (10737418240 bytes)</span><br><span class="line">disk size: 10M</span><br></pre></td></tr></table></figure>
<h4 id="使用virsh命令加载硬盘"><a href="#使用virsh命令加载硬盘" class="headerlink" title="使用virsh命令加载硬盘"></a>使用virsh命令加载硬盘</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virsh attach-disk CentOS8 /vms/dbvm_disk2.img vdb --live --config</span><br></pre></td></tr></table></figure>
<p>说明如下：</p>
<ul>
<li> <strong>CentOS8</strong> is the virtual machine to which a disk attachment is executed. </li>
<li>Then, there is the path of the disk image,  <strong>/vms/dbvm_disk2.img</strong></li>
<li><strong>vdb</strong> is the target disk name that would be visible inside the guest operating system. </li>
<li><strong>–live</strong> means performing the action while the virtual machine is running.</li>
<li><strong>–config</strong> means attaching it persistently across reboot. Not adding a –config switch will keep the disk attached only until reboot.</li>
</ul>
<p>查看虚拟机的硬盘信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">virsh domblklist CentOS8 --details</span><br><span class="line"></span><br><span class="line">Type Device Target Source</span><br><span class="line">------------------------------------------------</span><br><span class="line">file disk vda /var/lib/libvirt/images/fedora21.qcow2</span><br><span class="line">file disk vdb /vms/dbvm_disk2_seek.img</span><br></pre></td></tr></table></figure>
<p>还有其他章节，比如创建ISO库、删除存储池、创建卷和删除卷。</p>
<h4 id="有关NVMe和NVMe-over-Fabric"><a href="#有关NVMe和NVMe-over-Fabric" class="headerlink" title="有关NVMe和NVMe over Fabric"></a>有关NVMe和NVMe over Fabric</h4><p>SSD存储的存取方式发生改变，主要体现在性能和延时这两方面。传统<strong>AHCI</strong> (Advanced Host Controller Interface) 已不能满足SSD的性能要求。</p>
<p><strong>NVMe</strong> (Non-Volatile Memory Express) 是一个全新的协议，基于PCIe技术，目的在于满足SSD的高性能、低时延的访问要求。越来越多的存储设备已经集成了SSD和NVMe，主要用于缓存，同时也有用于数据存储的。</p>
<p>Fiber Channel，虽然10多年被人争执说要从市场消失，主要原因无外乎：FC需要专用的交换机、专门的网卡和线缆，FC设备贵，需要专门的知识，而且FC的速率没有以太网发展快。</p>
<p>但是，目前市场上发生的情况有所不同，FC可以满足NVMe SSD带来的性能提升的需求。</p>
<p>Two of these concepts derived from <strong>Intel Optane</strong>—<strong>Storage Class Memory (SCM) and Persistent Memory (PM)</strong> are the latest technologies that storage companies and customers want adopted into their storage systems, and fast.</p>
<p>将工作负载移到内存当中是符合逻辑的，设想一下内存型数据库(Microsoft SQL, SAP HANA, Oracle).</p>
<p>如果一个存储厂商生产了使用SCM SSD的存储设备，那么只有内存可用于缓存(Cache).</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/kvm/" rel="tag"># kvm</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/csr1kv-nfvis-ztp-demo.html" rel="prev" title="Cisco NFVIS CSR1Kv ZTP Onboarding for SDWAN">
                  <i class="fa fa-chevron-left"></i> Cisco NFVIS CSR1Kv ZTP Onboarding for SDWAN
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/deploy-thousandeyes-agent-on-aws.html" rel="next" title="在AWS上部署TE Agent并进行测试">
                  在AWS上部署TE Agent并进行测试 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Rao Weibo</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
