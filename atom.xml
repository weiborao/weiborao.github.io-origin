<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Rao Weibo的博客</title>
  
  
  <link href="https://weiborao.link/atom.xml" rel="self"/>
  
  <link href="https://weiborao.link/"/>
  <updated>2021-07-06T06:10:58.348Z</updated>
  <id>https://weiborao.link/</id>
  
  <author>
    <name>Rao Weibo</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>有关AnyCast</title>
    <link href="https://weiborao.link/anycast-brief.html"/>
    <id>https://weiborao.link/anycast-brief.html</id>
    <published>2021-07-06T06:00:00.000Z</published>
    <updated>2021-07-06T06:10:58.348Z</updated>
    
    <content type="html"><![CDATA[<p>AnyCast，一组服务器拥有相同的IP地址，当客户端访问该组服务器时，网络会将请求发送至最近的服务器进行处理，从而极大的缩短途径的公网路径，减少延时、抖动、丢包的情况。</p><p>AnyCast通常和BGP路由协议关联在一起，其实现的主要原理是：位于不同地理位置的路由器向外发布同一段IP网段的BGP路由，路由在Internet中传播后，访问发起端所处网络的路由器会选择最短的BGP AS Path路由，从而实现最短路径的访问。如果BGP选路区分不出最近的路径，那就由IGP最短路径进行转发。</p><p>AnyCast的好处：</p><ul><li>就近访问，减少时延、提升性能</li><li>获得高冗余性和可用性，即当任意目的节点异常时，可自动路由到就近目的节点</li><li>实现负载均衡，且对客户端是透明的（由网络路由实现）</li><li>缓解DDOS攻击，AnyCast将DDOS攻击流量引导至本地服务器，极大的减少了DDOS流量的范围以及规模</li></ul><p>Office 365 的SharePoint使用了AnyCast，例如nslookup 解析<a href="https://cisco.sharepoint.com/">cisco.sharepoint.com</a>、<a href="http://citrix.sharepoint.com/">citrix.sharepoint.com</a>、<a href="http://intel.sharepoint.com/">intel.sharepoint.com</a> 得到相同的地址</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ nslookup cisco.sharepoint.com | tail -n 2 | grep Address</span><br><span class="line">Address: 13.107.136.9</span><br><span class="line">➜  ~ nslookup citrix.sharepoint.com | tail -n 2 | grep Address</span><br><span class="line">Address: 13.107.136.9</span><br><span class="line">➜  ~ nslookup intel.sharepoint.com | tail -n 2 | grep Address</span><br><span class="line">Address: 13.107.136.9</span><br><span class="line">➜  ~ nslookup nike.sharepoint.com | tail -n 2 | grep Address</span><br><span class="line">Address: 13.107.136.9</span><br><span class="line">➜  ~ nslookup bmw.sharepoint.com | tail -n 2 | grep Address</span><br><span class="line">Address: 13.107.136.9</span><br></pre></td></tr></table></figure><p>Telnet 至 route-views3.routeviews.org 查询13.107.136.9的路由，发现该地址命中的路由是13.107.136.0/24，从AS 8068 – AS 8075发布出来，这都是Microsoft的AS号。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line">route-views3.routeviews.org&gt; show bgp ipv4 13.107.136.9</span><br><span class="line">BGP routing table entry for 13.107.136.0&#x2F;24</span><br><span class="line">Paths: (40 available, best #33, table default)</span><br><span class="line">  Not advertised to any peer</span><br><span class="line">  61568 8075 8068</span><br><span class="line">    190.15.124.18 from 190.15.124.18 (190.15.124.18)</span><br><span class="line">      Origin IGP, valid, external</span><br><span class="line">      Last update: Mon Jul  5 21:13:03 2021</span><br><span class="line">  202365 49697 8075 8068</span><br><span class="line">    194.50.19.4 from 194.50.19.4 (185.1.166.50)</span><br><span class="line">      Origin IGP, valid, external</span><br><span class="line">      Community: 49697:3000 65101:1002 65102:1000 65103:276 65104:150</span><br><span class="line">      Last update: Sun Jul  4 17:31:02 2021</span><br><span class="line">  39120 8075 8068</span><br><span class="line">    89.21.210.85 from 89.21.210.85 (195.60.191.13)</span><br><span class="line">      Origin IGP, valid, external</span><br><span class="line">      Last update: Sat Jul  3 20:46:17 2021</span><br><span class="line">  40630 6939 8075 8068</span><br><span class="line">    208.94.118.10 from 208.94.118.10 (208.94.118.10)</span><br><span class="line">      Origin IGP, valid, external</span><br><span class="line">      Community: 40630:100 40630:11701</span><br><span class="line">      Last update: Mon Jul  5 19:14:13 2021</span><br><span class="line">  54574 8075 8068</span><br><span class="line">    154.18.7.114 from 154.18.7.114 (193.41.248.191)</span><br><span class="line">      Origin IGP, valid, external</span><br><span class="line">      Community: 54574:1000</span><br><span class="line">      Last update: Wed Jun 30 02:40:58 2021</span><br><span class="line">  39120 8075 8068</span><br><span class="line">    89.21.210.86 from 89.21.210.86 (195.60.190.28)</span><br><span class="line">      Origin IGP, valid, external</span><br><span class="line">      Last update: Mon Jun 28 17:54:55 2021</span><br><span class="line">  64116 7195 8075 8068</span><br><span class="line">    45.183.45.1 from 45.183.45.1 (10.7.1.1)</span><br><span class="line">      Origin IGP, valid, external</span><br><span class="line">      Community: 7195:1000 7195:1001 7195:1300 7195:1302</span><br><span class="line">      Last update: Fri Jul  2 00:44:52 2021</span><br><span class="line">  54574 6461 8075 8068</span><br><span class="line">    38.19.140.162 from 38.19.140.162 (193.41.248.193)</span><br><span class="line">      Origin IGP, valid, external</span><br><span class="line">      Community: 6461:5997 54574:2000 54574:6461</span><br><span class="line">      Last update: Mon Jun 28 07:19:51 2021</span><br><span class="line">  39351 8075 8068</span><br><span class="line">    193.138.216.164 from 193.138.216.164 (193.138.216.164)</span><br><span class="line">      Origin IGP, valid, external</span><br><span class="line">      Last update: Fri Jun 25 20:17:33 2021</span><br><span class="line">  202365 57866 8075 8068</span><br><span class="line">    5.255.90.109 from 5.255.90.109 (185.255.155.66)</span><br><span class="line">      Origin IGP, metric 0, valid, external</span><br><span class="line">      Community: 57866:12 57866:304 57866:501</span><br><span class="line">      Large Community: 57866:41441:41441</span><br><span class="line">      Last update: Sun Jun 27 19:25:03 2021</span><br><span class="line">  3216 12389 8075 8068</span><br><span class="line">    195.239.252.124 from 195.239.252.124 (195.239.252.124)</span><br><span class="line">      Origin IGP, valid, external</span><br><span class="line">      Community: 3216:1000 3216:1077 3216:1101</span><br><span class="line">      Last update: Thu Jun 24 09:16:54 2021</span><br><span class="line">  3216 12389 8075 8068</span><br><span class="line">    195.239.77.236 from 195.239.77.236 (195.239.77.236)</span><br><span class="line">      Origin IGP, valid, external</span><br><span class="line">      Community: 3216:1000 3216:1077 3216:1101</span><br><span class="line">      Last update: Thu Jun 24 09:14:17 2021</span><br><span class="line">  11537 8075 8068</span><br><span class="line">    64.57.28.241 from 64.57.28.241 (64.57.28.241)</span><br><span class="line">      Origin IGP, metric 17, valid, external</span><br><span class="line">      Community: 11537:254 11537:3500 11537:5000 11537:5002 11537:5014</span><br><span class="line">      Last update: Thu Jun 24 08:50:42 2021</span><br><span class="line">  19653 8075 8068</span><br><span class="line">    67.219.192.5 from 67.219.192.5 (67.219.192.5)</span><br><span class="line">      Origin IGP, valid, external</span><br><span class="line">      Last update: Wed Jun 30 11:14:51 2021</span><br><span class="line">  14315 6453 6453 8075 8068</span><br><span class="line">    104.251.122.1 from 104.251.122.1 (104.251.122.1)</span><br><span class="line">      Origin IGP, valid, external</span><br><span class="line">      Community: 14315:5000</span><br><span class="line">      Last update: Tue Jun 22 10:36:25 2021</span><br><span class="line">  38136 38008 8075 8068</span><br><span class="line">    103.152.35.22 from 103.152.35.22 (103.152.35.22)</span><br><span class="line">      Origin IGP, valid, external</span><br><span class="line">      Community: 38008:103 65521:10</span><br><span class="line">      Large Community: 38136:1000:11</span><br><span class="line">      Last update: Tue Jun 22 07:22:58 2021</span><br><span class="line">  17920 6939 8075 8068</span><br><span class="line">    103.149.144.251 from 103.149.144.251 (103.149.144.251)</span><br><span class="line">      Origin IGP, valid, external</span><br><span class="line">      Community: 17920:1000 17920:1008</span><br><span class="line">      Last update: Sat Jun 19 01:43:19 2021</span><br><span class="line">  50236 34549 8075 8068</span><br><span class="line">    2.56.9.2 from 2.56.9.2 (2.56.9.2)</span><br><span class="line">      Origin IGP, valid, external</span><br><span class="line">      Community: 34549:200 34549:10000 50236:10010</span><br><span class="line">      Last update: Thu Jun 17 16:09:18 2021</span><br><span class="line">  3280 39737 8075 8068</span><br><span class="line">    77.83.243.7 from 77.83.243.7 (77.83.243.7)</span><br><span class="line">      Origin IGP, valid, external</span><br><span class="line">      Community: 39737:80 39737:2040</span><br><span class="line">      Last update: Sat Jul  3 23:45:54 2021</span><br><span class="line">  39120 8075 8068</span><br><span class="line">    94.101.60.146 from 94.101.60.146 (94.161.60.146)</span><br><span class="line">      Origin IGP, valid, external</span><br><span class="line">      Last update: Fri Jun 18 15:06:50 2021</span><br><span class="line">  207740 58057 8075 8068</span><br><span class="line">    136.243.0.23 from 136.243.0.23 (136.243.0.23)</span><br><span class="line">      Origin IGP, valid, external</span><br><span class="line">      Last update: Tue Jun 22 18:11:37 2021</span><br><span class="line">  38136 50131 53340 174 8075 8068</span><br><span class="line">    172.83.155.50 from 172.83.155.50 (172.83.155.50)</span><br><span class="line">      Origin IGP, valid, external</span><br><span class="line">      Large Community: 38136:1000:17</span><br><span class="line">      Last update: Tue Jun  8 08:24:12 2021</span><br><span class="line">  40387 11537 8075 8068</span><br><span class="line">    72.36.126.8 from 72.36.126.8 (72.36.126.8)</span><br><span class="line">      Origin IGP, valid, external</span><br><span class="line">      Community: 40387:1400</span><br><span class="line">      Last update: Tue Jun  8 07:02:44 2021</span><br><span class="line">  38136 57695 8075 8068</span><br><span class="line">    170.39.224.212 from 170.39.224.212 (170.39.224.212)</span><br><span class="line">      Origin IGP, valid, external</span><br><span class="line">      Community: 57695:12000 57695:12002</span><br><span class="line">      Large Community: 38136:1000:1</span><br><span class="line">      Last update: Thu May 27 15:18:00 2021</span><br><span class="line">  3561 209 3356 8075 8068</span><br><span class="line">    206.24.210.80 from 206.24.210.80 (206.24.210.80)</span><br><span class="line">      Origin IGP, valid, external</span><br><span class="line">      Last update: Thu May 27 09:50:45 2021</span><br><span class="line">  29479 50304 8075 8068</span><br><span class="line">    109.233.62.1 from 109.233.62.1 (109.233.62.2)</span><br><span class="line">      Origin IGP, valid, external</span><br><span class="line">      Last update: Thu May 27 09:50:11 2021</span><br><span class="line">  209 3356 8075 8068</span><br><span class="line">    205.171.8.123 from 205.171.8.123 (205.171.8.123)</span><br><span class="line">      Origin IGP, metric 8000051, valid, external</span><br><span class="line">      Community: 209:88 209:888 3356:3 3356:22 3356:86 3356:575 3356:666 3356:901 3356:2057 3356:12341</span><br><span class="line">      Last update: Thu May 27 09:48:26 2021</span><br><span class="line">  14840 8075 8068</span><br><span class="line">    186.211.128.32 from 186.211.128.32 (201.16.22.1)</span><br><span class="line">      Origin IGP, valid, external</span><br><span class="line">      Community: 14840:10 14840:40 14840:6004 14840:7110</span><br><span class="line">      Last update: Wed Jun 23 00:56:13 2021</span><br><span class="line">  209 3356 8075 8068</span><br><span class="line">    205.171.200.245 from 205.171.200.245 (205.171.200.245)</span><br><span class="line">      Origin IGP, metric 0, valid, external</span><br><span class="line">      Community: 209:88 209:888 3356:3 3356:22 3356:86 3356:575 3356:666 3356:901 3356:2059 3356:10327</span><br><span class="line">      Last update: Thu May 27 09:48:23 2021</span><br><span class="line">  209 3356 8075 8068</span><br><span class="line">    205.171.3.54 from 205.171.3.54 (205.171.3.54)</span><br><span class="line">      Origin IGP, metric 8000036, valid, external</span><br><span class="line">      Community: 209:88 209:888 3356:3 3356:22 3356:86 3356:575 3356:666 3356:901 3356:2011 3356:11918</span><br><span class="line">      Last update: Thu May 27 09:48:17 2021</span><br><span class="line">  23367 8075 8068</span><br><span class="line">    64.250.124.251 from 64.250.124.251 (64.250.124.251)</span><br><span class="line">      Origin IGP, valid, external</span><br><span class="line">      Last update: Thu May 27 09:48:06 2021</span><br><span class="line">  5650 8075 8068</span><br><span class="line">    74.40.7.35 from 74.40.7.35 (74.40.0.100)</span><br><span class="line">      Origin IGP, metric 0, valid, external</span><br><span class="line">      Last update: Tue May 25 23:52:37 2021</span><br><span class="line">  38001 8075 8068</span><br><span class="line">    202.150.221.33 from 202.150.221.33 (10.11.33.29)</span><br><span class="line">      Origin IGP, valid, external, best (Older Path)</span><br><span class="line">      Community: 38001:420 38001:2406 38001:3001 38001:8009</span><br><span class="line">      Last update: Fri May 21 11:01:01 2021</span><br><span class="line">  6939 8075 8068</span><br><span class="line">    64.71.137.241 from 64.71.137.241 (216.218.252.164)</span><br><span class="line">      Origin IGP, valid, external</span><br><span class="line">      Last update: Fri May 21 10:58:51 2021</span><br><span class="line">  45352 8075 8068</span><br><span class="line">    210.5.41.225 from 210.5.41.225 (210.5.40.186)</span><br><span class="line">      Origin IGP, valid, external</span><br><span class="line">      Last update: Fri May 21 10:57:46 2021</span><br><span class="line">  3292 8075 8068</span><br><span class="line">    195.215.109.247 from 195.215.109.247 (83.88.49.1)</span><br><span class="line">      Origin IGP, valid, external</span><br><span class="line">      Community: 3292:1100 3292:24500 3292:24580</span><br><span class="line">      Last update: Wed Jun  9 23:59:27 2021</span><br><span class="line">  3257 8075 8068</span><br><span class="line">    89.149.178.10 from 89.149.178.10 (213.200.83.26)</span><br><span class="line">      Origin IGP, metric 10, valid, external</span><br><span class="line">      Community: 3257:4000 3257:8052 3257:50001 3257:50110 3257:54900 3257:54901</span><br><span class="line">      Last update: Fri Jul  2 03:36:10 2021</span><br><span class="line">  46450 8075 8068</span><br><span class="line">    158.106.197.135 from 158.106.197.135 (158.106.197.135)</span><br><span class="line">      Origin IGP, valid, external</span><br><span class="line">      Community: 46450:31111</span><br><span class="line">      Last update: Fri May 21 10:53:55 2021</span><br><span class="line">  5645 8075 8068</span><br><span class="line">    206.248.155.130 from 206.248.155.130 (206.248.155.130)</span><br><span class="line">      Origin IGP, valid, external</span><br><span class="line">      Community: no-advertise</span><br><span class="line">      Last update: Fri May 21 10:53:54 2021</span><br><span class="line">  55222 8075 8068</span><br><span class="line">    162.211.99.255 from 162.211.99.255 (162.211.99.255)</span><br><span class="line">      Origin IGP, valid, external</span><br><span class="line">      Community: 55222:101 55222:200 55222:6001 55222:20020</span><br><span class="line">      Last update: Fri May 21 10:53:45 2021</span><br></pre></td></tr></table></figure><p>AnyCast 典型应用场景：</p><ul><li>DNS：</li><li>CDN</li><li>负载均衡</li><li>分散DDOS攻击</li></ul><p>Reference：</p><p><a href="https://www.cnblogs.com/itzgr/p/10192799.html">https://www.cnblogs.com/itzgr/p/10192799.html</a></p><p><a href="https://www.imperva.com/blog/how-anycast-works/">https://www.imperva.com/blog/how-anycast-works/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;AnyCast，一组服务器拥有相同的IP地址，当客户端访问该组服务器时，网络会将请求发送至最近的服务器进行处理，从而极大的缩短途径的公网路径，减少延时、抖动、丢包的情况。&lt;/p&gt;
&lt;p&gt;AnyCast通常和BGP路由协议关联在一起，其实现的主要原理是：位于不同地理位置的路由</summary>
      
    
    
    
    
    <category term="anycast" scheme="https://weiborao.link/tags/anycast/"/>
    
  </entry>
  
  <entry>
    <title>在Docker容器中tcpdump抓包探秘Traceroute</title>
    <link href="https://weiborao.link/docker-traceroute-tcpdump.html"/>
    <id>https://weiborao.link/docker-traceroute-tcpdump.html</id>
    <published>2021-06-29T07:20:00.000Z</published>
    <updated>2021-06-29T14:19:26.631Z</updated>
    
    <content type="html"><![CDATA[<p>在上一篇文章<a href="https://weiborao.github.io/get-known-traceroute-by-wireshark.html">《通过Wireshark重新认识Traceroute》</a>中，我在MAC电脑上进行抓包来对MAC上的Traceroute过程进行分析。但是MAC电脑上运行了多个应用，我在抓完报文后，使用过滤器将其他报文过滤掉了，但是也很可能把Traceroute产生的报文给删掉了。</p><p>为了打造一个纯净的Traceroute环境，我又使用容器来做一次测试。</p><p>本文记录以下内容：</p><ol><li>创建一个包含traceroute、ping、whois等工具的容器，取名traceroute</li><li>创建一个只包含tcpdump的容器，对traceroute容器抓包</li><li>简略的分析抓包文件—-不是本文重点</li></ol><h1 id="创建Traceroute容器镜像"><a href="#创建Traceroute容器镜像" class="headerlink" title="创建Traceroute容器镜像"></a>创建Traceroute容器镜像</h1><h2 id="Dockerfile准备"><a href="#Dockerfile准备" class="headerlink" title="Dockerfile准备"></a>Dockerfile准备</h2><p>如果我们执行<strong>docker run -it ubuntu</strong>，想在该容器中执行ping、traceroute命令，抱歉，找不到该命令。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  docker pull ubuntu</span><br><span class="line">➜  docker run -it --rm ubuntu</span><br><span class="line">root@631c227046f7:/# ping 8.8.8.8</span><br><span class="line">bash: ping: command not found</span><br><span class="line">root@631c227046f7:/# traceroute 8.8.8.8</span><br><span class="line">bash: traceroute: command not found</span><br><span class="line">root@631c227046f7:/#</span><br></pre></td></tr></table></figure><p>这时候，您可以直接在容器里执行：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@631c227046f7:/# apt-get update &amp;&amp; apt-get install traceroute iputils-ping --no-install-recommends</span><br></pre></td></tr></table></figure><p>当然，您也可以创建一个容器镜像，如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir traceroute</span><br><span class="line">cd traceroute</span><br><span class="line">touch Dockerfile</span><br></pre></td></tr></table></figure><p>Dockerfile 内容如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">FROM ubuntu:latest</span><br><span class="line"></span><br><span class="line">RUN apt-get update &amp;&amp; apt-get install -y \</span><br><span class="line">traceroute \</span><br><span class="line">iputils-ping \</span><br><span class="line">whois \</span><br><span class="line">netbase \</span><br><span class="line">iproute2 \</span><br><span class="line">--no-install-recommends \</span><br><span class="line">&amp;&amp; rm -rf &#x2F;var&#x2F;lib&#x2F;apt&#x2F;lists&#x2F;*</span><br></pre></td></tr></table></figure><p>注：上述要安装的软件包，是我经过尝试后，一个个增加的。</p><ol><li><p>最开始我只安装了traceroute，当我执行traceroute -A 8.8.8.8时，提示如下错误信息：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">whois.radb.net/nicname: Servname not supported for ai_socktype</span><br></pre></td></tr></table></figure></li><li><p>我想起traceroute可能需要调用whois来查询BGP AS号，于是我继续安装whois，仍然报错。—-经过验证，如果不安装whois软件包，traceroute -A 8.8.8.8 可正常工作。</p></li><li><p>只能在网上搜索答案了，果然有人遇到过类似问题：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://stackoverflow.com/questions/56430294/bash-script-that-uses-whois-command-gets-servname-not-supported-error-on-do</span><br><span class="line">解决办法：</span><br><span class="line">apt-get update &amp;&amp; apt-get install -y --no-install-recommends netbase</span><br></pre></td></tr></table></figure></li><li><p>安装iproute2的目的是为了执行ip a,  ip link 这些命令。</p></li></ol><h2 id="根据Dockerfile创建容器镜像"><a href="#根据Dockerfile创建容器镜像" class="headerlink" title="根据Dockerfile创建容器镜像"></a>根据Dockerfile创建容器镜像</h2><p>根据上述的Dockerfile创建容器镜像，执行命令：<strong>docker image build -t traceroute:latest .</strong> 注意末尾的小点，表示当前目录。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">➜  traceroute docker image build -t traceroute:latest .</span><br><span class="line">[+] Building 48.7s (6/6) FINISHED</span><br><span class="line"> =&gt; [internal] load build definition from Dockerfile                                                               0.0s</span><br><span class="line"> =&gt; =&gt; transferring dockerfile: 274B                                                                               0.0s</span><br><span class="line"> =&gt; [internal] load .dockerignore                                                                                  0.0s</span><br><span class="line"> =&gt; =&gt; transferring context: 2B                                                                                    0.0s</span><br><span class="line"> =&gt; [internal] load metadata for docker.io/library/ubuntu:latest                                                   0.0s</span><br><span class="line"> =&gt; CACHED [1/2] FROM docker.io/library/ubuntu:latest                                                              0.0s</span><br><span class="line"> =&gt; [2/2] RUN apt-get update &amp;&amp; apt-get install -y  traceroute  iputils-ping  whois  netbase  iproute2  --no-ins  48.5s</span><br><span class="line"> =&gt; exporting to image                                                                                             0.1s</span><br><span class="line"> =&gt; =&gt; exporting layers                                                                                            0.1s</span><br><span class="line"> =&gt; =&gt; writing image sha256:bbf499e59136872e8d171fddcd1548497a9e76b96d154dcb340b8326252d97d5                       0.0s</span><br><span class="line"> =&gt; =&gt; naming to docker.io/library/traceroute:latest                                                               0.0s</span><br><span class="line"> </span><br><span class="line">➜  traceroute docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">traceroute   latest    bbf499e59136   5 seconds ago    77.4MB</span><br></pre></td></tr></table></figure><h1 id="如何抓取容器的网络报文"><a href="#如何抓取容器的网络报文" class="headerlink" title="如何抓取容器的网络报文"></a>如何抓取容器的网络报文</h1><p>接下来，需要考虑的问题是在MAC电脑上如何抓取容器的网络报文呢？</p><h2 id="Wireshark-on-macOS如何抓包？"><a href="#Wireshark-on-macOS如何抓包？" class="headerlink" title="Wireshark on macOS如何抓包？"></a>Wireshark on macOS如何抓包？</h2><p>我执行了docker run -it –name traceroute traceroute 启动了一个名为tracertoute的容器，打开Wireshark，哪一个接口对应的是这个容器的接口呢？</p><img src="/docker-traceroute-tcpdump/wireshark-int-list.png" class="" title="wireshark-int-list"><p>上面的接口眼花缭乱的，找不出是哪一个接口，en0和lo0上有流量，但是并不是容器连接的端口，只得寻求其他方法。</p><h2 id="基于-Container-网络共享机制来抓包"><a href="#基于-Container-网络共享机制来抓包" class="headerlink" title="基于 Container 网络共享机制来抓包"></a>基于 Container 网络共享机制来抓包</h2><p>通过搜索”how to tcpdump in docker”，找到一篇文章<a href="https://xxradar.medium.com/how-to-tcpdump-effectively-in-docker-2ed0a09b5406">How to TCPdump effectively in Docker</a>，获益匪浅。</p><p>该文章介绍了一种Docker的网络模式，container模式。</p><blockquote><p>In the <code>--net=container:id</code> all traffic in/out a specific container (or group of containers) can be captured.</p></blockquote><p>另一篇文章：<a href="https://www.freeaihub.com/article/container-module-in-docker-network.html">https://www.freeaihub.com/article/container-module-in-docker-network.html</a></p><blockquote><p>Docker网络container模式是指，创建新容器的时候，通过<code>--net container</code>参数，指定其和已经存在的某个容器共享一个 Network Namespace。如下图所示，右方黄色新创建的container，其网卡共享左边容器。因此就不会拥有自己独立的 IP，而是共享左边容器的 IP 172.17.0.2,端口范围等网络资源，两个容器的进程通过 lo 网卡设备通信。</p><p>但这两个容器在其他的资源上，如文件系统、进程列表等还是隔离的。</p><img src="/docker-traceroute-tcpdump/container-module-in-docker-network.png" class="" title="container-module-in-docker-network"></blockquote><p>专门创建一个安装了tcpdump的容器，对上文创建的traceroute容器进行抓包。</p><p>参考<a href="https://xxradar.medium.com/how-to-tcpdump-effectively-in-docker-2ed0a09b5406">How to TCPdump effectively in Docker</a>，在Terminal中执行以下命令，创建一个tcpdump的容器镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker build -t tcpdump - &lt;&lt;EOF </span><br><span class="line">FROM ubuntu </span><br><span class="line">RUN apt-get update &amp;&amp; apt-get install -y tcpdump </span><br><span class="line">CMD tcpdump -i eth0 -w /var/traceroute-ubuntu.pcapng</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>创建过程如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[+] Building 0.1s (6&#x2F;6) FINISHED</span><br><span class="line"> &#x3D;&gt; [internal] load build definition from Dockerfile                                                               0.0s</span><br><span class="line"> &#x3D;&gt; &#x3D;&gt; transferring dockerfile: 159B                                                                               0.0s</span><br><span class="line"> &#x3D;&gt; [internal] load .dockerignore                                                                                  0.0s</span><br><span class="line"> &#x3D;&gt; &#x3D;&gt; transferring context: 2B                                                                                    0.0s</span><br><span class="line"> &#x3D;&gt; [internal] load metadata for docker.io&#x2F;library&#x2F;ubuntu:latest                                                   0.0s</span><br><span class="line"> &#x3D;&gt; [1&#x2F;2] FROM docker.io&#x2F;library&#x2F;ubuntu                                                                            0.0s</span><br><span class="line"> &#x3D;&gt; CACHED [2&#x2F;2] RUN apt-get update &amp;&amp; apt-get install -y tcpdump                                                  0.0s</span><br><span class="line"> &#x3D;&gt; exporting to image                                                                                             0.0s</span><br><span class="line"> &#x3D;&gt; &#x3D;&gt; exporting layers                                                                                            0.0s</span><br><span class="line"> &#x3D;&gt; &#x3D;&gt; writing image sha256:d5d8942d4836fabbb0343a082d9aa0009c6dd5071c70a54ae57baf6728462562                       0.0s</span><br><span class="line"> &#x3D;&gt; &#x3D;&gt; naming to docker.io&#x2F;library&#x2F;tcpdump                                                                         0.0s</span><br></pre></td></tr></table></figure><p>镜像列表：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  traceroute docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">tcpdump      latest    d5d8942d4836   3 minutes ago    109MB</span><br><span class="line">traceroute   latest    bbf499e59136   35 minutes ago   77.4MB</span><br><span class="line">ubuntu       latest    9873176a8ff5   11 days ago      72.7MB</span><br></pre></td></tr></table></figure><p>启动traceroute容器：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜ docker run -it --name traceroute traceroute</span><br><span class="line">root@fbe3eb98ae63:/#</span><br></pre></td></tr></table></figure><p>启动tcpdump容器，进行抓包：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ docker run -it --net=container:traceroute tcpdump</span><br><span class="line">tcpdump: listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br></pre></td></tr></table></figure><p>在traceroute容器发起traceroute：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@fbe3eb98ae63:/# traceroute -A -q 1 -N 1 -z 500 -e 8.8.8.8</span><br><span class="line">traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets</span><br><span class="line"> 1  localhost (172.17.0.1) [*]  0.129 ms</span><br><span class="line"> 2  localhost (10.39.101.1) [*]  3.716 ms</span><br><span class="line"> 3  localhost (192.168.1.1) [*]  3.926 ms</span><br><span class="line"> 4  222.129.32.1 (222.129.32.1) [AS4808]  6.837 ms</span><br><span class="line"> 5  61.148.163.181 (61.148.163.181) [AS4808]  9.247 ms</span><br><span class="line"> 6  219.232.11.65 (219.232.11.65) [AS17431]  7.049 ms</span><br><span class="line"> 7  61.149.203.205 (61.149.203.205) [AS4808]  7.650 ms</span><br><span class="line"> 8  219.158.7.22 (219.158.7.22) [AS4837]  40.815 ms</span><br><span class="line"> 9  219.158.103.218 (219.158.103.218) [AS4837]  64.771 ms</span><br><span class="line">10  219.158.103.30 (219.158.103.30) [AS4837]  50.402 ms</span><br><span class="line">11  219.158.10.30 (219.158.10.30) [AS4837]  53.261 ms</span><br><span class="line">12  219.158.33.174 (219.158.33.174) [AS4837]  55.503 ms</span><br><span class="line">13  108.170.241.65 (108.170.241.65) [AS15169]  54.876 ms</span><br><span class="line">14  142.251.64.173 (142.251.64.173) [AS15169]  45.966 ms</span><br><span class="line">15  dns.google (8.8.8.8) [AS15169]  52.492 ms</span><br></pre></td></tr></table></figure><p><strong>traceroute -A -q 1 -N 1 -z 500 -e 8.8.8.8</strong> 参数解释如下：</p><ul><li>-A：     向radb.net查找对应节点IP所在的AS Path信息，并将查询信息输出</li><li>-q 1：  将缺省发送3个探测包改为1个</li><li>-N 1： 将并发16个探测改为一次一个，以便于逐个分析</li><li>-z 500： 表示每次等待500毫秒再发出下一个探测</li><li>-e：    显示ICMP的扩展消息，如果有的话</li></ul><p>按下CTRL+C，停止tcpdump容器的抓包：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ docker run -it --net=container:traceroute tcpdump</span><br><span class="line">tcpdump: listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">^C237 packets captured</span><br><span class="line">237 packets received by filter</span><br><span class="line">0 packets dropped by kernel</span><br></pre></td></tr></table></figure><p>该容器在抓完包后自动停止，并将抓包文件存储在容器内部的/var/traceroute-ubuntu.pcapng，通过<strong>docker cp</strong>命令将抓包文件拷贝出来。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ docker ps -a</span><br><span class="line">CONTAINER ID   IMAGE        COMMAND                  CREATED          STATUS                        PORTS     NAMES</span><br><span class="line">f397f50267ae   tcpdump      &quot;/bin/sh -c &#x27;tcpdump…&quot;   2 minutes ago    Exited (130) 20 seconds ago             condescending_cori</span><br><span class="line">fbe3eb98ae63   traceroute   &quot;bash&quot;                   48 minutes ago   Up 48 minutes                           traceroute</span><br><span class="line">➜  ~ docker cp f397f50267ae:/var/traceroute-ubuntu.pcapng ./</span><br></pre></td></tr></table></figure><h1 id="简略分析抓包文件"><a href="#简略分析抓包文件" class="headerlink" title="简略分析抓包文件"></a>简略分析抓包文件</h1><p>以下是本次抓取的237个报文的头36个报文，如下：</p><img src="/docker-traceroute-tcpdump/docker-packet1-36.png" class="" title="docker-packet1-36"><p>上图中，Wireshare直接分析出来Whois报文。</p><p>过程概述如下：</p><ol><li>向8.8.8.8发起UDP报文，目的端口为<strong>33434</strong>，TTL设置为1</li><li>收到路由器的ICMP TTL超时消息，获取路由器对应的IP地址</li><li>尝试向DNS服务器查询路由器IP地址的反向域名解析，如果得到域名，就将其显示在Traceroute的输出结果中。</li><li>发起DNS查询，查询<strong>whois.radb.net</strong>域名，得到应答为198.108.0.18</li><li>发起TCP连接请求，与198.108.0.18建立TCP连接。</li><li>向<strong>whois.radb.net</strong>发起查询，询问路由器IP地址对应的AS号，并得到回应，如果是私有地址，其AS号为0。</li><li>重复上述第1、2、3、6步，每次将TTL加1，直至目标地址接收到探测报文，并返回ICMP Port Unreachable消息。</li></ol><p><a href="docker-traceroute-tcpdump/traceroute-ubuntu.pcapng">抓包文件下载</a></p><h1 id="番外篇"><a href="#番外篇" class="headerlink" title="番外篇"></a>番外篇</h1><p>ThousandEyes的介绍可参考这篇文章<a href="https://weiborao.github.io/deploy-thousandeyes-agent-on-aws.html">《在AWS上部署TE Agent并进行测试》</a>。</p><p>ThousandEyes可将探针部署到容器中，而且安装十分简单，从ThousandEyes的Cloud &amp; Enterprise Agents中，选择Agent Settings，再选择Enterprise Agents，再点击Add New Enterprise Agent，切换到Docker这个TAB。</p><img src="/docker-traceroute-tcpdump/te-agent-docker.png" class="" title="te-agent-docker"><p>将下面的文字复制粘贴到Terminal终端：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">docker pull thousandeyes/enterprise-agent &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">docker stop &#x27;TEagent&#x27; &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">docker rm &#x27;TEagent&#x27; &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">docker run \</span><br><span class="line">  --hostname=&#x27;TEagent&#x27; \</span><br><span class="line">  --memory=2g \</span><br><span class="line">  --memory-swap=2g \</span><br><span class="line">  --detach=true \</span><br><span class="line">  --tty=true \</span><br><span class="line">  --shm-size=512M \</span><br><span class="line">  -e TEAGENT_ACCOUNT_TOKEN=lje1co39qi       8b5oviy \</span><br><span class="line">  -e TEAGENT_INET=4 \</span><br><span class="line">  -v &#x27;/Users/werao/thousandeyes/TEagent/te-agent&#x27;:/var/lib/te-agent \</span><br><span class="line">  -v &#x27;/Users/werao/thousandeyes/TEagent/te-browserbot&#x27;:/var/lib/te-browserbot \</span><br><span class="line">  -v &#x27;/Users/werao/thousandeyes/TEagent/log/&#x27;:/var/log/agent \</span><br><span class="line">  --cap-add=NET_ADMIN \</span><br><span class="line">  --cap-add=SYS_ADMIN \</span><br><span class="line">  --name &#x27;TEagent&#x27; \</span><br><span class="line">  --restart=unless-stopped \</span><br><span class="line">  thousandeyes/enterprise-agent /sbin/my_init</span><br></pre></td></tr></table></figure><p>安装完后，ThousandEyes即可使用该Agent进行测试了。</p><p>创建一个简单的探测如下：</p><img src="/docker-traceroute-tcpdump/probe-anycast-dns.png" class="" title="probe-anycast-dns"><p>在ThousandEyes的界面，可观测上述的探测结果：</p><p>时延比较稳定，维持在50ms左右。</p><img src="/docker-traceroute-tcpdump/thousandeyes-path.png" class="" title="thousandeyes-path"><p>路径可视化分析中，当我们把鼠标落在某个节点上，网页会弹出交互式的信息，包括：</p><ul><li>网络前缀信息，如：124.65.192.0/18</li><li>运营商AS信息，如：CNCGROUP Beijing Province (AS 4808)</li><li>地理位置，如：Beijing, Beijing, China</li><li>DSCP</li><li>平均时延，指从探测的Agent到对应节点的平均时延</li></ul><img src="/docker-traceroute-tcpdump/thousandeyes-path-node1.png" class="" title="thousandeyes-path-node1"><img src="/docker-traceroute-tcpdump/thousandeyes-path-node2.png" class="" title="thousandeyes-path-node2"><img src="/docker-traceroute-tcpdump/thousandeyes-path-node3.png" class="" title="thousandeyes-path-node3"><p>ThousandEyes的探针所收集的数据是常规的网络工具都能收集到的，ThousandEyes的平台对收集到的数据进行存储、分析、交叉关联，为用户的数字体验提供全方位的洞见。</p><p>本节是突发奇想的内容，故而放到番外篇。</p><p>全文完。</p>]]></content>
    
    
    <summary type="html">本文记录了在一个纯净的容器环境下进行抓包分析Traceroute的过程；通过番外篇介绍ThousandEyes的探针在容器中安装部署，并展示路径可视化分析的效果。</summary>
    
    
    
    
    <category term="traceroute" scheme="https://weiborao.link/tags/traceroute/"/>
    
    <category term="docker" scheme="https://weiborao.link/tags/docker/"/>
    
    <category term="tcpdump" scheme="https://weiborao.link/tags/tcpdump/"/>
    
  </entry>
  
  <entry>
    <title>通过Wireshark重新认识Traceroute</title>
    <link href="https://weiborao.link/get-known-traceroute-by-wireshark.html"/>
    <id>https://weiborao.link/get-known-traceroute-by-wireshark.html</id>
    <published>2021-06-27T06:50:00.000Z</published>
    <updated>2021-06-28T06:15:06.568Z</updated>
    
    <content type="html"><![CDATA[<h1 id="初识Traceroute"><a href="#初识Traceroute" class="headerlink" title="初识Traceroute"></a>初识Traceroute</h1><p>Traceroute是一种常见的网络分析工具，用于探测数据包从源地址到目的地址经过的路由器的IP地址。</p><p>以下的示例显示从一个MAC电脑到8.8.8.8的路径探测结果：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ traceroute 8.8.8.8</span><br><span class="line">traceroute to 8.8.8.8 (8.8.8.8), 64 hops max, 52 byte packets</span><br><span class="line"> 1  localhost (10.39.101.1)  8.662 ms  1.307 ms  1.155 ms</span><br><span class="line"> 2  localhost (192.168.1.1)  2.287 ms  2.157 ms  1.897 ms</span><br><span class="line"> 3  222.129.32.1 (222.129.32.1)  5.844 ms  13.092 ms  10.332 ms</span><br><span class="line"> 4  114.244.95.105 (114.244.95.105)  7.541 ms</span><br><span class="line">    61.51.101.101 (61.51.101.101)  7.420 ms</span><br><span class="line">    61.148.163.81 (61.148.163.81)  7.075 ms</span><br><span class="line"> 5  61.148.4.213 (61.148.4.213)  7.759 ms</span><br><span class="line">    219.232.11.65 (219.232.11.65)  5.976 ms</span><br><span class="line">    bt-230-081.bta.net.cn (202.106.230.81)  6.021 ms</span><br><span class="line"> 6  202.96.12.13 (202.96.12.13)  7.828 ms * *</span><br><span class="line"> 7  219.158.112.26 (219.158.112.26)  39.486 ms *</span><br><span class="line">    219.158.7.22 (219.158.7.22)  45.959 ms</span><br><span class="line"> 8  219.158.103.218 (219.158.103.218)  48.469 ms</span><br><span class="line">    219.158.97.2 (219.158.97.2)  47.146 ms</span><br><span class="line">    219.158.103.218 (219.158.103.218)  50.320 ms</span><br><span class="line"> 9  219.158.103.30 (219.158.103.30)  50.739 ms  50.382 ms  48.348 ms</span><br><span class="line">10  219.158.10.30 (219.158.10.30)  49.927 ms  44.264 ms  56.353 ms</span><br><span class="line">11  219.158.33.174 (219.158.33.174)  54.123 ms  61.131 ms  47.302 ms</span><br><span class="line">12  108.170.241.97 (108.170.241.97)  56.082 ms</span><br><span class="line">    108.170.241.33 (108.170.241.33)  52.942 ms  54.393 ms</span><br><span class="line">13  142.250.58.189 (142.250.58.189)  48.958 ms</span><br><span class="line">    209.85.143.37 (209.85.143.37)  51.217 ms</span><br><span class="line">    108.170.226.115 (108.170.226.115)  141.544 ms</span><br><span class="line">14  dns.google (8.8.8.8)  48.935 ms  46.364 ms  51.043 ms</span><br><span class="line"></span><br><span class="line">➜  ~ ping 8.8.8.8</span><br><span class="line">PING 8.8.8.8 (8.8.8.8): 56 data bytes</span><br><span class="line">64 bytes from 8.8.8.8: icmp_seq=0 ttl=113 time=52.060 ms</span><br><span class="line">64 bytes from 8.8.8.8: icmp_seq=1 ttl=113 time=44.845 ms</span><br><span class="line">64 bytes from 8.8.8.8: icmp_seq=2 ttl=113 time=52.393 ms</span><br><span class="line">64 bytes from 8.8.8.8: icmp_seq=3 ttl=113 time=51.059 ms</span><br><span class="line">64 bytes from 8.8.8.8: icmp_seq=4 ttl=113 time=44.437 ms</span><br><span class="line">64 bytes from 8.8.8.8: icmp_seq=5 ttl=113 time=44.534 ms</span><br><span class="line">^C</span><br><span class="line">--- 8.8.8.8 ping statistics ---</span><br><span class="line">6 packets transmitted, 6 packets received, 0.0% packet loss</span><br><span class="line">round-trip min/avg/max/stddev = 44.437/48.221/52.393/3.640 ms</span><br></pre></td></tr></table></figure><p>输出结果表明：</p><ol><li>从MAC电脑到8.8.8.8的路径包含14个网络节点。</li><li>每个节点后面都显示时延信息，表明从MAC电脑到该节点的往返时延。您可能会发现，中间的某些节点往返时延可能要高于更远的节点的往返时延。这是由于该时延包含了路由器将TTL=0的报文交给控制面处理的时延，因而往往比路径上的传播时延要高，尤其是当控制面CPU繁忙时。Traceroute对每一个节点发出3个探测报文，每个报文的路径不尽相同，例如在第4、5、7、8、12、13跳经过不同的路由器转发。</li><li>有的探测没有得到回应，因此在有的节点本应显示时延信息的，显示了*。这并不能断定中间的网络不可达，很可能的原因是该节点的路由器在接口上配置了 <strong><em>no ip unreachable</em></strong> 命令，该接口不回应ICMP Unreachable消息，而该消息正是Traceroute探测路径所依赖的信息来源。</li></ol><p>接下来，我们简要描述一下，在MAC电脑下，Traceroute的工作原理，并使用Wireshark进一步的探究Traceroute的工作过程。</p><h1 id="Traceroute的工作原理"><a href="#Traceroute的工作原理" class="headerlink" title="Traceroute的工作原理"></a>Traceroute的工作原理</h1><p>每当IP数据包经过一个路由器，其存活时间TTL就会减1。当其存活时间是0时，主机便取消数据包，并发送一个ICMP TTL超时数据包给原数据包的发出者。Traceroute程序通过向目的地址发送一系列的探测包，设置探测包的TTL初始值分别为1,2,3…，根据返回的超时通知（ICMP Time Exceeded Message）得到源地址与目的地址之间的每一跳路由信息。</p><img src="/get-known-traceroute-by-wireshark/Traceroute-work.png" class="" title="Traceroute 的工作原理"><ol><li><p>从源地址发出一个UDP探测包到目的地址，并将TTL设置为1；</p></li><li><p>到达路由器时，将TTL减1；</p></li><li><p>当TTL变为0时，包被丢弃，路由器向源地址发回一个ICMP超时通知（ICMP Time Exceeded Message），内含发送IP包的源地址，IP包的所有内容及路由器的IP地址；</p></li><li><p>当源地址收到该ICMP包时，显示这一跳路由信息；</p></li><li><p>重复1～5，并每次设置TTL加1；</p></li><li><p>直至目标地址收到探测数据包，并返回端口不可达通知（ICMP Port Unreachable）；</p></li><li><p>当源地址收到ICMP Port Unreachable包时停止traceroute。</p></li></ol><p>以上内容引自<a href="https://blog.csdn.net/shb_derek1/article/details/100097050">Traceroute/tracert原理和实践</a></p><h1 id="通过Wireshark探究Traceroute"><a href="#通过Wireshark探究Traceroute" class="headerlink" title="通过Wireshark探究Traceroute"></a>通过Wireshark探究Traceroute</h1><h2 id="在Traceroute输出结果中显示AS号"><a href="#在Traceroute输出结果中显示AS号" class="headerlink" title="在Traceroute输出结果中显示AS号"></a>在Traceroute输出结果中显示AS号</h2><p>在Mac电脑的Traceroute命令中，通过’-a’的参数可以开启路径中遇到的IP地址所在的BGP AS号，以便于获知路径中每一跳所归属的运营商，通过’-q 1’可将缺省发送3个探测报文改为发送1个探测报文，输出示例如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ traceroute -aq 1 8.8.8.8</span><br><span class="line">traceroute to 8.8.8.8 (8.8.8.8), 64 hops max, 52 byte packets</span><br><span class="line"> 1  [AS0] bogon (10.39.101.1)  2.424 ms</span><br><span class="line"> 2  [AS0] localhost (192.168.1.1)  3.031 ms</span><br><span class="line"> 3  [AS4808] 222.129.32.1 (222.129.32.1)  6.496 ms</span><br><span class="line"> 4  [AS4808] 61.51.101.101 (61.51.101.101)  8.114 ms</span><br><span class="line"> 5  [AS17431] 219.232.11.29 (219.232.11.29)  5.865 ms</span><br><span class="line"> 6  [AS4808] 202.96.12.13 (202.96.12.13)  6.558 ms</span><br><span class="line"> 7  [AS4837] 219.158.112.46 (219.158.112.46)  44.826 ms</span><br><span class="line"> 8  [AS4837] 219.158.103.218 (219.158.103.218)  52.181 ms</span><br><span class="line"> 9  [AS4837] 219.158.103.30 (219.158.103.30)  47.851 ms</span><br><span class="line">10  [AS4837] 219.158.10.30 (219.158.10.30)  56.963 ms</span><br><span class="line">11  [AS4837] 219.158.33.174 (219.158.33.174)  46.523 ms</span><br><span class="line">12  [AS15169] 108.170.241.1 (108.170.241.1)  48.503 ms</span><br><span class="line">13  [AS15169] 172.253.64.111 (172.253.64.111)  142.926 ms</span><br><span class="line">14  [AS15169] dns.google (8.8.8.8)  52.208 ms</span><br></pre></td></tr></table></figure><p>上述的AS编号信息是如何获得的？下面我们通过Wireshark抓取报文进行分析。</p><h2 id="上述Traceroute的收发包过程简述"><a href="#上述Traceroute的收发包过程简述" class="headerlink" title="上述Traceroute的收发包过程简述"></a>上述Traceroute的收发包过程简述</h2><p>开启Wireshark，并迅速执行<strong>traceroute -aq 1 8.8.8.8</strong>，Traceroute完整输出后，停止Wireshark的报文抓取。<br>针对抓取的报文进行过滤，在过滤框中输入 <strong>udp or icmp or ip.addr == 198.108.0.18</strong><br>经过Wireshark的报文分析，以下为Traceroute的简要的收发包过程：</p><ol><li>发起DNS查询，查询<strong>whois.radb.net</strong>域名，得到应答为198.108.0.18—-上述过滤器中IP地址来源于此。</li><li>发起TCP连接请求，与198.108.0.18建立TCP连接。</li><li>向8.8.8.8发起UDP报文，目的端口为33435，TTL设置为1</li><li>收到路由器的ICMP TTL超时消息，获取路由器对应的IP地址</li><li>向<strong>whois.radb.net</strong>发起查询，询问路由器IP地址对应的AS号，并得到回应，如果是私有地址，其AS号为0。</li><li>尝试向DNS服务器查询路由器IP地址的反向域名解析，如果得到域名，就将其显示在Traceroute的输出结果中。</li><li>重复上述第3~6步，每次将TTL加1，直至目标地址接收到探测报文，并返回ICMP Port Unreachable消息。</li></ol><h2 id="Wireshark抓包详细分析"><a href="#Wireshark抓包详细分析" class="headerlink" title="Wireshark抓包详细分析"></a>Wireshark抓包详细分析</h2><p>下图为Wireshark抓取的报文的前36个：<img src="/get-known-traceroute-by-wireshark/packet1-36.png" class="" title="packet1-36"></p><ol><li><p>第1和第2个报文为DNS查询，查询whois.radb.net的地址为198.108.0.18。</p></li><li><p>第3~5的报文为TCP三次握手，并成功建立TCP 连接10.39.101.141:51705&lt;—&gt;198.108.0.18:43，TCP 43端口通常是whois server的端口。</p></li><li><p>第6个报文由10.39.101.141发向198.108.0.18，并将PSH置位，请求接收端一收到就进行向上交付，以缩短Traceroute的等待时间。</p></li><li><p>第7个报文发出第一个UDP的探测报文，目标端口号为33435，TTL=1，具体如下：</p><img src="/get-known-traceroute-by-wireshark/UDP-Probe-1.png" class="" title="UDP-Probe-1"></li><li><p>第8个报文为网关回复的ICMP Time-to-live exceeded (Time to live exceeded in transit)报文，Traceroute从IP报文中的源地址获取路由器的IP地址10.39.101.1。该报文包含原始的UDP报文信息，具体如下：</p><img src="/get-known-traceroute-by-wireshark/ICMP-Reply-1.png" class="" title="ICMP-Reply-1"></li><li><p>第9个报文为第6个报文的TCP确认报文，第10个报文为向whois.radb.net查询网关10.39.101.1/32所在的AS号。第11个报文为第10个报文的TCP确认，第12个报文答复查询结果，由于该地址为私有IP地址段，没有查询到结果，因此Traceroute 将AS号显示为[AS0]。以下使用第29和30报文，用于展示AS号查询的报文，如下：</p><img src="/get-known-traceroute-by-wireshark/AS-query-1.png" class="" title="AS-query-1"><img src="/get-known-traceroute-by-wireshark/AS-reply-1.png" class="" title="AS-reply-1"><p>查询结果的文本内容如下：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">route:      222.129.0.0/18</span><br><span class="line">descr:      CMI  (Customer Route)</span><br><span class="line">origin:     AS4808</span><br><span class="line">mnt-by:     MAINT-AS58453</span><br><span class="line">changed:    qas_support@cmi.chinamobile.com 20160525</span><br><span class="line">source:     RADB</span><br><span class="line"></span><br><span class="line">route:          222.128.0.0/14</span><br><span class="line">descr:          China Unicom Beijing Province Network</span><br><span class="line">country:        CN</span><br><span class="line">origin:         AS4808</span><br><span class="line">mnt-by:         MAINT-CNCGROUP-RR</span><br><span class="line">changed:        abuse@cnc-noc.net 20160516</span><br><span class="line">source:         APNIC</span><br><span class="line"></span><br><span class="line">route:      222.129.0.0/18</span><br><span class="line">descr:      CMI IP Transit</span><br><span class="line">origin:     AS4808</span><br><span class="line">admin-c:    MAINT-CMI-INT-HK</span><br><span class="line">tech-c:     MAINT-CMI-INT-HK</span><br><span class="line">mnt-by:     MAINT-CMI-INT-HK</span><br><span class="line">changed:    qas_support@cmi.chinamobile.com 20160525</span><br><span class="line">source:     NTTCOM</span><br></pre></td></tr></table></figure></li><li><p>第14~17报文是DNS解析报文，分别对主机名WERAO-M-40KA进行域名解析，以及对网关IP 10.39.101.1进行反向域名解析，由于是私有主机名和私有地址，自然公网DNS是解析不出来。以下将针对8.8.8.8进行反向域名解析为dns.google的截图作为示例：</p><img src="/get-known-traceroute-by-wireshark/dns-query-1.png" class="" title="dns-query-1"></li><li><p>报文18~26重复报文7~17的过程，其中报文18的TTL为2，如下：</p><img src="/get-known-traceroute-by-wireshark/UDP-Probe-2.png" class="" title="UDP-Probe-2"><p>过程持续至8.8.8.8返回Code: 3 (Port unreachable)的消息，并对8.8.8.8进行反向域名解析。</p><img src="/get-known-traceroute-by-wireshark/ICMP-last-reply.png" class="" title="ICMP-last-reply"></li></ol><p>以上详细的分析了<strong>traceroute -aq 1 8.8.8.8</strong>的报文收发过程。</p><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>在上述的Traceroute完成输出后，Wireshark成功的将Whois的交互报文进行重新组装，并完成内容的解析。</p><p>在Wireshark分析完第133个报文后，Wireshark成功的组装出whois的查询报文，如下：</p><img src="/get-known-traceroute-by-wireshark/whois-query.png" class="" title="whois-query"><p>在Wireshark分析完第135个报文后，Wireshark成功的组装出Whois的应答报文，如下：</p><img src="/get-known-traceroute-by-wireshark/whois-answer.png" class="" title="whois-answer"><p>在Terminal执行whois 8.8.8.8/32，并进行报文抓取，解析出Whois的报文应答如下：</p><img src="/get-known-traceroute-by-wireshark/whois-answer-2.png" class="" title="whois-answer-2"><p>该报文也是Wireshark 拼装了多个TCP Segment，#101、#103、#104、#106、#109后解析出来的。对比该解析结果和上文中，Traceroute过程中的查询结果，可以发现，报文结构是一致的，都被Wireshark解析成Whois的报文。</p><p>据此，我推测，MAC电脑上的Traceroute 在增加了-a的参数后，会主动发起Whois查询，缺省的Whois服务器是whois.radb.net。</p><p>此部分内容是在Traceroute收发包过程分析完成后，再后知后觉发现的，因此将此部分内容作为“后记”进行记录。</p><h1 id="Traceroute-进阶版工具MTR"><a href="#Traceroute-进阶版工具MTR" class="headerlink" title="Traceroute 进阶版工具MTR"></a>Traceroute 进阶版工具MTR</h1><p>MTR （My Traceroute）工具将ping和traceroute命令的功能并入了同一个工具中，实现更强大的功能。相对于traceroute命令只会做一次链路跟踪测试，mtr命令会对链路上的相关节点做持续探测并给出相应的统计信息。</p><p>如下为MTR的输出：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ sudo mtr -ry 4 8.8.8.8</span><br><span class="line">Start: 2021-06-27T23:37:21+0800</span><br><span class="line">HOST: WERAO-M-40KA                Loss%   Snt   Last   Avg  Best  Wrst StDev</span><br><span class="line">  1. ???        localhost          0.0%    10    1.8   2.2   1.2  10.1   2.8</span><br><span class="line">  2. ???        bogon              0.0%    10    2.2   2.3   1.9   3.3   0.5</span><br><span class="line">  3. 2003-11-19 222.129.32.1       0.0%    10    6.3   9.5   5.0  29.2   7.7</span><br><span class="line">  4. 2000-03-14 61.148.163.181     0.0%    10    5.3   7.4   5.3   8.7   1.2</span><br><span class="line">  5. 2002-04-17 219.232.11.65     70.0%    10    5.4   6.1   5.4   6.8   0.7</span><br><span class="line">  6. 2006-01-09 124.65.194.153    30.0%    10   28.9   9.6   5.7  28.9   8.5</span><br><span class="line">  7. 2002-03-21 219.158.112.26    40.0%    10   38.9  44.2  38.5  63.7   9.7</span><br><span class="line">  8. 2002-03-21 219.158.19.66      0.0%    10   74.4  64.1  46.4  74.4   8.8</span><br><span class="line">  9. 2002-03-21 219.158.97.25      0.0%    10   90.8  90.8  82.2  96.7   4.3</span><br><span class="line"> 10. 2002-03-21 219.158.20.94      0.0%    10   97.5  89.8  74.1 104.6  11.8</span><br><span class="line"> 11. 2002-03-21 219.158.33.174     0.0%    10   73.0  62.1  49.7  74.0   8.5</span><br><span class="line"> 12. 2012-02-07 108.170.241.65     0.0%    10   59.0  67.3  53.1  75.4   7.2</span><br><span class="line"> 13. 2013-04-04 172.253.69.229    10.0%    10   62.9  68.3  54.5  76.6   6.5</span><br><span class="line"> 14. 1992-12-01 dns.google         0.0%    10   71.0  65.6  56.4  71.0   5.7</span><br></pre></td></tr></table></figure><p>MTR命令，通过-r 输出报告，-z 可输出地址所在的AS号，-y 4 可输出该地址的分配时间。</p><p>输出信息解释如下：</p><ul><li>第一列（Host）：节点IP地址和域名。</li><li>第二列（Loss%）：节点丢包率。</li><li>第三列（Snt）：发送的Ping包数。默认值是10，可以通过参数“-c”指定。</li><li>第四列（Last）：最近一次的探测延迟值。</li><li>第五、六、七列（Avg、Best、Wrst）：分别是探测延迟的平均值、最小值和最大值。</li><li>第八列（StDev）：标准偏差。越大说明相应节点越不稳定。</li></ul><p>上述解释引用自：<a href="https://help.aliyun.com/knowledge_detail/98706.html">MTR工具使用说明与结果分析</a>，略有改动。</p><h1 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h1><ol><li><p>David Tian:  赞，请教下，为什么ipv4的traceroute 会触发用ipv6去查dns呢？</p><p>答：好眼力，好问题~~实际上，我抓取的报文中，每次得到ICMP报文后，Traceroute也会向208.67.222.222发送DNS请求。但是报文是加密的，看不出是什么内容，不能猜测，所以我将这些不确定的报文删除了。208.67.222.222是OpenDNS的DNS服务器，这是Cisco IT设置的DNS服务器。😄</p></li></ol><h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><p>以下是Wireshark抓包文件的前60个报文的概览。</p><table><thead><tr><th>No.</th><th>Source</th><th>Destination</th><th>Protocol</th><th>Info</th></tr></thead><tbody><tr><td>1</td><td>fe80::1c7a:24fd:c837:3017</td><td>fe80::1</td><td>DNS</td><td>Standard query 0xc7d5 A whois.radb.net</td></tr><tr><td>2</td><td>fe80::1</td><td>fe80::1c7a:24fd:c837:3017</td><td>DNS</td><td>Standard query response 0xc7d5 A whois.radb.net A 198.108.0.18</td></tr><tr><td>3</td><td>10.39.101.141</td><td>198.108.0.18</td><td>TCP</td><td>51705 → 43 [SYN] Seq=0 Win=65535 Len=0 MSS=1460 WS=64 TSval=2785245374  TSecr=0 SACK_PERM=1</td></tr><tr><td>4</td><td>198.108.0.18</td><td>10.39.101.141</td><td>TCP</td><td>43 → 51705 [SYN, ACK] Seq=0 Ack=1 Win=28960 Len=0 MSS=1412  TSval=3642352050 TSecr=2785245374 WS=256</td></tr><tr><td>5</td><td>10.39.101.141</td><td>198.108.0.18</td><td>TCP</td><td>51705 → 43 [ACK] Seq=1 Ack=1 Win=131584 Len=0 TSval=2785245692  TSecr=3642352050</td></tr><tr><td>6</td><td>10.39.101.141</td><td>198.108.0.18</td><td>TCP</td><td>51705 → 43 [PSH, ACK] Seq=1 Ack=1 Win=131584 Len=3 TSval=2785245692  TSecr=3642352050 [TCP segment of a reassembled PDU]</td></tr><tr><td>7</td><td>10.39.101.141</td><td>8.8.8.8</td><td>UDP</td><td>36904 → 33435 Len=24</td></tr><tr><td>8</td><td>10.39.101.1</td><td>10.39.101.141</td><td>ICMP</td><td>Time-to-live exceeded (Time to live exceeded in transit)</td></tr><tr><td>9</td><td>198.108.0.18</td><td>10.39.101.141</td><td>TCP</td><td>43 → 51705 [ACK] Seq=1 Ack=4 Win=29184 Len=0 TSval=3642352370  TSecr=2785245692</td></tr><tr><td>10</td><td>10.39.101.141</td><td>198.108.0.18</td><td>TCP</td><td>51705 → 43 [PSH, ACK] Seq=4 Ack=1 Win=131584 Len=19 TSval=2785246039  TSecr=3642352370 [TCP segment of a reassembled PDU]</td></tr><tr><td>11</td><td>198.108.0.18</td><td>10.39.101.141</td><td>TCP</td><td>43 → 51705 [ACK] Seq=1 Ack=23 Win=29184 Len=0 TSval=3642352717  TSecr=2785246039</td></tr><tr><td>12</td><td>198.108.0.18</td><td>10.39.101.141</td><td>TCP</td><td>43 → 51705 [PSH, ACK] Seq=1 Ack=23 Win=29184 Len=2 TSval=3642352717  TSecr=2785246039 [TCP segment of a reassembled PDU]</td></tr><tr><td>13</td><td>10.39.101.141</td><td>198.108.0.18</td><td>TCP</td><td>51705 → 43 [ACK] Seq=23 Ack=3 Win=131584 Len=0 TSval=2785246448  TSecr=3642352717</td></tr><tr><td>14</td><td>fe80::1c7a:24fd:c837:3017</td><td>fe80::1</td><td>DNS</td><td>Standard query 0x93fc A WERAO-M-40KA</td></tr><tr><td>15</td><td>fe80::1</td><td>fe80::1c7a:24fd:c837:3017</td><td>DNS</td><td>Standard query response 0x93fc No such name A WERAO-M-40KA</td></tr><tr><td>16</td><td>fe80::1c7a:24fd:c837:3017</td><td>fe80::1</td><td>DNS</td><td>Standard query 0xbcf9 PTR 1.101.39.10.in-addr.arpa</td></tr><tr><td>17</td><td>fe80::1</td><td>fe80::1c7a:24fd:c837:3017</td><td>DNS</td><td>Standard query response 0xbcf9 PTR 1.101.39.10.in-addr.arpa PTR bogon</td></tr><tr><td>18</td><td>10.39.101.141</td><td>8.8.8.8</td><td>UDP</td><td>36904 → 33436 Len=24</td></tr><tr><td>19</td><td>192.168.1.1</td><td>10.39.101.141</td><td>ICMP</td><td>Time-to-live exceeded (Time to live exceeded in transit)</td></tr><tr><td>20</td><td>10.39.101.141</td><td>198.108.0.18</td><td>TCP</td><td>51705 → 43 [PSH, ACK] Seq=23 Ack=3 Win=131584 Len=19 TSval=2785248590  TSecr=3642352717 [TCP segment of a reassembled PDU]</td></tr><tr><td>21</td><td>10.39.101.141</td><td>10.39.101.1</td><td>DNS</td><td>Standard query 0xc81a A WERAO-M-40KA</td></tr><tr><td>22</td><td>10.39.101.1</td><td>10.39.101.141</td><td>DNS</td><td>Standard query response 0xc81a A WERAO-M-40KA A 10.39.101.141</td></tr><tr><td>23</td><td>198.108.0.18</td><td>10.39.101.141</td><td>TCP</td><td>43 → 51705 [PSH, ACK] Seq=3 Ack=42 Win=29184 Len=2 TSval=3642355278  TSecr=2785248590 [TCP segment of a reassembled PDU]</td></tr><tr><td>24</td><td>10.39.101.141</td><td>198.108.0.18</td><td>TCP</td><td>51705 → 43 [ACK] Seq=42 Ack=5 Win=131584 Len=0 TSval=2785248902  TSecr=3642355278</td></tr><tr><td>25</td><td>fe80::1c7a:24fd:c837:3017</td><td>fe80::1</td><td>DNS</td><td>Standard query 0x7504 PTR 1.1.168.192.in-addr.arpa</td></tr><tr><td>26</td><td>fe80::1</td><td>fe80::1c7a:24fd:c837:3017</td><td>DNS</td><td>Standard query response 0x7504 PTR 1.1.168.192.in-addr.arpa PTR localhost</td></tr><tr><td>27</td><td>10.39.101.141</td><td>8.8.8.8</td><td>UDP</td><td>36904 → 33437 Len=24</td></tr><tr><td>28</td><td>222.129.32.1</td><td>10.39.101.141</td><td>ICMP</td><td>Time-to-live exceeded (Time to live exceeded in transit)</td></tr><tr><td>29</td><td>10.39.101.141</td><td>198.108.0.18</td><td>TCP</td><td>51705 → 43 [PSH, ACK] Seq=42 Ack=5 Win=131584 Len=20 TSval=2785249974  TSecr=3642355278 [TCP segment of a reassembled PDU]</td></tr><tr><td>30</td><td>198.108.0.18</td><td>10.39.101.141</td><td>TCP</td><td>43 → 51705 [PSH, ACK] Seq=5 Ack=62 Win=29184 Len=643 TSval=3642356666  TSecr=2785249974 [TCP segment of a reassembled PDU]</td></tr><tr><td>31</td><td>10.39.101.141</td><td>198.108.0.18</td><td>TCP</td><td>51705 → 43 [ACK] Seq=62 Ack=648 Win=130944 Len=0 TSval=2785250324  TSecr=3642356666</td></tr><tr><td>32</td><td>fe80::1c7a:24fd:c837:3017</td><td>fe80::1</td><td>DNS</td><td>Standard query 0x4f56 PTR 1.32.129.222.in-addr.arpa</td></tr><tr><td>33</td><td>fe80::1</td><td>fe80::1c7a:24fd:c837:3017</td><td>DNS</td><td>Standard query response 0x4f56 No such name PTR 1.32.129.222.in-addr.arpa</td></tr><tr><td>34</td><td>10.39.101.141</td><td>8.8.8.8</td><td>UDP</td><td>36904 → 33438 Len=24</td></tr><tr><td>35</td><td>61.51.101.101</td><td>10.39.101.141</td><td>ICMP</td><td>Time-to-live exceeded (Time to live exceeded in transit)</td></tr><tr><td>36</td><td>10.39.101.141</td><td>198.108.0.18</td><td>TCP</td><td>51705 → 43 [PSH, ACK] Seq=62 Ack=648 Win=131072 Len=21 TSval=2785251389  TSecr=3642356666 [TCP segment of a reassembled PDU]</td></tr><tr><td>37</td><td>198.108.0.18</td><td>10.39.101.141</td><td>TCP</td><td>43 → 51705 [PSH, ACK] Seq=648 Ack=83 Win=29184 Len=639 TSval=3642358087  TSecr=2785251389 [TCP segment of a reassembled PDU]</td></tr><tr><td>38</td><td>10.39.101.141</td><td>198.108.0.18</td><td>TCP</td><td>51705 → 43 [ACK] Seq=83 Ack=1287 Win=130432 Len=0 TSval=2785251697  TSecr=3642358087</td></tr><tr><td>39</td><td>10.39.101.141</td><td>10.39.101.1</td><td>DNS</td><td>Standard query 0x521b PTR 1.32.129.222.in-addr.arpa</td></tr><tr><td>40</td><td>10.39.101.1</td><td>10.39.101.141</td><td>DNS</td><td>Standard query response 0x521b No such name PTR 1.32.129.222.in-addr.arpa</td></tr><tr><td>41</td><td>fe80::1c7a:24fd:c837:3017</td><td>fe80::1</td><td>DNS</td><td>Standard query 0x5931 PTR 101.101.51.61.in-addr.arpa</td></tr><tr><td>42</td><td>fe80::1</td><td>fe80::1c7a:24fd:c837:3017</td><td>DNS</td><td>Standard query response 0x5931 No such name PTR  101.101.51.61.in-addr.arpa</td></tr><tr><td>43</td><td>10.39.101.141</td><td>8.8.8.8</td><td>UDP</td><td>36904 → 33439 Len=24</td></tr><tr><td>44</td><td>219.232.11.29</td><td>10.39.101.141</td><td>ICMP</td><td>Time-to-live exceeded (Time to live exceeded in transit)</td></tr><tr><td>45</td><td>10.39.101.141</td><td>198.108.0.18</td><td>TCP</td><td>51705 → 43 [PSH, ACK] Seq=83 Ack=1287 Win=131072 Len=21 TSval=2785252732  TSecr=3642358087 [TCP segment of a reassembled PDU]</td></tr><tr><td>46</td><td>198.108.0.18</td><td>10.39.101.141</td><td>TCP</td><td>43 → 51705 [PSH, ACK] Seq=1287 Ack=104 Win=29184 Len=418 TSval=3642359437  TSecr=2785252732 [TCP segment of a reassembled PDU]</td></tr><tr><td>47</td><td>10.39.101.141</td><td>198.108.0.18</td><td>TCP</td><td>51705 → 43 [ACK] Seq=104 Ack=1705 Win=130624 Len=0 TSval=2785253042  TSecr=3642359437</td></tr><tr><td>48</td><td>fe80::1c7a:24fd:c837:3017</td><td>fe80::1</td><td>DNS</td><td>Standard query 0x7d09 PTR 29.11.232.219.in-addr.arpa</td></tr><tr><td>49</td><td>fe80::1</td><td>fe80::1c7a:24fd:c837:3017</td><td>DNS</td><td>Standard query response 0x7d09 No such name PTR  29.11.232.219.in-addr.arpa</td></tr><tr><td>50</td><td>10.39.101.141</td><td>8.8.8.8</td><td>UDP</td><td>36904 → 33440 Len=24</td></tr><tr><td>51</td><td>202.96.12.13</td><td>10.39.101.141</td><td>ICMP</td><td>Time-to-live exceeded (Time to live exceeded in transit)</td></tr><tr><td>52</td><td>10.39.101.141</td><td>198.108.0.18</td><td>TCP</td><td>51705 → 43 [PSH, ACK] Seq=104 Ack=1705 Win=131072 Len=20 TSval=2785254068  TSecr=3642359437 [TCP segment of a reassembled PDU]</td></tr><tr><td>53</td><td>10.39.101.141</td><td>10.39.101.1</td><td>DNS</td><td>Standard query 0x961b PTR 101.101.51.61.in-addr.arpa</td></tr><tr><td>54</td><td>10.39.101.1</td><td>10.39.101.141</td><td>DNS</td><td>Standard query response 0x961b No such name PTR  101.101.51.61.in-addr.arpa</td></tr><tr><td>55</td><td>198.108.0.18</td><td>10.39.101.141</td><td>TCP</td><td>43 → 51705 [PSH, ACK] Seq=1705 Ack=124 Win=29184 Len=642 TSval=3642360779  TSecr=2785254068 [TCP segment of a reassembled PDU]</td></tr><tr><td>56</td><td>10.39.101.141</td><td>198.108.0.18</td><td>TCP</td><td>51705 → 43 [ACK] Seq=124 Ack=2347 Win=130368 Len=0 TSval=2785254400  TSecr=3642360779</td></tr><tr><td>57</td><td>fe80::1c7a:24fd:c837:3017</td><td>fe80::1</td><td>DNS</td><td>Standard query 0xb016 PTR 13.12.96.202.in-addr.arpa</td></tr><tr><td>58</td><td>fe80::1</td><td>fe80::1c7a:24fd:c837:3017</td><td>DNS</td><td>Standard query response 0xb016 No such name PTR 13.12.96.202.in-addr.arpa  SOA beijing.cn.net</td></tr><tr><td>59</td><td>10.39.101.141</td><td>8.8.8.8</td><td>UDP</td><td>36904 → 33441 Len=24</td></tr><tr><td>60</td><td>219.158.112.46</td><td>10.39.101.141</td><td>ICMP</td><td>Time-to-live exceeded (Time to live exceeded in transit)</td></tr></tbody></table><p><a href="get-known-traceroute-by-wireshark/traceroute-google-dns.pcapng">抓包文件下载</a></p>]]></content>
    
    
    <summary type="html">本文对Traceroute的工作原理进行分析，介绍Traceroute在输出结果中显示AS号的功能参数，并通过Wireshark抓包分析MAC电脑上Traceroute的工作收发包过程，从而重新认识Traceroute；在此基础上，介绍Traceroute的进阶工具MTR。</summary>
    
    
    
    
    <category term="traceroute" scheme="https://weiborao.link/tags/traceroute/"/>
    
    <category term="wireshark" scheme="https://weiborao.link/tags/wireshark/"/>
    
  </entry>
  
  <entry>
    <title>在AWS上部署TE Agent并进行测试</title>
    <link href="https://weiborao.link/deploy-thousandeyes-agent-on-aws.html"/>
    <id>https://weiborao.link/deploy-thousandeyes-agent-on-aws.html</id>
    <published>2021-06-17T13:00:00.000Z</published>
    <updated>2021-06-17T13:06:53.306Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ThousandEyes-简介"><a href="#ThousandEyes-简介" class="headerlink" title="ThousandEyes 简介"></a>ThousandEyes 简介</h1><p><a href="https://www.thousandeyes.com/">ThousandEyes</a>是一个网络性能监控的SAAS云服务，结合了各种主动和被动的监控技术，让您深入了解您提供的以及您消费的应用和服务的用户体验。ThousandEyes使用的监控技术包括网络的可达性探测、时延、丢包、抖动、可视化的逐跳路径分析、可视化的BGP路由分析、DNS监控、HTTP服务监控等。ThousandEyes平台对这些监控收集而来的数据进行分析、交叉关联，将涉及用户体验的方方面面，包括网络和应用的状况统一的呈现在同一个界面之下，让您能够轻松的隔离问题，采取行动，从而快速的解决问题。</p><p>ThousandEyes提供了三种Agent进行网络和应用的探测，分别是Cloud Agent、Enterprise Agent和Endpoint Agent。Cloud Agent 由ThousandEyes在全球部署和维护，当前，ThousandEyes在全球200多个城市共部署了400多个<a href="https://www.thousandeyes.com/product/cloud-agents">Cloud Agent</a>，可供全球用户使用。Enterprise Agent由用户自己部署，可以部署为虚拟机或者容器，可以安装在物理硬件，如Intel NCU或者树莓派中，支持Windows、Linux系统，还可以部署在思科或Juniper的网络设备中，也能通过CloudFormation在AWS云中自动部署。Endpoint Agent是浏览器插件，用户在访问网站时，可以自助的使用Endpoint Agent进行测试，由ThousandEyes进行数据分析，从而帮助用户快速了解其数字体验，以及快速定位问题所在。用户可以根据自己的需要来选择一种或多种Agent进行探测，ThousandEyes平台会自动完成分析和展现，提供网络和应用状况的洞见分析。</p><h1 id="在AWS上部署TE-Agent"><a href="#在AWS上部署TE-Agent" class="headerlink" title="在AWS上部署TE Agent"></a>在AWS上部署TE Agent</h1><h2 id="了解部署过程"><a href="#了解部署过程" class="headerlink" title="了解部署过程"></a>了解部署过程</h2><p>在正式部署之前，快速阅读了一下<a href="https://docs.thousandeyes.com/product-documentation/global-vantage-points/enterprise-agents/installing/iaas-enterprise-agent-deployment-amazon-aws">AWS Deployment Guide</a>，部署过程是通过AWS的CloudFormation创建一个Stack，整个过程全部自动化。</p><p>部署的前提是需要设置好SSH Key-pair，VPC网络、公共子网、以及使用CloudFormation部署EC2的权限。</p><p>部署的内容包括：启动基于Ubuntu的EC2实例，并自动安装TE Agent，创建Security Group，并基于最小权限配置Inbound Rules。</p><h2 id="准备SSH-Key-pair"><a href="#准备SSH-Key-pair" class="headerlink" title="准备SSH Key-pair"></a>准备SSH Key-pair</h2><p>首先，在MAC电脑中，执行以下命令，用于创建一个RSA的秘钥对，并将公钥拷贝至桌面。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -b 4096 -f .ssh/aws_kp -m PEM</span><br><span class="line">mv .ssh/aws_kp .ssh/aws_kp.pem</span><br><span class="line">chmod 400 .ssh/aws_kp.pem</span><br><span class="line">cp .ssh/aws_kp.pub ~/Desktop</span><br></pre></td></tr></table></figure><p>登录AWS的Console管理界面后，选择Region，比如us-east-1，定位到EC2—Network Security—Key Pair，在界面右上侧的Actions下拉框中，选择Import key pair，将aws_kp.pub上传。</p><p>在其他的Region，重复上述动作，将key pair上传，这样在多个Region创建的EC2可以使用同一个私钥进行登录。</p><h2 id="在AWS上部署TE-Agent-1"><a href="#在AWS上部署TE-Agent-1" class="headerlink" title="在AWS上部署TE Agent"></a>在AWS上部署TE Agent</h2><p>部署TE Agent的操作路径为：在ThousandEyes的界面中，选择Cloud &amp; Enterprise Agents，再选择Agent Settings，进一步选择Enterprise Agents，点击Add New Enterprise Agent。在右侧出现的界面中，选择IaaS Marketplaces，在该界面中点击Launch in AWS，跳转到AWS的登录界面，并自动进入CloudFormation的界面，该界面已将Stack模板选择好了。</p><p>Stack模板的链接：</p><p><a href="https://s3-us-west-1.amazonaws.com/oneclick-ea.aws.thousandeyes/aws-ea-oneclick.yaml">https://s3-us-west-1.amazonaws.com/oneclick-ea.aws.thousandeyes/aws-ea-oneclick.yaml</a></p><p>该模板包含两个组件：EC2 Instance 和 Security Group。</p><p>按照上文的部署指南填写表单，并点击下一步，直至完成部署。</p><p>在完成安装后，可以使用私钥登录到虚机，注意：用户名为 ubuntu，不是ec2-user 或 root。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -i .ssh/aws_kp.pem -v [ubuntu@](mailto:ubuntu@18.141.230.240)x.x.x.x</span><br></pre></td></tr></table></figure><p>在两个不同的Region，us-east-1 和 ap-southeast-1 分别部署一个TE Agent。</p><p>大约5分钟后，即可在app.thousandeyes.com的界面中看到两个TE Agent上线。</p><h1 id="执行Agent-to-Agent-测试"><a href="#执行Agent-to-Agent-测试" class="headerlink" title="执行Agent to Agent 测试"></a>执行Agent to Agent 测试</h1><p>分别执行两种测试，一个是通过公网IP进行双向测试，一个是创建VPC Peering后，使用私有地址进行测试，比较两者之间的差异。</p><h2 id="通过公网IP地址进行双向测试"><a href="#通过公网IP地址进行双向测试" class="headerlink" title="通过公网IP地址进行双向测试"></a>通过公网IP地址进行双向测试</h2><p>在ThousandEyes的Agent Settings界面中，点击Agent，在右侧的网页中，选择Advanced Settings，将地址设置为Agent的公网IP地址。</p><p>在Test Settings中，选择Add New Test，Layer选择Network，Test Type选择Agent to Agent。</p><p>选择一个Agent作为Target，另一个Agent作为源，测试方向选择双向。</p><p>经过一段时间后，ThousandEyes上即可呈现测试结果。</p><p>测试持续了一个小时左右，测试结果如下：</p><p><strong>AWS us-east-1 to ap-southeast-1 Using Public IP</strong></p><table><thead><tr><th>Items</th><th>Result</th></tr></thead><tbody><tr><td>Loss</td><td>0%</td></tr><tr><td>Latency</td><td>212ms</td></tr><tr><td>Jitter</td><td>&lt;1ms</td></tr><tr><td>Throughput</td><td>55Mbps</td></tr></tbody></table><p>在可视化的路径分析图中，观察到如下信息：</p><ol><li>从us-east-1到ap-southeast-1往返，至少各有三条路径，每条路径显示的跳数约有20跳。</li><li>该测试每隔2分钟测试一次，共测试了25次。在这25次中，鲜有路径一致的，有时候全程没有公共节点，有时候两条、甚至三条路径中间有公共节点。</li><li>可视化路径中，从两侧的Agent出发，均有连续的5个或6个连续未知节点。这是由于这些节点不对Traceroute作出回应，导致路径中不可见。</li><li>在整个可视化路径中，可见的公网节点的IP地址属于<strong>AS 16509</strong>或者<strong>AS 14618</strong>，这两个都是AWS的BGP AS域。其他节点的地址为100.65.x.x或100.100.x.x，这段地址属于<strong>100.64.0.0/10</strong>，为IANA保留地址，用于给运营商使用。由此可以推断，两个Agent之间通讯的报文并未离开过AWS的网络，这也解释了为何上述的时延、抖动是很稳定的值，并且整个测试期间，没有丢包。</li><li>在可视化路径中，我还能发现有的路径是一段MPLS 隧道，并给出了转发时用到的Label值。ThousandEyes是如何发现路径中间有MPLS Tunnel呢？这个是值得仔细思考的问题。经查询，这是通过ThousandEyes的<a href="https://www.thousandeyes.com/pdf/ThousandEyes-Patents.pdf">专利技术Deep Path Analysis (DPA)</a>实现的。</li></ol><h2 id="通过私网IP地址进行双向测试"><a href="#通过私网IP地址进行双向测试" class="headerlink" title="通过私网IP地址进行双向测试"></a>通过私网IP地址进行双向测试</h2><p>本次测试的方法同上，只是需要将Agent的IP地址修改为使用私有IP地址，两个Region的VPC之间建立VPC Peering。</p><p>测试结果如下：</p><p><strong>AWS us-east-1 to ap-southeast-1 Using Private IP</strong></p><table><thead><tr><th>Items</th><th>Result</th></tr></thead><tbody><tr><td>Loss</td><td>0%</td></tr><tr><td>Latency</td><td>212ms</td></tr><tr><td>Jitter</td><td>&lt;1ms</td></tr><tr><td>Throughput</td><td>56Mbps</td></tr></tbody></table><p>在可视化的路径分析图中，观察到如下信息：</p><ul><li>两个Agent之间是直连的，没有任何中间节点，两者之间时延为211ms。</li></ul><p>做完两次测试，第二天检查了一下AWS的账单，预计花费了0.29美金。</p><h2 id="测试结果的共享链接"><a href="#测试结果的共享链接" class="headerlink" title="测试结果的共享链接"></a>测试结果的共享链接</h2><p><a href="https://zwskwtsea.share.thousandeyes.com/">https://zwskwtsea.share.thousandeyes.com/</a></p><p><a href="https://aieajezsh.share.thousandeyes.com/">https://aieajezsh.share.thousandeyes.com/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ThousandEyes-简介&quot;&gt;&lt;a href=&quot;#ThousandEyes-简介&quot; class=&quot;headerlink&quot; title=&quot;ThousandEyes 简介&quot;&gt;&lt;/a&gt;ThousandEyes 简介&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://w</summary>
      
    
    
    
    
    <category term="ThousandEyes" scheme="https://weiborao.link/tags/ThousandEyes/"/>
    
    <category term="AWS" scheme="https://weiborao.link/tags/AWS/"/>
    
  </entry>
  
  <entry>
    <title>Mastering KVM Virtualization 学习笔记(1)</title>
    <link href="https://weiborao.link/master-kvm-notes-1.html"/>
    <id>https://weiborao.link/master-kvm-notes-1.html</id>
    <published>2021-02-22T06:23:47.000Z</published>
    <updated>2021-02-22T06:30:40.658Z</updated>
    
    <content type="html"><![CDATA[<p>第一章和第二章之前快速阅读过了，没有笔记，等回头再回来整理。</p><h2 id="Chapter-3-KVM、virsh、oVirt等"><a href="#Chapter-3-KVM、virsh、oVirt等" class="headerlink" title="Chapter 3 KVM、virsh、oVirt等"></a>Chapter 3 KVM、virsh、oVirt等</h2><h3 id="CentOS-8-的KVM安装"><a href="#CentOS-8-的KVM安装" class="headerlink" title="CentOS 8 的KVM安装"></a>CentOS 8 的KVM安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum module install virt</span><br><span class="line">dnf install qemu-img qemu-kvm libvirt libvirt-client virt-manager \</span><br><span class="line">virt-install virt-viewer -y</span><br></pre></td></tr></table></figure><h3 id="安装完后，使用virt-host-validate验证"><a href="#安装完后，使用virt-host-validate验证" class="headerlink" title="安装完后，使用virt-host-validate验证"></a>安装完后，使用virt-host-validate验证</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># virt-host-validate</span></span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> hardware virtualization                                 : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">if</span> device /dev/kvm exists                                   : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">if</span> device /dev/kvm is accessible                            : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">if</span> device /dev/vhost-net exists                             : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">if</span> device /dev/net/tun exists                               : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;memory&#x27;</span> controller support                      : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;memory&#x27;</span> controller mount-point                  : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpu&#x27;</span> controller support                         : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpu&#x27;</span> controller mount-point                     : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpuacct&#x27;</span> controller support                     : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpuacct&#x27;</span> controller mount-point                 : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpuset&#x27;</span> controller support                      : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpuset&#x27;</span> controller mount-point                  : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;devices&#x27;</span> controller support                     : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;devices&#x27;</span> controller mount-point                 : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;blkio&#x27;</span> controller support                       : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;blkio&#x27;</span> controller mount-point                   : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> device assignment IOMMU support                         : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">if</span> IOMMU is enabled by kernel                               : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> Linux &gt;= 2.6.26                                         : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> namespace ipc                                           : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> namespace mnt                                           : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> namespace pid                                           : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> namespace uts                                           : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> namespace net                                           : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> namespace user                                          : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;memory&#x27;</span> controller support                      : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;memory&#x27;</span> controller mount-point                  : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpu&#x27;</span> controller support                         : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpu&#x27;</span> controller mount-point                     : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpuacct&#x27;</span> controller support                     : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpuacct&#x27;</span> controller mount-point                 : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpuset&#x27;</span> controller support                      : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpuset&#x27;</span> controller mount-point                  : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;devices&#x27;</span> controller support                     : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;devices&#x27;</span> controller mount-point                 : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;blkio&#x27;</span> controller support                       : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;blkio&#x27;</span> controller mount-point                   : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">if</span> device /sys/fs/fuse/connections exists                   : PASS</span><br></pre></td></tr></table></figure><h3 id="使用virt-install-安装虚拟机"><a href="#使用virt-install-安装虚拟机" class="headerlink" title="使用virt-install 安装虚拟机"></a>使用virt-install 安装虚拟机</h3><p>编辑anaconda-ks.cfg文件，使用以下参数可以实现虚机部署的静默安装。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">virt-install --virt-type=kvm --name=MasteringKVM02 --ram=4096</span><br><span class="line">--vcpus=4 --os-variant=rhel8.0 --location=/var/lib/libvirt/</span><br><span class="line">images/ CentOS-8-x86_64-1905-dvd1.iso --network=default</span><br><span class="line">--graphics vnc --disk size=16 -x <span class="string">&quot;ks=http://10.10.48.1/ks.cfg&quot;</span></span><br></pre></td></tr></table></figure><h3 id="oVirt"><a href="#oVirt" class="headerlink" title="oVirt"></a>oVirt</h3><p>oVirt（Open Virtualization Manager）是一款免费开源虚拟化软件，是RedHat商业版本虚拟化软件RHEV的开源版本。</p><p>oVirt基于kvm，并整合使用了libvirt、gluster、patternfly、ansible等一系列优秀的开源软件。</p><h3 id="探索虚拟机Qemu-kvm进程"><a href="#探索虚拟机Qemu-kvm进程" class="headerlink" title="探索虚拟机Qemu-kvm进程"></a>探索虚拟机Qemu-kvm进程</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-kvm:/home/ubuntu<span class="comment"># ps aux | grep qemu</span></span><br><span class="line">libvirt+    8526  255  0.1 13876708 653744 ?     SLl  Feb01 61850:36 /usr/bin/qemu-system-x86_64 -name guest=csr1kv-1,debug-threads=on -S -object secret,id=masterKey0,format=raw,file=/var/lib/libvirt/qemu/domain-4-csr1kv-1/master-key.aes -machine pc-q35-4.2,accel=kvm,usb=off,vmport=off,dump-guest-core=off,mem-merge=off -cpu host -m 8192 -mem-prealloc -mem-path /dev/hugepages/libvirt/qemu/4-csr1kv-1 -overcommit mem-lock=on -smp 8,sockets=8,cores=1,threads=1 -uuid 83f90c1c-f0ea-4298-bcdf-3d676de2aeb4 -no-user-config -nodefaults -chardev socket,id=charmonitor,fd=31,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=utc,driftfix=slew -global kvm-pit.lost_tick_policy=delay -no-hpet -no-shutdown -global ICH9-LPC.disable_s3=1 -global ICH9-LPC.disable_s4=1 -boot strict=on -device pcie-root-port,port=0x10,chassis=1,id=pci.1,bus=pcie.0,multifunction=on,addr=0x2 -device pcie-root-port,port=0x11,chassis=2,id=pci.2,bus=pcie.0,addr=0x2.0x1 -device pcie-root-port,port=0x12,chassis=3,id=pci.3,bus=pcie.0,addr=0x2.0x2 -device pcie-root-port,port=0x13,chassis=4,id=pci.4,bus=pcie.0,addr=0x2.0x3 -device pcie-root-port,port=0x14,chassis=5,id=pci.5,bus=pcie.0,addr=0x2.0x4 -device pcie-root-port,port=0x15,chassis=6,id=pci.6,bus=pcie.0,addr=0x2.0x5 -device pcie-root-port,port=0x16,chassis=7,id=pci.7,bus=pcie.0,addr=0x2.0x6 -device pcie-root-port,port=0x17,chassis=8,id=pci.8,bus=pcie.0,addr=0x2.0x7 -device qemu-xhci,p2=15,p3=15,id=usb,bus=pci.3,addr=0x0 -device virtio-serial-pci,id=virtio-serial0,bus=pci.4,addr=0x0 -blockdev &#123;<span class="string">&quot;driver&quot;</span>:<span class="string">&quot;file&quot;</span>,<span class="string">&quot;filename&quot;</span>:<span class="string">&quot;/var/lib/libvirt/images/csr1000v-universalk9.17.02.01v.qcow2&quot;</span>,<span class="string">&quot;node-name&quot;</span>:<span class="string">&quot;libvirt-1-storage&quot;</span>,<span class="string">&quot;auto-read-only&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;discard&quot;</span>:<span class="string">&quot;unmap&quot;</span>&#125; -blockdev &#123;<span class="string">&quot;node-name&quot;</span>:<span class="string">&quot;libvirt-1-format&quot;</span>,<span class="string">&quot;read-only&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;driver&quot;</span>:<span class="string">&quot;qcow2&quot;</span>,<span class="string">&quot;file&quot;</span>:<span class="string">&quot;libvirt-1-storage&quot;</span>,<span class="string">&quot;backing&quot;</span>:null&#125; -device virtio-blk-pci,scsi=off,bus=pci.5,addr=0x0,drive=libvirt-1-format,id=virtio-disk0,bootindex=1 -netdev tap,fd=33,id=hostnet0,vhost=on,vhostfd=34 -device virtio-net-pci,netdev=hostnet0,id=net0,mac=52:54:00:69:ec:73,bus=pci.1,addr=0x0 -chardev pty,id=charserial0 -device isa-serial,chardev=charserial0,id=serial0 -chardev socket,id=charchannel0,fd=35,server,nowait -device virtserialport,bus=virtio-serial0.0,nr=1,chardev=charchannel0,id=channel0,name=org.qemu.guest_agent.0 -chardev spicevmc,id=charchannel1,name=vdagent -device virtserialport,bus=virtio-serial0.0,nr=2,chardev=charchannel1,id=channel1,name=com.redhat.spice.0 -spice port=5900,addr=127.0.0.1,disable-ticketing,image-compression=off,seamless-migration=on -device qxl-vga,id=video0,ram_size=67108864,vram_size=67108864,vram64_size_mb=0,vgamem_mb=16,max_outputs=1,bus=pcie.0,addr=0x1 -device vfio-pci,host=0000:5e:02.0,id=hostdev0,bus=pci.2,addr=0x0 -device vfio-pci,host=0000:5e:0a.0,id=hostdev1,bus=pci.8,addr=0x0 -sandbox on,obsolete=deny,elevateprivileges=deny,spawn=deny,resourcecontrol=deny -msg timestamp=on</span><br></pre></td></tr></table></figure><p>使用pstree检查线程信息：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-kvm:/home/ubuntu<span class="comment"># pstree -p 8526</span></span><br><span class="line">qemu-system-x86(8526)─┬─&#123;qemu-system-x86&#125;(8530)</span><br><span class="line">                      ├─&#123;qemu-system-x86&#125;(8534)</span><br><span class="line">                      ├─&#123;qemu-system-x86&#125;(8535)</span><br><span class="line">                      ├─&#123;qemu-system-x86&#125;(8536)</span><br><span class="line">                      ├─&#123;qemu-system-x86&#125;(8537)</span><br><span class="line">                      ├─&#123;qemu-system-x86&#125;(8538)</span><br><span class="line">                      ├─&#123;qemu-system-x86&#125;(8539)</span><br><span class="line">                      ├─&#123;qemu-system-x86&#125;(8540)</span><br><span class="line">                      ├─&#123;qemu-system-x86&#125;(8541)</span><br><span class="line">                      ├─&#123;qemu-system-x86&#125;(8542)</span><br><span class="line">                      ├─&#123;qemu-system-x86&#125;(8552)</span><br></pre></td></tr></table></figure><p>使用gbd 调试进程，这里参考<a href="https://www.cnblogs.com/hukey/p/11138768.html">https://www.cnblogs.com/hukey/p/11138768.html</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-kvm:/home/ubuntu<span class="comment"># gdb attach 8526</span></span><br><span class="line">GNU gdb (Ubuntu 9.2-0ubuntu1~20.04) 9.2</span><br><span class="line">Copyright (C) 2020 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br><span class="line">Type <span class="string">&quot;show copying&quot;</span> and <span class="string">&quot;show warranty&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">&quot;x86_64-linux-gnu&quot;</span>.</span><br><span class="line">Type <span class="string">&quot;show configuration&quot;</span> <span class="keyword">for</span> configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">    &lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class="line"></span><br><span class="line">For <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">&quot;help&quot;</span>.</span><br><span class="line">Type <span class="string">&quot;apropos word&quot;</span> to search <span class="keyword">for</span> commands related to <span class="string">&quot;word&quot;</span>.</span><br><span class="line">Attaching to process 8526</span><br><span class="line">[New LWP 8530]</span><br><span class="line">[New LWP 8534]</span><br><span class="line">[New LWP 8535]</span><br><span class="line">[New LWP 8536]</span><br><span class="line">[New LWP 8537]</span><br><span class="line">[New LWP 8538]</span><br><span class="line">[New LWP 8539]</span><br><span class="line">[New LWP 8540]</span><br><span class="line">[New LWP 8541]</span><br><span class="line">[New LWP 8542]</span><br><span class="line">[New LWP 8552]</span><br><span class="line">[New LWP 250213]</span><br><span class="line"></span><br><span class="line">warning: <span class="string">&quot;target:/usr/bin/qemu-system-x86_64 (deleted)&quot;</span>: could not open as an executable file: No such file or directory.</span><br><span class="line"></span><br><span class="line">warning: `target:/usr/bin/qemu-system-x86_64 (deleted)<span class="string">&#x27;: can&#x27;</span>t open to <span class="built_in">read</span> symbols: No such file or directory.</span><br><span class="line"></span><br><span class="line">warning: Could not load vsyscall page because no executable was specified</span><br><span class="line">0x00007fdcda986bf6 <span class="keyword">in</span> ?? ()</span><br><span class="line">(gdb) info threads</span><br><span class="line">  Id   Target Id                  Frame</span><br><span class="line">* 1    LWP 8526 <span class="string">&quot;qemu-system-x86&quot;</span> 0x00007fdcda986bf6 <span class="keyword">in</span> ?? ()</span><br><span class="line">  2    LWP 8530 <span class="string">&quot;call_rcu&quot;</span>        0x00007fdcda98c89d <span class="keyword">in</span> ?? ()</span><br><span class="line">  3    LWP 8534 <span class="string">&quot;IO mon_iothread&quot;</span> 0x00007fdcda986aff <span class="keyword">in</span> ?? ()</span><br><span class="line">  4    LWP 8535 <span class="string">&quot;CPU 0/KVM&quot;</span>       0x00007fdcda98850b <span class="keyword">in</span> ?? ()</span><br><span class="line">  5    LWP 8536 <span class="string">&quot;CPU 1/KVM&quot;</span>       0x00007fdcda98850b <span class="keyword">in</span> ?? ()</span><br><span class="line">  6    LWP 8537 <span class="string">&quot;CPU 2/KVM&quot;</span>       0x00007fdcda98850b <span class="keyword">in</span> ?? ()</span><br><span class="line">  7    LWP 8538 <span class="string">&quot;CPU 3/KVM&quot;</span>       0x00007fdcda98850b <span class="keyword">in</span> ?? ()</span><br><span class="line">  8    LWP 8539 <span class="string">&quot;CPU 4/KVM&quot;</span>       0x00007fdcda98850b <span class="keyword">in</span> ?? ()</span><br><span class="line">  9    LWP 8540 <span class="string">&quot;CPU 5/KVM&quot;</span>       0x00007fdcda98850b <span class="keyword">in</span> ?? ()</span><br><span class="line">  10   LWP 8541 <span class="string">&quot;CPU 6/KVM&quot;</span>       0x00007fdcda98850b <span class="keyword">in</span> ?? ()</span><br><span class="line">  11   LWP 8542 <span class="string">&quot;CPU 7/KVM&quot;</span>       0x00007fdcda98850b <span class="keyword">in</span> ?? ()</span><br><span class="line">  12   LWP 8552 <span class="string">&quot;SPICE Worker&quot;</span>    0x00007fdcda986aff <span class="keyword">in</span> ?? ()</span><br><span class="line">  13   LWP 250213 <span class="string">&quot;worker&quot;</span>        0x00007fdcdaa76618 <span class="keyword">in</span> ?? ()</span><br></pre></td></tr></table></figure><h2 id="Chapter-4-KVM-网络"><a href="#Chapter-4-KVM-网络" class="headerlink" title="Chapter 4 KVM 网络"></a>Chapter 4 KVM 网络</h2><p>本章节介绍了以下内容</p><ul><li>Virtual Network – 阐述为什么需要虚拟网络。从虚拟交换机开始，设想一下如果没有虚拟交换机，有20个虚拟机需要20个物理接口连接至20个物理交换机的端口。引入虚拟交换机，减少服务器的物理接口和物理交换机的接口需求。</li><li>Libvirt 的三类网络：NAT、Routed(Bridged)、Isolated；使用virsh net-dumpxml default输出xml文件。</li><li>TUN/TAP设备：属于用户空间的设备，an application can open /dev/net/tun and use an ioctl() function to register a network device in the kernel, which, in turn, presents itself as a tunXX or tapXX device.  TUN设备是一个3层设备，TAP设备是一个2层设备。</li><li>简单介绍了Linux Bridge，此处可以使用ip link 命令替代brctl命令，并使用NetworkManager来持久化配置。</li><li>Open vSwitch简单介绍</li><li>SR-IOV的介绍：此处可以参考我自己的文档。</li><li>MACVTAP介绍：It’s a newer driver that should simplify our virtualized networking by completely removing tun/tap and bridge drivers with a single module.  有四种模式，VEPA，Bridge，Private和Pass-through。</li></ul><h2 id="Chapter-5-KVM-存储"><a href="#Chapter-5-KVM-存储" class="headerlink" title="Chapter 5 KVM 存储"></a>Chapter 5 KVM 存储</h2><p>本章属于囫囵吞枣的看完了，一知半解的记录一下，大致了解了一些存储方面的概念和存储的最新发展。</p><h3 id="存储资源池"><a href="#存储资源池" class="headerlink" title="存储资源池"></a>存储资源池</h3><p>CentOS支持的存储池种类如下：</p><ul><li>Logical Volume Manager (LVM)-based storage pools</li><li>Directory-based storage pools</li><li>Partition-based storage pools</li><li>GlusterFS-based storage pools</li><li>iSCSI-based storage pools</li><li>Disk-based storage pools</li><li>HBA-based storage pools, which use SCSI devices</li></ul><p>对于libvirt来说，存储资源池可能是一个目录，一个存储设备，或者是一个文件。</p><p>介绍了两种文件系统：</p><ul><li><strong>Brtfs</strong> is a type of filesystem that supports snapshots, RAID and LVM-like functionality, compression, defragmentation, online resizing, and many other advanced features. It was deprecated after it was discovered that its RAID5/6 can easily lead to a loss of data. –这里说的是Red Hat</li><li><strong>ZFS</strong> is a type of filesystem that supports everything that Brtfs does, plus read and write caching. <strong>ZFS is not a part of the Linux kernel.</strong></li></ul><h3 id="本地存储池"><a href="#本地存储池" class="headerlink" title="本地存储池"></a>本地存储池</h3><p>Stratis是随RHEL 8引入的本地管理存储解决方案，它使系统管理员可以配置高级存储功能：</p><ol><li>Pool-based management</li><li>Thin provisioning</li><li>File system snapshots</li><li>Monitoring</li></ol><p>Stratis使用示例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mdadm --create /dev/md0 --verbose --level=10 --raid-devices=4 /dev/sdb /dev/sdc /dev/sdd /dev/sde --spare-devices=1 /dev/sdf2</span><br><span class="line">stratis pool create PacktStratisPool01 /dev/md0</span><br><span class="line">stratis pool add-cache PacktStratisPool01 /dev/sdg</span><br><span class="line">stratis fs create PackStratisPool01 PacktStratisXFS01</span><br><span class="line">mkdir /mnt/packtStratisXFS01</span><br><span class="line">mount /stratis/PacktStratisPool01/PacktStratisXFS01 /mnt/packtStratisXFS01</span><br></pre></td></tr></table></figure><h3 id="Libvirt-Storage-Pool"><a href="#Libvirt-Storage-Pool" class="headerlink" title="Libvirt Storage Pool"></a>Libvirt Storage Pool</h3><p>Libvirt 支持多种Storage Pool，详见<a href="https://libvirt.org/storage.html">https://libvirt.org/storage.html</a></p><ul><li>Directory pool</li><li>Filesystem pool</li><li>Network filesystem pool</li><li>Logical volume pool</li><li>Disk pool</li><li>iSCSI pool</li><li>iSCSI direct pool</li><li>SCSI pool</li><li>Multipath pool</li><li>RBD pool</li><li>Sheepdog pool</li><li>Gluster pool</li><li>ZFS pool</li><li>Vstorage pool</li></ul><h3 id="NFS-Storage-Pool"><a href="#NFS-Storage-Pool" class="headerlink" title="NFS Storage Pool"></a>NFS Storage Pool</h3><p>NFS自上世纪80年代就出现了，至今依然活跃，尤其是4.2版本以后增强了不少功能；VMware Virtual Volume 6.0 可以提供基于Block和NFS的两种存储访问。</p><p>Libvirt 使用NFS Storage Pool示例，也可以使用virt-manager 图形界面创建：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">pool</span> <span class="attr">type</span>=<span class="string">&#x27;netfs&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>NFSpooll<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">host</span> <span class="attr">name</span>=<span class="string">&#x27;192.168.159.144&#x27;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dir</span> <span class="attr">path</span>=<span class="string">&#x27;/mnt/packtStratisXF501&#x27;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">format</span> <span class="attr">type</span>=<span class="string">&#x27;auto&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">path</span>&gt;</span>/var/lib/libvirt/images/NFSpooll<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">permissions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">mode</span>&gt;</span>0755<span class="tag">&lt;/<span class="name">mode</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">owner</span>&gt;</span>0<span class="tag">&lt;/<span class="name">owner</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">group</span>&gt;</span>0<span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span>&gt;</span>system_u:object r:nfs t:s0<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">permissions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">pool</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="iSCIS-和-SAN-存储"><a href="#iSCIS-和-SAN-存储" class="headerlink" title="iSCIS 和 SAN 存储"></a>iSCIS 和 SAN 存储</h3><p>iSCIS协议有两个主要原因影响其高效性：</p><ul><li><strong>IP协议封装</strong> iSCSI encapsulates SCSI commands into regular IP packages, which means segmentation and overhead as IP packages have a pretty large header, which means less efficiency.</li><li><strong>基于TCP传输</strong> Even worse, it’s TCP-based, which means that there are sequence numbers and retransmissions, which can lead to queueing and latency, and the bigger the environment is, the more you usually feel these effects affect your virtual machine performance.</li></ul><p>The iSCSI and FC architectures are very similar—they both need a target (an iSCSI target and an FC target) and an initiator (an iSCS initiator and an FC initiator)，the initiator connects to a target to get access to block storage that’s presented via that target.</p><h4 id="LUN的概念"><a href="#LUN的概念" class="headerlink" title="LUN的概念"></a>LUN的概念</h4><p>LUNs are just raw, block capacities that we export via an iSCSI target toward initiators. LUNs are indexed, or numbered, usually from 0 onward. Every LUN number represents a different storage capacity that an initiator can connect to.</p><p>For example, we can have an iSCSI target with three different LUNs—LUN0 with 20 GB, LUN1 with 40 GB, and LUN2 with 60 GB. These will all be hosted on the same storage system’s iSCSI target. We can then configure the iSCSI target to accept an IQN to see all the LUNs, another IQN to only see LUN1, and another IQN to only see LUN1 and LUN2. </p><p>使用 targetcli命令创建iSCIS target，步骤简要说明如下：</p><ol><li>创建/dev/sdb1分区和XFS文件系统，并mount /dev/sdb1 /LUN0，用targetcli创建一个fileio 类型的target后端</li><li>创建/dev/sdc1分区，并直接使用targetcli创建一个block类型的target后端</li><li>基于/dev/sdd创建LVM，并使用targetcli创建一个block类型的target后端</li><li>在KVM主机上设置好iscsi的initiator参数</li><li>回到iSCSI上，创建ACL，允许KVM host，基于1~3创建的target发布LUNs</li><li>在KVM Host上定义Storage Pool的XML文件，用virsh pool-define创建Storage Pool</li></ol><h3 id="Storage-redundancy-and-multipathing"><a href="#Storage-redundancy-and-multipathing" class="headerlink" title="Storage redundancy and multipathing"></a>Storage redundancy and multipathing</h3><p>避免单点故障SPOF，网卡、线缆、交换机、存储控制器等等。</p><p>KVM Host基于iSCSI做冗余和多路径的配置较为复杂，并且缺少支持，文章建议使用oVirt或者RHEV-H(Red Hat Enterprise Virtualization Hypervisor. )</p><p>使用oVirt 创建一个iSCSI Bond来实现冗余和多路径。</p><h3 id="Gluster"><a href="#Gluster" class="headerlink" title="Gluster"></a>Gluster</h3><p>Gluster 是一个分布式文件系统，其突出优势是可扩展性，数据复制和快照功能；注意Gluster是一个文件存储服务。</p><p>生产环境中，Gluster至少配置三台服务器。</p><p>配置步骤简要说明如下：</p><ol><li><p>创建磁盘分区以及文件系统 </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkfs.xfs /dev/sdb</span><br><span class="line">mkdir /gluster/bricks/1 -p</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;/dev/sdb /gluster/bricks/1 xfs defaults 0 0&#x27;</span> &gt;&gt; /etc/</span><br><span class="line">fstab</span><br><span class="line">mount -a</span><br><span class="line">mkdir /gluster/bricks/1/brick</span><br></pre></td></tr></table></figure></li><li><p>创建Gluster分布式文件系统</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gluster volume create kvmgluster replica 3 \ gluster1:/gluster/</span><br><span class="line">bricks/1/brick gluster2:/gluster/bricks/1/brick \ gluster3:/</span><br><span class="line">gluster/bricks/1/brick</span><br><span class="line">gluster volume start kvmgluster</span><br><span class="line">gluster volume <span class="built_in">set</span> kvmgluster auth.allow 192.168.159.0/24</span><br><span class="line">gluster volume <span class="built_in">set</span> kvmgluster allow-insecure on</span><br><span class="line">gluster volume <span class="built_in">set</span> kvmgluster storage.owner-uid 107</span><br><span class="line">gluster volume <span class="built_in">set</span> kvmgluster storage.owner-gid 107</span><br></pre></td></tr></table></figure></li><li><p>挂在Gluster文件系统为NFS服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;localhost:/kvmgluster /mnt glusterfs \ defaults,_</span></span><br><span class="line"><span class="string">netdev,backupvolfile-server=localhost 0 0&#x27;</span> &gt;&gt; /etc/fstab</span><br><span class="line">mount.glusterfs localhost:/kvmgluster /mnt</span><br></pre></td></tr></table></figure></li><li><p>在KVM主机上挂在Gluster</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget \ https://download.gluster.org/pub/gluster/glusterfs/6/</span><br><span class="line">LATEST/CentOS/gl\ usterfs-rhel8.repo -P /etc/yum.repos.d</span><br><span class="line">yum install glusterfs glusterfs-fuse attr -y</span><br><span class="line">mount -t glusterfs -o context=<span class="string">&quot;system_u:object_r:virt_</span></span><br><span class="line"><span class="string">image_t:s0&quot;</span> \ gluster1:/kvmgluster /var/lib/libvirt/images/</span><br><span class="line">GlusterFS</span><br></pre></td></tr></table></figure></li><li><p>在KVM上定义存储资源池：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">pool</span> <span class="attr">type</span>=<span class="string">&#x27;dir&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>glusterfs-pool<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">path</span>&gt;</span>/var/lib/libvirt/images/GlusterFS<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">permissions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">mode</span>&gt;</span>0755<span class="tag">&lt;/<span class="name">mode</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">owner</span>&gt;</span>107<span class="tag">&lt;/<span class="name">owner</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">group</span>&gt;</span>107<span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span>&gt;</span>system_u:object_r:virt_image_t:s0<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">permissions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">pool</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">virsh pool-define --file gluster.xml</span><br><span class="line">virsh pool-start --pool glusterfs-pool</span><br><span class="line">virsh pool-autostart --pool glusterfs-pool</span><br></pre></td></tr></table></figure><p>将Gluster挂在为目录，可以避免Libvirt在使用Gluster的两个问题：</p></li></ol><ul><li><p>We can use Gluster’s failover capability, which will be managed automatically by the</p><p>Gluster utilities that we installed directly, as libvirt doesn’t support them yet.</p></li><li><p>We will avoid creating virtual machine disks <em>manually</em>, which is another limitation of libvirt’s implementation of Gluster support, while directory-based storage pools support it without any issues.</p></li></ul><h3 id="Ceph"><a href="#Ceph" class="headerlink" title="Ceph"></a>Ceph</h3><p>Ceph offers block and object-based storage. Object-based storage for block-based devices means direct, binary storage, directly to a LUN. There are no filesystems involved, which theoretically means less overhead as there’s no filesystem, filesystem tables, and other constructs that might slow the I/O process down.</p><p>Architecture-wise, Ceph has three main services:</p><ul><li>ceph-mon : Used for cluster monitoring, CRUSH maps, and Object Storage Daemon (OSD) maps.</li><li>ceph-osd: This handles actual data storage, replication, and recovery. It requires at least two nodes; we’ll use three for clustering reasons.</li><li>ceph-mds: Metadata server, used when Ceph needs filesystem access.</li></ul><p>Ceph 集群中，所有的数据节点要求采用相同的硬件配置，相同的CPU、内存、硬盘，不适用RAID控制器，仅仅使用HBA。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy install ceph-admin ceph-monitor ceph-osd1 ceph-osd2</span><br><span class="line">ceph-osd3</span><br><span class="line">ceph-deploy mon create-initial</span><br><span class="line">ceph-deploy gatherkeys ceph-monitor</span><br><span class="line">ceph-deploy disk list ceph-osd1 ceph-osd2 ceph-osd3</span><br><span class="line">ceph-deploy disk zap ceph-osd1:/dev/sdb  ceph-osd2:/dev/sdb</span><br><span class="line">ceph-osd3:/dev/sdb</span><br><span class="line">ceph-deploy osd prepare ceph-osd1:/dev/sdb ceph-osd2:/dev/sdb</span><br><span class="line">ceph-osd3:/dev/sdb</span><br><span class="line">ceph-deploy osd activate ceph-osd1:/dev/sdb1 ceph-osd2:/dev/</span><br><span class="line">sdb1 ceph-osd3:/dev/sdb1</span><br></pre></td></tr></table></figure><p>对上述命令的说明：</p><ul><li><p>The first command starts the actual deployment process—for the admin, monitor, and OSD nodes, with the installation of all the necessary packages.</p></li><li><p>The second and third commands configure the monitor host so that it’s ready to accept external connections.</p></li><li><p>The two disk commands are all about disk preparation—Ceph will clear the disks that we assigned to it (/dev/sdb per OSD host) and create two partitions on them, one for Ceph data and one for the Ceph journal.</p></li><li><p>The last two commands prepare these filesystems for use and activate Ceph. If at any time your ceph-deploy script stops, check your DNS and /etc/hosts and firewalld configuration, as that’s where the problems usually are.</p></li></ul><p>使用以下命令将Ceph存储发布给KVM主机作为存储池：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph osd pool create KVMpool 128 128</span><br></pre></td></tr></table></figure><p>还需要几个步骤来实现安全的访问，为Ceph的访问增加密码验证。</p><ol><li><p>Ceph生成验证的密码 Key</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ceph auth get-or-create client.KVMpool mon <span class="string">&#x27;allow r&#x27;</span> osd <span class="string">&#x27;allow</span></span><br><span class="line"><span class="string">rwx pool=KVMpool&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#It&#x27;s going to throw us a status message, something like this:</span></span><br><span class="line">key = AQB9p8RdqS09CBAA1DHsiZJbehb7ZBffhfmFJQ==</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>定义一个Secret</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">secret</span> <span class="attr">ephemeral</span>=<span class="string">&#x27;no&#x27;</span> <span class="attr">private</span>=<span class="string">&#x27;no&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">usage</span> <span class="attr">type</span>=<span class="string">&#x27;ceph&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>client.KVMpool secret<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">usage</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">secret</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>将Secret的UUID与Ceph生成的Key进行关联。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">virsh secret-define --file secret.xml</span><br><span class="line"></span><br><span class="line">Secret 95b1ed29-16aa-4e95-9917-c2cd4f3b2791 created</span><br><span class="line"></span><br><span class="line">virsh secret-set-value 95b1ed29-16aa-4e95-9917-c2cd4f3b2791</span><br><span class="line">AQB9p8RdqS09CBAA1DHsiZJbehb7ZBffhfmFJQ==</span><br></pre></td></tr></table></figure></li><li><p>定义Ceph存储池</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">pool</span> <span class="attr">type</span>=<span class="string">&quot;rbd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>KVMpool<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">host</span> <span class="attr">name</span>=<span class="string">&#x27;192.168.159.151&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;6789&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">auth</span> <span class="attr">username</span>=<span class="string">&#x27;KVMpool&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;ceph&#x27;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">secret</span> <span class="attr">uuid</span>=<span class="string">&#x27;95b1ed29-16aa-4e95-9917-c2cd4f3b2791&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">auth</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">pool</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">virsh pool-define --file ceph.xml</span><br><span class="line">virsh pool-start KVMpool</span><br><span class="line">virsh pool-autostart KVMpool</span><br><span class="line">virsh pool-list --details</span><br></pre></td></tr></table></figure><h3 id="虚拟磁盘镜像和KVM存储基本操作"><a href="#虚拟磁盘镜像和KVM存储基本操作" class="headerlink" title="虚拟磁盘镜像和KVM存储基本操作"></a>虚拟磁盘镜像和KVM存储基本操作</h3></li></ol><p>文章介绍了使用dd命令生成磁盘镜像文件，如下：</p><p>生成10G的预分配磁盘文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd <span class="keyword">if</span>=/dev/zero of=/vms/dbvm_disk2.img bs=1G count=10</span><br></pre></td></tr></table></figure><p>生成10G的磁盘文件，使用seek关键字，不做预分配</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd <span class="keyword">if</span>=/dev/zero of=/vms/dbvm_disk2_seek.imgbs=1G seek=10 count=0</span><br></pre></td></tr></table></figure><h4 id="qemu-img-命令"><a href="#qemu-img-命令" class="headerlink" title="qemu-img 命令"></a>qemu-img 命令</h4><p>使用qemu-img info查看磁盘文件的信息，如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># qemu-img info /vms/dbvm_disk2.img</span></span><br><span class="line">image: /vms/dbvm_disk2.img</span><br><span class="line">file format: raw</span><br><span class="line">virtual size: 10G (10737418240 bytes)</span><br><span class="line">disk size: 10G</span><br><span class="line"><span class="comment"># qemu-img info /vms/dbvm_disk2_seek.img</span></span><br><span class="line">image: /vms/dbvm_disk2_seek.img</span><br><span class="line">file format: raw</span><br><span class="line">virtual size: 10G (10737418240 bytes)</span><br><span class="line">disk size: 10M</span><br></pre></td></tr></table></figure><h4 id="使用virsh命令加载硬盘"><a href="#使用virsh命令加载硬盘" class="headerlink" title="使用virsh命令加载硬盘"></a>使用virsh命令加载硬盘</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virsh attach-disk CentOS8 /vms/dbvm_disk2.img vdb --live --config</span><br></pre></td></tr></table></figure><p>说明如下：</p><ul><li> <strong>CentOS8</strong> is the virtual machine to which a disk attachment is executed. </li><li>Then, there is the path of the disk image,  <strong>/vms/dbvm_disk2.img</strong></li><li><strong>vdb</strong> is the target disk name that would be visible inside the guest operating system. </li><li><strong>–live</strong> means performing the action while the virtual machine is running.</li><li><strong>–config</strong> means attaching it persistently across reboot. Not adding a –config switch will keep the disk attached only until reboot.</li></ul><p>查看虚拟机的硬盘信息：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">virsh domblklist CentOS8 --details</span><br><span class="line"></span><br><span class="line">Type Device Target Source</span><br><span class="line">------------------------------------------------</span><br><span class="line">file disk vda /var/lib/libvirt/images/fedora21.qcow2</span><br><span class="line">file disk vdb /vms/dbvm_disk2_seek.img</span><br></pre></td></tr></table></figure><p>还有其他章节，比如创建ISO库、删除存储池、创建卷和删除卷。</p><h4 id="有关NVMe和NVMe-over-Fabric"><a href="#有关NVMe和NVMe-over-Fabric" class="headerlink" title="有关NVMe和NVMe over Fabric"></a>有关NVMe和NVMe over Fabric</h4><p>SSD存储的存取方式发生改变，主要体现在性能和延时这两方面。传统<strong>AHCI</strong> (Advanced Host Controller Interface) 已不能满足SSD的性能要求。</p><p><strong>NVMe</strong> (Non-Volatile Memory Express) 是一个全新的协议，基于PCIe技术，目的在于满足SSD的高性能、低时延的访问要求。越来越多的存储设备已经集成了SSD和NVMe，主要用于缓存，同时也有用于数据存储的。</p><p>Fiber Channel，虽然10多年被人争执说要从市场消失，主要原因无外乎：FC需要专用的交换机、专门的网卡和线缆，FC设备贵，需要专门的知识，而且FC的速率没有以太网发展快。</p><p>但是，目前市场上发生的情况有所不同，FC可以满足NVMe SSD带来的性能提升的需求。</p><p>Two of these concepts derived from <strong>Intel Optane</strong>—<strong>Storage Class Memory (SCM) and Persistent Memory (PM)</strong> are the latest technologies that storage companies and customers want adopted into their storage systems, and fast.</p><p>将工作负载移到内存当中是符合逻辑的，设想一下内存型数据库(Microsoft SQL, SAP HANA, Oracle).</p><p>如果一个存储厂商生产了使用SCM SSD的存储设备，那么只有内存可用于缓存(Cache).</p>]]></content>
    
    
    <summary type="html">Mastering KVM Virtualization 学习笔记，自用，本篇主要记录第三章到第五章。</summary>
    
    
    
    
    <category term="kvm" scheme="https://weiborao.link/tags/kvm/"/>
    
  </entry>
  
  <entry>
    <title>Cisco NFVIS CSR1Kv ZTP Onboarding for SDWAN</title>
    <link href="https://weiborao.link/csr1kv-nfvis-ztp-demo.html"/>
    <id>https://weiborao.link/csr1kv-nfvis-ztp-demo.html</id>
    <published>2021-02-08T03:02:43.000Z</published>
    <updated>2021-09-17T06:27:54.266Z</updated>
    
    <content type="html"><![CDATA[<div style="position: relative; width: 100%; height: 0; padding-bottom: 75%;">    <iframe src="//player.bilibili.com/player.html?aid=544065936&bvid=BV1Zv4y1o7YJ&cid=294265132&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="position: absolute; width: 100%; height: 100%; left: 0; top: 0;">    </iframe></div>]]></content>
    
    
    <summary type="html">本视频演示在Cisco NFVIS平台上零配置上线CSR1000v，并完成SDWAN的配置。</summary>
    
    
    
    
    <category term="ztp" scheme="https://weiborao.link/tags/ztp/"/>
    
    <category term="nfvis" scheme="https://weiborao.link/tags/nfvis/"/>
    
  </entry>
  
  <entry>
    <title>Cisco CSR 1000v &amp; Catalyst 8000v KVM SRIOV安装设置演示</title>
    <link href="https://weiborao.link/csr1kv-kvm-sriov-ubuntu-demo.html"/>
    <id>https://weiborao.link/csr1kv-kvm-sriov-ubuntu-demo.html</id>
    <published>2021-02-08T02:36:08.000Z</published>
    <updated>2021-09-17T06:29:03.172Z</updated>
    
    <content type="html"><![CDATA[<div style="position: relative; width: 100%; height: 0; padding-bottom: 75%;">    <iframe src="//player.bilibili.com/player.html?aid=501530216&bvid=BV1VN411R75t&cid=294248612&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="position: absolute; width: 100%; height: 100%; left: 0; top: 0;">    </iframe></div><p>鸣谢：<a href="https://rongtianjie.github.io/">Johnny Rong</a> <a href="https://rongtianjie.github.io/2019/03/15/2019-03-15-HEXO%E4%B8%AD%E6%B7%BB%E5%8A%A0B%E7%AB%99%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE%E5%99%A8/">Hexo博客中添加B站视频播放器</a> </p>]]></content>
    
    
    <summary type="html">本视频演示在 Ubuntu 20.0 版本上安装 KVM，并安装和设置 CSR 1000v/Catalyst 8000v 的指南，内容包括 SRIOV，KVM 调优以及 CSR1KV 初始化配置等内容。</summary>
    
    
    
    
    <category term="sriov" scheme="https://weiborao.link/tags/sriov/"/>
    
    <category term="csr1000v" scheme="https://weiborao.link/tags/csr1000v/"/>
    
    <category term="ztp" scheme="https://weiborao.link/tags/ztp/"/>
    
  </entry>
  
  <entry>
    <title>Hexo 安装设置遇到的问题及解决办法</title>
    <link href="https://weiborao.link/hexo-setup-log-md.html"/>
    <id>https://weiborao.link/hexo-setup-log-md.html</id>
    <published>2021-02-07T15:36:19.000Z</published>
    <updated>2021-02-08T15:43:30.966Z</updated>
    
    <content type="html"><![CDATA[<h1 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h1><p>正常按照<strong>brew install node</strong> 以及 <strong>npm install -g hexo-cli</strong> 安装完以后，运行<strong>hexo deploy</strong>报错，如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜  blog hexo d</span><br><span class="line">INFO  Validating config</span><br><span class="line">INFO  Deploying: git</span><br><span class="line">INFO  Clearing .deploy_git folder...</span><br><span class="line">INFO  Copying files from public folder...</span><br><span class="line">FATAL &#123;</span><br><span class="line">  err: TypeError [ERR_INVALID_ARG_TYPE]: The <span class="string">&quot;mode&quot;</span> argument must be <span class="built_in">integer</span>. Received an instance of Object</span><br><span class="line">      at copyFile (node:fs:2019:10)</span><br><span class="line">      at tryCatcher (/Users/werao/blog/node_modules/bluebird/js/release/util.js:16:23)</span><br><span class="line">      at ret (<span class="built_in">eval</span> at makeNodePromisifiedEval (/usr/<span class="built_in">local</span>/lib/node_modules/hexo-cli/node_modules/bluebird/js/release/promisify.js:184:12), &lt;anonymous&gt;:13:39)</span><br></pre></td></tr></table></figure><p>网上查找了一下，报错的原因是Hexo与Node.js的兼容性问题。</p><h1 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h1><p>非常幸运，找到一篇文章：<a href="http://franktianyirenjian.github.io/2020/04/28/%E9%87%8D%E8%A3%85Hexo%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/">重装Hexo遇到的坑</a> 作者 成百川。</p><p>简要记录步骤如下：</p><ol><li><p>卸载<strong>node</strong><br><strong>brew uninstall node</strong></p></li><li><p>安装<strong>nvm</strong><br><strong>brew install nvm</strong><br>记得按提示修改**~/.zshrc<strong>文件，否则下次启动会找不到</strong>nvm**。</p></li><li><p>使用<strong>nvm</strong>安装低于14.0版本的node.js–如果后续版本升级，还可以使用nvm安装新版本。<br><strong>nvm install v13.14.0</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Now using node v13.14.0 (npm v6.14.4)</span><br><span class="line">Creating default <span class="built_in">alias</span>: default -&gt; v13.14.0</span><br></pre></td></tr></table></figure></li><li><p>重新运行<strong>hexo deploy -g</strong> 发布本文。</p></li></ol><p>鸣谢<strong>成百川</strong>。</p>]]></content>
    
    
    <summary type="html">记录在Hexo安装过程中遇到的Hexo与Node.js版本兼容性的问题，使用nvm安装低版本的node.js解决问题，参考成百川的解决办法。</summary>
    
    
    
    
    <category term="hexo" scheme="https://weiborao.link/tags/hexo/"/>
    
  </entry>
  
  <entry>
    <title>Cisco CSR1000v KVM SRIOV Setting Guide on Ubuntu 20.04 With NetworkManager</title>
    <link href="https://weiborao.link/csr1kv-kvm-Ubuntu20-04-md.html"/>
    <id>https://weiborao.link/csr1kv-kvm-Ubuntu20-04-md.html</id>
    <published>2021-02-03T14:37:33.000Z</published>
    <updated>2021-02-08T03:38:30.670Z</updated>
    
    <content type="html"><![CDATA[<p>Last Update: February 3, 2021</p><p>Author: Rao Weibo</p><p>Version: 1.0</p><p>This guide provides the steps on how to install CSR1000v/Catalyst 8000v on KVM, the setting of SRIOV and KVM tuning.</p><h1 id="Ubuntu-20-04-Installation-and-Settings"><a href="#Ubuntu-20-04-Installation-and-Settings" class="headerlink" title="Ubuntu 20.04 Installation and Settings"></a>Ubuntu 20.04 Installation and Settings</h1><h2 id="1-BIOS-settings"><a href="#1-BIOS-settings" class="headerlink" title="(1) BIOS settings"></a>(1) BIOS settings</h2><table><thead><tr><th>Configuration</th><th>Recommended Setting</th></tr></thead><tbody><tr><td>Intel Hyper-Threading  Technology</td><td>Disabled</td></tr><tr><td>Number of Enable Cores</td><td>ALL</td></tr><tr><td>Execute Disable</td><td>Enabled</td></tr><tr><td><strong>Intel VT</strong></td><td><strong>Enabled</strong></td></tr><tr><td><strong>Intel VT-D</strong></td><td><strong>Enabled</strong></td></tr><tr><td>Intel VT-D coherency support</td><td>Enabled</td></tr><tr><td>Intel VT-D ATS support</td><td>Enabled</td></tr><tr><td>CPU Performance</td><td>High throughput</td></tr><tr><td>Hardware Perfetcher</td><td>Disabled</td></tr><tr><td>Adjacent Cache Line Prefetcher</td><td>Disabled</td></tr><tr><td>DCU Streamer Prefetch</td><td>Disable</td></tr><tr><td>Power Technology</td><td>Custom</td></tr><tr><td>Enhanced Intel Speedstep  Technology</td><td>Disabled</td></tr><tr><td>Intel Turbo Boost Technology</td><td>Enabled</td></tr><tr><td>Processor Power State C6</td><td>Disabled</td></tr><tr><td>Processor Power State C1 Enhanced</td><td>Disabled</td></tr><tr><td>Frequency Poor Override</td><td>Enabled</td></tr><tr><td>P-State Coordination</td><td>HW_ALL</td></tr><tr><td>Energy Performance</td><td>Performance</td></tr></tbody></table><p>The above settings are from the Installation guide from <a href="https://www.cisco.com/c/en/us/td/docs/routers/csr1000/software/configuration/b_CSR1000v_Configuration_Guide/b_CSR1000v_Configuration_Guide_chapter_0101.html#con_1313827">Cisco CSR 1000v and Cisco ISRv Software Configuration Guide</a>.<br>Note: some platform such as <strong>Cisco NFVIS</strong>, does not disable the Hyper-Threading.</p><h2 id="2-Ubuntu-20-04-installation-tips"><a href="#2-Ubuntu-20-04-installation-tips" class="headerlink" title="(2) Ubuntu 20.04 installation tips"></a>(2) Ubuntu 20.04 installation tips</h2><p>If you need the Gnome GUI, you can install the Ubuntu 20.04 Desktop.<br>After the system bootup, <strong>‘apparmor’</strong> is recommended to be disabled, otherwise, you may meet <strong>permission denied</strong> when you assign SRIOV devices to the CSR1kV. You need to reboot to take effect.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl disable apparmor</span><br><span class="line">egrep -o &#x27;(vmx|svm)&#x27; /proc/cpuinfo | sort | uniq</span><br></pre></td></tr></table></figure><p>You can find the <strong>vmx</strong> on Intel platform, or <strong>svm</strong> on AMD platform.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop ufw</span><br><span class="line">systemctl disable ufw</span><br></pre></td></tr></table></figure><p><code>cat /etc/sysctl.conf</code></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 0</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 0</span><br><span class="line">net.bridge.bridge-nf-call-arptables = 0</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo apt install qemu-kvm libvirt-clients libvirt-daemon-system bridge-utils virt-manager numactl virt-top</span></span><br></pre></td></tr></table></figure><p>After installation, you can check the version</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ libvirtd -V</span><br><span class="line">libvirtd (libvirt) 6.0.0</span><br><span class="line">ubuntu@ubuntu-kvm:~$ qemu-system-x86_64 --version</span><br><span class="line">QEMU emulator version 4.2.1 (Debian 1:4.2-3ubuntu6.11)</span><br><span class="line">Copyright (c) 2003-2019 Fabrice Bellard and the QEMU Project developers</span><br><span class="line">ubuntu@ubuntu-kvm:~$ virt-manager --version</span><br><span class="line">2.2.1</span><br><span class="line">ubuntu@ubuntu-kvm:~$ modinfo kvm-intel</span><br><span class="line">filename:       /lib/modules/5.4.0-62-generic/kernel/arch/x86/kvm/kvm-intel.ko</span><br><span class="line">ubuntu@ubuntu-kvm:~$ modinfo i40evf</span><br><span class="line">filename:       /lib/modules/5.4.0-62-generic/kernel/drivers/net/ethernet/intel/iavf/iavf.ko</span><br><span class="line">version:        3.2.3-k</span><br></pre></td></tr></table></figure><h2 id="3-NIC-Setting"><a href="#3-NIC-Setting" class="headerlink" title="(3) NIC Setting"></a>(3) NIC Setting</h2><p>In Ubuntu 20.04, we use NetworkManager to config the NIC, you can use nmtui on the terminal, or nmcli.<br>First, check the netplan.</p><p><code>cat /etc/netplan/ 00-installer-config.yaml</code></p><p>Edit the yaml file:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Let NetworkManager manage all devices on this system</span></span><br><span class="line"><span class="attr">network:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">renderer:</span> <span class="string">NetworkManager</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo netplan apply</span><br></pre></td></tr></table></figure><p>Then you can set the network config with nmcli or nmtui.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ sudo nmcli connection modify netplan-eno1 ipv4.method manual ipv4.addresses 10.75.59.50/24 ipv4.gateway 10.75.59.1 ipv4.dns 64.104.123.245</span><br><span class="line">ubuntu@ubuntu-kvm:~$ sudo nmcli connection modify netplan-eno1 connection.id eno1</span><br><span class="line">ubuntu@ubuntu-kvm:~$ sudo nmcli connection up eno1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Change the connections name to the devices name.</span></span><br><span class="line"></span><br><span class="line">sudo nmcli connection</span><br><span class="line">ubuntu@ubuntu-kvm:~$ sudo nmcli connection</span><br><span class="line">NAME        UUID                                  TYPE      DEVICE</span><br><span class="line">eno1        10838d80-caeb-349e-ba73-08ed16d4d666  ethernet  eno1</span><br><span class="line">enp216s0f0  6556c191-c253-3a5e-b440-c5b071ec29a4  ethernet  enp216s0f0</span><br><span class="line">enp216s0f1  8080672c-5784-375f-8eb9-a6ef57cbd4f7  ethernet  enp216s0f1</span><br><span class="line">ens1f0      58fb5b1f-c10a-3e7a-9ab9-a8c449840ce6  ethernet  ens1f0</span><br><span class="line">ens1f1      2a06a9d9-b761-3bdf-aa0b-3d44fff2158f  ethernet  ens1f1</span><br><span class="line">virbr0      ca7d1e11-a82f-429c-9d91-fc985776232c  bridge    virbr0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">Set the MTU and <span class="built_in">disable</span> ipv4 <span class="keyword">for</span> the NIC to <span class="built_in">enable</span> SRIOV.</span> </span><br><span class="line"></span><br><span class="line">sudo nmcli connection modify ens1f0 ethernet.mtu 9216</span><br><span class="line">sudo nmcli connection modify ens1f0 ipv4.method disabled</span><br><span class="line">sudo nmcli connection up ens1f0</span><br><span class="line">sudo ip link show ens1f0</span><br><span class="line">2: ens1f0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9216 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class="line">link/ether 40:a6:b7:0f:a7:74 brd ff:ff:ff:ff:ff:ff</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Note: This value 9216 of MTU is derived from Cisco NFVIS.</span></span><br><span class="line"><span class="meta">CSP5228-1#</span><span class="bash"> show pnic-detail mtu</span></span><br><span class="line">Name          MTU</span><br><span class="line">=============================</span><br><span class="line">eth0-1        9216</span><br><span class="line">eth0-2        9216</span><br><span class="line">eth1-1        9216</span><br><span class="line">eth1-2        9216</span><br></pre></td></tr></table></figure><h1 id="SR-IOV-Configuration"><a href="#SR-IOV-Configuration" class="headerlink" title="SR-IOV Configuration"></a>SR-IOV Configuration</h1><h2 id="1-Check-the-NIC-to-support-SR-IOV"><a href="#1-Check-the-NIC-to-support-SR-IOV" class="headerlink" title="(1) Check the NIC to support SR-IOV"></a>(1) Check the NIC to support SR-IOV</h2><p>Check the NIC hardware infor.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sudo lshw -c network -businfo</span><br><span class="line"></span><br><span class="line">Bus info          Device      Class          Description</span><br><span class="line">========================================================</span><br><span class="line"></span><br><span class="line">pci@0000:3b:00.0  eno1        network        Ethernet Controller 10G X550T</span><br><span class="line">pci@0000:3b:00.1  eno2        network        Ethernet Controller 10G X550T</span><br><span class="line">pci@0000:5e:00.0  ens1f0      network        Ethernet Controller XXV710 for 25GbE SFP28</span><br><span class="line">pci@0000:5e:00.1  ens1f1      network        Ethernet Controller XXV710 for 25GbE SFP28</span><br><span class="line">pci@0000:d8:00.0  enp216s0f0  network        Ethernet Controller XXV710 for 25GbE SFP28</span><br><span class="line">pci@0000:d8:00.1  enp216s0f1  network        Ethernet Controller XXV710 for 25GbE SFP28</span><br></pre></td></tr></table></figure><p>Check the capabilities of NIC</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo lspci -vv -s 5e:00.0 | grep -A 5 -i SR-IOV</span><br><span class="line">    Capabilities: [160 v1] Single Root I/O Virtualization (SR-IOV)</span><br><span class="line">        IOVCap: Migration-, Interrupt Message Number: 000</span><br><span class="line">        IOVCtl: Enable+ Migration- Interrupt- MSE+ ARIHierarchy+</span><br><span class="line">        IOVSta: Migration-</span><br><span class="line">        Initial VFs: 64, Total VFs: 64, Number of VFs: 2, Function Dependency Link: 00</span><br><span class="line">        VF offset: 16, stride: 1, Device ID: 154c</span><br></pre></td></tr></table></figure><h2 id="2-Change-the-GRUB-parameters"><a href="#2-Change-the-GRUB-parameters" class="headerlink" title="(2) Change the GRUB parameters"></a>(2) Change the GRUB parameters</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/default/grub </span><br><span class="line">GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet hugepagesz=1G hugepages=64 default_hugepagesz=1G intel_iommu=on iommu=pt isolcpus=1-8,45-52&quot;</span><br></pre></td></tr></table></figure><p><strong>Note：The hugepages should be no more than the physical memory, otherwise, it will fail to bootup.</strong></p><ul><li><strong>default_hugepagesz=1G hugepagesz=1G hugepages=64</strong> will allocate 64 1GB huge pages at boot, which are <strong>static huge pages</strong>. CSR 1000v will use these static huge pages for best performance.</li><li><strong>isolcpus=1-8,45-52</strong> will isolate the CPUs cores reserved for CSR 1000v, prevent other processes running on these cores, this can reduce latency for CSR 1000v. You can refer to   [Check the capability of the platform][1]  to get the CPU information.</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo update-grub</span><br></pre></td></tr></table></figure><p>After reboot, check the /proc/cmdline.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/cmdline |grep intel_iommu=on</span><br><span class="line">dmesg |grep -e DMAR -e IOMMU</span><br><span class="line">dmesg | grep -e DMAR -e IOMMU -e AMD-Vi</span><br><span class="line">ubuntu@ubuntu-kvm:~$ cat /proc/cmdline |grep intel_iommu=on</span><br><span class="line">BOOT_IMAGE=/vmlinuz-5.4.0-62-generic root=/dev/mapper/ubuntu--vg-ubuntu--lv ro quiet hugepagesz=1G hugepages=64 default_hugepagesz=1G intel_iommu=on iommu=pt isolcpus=1-8,45-52</span><br><span class="line"></span><br><span class="line">ubuntu@ubuntu-kvm:~ $ dmesg |grep -e DMAR -e IOMMU</span><br><span class="line">[    0.020313] ACPI: DMAR 0x000000005DA8EB80 000270 (v01 Cisco0 CiscoUCS 00000001 INTL 20091013)</span><br><span class="line">[    1.954441] DMAR: IOMMU enabled</span><br></pre></td></tr></table></figure><p>Check the CPU info, all the CPU cores and isolated CPU cores.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ cat /sys/devices/system/cpu/isolated</span><br><span class="line">1-8,45-52</span><br><span class="line">ubuntu@ubuntu-kvm:~$ cat /sys/devices/system/cpu/present</span><br><span class="line">0-87</span><br></pre></td></tr></table></figure><h2 id="3-VFs-Persistence"><a href="#3-VFs-Persistence" class="headerlink" title="(3) VFs Persistence"></a>(3) VFs Persistence</h2><p><strong>NetworkManager way:</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> nmcli can <span class="built_in">set</span> the SRIOV, as follow:</span></span><br><span class="line">sudo nmcli connection modify ens1f0 sriov.total-vfs 2</span><br><span class="line">sudo nmcli connection modify ens1f1 sriov.total-vfs 2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> We can <span class="built_in">set</span> the MAC address and <span class="built_in">set</span> the trust on:</span></span><br><span class="line">sudo nmcli connection modify ens1f0 sriov.vfs &#x27;0 mac=b6:4f:02:37:5a:d8 trust=true, 1 mac=26:04:1d:1f:3d:a9 trust=true&#x27;</span><br><span class="line">sudo nmcli connection modify ens1f1 sriov.vfs &#x27;0 mac=76:6c:4e:16:7f:e2 trust=true, 1 mac=6a:f2:bd:97:71:65 trust=true&#x27;</span><br><span class="line">sudo nmcli connection up ens1f0</span><br><span class="line">sudo nmcli connection up ens1f1</span><br></pre></td></tr></table></figure><p>After reboot, check the dmesg.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sudo dmesg | grep -i vf</span><br><span class="line">[    6.599304] i40e 0000:5e:00.0: Allocating 2 VFs.</span><br><span class="line">[    6.680111] i40e 0000:5e:00.1: Allocating 2 VFs.</span><br><span class="line">[    6.730167] iavf: Intel(R) Ethernet Adaptive Virtual Function Network Driver - version 3.2.3-k</span><br><span class="line">&lt;&lt; snip &gt;&gt;</span><br><span class="line">[   17.931493] i40e 0000:5e:00.0: Setting MAC b6:4f:02:37:5a:d8 on VF 0</span><br><span class="line">[   18.111781] i40e 0000:5e:00.0: VF 0 is now trusted</span><br><span class="line">[   18.112559] i40e 0000:5e:00.0: Setting MAC 26:04:1d:1f:3d:a9 on VF 1</span><br><span class="line">[   18.291464] i40e 0000:5e:00.0: VF 1 is now trusted</span><br><span class="line">[   18.292231] i40e 0000:5e:00.1: Setting MAC 76:6c:4e:16:7f:e2 on VF 0</span><br><span class="line">[   18.475259] i40e 0000:5e:00.1: VF 0 is now trusted</span><br><span class="line">[   18.475929] i40e 0000:5e:00.1: Setting MAC 6a:f2:bd:97:71:65 on VF 1</span><br><span class="line">[   18.659465] i40e 0000:5e:00.1: VF 1 is now trusted</span><br><span class="line">[   18.728124] iavf 0000:5e:02.0 ens1f0v0: NIC Link is Up Speed is 25 Gbps Full Duplex</span><br><span class="line">[   18.752275] iavf 0000:5e:02.1 ens1f0v1: NIC Link is Up Speed is 25 Gbps Full Duplex</span><br><span class="line">[   18.776329] iavf 0000:5e:0a.0 ens1f1v0: NIC Link is Up Speed is 25 Gbps Full Duplex</span><br><span class="line">[   18.800569] iavf 0000:5e:0a.1 ens1f1v1: NIC Link is Up Speed is 25 Gbps Full Duplex</span><br></pre></td></tr></table></figure><h2 id="4-Check-the-VFs"><a href="#4-Check-the-VFs" class="headerlink" title="(4) Check the VFs"></a>(4) Check the VFs</h2><p>You can check the VFs from lspci or ip link commands.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ sudo lspci | grep -i Virtual</span><br><span class="line">ubuntu@ubuntu-kvm:~$ sudo ip link show | grep -B2 vf</span><br></pre></td></tr></table></figure><p>Good news is that the VFs names are well related to the physical NICs. For example, <strong>ens1f0v1</strong> is one of the VFs of the physical NIC <strong>ens1f0</strong> .</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ ip link show | grep -E ens1f[0,1]v[0,1] -A 1</span><br><span class="line">9: ens1f0v1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether 26:04:1d:1f:3d:a9 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">10: ens1f1v1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether 6a:f2:bd:97:71:65 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">15: ens1f0v0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether b6:4f:02:37:5a:d8 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">16: ens1f1v0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class="line">link/ether 76:6c:4e:16:7f:e2 brd ff:ff:ff:ff:ff:ff</span><br></pre></td></tr></table></figure><p>We can change the MTU to <strong>9216</strong> (or you may not need 9216, 1504 is enough).</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo nmcli connection modify ens1f0v0 ethernet.mtu 9216 ipv4.method disabled</span><br><span class="line">sudo nmcli connection modify ens1f0v1 ethernet.mtu 9216 ipv4.method disabled</span><br><span class="line">sudo nmcli connection modify ens1f1v0 ethernet.mtu 9216 ipv4.method disabled</span><br><span class="line">sudo nmcli connection modify ens1f1v1 ethernet.mtu 9216 ipv4.method disabled</span><br><span class="line">sudo nmcli connection up ens1f0v0 </span><br><span class="line">sudo nmcli connection up ens1f0v1</span><br><span class="line">sudo nmcli connection up ens1f1v0</span><br><span class="line">sudo nmcli connection up ens1f1v1</span><br></pre></td></tr></table></figure><p>The above configs will survive after reboot.</p><h1 id="Create-SR-IOV-Virtual-Network-Adapter-Pool"><a href="#Create-SR-IOV-Virtual-Network-Adapter-Pool" class="headerlink" title="Create SR-IOV Virtual Network Adapter Pool"></a>Create SR-IOV Virtual Network Adapter Pool</h1><p>Using this method, KVM creates a pool of network devices that can be inserted into VMs, and the size of that pool is determined by how many VFs were created on the physical function when they were initialized.</p><h2 id="1-Create-an-xml-file"><a href="#1-Create-an-xml-file" class="headerlink" title="(1) Create an xml file"></a>(1) Create an xml file</h2><p>ubuntu@ubuntu-kvm:~/kvm$ cat ens1f0_sriov_pool.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">network</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">name</span>&gt;</span>ens1f0_sriov_pool<span class="tag">&lt;/<span class="name">name</span>&gt;</span> <span class="comment">&lt;!-- This is the name of the file you created --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">forward</span> <span class="attr">mode</span>=<span class="string">&#x27;hostdev&#x27;</span> <span class="attr">managed</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">pf</span> <span class="attr">dev</span>=<span class="string">&#x27;ens1f0&#x27;</span>/&gt;</span>  <span class="comment">&lt;!-- Use the netdev name of your SR-IOV devices PF here --&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">forward</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">network</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="2-Define-a-network-and-set-to-auto-start"><a href="#2-Define-a-network-and-set-to-auto-start" class="headerlink" title="(2) Define a network and set to auto start."></a>(2) Define a network and set to auto start.</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">virsh net-define ens1f0_sriov_pool.xml</span><br><span class="line">Sleep 1</span><br><span class="line">virsh net-start ens1f0_sriov_pool</span><br><span class="line">virsh net-autostart ens1f0_sriov_pool</span><br></pre></td></tr></table></figure><p>ubuntu@ubuntu-kvm:~/kvm$ virsh net-dumpxml ens1f0_sriov_pool</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">network</span> <span class="attr">connections</span>=<span class="string">&#x27;1&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>ens1f0_sriov_pool<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>9125a600-6620-4ab6-9a47-8844a61b0918<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">forward</span> <span class="attr">mode</span>=<span class="string">&#x27;hostdev&#x27;</span> <span class="attr">managed</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pf</span> <span class="attr">dev</span>=<span class="string">&#x27;ens1f0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x5e&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x5e&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x1&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">forward</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">network</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="3-Select-the-virtual-adapter-from-the-pool"><a href="#3-Select-the-virtual-adapter-from-the-pool" class="headerlink" title="(3) Select the virtual adapter from the pool"></a>(3) Select the virtual adapter from the pool</h2><p>It is simple to add an SR-IOV NIC, as follow:</p><img src="/csr1kv-kvm-Ubuntu20-04-md/pic1-sriov-pool.png" class="" title="SRIOV Adapter Pool"><p>This is equivalent to the following XML:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;network&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;52:54:00:0b:a5:2e&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">source</span> <span class="attr">network</span>=<span class="string">&#x27;ens1f0_sriov_pool&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br></pre></td></tr></table></figure><p>After the VM powered on, the network info is as follow:<br>virsh dumpxml CSR1KV-1</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;hostdev&#x27;</span> <span class="attr">managed</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;52:54:00:0b:a5:2e&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;vfio&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x5e&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;hostdev0&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="Create-the-CSR1KV-VM-from-virt-manager"><a href="#Create-the-CSR1KV-VM-from-virt-manager" class="headerlink" title="Create the CSR1KV VM from virt-manager"></a>Create the CSR1KV VM from virt-manager</h1><p>From the virt-manager, create a CSR1KV virtual machine step by step, and choose the virtual network interface from the SR-IOV pool.</p><img src="/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step1.png" class="" title="Virt-manager step 1"><img src="/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step2.png" class="" title="Virt-manager Step 2"><img src="/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step2-2.png" class="" title="Virt-manager Step2-2"><img src="/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step3.png" class="" title="Virt-manager Step 3"><img src="/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step4.png" class="" title="Virt-manager Step 4"><p>Note: The first interface of csr1kv-1 is configured to <strong>macvtap Bridge mode</strong>, so you do not need to create a Linux bridge. However, csr1kv-1 can not communicate to the Linux host through this interface, but it can go out of the Linux host through the eno1. This is a known issue with macvtap.</p><img src="/csr1kv-kvm-Ubuntu20-04-md/add-sriov-pool.png" class="" title="Virt-manager Step 5"><p>After select the Virtual Network Interface, click the <strong>Begin Installation</strong>, and you can shut down the virtual machine.<br>The actions above will create the <strong>csr1kv-1.xml</strong> file under the directory: <strong>/etc/libvirtd/qemu/</strong></p><h1 id="KVM-Performance-Tunning"><a href="#KVM-Performance-Tunning" class="headerlink" title="KVM Performance Tunning"></a>KVM Performance Tunning</h1><p>KVM performance tuning are related to NUMA, Memory Hugepage and vCPU pinning. The main reference is Redhat Linux 7 PERFORMANCE TUNING GUIDE</p><p>We will use <strong>virsh edit csr1kv-1</strong> to do the performance tuning.</p><h2 id="1-Check-the-capability-of-the-platform"><a href="#1-Check-the-capability-of-the-platform" class="headerlink" title="(1) Check the capability of the platform"></a>(1) Check the capability of the platform</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ virsh nodeinfo</span><br><span class="line">CPU model:           x86_64</span><br><span class="line">CPU(s):              88</span><br><span class="line">CPU frequency:       1000 MHz</span><br><span class="line">CPU socket(s):       1</span><br><span class="line">Core(s) per socket:  22</span><br><span class="line">Thread(s) per core:  2</span><br><span class="line">NUMA cell(s):        2</span><br><span class="line">Memory size:         394929928 KiB</span><br></pre></td></tr></table></figure><p>[1]:ubuntu@ubuntu-kvm:~$ virsh capabilities</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">capabilities</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">host</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>a24f9760-48f1-f34e-a001-a848f08df7bb<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">cpu</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">arch</span>&gt;</span>x86_64<span class="tag">&lt;/<span class="name">arch</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span>&gt;</span>Cascadelake-Server-noTSX<span class="tag">&lt;/<span class="name">model</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">vendor</span>&gt;</span>Intel<span class="tag">&lt;/<span class="name">vendor</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">microcode</span> <span class="attr">version</span>=<span class="string">&#x27;83898371&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">counter</span> <span class="attr">name</span>=<span class="string">&#x27;tsc&#x27;</span> <span class="attr">frequency</span>=<span class="string">&#x27;2095078000&#x27;</span> <span class="attr">scaling</span>=<span class="string">&#x27;no&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">topology</span> <span class="attr">sockets</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">cores</span>=<span class="string">&#x27;22&#x27;</span> <span class="attr">threads</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>From the outputs, we can get the cores of CPU, the NUMA info and the hugepages.</p><h2 id="2-NUMA-Info"><a href="#2-NUMA-Info" class="headerlink" title="(2) NUMA Info"></a>(2) NUMA Info</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ numactl --hardware</span><br><span class="line">available: 2 nodes (0-1)</span><br><span class="line">node 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65</span><br><span class="line">node 0 size: 192172 MB</span><br><span class="line">node 0 free: 152956 MB</span><br><span class="line">node 1 cpus: 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87</span><br><span class="line">node 1 size: 193500 MB</span><br><span class="line">node 1 free: 158037 MB</span><br><span class="line">node distances:</span><br><span class="line">node   0   1</span><br><span class="line">  0:  10  21</span><br><span class="line">  1:  21  10 </span><br></pre></td></tr></table></figure><p>Two CPUs, each has 192GB memory, the NUMA node are node 0 and node 1.</p><p>You can also check the NUMA info of the NIC, as follow:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ sudo lspci -vv | grep Ethernet -A 6</span><br><span class="line">5e:00.0 Ethernet controller: Intel Corporation Ethernet Controller XXV710 for 25GbE SFP28 (rev 02)</span><br><span class="line">    Subsystem: Cisco Systems Inc Ethernet Network Adapter XXV710</span><br><span class="line">    Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr+ Stepping- SERR+ FastB2B- DisINTx+</span><br><span class="line">    Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx-</span><br><span class="line">    Latency: 0, Cache Line Size: 32 bytes</span><br><span class="line">    Interrupt: pin A routed to IRQ 137</span><br><span class="line">    NUMA node: 0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">Or you can find the numa infor from udevadm.</span></span><br><span class="line">ubuntu@ubuntu-kvm:~$ sudo udevadm info -ap /sys/class/net/ens1f0 | grep numa</span><br><span class="line">    ATTRS&#123;numa_node&#125;==&quot;0&quot;</span><br><span class="line">    ATTRS&#123;numa_node&#125;==&quot;0&quot;</span><br></pre></td></tr></table></figure><p>If the memory and NICs are all on numa_node 0, that would be more efficient. Please check the server’s PCI-E slots mapping with the CPU slots.</p><h2 id="3-HugePage-and-Transparent-Hugepage"><a href="#3-HugePage-and-Transparent-Hugepage" class="headerlink" title="(3) HugePage and Transparent Hugepage"></a>(3) HugePage and Transparent Hugepage</h2><p>To check the memory info</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ cat /proc/meminfo | grep Huge</span><br><span class="line">AnonHugePages:    133120 kB</span><br><span class="line">ShmemHugePages:        0 kB</span><br><span class="line">FileHugePages:         0 kB</span><br><span class="line">HugePages_Total:      64</span><br><span class="line">HugePages_Free:       56</span><br><span class="line">HugePages_Rsvd:        0</span><br><span class="line">HugePages_Surp:        0</span><br><span class="line">Hugepagesize:    1048576 kB</span><br><span class="line">Hugetlb:        67108864 kB</span><br></pre></td></tr></table></figure><p>You can change the hugepages on the run time：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ cat /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages</span><br><span class="line">32</span><br><span class="line">sudo su -     // switch to root user.</span><br><span class="line">root@ubuntu-kvm:~# echo 64 &gt; /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages</span><br><span class="line">root@ubuntu-kvm:~# echo 64 &gt; /sys/devices/system/node/node1/hugepages/hugepages-1048576kB/nr_hugepages</span><br></pre></td></tr></table></figure><p>Check and configure the transparent_hugepage:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-kvm:~# echo always &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line">cat /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line">[always] madvise never</span><br></pre></td></tr></table></figure><h2 id="4-vCPU-Pinning"><a href="#4-vCPU-Pinning" class="headerlink" title="(4) vCPU Pinning"></a>(4) vCPU Pinning</h2><p>vCPU pinning can improve the cache meet rate and improve the performance.<br>You can check the vcpu pinning.<br><strong>virsh vcpuinfo csr1kv-1</strong></p><h2 id="5-Edit-the-XML-file-of-the-CSR1KV"><a href="#5-Edit-the-XML-file-of-the-CSR1KV" class="headerlink" title="(5) Edit the XML file of the CSR1KV"></a>(5) Edit the XML file of the CSR1KV</h2><p>Run virsh edit csr1kv-1 to edit the parameters.<br>Please pay attention to the following texts, other parameters might be different.</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">memoryBacking</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">hugepages</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">page</span> <span class="attr">size</span>=<span class="string">&#x27;1048576&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">hugepages</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">locked</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">nosharepages</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">memoryBacking</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">vcpu</span> <span class="attr">placement</span>=<span class="string">&#x27;static&#x27;</span>&gt;</span>8<span class="tag">&lt;/<span class="name">vcpu</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">cputune</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;3&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;4&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;5&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;5&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;6&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;6&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;7&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;7&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;8&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">emulatorpin</span> <span class="attr">cpuset</span>=<span class="string">&#x27;45-52&#x27;</span>/&gt;</span> <span class="comment">&lt;!-- If Hyper-threading were enabled --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cputune</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">numatune</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">memory</span> <span class="attr">mode</span>=<span class="string">&#x27;strict&#x27;</span> <span class="attr">nodeset</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">numatune</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">cpu</span> <span class="attr">mode</span>=<span class="string">&#x27;host-passthrough&#x27;</span> <span class="attr">check</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">memballoon</span> <span class="attr">model</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>Please note that, if hyper-threading is enabled in BIOS setting, the parameter “emulatorpin” should be set, the cpuset are from the “virsh capabilities”, for example, siblings=’1,45’. When the core 1 is pinned, core 45 should be set in emulatorpin.</p><p>From the guide <a href="https://libvirt.org/formatdomain.html">https://libvirt.org/formatdomain.html</a> and <a href="https://libvirt.org/kbase/kvm-realtime.html">https://libvirt.org/kbase/kvm-realtime.html</a> we set the CPU and memory tuning parameters as the highlighted text.</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">domain</span> <span class="attr">type</span>=<span class="string">&#x27;kvm&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>csr1kv-1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>83f90c1c-f0ea-4298-bcdf-3d676de2aeb4<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">metadata</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">libosinfo:libosinfo</span> <span class="attr">xmlns:libosinfo</span>=<span class="string">&quot;http://libosinfo.org/xmlns/libvirt/domain/1.0&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">libosinfo:os</span> <span class="attr">id</span>=<span class="string">&quot;http://centos.org/centos/7.0&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">libosinfo:libosinfo</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">metadata</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">memory</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>&gt;</span>8388608<span class="tag">&lt;/<span class="name">memory</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">currentMemory</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>&gt;</span>8388608<span class="tag">&lt;/<span class="name">currentMemory</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">memoryBacking</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hugepages</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">page</span> <span class="attr">size</span>=<span class="string">&#x27;1048576&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">hugepages</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">locked</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">nosharepages</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">memoryBacking</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpu</span> <span class="attr">placement</span>=<span class="string">&#x27;static&#x27;</span>&gt;</span>8<span class="tag">&lt;/<span class="name">vcpu</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">cputune</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;3&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;4&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;5&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;5&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;6&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;6&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;7&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;7&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;8&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">emulatorpin</span> <span class="attr">cpuset</span>=<span class="string">&#x27;45-52&#x27;</span>/&gt;</span> <span class="comment">&lt;!-- If Hyper-threading were enabled --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">cputune</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">numatune</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">memory</span> <span class="attr">mode</span>=<span class="string">&#x27;strict&#x27;</span> <span class="attr">nodeset</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">numatune</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">os</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span> <span class="attr">arch</span>=<span class="string">&#x27;x86_64&#x27;</span> <span class="attr">machine</span>=<span class="string">&#x27;pc-q35-4.2&#x27;</span>&gt;</span>hvm<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">boot</span> <span class="attr">dev</span>=<span class="string">&#x27;hd&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">os</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">features</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">acpi</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">apic</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vmport</span> <span class="attr">state</span>=<span class="string">&#x27;off&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">features</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">cpu</span> <span class="attr">mode</span>=<span class="string">&#x27;host-passthrough&#x27;</span> <span class="attr">check</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">clock</span> <span class="attr">offset</span>=<span class="string">&#x27;utc&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">timer</span> <span class="attr">name</span>=<span class="string">&#x27;rtc&#x27;</span> <span class="attr">tickpolicy</span>=<span class="string">&#x27;catchup&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">timer</span> <span class="attr">name</span>=<span class="string">&#x27;pit&#x27;</span> <span class="attr">tickpolicy</span>=<span class="string">&#x27;delay&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">timer</span> <span class="attr">name</span>=<span class="string">&#x27;hpet&#x27;</span> <span class="attr">present</span>=<span class="string">&#x27;no&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">clock</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">on_poweroff</span>&gt;</span>destroy<span class="tag">&lt;/<span class="name">on_poweroff</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">on_reboot</span>&gt;</span>restart<span class="tag">&lt;/<span class="name">on_reboot</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">on_crash</span>&gt;</span>destroy<span class="tag">&lt;/<span class="name">on_crash</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">pm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">suspend-to-mem</span> <span class="attr">enabled</span>=<span class="string">&#x27;no&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">suspend-to-disk</span> <span class="attr">enabled</span>=<span class="string">&#x27;no&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">pm</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">devices</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">emulator</span>&gt;</span>/usr/bin/qemu-system-x86_64<span class="tag">&lt;/<span class="name">emulator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;file&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;disk&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;qcow2&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">&#x27;/var/lib/libvirt/images/csr1000v-universalk9.17.02.01v.qcow2&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;vda&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x05&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;qemu-xhci&#x27;</span> <span class="attr">ports</span>=<span class="string">&#x27;15&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x03&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;sata&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x1f&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pcie-root&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">chassis</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0x10&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span> <span class="attr">multifunction</span>=<span class="string">&#x27;on&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">chassis</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0x11&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">chassis</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0x12&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">chassis</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0x13&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x3&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;5&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">chassis</span>=<span class="string">&#x27;5&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0x14&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x4&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;6&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">chassis</span>=<span class="string">&#x27;6&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0x15&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x5&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;7&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">chassis</span>=<span class="string">&#x27;7&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0x16&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x6&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;8&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">chassis</span>=<span class="string">&#x27;8&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0x17&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x7&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;virtio-serial&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x04&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;direct&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;52:54:00:69:ec:73&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">dev</span>=<span class="string">&#x27;eno1&#x27;</span> <span class="attr">mode</span>=<span class="string">&#x27;bridge&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x01&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;network&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;52:54:00:0b:a5:2e&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">network</span>=<span class="string">&#x27;ens1f0_sriov_pool&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;network&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;52:54:00:bd:9f:54&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">network</span>=<span class="string">&#x27;ens1f1_sriov_pool&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x08&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">serial</span> <span class="attr">type</span>=<span class="string">&#x27;pty&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;isa-serial&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;isa-serial&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">serial</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">console</span> <span class="attr">type</span>=<span class="string">&#x27;pty&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;serial&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">console</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">channel</span> <span class="attr">type</span>=<span class="string">&#x27;unix&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;org.qemu.guest_agent.0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;virtio-serial&#x27;</span> <span class="attr">controller</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">channel</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">channel</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;com.redhat.spice.0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;virtio-serial&#x27;</span> <span class="attr">controller</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">channel</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;mouse&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;ps2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;keyboard&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;ps2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">graphics</span> <span class="attr">type</span>=<span class="string">&#x27;spice&#x27;</span> <span class="attr">autoport</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">listen</span> <span class="attr">type</span>=<span class="string">&#x27;address&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">image</span> <span class="attr">compression</span>=<span class="string">&#x27;off&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">graphics</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">video</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;qxl&#x27;</span> <span class="attr">ram</span>=<span class="string">&#x27;65536&#x27;</span> <span class="attr">vram</span>=<span class="string">&#x27;65536&#x27;</span> <span class="attr">vgamem</span>=<span class="string">&#x27;16384&#x27;</span> <span class="attr">heads</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">primary</span>=<span class="string">&#x27;yes&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x01&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;3&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">memballoon</span> <span class="attr">model</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">devices</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br></pre></td></tr></table></figure><p>The parameters are from <a href="https://www.cisco.com/c/en/us/td/docs/routers/csr1000/software/configuration/b_CSR1000v_Configuration_Guide/b_CSR1000v_Configuration_Guide_chapter_0101.html#con_1313827">Cisco CSR 1000v and Cisco ISRv Software Configuration Guide</a><br>After you install the CSR1000v, and edit the XML file, you can run virsh to create the csr1kv.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/libvirtd/qemu</span><br><span class="line">virsh define csr1kv-1.xml</span><br><span class="line">virsh start csr1kv-1</span><br></pre></td></tr></table></figure><h2 id="6-Check-CSR1000v’s-tunning"><a href="#6-Check-CSR1000v’s-tunning" class="headerlink" title="(6) Check CSR1000v’s tunning"></a>(6) Check CSR1000v’s tunning</h2><p>ubuntu@ubuntu-kvm:/etc/libvirt/qemu$ virsh list</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"> Id   Name       State</span><br><span class="line">--------------------------</span><br><span class="line"></span><br><span class="line"> 1    csr1kv-1   running</span><br><span class="line"></span><br><span class="line">ubuntu@ubuntu-kvm:/etc/libvirt/qemu$ virsh vcpuinfo 1</span><br><span class="line">VCPU:           0</span><br><span class="line">CPU:            1</span><br><span class="line">State:          running</span><br><span class="line">CPU time:       167.0s</span><br><span class="line">CPU Affinity:   -y--------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">VCPU:           1</span><br><span class="line">CPU:            2</span><br><span class="line">State:          running</span><br><span class="line">CPU time:       193.3s</span><br><span class="line">CPU Affinity:   --y-------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">VCPU:           2</span><br><span class="line">CPU:            3</span><br><span class="line">State:          running</span><br><span class="line">CPU time:       152.5s</span><br><span class="line">CPU Affinity:   ---y------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">VCPU:           3</span><br><span class="line">CPU:            4</span><br><span class="line">State:          running</span><br><span class="line">CPU time:       174.3s</span><br><span class="line">CPU Affinity:   ----y-----------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">VCPU:           4</span><br><span class="line">CPU:            5</span><br><span class="line">State:          running</span><br><span class="line">CPU time:       260.6s</span><br><span class="line">CPU Affinity:   -----y----------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">VCPU:           5</span><br><span class="line">CPU:            6</span><br><span class="line">State:          running</span><br><span class="line">CPU time:       386.0s</span><br><span class="line">CPU Affinity:   ------y---------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">VCPU:           6</span><br><span class="line">CPU:            7</span><br><span class="line">State:          running</span><br><span class="line">CPU time:       2189.9s</span><br><span class="line">CPU Affinity:   -------y--------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">VCPU:           7</span><br><span class="line">CPU:            8</span><br><span class="line">State:          running</span><br><span class="line">CPU time:       2192.2s</span><br><span class="line">CPU Affinity:   --------y-------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure><p>From the above outputs, we can find that the vCPUa are pinned to NO. 1 to 8 CPU cores.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ sudo numastat -c qemu</span><br><span class="line">Per-node process memory usage (in MBs)</span><br><span class="line">PID              Node 0 Node 1 Total</span><br><span class="line"></span><br><span class="line">---------------  ------ ------ -----</span><br><span class="line"></span><br><span class="line">4391 (qemu-syste   8373      0  8373</span><br><span class="line">5891 (sudo)           4      1     5</span><br><span class="line"></span><br><span class="line">---------------  ------ ------ -----</span><br><span class="line"></span><br><span class="line">Total              8377      1  8377</span><br><span class="line"></span><br><span class="line">ubuntu@ubuntu-kvm:~$ sudo numastat -p 4391</span><br><span class="line">Per-node process memory usage (in MBs) for PID 4391 (qemu-system-x86)</span><br><span class="line">                           Node 0          Node 1           Total</span><br><span class="line">                  --------------- --------------- ---------------</span><br><span class="line">Huge                      8192.00            0.00         8192.00</span><br><span class="line">Heap                        10.00            0.00           10.00</span><br><span class="line">Stack                        0.03            0.00            0.03</span><br><span class="line">Private                    170.70            0.15          170.85</span><br><span class="line"></span><br><span class="line">----------------  --------------- --------------- ---------------</span><br><span class="line"></span><br><span class="line">Total                     8372.73            0.16         8372.88</span><br></pre></td></tr></table></figure><p>From the above outputs, the csr1kv-1 are using the memories from node 0.</p><h2 id="7-Check-the-vNIC-in-CSR1KV"><a href="#7-Check-the-vNIC-in-CSR1KV" class="headerlink" title="(7) Check the vNIC in CSR1KV"></a>(7) Check the vNIC in CSR1KV</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">csr1kv-1#show platform software vnic-if interface-mapping</span><br><span class="line">-------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"> Interface Name        Driver Name         Mac Addr</span><br><span class="line">-------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"> GigabitEthernet3       net_i40e_vf        5254.00bd.9f54</span><br><span class="line"> GigabitEthernet2       net_i40e_vf        5254.000b.a52e</span><br><span class="line"> GigabitEthernet1       net_virtio         5254.0069.ec73</span><br></pre></td></tr></table></figure><p>The Driver Name net_i40e_vf indicates that the vNIC is a VF from the SR-IOV pool.</p><h1 id="CSR-1000v-initial-configuration-and-Smart-License-registration"><a href="#CSR-1000v-initial-configuration-and-Smart-License-registration" class="headerlink" title="CSR 1000v initial configuration and Smart License registration"></a>CSR 1000v initial configuration and Smart License registration</h1><h2 id="1-CSR-1000v-initial-config-example"><a href="#1-CSR-1000v-initial-config-example" class="headerlink" title="(1) CSR 1000v initial config example"></a>(1) CSR 1000v initial config example</h2><p>Part of the configuration:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">CSR1000v-1#show sdwan running-config</span><br><span class="line">system</span><br><span class="line"> system-ip             1.1.10.1</span><br><span class="line"> site-id               101</span><br><span class="line"> sp-organization-name  CiscoBJ</span><br><span class="line"> organization-name     CiscoBJ</span><br><span class="line"> vbond 10.75.58.51 port 12346</span><br><span class="line">!</span><br><span class="line">hostname CSR1000v-1</span><br><span class="line">username admin privilege 15 secret 9 $9$4&#x2F;QL2V2K4&#x2F;6H1k$XUmRNf.T7t3KDOj&#x2F;FmoNexpEypCxr482dExXHDnohSI</span><br><span class="line">ip name-server 64.104.123.245</span><br><span class="line">ip route 0.0.0.0 0.0.0.0 10.75.59.1</span><br><span class="line"></span><br><span class="line">interface GigabitEthernet1</span><br><span class="line"> no shutdown</span><br><span class="line"> arp timeout 1200</span><br><span class="line"> ip address 10.75.59.35 255.255.255.0</span><br><span class="line"> no ip redirects</span><br><span class="line"> ip mtu    1500</span><br><span class="line"> mtu 1500</span><br><span class="line"> negotiation auto</span><br><span class="line">exit</span><br><span class="line"></span><br><span class="line">interface Tunnel1</span><br><span class="line"> no shutdown</span><br><span class="line"> ip unnumbered GigabitEthernet1</span><br><span class="line"> no ip redirects</span><br><span class="line"> ipv6 unnumbered GigabitEthernet1</span><br><span class="line"> no ipv6 redirects</span><br><span class="line"> tunnel source GigabitEthernet1</span><br><span class="line"> tunnel mode sdwan</span><br><span class="line">exit</span><br><span class="line"></span><br><span class="line">clock timezone CST 8 0</span><br><span class="line">ntp server x.x.x.x version 4</span><br><span class="line"></span><br><span class="line">sdwan</span><br><span class="line"> interface GigabitEthernet1</span><br><span class="line">  tunnel-interface</span><br><span class="line">   encapsulation ipsec</span><br><span class="line">   allow-service sshd</span><br><span class="line">  exit</span><br></pre></td></tr></table></figure><h2 id="2-Commands-to-check-the-status"><a href="#2-Commands-to-check-the-status" class="headerlink" title="(2) Commands to check the status"></a>(2) Commands to check the status</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">show sdwan control local-properties</span><br><span class="line">show sdwan control connections</span><br><span class="line">show sdwan control connection-history</span><br><span class="line">show sdwan running-config</span><br><span class="line">show sdwan bfd sessions</span><br><span class="line">show sdwan omp peers</span><br><span class="line">show sdwan omp routes</span><br></pre></td></tr></table></figure><h2 id="3-CSR-1000v-Smart-License-Registration"><a href="#3-CSR-1000v-Smart-License-Registration" class="headerlink" title="(3) CSR 1000v Smart License Registration"></a>(3) CSR 1000v Smart License Registration</h2><p>Before Smart License registration, you need ：</p><ol><li>CSR 1000v’s control connections are up；</li><li>Configure ip http client source-interface GigabitEthernet2</li><li>If the version is 16.12.x and bellow, you need to allow service all<br><code>sdwan interface GigabitEthernet2 tunnel-interface allow-service all </code><br>In the 17.2.x and above versions, there is an allow-service https</li><li>CSR 1000v can access URL：<a href="https://tools.cisco.com/its/service/oddce/services/DDCEService">https://tools.cisco.com/its/service/oddce/services/DDCEService</a><br>The command license smart register idtoken xxxxxx will do the registration.<br>You can find the idtoken from your Smart Account smart license inventory.<br>show license status to check the status.</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CSR1000v-1#show platform hardware throughput level</span><br><span class="line">The current throughput level is 200000000 kb&#x2F;s</span><br></pre></td></tr></table></figure><h1 id="Performances-and-limitations"><a href="#Performances-and-limitations" class="headerlink" title="Performances and limitations"></a>Performances and limitations</h1><h2 id="1-The-performance-of-the-SR-IOV"><a href="#1-The-performance-of-the-SR-IOV" class="headerlink" title="(1) The performance of the SR-IOV"></a>(1) The performance of the SR-IOV</h2><p>A performance test was done after the SR-IOV setup, the CSR1KV was configured as 8vCPU and 8G Memory, the packet drop rate was 0%.</p><table><thead><tr><th>Packet Site</th><th>SDWAN Performance (Mbps)</th><th>CEF Performance (Mbps)</th></tr></thead><tbody><tr><td>128Bytes</td><td>800</td><td>2843.75</td></tr><tr><td>256Bytes</td><td>1431.26</td><td>6500.00</td></tr><tr><td>512Bytes</td><td>2581.26</td><td>10578.13</td></tr><tr><td>1024Bytes</td><td>3731.26</td><td>15500.00</td></tr><tr><td>1400Bytes</td><td>4306.26</td><td>18171.88</td></tr></tbody></table><img src="/csr1kv-kvm-Ubuntu20-04-md/line-chart.png" class="" title="Performance Line Chart"><p>Note: <strong>These test results are not to represent the official performance data. Different servers and network cards may have different test results. The above data is for demo only.</strong></p><h2 id="2-The-limitation-of-the-SR-IOV"><a href="#2-The-limitation-of-the-SR-IOV" class="headerlink" title="(2) The limitation of the SR-IOV"></a>(2) The limitation of the SR-IOV</h2><p>The main limitation of the SR-IOV is the number of VLANs on each VF, the maximum VLAN of an VF is limited to 63 in ixgbevf.<br>So, the active number of sub-interfaces on an interface of the CSR1KV that uses the SRIOV VFs is limited to 63.<br>There is some notes in the Cisco CSR 1000v and Cisco ISRv Software Configuration Guide:</p><blockquote><p>SR-IOV (ixgbevf)<br>Maximum VLANs: The maximum number of VLANs supported on PF is 64. Together, all VFs can have a total of 64 VLANs. (Intel limitation.)</p><p>SR-IOV (i40evf)<br>Maximum VLANs: The maximum number of VLANs supported on PF is 512. Together, all VFs can have a total of 512 VLANs. (Intel limitation.) Per-VF resources are managed by the PF (host) device driver.</p></blockquote><h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/performance_tuning_guide/index">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/performance_tuning_guide/index</a></p><p><a href="https://computingforgeeks.com/how-to-create-and-configure-bridge-networking-for-kvm-in-linux/">https://computingforgeeks.com/how-to-create-and-configure-bridge-networking-for-kvm-in-linux/</a></p><p><a href="https://software.intel.com/content/www/us/en/develop/articles/configure-sr-iov-network-virtual-functions-in-linux-kvm.html">https://software.intel.com/content/www/us/en/develop/articles/configure-sr-iov-network-virtual-functions-in-linux-kvm.html</a></p><p><a href="https://linuxconfig.org/install-and-set-up-kvm-on-ubuntu-20-04-focal-fossa-linux">https://linuxconfig.org/install-and-set-up-kvm-on-ubuntu-20-04-focal-fossa-linux</a></p><p><a href="https://kifarunix.com/how-to-fix-qemu-kvm-not-connected-error-on-ubuntu-20-04/">https://kifarunix.com/how-to-fix-qemu-kvm-not-connected-error-on-ubuntu-20-04/</a></p><p><a href="https://linuxconfig.org/how-to-disable-apparmor-on-ubuntu-20-04-focal-fossa-linux">https://linuxconfig.org/how-to-disable-apparmor-on-ubuntu-20-04-focal-fossa-linux</a></p><p><strong>CSR1000v SD-WAN Installation on KVM</strong> by Jean-Marc Barozet</p><h1 id="Scripts-and-XML-Example-Files"><a href="#Scripts-and-XML-Example-Files" class="headerlink" title="Scripts and XML Example Files"></a>Scripts and XML Example Files</h1><ol><li><a href="https://raw.githubusercontent.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/main/kvm/1.2-install-ubuntu-kvm.sh">Ubuntu and KVM installation and setting</a></li><li><a href="https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/1.3-nic-settings.sh">NIC Settings with nmcli</a></li><li><a href="https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/2.1-check-nic-sriov.sh">Check NIC SRIOV Capabilities</a></li><li><a href="https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/2.2-change-grub.sh">GRUB Settings</a></li><li><a href="https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/2.3-sriov-setting.sh">SRIOV Settings</a></li><li><a href="https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/2.4-check-vfs.sh">Check VFs</a></li><li><a href="https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/3.0-create-sriov-pool.sh">Create SRIOV Adapter Pool</a></li><li><a href="https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/4.0-kvm-tuning.sh">KVM Tuning</a></li><li><a href="https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/4.1-check-csr1kv.sh">Check CSR1000v Tuning</a></li><li><a href="https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/ens1f0_sriov_pool.xml">ens1f0_sriov_pool.xml</a></li><li><a href="https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/csr1kv-1.xml">csr1kv-1.xml</a></li></ol>]]></content>
    
    
    <summary type="html">This guide provides the steps on how to install CSR1000v/Catalyst 8000v on KVM, the setting of SRIOV and KVM tuning.</summary>
    
    
    
    
    <category term="CSR1000v" scheme="https://weiborao.link/tags/CSR1000v/"/>
    
    <category term="KVM" scheme="https://weiborao.link/tags/KVM/"/>
    
    <category term="SRIOV" scheme="https://weiborao.link/tags/SRIOV/"/>
    
    <category term="NetworkManager" scheme="https://weiborao.link/tags/NetworkManager/"/>
    
  </entry>
  
  <entry>
    <title>CSR 1000v KVM SRIOV CentOS 7安装设置指南</title>
    <link href="https://weiborao.link/csr1kv-kvm-CentOS7.html"/>
    <id>https://weiborao.link/csr1kv-kvm-CentOS7.html</id>
    <published>2021-02-03T05:58:32.000Z</published>
    <updated>2021-02-05T05:57:29.431Z</updated>
    
    <content type="html"><![CDATA[<p>作者：Rao Weibo</p><p>版本：1.0</p><p>更新日期：20210203</p><p>本文提供在 CentOS 7 版本上安装 KVM，并安装和设置 CSR 1000v/Catalyst 8000v 的指南，内容包括 SRIOV，KVM 调优以及 CSR1KV 初始化配置等内容。</p><h1 id="CentOS7-安装及设置"><a href="#CentOS7-安装及设置" class="headerlink" title="CentOS7 安装及设置"></a>CentOS7 安装及设置</h1><h2 id="（1）BIOS-设置建议"><a href="#（1）BIOS-设置建议" class="headerlink" title="（1）BIOS 设置建议"></a>（1）BIOS 设置建议</h2><table><thead><tr><th align="left">Configuration</th><th align="left">Recommended Setting</th></tr></thead><tbody><tr><td align="left">Intel Hyper-Threading Technology</td><td align="left">Disabled</td></tr><tr><td align="left">Number of Enable Cores</td><td align="left">ALL</td></tr><tr><td align="left">Execute Disable</td><td align="left">Enabled</td></tr><tr><td align="left">Intel VT</td><td align="left">Enabled</td></tr><tr><td align="left">Intel VT-D</td><td align="left">Enabled</td></tr><tr><td align="left">Intel VT-D coherency support</td><td align="left">Enabled</td></tr><tr><td align="left">Intel VT-D ATS support</td><td align="left">Enabled</td></tr><tr><td align="left">CPU Performance</td><td align="left">High throughput</td></tr><tr><td align="left">Hardware Perfetcher</td><td align="left">Disabled</td></tr><tr><td align="left">Adjacent Cache Line Prefetcher</td><td align="left">Disabled</td></tr><tr><td align="left">DCU Streamer Prefetch</td><td align="left">Disable</td></tr><tr><td align="left">Power Technology</td><td align="left">Custom</td></tr><tr><td align="left">Enhanced Intel Speedstep Technology</td><td align="left">Disabled</td></tr><tr><td align="left">Intel Turbo Boost Technology</td><td align="left">Enabled</td></tr><tr><td align="left">Processor Power State C6</td><td align="left">Disabled</td></tr><tr><td align="left">Processor Power State C1 Enhanced</td><td align="left">Disabled</td></tr><tr><td align="left">Frequency Poor Override</td><td align="left">Enabled</td></tr><tr><td align="left">P-State Coordination</td><td align="left">HW_ALL</td></tr><tr><td align="left">Energy Performance</td><td align="left">Performance</td></tr></tbody></table><p>以上建议来自 CSR 1000v 的安装指南。</p><h2 id="（2）CentOS-7-的安装"><a href="#（2）CentOS-7-的安装" class="headerlink" title="（2）CentOS 7 的安装"></a>（2）CentOS 7 的安装</h2><p>在安装的时候选择</p><ul><li>Server with GUI</li><li>Virtualization Client</li><li>Virtualization Hypervisor</li><li>Virtualization Tools</li></ul><p>启动完毕以后关闭 selinux，重启生效。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config</span><br><span class="line"></span><br><span class="line">getenforce//结果为：Enforcing（开启状态）disabled(关闭状态)</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装完后，SSH登录可能显示中文，可修改 .bash_profile</span></span><br><span class="line"></span><br><span class="line">LANG=&quot;en_US.UTF-8&quot;</span><br><span class="line"></span><br><span class="line">export LANG</span><br><span class="line"></span><br><span class="line">source .bash_profile</span><br><span class="line"></span><br><span class="line">egrep -o &#x27;(vmx|svm)&#x27; /proc/cpuinfo | sort | uniq</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注：在生产环境中，需要在服务器连接的交换机以及出口防火墙上做好安全策略。</span></span><br><span class="line"></span><br><span class="line">systemctl stop firewalld</span><br><span class="line"></span><br><span class="line">systemctl disable firewalld</span><br></pre></td></tr></table></figure><p>本文档采用 NetworkManager 配置，故在此并不停用 NetworkManager。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/sysctl.conf</span><br><span class="line"></span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line"></span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 0</span><br><span class="line"></span><br><span class="line">net.bridge.bridge-nf-call-iptables = 0</span><br><span class="line"></span><br><span class="line">net.bridge.bridge-nf-call-arptables = 0</span><br></pre></td></tr></table></figure><p>检查 KVM 组件版本：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# libvirtd -V</span><br><span class="line"></span><br><span class="line">libvirtd (libvirt) 4.5.0</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# /usr/libexec/qemu-kvm --version</span><br><span class="line"></span><br><span class="line">QEMU emulator version 1.5.3 (qemu-kvm-1.5.3-173.el7_8.3), Copyright (c) 2003-2008 Fabrice Bellard</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# virt-manager --version</span><br><span class="line"></span><br><span class="line">1.5.0</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# modinfo kvm-intel</span><br><span class="line"></span><br><span class="line">filename:       /lib/modules/3.10.0-1127.18.2.el7.x86_64/kernel/arch/x86/kvm/kvm-intel.ko.xz</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# modinfo ixgbevf</span><br><span class="line"></span><br><span class="line">filename:       /lib/modules/3.10.0-1127.18.2.el7.x86_64/kernel/drivers/net/ethernet/intel/ixgbevf/ixgbevf.ko.xz</span><br><span class="line"></span><br><span class="line">version:        4.1.0-k-rh7.7</span><br></pre></td></tr></table></figure><h2 id="（3）创建本地-Yum-源（可选）"><a href="#（3）创建本地-Yum-源（可选）" class="headerlink" title="（3）创建本地 Yum 源（可选）"></a>（3）创建本地 Yum 源（可选）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1、备份本地/etc/yum.repos.d 目录下的yum源</span></span><br><span class="line"></span><br><span class="line">cd /etc/yum.repos.d/</span><br><span class="line"></span><br><span class="line">mkdir bak</span><br><span class="line"></span><br><span class="line">mv C* bak/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2、上传CentOS-7-x86_64-Everything-2009.iso镜像到/opt</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3、挂载镜像</span></span><br><span class="line"></span><br><span class="line">mkdir -p /media/cdrom</span><br><span class="line"></span><br><span class="line">mount -t iso9660 -o loop /opt/CentOS-7-x86_64-Everything-2009.iso /media/cdrom/</span><br><span class="line"></span><br><span class="line">mount//查看挂载信息</span><br><span class="line"></span><br><span class="line">df -h</span><br><span class="line"></span><br><span class="line">vi /etc/fstab</span><br><span class="line"></span><br><span class="line">/opt/CentOS-7-x86_64-Everything-2009.iso    /media/cdrom    iso9660 loop 0 0</span><br><span class="line"></span><br><span class="line">tail -1 /etc/fstab//查看是否写入/etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 4、配置本地yum源</span></span><br><span class="line"></span><br><span class="line">cd /etc/yum.repos.d/</span><br><span class="line"></span><br><span class="line">vi local.repo</span><br><span class="line"></span><br><span class="line">[local]</span><br><span class="line"></span><br><span class="line">name=local</span><br><span class="line"></span><br><span class="line">baseurl=file:///media/cdrom   //前面的file://是协议,后面的/media/cdrom是光盘挂载点</span><br><span class="line"></span><br><span class="line">gpgcheck=0//1使用公钥验证rpm包的正确性,0不验证</span><br><span class="line"></span><br><span class="line">enabled=1//1启用yum源,0禁用yum源</span><br><span class="line"></span><br><span class="line">yum install -y numactl telnet</span><br></pre></td></tr></table></figure><p>运行 virt-manager 启动图形化界面。</p><p>如果对 virsh CLI 命令熟悉，可以使用 virsh 命令创建虚拟机。</p><h2 id="（4）服务器网卡配置—NetworkManager-配置"><a href="#（4）服务器网卡配置—NetworkManager-配置" class="headerlink" title="（4）服务器网卡配置—NetworkManager 配置"></a>（4）服务器网卡配置—NetworkManager 配置</h2><p>在终端界面，可以通过 nmtui 打开图形化界面进行设置；以下使用 nmcli 进行设置。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection add con-name eno1 type ethernet autoconnect yes ifname eno1</span><br><span class="line"></span><br><span class="line">nmcli connection modify eno1 ipv4.method manual ipv4.addresses 10.75.58.43/24 ipv4.gateway 10.75.58.1 ipv4.dns 64.104.123.245</span><br><span class="line"></span><br><span class="line">nmcli connection up eno1</span><br><span class="line"></span><br><span class="line">nmcli connection show eno1</span><br><span class="line"></span><br><span class="line">ping 10.75.58.1</span><br></pre></td></tr></table></figure><p>上述命令完成后，在/etc/sysconfig/network-scripts 中会生成网卡的 ifcfg 配置文件。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/sysconfig/network-scripts/ifcfg-eno1</span><br><span class="line"></span><br><span class="line">HWADDR=70:7D:B9:59:5B:AE</span><br><span class="line"></span><br><span class="line">TYPE=Ethernet</span><br><span class="line"></span><br><span class="line">PROXY_METHOD=none</span><br><span class="line"></span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line"></span><br><span class="line">BOOTPROTO=none</span><br><span class="line"></span><br><span class="line">IPADDR=10.75.58.43</span><br><span class="line"></span><br><span class="line">PREFIX=24</span><br><span class="line"></span><br><span class="line">GATEWAY=10.75.58.1</span><br><span class="line"></span><br><span class="line">DNS1=64.104.123.245</span><br><span class="line"></span><br><span class="line">DEFROUTE=yes</span><br><span class="line"></span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line"></span><br><span class="line">IPV6INIT=yes</span><br><span class="line"></span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line"></span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line"></span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line"></span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line"></span><br><span class="line">NAME=eno1</span><br><span class="line"></span><br><span class="line">UUID=2a1c8b39-7f44-321b-a65f-a93e70ab0616</span><br><span class="line"></span><br><span class="line">ONBOOT=yes</span><br><span class="line"></span><br><span class="line">AUTOCONNECT_PRIORITY=-999</span><br><span class="line"></span><br><span class="line">DEVICE=eno1</span><br></pre></td></tr></table></figure><p>此时，可以将 network.service 停止和关闭。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop network</span><br><span class="line"></span><br><span class="line">systemctl disable network</span><br></pre></td></tr></table></figure><p>注意，如果 NetworkManager 未设置妥当，执行 systemctl stop network 后，会导致服务器无法管理。</p><p>准备开启 SRIOV 的网卡设置，以 eno2 为例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection add con-name eno2 <span class="built_in">type</span> ethernet autoconnect yes ifname eno2</span><br><span class="line"></span><br><span class="line">nmcli connection modify eno2 ethernet.mtu 9216 ipv4.method disabled</span><br><span class="line"></span><br><span class="line">nmcli connection up eno2</span><br><span class="line"></span><br><span class="line">nmcli connection show eno2</span><br><span class="line"></span><br><span class="line">ip link show dev eno2</span><br></pre></td></tr></table></figure><p>注：上述 MTU 值设置为 9216 是借鉴自 Cisco NFVIS 平台，如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">CSP5228-1# show pnic-detail mtu</span><br><span class="line"></span><br><span class="line">Name          MTU</span><br><span class="line"></span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">eth0-1        9216</span><br><span class="line"></span><br><span class="line">eth0-2        9216</span><br><span class="line"></span><br><span class="line">eth1-1        9216</span><br><span class="line"></span><br><span class="line">eth1-2        9216</span><br></pre></td></tr></table></figure><h2 id="（5）配置-Linux-网桥-（可选）"><a href="#（5）配置-Linux-网桥-（可选）" class="headerlink" title="（5）配置 Linux 网桥 （可选）"></a>（5）配置 Linux 网桥 （可选）</h2><p>网桥 br1 配置示例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection add con-name br1 <span class="built_in">type</span> bridge autoconnect yes ipv4.method disabled ethernet.mtu 9216 ifname br1</span><br><span class="line"></span><br><span class="line">nmcli connection up br1</span><br><span class="line"></span><br><span class="line">ip link show dev br1</span><br></pre></td></tr></table></figure><p>网桥 br1 的物理网卡配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection add con-name eno5 <span class="built_in">type</span> ethernet autoconnect yes ifname eno5</span><br><span class="line"></span><br><span class="line">nmcli connection modify eno5 ethernet.mtu 9216 ipv4.method disabled master br1</span><br><span class="line"></span><br><span class="line">nmcli connection up eno5</span><br><span class="line"></span><br><span class="line">ip link show dev eno5</span><br></pre></td></tr></table></figure><p>创建 net-br1 网络</p><p>[root@centos7 ~]# cat net-br1.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">network</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">name</span>&gt;</span>net-br1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">forward</span> <span class="attr">mode</span>=<span class="string">&quot;bridge&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">name</span>=<span class="string">&quot;br1&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">network</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># virsh net-define net-br1.xml</span></span><br><span class="line"></span><br><span class="line">Network net-br1 defined from net-br1.xml</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># virsh net-start net-br1</span></span><br><span class="line"></span><br><span class="line">Network net-br1 started</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># virsh net-autostart net-br1</span></span><br><span class="line"></span><br><span class="line">Network net-br1 marked as autostarted</span><br></pre></td></tr></table></figure><h1 id="配置-SR-IOV"><a href="#配置-SR-IOV" class="headerlink" title="配置 SR-IOV"></a>配置 SR-IOV</h1><h2 id="（1）检查网卡对-SR-IOV-的支持，并配置网卡"><a href="#（1）检查网卡对-SR-IOV-的支持，并配置网卡" class="headerlink" title="（1）检查网卡对 SR-IOV 的支持，并配置网卡"></a>（1）检查网卡对 SR-IOV 的支持，并配置网卡</h2><p>可使用 lshw 和 lspci 检查网卡对 SR-IOV 的支持</p><p>lshw -c network -businfo</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Bus info          Device      Class          Description</span><br><span class="line"></span><br><span class="line">========================================================</span><br><span class="line"></span><br><span class="line">pci@0000:1d:00.0  eno5        network        VIC Ethernet NIC</span><br><span class="line"></span><br><span class="line">pci@0000:1d:00.1  eno6        network        VIC Ethernet NIC</span><br><span class="line"></span><br><span class="line">pci@0000:1d:00.2  eno7        network        VIC Ethernet NIC</span><br><span class="line"></span><br><span class="line">pci@0000:1d:00.3  eno8        network        VIC Ethernet NIC</span><br><span class="line"></span><br><span class="line">pci@0000:3b:00.0  eno1        network        Ethernet Controller 10G X550T</span><br><span class="line"></span><br><span class="line">pci@0000:3b:00.1  eno2        network        Ethernet Controller 10G X550T</span><br></pre></td></tr></table></figure><p>lspci -vv -s 3b:00.1 | grep -A 5 -i SR-IOV</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Capabilities: [160 v1] Single Root I/O Virtualization (SR-IOV)</span><br><span class="line"></span><br><span class="line">  IOVCap:Migration-, Interrupt Message Number: 000</span><br><span class="line"></span><br><span class="line">IOVCtl:Enable+ Migration- Interrupt- MSE+ ARIHierarchy-</span><br><span class="line"></span><br><span class="line">IOVSta:Migration-</span><br><span class="line"></span><br><span class="line">Initial VFs: 64, Total VFs: 64, Number of VFs: 8, Function Dependency Link: 01</span><br><span class="line"></span><br><span class="line">VF offset: 128, stride: 2, Device ID: 1565</span><br></pre></td></tr></table></figure><h2 id="（2）设置启动参数"><a href="#（2）设置启动参数" class="headerlink" title="（2）设置启动参数"></a>（2）设置启动参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/default/grub</span><br><span class="line"></span><br><span class="line">GRUB_CMDLINE_LINUX=&quot;crashkernel=auto spectre_v2=retpoline rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet hugepagesz=1G hugepages=32 default_hugepagesz=1G intel_iommu=on iommu=pt isolcpus=1-8,37-44&quot;</span><br><span class="line"></span><br><span class="line">注：页面数字不要过大，不然启动失败，如果后续不够，可以在运行时添加。</span><br><span class="line"></span><br><span class="line">grub2-mkconfig -o /boot/grub2/grub.cfg</span><br><span class="line"></span><br><span class="line">grub2-mkconfig -o /boot/efi/EFI/centos/grub.cfg</span><br><span class="line"></span><br><span class="line">iommu=pt 参数是将SRIOV设备支持PCI Passthrough</span><br></pre></td></tr></table></figure><p>重启后验证</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/cmdline |grep intel_iommu=on</span><br><span class="line"></span><br><span class="line">dmesg |grep -e DMAR -e IOMMU</span><br><span class="line"></span><br><span class="line">dmesg | grep -e DMAR -e IOMMU -e AMD-Vi</span><br></pre></td></tr></table></figure><ul><li><strong>default_hugepagesz=1G hugepagesz=1G hugepages=32</strong> 参数设置主机在启动时分配 32 个 1GB 的内存大页，这些是静态内存大页。 CSR 1000v 虚拟机将试用这些静态大页以获得最优性能。</li><li><strong>isolcpus=1-8,37-44</strong> 参数设置的作用是隔离 1-8，37-44 的 CPU 核，使其独立于内核的平衡调度算法，也就是内核本身不会将进程分配到被隔离的 CPU。之后我们可将指定的进程 CSR 1000v 虚拟机绑定到被隔离的 CPU 上运行，让进程独占 CPU，使其实时性可得到一定程度的提高。</li></ul><p>可参考 这个章节获取主机 CPU 核的相关信息。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@centos7 ~]# cat /proc/cmdline |grep intel_iommu=on</span><br><span class="line"></span><br><span class="line">BOOT_IMAGE=/vmlinuz-3.10.0-1127.el7.x86_64 root=/dev/mapper/centos-root ro crashkernel=auto spectre_v2=retpoline rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet hugepagesz=1G hugepages=32 default_hugepagesz=1G intel_iommu=on iommu=pt LANG=en_US.UTF-8</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# dmesg |grep -e DMAR -e IOMMU</span><br><span class="line"></span><br><span class="line">[    0.000000] ACPI: DMAR 000000005d6f5d70 00250 (v01 Cisco0 CiscoUCS 00000001 INTL 20091013)</span><br><span class="line"></span><br><span class="line">[    0.000000] DMAR: IOMMU enabled</span><br></pre></td></tr></table></figure><p>查看隔离的 CPU 核以及所有的 CPU 核。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cat /sys/devices/system/cpu/isolated</span></span><br><span class="line"></span><br><span class="line">1-8,37-44</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># cat /sys/devices/system/cpu/present</span></span><br><span class="line"></span><br><span class="line">0-71</span><br></pre></td></tr></table></figure><h2 id="（3）通过-nmcli-持久化-VFs-配置"><a href="#（3）通过-nmcli-持久化-VFs-配置" class="headerlink" title="（3）通过 nmcli 持久化 VFs 配置"></a>（3）通过 nmcli 持久化 VFs 配置</h2><p>nmcli 可以设置网卡的 sriov 参数，如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection modify eno2 sriov.total-vfs 4</span><br></pre></td></tr></table></figure><p>还可以设置每一个 VF 设备的 MAC 地址，便于管理：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection modify eno2 sriov.vfs <span class="string">&#x27;0 mac=8E:DF:08:C1:D1:DE trust=true, 1 mac=5A:B9:2F:99:A6:CE trust=true, 2 mac=46:78:69:E3:71:3D trust=true, 3 mac=7E:A7:DB:3B:1B:B3 trust=true&#x27;</span></span><br></pre></td></tr></table></figure><p>执行上述命令后：</p><p>cat /etc/sysconfig/network-scripts/ifcfg-eno2</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">TYPE=Ethernet</span><br><span class="line"></span><br><span class="line">NAME=eno2</span><br><span class="line"></span><br><span class="line">UUID=64ffa204-0158-40c8-ba86-2b7aebf27619</span><br><span class="line"></span><br><span class="line">DEVICE=eno2</span><br><span class="line"></span><br><span class="line">ONBOOT=yes</span><br><span class="line"></span><br><span class="line">MTU=9216</span><br><span class="line"></span><br><span class="line">HWADDR=70:7D:B9:59:5B:AF</span><br><span class="line"></span><br><span class="line">PROXY_METHOD=none</span><br><span class="line"></span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line"></span><br><span class="line">IPV6INIT=no</span><br><span class="line"></span><br><span class="line">SRIOV_TOTAL_VFS=4</span><br><span class="line"></span><br><span class="line">SRIOV_VF0=<span class="string">&quot;mac=8E:DF:08:C1:D1:DE trust=true&quot;</span></span><br><span class="line"></span><br><span class="line">SRIOV_VF1=<span class="string">&quot;mac=5A:B9:2F:99:A6:CE trust=true&quot;</span></span><br><span class="line"></span><br><span class="line">SRIOV_VF2=<span class="string">&quot;mac=46:78:69:E3:71:3D trust=true&quot;</span></span><br><span class="line"></span><br><span class="line">SRIOV_VF3=<span class="string">&quot;mac=7E:A7:DB:3B:1B:B3 trust=true&quot;</span></span><br></pre></td></tr></table></figure><p>重启后，检查 dmesg：</p><p>dmesg | grep -i vf | grep -i eno2</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[   11.953333] ixgbe 0000:3b:00.1 eno2: SR-IOV enabled with 4 VFs</span><br><span class="line"></span><br><span class="line">[   12.541801] ixgbe 0000:3b:00.1: setting MAC 8e:df:08:c1:d1:de on VF 0</span><br><span class="line"></span><br><span class="line">[   12.541805] ixgbe 0000:3b:00.1: Reload the VF driver to make this change effective.</span><br><span class="line"></span><br><span class="line">[   12.541841] ixgbe 0000:3b:00.1 eno2: VF 0 is trusted</span><br><span class="line"></span><br><span class="line">[   12.541846] ixgbe 0000:3b:00.1: setting MAC 5a:b9:2f:99:a6:ce on VF 1</span><br><span class="line"></span><br><span class="line">[   12.541850] ixgbe 0000:3b:00.1: Reload the VF driver to make this change effective.</span><br><span class="line"></span><br><span class="line">[   12.541883] ixgbe 0000:3b:00.1 eno2: VF 1 is trusted</span><br><span class="line"></span><br><span class="line">[   12.541887] ixgbe 0000:3b:00.1: setting MAC 46:78:69:e3:71:3d on VF 2</span><br><span class="line"></span><br><span class="line">[   12.541891] ixgbe 0000:3b:00.1: Reload the VF driver to make this change effective.</span><br><span class="line"></span><br><span class="line">[   12.541923] ixgbe 0000:3b:00.1 eno2: VF 2 is trusted</span><br><span class="line"></span><br><span class="line">[   12.541928] ixgbe 0000:3b:00.1: setting MAC 7e:a7:db:3b:1b:b3 on VF 3</span><br><span class="line"></span><br><span class="line">[   12.541932] ixgbe 0000:3b:00.1: Reload the VF driver to make this change effective.</span><br><span class="line"></span><br><span class="line">[   12.541965] ixgbe 0000:3b:00.1 eno2: VF 3 is trusted</span><br></pre></td></tr></table></figure><h2 id="（4）检查-VF"><a href="#（4）检查-VF" class="headerlink" title="（4）检查 VF"></a>（4）检查 VF</h2><p>可通过 lspci 和 ip link 检查 VF，如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># lspci | grep -i Virtual</span></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># ip link show | grep -B2 vf</span></span><br></pre></td></tr></table></figure><p>寻找 Physical Function 和 Virtual Function 之间的对应关系：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># ls -l /sys/class/net/eno1/device/ | grep virtfn</span></span><br></pre></td></tr></table></figure><p>VF 被创建后，NetworkManager 自动给新的设备创建 Connection，可以修改名称，如下：</p><p>nmcli connection</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">NAME        UUID                                  TYPE      DEVICE</span><br><span class="line"></span><br><span class="line">eno1        2a1c8b39-7f44-321b-a65f-a93e70ab0616  ethernet  eno1</span><br><span class="line"></span><br><span class="line">eno2        64ffa204-0158-40c8-ba86-2b7aebf27619  ethernet  eno2</span><br><span class="line"></span><br><span class="line">enp59s16f1  19c28a93-aa36-38e6-a556-55a922a0a332  ethernet  enp59s16f1</span><br><span class="line"></span><br><span class="line">enp59s16f3  428d9707-1515-3475-b356-7eb229c3f937  ethernet  enp59s16f3</span><br><span class="line"></span><br><span class="line">enp59s16f5  21a8dd5f-239f-37b2-9b09-24ce0e7413bc  ethernet  enp59s16f5</span><br><span class="line"></span><br><span class="line">enp59s16f7  0ca0da65-64c4-314d-89a4-4213f9e4f478  ethernet  enp59s16f7</span><br></pre></td></tr></table></figure><p>修改名称：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection modify uuid 19c28a93-aa36-38e6-a556-55a922a0a332 connection.id enp59s16f1</span><br></pre></td></tr></table></figure><p>修改 MTU 值，并禁用 IPv4 和 IPv6，网卡启动更快</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection modify enp59s16f1 ifname enp59s16f1 ipv4.method disabled ipv6.method ignore ethernet.mtu 9216 ethernet.mac-address <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">nmcli connection up enp59s16f1</span><br><span class="line"></span><br><span class="line">nmcli connection show enp59s16f1</span><br></pre></td></tr></table></figure><p>上述命令生成的 ifcfg 配置文件如下：</p><p>[root@centos7 ~]# cat /etc/sysconfig/network-scripts/ifcfg-enp59s16f1</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">TYPE=Ethernet</span><br><span class="line"></span><br><span class="line">PROXY_METHOD=none</span><br><span class="line"></span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line"></span><br><span class="line">DEFROUTE=yes</span><br><span class="line"></span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line"></span><br><span class="line">IPV6INIT=no</span><br><span class="line"></span><br><span class="line">IPV6_AUTOCONF=no</span><br><span class="line"></span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line"></span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line"></span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line"></span><br><span class="line">NAME=enp59s16f1</span><br><span class="line"></span><br><span class="line">UUID=19c28a93-aa36-38e6-a556-55a922a0a332</span><br><span class="line"></span><br><span class="line">ONBOOT=yes</span><br><span class="line"></span><br><span class="line">AUTOCONNECT_PRIORITY=-999</span><br><span class="line"></span><br><span class="line">DEVICE=enp59s16f1</span><br><span class="line"></span><br><span class="line">MTU=9216</span><br></pre></td></tr></table></figure><p>这样，即便系统重启，上述配置依然能生效。</p><h1 id="使用-KVM-的虚拟网络适配器池"><a href="#使用-KVM-的虚拟网络适配器池" class="headerlink" title="使用 KVM 的虚拟网络适配器池"></a>使用 KVM 的虚拟网络适配器池</h1><p>主机上创建一个 VF 网络设备的资源池，资源池内的设备可以自动地分配给虚拟机使用。</p><h2 id="（1）创建一个-xml-文件。"><a href="#（1）创建一个-xml-文件。" class="headerlink" title="（1）创建一个 xml 文件。"></a>（1）创建一个 xml 文件。</h2><p>[root@centos7 ~]# cat eno2_sriov_pool.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">network</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>eno2_sriov_pool<span class="tag">&lt;/<span class="name">name</span>&gt;</span> <span class="comment">&lt;!-- This is the name of the file you created --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">forward</span> <span class="attr">mode</span>=<span class="string">&#x27;hostdev&#x27;</span> <span class="attr">managed</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">pf</span> <span class="attr">dev</span>=<span class="string">&#x27;eno2&#x27;</span>/&gt;</span> <span class="comment">&lt;!-- Use the netdev name of your SR-IOV devices PF here --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">forward</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">network</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="（2）根据-xml-定义一个网络，并设置为自动重启"><a href="#（2）根据-xml-定义一个网络，并设置为自动重启" class="headerlink" title="（2）根据 xml 定义一个网络，并设置为自动重启"></a>（2）根据 xml 定义一个网络，并设置为自动重启</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">virsh net-define eno2_sriov_pool.xml</span><br><span class="line"></span><br><span class="line">virsh net-start eno2_sriov_pool</span><br><span class="line"></span><br><span class="line">virsh net-autostart eno2_sriov_pool</span><br></pre></td></tr></table></figure><p>[root@centos7 ~]# virsh net-dumpxml eno2_sriov_pool</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">network</span> <span class="attr">connections</span>=<span class="string">&#x27;1&#x27;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">name</span>&gt;</span>eno2_sriov_pool<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>e0842451-0137-4255-8783-305ca27f082d<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">forward</span> <span class="attr">mode</span>=<span class="string">&#x27;hostdev&#x27;</span> <span class="attr">managed</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">pf</span> <span class="attr">dev</span>=<span class="string">&#x27;eno2&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x3b&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x10&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x1&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x3b&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x10&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x3&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x3b&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x10&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x5&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x3b&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x10&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x7&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;/<span class="name">forward</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">network</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="（3）从网络适配器池中分配网卡给虚拟机"><a href="#（3）从网络适配器池中分配网卡给虚拟机" class="headerlink" title="（3）从网络适配器池中分配网卡给虚拟机"></a>（3）从网络适配器池中分配网卡给虚拟机</h2><p>用这种方法添加 SRIOV 网卡比较简单：</p><img src="/csr1kv-kvm-CentOS7/sriov-pool-001.png" class="" title="SRIOV Adapter Pool"><p>按照如上方法添加网卡，等同于以下 xml 配置：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;network&#x27;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;52:54:00:2d:87:99&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">source</span> <span class="attr">network</span>=<span class="string">&#x27;eno2_sriov_pool&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x04&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br></pre></td></tr></table></figure><p>开机后 dumpxml 如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">  <span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;hostdev&#x27;</span> <span class="attr">managed</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;52:54:00:2d:87:99&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;vfio&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">source</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x3b&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x10&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x1&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;hostdev0&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x0f&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="使用-Virt-manager-安装-CSR1000v"><a href="#使用-Virt-manager-安装-CSR1000v" class="headerlink" title="使用 Virt-manager 安装 CSR1000v"></a>使用 Virt-manager 安装 CSR1000v</h1><p>在 CentOS 图形界面中，打开 Terminal，运行 virt-manager，按照以下步骤创建 CSR1000v；添加网卡，并选择 en2_sriov_pool。</p><img src="/csr1kv-kvm-CentOS7/virt-manager-1.png" class="" title="Step 1"><img src="/csr1kv-kvm-CentOS7/virt-manager-2.png" class="" title="选择镜像"><img src="/csr1kv-kvm-CentOS7/virt-manager-3.png" class="" title="Step 2"><img src="/csr1kv-kvm-CentOS7/virt-manager-3.png" class="" title="Step 3"><img src="/csr1kv-kvm-CentOS7/virt-manager-5.png" class="" title="Step 4"><p>注：csr1kv-1 的第一个网口选择<strong>macvtap Bridge</strong>模式，这样就无需创建一个 Linux 网桥。但是，csr1kv-1 启动以后不能通过该接口与 Linux 主机进行通信，仅能通过该接口访问 Linux 主机外的网络。</p><img src="/csr1kv-kvm-CentOS7/virt-manager-6.png" class="" title="Step 5"><img src="/csr1kv-kvm-CentOS7/virt-manager-7.png" class="" title="Step 6"><p>添加完网卡后，点击开始安装，然后就可以关闭虚拟机了。上述操作完成后，virt-manager 会在**/etc/libvirtd/qemu/<strong>目录下创建</strong>csr1kv-1.xml**。</p><h1 id="KVM-调优配置"><a href="#KVM-调优配置" class="headerlink" title="KVM 调优配置"></a>KVM 调优配置</h1><p>KVM 的调优比较复杂，主要是 NUMA、内存大页、vCPU PIN 等，参考资料为 Redhat Linux 7 PERFORMANCE TUNING GUIDE。</p><h2 id="（1）检查平台的能力"><a href="#（1）检查平台的能力" class="headerlink" title="（1）检查平台的能力"></a>（1）检查平台的能力</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># virsh nodeinfo</span></span><br><span class="line"></span><br><span class="line">CPU model:           x86_64</span><br><span class="line"></span><br><span class="line">CPU(s):              72</span><br><span class="line"></span><br><span class="line">CPU frequency:       999 MHz</span><br><span class="line"></span><br><span class="line">CPU socket(s):       1</span><br><span class="line"></span><br><span class="line">Core(s) per socket:  18</span><br><span class="line"></span><br><span class="line">Thread(s) per core:  2</span><br><span class="line"></span><br><span class="line">NUMA cell(s):        2</span><br><span class="line"></span><br><span class="line">Memory size:         263665612 KiB</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># virsh capabilities</span></span><br><span class="line"></span><br><span class="line">&lt;capabilities&gt;</span><br><span class="line"></span><br><span class="line"> &lt;host&gt;</span><br><span class="line"></span><br><span class="line">  &lt;uuid&gt;4e53df1f-5b36-6842-99ee-1369d7c68730&lt;/uuid&gt;</span><br><span class="line"></span><br><span class="line">  &lt;cpu&gt;</span><br><span class="line"></span><br><span class="line">   &lt;arch&gt;x86_64&lt;/arch&gt;</span><br><span class="line"></span><br><span class="line">   &lt;model&gt;Skylake-Server-IBRS&lt;/model&gt;</span><br><span class="line"></span><br><span class="line">   &lt;vendor&gt;Intel&lt;/vendor&gt;</span><br><span class="line"></span><br><span class="line">   &lt;microcode version=<span class="string">&#x27;33581318&#x27;</span>/&gt;</span><br><span class="line"></span><br><span class="line">   &lt;counter name=<span class="string">&#x27;tsc&#x27;</span> frequency=<span class="string">&#x27;2294597000&#x27;</span> scaling=<span class="string">&#x27;yes&#x27;</span>/&gt;</span><br><span class="line"></span><br><span class="line">   &lt;topology sockets=<span class="string">&#x27;1&#x27;</span> cores=<span class="string">&#x27;18&#x27;</span> threads=<span class="string">&#x27;2&#x27;</span>/&gt;</span><br><span class="line"></span><br><span class="line">……</span><br></pre></td></tr></table></figure><p>可检查平台的 CPU 核数、分布，内存的 NUMA 分布等。</p><h2 id="（2）NUMA-调优"><a href="#（2）NUMA-调优" class="headerlink" title="（2）NUMA 调优"></a>（2）NUMA 调优</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># numactl --hardware</span></span><br><span class="line"></span><br><span class="line">available: 2 nodes (0-1)</span><br><span class="line"></span><br><span class="line">node 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53</span><br><span class="line"></span><br><span class="line">node 0 size: 128491 MB</span><br><span class="line"></span><br><span class="line">node 0 free: 112157 MB</span><br><span class="line"></span><br><span class="line">node 1 cpus: 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71</span><br><span class="line"></span><br><span class="line">node 1 size: 128994 MB</span><br><span class="line"></span><br><span class="line">node 1 free: 124120 MB</span><br><span class="line"></span><br><span class="line">node distances:</span><br><span class="line"></span><br><span class="line">node  0  1</span><br><span class="line"></span><br><span class="line"> 0: 10 21</span><br><span class="line"></span><br><span class="line"> 1: 21 10</span><br></pre></td></tr></table></figure><p>两颗 CPU，每颗 CPU 各有 128GB 内存，分别是 node 0 和 node 1。</p><h2 id="（3）内存大页-HugePage-以及透明大页"><a href="#（3）内存大页-HugePage-以及透明大页" class="headerlink" title="（3）内存大页 HugePage 以及透明大页"></a>（3）内存大页 HugePage 以及透明大页</h2><p><code> </code>cat /proc/meminfo | grep HugePages 查看当前系统有多少个大页：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cat /proc/meminfo | grep Huge</span></span><br><span class="line"></span><br><span class="line">AnonHugePages:   1685504 kB</span><br><span class="line"></span><br><span class="line">HugePages_Total:      64</span><br><span class="line"></span><br><span class="line">HugePages_Free:       60</span><br><span class="line"></span><br><span class="line">HugePages_Rsvd:        0</span><br><span class="line"></span><br><span class="line">HugePages_Surp:        0</span><br><span class="line"></span><br><span class="line">Hugepagesize:    1048576 kB</span><br></pre></td></tr></table></figure><p>在系统运行时修改大页数量：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cat /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages</span></span><br><span class="line"></span><br><span class="line">16</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># echo 32 &gt; /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages</span></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># echo 32 &gt; /sys/devices/system/node/node1/hugepages/hugepages-1048576kB/nr_hugepages</span></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment">#</span></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># numastat -cm | egrep &#x27;Node|Huge&#x27;</span></span><br><span class="line"></span><br><span class="line">`                 `Node 0 Node 1  Total</span><br><span class="line"></span><br><span class="line">AnonHugePages     10962   1528  12490</span><br><span class="line"></span><br><span class="line">HugePages_Total   32768  32768  65536</span><br><span class="line"></span><br><span class="line">HugePages_Free    32768  32768  65536</span><br><span class="line"></span><br><span class="line">HugePages_Surp        0      0      0</span><br></pre></td></tr></table></figure><p>检查透明大页参数，在 CentOS7 上缺省开启；开启了透明大页，不影响静态大页的使用。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line"></span><br><span class="line">[always] madvise never</span><br></pre></td></tr></table></figure><h2 id="（4）vCPU-钉选"><a href="#（4）vCPU-钉选" class="headerlink" title="（4）vCPU 钉选"></a>（4）vCPU 钉选</h2><p>设置 CPU Affinity 的好处是提高 CPU 缓存效率，避免进程在多个 CPU 核之间跳跃，切换 CPU 核均会导致缓存中的数据无效，缓存命中率大幅降低，导致数据获取的开销居高不下，损失性能。</p><p><strong>virsh vcpuinfo csr1kv-1</strong> 可以查看 vCPU 的分配。</p><h2 id="（5）编辑-CSR-1000v-的-XML-调优参数"><a href="#（5）编辑-CSR-1000v-的-XML-调优参数" class="headerlink" title="（5）编辑 CSR 1000v 的 XML 调优参数"></a>（5）编辑 CSR 1000v 的 XML 调优参数</h2><p>virsh edit csr1kv-1 可以编辑 XML 的参数，如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">memoryBacking</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">hugepages</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">page</span> <span class="attr">size</span>=<span class="string">&#x27;1048576&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">hugepages</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">locked</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">nosharepages</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">memoryBacking</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">vcpu</span> <span class="attr">placement</span>=<span class="string">&#x27;static&#x27;</span>&gt;</span>8<span class="tag">&lt;/<span class="name">vcpu</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">cputune</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;3&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;4&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;5&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;5&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;6&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;6&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;7&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;7&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;8&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">emulatorpin</span> <span class="attr">cpuset</span>=<span class="string">&#x27;45-52&#x27;</span>/&gt;</span> <span class="comment">&lt;!-- If Hyper-threading were enabled --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cputune</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">numatune</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">memory</span> <span class="attr">mode</span>=<span class="string">&#x27;strict&#x27;</span> <span class="attr">nodeset</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">numatune</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">cpu</span> <span class="attr">mode</span>=<span class="string">&#x27;host-passthrough&#x27;</span> <span class="attr">check</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">memballoon</span> <span class="attr">model</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>注：**<emulatorpin cpuset='37-44'/>** 参数，仅当 Hyper-Threating 开启时使用；有一些平台并未关闭超线程，例如 Cisco 专门的 NFV 平台 CSP。通过 virsh chapabilities 查看 siblings=’1,37’，当 core 1 设置为 vcpupin 时，core 37 应设置到 emulatorpin cpuset 中。</p><p>以下关于 CPU 和内存的参数设定建议来自于<a href="https://libvirt.org/formatdomain.html">https://libvirt.org/formatdomain.html</a> 和 <a href="https://libvirt.org/kbase/kvm-realtime.html">https://libvirt.org/kbase/kvm-realtime.html</a></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">domain</span> <span class="attr">type</span>=<span class="string">&#x27;kvm&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>csr1kv-1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>59581018-6387-49df-ab09-2bcf40fc12ba<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">memory</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>&gt;</span>8388608<span class="tag">&lt;/<span class="name">memory</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">currentMemory</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>&gt;</span>8388608<span class="tag">&lt;/<span class="name">currentMemory</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">memoryBacking</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hugepages</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">page</span> <span class="attr">size</span>=<span class="string">&#x27;1048576&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">hugepages</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">locked</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">nosharepages</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">memoryBacking</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpu</span> <span class="attr">placement</span>=<span class="string">&#x27;static&#x27;</span>&gt;</span>8<span class="tag">&lt;/<span class="name">vcpu</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">cputune</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;3&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;4&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;5&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;5&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;6&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;6&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;7&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;7&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;8&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">emulatorpin</span> <span class="attr">cpuset</span>=<span class="string">&#x27;37-44&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">cputune</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">numatune</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">memory</span> <span class="attr">mode</span>=<span class="string">&#x27;strict&#x27;</span> <span class="attr">nodeset</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">numatune</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">os</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span> <span class="attr">arch</span>=<span class="string">&#x27;x86_64&#x27;</span> <span class="attr">machine</span>=<span class="string">&#x27;pc-i440fx-rhel7.0.0&#x27;</span>&gt;</span>hvm<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">boot</span> <span class="attr">dev</span>=<span class="string">&#x27;hd&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">os</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">features</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">acpi</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">apic</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">features</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">cpu</span> <span class="attr">mode</span>=<span class="string">&#x27;host-passthrough&#x27;</span> <span class="attr">check</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">clock</span> <span class="attr">offset</span>=<span class="string">&#x27;utc&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">timer</span> <span class="attr">name</span>=<span class="string">&#x27;rtc&#x27;</span> <span class="attr">tickpolicy</span>=<span class="string">&#x27;catchup&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">timer</span> <span class="attr">name</span>=<span class="string">&#x27;pit&#x27;</span> <span class="attr">tickpolicy</span>=<span class="string">&#x27;delay&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">timer</span> <span class="attr">name</span>=<span class="string">&#x27;hpet&#x27;</span> <span class="attr">present</span>=<span class="string">&#x27;no&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">clock</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">on_poweroff</span>&gt;</span>destroy<span class="tag">&lt;/<span class="name">on_poweroff</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">on_reboot</span>&gt;</span>restart<span class="tag">&lt;/<span class="name">on_reboot</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">on_crash</span>&gt;</span>destroy<span class="tag">&lt;/<span class="name">on_crash</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">pm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">suspend-to-mem</span> <span class="attr">enabled</span>=<span class="string">&#x27;no&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">suspend-to-disk</span> <span class="attr">enabled</span>=<span class="string">&#x27;no&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">pm</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">devices</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">emulator</span>&gt;</span>/usr/libexec/qemu-kvm<span class="tag">&lt;/<span class="name">emulator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;file&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;disk&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;qcow2&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">&#x27;/home/root/images/csr1000v-universalk9.17.02.01v.qcow2&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;vda&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x07&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;ich9-ehci1&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x05&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x7&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;ich9-uhci1&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">master</span> <span class="attr">startport</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x05&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span> <span class="attr">multifunction</span>=<span class="string">&#x27;on&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;ich9-uhci2&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">master</span> <span class="attr">startport</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x05&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;ich9-uhci3&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">master</span> <span class="attr">startport</span>=<span class="string">&#x27;4&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x05&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pci-root&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;virtio-serial&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x06&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;direct&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;52:54:00:36:95:f0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">dev</span>=<span class="string">&#x27;eno1&#x27;</span> <span class="attr">mode</span>=<span class="string">&#x27;bridge&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x03&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;network&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;52:54:00:2d:87:99&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">network</span>=<span class="string">&#x27;eno2_sriov_pool&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x04&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">serial</span> <span class="attr">type</span>=<span class="string">&#x27;pty&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;isa-serial&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;isa-serial&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">serial</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">console</span> <span class="attr">type</span>=<span class="string">&#x27;pty&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;serial&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">console</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">channel</span> <span class="attr">type</span>=<span class="string">&#x27;unix&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;org.qemu.guest_agent.0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;virtio-serial&#x27;</span> <span class="attr">controller</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">channel</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">channel</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;com.redhat.spice.0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;virtio-serial&#x27;</span> <span class="attr">controller</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">channel</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;tablet&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;mouse&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;ps2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;keyboard&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;ps2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">graphics</span> <span class="attr">type</span>=<span class="string">&#x27;spice&#x27;</span> <span class="attr">autoport</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">listen</span> <span class="attr">type</span>=<span class="string">&#x27;address&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">image</span> <span class="attr">compression</span>=<span class="string">&#x27;off&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">graphics</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">video</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;qxl&#x27;</span> <span class="attr">ram</span>=<span class="string">&#x27;65536&#x27;</span> <span class="attr">vram</span>=<span class="string">&#x27;65536&#x27;</span> <span class="attr">vgamem</span>=<span class="string">&#x27;16384&#x27;</span> <span class="attr">heads</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">primary</span>=<span class="string">&#x27;yes&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;3&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">memballoon</span> <span class="attr">model</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rng</span> <span class="attr">model</span>=<span class="string">&#x27;virtio&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">backend</span> <span class="attr">model</span>=<span class="string">&#x27;random&#x27;</span>&gt;</span>/dev/urandom<span class="tag">&lt;/<span class="name">backend</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x09&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rng</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">devices</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br></pre></td></tr></table></figure><p>上述参数整理自<a href="https://www.cisco.com/c/en/us/td/docs/routers/csr1000/software/configuration/b_CSR1000v_Configuration_Guide/b_CSR1000v_Configuration_Guide_chapter_0101.html">《Cisco CSR 1000v and Cisco ISRv Software Configuration Guide》</a></p><p>完成上述 XML 文件的编辑后，执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/libvirtd/qemu</span><br><span class="line"></span><br><span class="line">virsh define csr1kv-1.xml</span><br><span class="line"></span><br><span class="line">virsh start csr1kv-1</span><br></pre></td></tr></table></figure><h2 id="（6）在-KVM-主机上访问-CSR1000v-的-Console"><a href="#（6）在-KVM-主机上访问-CSR1000v-的-Console" class="headerlink" title="（6）在 KVM 主机上访问 CSR1000v 的 Console"></a>（6）在 KVM 主机上访问 CSR1000v 的 Console</h2><p>在 virt-manager 创建 CSR1000v 虚拟机的时候，缺省会添加一个 Serial Device。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 qemu]<span class="comment"># virsh console 20</span></span><br><span class="line"></span><br><span class="line">Connected to domain CSR1000v-1</span><br><span class="line"></span><br><span class="line">Escape character is ^]</span><br></pre></td></tr></table></figure><p>CSR 1000v 暂时不能通过 Console 配置，需要通过 virt-manager 的图形化界面进行初始化配置。</p><p>vCloud 的 Console 访问正常。</p><h2 id="（7）检验-CSR1000v-的调优配置"><a href="#（7）检验-CSR1000v-的调优配置" class="headerlink" title="（7）检验 CSR1000v 的调优配置"></a>（7）检验 CSR1000v 的调优配置</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# virsh list</span><br><span class="line"></span><br><span class="line">Id  Name              State</span><br><span class="line"></span><br><span class="line">----------------------------------------------------</span><br><span class="line"></span><br><span class="line"> 6   csr1kv-1            running</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# virsh vcpuinfo 6</span><br><span class="line"></span><br><span class="line">VCPU:      0</span><br><span class="line"></span><br><span class="line">CPU:      1</span><br><span class="line"></span><br><span class="line">State:     running</span><br><span class="line"></span><br><span class="line">CPU time:    34.5s</span><br><span class="line"></span><br><span class="line">CPU Affinity:  -y----------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VCPU:      1</span><br><span class="line"></span><br><span class="line">CPU:      2</span><br><span class="line"></span><br><span class="line">State:     running</span><br><span class="line"></span><br><span class="line">CPU time:    32.0s</span><br><span class="line"></span><br><span class="line">CPU Affinity:  --y---------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VCPU:      2</span><br><span class="line"></span><br><span class="line">CPU:      3</span><br><span class="line"></span><br><span class="line">State:     running</span><br><span class="line"></span><br><span class="line">CPU time:    23.8s</span><br><span class="line"></span><br><span class="line">CPU Affinity:  ---y--------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VCPU:      3</span><br><span class="line"></span><br><span class="line">CPU:      4</span><br><span class="line"></span><br><span class="line">State:     running</span><br><span class="line"></span><br><span class="line">CPU time:    19.8s</span><br><span class="line"></span><br><span class="line">CPU Affinity:  ----y-------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VCPU:      4</span><br><span class="line"></span><br><span class="line">CPU:      5</span><br><span class="line"></span><br><span class="line">State:     running</span><br><span class="line"></span><br><span class="line">CPU time:    23.0s</span><br><span class="line"></span><br><span class="line">CPU Affinity:  -----y------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VCPU:      5</span><br><span class="line"></span><br><span class="line">CPU:      6</span><br><span class="line"></span><br><span class="line">State:     running</span><br><span class="line"></span><br><span class="line">CPU time:    23.4s</span><br><span class="line"></span><br><span class="line">CPU Affinity:  ------y-----------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VCPU:      6</span><br><span class="line"></span><br><span class="line">CPU:      7</span><br><span class="line"></span><br><span class="line">State:     running</span><br><span class="line"></span><br><span class="line">CPU time:    28.5s</span><br><span class="line"></span><br><span class="line">CPU Affinity:  -------y----------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VCPU:      7</span><br><span class="line"></span><br><span class="line">CPU:      8</span><br><span class="line"></span><br><span class="line">State:     running</span><br><span class="line"></span><br><span class="line">CPU time:    28.2s</span><br><span class="line"></span><br><span class="line">CPU Affinity:  --------y---------------------------------------------------------------</span><br></pre></td></tr></table></figure><p>以上显示 CSR1000v 虚拟机的 CPU 亲和性在 1-8 核上。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># numastat -c qemu-kvm</span></span><br><span class="line"></span><br><span class="line">Per-node process memory usage (<span class="keyword">in</span> MBs) <span class="keyword">for</span> PID 46895 (qemu-kvm)</span><br><span class="line"></span><br><span class="line">     Node 0 Node 1 Total</span><br><span class="line"></span><br><span class="line">     ------ ------ -----</span><br><span class="line"></span><br><span class="line">Huge    8192   0 8192</span><br><span class="line"></span><br><span class="line">Heap    118   0  118</span><br><span class="line"></span><br><span class="line">Stack     0   0   0</span><br><span class="line"></span><br><span class="line">Private   144   7  151</span><br><span class="line"></span><br><span class="line">------- ------ ------ -----</span><br><span class="line"></span><br><span class="line">Total   8455   7 8461</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>以上显示，内存主要使用 Node 0。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># numastat -vm -p 13428 | grep HugePage</span></span><br><span class="line"></span><br><span class="line">AnonHugePages       956.00     494.00     1450.00</span><br><span class="line"></span><br><span class="line">HugePages_Total     16384.00    16384.00    32768.00</span><br><span class="line"></span><br><span class="line">HugePages_Free      8192.00    16384.00    24576.00</span><br><span class="line"></span><br><span class="line">HugePages_Surp       0.00       0.00      0.00</span><br></pre></td></tr></table></figure><h2 id="（8）在-CSR1KV-上检查虚拟网卡"><a href="#（8）在-CSR1KV-上检查虚拟网卡" class="headerlink" title="（8）在 CSR1KV 上检查虚拟网卡"></a>（8）在 CSR1KV 上检查虚拟网卡</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">csr1kv-1#show platform software vnic-if interface-mapping</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"> Interface Name    Driver Name     Mac Addr</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"> GigabitEthernet2    net_ixgbe_vf    5254.002d.8799</span><br><span class="line"></span><br><span class="line"> GigabitEthernet1    net_virtio     5254.0036.95f0</span><br></pre></td></tr></table></figure><p>上述驱动名显示为 net_ixgbe_vf 表明该虚拟网卡是一个 SR-IOV 池中分配的 VF 设备。</p><h1 id="Linux-上抓取虚拟网卡的报文（参考）"><a href="#Linux-上抓取虚拟网卡的报文（参考）" class="headerlink" title="Linux 上抓取虚拟网卡的报文（参考）"></a>Linux 上抓取虚拟网卡的报文（参考）</h1><p>查找虚拟机的网卡列表</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># virsh domiflist 10</span></span><br><span class="line"></span><br><span class="line">Interface Type    Source   Model    MAC</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------</span><br><span class="line"></span><br><span class="line">vnet0   network  default  virtio   52:54:00:38:71:4a</span><br><span class="line"></span><br><span class="line">macvtap0  direct   eno1    virtio   52:54:00:b2:70:90</span><br><span class="line"></span><br><span class="line">vnet5   bridge   net-br1  virtio   52:54:00:69:93:23</span><br></pre></td></tr></table></figure><p>抓取 vnet5 的报文</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># tcpdump -i vnet5 -w ping.pcap</span></span><br><span class="line"></span><br><span class="line">tcpdump: listening on vnet5, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line"></span><br><span class="line">^C49 packets captured</span><br><span class="line"></span><br><span class="line">51 packets received by filter</span><br><span class="line"></span><br><span class="line">0 packets dropped by kernel</span><br></pre></td></tr></table></figure><p>注：VF 如果被分配给虚拟机，那么在 Linux 主机里，通过 ip link 则查看不到该设备，无法通过上述办法抓包。</p><h1 id="CSR-1000v-的初始化配置及-Smart-License-注册"><a href="#CSR-1000v-的初始化配置及-Smart-License-注册" class="headerlink" title="CSR 1000v 的初始化配置及 Smart License 注册"></a>CSR 1000v 的初始化配置及 Smart License 注册</h1><h2 id="（1）CSR-1000v-初始化配置示例"><a href="#（1）CSR-1000v-初始化配置示例" class="headerlink" title="（1）CSR 1000v 初始化配置示例"></a>（1）CSR 1000v 初始化配置示例</h2><p>部分节略，其他为缺省配置。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">CSR1000v-1#show sdwan running-config</span><br><span class="line"></span><br><span class="line">system</span><br><span class="line"></span><br><span class="line"> system-ip       1.1.10.1</span><br><span class="line"></span><br><span class="line"> site-id        101</span><br><span class="line"></span><br><span class="line"> sp-organization-name CiscoBJ</span><br><span class="line"></span><br><span class="line"> organization-name   CiscoBJ</span><br><span class="line"></span><br><span class="line"> vbond 10.75.58.51 port 12346</span><br><span class="line"></span><br><span class="line">!</span><br><span class="line"></span><br><span class="line">hostname CSR1000v-1</span><br><span class="line"></span><br><span class="line">username admin privilege 15 secret 9 $9$4&#x2F;QL2V2K4&#x2F;6H1k$XUmRNf.T7t3KDOj&#x2F;FmoNexpEypCxr482dExXHDnohSI</span><br><span class="line"></span><br><span class="line">ip name-server 64.104.123.245</span><br><span class="line"></span><br><span class="line">ip route 0.0.0.0 0.0.0.0 10.75.59.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">interface GigabitEthernet1</span><br><span class="line"></span><br><span class="line"> no shutdown</span><br><span class="line"></span><br><span class="line"> arp timeout 1200</span><br><span class="line"></span><br><span class="line"> ip address 10.75.59.35 255.255.255.0</span><br><span class="line"></span><br><span class="line"> no ip redirects</span><br><span class="line"></span><br><span class="line"> ip mtu  1500</span><br><span class="line"></span><br><span class="line"> mtu 1500</span><br><span class="line"></span><br><span class="line"> negotiation auto</span><br><span class="line"></span><br><span class="line">exit</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">interface Tunnel1</span><br><span class="line"></span><br><span class="line"> no shutdown</span><br><span class="line"></span><br><span class="line"> ip unnumbered GigabitEthernet1</span><br><span class="line"></span><br><span class="line"> no ip redirects</span><br><span class="line"></span><br><span class="line"> ipv6 unnumbered GigabitEthernet1</span><br><span class="line"></span><br><span class="line"> no ipv6 redirects</span><br><span class="line"></span><br><span class="line"> tunnel source GigabitEthernet1</span><br><span class="line"></span><br><span class="line"> tunnel mode sdwan</span><br><span class="line"></span><br><span class="line">exit</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">clock timezone CST 8 0</span><br><span class="line"></span><br><span class="line">ntp server 10.75.58.1 version 4</span><br><span class="line"></span><br><span class="line">sdwan</span><br><span class="line"></span><br><span class="line"> interface GigabitEthernet1</span><br><span class="line"></span><br><span class="line"> tunnel-interface</span><br><span class="line"></span><br><span class="line">  encapsulation ipsec</span><br><span class="line"></span><br><span class="line">  allow-service sshd</span><br><span class="line"></span><br><span class="line"> exit</span><br></pre></td></tr></table></figure><h2 id="（2）常用命令"><a href="#（2）常用命令" class="headerlink" title="（2）常用命令"></a>（2）常用命令</h2><ul><li>show sdwan control local-properties</li><li>show sdwan control connections</li><li>show sdwan control connection-history</li><li>show sdwan running-config</li><li>show sdwan bfd sessions</li><li>show sdwan omp peers</li><li>show sdwan omp routes</li></ul><h2 id="（3）CSR-1000v-Smart-License-注册"><a href="#（3）CSR-1000v-Smart-License-注册" class="headerlink" title="（3）CSR 1000v Smart License 注册"></a>（3）CSR 1000v Smart License 注册</h2><p>CSR 1000v 默认限速为 250Mbps，需要注册 Smart License 才可解开限速。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CSR1000v-2#show platform hardware throughput level</span><br><span class="line"></span><br><span class="line">The current throughput level is 250000 kb&#x2F;s</span><br></pre></td></tr></table></figure><p>注册 Smart License 需要满足以下条件：</p><p>1、 CSR 1000v 已经注册到 vManage，控制面连接正常；</p><p>2、 配置 ip http client source-interface GigabitEthernet2</p><p>3、 sdwan interface GigabitEthernet2 tunnel-interface allow-service all —针对 16.12.x 版本；在新版本中仅需要 allow https</p><p>4、 CSR 1000v 可以访问 URL：<a href="https://tools.cisco.com/its/service/oddce/services/DDCEService">https://tools.cisco.com/its/service/oddce/services/DDCEService</a></p><p>允许访问 114.114.114.114，CSR 1000v 可解析域名 tools.cisco.com</p><p>替代办法，增加一条命令 ip host tools.cisco.com 72.163.4.38</p><p>执行 license smart register idtoken xxxxxx 进行注册</p><p>show license status 查看注册结果</p><p>注册完成后，系统解开限速：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CSR1000v-1#show platform hardware throughput level</span><br><span class="line"></span><br><span class="line">The current throughput level is 200000000 kb&#x2F;s</span><br></pre></td></tr></table></figure><h1 id="性能和相关限制"><a href="#性能和相关限制" class="headerlink" title="性能和相关限制"></a>性能和相关限制</h1><h2 id="（1）SRIOV-的性能"><a href="#（1）SRIOV-的性能" class="headerlink" title="（1）SRIOV 的性能"></a>（1）SRIOV 的性能</h2><p>在上述 CSR1KV-1 安装好后，使用测试仪进行性能测试，测试条件中，设置丢包率为 0%，其性能如下：</p><table><thead><tr><th align="left">Packet Site</th><th align="center">SDWAN Performance (Mbps)</th><th align="center">CEF Performance (Mbps)</th></tr></thead><tbody><tr><td align="left">128Byte</td><td align="center">800</td><td align="center">2843.75</td></tr><tr><td align="left">256Byte</td><td align="center">1431.26</td><td align="center">6500.00</td></tr><tr><td align="left">512Byte</td><td align="center">2581.26</td><td align="center">10578.13</td></tr><tr><td align="left">1024Byte</td><td align="center">3731.26</td><td align="center">15500.00</td></tr><tr><td align="left">1400Byte</td><td align="center">4306.26</td><td align="center">18171.88</td></tr></tbody></table><img src="/csr1kv-kvm-CentOS7/line-chart-009.png" class="" title="性能现状图表"><p>注：上述测试结果非官方结果，不同服务器和网卡可能测试结果有区别，上述性能数据仅供参考。</p><h2 id="（2）SRIOV-的限制"><a href="#（2）SRIOV-的限制" class="headerlink" title="（2）SRIOV 的限制"></a>（2）SRIOV 的限制</h2><p>SRIOV 的主要限制是每一个 VF 设备支持的 VLAN 数，ixgbevf 所支持的最大 VLAN 数为 64；因此，在 CSR1KV 中对应的虚拟接口配置的活跃子接口数最大为 64。</p><p>配置指南中有关于 SRIOV 子接口限制的说明：</p><p><code> </code><a href="https://www.cisco.com/c/en/us/td/docs/routers/csr1000/software/configuration/b_CSR1000v_Configuration_Guide/b_CSR1000v_Configuration_Guide_chapter_0101.html">Cisco CSR 1000v and Cisco ISRv Software Configuration Guide</a>:</p><blockquote><p>SR-IOV (ixgbevf)</p><p>Maximum VLANs: The maximum number of VLANs supported on PF is 64. Together, all VFs can have a total of 64 VLANs. (Intel limitation.)</p><p>SR-IOV (i40evf)</p><p>Maximum VLANs: The maximum number of VLANs supported on PF is 512. Together, all VFs can have a total of 512 VLANs. (Intel limitation.) Per-VF resources are managed by the PF (host) device driver.</p></blockquote><h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><h2 id="（1）Virt-manager-设置虚机的-CPU-模式说明"><a href="#（1）Virt-manager-设置虚机的-CPU-模式说明" class="headerlink" title="（1）Virt-manager 设置虚机的 CPU 模式说明"></a>（1）Virt-manager 设置虚机的 CPU 模式说明</h2><p>Libvirt 主要支持三种 CPU mode：</p><ul><li>host-passthrough: libvirt 令 KVM 把宿主机的 CPU 指令集全部透传给虚拟机。因此虚拟机能够最大限度的使用宿主机 CPU 指令集，故性能是最好的。但是在热迁移时，它要求目的节点的 CPU 和源节点的一致。</li><li>host-model: libvirt 根据当前宿主机 CPU 指令集从配置文件 /usr/share/libvirt/cpu_map.xml 选择一种最相配的 CPU 型号。在这种 mode 下，虚拟机的指令集往往比宿主机少，性能相对 host-passthrough 要差一点，但是热迁移时，它允许目的节点 CPU 和源节点的存在一定的差异。</li><li>custom: 这种模式下虚拟机 CPU 指令集数最少，故性能相对最差，但是它在热迁移时跨不同型号 CPU 的能力最强。此外，custom 模式下支持用户添加额外的指令集。</li></ul><p>三种 mode 的性能排序是：host-passthrough &gt; host-model &gt; custom</p><p>实际性能差异不大：100%&gt; 95.84%&gt;94.73%</p><p>引自：<a href="http://wsfdl.com/openstack/2018/01/02/libvirt_cpu_mode.html">http://wsfdl.com/openstack/2018/01/02/libvirt_cpu_mode.html</a></p><h2 id="（2）有关网卡模式的说明"><a href="#（2）有关网卡模式的说明" class="headerlink" title="（2）有关网卡模式的说明"></a>（2）有关网卡模式的说明</h2><p>使用 virt-manager 创建虚拟机，在添加网卡时，有 3 中选择，分别是 e1000, rtl8139, virtio。</p><p>“rtl8139”这个网卡模式是 qemu-kvm 默认的模拟网卡类型，RTL8139 是 Realtek 半导体公司的一个 10/100M 网卡系列，是曾经非常流行（当然现在看来有点古老）且兼容性好的网卡，几乎所有的现代操作系统都对 RTL8139 网卡驱动的提供支持。</p><p>“e1000”系列提供 Intel e1000 系列的网卡模拟，纯的 QEMU（非 qemu-kvm）默认就是提供 Intel e1000 系列的虚拟网卡。</p><p>“virtio” 类型是 qemu-kvm 对半虚拟化 IO（virtio）驱动的支持。</p><p>这三个网卡的最大区别(此处指最需要关注的地方)是速度：</p><ul><li><p>rtl8139 10/100Mb/s</p></li><li><p>e1000 1Gb/s</p></li><li><p>virtio 10Gb/s</p></li></ul><p>注意 virtio 是唯一可以达到 10Gb/s 的。</p><p>virtio 是一种 I/O 半虚拟化解决方案，是一套通用 I/O 设备虚拟化的程序，是对半虚拟化 Hypervisor 中的一组通用 I/O 设备的抽象。提供了一套上层应用与各 Hypervisor 虚拟化设备（KVM，Xen，VMware 等）之间的通信框架和编程接口，减少跨平台所带来的兼容性问题，大大提高驱动程序开发效率。</p><h2 id="（3）有关-MACVTAP"><a href="#（3）有关-MACVTAP" class="headerlink" title="（3）有关 MACVTAP"></a>（3）有关 MACVTAP</h2><p>以下内容来自：<a href="https://www.ibm.com/developerworks/cn/linux/1312_xiawc_linuxvirtnet/index.html">https://www.ibm.com/developerworks/cn/linux/1312_xiawc_linuxvirtnet/index.html</a></p><p>MACVTAP 的实现基于传统的 MACVLAN。和 TAP 设备一样，每一个 MACVTAP 设备拥有一个对应的 Linux 字符设备，并拥有和 TAP 设备一样的 IOCTL 接口，因此能直接被 KVM/Qemu 使用，方便地完成网络数据交换工作。引入 MACVTAP 设备的目标是：简化虚拟化环境中的交换网络，代替传统的 Linux TAP 设备加 Bridge 设备组合，同时支持新的虚拟化网络技术，如 802.1 Qbg。</p><p>MACVTAP 设备和 VLAN 设备类似，是以一对多的母子关系出现的。在一个母设备上可以创建多个 MACVTAP 子设备，一个 MACVTAP 设备只有一个母设备，MACVTAP 子设备可以做为母设备，再一次嵌套的创建 MACVTAP 子设备。母子设备之间被隐含的桥接起来，母设备相当于现实世界中的交换机 TRUNK 口。实际上当 MACVTAP 设备被创建并且模式不为 Passthrough 时，内核隐含的创建了 MACVLAN 网络，完成转发功能。MACVTAP 设备有四种工作模式：Bridge、VEPA、Private，Passthrough。</p><p>Bridge 模式下，它完成与 Bridge 设备类似功能，数据可以在属于同一个母设备的子设备间交换转发，虚拟机相当于简单接入了一个交换机。当前的 Linux 实现有一个缺陷，此模式下 MACVTAP 子设备无法和 Linux Host 通讯，即虚拟机无法和 Host 通讯。—-经验证，属实。</p><p>Passthrough 模式下，内核的 MACVLAN 数据处理逻辑被跳过，硬件决定数据如何处理，从而释放了 Host CPU 资源。</p><img src="/csr1kv-kvm-CentOS7/macvtap-ibm.png" class="" title="MACVTAP 直通 vs PCI 直通"><p>MACVTAP Passthrough 概念与 PCI Passthrough 概念不同，上图详细解释了两种情况的区别。</p><p>PCI Passthrough 针对的是任意 PCI 设备，不一定是网络设备，目的是让 Guest OS 直接使用 Host 上的 PCI 硬件以提高效率。以 X86 平台为例，数据将通过需要硬件支持的 VT-D 技术从 Guest OS 直接传递到 Host 硬件上。这样做固然效率很高，但因为模拟器失去了对虚拟硬件的控制，难以同步不同 Host 上的硬件状态，因此当前在使用 PCI Passthrough 的情况下难以做动态迁移。</p><p>MACVTAP Passthrough 仅仅针对 MACVTAP 网络设备，目的是绕过内核里 MACVTAP 的部分软件处理过程，转而交给硬件处理。在虚拟化条件下，数据还是会先到达模拟器 I/O 层，再转发到硬件上。这样做效率有损失，但模拟器仍然控制虚拟硬件的状态及数据的走向，可以做动态迁移。</p><h2 id="（4）SR-IOV-介绍"><a href="#（4）SR-IOV-介绍" class="headerlink" title="（4）SR-IOV 介绍"></a>（4）SR-IOV 介绍</h2><p>如果网卡支持 SRIOV，请使用 SRIOV PCI Passthrough。</p><img src="/csr1kv-kvm-CentOS7/nic-type-010.png" class="" title="nic-type-010"><p>软件模拟是通过 Hypervisor 层模拟虚拟网卡，实现与物理设备完全一样的接口，虚拟机操作系统无须修改就能直接驱动虚拟网卡，其最大的缺点是性能相对较差；</p><p>网卡直通支持虚拟机绕过 Hypervisor 层，直接访问物理 I/O 设备，具有最高的性能，但是在同一时刻物理 I/O 设备只能被一个虚拟机独享；</p><p>SR-IOV 是 Intel 在 2007 年提出的解决虚拟化网络 I/O 的硬件技术方案，该技术不仅能够继承网卡直通的高性能优势，而且同时支持物理 I/O 设备的跨虚拟机共享，具有较好的应用前景。</p><p>原文链接：<a href="https://blog.csdn.net/lsz137105/article/details/100752930">https://blog.csdn.net/lsz137105/article/details/100752930</a></p><p>SR-IOV（Single Root I/O Virtualization）是一个将 PCIe 设备（如网卡）共享给虚拟机的标准，通过为虚拟机提供独立的内存空间、中断、DMA 流，来绕过 VMM 实现数据访问。</p><p>SR-IOV 引入了两种 PCIe functions：</p><ul><li>PF（Physical Function）：包含完整的 PCIe 功能，包括 SR-IOV 的扩张能力，该功能用于 SR-IOV 的配置和管理。</li><li>VF（Virtual Function）：包含轻量级的 PCIe 功能。每一个 VF 有它自己独享的 PCI 配置区域，并且可能与其他 VF 共享着同一个物理资源。</li></ul><p>SR-IOV 网卡通过将 SR-IOV 功能集成到物理网卡上，将单一的物理网卡虚拟成多个 VF 接口，每个 VF 接口都有单独的虚拟 PCIe 通道，这些虚拟的 PCIe 通道共用物理网卡的 PCIe 通道。每个虚拟机可占用一个或多个 VF 接口，这样虚拟机就可以直接访问自己的 VF 接口，而不需要 Hypervisor 的协调干预，从而大幅提升网络吞吐性能。</p><h2 id="（5）探索虚拟机进程"><a href="#（5）探索虚拟机进程" class="headerlink" title="（5）探索虚拟机进程"></a>（5）探索虚拟机进程</h2><p>每一个客户机就是宿主机中的一个 QEMU 进程，而一个客户机的多个 vCPU 就是一个 QEMU 进程中的多个线程。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># ps -ef | grep qemu</span></span><br><span class="line"></span><br><span class="line">qemu      52595      1 99 10:37 ?        01:24:12 /usr/libexec/qemu-kvm -name csr1kv-1 -S -machine pc-i440fx-rhel7.0.0,accel=kvm,usb=off,dump-guest-core=off,mem-merge=off -cpu host -m 8192 -mem-prealloc -mem-path /dev/hugepages/libvirt/qemu/7-csr1kv-1 -realtime mlock=on -smp 8,sockets=8,cores=1,threads=1 -uuid 59581018-6387-49df-ab09-2bcf40fc12ba -no-user-config -nodefaults -chardev socket,id=charmonitor,path=/var/lib/libvirt/qemu/domain-7-csr1kv-1/monitor.sock,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=utc,driftfix=slew -global kvm-pit.lost_tick_policy=delay -no-hpet -no-shutdown -global PIIX4_PM.disable_s3=1 -global PIIX4_PM.disable_s4=1 -boot strict=on -device piix3-usb-uhci,id=usb,bus=pci.0,addr=0x1.0x2 -device virtio-serial-pci,id=virtio-serial0,bus=pci.0,addr=0x6 -drive file=/home/root/images/csr1000v-universalk9.17.02.01v.qcow2,format=qcow2,<span class="keyword">if</span>=none,id=drive-virtio-disk0 -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x7,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 -netdev tap,fd=26,id=hostnet0,vhost=on,vhostfd=28 -device virtio-net-pci,netdev=hostnet0,id=net0,mac=52:54:00:36:95:f0,bus=pci.0,addr=0x3 -chardev pty,id=charserial0 -device isa-serial,chardev=charserial0,id=serial0 -chardev socket,id=charchannel0,path=/var/lib/libvirt/qemu/channel/target/domain-7-csr1kv-1/org.qemu.guest_agent.0,server,nowait -device virtserialport,bus=virtio-serial0.0,nr=1,chardev=charchannel0,id=channel0,name=org.qemu.guest_agent.0 -chardev spicevmc,id=charchannel1,name=vdagent -device virtserialport,bus=virtio-serial0.0,nr=2,chardev=charchannel1,id=channel1,name=com.redhat.spice.0 -spice port=5900,addr=127.0.0.1,disable-ticketing,image-compression=off,seamless-migration=on -vga qxl -global qxl-vga.ram_size=67108864 -global qxl-vga.vram_size=67108864 -global qxl-vga.vgamem_mb=16 -global qxl-vga.max_outputs=1 -device vfio-pci,host=1d:00.0,id=hostdev1,bus=pci.0,addr=0x8 -device vfio-pci,host=3b:10.1,id=hostdev0,bus=pci.0,addr=0x4 -msg timestamp=on</span><br></pre></td></tr></table></figure><p>使用 virsh 命令或 virt-manager 开启虚拟机，是通过调用/usr/libexec/qemu-kvm 并附带虚拟配置的参数，来开启 qemu-kvm 的进程。可以看到上述的参数是非常复杂的，libvirt 提供 XML 参数进行简化。</p><p>ps -efL | grep qemu 可以列出所有的线程，但是输出篇幅很长，不在此列出；使用 pstree 可列出其父进程、线程关系，如下：</p><img src="/csr1kv-kvm-CentOS7/pstree-011.png" class="" title="Pstree"><p>virt-top 可查看虚机运行状态和资源利用率：</p><p>[root@centos7 ~]# virt-top -1</p><img src="/csr1kv-kvm-CentOS7/virt-top-012.png" class="" title="Virt-top"><h1 id="参考资料连接"><a href="#参考资料连接" class="headerlink" title="参考资料连接"></a>参考资料连接</h1><ul><li><a href="https://cloud.tencent.com/developer/article/1703094">https://cloud.tencent.com/developer/article/1703094</a></li><li><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/performance_tuning_guide/index">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/performance_tuning_guide/index</a></li><li><a href="https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html-single/virtualization_tuning_and_optimization_guide/index">https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html-single/virtualization_tuning_and_optimization_guide/index</a></li><li><a href="https://computingforgeeks.com/how-to-create-and-configure-bridge-networking-for-kvm-in-linux/">https://computingforgeeks.com/how-to-create-and-configure-bridge-networking-for-kvm-in-linux/</a></li><li><a href="https://software.intel.com/content/www/us/en/develop/articles/configure-sr-iov-network-virtual-functions-in-linux-kvm.html">https://software.intel.com/content/www/us/en/develop/articles/configure-sr-iov-network-virtual-functions-in-linux-kvm.html</a></li></ul>]]></content>
    
    
    <summary type="html">本文提供在 CentOS 7 版本上安装 KVM，并安装和设置 CSR 1000v/Catalyst 8000v 的指南，内容包括 SRIOV，KVM 调优以及 CSR1KV 初始化配置等内容。</summary>
    
    
    
    
    <category term="CSR1000v" scheme="https://weiborao.link/tags/CSR1000v/"/>
    
    <category term="KVM" scheme="https://weiborao.link/tags/KVM/"/>
    
    <category term="SRIOV" scheme="https://weiborao.link/tags/SRIOV/"/>
    
    <category term="NetworkManager" scheme="https://weiborao.link/tags/NetworkManager/"/>
    
    <category term="Cisco" scheme="https://weiborao.link/tags/Cisco/"/>
    
  </entry>
  
</feed>
