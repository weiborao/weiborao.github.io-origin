<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Rao Weiboçš„åšå®¢</title>
  
  
  <link href="https://weiborao.github.io/atom.xml" rel="self"/>
  
  <link href="https://weiborao.github.io/"/>
  <updated>2021-06-28T06:15:06.568Z</updated>
  <id>https://weiborao.github.io/</id>
  
  <author>
    <name>Rao Weibo</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>é€šè¿‡Wiresharké‡æ–°è®¤è¯†Traceroute</title>
    <link href="https://weiborao.github.io/get-known-traceroute-by-wireshark.html"/>
    <id>https://weiborao.github.io/get-known-traceroute-by-wireshark.html</id>
    <published>2021-06-27T06:50:00.000Z</published>
    <updated>2021-06-28T06:15:06.568Z</updated>
    
    <content type="html"><![CDATA[<h1 id="åˆè¯†Traceroute"><a href="#åˆè¯†Traceroute" class="headerlink" title="åˆè¯†Traceroute"></a>åˆè¯†Traceroute</h1><p>Tracerouteæ˜¯ä¸€ç§å¸¸è§çš„ç½‘ç»œåˆ†æå·¥å…·ï¼Œç”¨äºæ¢æµ‹æ•°æ®åŒ…ä»æºåœ°å€åˆ°ç›®çš„åœ°å€ç»è¿‡çš„è·¯ç”±å™¨çš„IPåœ°å€ã€‚</p><p>ä»¥ä¸‹çš„ç¤ºä¾‹æ˜¾ç¤ºä»ä¸€ä¸ªMACç”µè„‘åˆ°8.8.8.8çš„è·¯å¾„æ¢æµ‹ç»“æœï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ traceroute 8.8.8.8</span><br><span class="line">traceroute to 8.8.8.8 (8.8.8.8), 64 hops max, 52 byte packets</span><br><span class="line"> 1  localhost (10.39.101.1)  8.662 ms  1.307 ms  1.155 ms</span><br><span class="line"> 2  localhost (192.168.1.1)  2.287 ms  2.157 ms  1.897 ms</span><br><span class="line"> 3  222.129.32.1 (222.129.32.1)  5.844 ms  13.092 ms  10.332 ms</span><br><span class="line"> 4  114.244.95.105 (114.244.95.105)  7.541 ms</span><br><span class="line">    61.51.101.101 (61.51.101.101)  7.420 ms</span><br><span class="line">    61.148.163.81 (61.148.163.81)  7.075 ms</span><br><span class="line"> 5  61.148.4.213 (61.148.4.213)  7.759 ms</span><br><span class="line">    219.232.11.65 (219.232.11.65)  5.976 ms</span><br><span class="line">    bt-230-081.bta.net.cn (202.106.230.81)  6.021 ms</span><br><span class="line"> 6  202.96.12.13 (202.96.12.13)  7.828 ms * *</span><br><span class="line"> 7  219.158.112.26 (219.158.112.26)  39.486 ms *</span><br><span class="line">    219.158.7.22 (219.158.7.22)  45.959 ms</span><br><span class="line"> 8  219.158.103.218 (219.158.103.218)  48.469 ms</span><br><span class="line">    219.158.97.2 (219.158.97.2)  47.146 ms</span><br><span class="line">    219.158.103.218 (219.158.103.218)  50.320 ms</span><br><span class="line"> 9  219.158.103.30 (219.158.103.30)  50.739 ms  50.382 ms  48.348 ms</span><br><span class="line">10  219.158.10.30 (219.158.10.30)  49.927 ms  44.264 ms  56.353 ms</span><br><span class="line">11  219.158.33.174 (219.158.33.174)  54.123 ms  61.131 ms  47.302 ms</span><br><span class="line">12  108.170.241.97 (108.170.241.97)  56.082 ms</span><br><span class="line">    108.170.241.33 (108.170.241.33)  52.942 ms  54.393 ms</span><br><span class="line">13  142.250.58.189 (142.250.58.189)  48.958 ms</span><br><span class="line">    209.85.143.37 (209.85.143.37)  51.217 ms</span><br><span class="line">    108.170.226.115 (108.170.226.115)  141.544 ms</span><br><span class="line">14  dns.google (8.8.8.8)  48.935 ms  46.364 ms  51.043 ms</span><br><span class="line"></span><br><span class="line">âœ  ~ ping 8.8.8.8</span><br><span class="line">PING 8.8.8.8 (8.8.8.8): 56 data bytes</span><br><span class="line">64 bytes from 8.8.8.8: icmp_seq=0 ttl=113 time=52.060 ms</span><br><span class="line">64 bytes from 8.8.8.8: icmp_seq=1 ttl=113 time=44.845 ms</span><br><span class="line">64 bytes from 8.8.8.8: icmp_seq=2 ttl=113 time=52.393 ms</span><br><span class="line">64 bytes from 8.8.8.8: icmp_seq=3 ttl=113 time=51.059 ms</span><br><span class="line">64 bytes from 8.8.8.8: icmp_seq=4 ttl=113 time=44.437 ms</span><br><span class="line">64 bytes from 8.8.8.8: icmp_seq=5 ttl=113 time=44.534 ms</span><br><span class="line">^C</span><br><span class="line">--- 8.8.8.8 ping statistics ---</span><br><span class="line">6 packets transmitted, 6 packets received, 0.0% packet loss</span><br><span class="line">round-trip min/avg/max/stddev = 44.437/48.221/52.393/3.640 ms</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœè¡¨æ˜ï¼š</p><ol><li>ä»MACç”µè„‘åˆ°8.8.8.8çš„è·¯å¾„åŒ…å«14ä¸ªç½‘ç»œèŠ‚ç‚¹ã€‚</li><li>æ¯ä¸ªèŠ‚ç‚¹åé¢éƒ½æ˜¾ç¤ºæ—¶å»¶ä¿¡æ¯ï¼Œè¡¨æ˜ä»MACç”µè„‘åˆ°è¯¥èŠ‚ç‚¹çš„å¾€è¿”æ—¶å»¶ã€‚æ‚¨å¯èƒ½ä¼šå‘ç°ï¼Œä¸­é—´çš„æŸäº›èŠ‚ç‚¹å¾€è¿”æ—¶å»¶å¯èƒ½è¦é«˜äºæ›´è¿œçš„èŠ‚ç‚¹çš„å¾€è¿”æ—¶å»¶ã€‚è¿™æ˜¯ç”±äºè¯¥æ—¶å»¶åŒ…å«äº†è·¯ç”±å™¨å°†TTL=0çš„æŠ¥æ–‡äº¤ç»™æ§åˆ¶é¢å¤„ç†çš„æ—¶å»¶ï¼Œå› è€Œå¾€å¾€æ¯”è·¯å¾„ä¸Šçš„ä¼ æ’­æ—¶å»¶è¦é«˜ï¼Œå°¤å…¶æ˜¯å½“æ§åˆ¶é¢CPUç¹å¿™æ—¶ã€‚Tracerouteå¯¹æ¯ä¸€ä¸ªèŠ‚ç‚¹å‘å‡º3ä¸ªæ¢æµ‹æŠ¥æ–‡ï¼Œæ¯ä¸ªæŠ¥æ–‡çš„è·¯å¾„ä¸å°½ç›¸åŒï¼Œä¾‹å¦‚åœ¨ç¬¬4ã€5ã€7ã€8ã€12ã€13è·³ç»è¿‡ä¸åŒçš„è·¯ç”±å™¨è½¬å‘ã€‚</li><li>æœ‰çš„æ¢æµ‹æ²¡æœ‰å¾—åˆ°å›åº”ï¼Œå› æ­¤åœ¨æœ‰çš„èŠ‚ç‚¹æœ¬åº”æ˜¾ç¤ºæ—¶å»¶ä¿¡æ¯çš„ï¼Œæ˜¾ç¤ºäº†*ã€‚è¿™å¹¶ä¸èƒ½æ–­å®šä¸­é—´çš„ç½‘ç»œä¸å¯è¾¾ï¼Œå¾ˆå¯èƒ½çš„åŸå› æ˜¯è¯¥èŠ‚ç‚¹çš„è·¯ç”±å™¨åœ¨æ¥å£ä¸Šé…ç½®äº† <strong><em>no ip unreachable</em></strong> å‘½ä»¤ï¼Œè¯¥æ¥å£ä¸å›åº”ICMP Unreachableæ¶ˆæ¯ï¼Œè€Œè¯¥æ¶ˆæ¯æ­£æ˜¯Tracerouteæ¢æµ‹è·¯å¾„æ‰€ä¾èµ–çš„ä¿¡æ¯æ¥æºã€‚</li></ol><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç®€è¦æè¿°ä¸€ä¸‹ï¼Œåœ¨MACç”µè„‘ä¸‹ï¼ŒTracerouteçš„å·¥ä½œåŸç†ï¼Œå¹¶ä½¿ç”¨Wiresharkè¿›ä¸€æ­¥çš„æ¢ç©¶Tracerouteçš„å·¥ä½œè¿‡ç¨‹ã€‚</p><h1 id="Tracerouteçš„å·¥ä½œåŸç†"><a href="#Tracerouteçš„å·¥ä½œåŸç†" class="headerlink" title="Tracerouteçš„å·¥ä½œåŸç†"></a>Tracerouteçš„å·¥ä½œåŸç†</h1><p>æ¯å½“IPæ•°æ®åŒ…ç»è¿‡ä¸€ä¸ªè·¯ç”±å™¨ï¼Œå…¶å­˜æ´»æ—¶é—´TTLå°±ä¼šå‡1ã€‚å½“å…¶å­˜æ´»æ—¶é—´æ˜¯0æ—¶ï¼Œä¸»æœºä¾¿å–æ¶ˆæ•°æ®åŒ…ï¼Œå¹¶å‘é€ä¸€ä¸ªICMP TTLè¶…æ—¶æ•°æ®åŒ…ç»™åŸæ•°æ®åŒ…çš„å‘å‡ºè€…ã€‚Tracerouteç¨‹åºé€šè¿‡å‘ç›®çš„åœ°å€å‘é€ä¸€ç³»åˆ—çš„æ¢æµ‹åŒ…ï¼Œè®¾ç½®æ¢æµ‹åŒ…çš„TTLåˆå§‹å€¼åˆ†åˆ«ä¸º1,2,3â€¦ï¼Œæ ¹æ®è¿”å›çš„è¶…æ—¶é€šçŸ¥ï¼ˆICMP Time Exceeded Messageï¼‰å¾—åˆ°æºåœ°å€ä¸ç›®çš„åœ°å€ä¹‹é—´çš„æ¯ä¸€è·³è·¯ç”±ä¿¡æ¯ã€‚</p><img src="/get-known-traceroute-by-wireshark/Traceroute-work.png" class="" title="Traceroute çš„å·¥ä½œåŸç†"><ol><li><p>ä»æºåœ°å€å‘å‡ºä¸€ä¸ªUDPæ¢æµ‹åŒ…åˆ°ç›®çš„åœ°å€ï¼Œå¹¶å°†TTLè®¾ç½®ä¸º1ï¼›</p></li><li><p>åˆ°è¾¾è·¯ç”±å™¨æ—¶ï¼Œå°†TTLå‡1ï¼›</p></li><li><p>å½“TTLå˜ä¸º0æ—¶ï¼ŒåŒ…è¢«ä¸¢å¼ƒï¼Œè·¯ç”±å™¨å‘æºåœ°å€å‘å›ä¸€ä¸ªICMPè¶…æ—¶é€šçŸ¥ï¼ˆICMP Time Exceeded Messageï¼‰ï¼Œå†…å«å‘é€IPåŒ…çš„æºåœ°å€ï¼ŒIPåŒ…çš„æ‰€æœ‰å†…å®¹åŠè·¯ç”±å™¨çš„IPåœ°å€ï¼›</p></li><li><p>å½“æºåœ°å€æ”¶åˆ°è¯¥ICMPåŒ…æ—¶ï¼Œæ˜¾ç¤ºè¿™ä¸€è·³è·¯ç”±ä¿¡æ¯ï¼›</p></li><li><p>é‡å¤1ï½5ï¼Œå¹¶æ¯æ¬¡è®¾ç½®TTLåŠ 1ï¼›</p></li><li><p>ç›´è‡³ç›®æ ‡åœ°å€æ”¶åˆ°æ¢æµ‹æ•°æ®åŒ…ï¼Œå¹¶è¿”å›ç«¯å£ä¸å¯è¾¾é€šçŸ¥ï¼ˆICMP Port Unreachableï¼‰ï¼›</p></li><li><p>å½“æºåœ°å€æ”¶åˆ°ICMP Port UnreachableåŒ…æ—¶åœæ­¢tracerouteã€‚</p></li></ol><p>ä»¥ä¸Šå†…å®¹å¼•è‡ª<a href="https://blog.csdn.net/shb_derek1/article/details/100097050">Traceroute/tracertåŸç†å’Œå®è·µ</a></p><h1 id="é€šè¿‡Wiresharkæ¢ç©¶Traceroute"><a href="#é€šè¿‡Wiresharkæ¢ç©¶Traceroute" class="headerlink" title="é€šè¿‡Wiresharkæ¢ç©¶Traceroute"></a>é€šè¿‡Wiresharkæ¢ç©¶Traceroute</h1><h2 id="åœ¨Tracerouteè¾“å‡ºç»“æœä¸­æ˜¾ç¤ºASå·"><a href="#åœ¨Tracerouteè¾“å‡ºç»“æœä¸­æ˜¾ç¤ºASå·" class="headerlink" title="åœ¨Tracerouteè¾“å‡ºç»“æœä¸­æ˜¾ç¤ºASå·"></a>åœ¨Tracerouteè¾“å‡ºç»“æœä¸­æ˜¾ç¤ºASå·</h2><p>åœ¨Macç”µè„‘çš„Tracerouteå‘½ä»¤ä¸­ï¼Œé€šè¿‡â€™-aâ€™çš„å‚æ•°å¯ä»¥å¼€å¯è·¯å¾„ä¸­é‡åˆ°çš„IPåœ°å€æ‰€åœ¨çš„BGP ASå·ï¼Œä»¥ä¾¿äºè·çŸ¥è·¯å¾„ä¸­æ¯ä¸€è·³æ‰€å½’å±çš„è¿è¥å•†ï¼Œé€šè¿‡â€™-q 1â€™å¯å°†ç¼ºçœå‘é€3ä¸ªæ¢æµ‹æŠ¥æ–‡æ”¹ä¸ºå‘é€1ä¸ªæ¢æµ‹æŠ¥æ–‡ï¼Œè¾“å‡ºç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ traceroute -aq 1 8.8.8.8</span><br><span class="line">traceroute to 8.8.8.8 (8.8.8.8), 64 hops max, 52 byte packets</span><br><span class="line"> 1  [AS0] bogon (10.39.101.1)  2.424 ms</span><br><span class="line"> 2  [AS0] localhost (192.168.1.1)  3.031 ms</span><br><span class="line"> 3  [AS4808] 222.129.32.1 (222.129.32.1)  6.496 ms</span><br><span class="line"> 4  [AS4808] 61.51.101.101 (61.51.101.101)  8.114 ms</span><br><span class="line"> 5  [AS17431] 219.232.11.29 (219.232.11.29)  5.865 ms</span><br><span class="line"> 6  [AS4808] 202.96.12.13 (202.96.12.13)  6.558 ms</span><br><span class="line"> 7  [AS4837] 219.158.112.46 (219.158.112.46)  44.826 ms</span><br><span class="line"> 8  [AS4837] 219.158.103.218 (219.158.103.218)  52.181 ms</span><br><span class="line"> 9  [AS4837] 219.158.103.30 (219.158.103.30)  47.851 ms</span><br><span class="line">10  [AS4837] 219.158.10.30 (219.158.10.30)  56.963 ms</span><br><span class="line">11  [AS4837] 219.158.33.174 (219.158.33.174)  46.523 ms</span><br><span class="line">12  [AS15169] 108.170.241.1 (108.170.241.1)  48.503 ms</span><br><span class="line">13  [AS15169] 172.253.64.111 (172.253.64.111)  142.926 ms</span><br><span class="line">14  [AS15169] dns.google (8.8.8.8)  52.208 ms</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°çš„ASç¼–å·ä¿¡æ¯æ˜¯å¦‚ä½•è·å¾—çš„ï¼Ÿä¸‹é¢æˆ‘ä»¬é€šè¿‡WiresharkæŠ“å–æŠ¥æ–‡è¿›è¡Œåˆ†æã€‚</p><h2 id="ä¸Šè¿°Tracerouteçš„æ”¶å‘åŒ…è¿‡ç¨‹ç®€è¿°"><a href="#ä¸Šè¿°Tracerouteçš„æ”¶å‘åŒ…è¿‡ç¨‹ç®€è¿°" class="headerlink" title="ä¸Šè¿°Tracerouteçš„æ”¶å‘åŒ…è¿‡ç¨‹ç®€è¿°"></a>ä¸Šè¿°Tracerouteçš„æ”¶å‘åŒ…è¿‡ç¨‹ç®€è¿°</h2><p>å¼€å¯Wiresharkï¼Œå¹¶è¿…é€Ÿæ‰§è¡Œ<strong>traceroute -aq 1 8.8.8.8</strong>ï¼ŒTracerouteå®Œæ•´è¾“å‡ºåï¼Œåœæ­¢Wiresharkçš„æŠ¥æ–‡æŠ“å–ã€‚<br>é’ˆå¯¹æŠ“å–çš„æŠ¥æ–‡è¿›è¡Œè¿‡æ»¤ï¼Œåœ¨è¿‡æ»¤æ¡†ä¸­è¾“å…¥ <strong>udp or icmp or ip.addr == 198.108.0.18</strong><br>ç»è¿‡Wiresharkçš„æŠ¥æ–‡åˆ†æï¼Œä»¥ä¸‹ä¸ºTracerouteçš„ç®€è¦çš„æ”¶å‘åŒ…è¿‡ç¨‹ï¼š</p><ol><li>å‘èµ·DNSæŸ¥è¯¢ï¼ŒæŸ¥è¯¢<strong>whois.radb.net</strong>åŸŸåï¼Œå¾—åˆ°åº”ç­”ä¸º198.108.0.18â€”-ä¸Šè¿°è¿‡æ»¤å™¨ä¸­IPåœ°å€æ¥æºäºæ­¤ã€‚</li><li>å‘èµ·TCPè¿æ¥è¯·æ±‚ï¼Œä¸198.108.0.18å»ºç«‹TCPè¿æ¥ã€‚</li><li>å‘8.8.8.8å‘èµ·UDPæŠ¥æ–‡ï¼Œç›®çš„ç«¯å£ä¸º33435ï¼ŒTTLè®¾ç½®ä¸º1</li><li>æ”¶åˆ°è·¯ç”±å™¨çš„ICMP TTLè¶…æ—¶æ¶ˆæ¯ï¼Œè·å–è·¯ç”±å™¨å¯¹åº”çš„IPåœ°å€</li><li>å‘<strong>whois.radb.net</strong>å‘èµ·æŸ¥è¯¢ï¼Œè¯¢é—®è·¯ç”±å™¨IPåœ°å€å¯¹åº”çš„ASå·ï¼Œå¹¶å¾—åˆ°å›åº”ï¼Œå¦‚æœæ˜¯ç§æœ‰åœ°å€ï¼Œå…¶ASå·ä¸º0ã€‚</li><li>å°è¯•å‘DNSæœåŠ¡å™¨æŸ¥è¯¢è·¯ç”±å™¨IPåœ°å€çš„åå‘åŸŸåè§£æï¼Œå¦‚æœå¾—åˆ°åŸŸåï¼Œå°±å°†å…¶æ˜¾ç¤ºåœ¨Tracerouteçš„è¾“å‡ºç»“æœä¸­ã€‚</li><li>é‡å¤ä¸Šè¿°ç¬¬3~6æ­¥ï¼Œæ¯æ¬¡å°†TTLåŠ 1ï¼Œç›´è‡³ç›®æ ‡åœ°å€æ¥æ”¶åˆ°æ¢æµ‹æŠ¥æ–‡ï¼Œå¹¶è¿”å›ICMP Port Unreachableæ¶ˆæ¯ã€‚</li></ol><h2 id="WiresharkæŠ“åŒ…è¯¦ç»†åˆ†æ"><a href="#WiresharkæŠ“åŒ…è¯¦ç»†åˆ†æ" class="headerlink" title="WiresharkæŠ“åŒ…è¯¦ç»†åˆ†æ"></a>WiresharkæŠ“åŒ…è¯¦ç»†åˆ†æ</h2><p>ä¸‹å›¾ä¸ºWiresharkæŠ“å–çš„æŠ¥æ–‡çš„å‰36ä¸ªï¼š<img src="/get-known-traceroute-by-wireshark/packet1-36.png" class="" title="packet1-36"></p><ol><li><p>ç¬¬1å’Œç¬¬2ä¸ªæŠ¥æ–‡ä¸ºDNSæŸ¥è¯¢ï¼ŒæŸ¥è¯¢whois.radb.netçš„åœ°å€ä¸º198.108.0.18ã€‚</p></li><li><p>ç¬¬3~5çš„æŠ¥æ–‡ä¸ºTCPä¸‰æ¬¡æ¡æ‰‹ï¼Œå¹¶æˆåŠŸå»ºç«‹TCP è¿æ¥10.39.101.141:51705&lt;â€”&gt;198.108.0.18:43ï¼ŒTCP 43ç«¯å£é€šå¸¸æ˜¯whois serverçš„ç«¯å£ã€‚</p></li><li><p>ç¬¬6ä¸ªæŠ¥æ–‡ç”±10.39.101.141å‘å‘198.108.0.18ï¼Œå¹¶å°†PSHç½®ä½ï¼Œè¯·æ±‚æ¥æ”¶ç«¯ä¸€æ”¶åˆ°å°±è¿›è¡Œå‘ä¸Šäº¤ä»˜ï¼Œä»¥ç¼©çŸ­Tracerouteçš„ç­‰å¾…æ—¶é—´ã€‚</p></li><li><p>ç¬¬7ä¸ªæŠ¥æ–‡å‘å‡ºç¬¬ä¸€ä¸ªUDPçš„æ¢æµ‹æŠ¥æ–‡ï¼Œç›®æ ‡ç«¯å£å·ä¸º33435ï¼ŒTTL=1ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><img src="/get-known-traceroute-by-wireshark/UDP-Probe-1.png" class="" title="UDP-Probe-1"></li><li><p>ç¬¬8ä¸ªæŠ¥æ–‡ä¸ºç½‘å…³å›å¤çš„ICMP Time-to-live exceeded (Time to live exceeded in transit)æŠ¥æ–‡ï¼ŒTracerouteä»IPæŠ¥æ–‡ä¸­çš„æºåœ°å€è·å–è·¯ç”±å™¨çš„IPåœ°å€10.39.101.1ã€‚è¯¥æŠ¥æ–‡åŒ…å«åŸå§‹çš„UDPæŠ¥æ–‡ä¿¡æ¯ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><img src="/get-known-traceroute-by-wireshark/ICMP-Reply-1.png" class="" title="ICMP-Reply-1"></li><li><p>ç¬¬9ä¸ªæŠ¥æ–‡ä¸ºç¬¬6ä¸ªæŠ¥æ–‡çš„TCPç¡®è®¤æŠ¥æ–‡ï¼Œç¬¬10ä¸ªæŠ¥æ–‡ä¸ºå‘whois.radb.netæŸ¥è¯¢ç½‘å…³10.39.101.1/32æ‰€åœ¨çš„ASå·ã€‚ç¬¬11ä¸ªæŠ¥æ–‡ä¸ºç¬¬10ä¸ªæŠ¥æ–‡çš„TCPç¡®è®¤ï¼Œç¬¬12ä¸ªæŠ¥æ–‡ç­”å¤æŸ¥è¯¢ç»“æœï¼Œç”±äºè¯¥åœ°å€ä¸ºç§æœ‰IPåœ°å€æ®µï¼Œæ²¡æœ‰æŸ¥è¯¢åˆ°ç»“æœï¼Œå› æ­¤Traceroute å°†ASå·æ˜¾ç¤ºä¸º[AS0]ã€‚ä»¥ä¸‹ä½¿ç”¨ç¬¬29å’Œ30æŠ¥æ–‡ï¼Œç”¨äºå±•ç¤ºASå·æŸ¥è¯¢çš„æŠ¥æ–‡ï¼Œå¦‚ä¸‹ï¼š</p><img src="/get-known-traceroute-by-wireshark/AS-query-1.png" class="" title="AS-query-1"><img src="/get-known-traceroute-by-wireshark/AS-reply-1.png" class="" title="AS-reply-1"><p>æŸ¥è¯¢ç»“æœçš„æ–‡æœ¬å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">route:      222.129.0.0/18</span><br><span class="line">descr:      CMI  (Customer Route)</span><br><span class="line">origin:     AS4808</span><br><span class="line">mnt-by:     MAINT-AS58453</span><br><span class="line">changed:    qas_support@cmi.chinamobile.com 20160525</span><br><span class="line">source:     RADB</span><br><span class="line"></span><br><span class="line">route:          222.128.0.0/14</span><br><span class="line">descr:          China Unicom Beijing Province Network</span><br><span class="line">country:        CN</span><br><span class="line">origin:         AS4808</span><br><span class="line">mnt-by:         MAINT-CNCGROUP-RR</span><br><span class="line">changed:        abuse@cnc-noc.net 20160516</span><br><span class="line">source:         APNIC</span><br><span class="line"></span><br><span class="line">route:      222.129.0.0/18</span><br><span class="line">descr:      CMI IP Transit</span><br><span class="line">origin:     AS4808</span><br><span class="line">admin-c:    MAINT-CMI-INT-HK</span><br><span class="line">tech-c:     MAINT-CMI-INT-HK</span><br><span class="line">mnt-by:     MAINT-CMI-INT-HK</span><br><span class="line">changed:    qas_support@cmi.chinamobile.com 20160525</span><br><span class="line">source:     NTTCOM</span><br></pre></td></tr></table></figure></li><li><p>ç¬¬14~17æŠ¥æ–‡æ˜¯DNSè§£ææŠ¥æ–‡ï¼Œåˆ†åˆ«å¯¹ä¸»æœºåWERAO-M-40KAè¿›è¡ŒåŸŸåè§£æï¼Œä»¥åŠå¯¹ç½‘å…³IP 10.39.101.1è¿›è¡Œåå‘åŸŸåè§£æï¼Œç”±äºæ˜¯ç§æœ‰ä¸»æœºåå’Œç§æœ‰åœ°å€ï¼Œè‡ªç„¶å…¬ç½‘DNSæ˜¯è§£æä¸å‡ºæ¥ã€‚ä»¥ä¸‹å°†é’ˆå¯¹8.8.8.8è¿›è¡Œåå‘åŸŸåè§£æä¸ºdns.googleçš„æˆªå›¾ä½œä¸ºç¤ºä¾‹ï¼š</p><img src="/get-known-traceroute-by-wireshark/dns-query-1.png" class="" title="dns-query-1"></li><li><p>æŠ¥æ–‡18~26é‡å¤æŠ¥æ–‡7~17çš„è¿‡ç¨‹ï¼Œå…¶ä¸­æŠ¥æ–‡18çš„TTLä¸º2ï¼Œå¦‚ä¸‹ï¼š</p><img src="/get-known-traceroute-by-wireshark/UDP-Probe-2.png" class="" title="UDP-Probe-2"><p>è¿‡ç¨‹æŒç»­è‡³8.8.8.8è¿”å›Code: 3 (Port unreachable)çš„æ¶ˆæ¯ï¼Œå¹¶å¯¹8.8.8.8è¿›è¡Œåå‘åŸŸåè§£æã€‚</p><img src="/get-known-traceroute-by-wireshark/ICMP-last-reply.png" class="" title="ICMP-last-reply"></li></ol><p>ä»¥ä¸Šè¯¦ç»†çš„åˆ†æäº†<strong>traceroute -aq 1 8.8.8.8</strong>çš„æŠ¥æ–‡æ”¶å‘è¿‡ç¨‹ã€‚</p><h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>åœ¨ä¸Šè¿°çš„Tracerouteå®Œæˆè¾“å‡ºåï¼ŒWiresharkæˆåŠŸçš„å°†Whoisçš„äº¤äº’æŠ¥æ–‡è¿›è¡Œé‡æ–°ç»„è£…ï¼Œå¹¶å®Œæˆå†…å®¹çš„è§£æã€‚</p><p>åœ¨Wiresharkåˆ†æå®Œç¬¬133ä¸ªæŠ¥æ–‡åï¼ŒWiresharkæˆåŠŸçš„ç»„è£…å‡ºwhoisçš„æŸ¥è¯¢æŠ¥æ–‡ï¼Œå¦‚ä¸‹ï¼š</p><img src="/get-known-traceroute-by-wireshark/whois-query.png" class="" title="whois-query"><p>åœ¨Wiresharkåˆ†æå®Œç¬¬135ä¸ªæŠ¥æ–‡åï¼ŒWiresharkæˆåŠŸçš„ç»„è£…å‡ºWhoisçš„åº”ç­”æŠ¥æ–‡ï¼Œå¦‚ä¸‹ï¼š</p><img src="/get-known-traceroute-by-wireshark/whois-answer.png" class="" title="whois-answer"><p>åœ¨Terminalæ‰§è¡Œwhois 8.8.8.8/32ï¼Œå¹¶è¿›è¡ŒæŠ¥æ–‡æŠ“å–ï¼Œè§£æå‡ºWhoisçš„æŠ¥æ–‡åº”ç­”å¦‚ä¸‹ï¼š</p><img src="/get-known-traceroute-by-wireshark/whois-answer-2.png" class="" title="whois-answer-2"><p>è¯¥æŠ¥æ–‡ä¹Ÿæ˜¯Wireshark æ‹¼è£…äº†å¤šä¸ªTCP Segmentï¼Œ#101ã€#103ã€#104ã€#106ã€#109åè§£æå‡ºæ¥çš„ã€‚å¯¹æ¯”è¯¥è§£æç»“æœå’Œä¸Šæ–‡ä¸­ï¼ŒTracerouteè¿‡ç¨‹ä¸­çš„æŸ¥è¯¢ç»“æœï¼Œå¯ä»¥å‘ç°ï¼ŒæŠ¥æ–‡ç»“æ„æ˜¯ä¸€è‡´çš„ï¼Œéƒ½è¢«Wiresharkè§£ææˆWhoisçš„æŠ¥æ–‡ã€‚</p><p>æ®æ­¤ï¼Œæˆ‘æ¨æµ‹ï¼ŒMACç”µè„‘ä¸Šçš„Traceroute åœ¨å¢åŠ äº†-açš„å‚æ•°åï¼Œä¼šä¸»åŠ¨å‘èµ·WhoisæŸ¥è¯¢ï¼Œç¼ºçœçš„WhoisæœåŠ¡å™¨æ˜¯whois.radb.netã€‚</p><p>æ­¤éƒ¨åˆ†å†…å®¹æ˜¯åœ¨Tracerouteæ”¶å‘åŒ…è¿‡ç¨‹åˆ†æå®Œæˆåï¼Œå†åçŸ¥åè§‰å‘ç°çš„ï¼Œå› æ­¤å°†æ­¤éƒ¨åˆ†å†…å®¹ä½œä¸ºâ€œåè®°â€è¿›è¡Œè®°å½•ã€‚</p><h1 id="Traceroute-è¿›é˜¶ç‰ˆå·¥å…·MTR"><a href="#Traceroute-è¿›é˜¶ç‰ˆå·¥å…·MTR" class="headerlink" title="Traceroute è¿›é˜¶ç‰ˆå·¥å…·MTR"></a>Traceroute è¿›é˜¶ç‰ˆå·¥å…·MTR</h1><p>MTR ï¼ˆMy Tracerouteï¼‰å·¥å…·å°†pingå’Œtracerouteå‘½ä»¤çš„åŠŸèƒ½å¹¶å…¥äº†åŒä¸€ä¸ªå·¥å…·ä¸­ï¼Œå®ç°æ›´å¼ºå¤§çš„åŠŸèƒ½ã€‚ç›¸å¯¹äºtracerouteå‘½ä»¤åªä¼šåšä¸€æ¬¡é“¾è·¯è·Ÿè¸ªæµ‹è¯•ï¼Œmtrå‘½ä»¤ä¼šå¯¹é“¾è·¯ä¸Šçš„ç›¸å…³èŠ‚ç‚¹åšæŒç»­æ¢æµ‹å¹¶ç»™å‡ºç›¸åº”çš„ç»Ÿè®¡ä¿¡æ¯ã€‚</p><p>å¦‚ä¸‹ä¸ºMTRçš„è¾“å‡ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ sudo mtr -ry 4 8.8.8.8</span><br><span class="line">Start: 2021-06-27T23:37:21+0800</span><br><span class="line">HOST: WERAO-M-40KA                Loss%   Snt   Last   Avg  Best  Wrst StDev</span><br><span class="line">  1. ???        localhost          0.0%    10    1.8   2.2   1.2  10.1   2.8</span><br><span class="line">  2. ???        bogon              0.0%    10    2.2   2.3   1.9   3.3   0.5</span><br><span class="line">  3. 2003-11-19 222.129.32.1       0.0%    10    6.3   9.5   5.0  29.2   7.7</span><br><span class="line">  4. 2000-03-14 61.148.163.181     0.0%    10    5.3   7.4   5.3   8.7   1.2</span><br><span class="line">  5. 2002-04-17 219.232.11.65     70.0%    10    5.4   6.1   5.4   6.8   0.7</span><br><span class="line">  6. 2006-01-09 124.65.194.153    30.0%    10   28.9   9.6   5.7  28.9   8.5</span><br><span class="line">  7. 2002-03-21 219.158.112.26    40.0%    10   38.9  44.2  38.5  63.7   9.7</span><br><span class="line">  8. 2002-03-21 219.158.19.66      0.0%    10   74.4  64.1  46.4  74.4   8.8</span><br><span class="line">  9. 2002-03-21 219.158.97.25      0.0%    10   90.8  90.8  82.2  96.7   4.3</span><br><span class="line"> 10. 2002-03-21 219.158.20.94      0.0%    10   97.5  89.8  74.1 104.6  11.8</span><br><span class="line"> 11. 2002-03-21 219.158.33.174     0.0%    10   73.0  62.1  49.7  74.0   8.5</span><br><span class="line"> 12. 2012-02-07 108.170.241.65     0.0%    10   59.0  67.3  53.1  75.4   7.2</span><br><span class="line"> 13. 2013-04-04 172.253.69.229    10.0%    10   62.9  68.3  54.5  76.6   6.5</span><br><span class="line"> 14. 1992-12-01 dns.google         0.0%    10   71.0  65.6  56.4  71.0   5.7</span><br></pre></td></tr></table></figure><p>MTRå‘½ä»¤ï¼Œé€šè¿‡-r è¾“å‡ºæŠ¥å‘Šï¼Œ-z å¯è¾“å‡ºåœ°å€æ‰€åœ¨çš„ASå·ï¼Œ-y 4 å¯è¾“å‡ºè¯¥åœ°å€çš„åˆ†é…æ—¶é—´ã€‚</p><p>è¾“å‡ºä¿¡æ¯è§£é‡Šå¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ä¸€åˆ—ï¼ˆHostï¼‰ï¼šèŠ‚ç‚¹IPåœ°å€å’ŒåŸŸåã€‚</li><li>ç¬¬äºŒåˆ—ï¼ˆLoss%ï¼‰ï¼šèŠ‚ç‚¹ä¸¢åŒ…ç‡ã€‚</li><li>ç¬¬ä¸‰åˆ—ï¼ˆSntï¼‰ï¼šå‘é€çš„PingåŒ…æ•°ã€‚é»˜è®¤å€¼æ˜¯10ï¼Œå¯ä»¥é€šè¿‡å‚æ•°â€œ-câ€æŒ‡å®šã€‚</li><li>ç¬¬å››åˆ—ï¼ˆLastï¼‰ï¼šæœ€è¿‘ä¸€æ¬¡çš„æ¢æµ‹å»¶è¿Ÿå€¼ã€‚</li><li>ç¬¬äº”ã€å…­ã€ä¸ƒåˆ—ï¼ˆAvgã€Bestã€Wrstï¼‰ï¼šåˆ†åˆ«æ˜¯æ¢æµ‹å»¶è¿Ÿçš„å¹³å‡å€¼ã€æœ€å°å€¼å’Œæœ€å¤§å€¼ã€‚</li><li>ç¬¬å…«åˆ—ï¼ˆStDevï¼‰ï¼šæ ‡å‡†åå·®ã€‚è¶Šå¤§è¯´æ˜ç›¸åº”èŠ‚ç‚¹è¶Šä¸ç¨³å®šã€‚</li></ul><p>ä¸Šè¿°è§£é‡Šå¼•ç”¨è‡ªï¼š<a href="https://help.aliyun.com/knowledge_detail/98706.html">MTRå·¥å…·ä½¿ç”¨è¯´æ˜ä¸ç»“æœåˆ†æ</a>ï¼Œç•¥æœ‰æ”¹åŠ¨ã€‚</p><h1 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h1><ol><li><p>David Tian:  èµï¼Œè¯·æ•™ä¸‹ï¼Œä¸ºä»€ä¹ˆipv4çš„traceroute ä¼šè§¦å‘ç”¨ipv6å»æŸ¥dnså‘¢ï¼Ÿ</p><p>ç­”ï¼šå¥½çœ¼åŠ›ï¼Œå¥½é—®é¢˜~~å®é™…ä¸Šï¼Œæˆ‘æŠ“å–çš„æŠ¥æ–‡ä¸­ï¼Œæ¯æ¬¡å¾—åˆ°ICMPæŠ¥æ–‡åï¼ŒTracerouteä¹Ÿä¼šå‘208.67.222.222å‘é€DNSè¯·æ±‚ã€‚ä½†æ˜¯æŠ¥æ–‡æ˜¯åŠ å¯†çš„ï¼Œçœ‹ä¸å‡ºæ˜¯ä»€ä¹ˆå†…å®¹ï¼Œä¸èƒ½çŒœæµ‹ï¼Œæ‰€ä»¥æˆ‘å°†è¿™äº›ä¸ç¡®å®šçš„æŠ¥æ–‡åˆ é™¤äº†ã€‚208.67.222.222æ˜¯OpenDNSçš„DNSæœåŠ¡å™¨ï¼Œè¿™æ˜¯Cisco ITè®¾ç½®çš„DNSæœåŠ¡å™¨ã€‚ğŸ˜„</p></li></ol><h1 id="é™„å½•"><a href="#é™„å½•" class="headerlink" title="é™„å½•"></a>é™„å½•</h1><p>ä»¥ä¸‹æ˜¯WiresharkæŠ“åŒ…æ–‡ä»¶çš„å‰60ä¸ªæŠ¥æ–‡çš„æ¦‚è§ˆã€‚</p><table><thead><tr><th>No.</th><th>Source</th><th>Destination</th><th>Protocol</th><th>Info</th></tr></thead><tbody><tr><td>1</td><td>fe80::1c7a:24fd:c837:3017</td><td>fe80::1</td><td>DNS</td><td>Standard query 0xc7d5 A whois.radb.net</td></tr><tr><td>2</td><td>fe80::1</td><td>fe80::1c7a:24fd:c837:3017</td><td>DNS</td><td>Standard query response 0xc7d5 A whois.radb.net A 198.108.0.18</td></tr><tr><td>3</td><td>10.39.101.141</td><td>198.108.0.18</td><td>TCP</td><td>51705 â†’ 43 [SYN] Seq=0 Win=65535 Len=0 MSS=1460 WS=64 TSval=2785245374  TSecr=0 SACK_PERM=1</td></tr><tr><td>4</td><td>198.108.0.18</td><td>10.39.101.141</td><td>TCP</td><td>43 â†’ 51705 [SYN, ACK] Seq=0 Ack=1 Win=28960 Len=0 MSS=1412  TSval=3642352050 TSecr=2785245374 WS=256</td></tr><tr><td>5</td><td>10.39.101.141</td><td>198.108.0.18</td><td>TCP</td><td>51705 â†’ 43 [ACK] Seq=1 Ack=1 Win=131584 Len=0 TSval=2785245692  TSecr=3642352050</td></tr><tr><td>6</td><td>10.39.101.141</td><td>198.108.0.18</td><td>TCP</td><td>51705 â†’ 43 [PSH, ACK] Seq=1 Ack=1 Win=131584 Len=3 TSval=2785245692  TSecr=3642352050 [TCP segment of a reassembled PDU]</td></tr><tr><td>7</td><td>10.39.101.141</td><td>8.8.8.8</td><td>UDP</td><td>36904 â†’ 33435 Len=24</td></tr><tr><td>8</td><td>10.39.101.1</td><td>10.39.101.141</td><td>ICMP</td><td>Time-to-live exceeded (Time to live exceeded in transit)</td></tr><tr><td>9</td><td>198.108.0.18</td><td>10.39.101.141</td><td>TCP</td><td>43 â†’ 51705 [ACK] Seq=1 Ack=4 Win=29184 Len=0 TSval=3642352370  TSecr=2785245692</td></tr><tr><td>10</td><td>10.39.101.141</td><td>198.108.0.18</td><td>TCP</td><td>51705 â†’ 43 [PSH, ACK] Seq=4 Ack=1 Win=131584 Len=19 TSval=2785246039  TSecr=3642352370 [TCP segment of a reassembled PDU]</td></tr><tr><td>11</td><td>198.108.0.18</td><td>10.39.101.141</td><td>TCP</td><td>43 â†’ 51705 [ACK] Seq=1 Ack=23 Win=29184 Len=0 TSval=3642352717  TSecr=2785246039</td></tr><tr><td>12</td><td>198.108.0.18</td><td>10.39.101.141</td><td>TCP</td><td>43 â†’ 51705 [PSH, ACK] Seq=1 Ack=23 Win=29184 Len=2 TSval=3642352717  TSecr=2785246039 [TCP segment of a reassembled PDU]</td></tr><tr><td>13</td><td>10.39.101.141</td><td>198.108.0.18</td><td>TCP</td><td>51705 â†’ 43 [ACK] Seq=23 Ack=3 Win=131584 Len=0 TSval=2785246448  TSecr=3642352717</td></tr><tr><td>14</td><td>fe80::1c7a:24fd:c837:3017</td><td>fe80::1</td><td>DNS</td><td>Standard query 0x93fc A WERAO-M-40KA</td></tr><tr><td>15</td><td>fe80::1</td><td>fe80::1c7a:24fd:c837:3017</td><td>DNS</td><td>Standard query response 0x93fc No such name A WERAO-M-40KA</td></tr><tr><td>16</td><td>fe80::1c7a:24fd:c837:3017</td><td>fe80::1</td><td>DNS</td><td>Standard query 0xbcf9 PTR 1.101.39.10.in-addr.arpa</td></tr><tr><td>17</td><td>fe80::1</td><td>fe80::1c7a:24fd:c837:3017</td><td>DNS</td><td>Standard query response 0xbcf9 PTR 1.101.39.10.in-addr.arpa PTR bogon</td></tr><tr><td>18</td><td>10.39.101.141</td><td>8.8.8.8</td><td>UDP</td><td>36904 â†’ 33436 Len=24</td></tr><tr><td>19</td><td>192.168.1.1</td><td>10.39.101.141</td><td>ICMP</td><td>Time-to-live exceeded (Time to live exceeded in transit)</td></tr><tr><td>20</td><td>10.39.101.141</td><td>198.108.0.18</td><td>TCP</td><td>51705 â†’ 43 [PSH, ACK] Seq=23 Ack=3 Win=131584 Len=19 TSval=2785248590  TSecr=3642352717 [TCP segment of a reassembled PDU]</td></tr><tr><td>21</td><td>10.39.101.141</td><td>10.39.101.1</td><td>DNS</td><td>Standard query 0xc81a A WERAO-M-40KA</td></tr><tr><td>22</td><td>10.39.101.1</td><td>10.39.101.141</td><td>DNS</td><td>Standard query response 0xc81a A WERAO-M-40KA A 10.39.101.141</td></tr><tr><td>23</td><td>198.108.0.18</td><td>10.39.101.141</td><td>TCP</td><td>43 â†’ 51705 [PSH, ACK] Seq=3 Ack=42 Win=29184 Len=2 TSval=3642355278  TSecr=2785248590 [TCP segment of a reassembled PDU]</td></tr><tr><td>24</td><td>10.39.101.141</td><td>198.108.0.18</td><td>TCP</td><td>51705 â†’ 43 [ACK] Seq=42 Ack=5 Win=131584 Len=0 TSval=2785248902  TSecr=3642355278</td></tr><tr><td>25</td><td>fe80::1c7a:24fd:c837:3017</td><td>fe80::1</td><td>DNS</td><td>Standard query 0x7504 PTR 1.1.168.192.in-addr.arpa</td></tr><tr><td>26</td><td>fe80::1</td><td>fe80::1c7a:24fd:c837:3017</td><td>DNS</td><td>Standard query response 0x7504 PTR 1.1.168.192.in-addr.arpa PTR localhost</td></tr><tr><td>27</td><td>10.39.101.141</td><td>8.8.8.8</td><td>UDP</td><td>36904 â†’ 33437 Len=24</td></tr><tr><td>28</td><td>222.129.32.1</td><td>10.39.101.141</td><td>ICMP</td><td>Time-to-live exceeded (Time to live exceeded in transit)</td></tr><tr><td>29</td><td>10.39.101.141</td><td>198.108.0.18</td><td>TCP</td><td>51705 â†’ 43 [PSH, ACK] Seq=42 Ack=5 Win=131584 Len=20 TSval=2785249974  TSecr=3642355278 [TCP segment of a reassembled PDU]</td></tr><tr><td>30</td><td>198.108.0.18</td><td>10.39.101.141</td><td>TCP</td><td>43 â†’ 51705 [PSH, ACK] Seq=5 Ack=62 Win=29184 Len=643 TSval=3642356666  TSecr=2785249974 [TCP segment of a reassembled PDU]</td></tr><tr><td>31</td><td>10.39.101.141</td><td>198.108.0.18</td><td>TCP</td><td>51705 â†’ 43 [ACK] Seq=62 Ack=648 Win=130944 Len=0 TSval=2785250324  TSecr=3642356666</td></tr><tr><td>32</td><td>fe80::1c7a:24fd:c837:3017</td><td>fe80::1</td><td>DNS</td><td>Standard query 0x4f56 PTR 1.32.129.222.in-addr.arpa</td></tr><tr><td>33</td><td>fe80::1</td><td>fe80::1c7a:24fd:c837:3017</td><td>DNS</td><td>Standard query response 0x4f56 No such name PTR 1.32.129.222.in-addr.arpa</td></tr><tr><td>34</td><td>10.39.101.141</td><td>8.8.8.8</td><td>UDP</td><td>36904 â†’ 33438 Len=24</td></tr><tr><td>35</td><td>61.51.101.101</td><td>10.39.101.141</td><td>ICMP</td><td>Time-to-live exceeded (Time to live exceeded in transit)</td></tr><tr><td>36</td><td>10.39.101.141</td><td>198.108.0.18</td><td>TCP</td><td>51705 â†’ 43 [PSH, ACK] Seq=62 Ack=648 Win=131072 Len=21 TSval=2785251389  TSecr=3642356666 [TCP segment of a reassembled PDU]</td></tr><tr><td>37</td><td>198.108.0.18</td><td>10.39.101.141</td><td>TCP</td><td>43 â†’ 51705 [PSH, ACK] Seq=648 Ack=83 Win=29184 Len=639 TSval=3642358087  TSecr=2785251389 [TCP segment of a reassembled PDU]</td></tr><tr><td>38</td><td>10.39.101.141</td><td>198.108.0.18</td><td>TCP</td><td>51705 â†’ 43 [ACK] Seq=83 Ack=1287 Win=130432 Len=0 TSval=2785251697  TSecr=3642358087</td></tr><tr><td>39</td><td>10.39.101.141</td><td>10.39.101.1</td><td>DNS</td><td>Standard query 0x521b PTR 1.32.129.222.in-addr.arpa</td></tr><tr><td>40</td><td>10.39.101.1</td><td>10.39.101.141</td><td>DNS</td><td>Standard query response 0x521b No such name PTR 1.32.129.222.in-addr.arpa</td></tr><tr><td>41</td><td>fe80::1c7a:24fd:c837:3017</td><td>fe80::1</td><td>DNS</td><td>Standard query 0x5931 PTR 101.101.51.61.in-addr.arpa</td></tr><tr><td>42</td><td>fe80::1</td><td>fe80::1c7a:24fd:c837:3017</td><td>DNS</td><td>Standard query response 0x5931 No such name PTR  101.101.51.61.in-addr.arpa</td></tr><tr><td>43</td><td>10.39.101.141</td><td>8.8.8.8</td><td>UDP</td><td>36904 â†’ 33439 Len=24</td></tr><tr><td>44</td><td>219.232.11.29</td><td>10.39.101.141</td><td>ICMP</td><td>Time-to-live exceeded (Time to live exceeded in transit)</td></tr><tr><td>45</td><td>10.39.101.141</td><td>198.108.0.18</td><td>TCP</td><td>51705 â†’ 43 [PSH, ACK] Seq=83 Ack=1287 Win=131072 Len=21 TSval=2785252732  TSecr=3642358087 [TCP segment of a reassembled PDU]</td></tr><tr><td>46</td><td>198.108.0.18</td><td>10.39.101.141</td><td>TCP</td><td>43 â†’ 51705 [PSH, ACK] Seq=1287 Ack=104 Win=29184 Len=418 TSval=3642359437  TSecr=2785252732 [TCP segment of a reassembled PDU]</td></tr><tr><td>47</td><td>10.39.101.141</td><td>198.108.0.18</td><td>TCP</td><td>51705 â†’ 43 [ACK] Seq=104 Ack=1705 Win=130624 Len=0 TSval=2785253042  TSecr=3642359437</td></tr><tr><td>48</td><td>fe80::1c7a:24fd:c837:3017</td><td>fe80::1</td><td>DNS</td><td>Standard query 0x7d09 PTR 29.11.232.219.in-addr.arpa</td></tr><tr><td>49</td><td>fe80::1</td><td>fe80::1c7a:24fd:c837:3017</td><td>DNS</td><td>Standard query response 0x7d09 No such name PTR  29.11.232.219.in-addr.arpa</td></tr><tr><td>50</td><td>10.39.101.141</td><td>8.8.8.8</td><td>UDP</td><td>36904 â†’ 33440 Len=24</td></tr><tr><td>51</td><td>202.96.12.13</td><td>10.39.101.141</td><td>ICMP</td><td>Time-to-live exceeded (Time to live exceeded in transit)</td></tr><tr><td>52</td><td>10.39.101.141</td><td>198.108.0.18</td><td>TCP</td><td>51705 â†’ 43 [PSH, ACK] Seq=104 Ack=1705 Win=131072 Len=20 TSval=2785254068  TSecr=3642359437 [TCP segment of a reassembled PDU]</td></tr><tr><td>53</td><td>10.39.101.141</td><td>10.39.101.1</td><td>DNS</td><td>Standard query 0x961b PTR 101.101.51.61.in-addr.arpa</td></tr><tr><td>54</td><td>10.39.101.1</td><td>10.39.101.141</td><td>DNS</td><td>Standard query response 0x961b No such name PTR  101.101.51.61.in-addr.arpa</td></tr><tr><td>55</td><td>198.108.0.18</td><td>10.39.101.141</td><td>TCP</td><td>43 â†’ 51705 [PSH, ACK] Seq=1705 Ack=124 Win=29184 Len=642 TSval=3642360779  TSecr=2785254068 [TCP segment of a reassembled PDU]</td></tr><tr><td>56</td><td>10.39.101.141</td><td>198.108.0.18</td><td>TCP</td><td>51705 â†’ 43 [ACK] Seq=124 Ack=2347 Win=130368 Len=0 TSval=2785254400  TSecr=3642360779</td></tr><tr><td>57</td><td>fe80::1c7a:24fd:c837:3017</td><td>fe80::1</td><td>DNS</td><td>Standard query 0xb016 PTR 13.12.96.202.in-addr.arpa</td></tr><tr><td>58</td><td>fe80::1</td><td>fe80::1c7a:24fd:c837:3017</td><td>DNS</td><td>Standard query response 0xb016 No such name PTR 13.12.96.202.in-addr.arpa  SOA beijing.cn.net</td></tr><tr><td>59</td><td>10.39.101.141</td><td>8.8.8.8</td><td>UDP</td><td>36904 â†’ 33441 Len=24</td></tr><tr><td>60</td><td>219.158.112.46</td><td>10.39.101.141</td><td>ICMP</td><td>Time-to-live exceeded (Time to live exceeded in transit)</td></tr></tbody></table><p><a href="get-known-traceroute-by-wireshark/traceroute-google-dns.pcapng">æŠ“åŒ…æ–‡ä»¶ä¸‹è½½</a></p>]]></content>
    
    
    <summary type="html">æœ¬æ–‡å¯¹Tracerouteçš„å·¥ä½œåŸç†è¿›è¡Œåˆ†æï¼Œä»‹ç»Tracerouteåœ¨è¾“å‡ºç»“æœä¸­æ˜¾ç¤ºASå·çš„åŠŸèƒ½å‚æ•°ï¼Œå¹¶é€šè¿‡WiresharkæŠ“åŒ…åˆ†æMACç”µè„‘ä¸ŠTracerouteçš„å·¥ä½œæ”¶å‘åŒ…è¿‡ç¨‹ï¼Œä»è€Œé‡æ–°è®¤è¯†Tracerouteï¼›åœ¨æ­¤åŸºç¡€ä¸Šï¼Œä»‹ç»Tracerouteçš„è¿›é˜¶å·¥å…·MTRã€‚</summary>
    
    
    
    
    <category term="traceroute" scheme="https://weiborao.github.io/tags/traceroute/"/>
    
    <category term="wireshark" scheme="https://weiborao.github.io/tags/wireshark/"/>
    
  </entry>
  
  <entry>
    <title>åœ¨AWSä¸Šéƒ¨ç½²TE Agentå¹¶è¿›è¡Œæµ‹è¯•</title>
    <link href="https://weiborao.github.io/deploy-thousandeyes-agent-on-aws.html"/>
    <id>https://weiborao.github.io/deploy-thousandeyes-agent-on-aws.html</id>
    <published>2021-06-17T13:00:00.000Z</published>
    <updated>2021-06-17T13:06:53.306Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ThousandEyes-ç®€ä»‹"><a href="#ThousandEyes-ç®€ä»‹" class="headerlink" title="ThousandEyes ç®€ä»‹"></a>ThousandEyes ç®€ä»‹</h1><p><a href="https://www.thousandeyes.com/">ThousandEyes</a>æ˜¯ä¸€ä¸ªç½‘ç»œæ€§èƒ½ç›‘æ§çš„SAASäº‘æœåŠ¡ï¼Œç»“åˆäº†å„ç§ä¸»åŠ¨å’Œè¢«åŠ¨çš„ç›‘æ§æŠ€æœ¯ï¼Œè®©æ‚¨æ·±å…¥äº†è§£æ‚¨æä¾›çš„ä»¥åŠæ‚¨æ¶ˆè´¹çš„åº”ç”¨å’ŒæœåŠ¡çš„ç”¨æˆ·ä½“éªŒã€‚ThousandEyesä½¿ç”¨çš„ç›‘æ§æŠ€æœ¯åŒ…æ‹¬ç½‘ç»œçš„å¯è¾¾æ€§æ¢æµ‹ã€æ—¶å»¶ã€ä¸¢åŒ…ã€æŠ–åŠ¨ã€å¯è§†åŒ–çš„é€è·³è·¯å¾„åˆ†æã€å¯è§†åŒ–çš„BGPè·¯ç”±åˆ†æã€DNSç›‘æ§ã€HTTPæœåŠ¡ç›‘æ§ç­‰ã€‚ThousandEyeså¹³å°å¯¹è¿™äº›ç›‘æ§æ”¶é›†è€Œæ¥çš„æ•°æ®è¿›è¡Œåˆ†æã€äº¤å‰å…³è”ï¼Œå°†æ¶‰åŠç”¨æˆ·ä½“éªŒçš„æ–¹æ–¹é¢é¢ï¼ŒåŒ…æ‹¬ç½‘ç»œå’Œåº”ç”¨çš„çŠ¶å†µç»Ÿä¸€çš„å‘ˆç°åœ¨åŒä¸€ä¸ªç•Œé¢ä¹‹ä¸‹ï¼Œè®©æ‚¨èƒ½å¤Ÿè½»æ¾çš„éš”ç¦»é—®é¢˜ï¼Œé‡‡å–è¡ŒåŠ¨ï¼Œä»è€Œå¿«é€Ÿçš„è§£å†³é—®é¢˜ã€‚</p><p>ThousandEyesæä¾›äº†ä¸‰ç§Agentè¿›è¡Œç½‘ç»œå’Œåº”ç”¨çš„æ¢æµ‹ï¼Œåˆ†åˆ«æ˜¯Cloud Agentã€Enterprise Agentå’ŒEndpoint Agentã€‚Cloud Agent ç”±ThousandEyesåœ¨å…¨çƒéƒ¨ç½²å’Œç»´æŠ¤ï¼Œå½“å‰ï¼ŒThousandEyesåœ¨å…¨çƒ200å¤šä¸ªåŸå¸‚å…±éƒ¨ç½²äº†400å¤šä¸ª<a href="https://www.thousandeyes.com/product/cloud-agents">Cloud Agent</a>ï¼Œå¯ä¾›å…¨çƒç”¨æˆ·ä½¿ç”¨ã€‚Enterprise Agentç”±ç”¨æˆ·è‡ªå·±éƒ¨ç½²ï¼Œå¯ä»¥éƒ¨ç½²ä¸ºè™šæ‹Ÿæœºæˆ–è€…å®¹å™¨ï¼Œå¯ä»¥å®‰è£…åœ¨ç‰©ç†ç¡¬ä»¶ï¼Œå¦‚Intel NCUæˆ–è€…æ ‘è“æ´¾ä¸­ï¼Œæ”¯æŒWindowsã€Linuxç³»ç»Ÿï¼Œè¿˜å¯ä»¥éƒ¨ç½²åœ¨æ€ç§‘æˆ–Juniperçš„ç½‘ç»œè®¾å¤‡ä¸­ï¼Œä¹Ÿèƒ½é€šè¿‡CloudFormationåœ¨AWSäº‘ä¸­è‡ªåŠ¨éƒ¨ç½²ã€‚Endpoint Agentæ˜¯æµè§ˆå™¨æ’ä»¶ï¼Œç”¨æˆ·åœ¨è®¿é—®ç½‘ç«™æ—¶ï¼Œå¯ä»¥è‡ªåŠ©çš„ä½¿ç”¨Endpoint Agentè¿›è¡Œæµ‹è¯•ï¼Œç”±ThousandEyesè¿›è¡Œæ•°æ®åˆ†æï¼Œä»è€Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿäº†è§£å…¶æ•°å­—ä½“éªŒï¼Œä»¥åŠå¿«é€Ÿå®šä½é—®é¢˜æ‰€åœ¨ã€‚ç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦æ¥é€‰æ‹©ä¸€ç§æˆ–å¤šç§Agentè¿›è¡Œæ¢æµ‹ï¼ŒThousandEyeså¹³å°ä¼šè‡ªåŠ¨å®Œæˆåˆ†æå’Œå±•ç°ï¼Œæä¾›ç½‘ç»œå’Œåº”ç”¨çŠ¶å†µçš„æ´è§åˆ†æã€‚</p><h1 id="åœ¨AWSä¸Šéƒ¨ç½²TE-Agent"><a href="#åœ¨AWSä¸Šéƒ¨ç½²TE-Agent" class="headerlink" title="åœ¨AWSä¸Šéƒ¨ç½²TE Agent"></a>åœ¨AWSä¸Šéƒ¨ç½²TE Agent</h1><h2 id="äº†è§£éƒ¨ç½²è¿‡ç¨‹"><a href="#äº†è§£éƒ¨ç½²è¿‡ç¨‹" class="headerlink" title="äº†è§£éƒ¨ç½²è¿‡ç¨‹"></a>äº†è§£éƒ¨ç½²è¿‡ç¨‹</h2><p>åœ¨æ­£å¼éƒ¨ç½²ä¹‹å‰ï¼Œå¿«é€Ÿé˜…è¯»äº†ä¸€ä¸‹<a href="https://docs.thousandeyes.com/product-documentation/global-vantage-points/enterprise-agents/installing/iaas-enterprise-agent-deployment-amazon-aws">AWS Deployment Guide</a>ï¼Œéƒ¨ç½²è¿‡ç¨‹æ˜¯é€šè¿‡AWSçš„CloudFormationåˆ›å»ºä¸€ä¸ªStackï¼Œæ•´ä¸ªè¿‡ç¨‹å…¨éƒ¨è‡ªåŠ¨åŒ–ã€‚</p><p>éƒ¨ç½²çš„å‰ææ˜¯éœ€è¦è®¾ç½®å¥½SSH Key-pairï¼ŒVPCç½‘ç»œã€å…¬å…±å­ç½‘ã€ä»¥åŠä½¿ç”¨CloudFormationéƒ¨ç½²EC2çš„æƒé™ã€‚</p><p>éƒ¨ç½²çš„å†…å®¹åŒ…æ‹¬ï¼šå¯åŠ¨åŸºäºUbuntuçš„EC2å®ä¾‹ï¼Œå¹¶è‡ªåŠ¨å®‰è£…TE Agentï¼Œåˆ›å»ºSecurity Groupï¼Œå¹¶åŸºäºæœ€å°æƒé™é…ç½®Inbound Rulesã€‚</p><h2 id="å‡†å¤‡SSH-Key-pair"><a href="#å‡†å¤‡SSH-Key-pair" class="headerlink" title="å‡†å¤‡SSH Key-pair"></a>å‡†å¤‡SSH Key-pair</h2><p>é¦–å…ˆï¼Œåœ¨MACç”µè„‘ä¸­ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œç”¨äºåˆ›å»ºä¸€ä¸ªRSAçš„ç§˜é’¥å¯¹ï¼Œå¹¶å°†å…¬é’¥æ‹·è´è‡³æ¡Œé¢ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -b 4096 -f .ssh/aws_kp -m PEM</span><br><span class="line">mv .ssh/aws_kp .ssh/aws_kp.pem</span><br><span class="line">chmod 400 .ssh/aws_kp.pem</span><br><span class="line">cp .ssh/aws_kp.pub ~/Desktop</span><br></pre></td></tr></table></figure><p>ç™»å½•AWSçš„Consoleç®¡ç†ç•Œé¢åï¼Œé€‰æ‹©Regionï¼Œæ¯”å¦‚us-east-1ï¼Œå®šä½åˆ°EC2â€”Network Securityâ€”Key Pairï¼Œåœ¨ç•Œé¢å³ä¸Šä¾§çš„Actionsä¸‹æ‹‰æ¡†ä¸­ï¼Œé€‰æ‹©Import key pairï¼Œå°†aws_kp.pubä¸Šä¼ ã€‚</p><p>åœ¨å…¶ä»–çš„Regionï¼Œé‡å¤ä¸Šè¿°åŠ¨ä½œï¼Œå°†key pairä¸Šä¼ ï¼Œè¿™æ ·åœ¨å¤šä¸ªRegionåˆ›å»ºçš„EC2å¯ä»¥ä½¿ç”¨åŒä¸€ä¸ªç§é’¥è¿›è¡Œç™»å½•ã€‚</p><h2 id="åœ¨AWSä¸Šéƒ¨ç½²TE-Agent-1"><a href="#åœ¨AWSä¸Šéƒ¨ç½²TE-Agent-1" class="headerlink" title="åœ¨AWSä¸Šéƒ¨ç½²TE Agent"></a>åœ¨AWSä¸Šéƒ¨ç½²TE Agent</h2><p>éƒ¨ç½²TE Agentçš„æ“ä½œè·¯å¾„ä¸ºï¼šåœ¨ThousandEyesçš„ç•Œé¢ä¸­ï¼Œé€‰æ‹©Cloud &amp; Enterprise Agentsï¼Œå†é€‰æ‹©Agent Settingsï¼Œè¿›ä¸€æ­¥é€‰æ‹©Enterprise Agentsï¼Œç‚¹å‡»Add New Enterprise Agentã€‚åœ¨å³ä¾§å‡ºç°çš„ç•Œé¢ä¸­ï¼Œé€‰æ‹©IaaS Marketplacesï¼Œåœ¨è¯¥ç•Œé¢ä¸­ç‚¹å‡»Launch in AWSï¼Œè·³è½¬åˆ°AWSçš„ç™»å½•ç•Œé¢ï¼Œå¹¶è‡ªåŠ¨è¿›å…¥CloudFormationçš„ç•Œé¢ï¼Œè¯¥ç•Œé¢å·²å°†Stackæ¨¡æ¿é€‰æ‹©å¥½äº†ã€‚</p><p>Stackæ¨¡æ¿çš„é“¾æ¥ï¼š</p><p><a href="https://s3-us-west-1.amazonaws.com/oneclick-ea.aws.thousandeyes/aws-ea-oneclick.yaml">https://s3-us-west-1.amazonaws.com/oneclick-ea.aws.thousandeyes/aws-ea-oneclick.yaml</a></p><p>è¯¥æ¨¡æ¿åŒ…å«ä¸¤ä¸ªç»„ä»¶ï¼šEC2 Instance å’Œ Security Groupã€‚</p><p>æŒ‰ç…§ä¸Šæ–‡çš„éƒ¨ç½²æŒ‡å—å¡«å†™è¡¨å•ï¼Œå¹¶ç‚¹å‡»ä¸‹ä¸€æ­¥ï¼Œç›´è‡³å®Œæˆéƒ¨ç½²ã€‚</p><p>åœ¨å®Œæˆå®‰è£…åï¼Œå¯ä»¥ä½¿ç”¨ç§é’¥ç™»å½•åˆ°è™šæœºï¼Œæ³¨æ„ï¼šç”¨æˆ·åä¸º ubuntuï¼Œä¸æ˜¯ec2-user æˆ– rootã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -i .ssh/aws_kp.pem -v [ubuntu@](mailto:ubuntu@18.141.230.240)x.x.x.x</span><br></pre></td></tr></table></figure><p>åœ¨ä¸¤ä¸ªä¸åŒçš„Regionï¼Œus-east-1 å’Œ ap-southeast-1 åˆ†åˆ«éƒ¨ç½²ä¸€ä¸ªTE Agentã€‚</p><p>å¤§çº¦5åˆ†é’Ÿåï¼Œå³å¯åœ¨app.thousandeyes.comçš„ç•Œé¢ä¸­çœ‹åˆ°ä¸¤ä¸ªTE Agentä¸Šçº¿ã€‚</p><h1 id="æ‰§è¡ŒAgent-to-Agent-æµ‹è¯•"><a href="#æ‰§è¡ŒAgent-to-Agent-æµ‹è¯•" class="headerlink" title="æ‰§è¡ŒAgent to Agent æµ‹è¯•"></a>æ‰§è¡ŒAgent to Agent æµ‹è¯•</h1><p>åˆ†åˆ«æ‰§è¡Œä¸¤ç§æµ‹è¯•ï¼Œä¸€ä¸ªæ˜¯é€šè¿‡å…¬ç½‘IPè¿›è¡ŒåŒå‘æµ‹è¯•ï¼Œä¸€ä¸ªæ˜¯åˆ›å»ºVPC Peeringåï¼Œä½¿ç”¨ç§æœ‰åœ°å€è¿›è¡Œæµ‹è¯•ï¼Œæ¯”è¾ƒä¸¤è€…ä¹‹é—´çš„å·®å¼‚ã€‚</p><h2 id="é€šè¿‡å…¬ç½‘IPåœ°å€è¿›è¡ŒåŒå‘æµ‹è¯•"><a href="#é€šè¿‡å…¬ç½‘IPåœ°å€è¿›è¡ŒåŒå‘æµ‹è¯•" class="headerlink" title="é€šè¿‡å…¬ç½‘IPåœ°å€è¿›è¡ŒåŒå‘æµ‹è¯•"></a>é€šè¿‡å…¬ç½‘IPåœ°å€è¿›è¡ŒåŒå‘æµ‹è¯•</h2><p>åœ¨ThousandEyesçš„Agent Settingsç•Œé¢ä¸­ï¼Œç‚¹å‡»Agentï¼Œåœ¨å³ä¾§çš„ç½‘é¡µä¸­ï¼Œé€‰æ‹©Advanced Settingsï¼Œå°†åœ°å€è®¾ç½®ä¸ºAgentçš„å…¬ç½‘IPåœ°å€ã€‚</p><p>åœ¨Test Settingsä¸­ï¼Œé€‰æ‹©Add New Testï¼ŒLayeré€‰æ‹©Networkï¼ŒTest Typeé€‰æ‹©Agent to Agentã€‚</p><p>é€‰æ‹©ä¸€ä¸ªAgentä½œä¸ºTargetï¼Œå¦ä¸€ä¸ªAgentä½œä¸ºæºï¼Œæµ‹è¯•æ–¹å‘é€‰æ‹©åŒå‘ã€‚</p><p>ç»è¿‡ä¸€æ®µæ—¶é—´åï¼ŒThousandEyesä¸Šå³å¯å‘ˆç°æµ‹è¯•ç»“æœã€‚</p><p>æµ‹è¯•æŒç»­äº†ä¸€ä¸ªå°æ—¶å·¦å³ï¼Œæµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š</p><p><strong>AWS us-east-1 to ap-southeast-1 Using Public IP</strong></p><table><thead><tr><th>Items</th><th>Result</th></tr></thead><tbody><tr><td>Loss</td><td>0%</td></tr><tr><td>Latency</td><td>212ms</td></tr><tr><td>Jitter</td><td>&lt;1ms</td></tr><tr><td>Throughput</td><td>55Mbps</td></tr></tbody></table><p>åœ¨å¯è§†åŒ–çš„è·¯å¾„åˆ†æå›¾ä¸­ï¼Œè§‚å¯Ÿåˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š</p><ol><li>ä»us-east-1åˆ°ap-southeast-1å¾€è¿”ï¼Œè‡³å°‘å„æœ‰ä¸‰æ¡è·¯å¾„ï¼Œæ¯æ¡è·¯å¾„æ˜¾ç¤ºçš„è·³æ•°çº¦æœ‰20è·³ã€‚</li><li>è¯¥æµ‹è¯•æ¯éš”2åˆ†é’Ÿæµ‹è¯•ä¸€æ¬¡ï¼Œå…±æµ‹è¯•äº†25æ¬¡ã€‚åœ¨è¿™25æ¬¡ä¸­ï¼Œé²œæœ‰è·¯å¾„ä¸€è‡´çš„ï¼Œæœ‰æ—¶å€™å…¨ç¨‹æ²¡æœ‰å…¬å…±èŠ‚ç‚¹ï¼Œæœ‰æ—¶å€™ä¸¤æ¡ã€ç”šè‡³ä¸‰æ¡è·¯å¾„ä¸­é—´æœ‰å…¬å…±èŠ‚ç‚¹ã€‚</li><li>å¯è§†åŒ–è·¯å¾„ä¸­ï¼Œä»ä¸¤ä¾§çš„Agentå‡ºå‘ï¼Œå‡æœ‰è¿ç»­çš„5ä¸ªæˆ–6ä¸ªè¿ç»­æœªçŸ¥èŠ‚ç‚¹ã€‚è¿™æ˜¯ç”±äºè¿™äº›èŠ‚ç‚¹ä¸å¯¹Tracerouteä½œå‡ºå›åº”ï¼Œå¯¼è‡´è·¯å¾„ä¸­ä¸å¯è§ã€‚</li><li>åœ¨æ•´ä¸ªå¯è§†åŒ–è·¯å¾„ä¸­ï¼Œå¯è§çš„å…¬ç½‘èŠ‚ç‚¹çš„IPåœ°å€å±äº<strong>AS 16509</strong>æˆ–è€…<strong>AS 14618</strong>ï¼Œè¿™ä¸¤ä¸ªéƒ½æ˜¯AWSçš„BGP ASåŸŸã€‚å…¶ä»–èŠ‚ç‚¹çš„åœ°å€ä¸º100.65.x.xæˆ–100.100.x.xï¼Œè¿™æ®µåœ°å€å±äº<strong>100.64.0.0/10</strong>ï¼Œä¸ºIANAä¿ç•™åœ°å€ï¼Œç”¨äºç»™è¿è¥å•†ä½¿ç”¨ã€‚ç”±æ­¤å¯ä»¥æ¨æ–­ï¼Œä¸¤ä¸ªAgentä¹‹é—´é€šè®¯çš„æŠ¥æ–‡å¹¶æœªç¦»å¼€è¿‡AWSçš„ç½‘ç»œï¼Œè¿™ä¹Ÿè§£é‡Šäº†ä¸ºä½•ä¸Šè¿°çš„æ—¶å»¶ã€æŠ–åŠ¨æ˜¯å¾ˆç¨³å®šçš„å€¼ï¼Œå¹¶ä¸”æ•´ä¸ªæµ‹è¯•æœŸé—´ï¼Œæ²¡æœ‰ä¸¢åŒ…ã€‚</li><li>åœ¨å¯è§†åŒ–è·¯å¾„ä¸­ï¼Œæˆ‘è¿˜èƒ½å‘ç°æœ‰çš„è·¯å¾„æ˜¯ä¸€æ®µMPLS éš§é“ï¼Œå¹¶ç»™å‡ºäº†è½¬å‘æ—¶ç”¨åˆ°çš„Labelå€¼ã€‚ThousandEyesæ˜¯å¦‚ä½•å‘ç°è·¯å¾„ä¸­é—´æœ‰MPLS Tunnelå‘¢ï¼Ÿè¿™ä¸ªæ˜¯å€¼å¾—ä»”ç»†æ€è€ƒçš„é—®é¢˜ã€‚ç»æŸ¥è¯¢ï¼Œè¿™æ˜¯é€šè¿‡ThousandEyesçš„<a href="https://www.thousandeyes.com/pdf/ThousandEyes-Patents.pdf">ä¸“åˆ©æŠ€æœ¯Deep Path Analysis (DPA)</a>å®ç°çš„ã€‚</li></ol><h2 id="é€šè¿‡ç§ç½‘IPåœ°å€è¿›è¡ŒåŒå‘æµ‹è¯•"><a href="#é€šè¿‡ç§ç½‘IPåœ°å€è¿›è¡ŒåŒå‘æµ‹è¯•" class="headerlink" title="é€šè¿‡ç§ç½‘IPåœ°å€è¿›è¡ŒåŒå‘æµ‹è¯•"></a>é€šè¿‡ç§ç½‘IPåœ°å€è¿›è¡ŒåŒå‘æµ‹è¯•</h2><p>æœ¬æ¬¡æµ‹è¯•çš„æ–¹æ³•åŒä¸Šï¼Œåªæ˜¯éœ€è¦å°†Agentçš„IPåœ°å€ä¿®æ”¹ä¸ºä½¿ç”¨ç§æœ‰IPåœ°å€ï¼Œä¸¤ä¸ªRegionçš„VPCä¹‹é—´å»ºç«‹VPC Peeringã€‚</p><p>æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š</p><p><strong>AWS us-east-1 to ap-southeast-1 Using Private IP</strong></p><table><thead><tr><th>Items</th><th>Result</th></tr></thead><tbody><tr><td>Loss</td><td>0%</td></tr><tr><td>Latency</td><td>212ms</td></tr><tr><td>Jitter</td><td>&lt;1ms</td></tr><tr><td>Throughput</td><td>56Mbps</td></tr></tbody></table><p>åœ¨å¯è§†åŒ–çš„è·¯å¾„åˆ†æå›¾ä¸­ï¼Œè§‚å¯Ÿåˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š</p><ul><li>ä¸¤ä¸ªAgentä¹‹é—´æ˜¯ç›´è¿çš„ï¼Œæ²¡æœ‰ä»»ä½•ä¸­é—´èŠ‚ç‚¹ï¼Œä¸¤è€…ä¹‹é—´æ—¶å»¶ä¸º211msã€‚</li></ul><p>åšå®Œä¸¤æ¬¡æµ‹è¯•ï¼Œç¬¬äºŒå¤©æ£€æŸ¥äº†ä¸€ä¸‹AWSçš„è´¦å•ï¼Œé¢„è®¡èŠ±è´¹äº†0.29ç¾é‡‘ã€‚</p><h2 id="æµ‹è¯•ç»“æœçš„å…±äº«é“¾æ¥"><a href="#æµ‹è¯•ç»“æœçš„å…±äº«é“¾æ¥" class="headerlink" title="æµ‹è¯•ç»“æœçš„å…±äº«é“¾æ¥"></a>æµ‹è¯•ç»“æœçš„å…±äº«é“¾æ¥</h2><p><a href="https://zwskwtsea.share.thousandeyes.com/">https://zwskwtsea.share.thousandeyes.com/</a></p><p><a href="https://aieajezsh.share.thousandeyes.com/">https://aieajezsh.share.thousandeyes.com/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ThousandEyes-ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ThousandEyes-ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ThousandEyes ç®€ä»‹&quot;&gt;&lt;/a&gt;ThousandEyes ç®€ä»‹&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://w</summary>
      
    
    
    
    
    <category term="ThousandEyes" scheme="https://weiborao.github.io/tags/ThousandEyes/"/>
    
    <category term="AWS" scheme="https://weiborao.github.io/tags/AWS/"/>
    
  </entry>
  
  <entry>
    <title>Mastering KVM Virtualization å­¦ä¹ ç¬”è®°(1)</title>
    <link href="https://weiborao.github.io/master-kvm-notes-1.html"/>
    <id>https://weiborao.github.io/master-kvm-notes-1.html</id>
    <published>2021-02-22T06:23:47.000Z</published>
    <updated>2021-02-22T06:30:40.658Z</updated>
    
    <content type="html"><![CDATA[<p>ç¬¬ä¸€ç« å’Œç¬¬äºŒç« ä¹‹å‰å¿«é€Ÿé˜…è¯»è¿‡äº†ï¼Œæ²¡æœ‰ç¬”è®°ï¼Œç­‰å›å¤´å†å›æ¥æ•´ç†ã€‚</p><h2 id="Chapter-3-KVMã€virshã€oVirtç­‰"><a href="#Chapter-3-KVMã€virshã€oVirtç­‰" class="headerlink" title="Chapter 3 KVMã€virshã€oVirtç­‰"></a>Chapter 3 KVMã€virshã€oVirtç­‰</h2><h3 id="CentOS-8-çš„KVMå®‰è£…"><a href="#CentOS-8-çš„KVMå®‰è£…" class="headerlink" title="CentOS 8 çš„KVMå®‰è£…"></a>CentOS 8 çš„KVMå®‰è£…</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum module install virt</span><br><span class="line">dnf install qemu-img qemu-kvm libvirt libvirt-client virt-manager \</span><br><span class="line">virt-install virt-viewer -y</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…å®Œåï¼Œä½¿ç”¨virt-host-validateéªŒè¯"><a href="#å®‰è£…å®Œåï¼Œä½¿ç”¨virt-host-validateéªŒè¯" class="headerlink" title="å®‰è£…å®Œåï¼Œä½¿ç”¨virt-host-validateéªŒè¯"></a>å®‰è£…å®Œåï¼Œä½¿ç”¨virt-host-validateéªŒè¯</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># virt-host-validate</span></span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> hardware virtualization                                 : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">if</span> device /dev/kvm exists                                   : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">if</span> device /dev/kvm is accessible                            : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">if</span> device /dev/vhost-net exists                             : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">if</span> device /dev/net/tun exists                               : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;memory&#x27;</span> controller support                      : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;memory&#x27;</span> controller mount-point                  : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpu&#x27;</span> controller support                         : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpu&#x27;</span> controller mount-point                     : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpuacct&#x27;</span> controller support                     : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpuacct&#x27;</span> controller mount-point                 : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpuset&#x27;</span> controller support                      : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpuset&#x27;</span> controller mount-point                  : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;devices&#x27;</span> controller support                     : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;devices&#x27;</span> controller mount-point                 : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;blkio&#x27;</span> controller support                       : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;blkio&#x27;</span> controller mount-point                   : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> device assignment IOMMU support                         : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">if</span> IOMMU is enabled by kernel                               : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> Linux &gt;= 2.6.26                                         : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> namespace ipc                                           : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> namespace mnt                                           : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> namespace pid                                           : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> namespace uts                                           : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> namespace net                                           : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> namespace user                                          : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;memory&#x27;</span> controller support                      : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;memory&#x27;</span> controller mount-point                  : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpu&#x27;</span> controller support                         : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpu&#x27;</span> controller mount-point                     : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpuacct&#x27;</span> controller support                     : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpuacct&#x27;</span> controller mount-point                 : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpuset&#x27;</span> controller support                      : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpuset&#x27;</span> controller mount-point                  : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;devices&#x27;</span> controller support                     : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;devices&#x27;</span> controller mount-point                 : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;blkio&#x27;</span> controller support                       : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;blkio&#x27;</span> controller mount-point                   : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">if</span> device /sys/fs/fuse/connections exists                   : PASS</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨virt-install-å®‰è£…è™šæ‹Ÿæœº"><a href="#ä½¿ç”¨virt-install-å®‰è£…è™šæ‹Ÿæœº" class="headerlink" title="ä½¿ç”¨virt-install å®‰è£…è™šæ‹Ÿæœº"></a>ä½¿ç”¨virt-install å®‰è£…è™šæ‹Ÿæœº</h3><p>ç¼–è¾‘anaconda-ks.cfgæ–‡ä»¶ï¼Œä½¿ç”¨ä»¥ä¸‹å‚æ•°å¯ä»¥å®ç°è™šæœºéƒ¨ç½²çš„é™é»˜å®‰è£…ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">virt-install --virt-type=kvm --name=MasteringKVM02 --ram=4096</span><br><span class="line">--vcpus=4 --os-variant=rhel8.0 --location=/var/lib/libvirt/</span><br><span class="line">images/ CentOS-8-x86_64-1905-dvd1.iso --network=default</span><br><span class="line">--graphics vnc --disk size=16 -x <span class="string">&quot;ks=http://10.10.48.1/ks.cfg&quot;</span></span><br></pre></td></tr></table></figure><h3 id="oVirt"><a href="#oVirt" class="headerlink" title="oVirt"></a>oVirt</h3><p>oVirtï¼ˆOpen Virtualization Managerï¼‰æ˜¯ä¸€æ¬¾å…è´¹å¼€æºè™šæ‹ŸåŒ–è½¯ä»¶ï¼Œæ˜¯RedHatå•†ä¸šç‰ˆæœ¬è™šæ‹ŸåŒ–è½¯ä»¶RHEVçš„å¼€æºç‰ˆæœ¬ã€‚</p><p>oVirtåŸºäºkvmï¼Œå¹¶æ•´åˆä½¿ç”¨äº†libvirtã€glusterã€patternflyã€ansibleç­‰ä¸€ç³»åˆ—ä¼˜ç§€çš„å¼€æºè½¯ä»¶ã€‚</p><h3 id="æ¢ç´¢è™šæ‹ŸæœºQemu-kvmè¿›ç¨‹"><a href="#æ¢ç´¢è™šæ‹ŸæœºQemu-kvmè¿›ç¨‹" class="headerlink" title="æ¢ç´¢è™šæ‹ŸæœºQemu-kvmè¿›ç¨‹"></a>æ¢ç´¢è™šæ‹ŸæœºQemu-kvmè¿›ç¨‹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-kvm:/home/ubuntu<span class="comment"># ps aux | grep qemu</span></span><br><span class="line">libvirt+    8526  255  0.1 13876708 653744 ?     SLl  Feb01 61850:36 /usr/bin/qemu-system-x86_64 -name guest=csr1kv-1,debug-threads=on -S -object secret,id=masterKey0,format=raw,file=/var/lib/libvirt/qemu/domain-4-csr1kv-1/master-key.aes -machine pc-q35-4.2,accel=kvm,usb=off,vmport=off,dump-guest-core=off,mem-merge=off -cpu host -m 8192 -mem-prealloc -mem-path /dev/hugepages/libvirt/qemu/4-csr1kv-1 -overcommit mem-lock=on -smp 8,sockets=8,cores=1,threads=1 -uuid 83f90c1c-f0ea-4298-bcdf-3d676de2aeb4 -no-user-config -nodefaults -chardev socket,id=charmonitor,fd=31,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=utc,driftfix=slew -global kvm-pit.lost_tick_policy=delay -no-hpet -no-shutdown -global ICH9-LPC.disable_s3=1 -global ICH9-LPC.disable_s4=1 -boot strict=on -device pcie-root-port,port=0x10,chassis=1,id=pci.1,bus=pcie.0,multifunction=on,addr=0x2 -device pcie-root-port,port=0x11,chassis=2,id=pci.2,bus=pcie.0,addr=0x2.0x1 -device pcie-root-port,port=0x12,chassis=3,id=pci.3,bus=pcie.0,addr=0x2.0x2 -device pcie-root-port,port=0x13,chassis=4,id=pci.4,bus=pcie.0,addr=0x2.0x3 -device pcie-root-port,port=0x14,chassis=5,id=pci.5,bus=pcie.0,addr=0x2.0x4 -device pcie-root-port,port=0x15,chassis=6,id=pci.6,bus=pcie.0,addr=0x2.0x5 -device pcie-root-port,port=0x16,chassis=7,id=pci.7,bus=pcie.0,addr=0x2.0x6 -device pcie-root-port,port=0x17,chassis=8,id=pci.8,bus=pcie.0,addr=0x2.0x7 -device qemu-xhci,p2=15,p3=15,id=usb,bus=pci.3,addr=0x0 -device virtio-serial-pci,id=virtio-serial0,bus=pci.4,addr=0x0 -blockdev &#123;<span class="string">&quot;driver&quot;</span>:<span class="string">&quot;file&quot;</span>,<span class="string">&quot;filename&quot;</span>:<span class="string">&quot;/var/lib/libvirt/images/csr1000v-universalk9.17.02.01v.qcow2&quot;</span>,<span class="string">&quot;node-name&quot;</span>:<span class="string">&quot;libvirt-1-storage&quot;</span>,<span class="string">&quot;auto-read-only&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;discard&quot;</span>:<span class="string">&quot;unmap&quot;</span>&#125; -blockdev &#123;<span class="string">&quot;node-name&quot;</span>:<span class="string">&quot;libvirt-1-format&quot;</span>,<span class="string">&quot;read-only&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;driver&quot;</span>:<span class="string">&quot;qcow2&quot;</span>,<span class="string">&quot;file&quot;</span>:<span class="string">&quot;libvirt-1-storage&quot;</span>,<span class="string">&quot;backing&quot;</span>:null&#125; -device virtio-blk-pci,scsi=off,bus=pci.5,addr=0x0,drive=libvirt-1-format,id=virtio-disk0,bootindex=1 -netdev tap,fd=33,id=hostnet0,vhost=on,vhostfd=34 -device virtio-net-pci,netdev=hostnet0,id=net0,mac=52:54:00:69:ec:73,bus=pci.1,addr=0x0 -chardev pty,id=charserial0 -device isa-serial,chardev=charserial0,id=serial0 -chardev socket,id=charchannel0,fd=35,server,nowait -device virtserialport,bus=virtio-serial0.0,nr=1,chardev=charchannel0,id=channel0,name=org.qemu.guest_agent.0 -chardev spicevmc,id=charchannel1,name=vdagent -device virtserialport,bus=virtio-serial0.0,nr=2,chardev=charchannel1,id=channel1,name=com.redhat.spice.0 -spice port=5900,addr=127.0.0.1,disable-ticketing,image-compression=off,seamless-migration=on -device qxl-vga,id=video0,ram_size=67108864,vram_size=67108864,vram64_size_mb=0,vgamem_mb=16,max_outputs=1,bus=pcie.0,addr=0x1 -device vfio-pci,host=0000:5e:02.0,id=hostdev0,bus=pci.2,addr=0x0 -device vfio-pci,host=0000:5e:0a.0,id=hostdev1,bus=pci.8,addr=0x0 -sandbox on,obsolete=deny,elevateprivileges=deny,spawn=deny,resourcecontrol=deny -msg timestamp=on</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨pstreeæ£€æŸ¥çº¿ç¨‹ä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-kvm:/home/ubuntu<span class="comment"># pstree -p 8526</span></span><br><span class="line">qemu-system-x86(8526)â”€â”¬â”€&#123;qemu-system-x86&#125;(8530)</span><br><span class="line">                      â”œâ”€&#123;qemu-system-x86&#125;(8534)</span><br><span class="line">                      â”œâ”€&#123;qemu-system-x86&#125;(8535)</span><br><span class="line">                      â”œâ”€&#123;qemu-system-x86&#125;(8536)</span><br><span class="line">                      â”œâ”€&#123;qemu-system-x86&#125;(8537)</span><br><span class="line">                      â”œâ”€&#123;qemu-system-x86&#125;(8538)</span><br><span class="line">                      â”œâ”€&#123;qemu-system-x86&#125;(8539)</span><br><span class="line">                      â”œâ”€&#123;qemu-system-x86&#125;(8540)</span><br><span class="line">                      â”œâ”€&#123;qemu-system-x86&#125;(8541)</span><br><span class="line">                      â”œâ”€&#123;qemu-system-x86&#125;(8542)</span><br><span class="line">                      â”œâ”€&#123;qemu-system-x86&#125;(8552)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨gbd è°ƒè¯•è¿›ç¨‹ï¼Œè¿™é‡Œå‚è€ƒ<a href="https://www.cnblogs.com/hukey/p/11138768.html">https://www.cnblogs.com/hukey/p/11138768.html</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-kvm:/home/ubuntu<span class="comment"># gdb attach 8526</span></span><br><span class="line">GNU gdb (Ubuntu 9.2-0ubuntu1~20.04) 9.2</span><br><span class="line">Copyright (C) 2020 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br><span class="line">Type <span class="string">&quot;show copying&quot;</span> and <span class="string">&quot;show warranty&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">&quot;x86_64-linux-gnu&quot;</span>.</span><br><span class="line">Type <span class="string">&quot;show configuration&quot;</span> <span class="keyword">for</span> configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">    &lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class="line"></span><br><span class="line">For <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">&quot;help&quot;</span>.</span><br><span class="line">Type <span class="string">&quot;apropos word&quot;</span> to search <span class="keyword">for</span> commands related to <span class="string">&quot;word&quot;</span>.</span><br><span class="line">Attaching to process 8526</span><br><span class="line">[New LWP 8530]</span><br><span class="line">[New LWP 8534]</span><br><span class="line">[New LWP 8535]</span><br><span class="line">[New LWP 8536]</span><br><span class="line">[New LWP 8537]</span><br><span class="line">[New LWP 8538]</span><br><span class="line">[New LWP 8539]</span><br><span class="line">[New LWP 8540]</span><br><span class="line">[New LWP 8541]</span><br><span class="line">[New LWP 8542]</span><br><span class="line">[New LWP 8552]</span><br><span class="line">[New LWP 250213]</span><br><span class="line"></span><br><span class="line">warning: <span class="string">&quot;target:/usr/bin/qemu-system-x86_64 (deleted)&quot;</span>: could not open as an executable file: No such file or directory.</span><br><span class="line"></span><br><span class="line">warning: `target:/usr/bin/qemu-system-x86_64 (deleted)<span class="string">&#x27;: can&#x27;</span>t open to <span class="built_in">read</span> symbols: No such file or directory.</span><br><span class="line"></span><br><span class="line">warning: Could not load vsyscall page because no executable was specified</span><br><span class="line">0x00007fdcda986bf6 <span class="keyword">in</span> ?? ()</span><br><span class="line">(gdb) info threads</span><br><span class="line">  Id   Target Id                  Frame</span><br><span class="line">* 1    LWP 8526 <span class="string">&quot;qemu-system-x86&quot;</span> 0x00007fdcda986bf6 <span class="keyword">in</span> ?? ()</span><br><span class="line">  2    LWP 8530 <span class="string">&quot;call_rcu&quot;</span>        0x00007fdcda98c89d <span class="keyword">in</span> ?? ()</span><br><span class="line">  3    LWP 8534 <span class="string">&quot;IO mon_iothread&quot;</span> 0x00007fdcda986aff <span class="keyword">in</span> ?? ()</span><br><span class="line">  4    LWP 8535 <span class="string">&quot;CPU 0/KVM&quot;</span>       0x00007fdcda98850b <span class="keyword">in</span> ?? ()</span><br><span class="line">  5    LWP 8536 <span class="string">&quot;CPU 1/KVM&quot;</span>       0x00007fdcda98850b <span class="keyword">in</span> ?? ()</span><br><span class="line">  6    LWP 8537 <span class="string">&quot;CPU 2/KVM&quot;</span>       0x00007fdcda98850b <span class="keyword">in</span> ?? ()</span><br><span class="line">  7    LWP 8538 <span class="string">&quot;CPU 3/KVM&quot;</span>       0x00007fdcda98850b <span class="keyword">in</span> ?? ()</span><br><span class="line">  8    LWP 8539 <span class="string">&quot;CPU 4/KVM&quot;</span>       0x00007fdcda98850b <span class="keyword">in</span> ?? ()</span><br><span class="line">  9    LWP 8540 <span class="string">&quot;CPU 5/KVM&quot;</span>       0x00007fdcda98850b <span class="keyword">in</span> ?? ()</span><br><span class="line">  10   LWP 8541 <span class="string">&quot;CPU 6/KVM&quot;</span>       0x00007fdcda98850b <span class="keyword">in</span> ?? ()</span><br><span class="line">  11   LWP 8542 <span class="string">&quot;CPU 7/KVM&quot;</span>       0x00007fdcda98850b <span class="keyword">in</span> ?? ()</span><br><span class="line">  12   LWP 8552 <span class="string">&quot;SPICE Worker&quot;</span>    0x00007fdcda986aff <span class="keyword">in</span> ?? ()</span><br><span class="line">  13   LWP 250213 <span class="string">&quot;worker&quot;</span>        0x00007fdcdaa76618 <span class="keyword">in</span> ?? ()</span><br></pre></td></tr></table></figure><h2 id="Chapter-4-KVM-ç½‘ç»œ"><a href="#Chapter-4-KVM-ç½‘ç»œ" class="headerlink" title="Chapter 4 KVM ç½‘ç»œ"></a>Chapter 4 KVM ç½‘ç»œ</h2><p>æœ¬ç« èŠ‚ä»‹ç»äº†ä»¥ä¸‹å†…å®¹</p><ul><li>Virtual Network â€“ é˜è¿°ä¸ºä»€ä¹ˆéœ€è¦è™šæ‹Ÿç½‘ç»œã€‚ä»è™šæ‹Ÿäº¤æ¢æœºå¼€å§‹ï¼Œè®¾æƒ³ä¸€ä¸‹å¦‚æœæ²¡æœ‰è™šæ‹Ÿäº¤æ¢æœºï¼Œæœ‰20ä¸ªè™šæ‹Ÿæœºéœ€è¦20ä¸ªç‰©ç†æ¥å£è¿æ¥è‡³20ä¸ªç‰©ç†äº¤æ¢æœºçš„ç«¯å£ã€‚å¼•å…¥è™šæ‹Ÿäº¤æ¢æœºï¼Œå‡å°‘æœåŠ¡å™¨çš„ç‰©ç†æ¥å£å’Œç‰©ç†äº¤æ¢æœºçš„æ¥å£éœ€æ±‚ã€‚</li><li>Libvirt çš„ä¸‰ç±»ç½‘ç»œï¼šNATã€Routed(Bridged)ã€Isolatedï¼›ä½¿ç”¨virsh net-dumpxml defaultè¾“å‡ºxmlæ–‡ä»¶ã€‚</li><li>TUN/TAPè®¾å¤‡ï¼šå±äºç”¨æˆ·ç©ºé—´çš„è®¾å¤‡ï¼Œan application can open /dev/net/tun and use an ioctl() function to register a network device in the kernel, which, in turn, presents itself as a tunXX or tapXX device.  TUNè®¾å¤‡æ˜¯ä¸€ä¸ª3å±‚è®¾å¤‡ï¼ŒTAPè®¾å¤‡æ˜¯ä¸€ä¸ª2å±‚è®¾å¤‡ã€‚</li><li>ç®€å•ä»‹ç»äº†Linux Bridgeï¼Œæ­¤å¤„å¯ä»¥ä½¿ç”¨ip link å‘½ä»¤æ›¿ä»£brctlå‘½ä»¤ï¼Œå¹¶ä½¿ç”¨NetworkManageræ¥æŒä¹…åŒ–é…ç½®ã€‚</li><li>Open vSwitchç®€å•ä»‹ç»</li><li>SR-IOVçš„ä»‹ç»ï¼šæ­¤å¤„å¯ä»¥å‚è€ƒæˆ‘è‡ªå·±çš„æ–‡æ¡£ã€‚</li><li>MACVTAPä»‹ç»ï¼šItâ€™s a newer driver that should simplify our virtualized networking by completely removing tun/tap and bridge drivers with a single module.  æœ‰å››ç§æ¨¡å¼ï¼ŒVEPAï¼ŒBridgeï¼ŒPrivateå’ŒPass-throughã€‚</li></ul><h2 id="Chapter-5-KVM-å­˜å‚¨"><a href="#Chapter-5-KVM-å­˜å‚¨" class="headerlink" title="Chapter 5 KVM å­˜å‚¨"></a>Chapter 5 KVM å­˜å‚¨</h2><p>æœ¬ç« å±äºå›«å›µåæ£çš„çœ‹å®Œäº†ï¼Œä¸€çŸ¥åŠè§£çš„è®°å½•ä¸€ä¸‹ï¼Œå¤§è‡´äº†è§£äº†ä¸€äº›å­˜å‚¨æ–¹é¢çš„æ¦‚å¿µå’Œå­˜å‚¨çš„æœ€æ–°å‘å±•ã€‚</p><h3 id="å­˜å‚¨èµ„æºæ± "><a href="#å­˜å‚¨èµ„æºæ± " class="headerlink" title="å­˜å‚¨èµ„æºæ± "></a>å­˜å‚¨èµ„æºæ± </h3><p>CentOSæ”¯æŒçš„å­˜å‚¨æ± ç§ç±»å¦‚ä¸‹ï¼š</p><ul><li>Logical Volume Manager (LVM)-based storage pools</li><li>Directory-based storage pools</li><li>Partition-based storage pools</li><li>GlusterFS-based storage pools</li><li>iSCSI-based storage pools</li><li>Disk-based storage pools</li><li>HBA-based storage pools, which use SCSI devices</li></ul><p>å¯¹äºlibvirtæ¥è¯´ï¼Œå­˜å‚¨èµ„æºæ± å¯èƒ½æ˜¯ä¸€ä¸ªç›®å½•ï¼Œä¸€ä¸ªå­˜å‚¨è®¾å¤‡ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªæ–‡ä»¶ã€‚</p><p>ä»‹ç»äº†ä¸¤ç§æ–‡ä»¶ç³»ç»Ÿï¼š</p><ul><li><strong>Brtfs</strong> is a type of filesystem that supports snapshots, RAID and LVM-like functionality, compression, defragmentation, online resizing, and many other advanced features. It was deprecated after it was discovered that its RAID5/6 can easily lead to a loss of data. â€“è¿™é‡Œè¯´çš„æ˜¯Red Hat</li><li><strong>ZFS</strong> is a type of filesystem that supports everything that Brtfs does, plus read and write caching. <strong>ZFS is not a part of the Linux kernel.</strong></li></ul><h3 id="æœ¬åœ°å­˜å‚¨æ± "><a href="#æœ¬åœ°å­˜å‚¨æ± " class="headerlink" title="æœ¬åœ°å­˜å‚¨æ± "></a>æœ¬åœ°å­˜å‚¨æ± </h3><p>Stratisæ˜¯éšRHEL 8å¼•å…¥çš„æœ¬åœ°ç®¡ç†å­˜å‚¨è§£å†³æ–¹æ¡ˆï¼Œå®ƒä½¿ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥é…ç½®é«˜çº§å­˜å‚¨åŠŸèƒ½ï¼š</p><ol><li>Pool-based management</li><li>Thin provisioning</li><li>File system snapshots</li><li>Monitoring</li></ol><p>Stratisä½¿ç”¨ç¤ºä¾‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mdadm --create /dev/md0 --verbose --level=10 --raid-devices=4 /dev/sdb /dev/sdc /dev/sdd /dev/sde --spare-devices=1 /dev/sdf2</span><br><span class="line">stratis pool create PacktStratisPool01 /dev/md0</span><br><span class="line">stratis pool add-cache PacktStratisPool01 /dev/sdg</span><br><span class="line">stratis fs create PackStratisPool01 PacktStratisXFS01</span><br><span class="line">mkdir /mnt/packtStratisXFS01</span><br><span class="line">mount /stratis/PacktStratisPool01/PacktStratisXFS01 /mnt/packtStratisXFS01</span><br></pre></td></tr></table></figure><h3 id="Libvirt-Storage-Pool"><a href="#Libvirt-Storage-Pool" class="headerlink" title="Libvirt Storage Pool"></a>Libvirt Storage Pool</h3><p>Libvirt æ”¯æŒå¤šç§Storage Poolï¼Œè¯¦è§<a href="https://libvirt.org/storage.html">https://libvirt.org/storage.html</a></p><ul><li>Directory pool</li><li>Filesystem pool</li><li>Network filesystem pool</li><li>Logical volume pool</li><li>Disk pool</li><li>iSCSI pool</li><li>iSCSI direct pool</li><li>SCSI pool</li><li>Multipath pool</li><li>RBD pool</li><li>Sheepdog pool</li><li>Gluster pool</li><li>ZFS pool</li><li>Vstorage pool</li></ul><h3 id="NFS-Storage-Pool"><a href="#NFS-Storage-Pool" class="headerlink" title="NFS Storage Pool"></a>NFS Storage Pool</h3><p>NFSè‡ªä¸Šä¸–çºª80å¹´ä»£å°±å‡ºç°äº†ï¼Œè‡³ä»Šä¾ç„¶æ´»è·ƒï¼Œå°¤å…¶æ˜¯4.2ç‰ˆæœ¬ä»¥åå¢å¼ºäº†ä¸å°‘åŠŸèƒ½ï¼›VMware Virtual Volume 6.0 å¯ä»¥æä¾›åŸºäºBlockå’ŒNFSçš„ä¸¤ç§å­˜å‚¨è®¿é—®ã€‚</p><p>Libvirt ä½¿ç”¨NFS Storage Poolç¤ºä¾‹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨virt-manager å›¾å½¢ç•Œé¢åˆ›å»ºï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">pool</span> <span class="attr">type</span>=<span class="string">&#x27;netfs&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>NFSpooll<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">host</span> <span class="attr">name</span>=<span class="string">&#x27;192.168.159.144&#x27;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dir</span> <span class="attr">path</span>=<span class="string">&#x27;/mnt/packtStratisXF501&#x27;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">format</span> <span class="attr">type</span>=<span class="string">&#x27;auto&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">path</span>&gt;</span>/var/lib/libvirt/images/NFSpooll<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">permissions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">mode</span>&gt;</span>0755<span class="tag">&lt;/<span class="name">mode</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">owner</span>&gt;</span>0<span class="tag">&lt;/<span class="name">owner</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">group</span>&gt;</span>0<span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span>&gt;</span>system_u:object r:nfs t:s0<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">permissions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">pool</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="iSCIS-å’Œ-SAN-å­˜å‚¨"><a href="#iSCIS-å’Œ-SAN-å­˜å‚¨" class="headerlink" title="iSCIS å’Œ SAN å­˜å‚¨"></a>iSCIS å’Œ SAN å­˜å‚¨</h3><p>iSCISåè®®æœ‰ä¸¤ä¸ªä¸»è¦åŸå› å½±å“å…¶é«˜æ•ˆæ€§ï¼š</p><ul><li><strong>IPåè®®å°è£…</strong> iSCSI encapsulates SCSI commands into regular IP packages, which means segmentation and overhead as IP packages have a pretty large header, which means less efficiency.</li><li><strong>åŸºäºTCPä¼ è¾“</strong> Even worse, itâ€™s TCP-based, which means that there are sequence numbers and retransmissions, which can lead to queueing and latency, and the bigger the environment is, the more you usually feel these effects affect your virtual machine performance.</li></ul><p>The iSCSI and FC architectures are very similarâ€”they both need a target (an iSCSI target and an FC target) and an initiator (an iSCS initiator and an FC initiator)ï¼Œthe initiator connects to a target to get access to block storage thatâ€™s presented via that target.</p><h4 id="LUNçš„æ¦‚å¿µ"><a href="#LUNçš„æ¦‚å¿µ" class="headerlink" title="LUNçš„æ¦‚å¿µ"></a>LUNçš„æ¦‚å¿µ</h4><p>LUNs are just raw, block capacities that we export via an iSCSI target toward initiators. LUNs are indexed, or numbered, usually from 0 onward. Every LUN number represents a different storage capacity that an initiator can connect to.</p><p>For example, we can have an iSCSI target with three different LUNsâ€”LUN0 with 20 GB, LUN1 with 40 GB, and LUN2 with 60 GB. These will all be hosted on the same storage systemâ€™s iSCSI target. We can then configure the iSCSI target to accept an IQN to see all the LUNs, another IQN to only see LUN1, and another IQN to only see LUN1 and LUN2. </p><p>ä½¿ç”¨ targetcliå‘½ä»¤åˆ›å»ºiSCIS targetï¼Œæ­¥éª¤ç®€è¦è¯´æ˜å¦‚ä¸‹ï¼š</p><ol><li>åˆ›å»º/dev/sdb1åˆ†åŒºå’ŒXFSæ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶mount /dev/sdb1 /LUN0ï¼Œç”¨targetcliåˆ›å»ºä¸€ä¸ªfileio ç±»å‹çš„targetåç«¯</li><li>åˆ›å»º/dev/sdc1åˆ†åŒºï¼Œå¹¶ç›´æ¥ä½¿ç”¨targetcliåˆ›å»ºä¸€ä¸ªblockç±»å‹çš„targetåç«¯</li><li>åŸºäº/dev/sddåˆ›å»ºLVMï¼Œå¹¶ä½¿ç”¨targetcliåˆ›å»ºä¸€ä¸ªblockç±»å‹çš„targetåç«¯</li><li>åœ¨KVMä¸»æœºä¸Šè®¾ç½®å¥½iscsiçš„initiatorå‚æ•°</li><li>å›åˆ°iSCSIä¸Šï¼Œåˆ›å»ºACLï¼Œå…è®¸KVM hostï¼ŒåŸºäº1~3åˆ›å»ºçš„targetå‘å¸ƒLUNs</li><li>åœ¨KVM Hostä¸Šå®šä¹‰Storage Poolçš„XMLæ–‡ä»¶ï¼Œç”¨virsh pool-defineåˆ›å»ºStorage Pool</li></ol><h3 id="Storage-redundancy-and-multipathing"><a href="#Storage-redundancy-and-multipathing" class="headerlink" title="Storage redundancy and multipathing"></a>Storage redundancy and multipathing</h3><p>é¿å…å•ç‚¹æ•…éšœSPOFï¼Œç½‘å¡ã€çº¿ç¼†ã€äº¤æ¢æœºã€å­˜å‚¨æ§åˆ¶å™¨ç­‰ç­‰ã€‚</p><p>KVM HoståŸºäºiSCSIåšå†—ä½™å’Œå¤šè·¯å¾„çš„é…ç½®è¾ƒä¸ºå¤æ‚ï¼Œå¹¶ä¸”ç¼ºå°‘æ”¯æŒï¼Œæ–‡ç« å»ºè®®ä½¿ç”¨oVirtæˆ–è€…RHEV-H(Red Hat Enterprise Virtualization Hypervisor. )</p><p>ä½¿ç”¨oVirt åˆ›å»ºä¸€ä¸ªiSCSI Bondæ¥å®ç°å†—ä½™å’Œå¤šè·¯å¾„ã€‚</p><h3 id="Gluster"><a href="#Gluster" class="headerlink" title="Gluster"></a>Gluster</h3><p>Gluster æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼Œå…¶çªå‡ºä¼˜åŠ¿æ˜¯å¯æ‰©å±•æ€§ï¼Œæ•°æ®å¤åˆ¶å’Œå¿«ç…§åŠŸèƒ½ï¼›æ³¨æ„Glusteræ˜¯ä¸€ä¸ªæ–‡ä»¶å­˜å‚¨æœåŠ¡ã€‚</p><p>ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒGlusterè‡³å°‘é…ç½®ä¸‰å°æœåŠ¡å™¨ã€‚</p><p>é…ç½®æ­¥éª¤ç®€è¦è¯´æ˜å¦‚ä¸‹ï¼š</p><ol><li><p>åˆ›å»ºç£ç›˜åˆ†åŒºä»¥åŠæ–‡ä»¶ç³»ç»Ÿ </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkfs.xfs /dev/sdb</span><br><span class="line">mkdir /gluster/bricks/1 -p</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;/dev/sdb /gluster/bricks/1 xfs defaults 0 0&#x27;</span> &gt;&gt; /etc/</span><br><span class="line">fstab</span><br><span class="line">mount -a</span><br><span class="line">mkdir /gluster/bricks/1/brick</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºGlusteråˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gluster volume create kvmgluster replica 3 \ gluster1:/gluster/</span><br><span class="line">bricks/1/brick gluster2:/gluster/bricks/1/brick \ gluster3:/</span><br><span class="line">gluster/bricks/1/brick</span><br><span class="line">gluster volume start kvmgluster</span><br><span class="line">gluster volume <span class="built_in">set</span> kvmgluster auth.allow 192.168.159.0/24</span><br><span class="line">gluster volume <span class="built_in">set</span> kvmgluster allow-insecure on</span><br><span class="line">gluster volume <span class="built_in">set</span> kvmgluster storage.owner-uid 107</span><br><span class="line">gluster volume <span class="built_in">set</span> kvmgluster storage.owner-gid 107</span><br></pre></td></tr></table></figure></li><li><p>æŒ‚åœ¨Glusteræ–‡ä»¶ç³»ç»Ÿä¸ºNFSæœåŠ¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;localhost:/kvmgluster /mnt glusterfs \ defaults,_</span></span><br><span class="line"><span class="string">netdev,backupvolfile-server=localhost 0 0&#x27;</span> &gt;&gt; /etc/fstab</span><br><span class="line">mount.glusterfs localhost:/kvmgluster /mnt</span><br></pre></td></tr></table></figure></li><li><p>åœ¨KVMä¸»æœºä¸ŠæŒ‚åœ¨Gluster</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget \ https://download.gluster.org/pub/gluster/glusterfs/6/</span><br><span class="line">LATEST/CentOS/gl\ usterfs-rhel8.repo -P /etc/yum.repos.d</span><br><span class="line">yum install glusterfs glusterfs-fuse attr -y</span><br><span class="line">mount -t glusterfs -o context=<span class="string">&quot;system_u:object_r:virt_</span></span><br><span class="line"><span class="string">image_t:s0&quot;</span> \ gluster1:/kvmgluster /var/lib/libvirt/images/</span><br><span class="line">GlusterFS</span><br></pre></td></tr></table></figure></li><li><p>åœ¨KVMä¸Šå®šä¹‰å­˜å‚¨èµ„æºæ± ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">pool</span> <span class="attr">type</span>=<span class="string">&#x27;dir&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>glusterfs-pool<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">path</span>&gt;</span>/var/lib/libvirt/images/GlusterFS<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">permissions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">mode</span>&gt;</span>0755<span class="tag">&lt;/<span class="name">mode</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">owner</span>&gt;</span>107<span class="tag">&lt;/<span class="name">owner</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">group</span>&gt;</span>107<span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span>&gt;</span>system_u:object_r:virt_image_t:s0<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">permissions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">pool</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">virsh pool-define --file gluster.xml</span><br><span class="line">virsh pool-start --pool glusterfs-pool</span><br><span class="line">virsh pool-autostart --pool glusterfs-pool</span><br></pre></td></tr></table></figure><p>å°†GlusteræŒ‚åœ¨ä¸ºç›®å½•ï¼Œå¯ä»¥é¿å…Libvirtåœ¨ä½¿ç”¨Glusterçš„ä¸¤ä¸ªé—®é¢˜ï¼š</p></li></ol><ul><li><p>We can use Glusterâ€™s failover capability, which will be managed automatically by the</p><p>Gluster utilities that we installed directly, as libvirt doesnâ€™t support them yet.</p></li><li><p>We will avoid creating virtual machine disks <em>manually</em>, which is another limitation of libvirtâ€™s implementation of Gluster support, while directory-based storage pools support it without any issues.</p></li></ul><h3 id="Ceph"><a href="#Ceph" class="headerlink" title="Ceph"></a>Ceph</h3><p>Ceph offers block and object-based storage. Object-based storage for block-based devices means direct, binary storage, directly to a LUN. There are no filesystems involved, which theoretically means less overhead as thereâ€™s no filesystem, filesystem tables, and other constructs that might slow the I/O process down.</p><p>Architecture-wise, Ceph has three main services:</p><ul><li>ceph-mon : Used for cluster monitoring, CRUSH maps, and Object Storage Daemon (OSD) maps.</li><li>ceph-osd: This handles actual data storage, replication, and recovery. It requires at least two nodes; weâ€™ll use three for clustering reasons.</li><li>ceph-mds: Metadata server, used when Ceph needs filesystem access.</li></ul><p>Ceph é›†ç¾¤ä¸­ï¼Œæ‰€æœ‰çš„æ•°æ®èŠ‚ç‚¹è¦æ±‚é‡‡ç”¨ç›¸åŒçš„ç¡¬ä»¶é…ç½®ï¼Œç›¸åŒçš„CPUã€å†…å­˜ã€ç¡¬ç›˜ï¼Œä¸é€‚ç”¨RAIDæ§åˆ¶å™¨ï¼Œä»…ä»…ä½¿ç”¨HBAã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy install ceph-admin ceph-monitor ceph-osd1 ceph-osd2</span><br><span class="line">ceph-osd3</span><br><span class="line">ceph-deploy mon create-initial</span><br><span class="line">ceph-deploy gatherkeys ceph-monitor</span><br><span class="line">ceph-deploy disk list ceph-osd1 ceph-osd2 ceph-osd3</span><br><span class="line">ceph-deploy disk zap ceph-osd1:/dev/sdb  ceph-osd2:/dev/sdb</span><br><span class="line">ceph-osd3:/dev/sdb</span><br><span class="line">ceph-deploy osd prepare ceph-osd1:/dev/sdb ceph-osd2:/dev/sdb</span><br><span class="line">ceph-osd3:/dev/sdb</span><br><span class="line">ceph-deploy osd activate ceph-osd1:/dev/sdb1 ceph-osd2:/dev/</span><br><span class="line">sdb1 ceph-osd3:/dev/sdb1</span><br></pre></td></tr></table></figure><p>å¯¹ä¸Šè¿°å‘½ä»¤çš„è¯´æ˜ï¼š</p><ul><li><p>The first command starts the actual deployment processâ€”for the admin, monitor, and OSD nodes, with the installation of all the necessary packages.</p></li><li><p>The second and third commands configure the monitor host so that itâ€™s ready to accept external connections.</p></li><li><p>The two disk commands are all about disk preparationâ€”Ceph will clear the disks that we assigned to it (/dev/sdb per OSD host) and create two partitions on them, one for Ceph data and one for the Ceph journal.</p></li><li><p>The last two commands prepare these filesystems for use and activate Ceph. If at any time your ceph-deploy script stops, check your DNS and /etc/hosts and firewalld configuration, as thatâ€™s where the problems usually are.</p></li></ul><p>ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°†Cephå­˜å‚¨å‘å¸ƒç»™KVMä¸»æœºä½œä¸ºå­˜å‚¨æ± ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph osd pool create KVMpool 128 128</span><br></pre></td></tr></table></figure><p>è¿˜éœ€è¦å‡ ä¸ªæ­¥éª¤æ¥å®ç°å®‰å…¨çš„è®¿é—®ï¼Œä¸ºCephçš„è®¿é—®å¢åŠ å¯†ç éªŒè¯ã€‚</p><ol><li><p>Cephç”ŸæˆéªŒè¯çš„å¯†ç  Key</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ceph auth get-or-create client.KVMpool mon <span class="string">&#x27;allow r&#x27;</span> osd <span class="string">&#x27;allow</span></span><br><span class="line"><span class="string">rwx pool=KVMpool&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#It&#x27;s going to throw us a status message, something like this:</span></span><br><span class="line">key = AQB9p8RdqS09CBAA1DHsiZJbehb7ZBffhfmFJQ==</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>å®šä¹‰ä¸€ä¸ªSecret</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">secret</span> <span class="attr">ephemeral</span>=<span class="string">&#x27;no&#x27;</span> <span class="attr">private</span>=<span class="string">&#x27;no&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">usage</span> <span class="attr">type</span>=<span class="string">&#x27;ceph&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>client.KVMpool secret<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">usage</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">secret</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å°†Secretçš„UUIDä¸Cephç”Ÿæˆçš„Keyè¿›è¡Œå…³è”ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">virsh secret-define --file secret.xml</span><br><span class="line"></span><br><span class="line">Secret 95b1ed29-16aa-4e95-9917-c2cd4f3b2791 created</span><br><span class="line"></span><br><span class="line">virsh secret-set-value 95b1ed29-16aa-4e95-9917-c2cd4f3b2791</span><br><span class="line">AQB9p8RdqS09CBAA1DHsiZJbehb7ZBffhfmFJQ==</span><br></pre></td></tr></table></figure></li><li><p>å®šä¹‰Cephå­˜å‚¨æ± </p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">pool</span> <span class="attr">type</span>=<span class="string">&quot;rbd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>KVMpool<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">host</span> <span class="attr">name</span>=<span class="string">&#x27;192.168.159.151&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;6789&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">auth</span> <span class="attr">username</span>=<span class="string">&#x27;KVMpool&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;ceph&#x27;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">secret</span> <span class="attr">uuid</span>=<span class="string">&#x27;95b1ed29-16aa-4e95-9917-c2cd4f3b2791&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">auth</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">pool</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">virsh pool-define --file ceph.xml</span><br><span class="line">virsh pool-start KVMpool</span><br><span class="line">virsh pool-autostart KVMpool</span><br><span class="line">virsh pool-list --details</span><br></pre></td></tr></table></figure><h3 id="è™šæ‹Ÿç£ç›˜é•œåƒå’ŒKVMå­˜å‚¨åŸºæœ¬æ“ä½œ"><a href="#è™šæ‹Ÿç£ç›˜é•œåƒå’ŒKVMå­˜å‚¨åŸºæœ¬æ“ä½œ" class="headerlink" title="è™šæ‹Ÿç£ç›˜é•œåƒå’ŒKVMå­˜å‚¨åŸºæœ¬æ“ä½œ"></a>è™šæ‹Ÿç£ç›˜é•œåƒå’ŒKVMå­˜å‚¨åŸºæœ¬æ“ä½œ</h3></li></ol><p>æ–‡ç« ä»‹ç»äº†ä½¿ç”¨ddå‘½ä»¤ç”Ÿæˆç£ç›˜é•œåƒæ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š</p><p>ç”Ÿæˆ10Gçš„é¢„åˆ†é…ç£ç›˜æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd <span class="keyword">if</span>=/dev/zero of=/vms/dbvm_disk2.img bs=1G count=10</span><br></pre></td></tr></table></figure><p>ç”Ÿæˆ10Gçš„ç£ç›˜æ–‡ä»¶ï¼Œä½¿ç”¨seekå…³é”®å­—ï¼Œä¸åšé¢„åˆ†é…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd <span class="keyword">if</span>=/dev/zero of=/vms/dbvm_disk2_seek.imgbs=1G seek=10 count=0</span><br></pre></td></tr></table></figure><h4 id="qemu-img-å‘½ä»¤"><a href="#qemu-img-å‘½ä»¤" class="headerlink" title="qemu-img å‘½ä»¤"></a>qemu-img å‘½ä»¤</h4><p>ä½¿ç”¨qemu-img infoæŸ¥çœ‹ç£ç›˜æ–‡ä»¶çš„ä¿¡æ¯ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># qemu-img info /vms/dbvm_disk2.img</span></span><br><span class="line">image: /vms/dbvm_disk2.img</span><br><span class="line">file format: raw</span><br><span class="line">virtual size: 10G (10737418240 bytes)</span><br><span class="line">disk size: 10G</span><br><span class="line"><span class="comment"># qemu-img info /vms/dbvm_disk2_seek.img</span></span><br><span class="line">image: /vms/dbvm_disk2_seek.img</span><br><span class="line">file format: raw</span><br><span class="line">virtual size: 10G (10737418240 bytes)</span><br><span class="line">disk size: 10M</span><br></pre></td></tr></table></figure><h4 id="ä½¿ç”¨virshå‘½ä»¤åŠ è½½ç¡¬ç›˜"><a href="#ä½¿ç”¨virshå‘½ä»¤åŠ è½½ç¡¬ç›˜" class="headerlink" title="ä½¿ç”¨virshå‘½ä»¤åŠ è½½ç¡¬ç›˜"></a>ä½¿ç”¨virshå‘½ä»¤åŠ è½½ç¡¬ç›˜</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virsh attach-disk CentOS8 /vms/dbvm_disk2.img vdb --live --config</span><br></pre></td></tr></table></figure><p>è¯´æ˜å¦‚ä¸‹ï¼š</p><ul><li> <strong>CentOS8</strong> is the virtual machine to which a disk attachment is executed. </li><li>Then, there is the path of the disk image,  <strong>/vms/dbvm_disk2.img</strong></li><li><strong>vdb</strong> is the target disk name that would be visible inside the guest operating system. </li><li><strong>â€“live</strong> means performing the action while the virtual machine is running.</li><li><strong>â€“config</strong> means attaching it persistently across reboot. Not adding a â€“config switch will keep the disk attached only until reboot.</li></ul><p>æŸ¥çœ‹è™šæ‹Ÿæœºçš„ç¡¬ç›˜ä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">virsh domblklist CentOS8 --details</span><br><span class="line"></span><br><span class="line">Type Device Target Source</span><br><span class="line">------------------------------------------------</span><br><span class="line">file disk vda /var/lib/libvirt/images/fedora21.qcow2</span><br><span class="line">file disk vdb /vms/dbvm_disk2_seek.img</span><br></pre></td></tr></table></figure><p>è¿˜æœ‰å…¶ä»–ç« èŠ‚ï¼Œæ¯”å¦‚åˆ›å»ºISOåº“ã€åˆ é™¤å­˜å‚¨æ± ã€åˆ›å»ºå·å’Œåˆ é™¤å·ã€‚</p><h4 id="æœ‰å…³NVMeå’ŒNVMe-over-Fabric"><a href="#æœ‰å…³NVMeå’ŒNVMe-over-Fabric" class="headerlink" title="æœ‰å…³NVMeå’ŒNVMe over Fabric"></a>æœ‰å…³NVMeå’ŒNVMe over Fabric</h4><p>SSDå­˜å‚¨çš„å­˜å–æ–¹å¼å‘ç”Ÿæ”¹å˜ï¼Œä¸»è¦ä½“ç°åœ¨æ€§èƒ½å’Œå»¶æ—¶è¿™ä¸¤æ–¹é¢ã€‚ä¼ ç»Ÿ<strong>AHCI</strong> (Advanced Host Controller Interface) å·²ä¸èƒ½æ»¡è¶³SSDçš„æ€§èƒ½è¦æ±‚ã€‚</p><p><strong>NVMe</strong> (Non-Volatile Memory Express) æ˜¯ä¸€ä¸ªå…¨æ–°çš„åè®®ï¼ŒåŸºäºPCIeæŠ€æœ¯ï¼Œç›®çš„åœ¨äºæ»¡è¶³SSDçš„é«˜æ€§èƒ½ã€ä½æ—¶å»¶çš„è®¿é—®è¦æ±‚ã€‚è¶Šæ¥è¶Šå¤šçš„å­˜å‚¨è®¾å¤‡å·²ç»é›†æˆäº†SSDå’ŒNVMeï¼Œä¸»è¦ç”¨äºç¼“å­˜ï¼ŒåŒæ—¶ä¹Ÿæœ‰ç”¨äºæ•°æ®å­˜å‚¨çš„ã€‚</p><p>Fiber Channelï¼Œè™½ç„¶10å¤šå¹´è¢«äººäº‰æ‰§è¯´è¦ä»å¸‚åœºæ¶ˆå¤±ï¼Œä¸»è¦åŸå› æ— å¤–ä¹ï¼šFCéœ€è¦ä¸“ç”¨çš„äº¤æ¢æœºã€ä¸“é—¨çš„ç½‘å¡å’Œçº¿ç¼†ï¼ŒFCè®¾å¤‡è´µï¼Œéœ€è¦ä¸“é—¨çš„çŸ¥è¯†ï¼Œè€Œä¸”FCçš„é€Ÿç‡æ²¡æœ‰ä»¥å¤ªç½‘å‘å±•å¿«ã€‚</p><p>ä½†æ˜¯ï¼Œç›®å‰å¸‚åœºä¸Šå‘ç”Ÿçš„æƒ…å†µæœ‰æ‰€ä¸åŒï¼ŒFCå¯ä»¥æ»¡è¶³NVMe SSDå¸¦æ¥çš„æ€§èƒ½æå‡çš„éœ€æ±‚ã€‚</p><p>Two of these concepts derived from <strong>Intel Optane</strong>â€”<strong>Storage Class Memory (SCM) and Persistent Memory (PM)</strong> are the latest technologies that storage companies and customers want adopted into their storage systems, and fast.</p><p>å°†å·¥ä½œè´Ÿè½½ç§»åˆ°å†…å­˜å½“ä¸­æ˜¯ç¬¦åˆé€»è¾‘çš„ï¼Œè®¾æƒ³ä¸€ä¸‹å†…å­˜å‹æ•°æ®åº“(Microsoft SQL, SAP HANA, Oracle).</p><p>å¦‚æœä¸€ä¸ªå­˜å‚¨å‚å•†ç”Ÿäº§äº†ä½¿ç”¨SCM SSDçš„å­˜å‚¨è®¾å¤‡ï¼Œé‚£ä¹ˆåªæœ‰å†…å­˜å¯ç”¨äºç¼“å­˜(Cache).</p>]]></content>
    
    
    <summary type="html">Mastering KVM Virtualization å­¦ä¹ ç¬”è®°ï¼Œè‡ªç”¨ï¼Œæœ¬ç¯‡ä¸»è¦è®°å½•ç¬¬ä¸‰ç« åˆ°ç¬¬äº”ç« ã€‚</summary>
    
    
    
    
    <category term="kvm" scheme="https://weiborao.github.io/tags/kvm/"/>
    
  </entry>
  
  <entry>
    <title>Cisco NFVIS CSR1Kv ZTP Onboarding for SDWAN</title>
    <link href="https://weiborao.github.io/csr1kv-nfvis-ztp-demo.html"/>
    <id>https://weiborao.github.io/csr1kv-nfvis-ztp-demo.html</id>
    <published>2021-02-08T03:02:43.000Z</published>
    <updated>2021-02-08T03:06:04.401Z</updated>
    
    <content type="html"><![CDATA[<div style="position: relative; width: 100%; height: 0; padding-bottom: 75%;">    <iframe src="//player.bilibili.com/player.html?aid=544065936&bvid=BV1Zv4y1o7YJ&cid=294265132&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="position: absolute; width: 100%; height: 100%; left: 0; top: 0;">    </iframe></div>]]></content>
    
    
      
      
    <summary type="html">

&lt;div style=&quot;position: relative; width: 100%; height: 0; padding-bottom: 75%;&quot;&gt;
    &lt;iframe src=&quot;//player.bilibili.com/player.html?aid=5440</summary>
      
    
    
    
    
    <category term="ztp" scheme="https://weiborao.github.io/tags/ztp/"/>
    
    <category term="nfvis" scheme="https://weiborao.github.io/tags/nfvis/"/>
    
  </entry>
  
  <entry>
    <title>Cisco CSR 1000v &amp; Catalyst 8000v KVM SRIOVå®‰è£…è®¾ç½®æ¼”ç¤º</title>
    <link href="https://weiborao.github.io/csr1kv-kvm-sriov-ubuntu-demo.html"/>
    <id>https://weiborao.github.io/csr1kv-kvm-sriov-ubuntu-demo.html</id>
    <published>2021-02-08T02:36:08.000Z</published>
    <updated>2021-02-08T03:12:51.946Z</updated>
    
    <content type="html"><![CDATA[<div style="position: relative; width: 100%; height: 0; padding-bottom: 75%;">    <iframe src="//player.bilibili.com/player.html?aid=501530216&bvid=BV1VN411R75t&cid=294248612&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="position: absolute; width: 100%; height: 100%; left: 0; top: 0;">    </iframe></div><p>é¸£è°¢ï¼š<a href="https://rongtianjie.github.io/">Johnny Rong</a> <a href="https://rongtianjie.github.io/2019/03/15/2019-03-15-HEXO%E4%B8%AD%E6%B7%BB%E5%8A%A0B%E7%AB%99%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE%E5%99%A8/">Hexoåšå®¢ä¸­æ·»åŠ Bç«™è§†é¢‘æ’­æ”¾å™¨</a> </p>]]></content>
    
    
      
      
    <summary type="html">

&lt;div style=&quot;position: relative; width: 100%; height: 0; padding-bottom: 75%;&quot;&gt;
    &lt;iframe src=&quot;//player.bilibili.com/player.html?aid=5015</summary>
      
    
    
    
    
    <category term="sriov" scheme="https://weiborao.github.io/tags/sriov/"/>
    
    <category term="csr1000v" scheme="https://weiborao.github.io/tags/csr1000v/"/>
    
    <category term="ztp" scheme="https://weiborao.github.io/tags/ztp/"/>
    
  </entry>
  
  <entry>
    <title>Hexo å®‰è£…è®¾ç½®é‡åˆ°çš„é—®é¢˜åŠè§£å†³åŠæ³•</title>
    <link href="https://weiborao.github.io/hexo-setup-log-md.html"/>
    <id>https://weiborao.github.io/hexo-setup-log-md.html</id>
    <published>2021-02-07T15:36:19.000Z</published>
    <updated>2021-02-08T15:43:30.966Z</updated>
    
    <content type="html"><![CDATA[<h1 id="é‡åˆ°çš„é—®é¢˜"><a href="#é‡åˆ°çš„é—®é¢˜" class="headerlink" title="é‡åˆ°çš„é—®é¢˜"></a>é‡åˆ°çš„é—®é¢˜</h1><p>æ­£å¸¸æŒ‰ç…§<strong>brew install node</strong> ä»¥åŠ <strong>npm install -g hexo-cli</strong> å®‰è£…å®Œä»¥åï¼Œè¿è¡Œ<strong>hexo deploy</strong>æŠ¥é”™ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">âœ  blog hexo d</span><br><span class="line">INFO  Validating config</span><br><span class="line">INFO  Deploying: git</span><br><span class="line">INFO  Clearing .deploy_git folder...</span><br><span class="line">INFO  Copying files from public folder...</span><br><span class="line">FATAL &#123;</span><br><span class="line">  err: TypeError [ERR_INVALID_ARG_TYPE]: The <span class="string">&quot;mode&quot;</span> argument must be <span class="built_in">integer</span>. Received an instance of Object</span><br><span class="line">      at copyFile (node:fs:2019:10)</span><br><span class="line">      at tryCatcher (/Users/werao/blog/node_modules/bluebird/js/release/util.js:16:23)</span><br><span class="line">      at ret (<span class="built_in">eval</span> at makeNodePromisifiedEval (/usr/<span class="built_in">local</span>/lib/node_modules/hexo-cli/node_modules/bluebird/js/release/promisify.js:184:12), &lt;anonymous&gt;:13:39)</span><br></pre></td></tr></table></figure><p>ç½‘ä¸ŠæŸ¥æ‰¾äº†ä¸€ä¸‹ï¼ŒæŠ¥é”™çš„åŸå› æ˜¯Hexoä¸Node.jsçš„å…¼å®¹æ€§é—®é¢˜ã€‚</p><h1 id="è§£å†³åŠæ³•"><a href="#è§£å†³åŠæ³•" class="headerlink" title="è§£å†³åŠæ³•"></a>è§£å†³åŠæ³•</h1><p>éå¸¸å¹¸è¿ï¼Œæ‰¾åˆ°ä¸€ç¯‡æ–‡ç« ï¼š<a href="http://franktianyirenjian.github.io/2020/04/28/%E9%87%8D%E8%A3%85Hexo%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/">é‡è£…Hexoé‡åˆ°çš„å‘</a> ä½œè€… æˆç™¾å·ã€‚</p><p>ç®€è¦è®°å½•æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li><p>å¸è½½<strong>node</strong><br><strong>brew uninstall node</strong></p></li><li><p>å®‰è£…<strong>nvm</strong><br><strong>brew install nvm</strong><br>è®°å¾—æŒ‰æç¤ºä¿®æ”¹**~/.zshrc<strong>æ–‡ä»¶ï¼Œå¦åˆ™ä¸‹æ¬¡å¯åŠ¨ä¼šæ‰¾ä¸åˆ°</strong>nvm**ã€‚</p></li><li><p>ä½¿ç”¨<strong>nvm</strong>å®‰è£…ä½äº14.0ç‰ˆæœ¬çš„node.jsâ€“å¦‚æœåç»­ç‰ˆæœ¬å‡çº§ï¼Œè¿˜å¯ä»¥ä½¿ç”¨nvmå®‰è£…æ–°ç‰ˆæœ¬ã€‚<br><strong>nvm install v13.14.0</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Now using node v13.14.0 (npm v6.14.4)</span><br><span class="line">Creating default <span class="built_in">alias</span>: default -&gt; v13.14.0</span><br></pre></td></tr></table></figure></li><li><p>é‡æ–°è¿è¡Œ<strong>hexo deploy -g</strong> å‘å¸ƒæœ¬æ–‡ã€‚</p></li></ol><p>é¸£è°¢<strong>æˆç™¾å·</strong>ã€‚</p>]]></content>
    
    
    <summary type="html">è®°å½•åœ¨Hexoå®‰è£…è¿‡ç¨‹ä¸­é‡åˆ°çš„Hexoä¸Node.jsç‰ˆæœ¬å…¼å®¹æ€§çš„é—®é¢˜ï¼Œä½¿ç”¨nvmå®‰è£…ä½ç‰ˆæœ¬çš„node.jsè§£å†³é—®é¢˜ï¼Œå‚è€ƒæˆç™¾å·çš„è§£å†³åŠæ³•ã€‚</summary>
    
    
    
    
    <category term="hexo" scheme="https://weiborao.github.io/tags/hexo/"/>
    
  </entry>
  
  <entry>
    <title>Cisco CSR1000v KVM SRIOV Setting Guide on Ubuntu 20.04 With NetworkManager</title>
    <link href="https://weiborao.github.io/csr1kv-kvm-Ubuntu20-04-md.html"/>
    <id>https://weiborao.github.io/csr1kv-kvm-Ubuntu20-04-md.html</id>
    <published>2021-02-03T14:37:33.000Z</published>
    <updated>2021-02-08T03:38:30.670Z</updated>
    
    <content type="html"><![CDATA[<p>Last Update: February 3, 2021</p><p>Author: Rao Weibo</p><p>Version: 1.0</p><p>This guide provides the steps on how to install CSR1000v/Catalyst 8000v on KVM, the setting of SRIOV and KVM tuning.</p><h1 id="Ubuntu-20-04-Installation-and-Settings"><a href="#Ubuntu-20-04-Installation-and-Settings" class="headerlink" title="Ubuntu 20.04 Installation and Settings"></a>Ubuntu 20.04 Installation and Settings</h1><h2 id="1-BIOS-settings"><a href="#1-BIOS-settings" class="headerlink" title="(1) BIOS settings"></a>(1) BIOS settings</h2><table><thead><tr><th>Configuration</th><th>Recommended Setting</th></tr></thead><tbody><tr><td>Intel Hyper-Threading  Technology</td><td>Disabled</td></tr><tr><td>Number of Enable Cores</td><td>ALL</td></tr><tr><td>Execute Disable</td><td>Enabled</td></tr><tr><td><strong>Intel VT</strong></td><td><strong>Enabled</strong></td></tr><tr><td><strong>Intel VT-D</strong></td><td><strong>Enabled</strong></td></tr><tr><td>Intel VT-D coherency support</td><td>Enabled</td></tr><tr><td>Intel VT-D ATS support</td><td>Enabled</td></tr><tr><td>CPU Performance</td><td>High throughput</td></tr><tr><td>Hardware Perfetcher</td><td>Disabled</td></tr><tr><td>Adjacent Cache Line Prefetcher</td><td>Disabled</td></tr><tr><td>DCU Streamer Prefetch</td><td>Disable</td></tr><tr><td>Power Technology</td><td>Custom</td></tr><tr><td>Enhanced Intel Speedstep  Technology</td><td>Disabled</td></tr><tr><td>Intel Turbo Boost Technology</td><td>Enabled</td></tr><tr><td>Processor Power State C6</td><td>Disabled</td></tr><tr><td>Processor Power State C1 Enhanced</td><td>Disabled</td></tr><tr><td>Frequency Poor Override</td><td>Enabled</td></tr><tr><td>P-State Coordination</td><td>HW_ALL</td></tr><tr><td>Energy Performance</td><td>Performance</td></tr></tbody></table><p>The above settings are from the Installation guide from <a href="https://www.cisco.com/c/en/us/td/docs/routers/csr1000/software/configuration/b_CSR1000v_Configuration_Guide/b_CSR1000v_Configuration_Guide_chapter_0101.html#con_1313827">Cisco CSR 1000v and Cisco ISRv Software Configuration Guide</a>.<br>Note: some platform such as <strong>Cisco NFVIS</strong>, does not disable the Hyper-Threading.</p><h2 id="2-Ubuntu-20-04-installation-tips"><a href="#2-Ubuntu-20-04-installation-tips" class="headerlink" title="(2) Ubuntu 20.04 installation tips"></a>(2) Ubuntu 20.04 installation tips</h2><p>If you need the Gnome GUI, you can install the Ubuntu 20.04 Desktop.<br>After the system bootup, <strong>â€˜apparmorâ€™</strong> is recommended to be disabled, otherwise, you may meet <strong>permission denied</strong> when you assign SRIOV devices to the CSR1kV. You need to reboot to take effect.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl disable apparmor</span><br><span class="line">egrep -o &#x27;(vmx|svm)&#x27; /proc/cpuinfo | sort | uniq</span><br></pre></td></tr></table></figure><p>You can find the <strong>vmx</strong> on Intel platform, or <strong>svm</strong> on AMD platform.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop ufw</span><br><span class="line">systemctl disable ufw</span><br></pre></td></tr></table></figure><p><code>cat /etc/sysctl.conf</code></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 0</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 0</span><br><span class="line">net.bridge.bridge-nf-call-arptables = 0</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo apt install qemu-kvm libvirt-clients libvirt-daemon-system bridge-utils virt-manager numactl virt-top</span></span><br></pre></td></tr></table></figure><p>After installation, you can check the version</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ libvirtd -V</span><br><span class="line">libvirtd (libvirt) 6.0.0</span><br><span class="line">ubuntu@ubuntu-kvm:~$ qemu-system-x86_64 --version</span><br><span class="line">QEMU emulator version 4.2.1 (Debian 1:4.2-3ubuntu6.11)</span><br><span class="line">Copyright (c) 2003-2019 Fabrice Bellard and the QEMU Project developers</span><br><span class="line">ubuntu@ubuntu-kvm:~$ virt-manager --version</span><br><span class="line">2.2.1</span><br><span class="line">ubuntu@ubuntu-kvm:~$ modinfo kvm-intel</span><br><span class="line">filename:       /lib/modules/5.4.0-62-generic/kernel/arch/x86/kvm/kvm-intel.ko</span><br><span class="line">ubuntu@ubuntu-kvm:~$ modinfo i40evf</span><br><span class="line">filename:       /lib/modules/5.4.0-62-generic/kernel/drivers/net/ethernet/intel/iavf/iavf.ko</span><br><span class="line">version:        3.2.3-k</span><br></pre></td></tr></table></figure><h2 id="3-NIC-Setting"><a href="#3-NIC-Setting" class="headerlink" title="(3) NIC Setting"></a>(3) NIC Setting</h2><p>In Ubuntu 20.04, we use NetworkManager to config the NIC, you can use nmtui on the terminal, or nmcli.<br>First, check the netplan.</p><p><code>cat /etc/netplan/ 00-installer-config.yaml</code></p><p>Edit the yaml file:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Let NetworkManager manage all devices on this system</span></span><br><span class="line"><span class="attr">network:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">renderer:</span> <span class="string">NetworkManager</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo netplan apply</span><br></pre></td></tr></table></figure><p>Then you can set the network config with nmcli or nmtui.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ sudo nmcli connection modify netplan-eno1 ipv4.method manual ipv4.addresses 10.75.59.50/24 ipv4.gateway 10.75.59.1 ipv4.dns 64.104.123.245</span><br><span class="line">ubuntu@ubuntu-kvm:~$ sudo nmcli connection modify netplan-eno1 connection.id eno1</span><br><span class="line">ubuntu@ubuntu-kvm:~$ sudo nmcli connection up eno1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Change the connections name to the devices name.</span></span><br><span class="line"></span><br><span class="line">sudo nmcli connection</span><br><span class="line">ubuntu@ubuntu-kvm:~$ sudo nmcli connection</span><br><span class="line">NAME        UUID                                  TYPE      DEVICE</span><br><span class="line">eno1        10838d80-caeb-349e-ba73-08ed16d4d666  ethernet  eno1</span><br><span class="line">enp216s0f0  6556c191-c253-3a5e-b440-c5b071ec29a4  ethernet  enp216s0f0</span><br><span class="line">enp216s0f1  8080672c-5784-375f-8eb9-a6ef57cbd4f7  ethernet  enp216s0f1</span><br><span class="line">ens1f0      58fb5b1f-c10a-3e7a-9ab9-a8c449840ce6  ethernet  ens1f0</span><br><span class="line">ens1f1      2a06a9d9-b761-3bdf-aa0b-3d44fff2158f  ethernet  ens1f1</span><br><span class="line">virbr0      ca7d1e11-a82f-429c-9d91-fc985776232c  bridge    virbr0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">Set the MTU and <span class="built_in">disable</span> ipv4 <span class="keyword">for</span> the NIC to <span class="built_in">enable</span> SRIOV.</span> </span><br><span class="line"></span><br><span class="line">sudo nmcli connection modify ens1f0 ethernet.mtu 9216</span><br><span class="line">sudo nmcli connection modify ens1f0 ipv4.method disabled</span><br><span class="line">sudo nmcli connection up ens1f0</span><br><span class="line">sudo ip link show ens1f0</span><br><span class="line">2: ens1f0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9216 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class="line">link/ether 40:a6:b7:0f:a7:74 brd ff:ff:ff:ff:ff:ff</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Note: This value 9216 of MTU is derived from Cisco NFVIS.</span></span><br><span class="line"><span class="meta">CSP5228-1#</span><span class="bash"> show pnic-detail mtu</span></span><br><span class="line">Name          MTU</span><br><span class="line">=============================</span><br><span class="line">eth0-1        9216</span><br><span class="line">eth0-2        9216</span><br><span class="line">eth1-1        9216</span><br><span class="line">eth1-2        9216</span><br></pre></td></tr></table></figure><h1 id="SR-IOV-Configuration"><a href="#SR-IOV-Configuration" class="headerlink" title="SR-IOV Configuration"></a>SR-IOV Configuration</h1><h2 id="1-Check-the-NIC-to-support-SR-IOV"><a href="#1-Check-the-NIC-to-support-SR-IOV" class="headerlink" title="(1) Check the NIC to support SR-IOV"></a>(1) Check the NIC to support SR-IOV</h2><p>Check the NIC hardware infor.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sudo lshw -c network -businfo</span><br><span class="line"></span><br><span class="line">Bus info          Device      Class          Description</span><br><span class="line">========================================================</span><br><span class="line"></span><br><span class="line">pci@0000:3b:00.0  eno1        network        Ethernet Controller 10G X550T</span><br><span class="line">pci@0000:3b:00.1  eno2        network        Ethernet Controller 10G X550T</span><br><span class="line">pci@0000:5e:00.0  ens1f0      network        Ethernet Controller XXV710 for 25GbE SFP28</span><br><span class="line">pci@0000:5e:00.1  ens1f1      network        Ethernet Controller XXV710 for 25GbE SFP28</span><br><span class="line">pci@0000:d8:00.0  enp216s0f0  network        Ethernet Controller XXV710 for 25GbE SFP28</span><br><span class="line">pci@0000:d8:00.1  enp216s0f1  network        Ethernet Controller XXV710 for 25GbE SFP28</span><br></pre></td></tr></table></figure><p>Check the capabilities of NIC</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo lspci -vv -s 5e:00.0 | grep -A 5 -i SR-IOV</span><br><span class="line">    Capabilities: [160 v1] Single Root I/O Virtualization (SR-IOV)</span><br><span class="line">        IOVCap: Migration-, Interrupt Message Number: 000</span><br><span class="line">        IOVCtl: Enable+ Migration- Interrupt- MSE+ ARIHierarchy+</span><br><span class="line">        IOVSta: Migration-</span><br><span class="line">        Initial VFs: 64, Total VFs: 64, Number of VFs: 2, Function Dependency Link: 00</span><br><span class="line">        VF offset: 16, stride: 1, Device ID: 154c</span><br></pre></td></tr></table></figure><h2 id="2-Change-the-GRUB-parameters"><a href="#2-Change-the-GRUB-parameters" class="headerlink" title="(2) Change the GRUB parameters"></a>(2) Change the GRUB parameters</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/default/grub </span><br><span class="line">GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet hugepagesz=1G hugepages=64 default_hugepagesz=1G intel_iommu=on iommu=pt isolcpus=1-8,45-52&quot;</span><br></pre></td></tr></table></figure><p><strong>Noteï¼šThe hugepages should be no more than the physical memory, otherwise, it will fail to bootup.</strong></p><ul><li><strong>default_hugepagesz=1G hugepagesz=1G hugepages=64</strong> will allocate 64 1GB huge pages at boot, which are <strong>static huge pages</strong>. CSR 1000v will use these static huge pages for best performance.</li><li><strong>isolcpus=1-8,45-52</strong> will isolate the CPUs cores reserved for CSR 1000v, prevent other processes running on these cores, this can reduce latency for CSR 1000v. You can refer to   [Check the capability of the platform][1]  to get the CPU information.</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo update-grub</span><br></pre></td></tr></table></figure><p>After reboot, check the /proc/cmdline.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/cmdline |grep intel_iommu=on</span><br><span class="line">dmesg |grep -e DMAR -e IOMMU</span><br><span class="line">dmesg | grep -e DMAR -e IOMMU -e AMD-Vi</span><br><span class="line">ubuntu@ubuntu-kvm:~$ cat /proc/cmdline |grep intel_iommu=on</span><br><span class="line">BOOT_IMAGE=/vmlinuz-5.4.0-62-generic root=/dev/mapper/ubuntu--vg-ubuntu--lv ro quiet hugepagesz=1G hugepages=64 default_hugepagesz=1G intel_iommu=on iommu=pt isolcpus=1-8,45-52</span><br><span class="line"></span><br><span class="line">ubuntu@ubuntu-kvm:~ $ dmesg |grep -e DMAR -e IOMMU</span><br><span class="line">[    0.020313] ACPI: DMAR 0x000000005DA8EB80 000270 (v01 Cisco0 CiscoUCS 00000001 INTL 20091013)</span><br><span class="line">[    1.954441] DMAR: IOMMU enabled</span><br></pre></td></tr></table></figure><p>Check the CPU info, all the CPU cores and isolated CPU cores.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ cat /sys/devices/system/cpu/isolated</span><br><span class="line">1-8,45-52</span><br><span class="line">ubuntu@ubuntu-kvm:~$ cat /sys/devices/system/cpu/present</span><br><span class="line">0-87</span><br></pre></td></tr></table></figure><h2 id="3-VFs-Persistence"><a href="#3-VFs-Persistence" class="headerlink" title="(3) VFs Persistence"></a>(3) VFs Persistence</h2><p><strong>NetworkManager way:</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> nmcli can <span class="built_in">set</span> the SRIOV, as follow:</span></span><br><span class="line">sudo nmcli connection modify ens1f0 sriov.total-vfs 2</span><br><span class="line">sudo nmcli connection modify ens1f1 sriov.total-vfs 2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> We can <span class="built_in">set</span> the MAC address and <span class="built_in">set</span> the trust on:</span></span><br><span class="line">sudo nmcli connection modify ens1f0 sriov.vfs &#x27;0 mac=b6:4f:02:37:5a:d8 trust=true, 1 mac=26:04:1d:1f:3d:a9 trust=true&#x27;</span><br><span class="line">sudo nmcli connection modify ens1f1 sriov.vfs &#x27;0 mac=76:6c:4e:16:7f:e2 trust=true, 1 mac=6a:f2:bd:97:71:65 trust=true&#x27;</span><br><span class="line">sudo nmcli connection up ens1f0</span><br><span class="line">sudo nmcli connection up ens1f1</span><br></pre></td></tr></table></figure><p>After reboot, check the dmesg.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sudo dmesg | grep -i vf</span><br><span class="line">[    6.599304] i40e 0000:5e:00.0: Allocating 2 VFs.</span><br><span class="line">[    6.680111] i40e 0000:5e:00.1: Allocating 2 VFs.</span><br><span class="line">[    6.730167] iavf: Intel(R) Ethernet Adaptive Virtual Function Network Driver - version 3.2.3-k</span><br><span class="line">&lt;&lt; snip &gt;&gt;</span><br><span class="line">[   17.931493] i40e 0000:5e:00.0: Setting MAC b6:4f:02:37:5a:d8 on VF 0</span><br><span class="line">[   18.111781] i40e 0000:5e:00.0: VF 0 is now trusted</span><br><span class="line">[   18.112559] i40e 0000:5e:00.0: Setting MAC 26:04:1d:1f:3d:a9 on VF 1</span><br><span class="line">[   18.291464] i40e 0000:5e:00.0: VF 1 is now trusted</span><br><span class="line">[   18.292231] i40e 0000:5e:00.1: Setting MAC 76:6c:4e:16:7f:e2 on VF 0</span><br><span class="line">[   18.475259] i40e 0000:5e:00.1: VF 0 is now trusted</span><br><span class="line">[   18.475929] i40e 0000:5e:00.1: Setting MAC 6a:f2:bd:97:71:65 on VF 1</span><br><span class="line">[   18.659465] i40e 0000:5e:00.1: VF 1 is now trusted</span><br><span class="line">[   18.728124] iavf 0000:5e:02.0 ens1f0v0: NIC Link is Up Speed is 25 Gbps Full Duplex</span><br><span class="line">[   18.752275] iavf 0000:5e:02.1 ens1f0v1: NIC Link is Up Speed is 25 Gbps Full Duplex</span><br><span class="line">[   18.776329] iavf 0000:5e:0a.0 ens1f1v0: NIC Link is Up Speed is 25 Gbps Full Duplex</span><br><span class="line">[   18.800569] iavf 0000:5e:0a.1 ens1f1v1: NIC Link is Up Speed is 25 Gbps Full Duplex</span><br></pre></td></tr></table></figure><h2 id="4-Check-the-VFs"><a href="#4-Check-the-VFs" class="headerlink" title="(4) Check the VFs"></a>(4) Check the VFs</h2><p>You can check the VFs from lspci or ip link commands.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ sudo lspci | grep -i Virtual</span><br><span class="line">ubuntu@ubuntu-kvm:~$ sudo ip link show | grep -B2 vf</span><br></pre></td></tr></table></figure><p>Good news is that the VFs names are well related to the physical NICs. For example, <strong>ens1f0v1</strong> is one of the VFs of the physical NIC <strong>ens1f0</strong> .</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ ip link show | grep -E ens1f[0,1]v[0,1] -A 1</span><br><span class="line">9: ens1f0v1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether 26:04:1d:1f:3d:a9 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">10: ens1f1v1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether 6a:f2:bd:97:71:65 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">15: ens1f0v0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether b6:4f:02:37:5a:d8 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">16: ens1f1v0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class="line">link/ether 76:6c:4e:16:7f:e2 brd ff:ff:ff:ff:ff:ff</span><br></pre></td></tr></table></figure><p>We can change the MTU to <strong>9216</strong> (or you may not need 9216, 1504 is enough).</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo nmcli connection modify ens1f0v0 ethernet.mtu 9216 ipv4.method disabled</span><br><span class="line">sudo nmcli connection modify ens1f0v1 ethernet.mtu 9216 ipv4.method disabled</span><br><span class="line">sudo nmcli connection modify ens1f1v0 ethernet.mtu 9216 ipv4.method disabled</span><br><span class="line">sudo nmcli connection modify ens1f1v1 ethernet.mtu 9216 ipv4.method disabled</span><br><span class="line">sudo nmcli connection up ens1f0v0 </span><br><span class="line">sudo nmcli connection up ens1f0v1</span><br><span class="line">sudo nmcli connection up ens1f1v0</span><br><span class="line">sudo nmcli connection up ens1f1v1</span><br></pre></td></tr></table></figure><p>The above configs will survive after reboot.</p><h1 id="Create-SR-IOV-Virtual-Network-Adapter-Pool"><a href="#Create-SR-IOV-Virtual-Network-Adapter-Pool" class="headerlink" title="Create SR-IOV Virtual Network Adapter Pool"></a>Create SR-IOV Virtual Network Adapter Pool</h1><p>Using this method, KVM creates a pool of network devices that can be inserted into VMs, and the size of that pool is determined by how many VFs were created on the physical function when they were initialized.</p><h2 id="1-Create-an-xml-file"><a href="#1-Create-an-xml-file" class="headerlink" title="(1) Create an xml file"></a>(1) Create an xml file</h2><p>ubuntu@ubuntu-kvm:~/kvm$ cat ens1f0_sriov_pool.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">network</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">name</span>&gt;</span>ens1f0_sriov_pool<span class="tag">&lt;/<span class="name">name</span>&gt;</span> <span class="comment">&lt;!-- This is the name of the file you created --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">forward</span> <span class="attr">mode</span>=<span class="string">&#x27;hostdev&#x27;</span> <span class="attr">managed</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">pf</span> <span class="attr">dev</span>=<span class="string">&#x27;ens1f0&#x27;</span>/&gt;</span>  <span class="comment">&lt;!-- Use the netdev name of your SR-IOV devices PF here --&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">forward</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">network</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="2-Define-a-network-and-set-to-auto-start"><a href="#2-Define-a-network-and-set-to-auto-start" class="headerlink" title="(2) Define a network and set to auto start."></a>(2) Define a network and set to auto start.</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">virsh net-define ens1f0_sriov_pool.xml</span><br><span class="line">Sleep 1</span><br><span class="line">virsh net-start ens1f0_sriov_pool</span><br><span class="line">virsh net-autostart ens1f0_sriov_pool</span><br></pre></td></tr></table></figure><p>ubuntu@ubuntu-kvm:~/kvm$ virsh net-dumpxml ens1f0_sriov_pool</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">network</span> <span class="attr">connections</span>=<span class="string">&#x27;1&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>ens1f0_sriov_pool<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>9125a600-6620-4ab6-9a47-8844a61b0918<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">forward</span> <span class="attr">mode</span>=<span class="string">&#x27;hostdev&#x27;</span> <span class="attr">managed</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pf</span> <span class="attr">dev</span>=<span class="string">&#x27;ens1f0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x5e&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x5e&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x1&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">forward</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">network</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="3-Select-the-virtual-adapter-from-the-pool"><a href="#3-Select-the-virtual-adapter-from-the-pool" class="headerlink" title="(3) Select the virtual adapter from the pool"></a>(3) Select the virtual adapter from the pool</h2><p>It is simple to add an SR-IOV NIC, as follow:</p><img src="/csr1kv-kvm-Ubuntu20-04-md/pic1-sriov-pool.png" class="" title="SRIOV Adapter Pool"><p>This is equivalent to the following XML:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;network&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;52:54:00:0b:a5:2e&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">source</span> <span class="attr">network</span>=<span class="string">&#x27;ens1f0_sriov_pool&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br></pre></td></tr></table></figure><p>After the VM powered on, the network info is as follow:<br>virsh dumpxml CSR1KV-1</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;hostdev&#x27;</span> <span class="attr">managed</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;52:54:00:0b:a5:2e&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;vfio&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x5e&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;hostdev0&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="Create-the-CSR1KV-VM-from-virt-manager"><a href="#Create-the-CSR1KV-VM-from-virt-manager" class="headerlink" title="Create the CSR1KV VM from virt-manager"></a>Create the CSR1KV VM from virt-manager</h1><p>From the virt-manager, create a CSR1KV virtual machine step by step, and choose the virtual network interface from the SR-IOV pool.</p><img src="/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step1.png" class="" title="Virt-manager step 1"><img src="/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step2.png" class="" title="Virt-manager Step 2"><img src="/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step2-2.png" class="" title="Virt-manager Step2-2"><img src="/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step3.png" class="" title="Virt-manager Step 3"><img src="/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step4.png" class="" title="Virt-manager Step 4"><p>Note: The first interface of csr1kv-1 is configured to <strong>macvtap Bridge mode</strong>, so you do not need to create a Linux bridge. However, csr1kv-1 can not communicate to the Linux host through this interface, but it can go out of the Linux host through the eno1. This is a known issue with macvtap.</p><img src="/csr1kv-kvm-Ubuntu20-04-md/add-sriov-pool.png" class="" title="Virt-manager Step 5"><p>After select the Virtual Network Interface, click the <strong>Begin Installation</strong>, and you can shut down the virtual machine.<br>The actions above will create the <strong>csr1kv-1.xml</strong> file under the directory: <strong>/etc/libvirtd/qemu/</strong></p><h1 id="KVM-Performance-Tunning"><a href="#KVM-Performance-Tunning" class="headerlink" title="KVM Performance Tunning"></a>KVM Performance Tunning</h1><p>KVM performance tuning are related to NUMA, Memory Hugepage and vCPU pinning. The main reference is Redhat Linux 7 PERFORMANCE TUNING GUIDE</p><p>We will use <strong>virsh edit csr1kv-1</strong> to do the performance tuning.</p><h2 id="1-Check-the-capability-of-the-platform"><a href="#1-Check-the-capability-of-the-platform" class="headerlink" title="(1) Check the capability of the platform"></a>(1) Check the capability of the platform</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ virsh nodeinfo</span><br><span class="line">CPU model:           x86_64</span><br><span class="line">CPU(s):              88</span><br><span class="line">CPU frequency:       1000 MHz</span><br><span class="line">CPU socket(s):       1</span><br><span class="line">Core(s) per socket:  22</span><br><span class="line">Thread(s) per core:  2</span><br><span class="line">NUMA cell(s):        2</span><br><span class="line">Memory size:         394929928 KiB</span><br></pre></td></tr></table></figure><p>[1]:ubuntu@ubuntu-kvm:~$ virsh capabilities</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">capabilities</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">host</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>a24f9760-48f1-f34e-a001-a848f08df7bb<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">cpu</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">arch</span>&gt;</span>x86_64<span class="tag">&lt;/<span class="name">arch</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span>&gt;</span>Cascadelake-Server-noTSX<span class="tag">&lt;/<span class="name">model</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">vendor</span>&gt;</span>Intel<span class="tag">&lt;/<span class="name">vendor</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">microcode</span> <span class="attr">version</span>=<span class="string">&#x27;83898371&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">counter</span> <span class="attr">name</span>=<span class="string">&#x27;tsc&#x27;</span> <span class="attr">frequency</span>=<span class="string">&#x27;2095078000&#x27;</span> <span class="attr">scaling</span>=<span class="string">&#x27;no&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">topology</span> <span class="attr">sockets</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">cores</span>=<span class="string">&#x27;22&#x27;</span> <span class="attr">threads</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>From the outputs, we can get the cores of CPU, the NUMA info and the hugepages.</p><h2 id="2-NUMA-Info"><a href="#2-NUMA-Info" class="headerlink" title="(2) NUMA Info"></a>(2) NUMA Info</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ numactl --hardware</span><br><span class="line">available: 2 nodes (0-1)</span><br><span class="line">node 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65</span><br><span class="line">node 0 size: 192172 MB</span><br><span class="line">node 0 free: 152956 MB</span><br><span class="line">node 1 cpus: 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87</span><br><span class="line">node 1 size: 193500 MB</span><br><span class="line">node 1 free: 158037 MB</span><br><span class="line">node distances:</span><br><span class="line">node   0   1</span><br><span class="line">  0:  10  21</span><br><span class="line">  1:  21  10 </span><br></pre></td></tr></table></figure><p>Two CPUs, each has 192GB memory, the NUMA node are node 0 and node 1.</p><p>You can also check the NUMA info of the NIC, as follow:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ sudo lspci -vv | grep Ethernet -A 6</span><br><span class="line">5e:00.0 Ethernet controller: Intel Corporation Ethernet Controller XXV710 for 25GbE SFP28 (rev 02)</span><br><span class="line">    Subsystem: Cisco Systems Inc Ethernet Network Adapter XXV710</span><br><span class="line">    Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr+ Stepping- SERR+ FastB2B- DisINTx+</span><br><span class="line">    Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx-</span><br><span class="line">    Latency: 0, Cache Line Size: 32 bytes</span><br><span class="line">    Interrupt: pin A routed to IRQ 137</span><br><span class="line">    NUMA node: 0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">Or you can find the numa infor from udevadm.</span></span><br><span class="line">ubuntu@ubuntu-kvm:~$ sudo udevadm info -ap /sys/class/net/ens1f0 | grep numa</span><br><span class="line">    ATTRS&#123;numa_node&#125;==&quot;0&quot;</span><br><span class="line">    ATTRS&#123;numa_node&#125;==&quot;0&quot;</span><br></pre></td></tr></table></figure><p>If the memory and NICs are all on numa_node 0, that would be more efficient. Please check the serverâ€™s PCI-E slots mapping with the CPU slots.</p><h2 id="3-HugePage-and-Transparent-Hugepage"><a href="#3-HugePage-and-Transparent-Hugepage" class="headerlink" title="(3) HugePage and Transparent Hugepage"></a>(3) HugePage and Transparent Hugepage</h2><p>To check the memory info</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ cat /proc/meminfo | grep Huge</span><br><span class="line">AnonHugePages:    133120 kB</span><br><span class="line">ShmemHugePages:        0 kB</span><br><span class="line">FileHugePages:         0 kB</span><br><span class="line">HugePages_Total:      64</span><br><span class="line">HugePages_Free:       56</span><br><span class="line">HugePages_Rsvd:        0</span><br><span class="line">HugePages_Surp:        0</span><br><span class="line">Hugepagesize:    1048576 kB</span><br><span class="line">Hugetlb:        67108864 kB</span><br></pre></td></tr></table></figure><p>You can change the hugepages on the run timeï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ cat /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages</span><br><span class="line">32</span><br><span class="line">sudo su -     // switch to root user.</span><br><span class="line">root@ubuntu-kvm:~# echo 64 &gt; /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages</span><br><span class="line">root@ubuntu-kvm:~# echo 64 &gt; /sys/devices/system/node/node1/hugepages/hugepages-1048576kB/nr_hugepages</span><br></pre></td></tr></table></figure><p>Check and configure the transparent_hugepage:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-kvm:~# echo always &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line">cat /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line">[always] madvise never</span><br></pre></td></tr></table></figure><h2 id="4-vCPU-Pinning"><a href="#4-vCPU-Pinning" class="headerlink" title="(4) vCPU Pinning"></a>(4) vCPU Pinning</h2><p>vCPU pinning can improve the cache meet rate and improve the performance.<br>You can check the vcpu pinning.<br><strong>virsh vcpuinfo csr1kv-1</strong></p><h2 id="5-Edit-the-XML-file-of-the-CSR1KV"><a href="#5-Edit-the-XML-file-of-the-CSR1KV" class="headerlink" title="(5) Edit the XML file of the CSR1KV"></a>(5) Edit the XML file of the CSR1KV</h2><p>Run virsh edit csr1kv-1 to edit the parameters.<br>Please pay attention to the following texts, other parameters might be different.</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">memoryBacking</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">hugepages</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">page</span> <span class="attr">size</span>=<span class="string">&#x27;1048576&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">hugepages</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">locked</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">nosharepages</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">memoryBacking</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">vcpu</span> <span class="attr">placement</span>=<span class="string">&#x27;static&#x27;</span>&gt;</span>8<span class="tag">&lt;/<span class="name">vcpu</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">cputune</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;3&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;4&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;5&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;5&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;6&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;6&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;7&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;7&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;8&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">emulatorpin</span> <span class="attr">cpuset</span>=<span class="string">&#x27;45-52&#x27;</span>/&gt;</span> <span class="comment">&lt;!-- If Hyper-threading were enabled --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cputune</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">numatune</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">memory</span> <span class="attr">mode</span>=<span class="string">&#x27;strict&#x27;</span> <span class="attr">nodeset</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">numatune</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">cpu</span> <span class="attr">mode</span>=<span class="string">&#x27;host-passthrough&#x27;</span> <span class="attr">check</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">memballoon</span> <span class="attr">model</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>Please note that, if hyper-threading is enabled in BIOS setting, the parameter â€œemulatorpinâ€ should be set, the cpuset are from the â€œvirsh capabilitiesâ€, for example, siblings=â€™1,45â€™. When the core 1 is pinned, core 45 should be set in emulatorpin.</p><p>From the guide <a href="https://libvirt.org/formatdomain.html">https://libvirt.org/formatdomain.html</a> and <a href="https://libvirt.org/kbase/kvm-realtime.html">https://libvirt.org/kbase/kvm-realtime.html</a> we set the CPU and memory tuning parameters as the highlighted text.</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">domain</span> <span class="attr">type</span>=<span class="string">&#x27;kvm&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>csr1kv-1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>83f90c1c-f0ea-4298-bcdf-3d676de2aeb4<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">metadata</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">libosinfo:libosinfo</span> <span class="attr">xmlns:libosinfo</span>=<span class="string">&quot;http://libosinfo.org/xmlns/libvirt/domain/1.0&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">libosinfo:os</span> <span class="attr">id</span>=<span class="string">&quot;http://centos.org/centos/7.0&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">libosinfo:libosinfo</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">metadata</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">memory</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>&gt;</span>8388608<span class="tag">&lt;/<span class="name">memory</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">currentMemory</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>&gt;</span>8388608<span class="tag">&lt;/<span class="name">currentMemory</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">memoryBacking</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hugepages</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">page</span> <span class="attr">size</span>=<span class="string">&#x27;1048576&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">hugepages</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">locked</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">nosharepages</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">memoryBacking</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpu</span> <span class="attr">placement</span>=<span class="string">&#x27;static&#x27;</span>&gt;</span>8<span class="tag">&lt;/<span class="name">vcpu</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">cputune</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;3&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;4&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;5&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;5&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;6&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;6&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;7&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;7&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;8&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">emulatorpin</span> <span class="attr">cpuset</span>=<span class="string">&#x27;45-52&#x27;</span>/&gt;</span> <span class="comment">&lt;!-- If Hyper-threading were enabled --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">cputune</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">numatune</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">memory</span> <span class="attr">mode</span>=<span class="string">&#x27;strict&#x27;</span> <span class="attr">nodeset</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">numatune</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">os</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span> <span class="attr">arch</span>=<span class="string">&#x27;x86_64&#x27;</span> <span class="attr">machine</span>=<span class="string">&#x27;pc-q35-4.2&#x27;</span>&gt;</span>hvm<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">boot</span> <span class="attr">dev</span>=<span class="string">&#x27;hd&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">os</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">features</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">acpi</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">apic</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vmport</span> <span class="attr">state</span>=<span class="string">&#x27;off&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">features</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">cpu</span> <span class="attr">mode</span>=<span class="string">&#x27;host-passthrough&#x27;</span> <span class="attr">check</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">clock</span> <span class="attr">offset</span>=<span class="string">&#x27;utc&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">timer</span> <span class="attr">name</span>=<span class="string">&#x27;rtc&#x27;</span> <span class="attr">tickpolicy</span>=<span class="string">&#x27;catchup&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">timer</span> <span class="attr">name</span>=<span class="string">&#x27;pit&#x27;</span> <span class="attr">tickpolicy</span>=<span class="string">&#x27;delay&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">timer</span> <span class="attr">name</span>=<span class="string">&#x27;hpet&#x27;</span> <span class="attr">present</span>=<span class="string">&#x27;no&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">clock</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">on_poweroff</span>&gt;</span>destroy<span class="tag">&lt;/<span class="name">on_poweroff</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">on_reboot</span>&gt;</span>restart<span class="tag">&lt;/<span class="name">on_reboot</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">on_crash</span>&gt;</span>destroy<span class="tag">&lt;/<span class="name">on_crash</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">pm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">suspend-to-mem</span> <span class="attr">enabled</span>=<span class="string">&#x27;no&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">suspend-to-disk</span> <span class="attr">enabled</span>=<span class="string">&#x27;no&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">pm</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">devices</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">emulator</span>&gt;</span>/usr/bin/qemu-system-x86_64<span class="tag">&lt;/<span class="name">emulator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;file&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;disk&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;qcow2&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">&#x27;/var/lib/libvirt/images/csr1000v-universalk9.17.02.01v.qcow2&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;vda&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x05&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;qemu-xhci&#x27;</span> <span class="attr">ports</span>=<span class="string">&#x27;15&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x03&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;sata&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x1f&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pcie-root&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">chassis</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0x10&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span> <span class="attr">multifunction</span>=<span class="string">&#x27;on&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">chassis</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0x11&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">chassis</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0x12&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">chassis</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0x13&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x3&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;5&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">chassis</span>=<span class="string">&#x27;5&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0x14&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x4&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;6&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">chassis</span>=<span class="string">&#x27;6&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0x15&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x5&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;7&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">chassis</span>=<span class="string">&#x27;7&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0x16&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x6&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;8&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">chassis</span>=<span class="string">&#x27;8&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0x17&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x7&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;virtio-serial&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x04&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;direct&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;52:54:00:69:ec:73&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">dev</span>=<span class="string">&#x27;eno1&#x27;</span> <span class="attr">mode</span>=<span class="string">&#x27;bridge&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x01&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;network&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;52:54:00:0b:a5:2e&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">network</span>=<span class="string">&#x27;ens1f0_sriov_pool&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;network&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;52:54:00:bd:9f:54&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">network</span>=<span class="string">&#x27;ens1f1_sriov_pool&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x08&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">serial</span> <span class="attr">type</span>=<span class="string">&#x27;pty&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;isa-serial&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;isa-serial&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">serial</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">console</span> <span class="attr">type</span>=<span class="string">&#x27;pty&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;serial&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">console</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">channel</span> <span class="attr">type</span>=<span class="string">&#x27;unix&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;org.qemu.guest_agent.0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;virtio-serial&#x27;</span> <span class="attr">controller</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">channel</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">channel</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;com.redhat.spice.0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;virtio-serial&#x27;</span> <span class="attr">controller</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">channel</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;mouse&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;ps2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;keyboard&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;ps2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">graphics</span> <span class="attr">type</span>=<span class="string">&#x27;spice&#x27;</span> <span class="attr">autoport</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">listen</span> <span class="attr">type</span>=<span class="string">&#x27;address&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">image</span> <span class="attr">compression</span>=<span class="string">&#x27;off&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">graphics</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">video</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;qxl&#x27;</span> <span class="attr">ram</span>=<span class="string">&#x27;65536&#x27;</span> <span class="attr">vram</span>=<span class="string">&#x27;65536&#x27;</span> <span class="attr">vgamem</span>=<span class="string">&#x27;16384&#x27;</span> <span class="attr">heads</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">primary</span>=<span class="string">&#x27;yes&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x01&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;3&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">memballoon</span> <span class="attr">model</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">devices</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br></pre></td></tr></table></figure><p>The parameters are from <a href="https://www.cisco.com/c/en/us/td/docs/routers/csr1000/software/configuration/b_CSR1000v_Configuration_Guide/b_CSR1000v_Configuration_Guide_chapter_0101.html#con_1313827">Cisco CSR 1000v and Cisco ISRv Software Configuration Guide</a><br>After you install the CSR1000v, and edit the XML file, you can run virsh to create the csr1kv.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/libvirtd/qemu</span><br><span class="line">virsh define csr1kv-1.xml</span><br><span class="line">virsh start csr1kv-1</span><br></pre></td></tr></table></figure><h2 id="6-Check-CSR1000vâ€™s-tunning"><a href="#6-Check-CSR1000vâ€™s-tunning" class="headerlink" title="(6) Check CSR1000vâ€™s tunning"></a>(6) Check CSR1000vâ€™s tunning</h2><p>ubuntu@ubuntu-kvm:/etc/libvirt/qemu$ virsh list</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"> Id   Name       State</span><br><span class="line">--------------------------</span><br><span class="line"></span><br><span class="line"> 1    csr1kv-1   running</span><br><span class="line"></span><br><span class="line">ubuntu@ubuntu-kvm:/etc/libvirt/qemu$ virsh vcpuinfo 1</span><br><span class="line">VCPU:           0</span><br><span class="line">CPU:            1</span><br><span class="line">State:          running</span><br><span class="line">CPU time:       167.0s</span><br><span class="line">CPU Affinity:   -y--------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">VCPU:           1</span><br><span class="line">CPU:            2</span><br><span class="line">State:          running</span><br><span class="line">CPU time:       193.3s</span><br><span class="line">CPU Affinity:   --y-------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">VCPU:           2</span><br><span class="line">CPU:            3</span><br><span class="line">State:          running</span><br><span class="line">CPU time:       152.5s</span><br><span class="line">CPU Affinity:   ---y------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">VCPU:           3</span><br><span class="line">CPU:            4</span><br><span class="line">State:          running</span><br><span class="line">CPU time:       174.3s</span><br><span class="line">CPU Affinity:   ----y-----------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">VCPU:           4</span><br><span class="line">CPU:            5</span><br><span class="line">State:          running</span><br><span class="line">CPU time:       260.6s</span><br><span class="line">CPU Affinity:   -----y----------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">VCPU:           5</span><br><span class="line">CPU:            6</span><br><span class="line">State:          running</span><br><span class="line">CPU time:       386.0s</span><br><span class="line">CPU Affinity:   ------y---------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">VCPU:           6</span><br><span class="line">CPU:            7</span><br><span class="line">State:          running</span><br><span class="line">CPU time:       2189.9s</span><br><span class="line">CPU Affinity:   -------y--------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">VCPU:           7</span><br><span class="line">CPU:            8</span><br><span class="line">State:          running</span><br><span class="line">CPU time:       2192.2s</span><br><span class="line">CPU Affinity:   --------y-------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure><p>From the above outputs, we can find that the vCPUa are pinned to NO. 1 to 8 CPU cores.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-kvm:~$ sudo numastat -c qemu</span><br><span class="line">Per-node process memory usage (in MBs)</span><br><span class="line">PID              Node 0 Node 1 Total</span><br><span class="line"></span><br><span class="line">---------------  ------ ------ -----</span><br><span class="line"></span><br><span class="line">4391 (qemu-syste   8373      0  8373</span><br><span class="line">5891 (sudo)           4      1     5</span><br><span class="line"></span><br><span class="line">---------------  ------ ------ -----</span><br><span class="line"></span><br><span class="line">Total              8377      1  8377</span><br><span class="line"></span><br><span class="line">ubuntu@ubuntu-kvm:~$ sudo numastat -p 4391</span><br><span class="line">Per-node process memory usage (in MBs) for PID 4391 (qemu-system-x86)</span><br><span class="line">                           Node 0          Node 1           Total</span><br><span class="line">                  --------------- --------------- ---------------</span><br><span class="line">Huge                      8192.00            0.00         8192.00</span><br><span class="line">Heap                        10.00            0.00           10.00</span><br><span class="line">Stack                        0.03            0.00            0.03</span><br><span class="line">Private                    170.70            0.15          170.85</span><br><span class="line"></span><br><span class="line">----------------  --------------- --------------- ---------------</span><br><span class="line"></span><br><span class="line">Total                     8372.73            0.16         8372.88</span><br></pre></td></tr></table></figure><p>From the above outputs, the csr1kv-1 are using the memories from node 0.</p><h2 id="7-Check-the-vNIC-in-CSR1KV"><a href="#7-Check-the-vNIC-in-CSR1KV" class="headerlink" title="(7) Check the vNIC in CSR1KV"></a>(7) Check the vNIC in CSR1KV</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">csr1kv-1#show platform software vnic-if interface-mapping</span><br><span class="line">-------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"> Interface Name        Driver Name         Mac Addr</span><br><span class="line">-------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"> GigabitEthernet3       net_i40e_vf        5254.00bd.9f54</span><br><span class="line"> GigabitEthernet2       net_i40e_vf        5254.000b.a52e</span><br><span class="line"> GigabitEthernet1       net_virtio         5254.0069.ec73</span><br></pre></td></tr></table></figure><p>The Driver Name net_i40e_vf indicates that the vNIC is a VF from the SR-IOV pool.</p><h1 id="CSR-1000v-initial-configuration-and-Smart-License-registration"><a href="#CSR-1000v-initial-configuration-and-Smart-License-registration" class="headerlink" title="CSR 1000v initial configuration and Smart License registration"></a>CSR 1000v initial configuration and Smart License registration</h1><h2 id="1-CSR-1000v-initial-config-example"><a href="#1-CSR-1000v-initial-config-example" class="headerlink" title="(1) CSR 1000v initial config example"></a>(1) CSR 1000v initial config example</h2><p>Part of the configuration:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">CSR1000v-1#show sdwan running-config</span><br><span class="line">system</span><br><span class="line"> system-ip             1.1.10.1</span><br><span class="line"> site-id               101</span><br><span class="line"> sp-organization-name  CiscoBJ</span><br><span class="line"> organization-name     CiscoBJ</span><br><span class="line"> vbond 10.75.58.51 port 12346</span><br><span class="line">!</span><br><span class="line">hostname CSR1000v-1</span><br><span class="line">username admin privilege 15 secret 9 $9$4&#x2F;QL2V2K4&#x2F;6H1k$XUmRNf.T7t3KDOj&#x2F;FmoNexpEypCxr482dExXHDnohSI</span><br><span class="line">ip name-server 64.104.123.245</span><br><span class="line">ip route 0.0.0.0 0.0.0.0 10.75.59.1</span><br><span class="line"></span><br><span class="line">interface GigabitEthernet1</span><br><span class="line"> no shutdown</span><br><span class="line"> arp timeout 1200</span><br><span class="line"> ip address 10.75.59.35 255.255.255.0</span><br><span class="line"> no ip redirects</span><br><span class="line"> ip mtu    1500</span><br><span class="line"> mtu 1500</span><br><span class="line"> negotiation auto</span><br><span class="line">exit</span><br><span class="line"></span><br><span class="line">interface Tunnel1</span><br><span class="line"> no shutdown</span><br><span class="line"> ip unnumbered GigabitEthernet1</span><br><span class="line"> no ip redirects</span><br><span class="line"> ipv6 unnumbered GigabitEthernet1</span><br><span class="line"> no ipv6 redirects</span><br><span class="line"> tunnel source GigabitEthernet1</span><br><span class="line"> tunnel mode sdwan</span><br><span class="line">exit</span><br><span class="line"></span><br><span class="line">clock timezone CST 8 0</span><br><span class="line">ntp server x.x.x.x version 4</span><br><span class="line"></span><br><span class="line">sdwan</span><br><span class="line"> interface GigabitEthernet1</span><br><span class="line">  tunnel-interface</span><br><span class="line">   encapsulation ipsec</span><br><span class="line">   allow-service sshd</span><br><span class="line">  exit</span><br></pre></td></tr></table></figure><h2 id="2-Commands-to-check-the-status"><a href="#2-Commands-to-check-the-status" class="headerlink" title="(2) Commands to check the status"></a>(2) Commands to check the status</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">show sdwan control local-properties</span><br><span class="line">show sdwan control connections</span><br><span class="line">show sdwan control connection-history</span><br><span class="line">show sdwan running-config</span><br><span class="line">show sdwan bfd sessions</span><br><span class="line">show sdwan omp peers</span><br><span class="line">show sdwan omp routes</span><br></pre></td></tr></table></figure><h2 id="3-CSR-1000v-Smart-License-Registration"><a href="#3-CSR-1000v-Smart-License-Registration" class="headerlink" title="(3) CSR 1000v Smart License Registration"></a>(3) CSR 1000v Smart License Registration</h2><p>Before Smart License registration, you need ï¼š</p><ol><li>CSR 1000vâ€™s control connections are upï¼›</li><li>Configure ip http client source-interface GigabitEthernet2</li><li>If the version is 16.12.x and bellow, you need to allow service all<br><code>sdwan interface GigabitEthernet2 tunnel-interface allow-service all </code><br>In the 17.2.x and above versions, there is an allow-service https</li><li>CSR 1000v can access URLï¼š<a href="https://tools.cisco.com/its/service/oddce/services/DDCEService">https://tools.cisco.com/its/service/oddce/services/DDCEService</a><br>The command license smart register idtoken xxxxxx will do the registration.<br>You can find the idtoken from your Smart Account smart license inventory.<br>show license status to check the status.</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CSR1000v-1#show platform hardware throughput level</span><br><span class="line">The current throughput level is 200000000 kb&#x2F;s</span><br></pre></td></tr></table></figure><h1 id="Performances-and-limitations"><a href="#Performances-and-limitations" class="headerlink" title="Performances and limitations"></a>Performances and limitations</h1><h2 id="1-The-performance-of-the-SR-IOV"><a href="#1-The-performance-of-the-SR-IOV" class="headerlink" title="(1) The performance of the SR-IOV"></a>(1) The performance of the SR-IOV</h2><p>A performance test was done after the SR-IOV setup, the CSR1KV was configured as 8vCPU and 8G Memory, the packet drop rate was 0%.</p><table><thead><tr><th>Packet Site</th><th>SDWAN Performance (Mbps)</th><th>CEF Performance (Mbps)</th></tr></thead><tbody><tr><td>128Bytes</td><td>800</td><td>2843.75</td></tr><tr><td>256Bytes</td><td>1431.26</td><td>6500.00</td></tr><tr><td>512Bytes</td><td>2581.26</td><td>10578.13</td></tr><tr><td>1024Bytes</td><td>3731.26</td><td>15500.00</td></tr><tr><td>1400Bytes</td><td>4306.26</td><td>18171.88</td></tr></tbody></table><img src="/csr1kv-kvm-Ubuntu20-04-md/line-chart.png" class="" title="Performance Line Chart"><p>Note: <strong>These test results are not to represent the official performance data. Different servers and network cards may have different test results. The above data is for demo only.</strong></p><h2 id="2-The-limitation-of-the-SR-IOV"><a href="#2-The-limitation-of-the-SR-IOV" class="headerlink" title="(2) The limitation of the SR-IOV"></a>(2) The limitation of the SR-IOV</h2><p>The main limitation of the SR-IOV is the number of VLANs on each VF, the maximum VLAN of an VF is limited to 63 in ixgbevf.<br>So, the active number of sub-interfaces on an interface of the CSR1KV that uses the SRIOV VFs is limited to 63.<br>There is some notes in the Cisco CSR 1000v and Cisco ISRv Software Configuration Guide:</p><blockquote><p>SR-IOV (ixgbevf)<br>Maximum VLANs: The maximum number of VLANs supported on PF is 64. Together, all VFs can have a total of 64 VLANs. (Intel limitation.)</p><p>SR-IOV (i40evf)<br>Maximum VLANs: The maximum number of VLANs supported on PF is 512. Together, all VFs can have a total of 512 VLANs. (Intel limitation.) Per-VF resources are managed by the PF (host) device driver.</p></blockquote><h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/performance_tuning_guide/index">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/performance_tuning_guide/index</a></p><p><a href="https://computingforgeeks.com/how-to-create-and-configure-bridge-networking-for-kvm-in-linux/">https://computingforgeeks.com/how-to-create-and-configure-bridge-networking-for-kvm-in-linux/</a></p><p><a href="https://software.intel.com/content/www/us/en/develop/articles/configure-sr-iov-network-virtual-functions-in-linux-kvm.html">https://software.intel.com/content/www/us/en/develop/articles/configure-sr-iov-network-virtual-functions-in-linux-kvm.html</a></p><p><a href="https://linuxconfig.org/install-and-set-up-kvm-on-ubuntu-20-04-focal-fossa-linux">https://linuxconfig.org/install-and-set-up-kvm-on-ubuntu-20-04-focal-fossa-linux</a></p><p><a href="https://kifarunix.com/how-to-fix-qemu-kvm-not-connected-error-on-ubuntu-20-04/">https://kifarunix.com/how-to-fix-qemu-kvm-not-connected-error-on-ubuntu-20-04/</a></p><p><a href="https://linuxconfig.org/how-to-disable-apparmor-on-ubuntu-20-04-focal-fossa-linux">https://linuxconfig.org/how-to-disable-apparmor-on-ubuntu-20-04-focal-fossa-linux</a></p><p><strong>CSR1000v SD-WAN Installation on KVM</strong> by Jean-Marc Barozet</p><h1 id="Scripts-and-XML-Example-Files"><a href="#Scripts-and-XML-Example-Files" class="headerlink" title="Scripts and XML Example Files"></a>Scripts and XML Example Files</h1><ol><li><a href="https://raw.githubusercontent.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/main/kvm/1.2-install-ubuntu-kvm.sh">Ubuntu and KVM installation and setting</a></li><li><a href="https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/1.3-nic-settings.sh">NIC Settings with nmcli</a></li><li><a href="https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/2.1-check-nic-sriov.sh">Check NIC SRIOV Capabilities</a></li><li><a href="https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/2.2-change-grub.sh">GRUB Settings</a></li><li><a href="https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/2.3-sriov-setting.sh">SRIOV Settings</a></li><li><a href="https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/2.4-check-vfs.sh">Check VFs</a></li><li><a href="https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/3.0-create-sriov-pool.sh">Create SRIOV Adapter Pool</a></li><li><a href="https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/4.0-kvm-tuning.sh">KVM Tuning</a></li><li><a href="https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/4.1-check-csr1kv.sh">Check CSR1000v Tuning</a></li><li><a href="https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/ens1f0_sriov_pool.xml">ens1f0_sriov_pool.xml</a></li><li><a href="https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/csr1kv-1.xml">csr1kv-1.xml</a></li></ol>]]></content>
    
    
    <summary type="html">This guide provides the steps on how to install CSR1000v/Catalyst 8000v on KVM, the setting of SRIOV and KVM tuning.</summary>
    
    
    
    
    <category term="CSR1000v" scheme="https://weiborao.github.io/tags/CSR1000v/"/>
    
    <category term="KVM" scheme="https://weiborao.github.io/tags/KVM/"/>
    
    <category term="SRIOV" scheme="https://weiborao.github.io/tags/SRIOV/"/>
    
    <category term="NetworkManager" scheme="https://weiborao.github.io/tags/NetworkManager/"/>
    
  </entry>
  
  <entry>
    <title>CSR 1000v KVM SRIOV CentOS 7å®‰è£…è®¾ç½®æŒ‡å—</title>
    <link href="https://weiborao.github.io/csr1kv-kvm-CentOS7.html"/>
    <id>https://weiborao.github.io/csr1kv-kvm-CentOS7.html</id>
    <published>2021-02-03T05:58:32.000Z</published>
    <updated>2021-02-05T05:57:29.431Z</updated>
    
    <content type="html"><![CDATA[<p>ä½œè€…ï¼šRao Weibo</p><p>ç‰ˆæœ¬ï¼š1.0</p><p>æ›´æ–°æ—¥æœŸï¼š20210203</p><p>æœ¬æ–‡æä¾›åœ¨ CentOS 7 ç‰ˆæœ¬ä¸Šå®‰è£… KVMï¼Œå¹¶å®‰è£…å’Œè®¾ç½® CSR 1000v/Catalyst 8000v çš„æŒ‡å—ï¼Œå†…å®¹åŒ…æ‹¬ SRIOVï¼ŒKVM è°ƒä¼˜ä»¥åŠ CSR1KV åˆå§‹åŒ–é…ç½®ç­‰å†…å®¹ã€‚</p><h1 id="CentOS7-å®‰è£…åŠè®¾ç½®"><a href="#CentOS7-å®‰è£…åŠè®¾ç½®" class="headerlink" title="CentOS7 å®‰è£…åŠè®¾ç½®"></a>CentOS7 å®‰è£…åŠè®¾ç½®</h1><h2 id="ï¼ˆ1ï¼‰BIOS-è®¾ç½®å»ºè®®"><a href="#ï¼ˆ1ï¼‰BIOS-è®¾ç½®å»ºè®®" class="headerlink" title="ï¼ˆ1ï¼‰BIOS è®¾ç½®å»ºè®®"></a>ï¼ˆ1ï¼‰BIOS è®¾ç½®å»ºè®®</h2><table><thead><tr><th align="left">Configuration</th><th align="left">Recommended Setting</th></tr></thead><tbody><tr><td align="left">Intel Hyper-Threading Technology</td><td align="left">Disabled</td></tr><tr><td align="left">Number of Enable Cores</td><td align="left">ALL</td></tr><tr><td align="left">Execute Disable</td><td align="left">Enabled</td></tr><tr><td align="left">Intel VT</td><td align="left">Enabled</td></tr><tr><td align="left">Intel VT-D</td><td align="left">Enabled</td></tr><tr><td align="left">Intel VT-D coherency support</td><td align="left">Enabled</td></tr><tr><td align="left">Intel VT-D ATS support</td><td align="left">Enabled</td></tr><tr><td align="left">CPU Performance</td><td align="left">High throughput</td></tr><tr><td align="left">Hardware Perfetcher</td><td align="left">Disabled</td></tr><tr><td align="left">Adjacent Cache Line Prefetcher</td><td align="left">Disabled</td></tr><tr><td align="left">DCU Streamer Prefetch</td><td align="left">Disable</td></tr><tr><td align="left">Power Technology</td><td align="left">Custom</td></tr><tr><td align="left">Enhanced Intel Speedstep Technology</td><td align="left">Disabled</td></tr><tr><td align="left">Intel Turbo Boost Technology</td><td align="left">Enabled</td></tr><tr><td align="left">Processor Power State C6</td><td align="left">Disabled</td></tr><tr><td align="left">Processor Power State C1 Enhanced</td><td align="left">Disabled</td></tr><tr><td align="left">Frequency Poor Override</td><td align="left">Enabled</td></tr><tr><td align="left">P-State Coordination</td><td align="left">HW_ALL</td></tr><tr><td align="left">Energy Performance</td><td align="left">Performance</td></tr></tbody></table><p>ä»¥ä¸Šå»ºè®®æ¥è‡ª CSR 1000v çš„å®‰è£…æŒ‡å—ã€‚</p><h2 id="ï¼ˆ2ï¼‰CentOS-7-çš„å®‰è£…"><a href="#ï¼ˆ2ï¼‰CentOS-7-çš„å®‰è£…" class="headerlink" title="ï¼ˆ2ï¼‰CentOS 7 çš„å®‰è£…"></a>ï¼ˆ2ï¼‰CentOS 7 çš„å®‰è£…</h2><p>åœ¨å®‰è£…çš„æ—¶å€™é€‰æ‹©</p><ul><li>Server with GUI</li><li>Virtualization Client</li><li>Virtualization Hypervisor</li><li>Virtualization Tools</li></ul><p>å¯åŠ¨å®Œæ¯•ä»¥åå…³é—­ selinuxï¼Œé‡å¯ç”Ÿæ•ˆã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config</span><br><span class="line"></span><br><span class="line">getenforce//ç»“æœä¸ºï¼šEnforcingï¼ˆå¼€å¯çŠ¶æ€ï¼‰disabled(å…³é—­çŠ¶æ€)</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å®‰è£…å®Œåï¼ŒSSHç™»å½•å¯èƒ½æ˜¾ç¤ºä¸­æ–‡ï¼Œå¯ä¿®æ”¹ .bash_profile</span></span><br><span class="line"></span><br><span class="line">LANG=&quot;en_US.UTF-8&quot;</span><br><span class="line"></span><br><span class="line">export LANG</span><br><span class="line"></span><br><span class="line">source .bash_profile</span><br><span class="line"></span><br><span class="line">egrep -o &#x27;(vmx|svm)&#x27; /proc/cpuinfo | sort | uniq</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ³¨ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œéœ€è¦åœ¨æœåŠ¡å™¨è¿æ¥çš„äº¤æ¢æœºä»¥åŠå‡ºå£é˜²ç«å¢™ä¸Šåšå¥½å®‰å…¨ç­–ç•¥ã€‚</span></span><br><span class="line"></span><br><span class="line">systemctl stop firewalld</span><br><span class="line"></span><br><span class="line">systemctl disable firewalld</span><br></pre></td></tr></table></figure><p>æœ¬æ–‡æ¡£é‡‡ç”¨ NetworkManager é…ç½®ï¼Œæ•…åœ¨æ­¤å¹¶ä¸åœç”¨ NetworkManagerã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/sysctl.conf</span><br><span class="line"></span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line"></span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 0</span><br><span class="line"></span><br><span class="line">net.bridge.bridge-nf-call-iptables = 0</span><br><span class="line"></span><br><span class="line">net.bridge.bridge-nf-call-arptables = 0</span><br></pre></td></tr></table></figure><p>æ£€æŸ¥ KVM ç»„ä»¶ç‰ˆæœ¬ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# libvirtd -V</span><br><span class="line"></span><br><span class="line">libvirtd (libvirt) 4.5.0</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# /usr/libexec/qemu-kvm --version</span><br><span class="line"></span><br><span class="line">QEMU emulator version 1.5.3 (qemu-kvm-1.5.3-173.el7_8.3), Copyright (c) 2003-2008 Fabrice Bellard</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# virt-manager --version</span><br><span class="line"></span><br><span class="line">1.5.0</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# modinfo kvm-intel</span><br><span class="line"></span><br><span class="line">filename:       /lib/modules/3.10.0-1127.18.2.el7.x86_64/kernel/arch/x86/kvm/kvm-intel.ko.xz</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# modinfo ixgbevf</span><br><span class="line"></span><br><span class="line">filename:       /lib/modules/3.10.0-1127.18.2.el7.x86_64/kernel/drivers/net/ethernet/intel/ixgbevf/ixgbevf.ko.xz</span><br><span class="line"></span><br><span class="line">version:        4.1.0-k-rh7.7</span><br></pre></td></tr></table></figure><h2 id="ï¼ˆ3ï¼‰åˆ›å»ºæœ¬åœ°-Yum-æºï¼ˆå¯é€‰ï¼‰"><a href="#ï¼ˆ3ï¼‰åˆ›å»ºæœ¬åœ°-Yum-æºï¼ˆå¯é€‰ï¼‰" class="headerlink" title="ï¼ˆ3ï¼‰åˆ›å»ºæœ¬åœ° Yum æºï¼ˆå¯é€‰ï¼‰"></a>ï¼ˆ3ï¼‰åˆ›å»ºæœ¬åœ° Yum æºï¼ˆå¯é€‰ï¼‰</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1ã€å¤‡ä»½æœ¬åœ°/etc/yum.repos.d ç›®å½•ä¸‹çš„yumæº</span></span><br><span class="line"></span><br><span class="line">cd /etc/yum.repos.d/</span><br><span class="line"></span><br><span class="line">mkdir bak</span><br><span class="line"></span><br><span class="line">mv C* bak/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2ã€ä¸Šä¼ CentOS-7-x86_64-Everything-2009.isoé•œåƒåˆ°/opt</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3ã€æŒ‚è½½é•œåƒ</span></span><br><span class="line"></span><br><span class="line">mkdir -p /media/cdrom</span><br><span class="line"></span><br><span class="line">mount -t iso9660 -o loop /opt/CentOS-7-x86_64-Everything-2009.iso /media/cdrom/</span><br><span class="line"></span><br><span class="line">mount//æŸ¥çœ‹æŒ‚è½½ä¿¡æ¯</span><br><span class="line"></span><br><span class="line">df -h</span><br><span class="line"></span><br><span class="line">vi /etc/fstab</span><br><span class="line"></span><br><span class="line">/opt/CentOS-7-x86_64-Everything-2009.iso    /media/cdrom    iso9660 loop 0 0</span><br><span class="line"></span><br><span class="line">tail -1 /etc/fstab//æŸ¥çœ‹æ˜¯å¦å†™å…¥/etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 4ã€é…ç½®æœ¬åœ°yumæº</span></span><br><span class="line"></span><br><span class="line">cd /etc/yum.repos.d/</span><br><span class="line"></span><br><span class="line">vi local.repo</span><br><span class="line"></span><br><span class="line">[local]</span><br><span class="line"></span><br><span class="line">name=local</span><br><span class="line"></span><br><span class="line">baseurl=file:///media/cdrom   //å‰é¢çš„file://æ˜¯åè®®,åé¢çš„/media/cdromæ˜¯å…‰ç›˜æŒ‚è½½ç‚¹</span><br><span class="line"></span><br><span class="line">gpgcheck=0//1ä½¿ç”¨å…¬é’¥éªŒè¯rpmåŒ…çš„æ­£ç¡®æ€§,0ä¸éªŒè¯</span><br><span class="line"></span><br><span class="line">enabled=1//1å¯ç”¨yumæº,0ç¦ç”¨yumæº</span><br><span class="line"></span><br><span class="line">yum install -y numactl telnet</span><br></pre></td></tr></table></figure><p>è¿è¡Œ virt-manager å¯åŠ¨å›¾å½¢åŒ–ç•Œé¢ã€‚</p><p>å¦‚æœå¯¹ virsh CLI å‘½ä»¤ç†Ÿæ‚‰ï¼Œå¯ä»¥ä½¿ç”¨ virsh å‘½ä»¤åˆ›å»ºè™šæ‹Ÿæœºã€‚</p><h2 id="ï¼ˆ4ï¼‰æœåŠ¡å™¨ç½‘å¡é…ç½®â€”NetworkManager-é…ç½®"><a href="#ï¼ˆ4ï¼‰æœåŠ¡å™¨ç½‘å¡é…ç½®â€”NetworkManager-é…ç½®" class="headerlink" title="ï¼ˆ4ï¼‰æœåŠ¡å™¨ç½‘å¡é…ç½®â€”NetworkManager é…ç½®"></a>ï¼ˆ4ï¼‰æœåŠ¡å™¨ç½‘å¡é…ç½®â€”NetworkManager é…ç½®</h2><p>åœ¨ç»ˆç«¯ç•Œé¢ï¼Œå¯ä»¥é€šè¿‡ nmtui æ‰“å¼€å›¾å½¢åŒ–ç•Œé¢è¿›è¡Œè®¾ç½®ï¼›ä»¥ä¸‹ä½¿ç”¨ nmcli è¿›è¡Œè®¾ç½®ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection add con-name eno1 type ethernet autoconnect yes ifname eno1</span><br><span class="line"></span><br><span class="line">nmcli connection modify eno1 ipv4.method manual ipv4.addresses 10.75.58.43/24 ipv4.gateway 10.75.58.1 ipv4.dns 64.104.123.245</span><br><span class="line"></span><br><span class="line">nmcli connection up eno1</span><br><span class="line"></span><br><span class="line">nmcli connection show eno1</span><br><span class="line"></span><br><span class="line">ping 10.75.58.1</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°å‘½ä»¤å®Œæˆåï¼Œåœ¨/etc/sysconfig/network-scripts ä¸­ä¼šç”Ÿæˆç½‘å¡çš„ ifcfg é…ç½®æ–‡ä»¶ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/sysconfig/network-scripts/ifcfg-eno1</span><br><span class="line"></span><br><span class="line">HWADDR=70:7D:B9:59:5B:AE</span><br><span class="line"></span><br><span class="line">TYPE=Ethernet</span><br><span class="line"></span><br><span class="line">PROXY_METHOD=none</span><br><span class="line"></span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line"></span><br><span class="line">BOOTPROTO=none</span><br><span class="line"></span><br><span class="line">IPADDR=10.75.58.43</span><br><span class="line"></span><br><span class="line">PREFIX=24</span><br><span class="line"></span><br><span class="line">GATEWAY=10.75.58.1</span><br><span class="line"></span><br><span class="line">DNS1=64.104.123.245</span><br><span class="line"></span><br><span class="line">DEFROUTE=yes</span><br><span class="line"></span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line"></span><br><span class="line">IPV6INIT=yes</span><br><span class="line"></span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line"></span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line"></span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line"></span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line"></span><br><span class="line">NAME=eno1</span><br><span class="line"></span><br><span class="line">UUID=2a1c8b39-7f44-321b-a65f-a93e70ab0616</span><br><span class="line"></span><br><span class="line">ONBOOT=yes</span><br><span class="line"></span><br><span class="line">AUTOCONNECT_PRIORITY=-999</span><br><span class="line"></span><br><span class="line">DEVICE=eno1</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ï¼Œå¯ä»¥å°† network.service åœæ­¢å’Œå…³é—­ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop network</span><br><span class="line"></span><br><span class="line">systemctl disable network</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œå¦‚æœ NetworkManager æœªè®¾ç½®å¦¥å½“ï¼Œæ‰§è¡Œ systemctl stop network åï¼Œä¼šå¯¼è‡´æœåŠ¡å™¨æ— æ³•ç®¡ç†ã€‚</p><p>å‡†å¤‡å¼€å¯ SRIOV çš„ç½‘å¡è®¾ç½®ï¼Œä»¥ eno2 ä¸ºä¾‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection add con-name eno2 <span class="built_in">type</span> ethernet autoconnect yes ifname eno2</span><br><span class="line"></span><br><span class="line">nmcli connection modify eno2 ethernet.mtu 9216 ipv4.method disabled</span><br><span class="line"></span><br><span class="line">nmcli connection up eno2</span><br><span class="line"></span><br><span class="line">nmcli connection show eno2</span><br><span class="line"></span><br><span class="line">ip link show dev eno2</span><br></pre></td></tr></table></figure><p>æ³¨ï¼šä¸Šè¿° MTU å€¼è®¾ç½®ä¸º 9216 æ˜¯å€Ÿé‰´è‡ª Cisco NFVIS å¹³å°ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">CSP5228-1# show pnic-detail mtu</span><br><span class="line"></span><br><span class="line">Name          MTU</span><br><span class="line"></span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">eth0-1        9216</span><br><span class="line"></span><br><span class="line">eth0-2        9216</span><br><span class="line"></span><br><span class="line">eth1-1        9216</span><br><span class="line"></span><br><span class="line">eth1-2        9216</span><br></pre></td></tr></table></figure><h2 id="ï¼ˆ5ï¼‰é…ç½®-Linux-ç½‘æ¡¥-ï¼ˆå¯é€‰ï¼‰"><a href="#ï¼ˆ5ï¼‰é…ç½®-Linux-ç½‘æ¡¥-ï¼ˆå¯é€‰ï¼‰" class="headerlink" title="ï¼ˆ5ï¼‰é…ç½® Linux ç½‘æ¡¥ ï¼ˆå¯é€‰ï¼‰"></a>ï¼ˆ5ï¼‰é…ç½® Linux ç½‘æ¡¥ ï¼ˆå¯é€‰ï¼‰</h2><p>ç½‘æ¡¥ br1 é…ç½®ç¤ºä¾‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection add con-name br1 <span class="built_in">type</span> bridge autoconnect yes ipv4.method disabled ethernet.mtu 9216 ifname br1</span><br><span class="line"></span><br><span class="line">nmcli connection up br1</span><br><span class="line"></span><br><span class="line">ip link show dev br1</span><br></pre></td></tr></table></figure><p>ç½‘æ¡¥ br1 çš„ç‰©ç†ç½‘å¡é…ç½®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection add con-name eno5 <span class="built_in">type</span> ethernet autoconnect yes ifname eno5</span><br><span class="line"></span><br><span class="line">nmcli connection modify eno5 ethernet.mtu 9216 ipv4.method disabled master br1</span><br><span class="line"></span><br><span class="line">nmcli connection up eno5</span><br><span class="line"></span><br><span class="line">ip link show dev eno5</span><br></pre></td></tr></table></figure><p>åˆ›å»º net-br1 ç½‘ç»œ</p><p>[root@centos7 ~]# cat net-br1.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">network</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">name</span>&gt;</span>net-br1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">forward</span> <span class="attr">mode</span>=<span class="string">&quot;bridge&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">name</span>=<span class="string">&quot;br1&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">network</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># virsh net-define net-br1.xml</span></span><br><span class="line"></span><br><span class="line">Network net-br1 defined from net-br1.xml</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># virsh net-start net-br1</span></span><br><span class="line"></span><br><span class="line">Network net-br1 started</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># virsh net-autostart net-br1</span></span><br><span class="line"></span><br><span class="line">Network net-br1 marked as autostarted</span><br></pre></td></tr></table></figure><h1 id="é…ç½®-SR-IOV"><a href="#é…ç½®-SR-IOV" class="headerlink" title="é…ç½® SR-IOV"></a>é…ç½® SR-IOV</h1><h2 id="ï¼ˆ1ï¼‰æ£€æŸ¥ç½‘å¡å¯¹-SR-IOV-çš„æ”¯æŒï¼Œå¹¶é…ç½®ç½‘å¡"><a href="#ï¼ˆ1ï¼‰æ£€æŸ¥ç½‘å¡å¯¹-SR-IOV-çš„æ”¯æŒï¼Œå¹¶é…ç½®ç½‘å¡" class="headerlink" title="ï¼ˆ1ï¼‰æ£€æŸ¥ç½‘å¡å¯¹ SR-IOV çš„æ”¯æŒï¼Œå¹¶é…ç½®ç½‘å¡"></a>ï¼ˆ1ï¼‰æ£€æŸ¥ç½‘å¡å¯¹ SR-IOV çš„æ”¯æŒï¼Œå¹¶é…ç½®ç½‘å¡</h2><p>å¯ä½¿ç”¨ lshw å’Œ lspci æ£€æŸ¥ç½‘å¡å¯¹ SR-IOV çš„æ”¯æŒ</p><p>lshw -c network -businfo</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Bus info          Device      Class          Description</span><br><span class="line"></span><br><span class="line">========================================================</span><br><span class="line"></span><br><span class="line">pci@0000:1d:00.0  eno5        network        VIC Ethernet NIC</span><br><span class="line"></span><br><span class="line">pci@0000:1d:00.1  eno6        network        VIC Ethernet NIC</span><br><span class="line"></span><br><span class="line">pci@0000:1d:00.2  eno7        network        VIC Ethernet NIC</span><br><span class="line"></span><br><span class="line">pci@0000:1d:00.3  eno8        network        VIC Ethernet NIC</span><br><span class="line"></span><br><span class="line">pci@0000:3b:00.0  eno1        network        Ethernet Controller 10G X550T</span><br><span class="line"></span><br><span class="line">pci@0000:3b:00.1  eno2        network        Ethernet Controller 10G X550T</span><br></pre></td></tr></table></figure><p>lspci -vv -s 3b:00.1 | grep -A 5 -i SR-IOV</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Capabilities: [160 v1] Single Root I/O Virtualization (SR-IOV)</span><br><span class="line"></span><br><span class="line">  IOVCap:Migration-, Interrupt Message Number: 000</span><br><span class="line"></span><br><span class="line">IOVCtl:Enable+ Migration- Interrupt- MSE+ ARIHierarchy-</span><br><span class="line"></span><br><span class="line">IOVSta:Migration-</span><br><span class="line"></span><br><span class="line">Initial VFs: 64, Total VFs: 64, Number of VFs: 8, Function Dependency Link: 01</span><br><span class="line"></span><br><span class="line">VF offset: 128, stride: 2, Device ID: 1565</span><br></pre></td></tr></table></figure><h2 id="ï¼ˆ2ï¼‰è®¾ç½®å¯åŠ¨å‚æ•°"><a href="#ï¼ˆ2ï¼‰è®¾ç½®å¯åŠ¨å‚æ•°" class="headerlink" title="ï¼ˆ2ï¼‰è®¾ç½®å¯åŠ¨å‚æ•°"></a>ï¼ˆ2ï¼‰è®¾ç½®å¯åŠ¨å‚æ•°</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/default/grub</span><br><span class="line"></span><br><span class="line">GRUB_CMDLINE_LINUX=&quot;crashkernel=auto spectre_v2=retpoline rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet hugepagesz=1G hugepages=32 default_hugepagesz=1G intel_iommu=on iommu=pt isolcpus=1-8,37-44&quot;</span><br><span class="line"></span><br><span class="line">æ³¨ï¼šé¡µé¢æ•°å­—ä¸è¦è¿‡å¤§ï¼Œä¸ç„¶å¯åŠ¨å¤±è´¥ï¼Œå¦‚æœåç»­ä¸å¤Ÿï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶æ·»åŠ ã€‚</span><br><span class="line"></span><br><span class="line">grub2-mkconfig -o /boot/grub2/grub.cfg</span><br><span class="line"></span><br><span class="line">grub2-mkconfig -o /boot/efi/EFI/centos/grub.cfg</span><br><span class="line"></span><br><span class="line">iommu=pt å‚æ•°æ˜¯å°†SRIOVè®¾å¤‡æ”¯æŒPCI Passthrough</span><br></pre></td></tr></table></figure><p>é‡å¯åéªŒè¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/cmdline |grep intel_iommu=on</span><br><span class="line"></span><br><span class="line">dmesg |grep -e DMAR -e IOMMU</span><br><span class="line"></span><br><span class="line">dmesg | grep -e DMAR -e IOMMU -e AMD-Vi</span><br></pre></td></tr></table></figure><ul><li><strong>default_hugepagesz=1G hugepagesz=1G hugepages=32</strong> å‚æ•°è®¾ç½®ä¸»æœºåœ¨å¯åŠ¨æ—¶åˆ†é… 32 ä¸ª 1GB çš„å†…å­˜å¤§é¡µï¼Œè¿™äº›æ˜¯é™æ€å†…å­˜å¤§é¡µã€‚ CSR 1000v è™šæ‹Ÿæœºå°†è¯•ç”¨è¿™äº›é™æ€å¤§é¡µä»¥è·å¾—æœ€ä¼˜æ€§èƒ½ã€‚</li><li><strong>isolcpus=1-8,37-44</strong> å‚æ•°è®¾ç½®çš„ä½œç”¨æ˜¯éš”ç¦» 1-8ï¼Œ37-44 çš„ CPU æ ¸ï¼Œä½¿å…¶ç‹¬ç«‹äºå†…æ ¸çš„å¹³è¡¡è°ƒåº¦ç®—æ³•ï¼Œä¹Ÿå°±æ˜¯å†…æ ¸æœ¬èº«ä¸ä¼šå°†è¿›ç¨‹åˆ†é…åˆ°è¢«éš”ç¦»çš„ CPUã€‚ä¹‹åæˆ‘ä»¬å¯å°†æŒ‡å®šçš„è¿›ç¨‹ CSR 1000v è™šæ‹Ÿæœºç»‘å®šåˆ°è¢«éš”ç¦»çš„ CPU ä¸Šè¿è¡Œï¼Œè®©è¿›ç¨‹ç‹¬å  CPUï¼Œä½¿å…¶å®æ—¶æ€§å¯å¾—åˆ°ä¸€å®šç¨‹åº¦çš„æé«˜ã€‚</li></ul><p>å¯å‚è€ƒ è¿™ä¸ªç« èŠ‚è·å–ä¸»æœº CPU æ ¸çš„ç›¸å…³ä¿¡æ¯ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@centos7 ~]# cat /proc/cmdline |grep intel_iommu=on</span><br><span class="line"></span><br><span class="line">BOOT_IMAGE=/vmlinuz-3.10.0-1127.el7.x86_64 root=/dev/mapper/centos-root ro crashkernel=auto spectre_v2=retpoline rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet hugepagesz=1G hugepages=32 default_hugepagesz=1G intel_iommu=on iommu=pt LANG=en_US.UTF-8</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# dmesg |grep -e DMAR -e IOMMU</span><br><span class="line"></span><br><span class="line">[    0.000000] ACPI: DMAR 000000005d6f5d70 00250 (v01 Cisco0 CiscoUCS 00000001 INTL 20091013)</span><br><span class="line"></span><br><span class="line">[    0.000000] DMAR: IOMMU enabled</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹éš”ç¦»çš„ CPU æ ¸ä»¥åŠæ‰€æœ‰çš„ CPU æ ¸ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cat /sys/devices/system/cpu/isolated</span></span><br><span class="line"></span><br><span class="line">1-8,37-44</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># cat /sys/devices/system/cpu/present</span></span><br><span class="line"></span><br><span class="line">0-71</span><br></pre></td></tr></table></figure><h2 id="ï¼ˆ3ï¼‰é€šè¿‡-nmcli-æŒä¹…åŒ–-VFs-é…ç½®"><a href="#ï¼ˆ3ï¼‰é€šè¿‡-nmcli-æŒä¹…åŒ–-VFs-é…ç½®" class="headerlink" title="ï¼ˆ3ï¼‰é€šè¿‡ nmcli æŒä¹…åŒ– VFs é…ç½®"></a>ï¼ˆ3ï¼‰é€šè¿‡ nmcli æŒä¹…åŒ– VFs é…ç½®</h2><p>nmcli å¯ä»¥è®¾ç½®ç½‘å¡çš„ sriov å‚æ•°ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection modify eno2 sriov.total-vfs 4</span><br></pre></td></tr></table></figure><p>è¿˜å¯ä»¥è®¾ç½®æ¯ä¸€ä¸ª VF è®¾å¤‡çš„ MAC åœ°å€ï¼Œä¾¿äºç®¡ç†ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection modify eno2 sriov.vfs <span class="string">&#x27;0 mac=8E:DF:08:C1:D1:DE trust=true, 1 mac=5A:B9:2F:99:A6:CE trust=true, 2 mac=46:78:69:E3:71:3D trust=true, 3 mac=7E:A7:DB:3B:1B:B3 trust=true&#x27;</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡Œä¸Šè¿°å‘½ä»¤åï¼š</p><p>cat /etc/sysconfig/network-scripts/ifcfg-eno2</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">TYPE=Ethernet</span><br><span class="line"></span><br><span class="line">NAME=eno2</span><br><span class="line"></span><br><span class="line">UUID=64ffa204-0158-40c8-ba86-2b7aebf27619</span><br><span class="line"></span><br><span class="line">DEVICE=eno2</span><br><span class="line"></span><br><span class="line">ONBOOT=yes</span><br><span class="line"></span><br><span class="line">MTU=9216</span><br><span class="line"></span><br><span class="line">HWADDR=70:7D:B9:59:5B:AF</span><br><span class="line"></span><br><span class="line">PROXY_METHOD=none</span><br><span class="line"></span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line"></span><br><span class="line">IPV6INIT=no</span><br><span class="line"></span><br><span class="line">SRIOV_TOTAL_VFS=4</span><br><span class="line"></span><br><span class="line">SRIOV_VF0=<span class="string">&quot;mac=8E:DF:08:C1:D1:DE trust=true&quot;</span></span><br><span class="line"></span><br><span class="line">SRIOV_VF1=<span class="string">&quot;mac=5A:B9:2F:99:A6:CE trust=true&quot;</span></span><br><span class="line"></span><br><span class="line">SRIOV_VF2=<span class="string">&quot;mac=46:78:69:E3:71:3D trust=true&quot;</span></span><br><span class="line"></span><br><span class="line">SRIOV_VF3=<span class="string">&quot;mac=7E:A7:DB:3B:1B:B3 trust=true&quot;</span></span><br></pre></td></tr></table></figure><p>é‡å¯åï¼Œæ£€æŸ¥ dmesgï¼š</p><p>dmesg | grep -i vf | grep -i eno2</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[   11.953333] ixgbe 0000:3b:00.1 eno2: SR-IOV enabled with 4 VFs</span><br><span class="line"></span><br><span class="line">[   12.541801] ixgbe 0000:3b:00.1: setting MAC 8e:df:08:c1:d1:de on VF 0</span><br><span class="line"></span><br><span class="line">[   12.541805] ixgbe 0000:3b:00.1: Reload the VF driver to make this change effective.</span><br><span class="line"></span><br><span class="line">[   12.541841] ixgbe 0000:3b:00.1 eno2: VF 0 is trusted</span><br><span class="line"></span><br><span class="line">[   12.541846] ixgbe 0000:3b:00.1: setting MAC 5a:b9:2f:99:a6:ce on VF 1</span><br><span class="line"></span><br><span class="line">[   12.541850] ixgbe 0000:3b:00.1: Reload the VF driver to make this change effective.</span><br><span class="line"></span><br><span class="line">[   12.541883] ixgbe 0000:3b:00.1 eno2: VF 1 is trusted</span><br><span class="line"></span><br><span class="line">[   12.541887] ixgbe 0000:3b:00.1: setting MAC 46:78:69:e3:71:3d on VF 2</span><br><span class="line"></span><br><span class="line">[   12.541891] ixgbe 0000:3b:00.1: Reload the VF driver to make this change effective.</span><br><span class="line"></span><br><span class="line">[   12.541923] ixgbe 0000:3b:00.1 eno2: VF 2 is trusted</span><br><span class="line"></span><br><span class="line">[   12.541928] ixgbe 0000:3b:00.1: setting MAC 7e:a7:db:3b:1b:b3 on VF 3</span><br><span class="line"></span><br><span class="line">[   12.541932] ixgbe 0000:3b:00.1: Reload the VF driver to make this change effective.</span><br><span class="line"></span><br><span class="line">[   12.541965] ixgbe 0000:3b:00.1 eno2: VF 3 is trusted</span><br></pre></td></tr></table></figure><h2 id="ï¼ˆ4ï¼‰æ£€æŸ¥-VF"><a href="#ï¼ˆ4ï¼‰æ£€æŸ¥-VF" class="headerlink" title="ï¼ˆ4ï¼‰æ£€æŸ¥ VF"></a>ï¼ˆ4ï¼‰æ£€æŸ¥ VF</h2><p>å¯é€šè¿‡ lspci å’Œ ip link æ£€æŸ¥ VFï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># lspci | grep -i Virtual</span></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># ip link show | grep -B2 vf</span></span><br></pre></td></tr></table></figure><p>å¯»æ‰¾ Physical Function å’Œ Virtual Function ä¹‹é—´çš„å¯¹åº”å…³ç³»ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># ls -l /sys/class/net/eno1/device/ | grep virtfn</span></span><br></pre></td></tr></table></figure><p>VF è¢«åˆ›å»ºåï¼ŒNetworkManager è‡ªåŠ¨ç»™æ–°çš„è®¾å¤‡åˆ›å»º Connectionï¼Œå¯ä»¥ä¿®æ”¹åç§°ï¼Œå¦‚ä¸‹ï¼š</p><p>nmcli connection</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">NAME        UUID                                  TYPE      DEVICE</span><br><span class="line"></span><br><span class="line">eno1        2a1c8b39-7f44-321b-a65f-a93e70ab0616  ethernet  eno1</span><br><span class="line"></span><br><span class="line">eno2        64ffa204-0158-40c8-ba86-2b7aebf27619  ethernet  eno2</span><br><span class="line"></span><br><span class="line">enp59s16f1  19c28a93-aa36-38e6-a556-55a922a0a332  ethernet  enp59s16f1</span><br><span class="line"></span><br><span class="line">enp59s16f3  428d9707-1515-3475-b356-7eb229c3f937  ethernet  enp59s16f3</span><br><span class="line"></span><br><span class="line">enp59s16f5  21a8dd5f-239f-37b2-9b09-24ce0e7413bc  ethernet  enp59s16f5</span><br><span class="line"></span><br><span class="line">enp59s16f7  0ca0da65-64c4-314d-89a4-4213f9e4f478  ethernet  enp59s16f7</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹åç§°ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection modify uuid 19c28a93-aa36-38e6-a556-55a922a0a332 connection.id enp59s16f1</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ MTU å€¼ï¼Œå¹¶ç¦ç”¨ IPv4 å’Œ IPv6ï¼Œç½‘å¡å¯åŠ¨æ›´å¿«</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nmcli connection modify enp59s16f1 ifname enp59s16f1 ipv4.method disabled ipv6.method ignore ethernet.mtu 9216 ethernet.mac-address <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">nmcli connection up enp59s16f1</span><br><span class="line"></span><br><span class="line">nmcli connection show enp59s16f1</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°å‘½ä»¤ç”Ÿæˆçš„ ifcfg é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š</p><p>[root@centos7 ~]# cat /etc/sysconfig/network-scripts/ifcfg-enp59s16f1</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">TYPE=Ethernet</span><br><span class="line"></span><br><span class="line">PROXY_METHOD=none</span><br><span class="line"></span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line"></span><br><span class="line">DEFROUTE=yes</span><br><span class="line"></span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line"></span><br><span class="line">IPV6INIT=no</span><br><span class="line"></span><br><span class="line">IPV6_AUTOCONF=no</span><br><span class="line"></span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line"></span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line"></span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line"></span><br><span class="line">NAME=enp59s16f1</span><br><span class="line"></span><br><span class="line">UUID=19c28a93-aa36-38e6-a556-55a922a0a332</span><br><span class="line"></span><br><span class="line">ONBOOT=yes</span><br><span class="line"></span><br><span class="line">AUTOCONNECT_PRIORITY=-999</span><br><span class="line"></span><br><span class="line">DEVICE=enp59s16f1</span><br><span class="line"></span><br><span class="line">MTU=9216</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œå³ä¾¿ç³»ç»Ÿé‡å¯ï¼Œä¸Šè¿°é…ç½®ä¾ç„¶èƒ½ç”Ÿæ•ˆã€‚</p><h1 id="ä½¿ç”¨-KVM-çš„è™šæ‹Ÿç½‘ç»œé€‚é…å™¨æ± "><a href="#ä½¿ç”¨-KVM-çš„è™šæ‹Ÿç½‘ç»œé€‚é…å™¨æ± " class="headerlink" title="ä½¿ç”¨ KVM çš„è™šæ‹Ÿç½‘ç»œé€‚é…å™¨æ± "></a>ä½¿ç”¨ KVM çš„è™šæ‹Ÿç½‘ç»œé€‚é…å™¨æ± </h1><p>ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ª VF ç½‘ç»œè®¾å¤‡çš„èµ„æºæ± ï¼Œèµ„æºæ± å†…çš„è®¾å¤‡å¯ä»¥è‡ªåŠ¨åœ°åˆ†é…ç»™è™šæ‹Ÿæœºä½¿ç”¨ã€‚</p><h2 id="ï¼ˆ1ï¼‰åˆ›å»ºä¸€ä¸ª-xml-æ–‡ä»¶ã€‚"><a href="#ï¼ˆ1ï¼‰åˆ›å»ºä¸€ä¸ª-xml-æ–‡ä»¶ã€‚" class="headerlink" title="ï¼ˆ1ï¼‰åˆ›å»ºä¸€ä¸ª xml æ–‡ä»¶ã€‚"></a>ï¼ˆ1ï¼‰åˆ›å»ºä¸€ä¸ª xml æ–‡ä»¶ã€‚</h2><p>[root@centos7 ~]# cat eno2_sriov_pool.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">network</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>eno2_sriov_pool<span class="tag">&lt;/<span class="name">name</span>&gt;</span> <span class="comment">&lt;!-- This is the name of the file you created --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">forward</span> <span class="attr">mode</span>=<span class="string">&#x27;hostdev&#x27;</span> <span class="attr">managed</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">pf</span> <span class="attr">dev</span>=<span class="string">&#x27;eno2&#x27;</span>/&gt;</span> <span class="comment">&lt;!-- Use the netdev name of your SR-IOV devices PF here --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">forward</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">network</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="ï¼ˆ2ï¼‰æ ¹æ®-xml-å®šä¹‰ä¸€ä¸ªç½‘ç»œï¼Œå¹¶è®¾ç½®ä¸ºè‡ªåŠ¨é‡å¯"><a href="#ï¼ˆ2ï¼‰æ ¹æ®-xml-å®šä¹‰ä¸€ä¸ªç½‘ç»œï¼Œå¹¶è®¾ç½®ä¸ºè‡ªåŠ¨é‡å¯" class="headerlink" title="ï¼ˆ2ï¼‰æ ¹æ® xml å®šä¹‰ä¸€ä¸ªç½‘ç»œï¼Œå¹¶è®¾ç½®ä¸ºè‡ªåŠ¨é‡å¯"></a>ï¼ˆ2ï¼‰æ ¹æ® xml å®šä¹‰ä¸€ä¸ªç½‘ç»œï¼Œå¹¶è®¾ç½®ä¸ºè‡ªåŠ¨é‡å¯</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">virsh net-define eno2_sriov_pool.xml</span><br><span class="line"></span><br><span class="line">virsh net-start eno2_sriov_pool</span><br><span class="line"></span><br><span class="line">virsh net-autostart eno2_sriov_pool</span><br></pre></td></tr></table></figure><p>[root@centos7 ~]# virsh net-dumpxml eno2_sriov_pool</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">network</span> <span class="attr">connections</span>=<span class="string">&#x27;1&#x27;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">name</span>&gt;</span>eno2_sriov_pool<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>e0842451-0137-4255-8783-305ca27f082d<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">forward</span> <span class="attr">mode</span>=<span class="string">&#x27;hostdev&#x27;</span> <span class="attr">managed</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">pf</span> <span class="attr">dev</span>=<span class="string">&#x27;eno2&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x3b&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x10&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x1&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x3b&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x10&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x3&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x3b&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x10&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x5&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x3b&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x10&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x7&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;/<span class="name">forward</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">network</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="ï¼ˆ3ï¼‰ä»ç½‘ç»œé€‚é…å™¨æ± ä¸­åˆ†é…ç½‘å¡ç»™è™šæ‹Ÿæœº"><a href="#ï¼ˆ3ï¼‰ä»ç½‘ç»œé€‚é…å™¨æ± ä¸­åˆ†é…ç½‘å¡ç»™è™šæ‹Ÿæœº" class="headerlink" title="ï¼ˆ3ï¼‰ä»ç½‘ç»œé€‚é…å™¨æ± ä¸­åˆ†é…ç½‘å¡ç»™è™šæ‹Ÿæœº"></a>ï¼ˆ3ï¼‰ä»ç½‘ç»œé€‚é…å™¨æ± ä¸­åˆ†é…ç½‘å¡ç»™è™šæ‹Ÿæœº</h2><p>ç”¨è¿™ç§æ–¹æ³•æ·»åŠ  SRIOV ç½‘å¡æ¯”è¾ƒç®€å•ï¼š</p><img src="/csr1kv-kvm-CentOS7/sriov-pool-001.png" class="" title="SRIOV Adapter Pool"><p>æŒ‰ç…§å¦‚ä¸Šæ–¹æ³•æ·»åŠ ç½‘å¡ï¼Œç­‰åŒäºä»¥ä¸‹ xml é…ç½®ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;network&#x27;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;52:54:00:2d:87:99&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">source</span> <span class="attr">network</span>=<span class="string">&#x27;eno2_sriov_pool&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x04&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å¼€æœºå dumpxml å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">  <span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;hostdev&#x27;</span> <span class="attr">managed</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;52:54:00:2d:87:99&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;vfio&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">source</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x3b&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x10&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x1&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;hostdev0&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x0f&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="ä½¿ç”¨-Virt-manager-å®‰è£…-CSR1000v"><a href="#ä½¿ç”¨-Virt-manager-å®‰è£…-CSR1000v" class="headerlink" title="ä½¿ç”¨ Virt-manager å®‰è£… CSR1000v"></a>ä½¿ç”¨ Virt-manager å®‰è£… CSR1000v</h1><p>åœ¨ CentOS å›¾å½¢ç•Œé¢ä¸­ï¼Œæ‰“å¼€ Terminalï¼Œè¿è¡Œ virt-managerï¼ŒæŒ‰ç…§ä»¥ä¸‹æ­¥éª¤åˆ›å»º CSR1000vï¼›æ·»åŠ ç½‘å¡ï¼Œå¹¶é€‰æ‹© en2_sriov_poolã€‚</p><img src="/csr1kv-kvm-CentOS7/virt-manager-1.png" class="" title="Step 1"><img src="/csr1kv-kvm-CentOS7/virt-manager-2.png" class="" title="é€‰æ‹©é•œåƒ"><img src="/csr1kv-kvm-CentOS7/virt-manager-3.png" class="" title="Step 2"><img src="/csr1kv-kvm-CentOS7/virt-manager-3.png" class="" title="Step 3"><img src="/csr1kv-kvm-CentOS7/virt-manager-5.png" class="" title="Step 4"><p>æ³¨ï¼šcsr1kv-1 çš„ç¬¬ä¸€ä¸ªç½‘å£é€‰æ‹©<strong>macvtap Bridge</strong>æ¨¡å¼ï¼Œè¿™æ ·å°±æ— éœ€åˆ›å»ºä¸€ä¸ª Linux ç½‘æ¡¥ã€‚ä½†æ˜¯ï¼Œcsr1kv-1 å¯åŠ¨ä»¥åä¸èƒ½é€šè¿‡è¯¥æ¥å£ä¸ Linux ä¸»æœºè¿›è¡Œé€šä¿¡ï¼Œä»…èƒ½é€šè¿‡è¯¥æ¥å£è®¿é—® Linux ä¸»æœºå¤–çš„ç½‘ç»œã€‚</p><img src="/csr1kv-kvm-CentOS7/virt-manager-6.png" class="" title="Step 5"><img src="/csr1kv-kvm-CentOS7/virt-manager-7.png" class="" title="Step 6"><p>æ·»åŠ å®Œç½‘å¡åï¼Œç‚¹å‡»å¼€å§‹å®‰è£…ï¼Œç„¶åå°±å¯ä»¥å…³é—­è™šæ‹Ÿæœºäº†ã€‚ä¸Šè¿°æ“ä½œå®Œæˆåï¼Œvirt-manager ä¼šåœ¨**/etc/libvirtd/qemu/<strong>ç›®å½•ä¸‹åˆ›å»º</strong>csr1kv-1.xml**ã€‚</p><h1 id="KVM-è°ƒä¼˜é…ç½®"><a href="#KVM-è°ƒä¼˜é…ç½®" class="headerlink" title="KVM è°ƒä¼˜é…ç½®"></a>KVM è°ƒä¼˜é…ç½®</h1><p>KVM çš„è°ƒä¼˜æ¯”è¾ƒå¤æ‚ï¼Œä¸»è¦æ˜¯ NUMAã€å†…å­˜å¤§é¡µã€vCPU PIN ç­‰ï¼Œå‚è€ƒèµ„æ–™ä¸º Redhat Linux 7 PERFORMANCE TUNING GUIDEã€‚</p><h2 id="ï¼ˆ1ï¼‰æ£€æŸ¥å¹³å°çš„èƒ½åŠ›"><a href="#ï¼ˆ1ï¼‰æ£€æŸ¥å¹³å°çš„èƒ½åŠ›" class="headerlink" title="ï¼ˆ1ï¼‰æ£€æŸ¥å¹³å°çš„èƒ½åŠ›"></a>ï¼ˆ1ï¼‰æ£€æŸ¥å¹³å°çš„èƒ½åŠ›</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># virsh nodeinfo</span></span><br><span class="line"></span><br><span class="line">CPU model:           x86_64</span><br><span class="line"></span><br><span class="line">CPU(s):              72</span><br><span class="line"></span><br><span class="line">CPU frequency:       999 MHz</span><br><span class="line"></span><br><span class="line">CPU socket(s):       1</span><br><span class="line"></span><br><span class="line">Core(s) per socket:  18</span><br><span class="line"></span><br><span class="line">Thread(s) per core:  2</span><br><span class="line"></span><br><span class="line">NUMA cell(s):        2</span><br><span class="line"></span><br><span class="line">Memory size:         263665612 KiB</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># virsh capabilities</span></span><br><span class="line"></span><br><span class="line">&lt;capabilities&gt;</span><br><span class="line"></span><br><span class="line"> &lt;host&gt;</span><br><span class="line"></span><br><span class="line">  &lt;uuid&gt;4e53df1f-5b36-6842-99ee-1369d7c68730&lt;/uuid&gt;</span><br><span class="line"></span><br><span class="line">  &lt;cpu&gt;</span><br><span class="line"></span><br><span class="line">   &lt;arch&gt;x86_64&lt;/arch&gt;</span><br><span class="line"></span><br><span class="line">   &lt;model&gt;Skylake-Server-IBRS&lt;/model&gt;</span><br><span class="line"></span><br><span class="line">   &lt;vendor&gt;Intel&lt;/vendor&gt;</span><br><span class="line"></span><br><span class="line">   &lt;microcode version=<span class="string">&#x27;33581318&#x27;</span>/&gt;</span><br><span class="line"></span><br><span class="line">   &lt;counter name=<span class="string">&#x27;tsc&#x27;</span> frequency=<span class="string">&#x27;2294597000&#x27;</span> scaling=<span class="string">&#x27;yes&#x27;</span>/&gt;</span><br><span class="line"></span><br><span class="line">   &lt;topology sockets=<span class="string">&#x27;1&#x27;</span> cores=<span class="string">&#x27;18&#x27;</span> threads=<span class="string">&#x27;2&#x27;</span>/&gt;</span><br><span class="line"></span><br><span class="line">â€¦â€¦</span><br></pre></td></tr></table></figure><p>å¯æ£€æŸ¥å¹³å°çš„ CPU æ ¸æ•°ã€åˆ†å¸ƒï¼Œå†…å­˜çš„ NUMA åˆ†å¸ƒç­‰ã€‚</p><h2 id="ï¼ˆ2ï¼‰NUMA-è°ƒä¼˜"><a href="#ï¼ˆ2ï¼‰NUMA-è°ƒä¼˜" class="headerlink" title="ï¼ˆ2ï¼‰NUMA è°ƒä¼˜"></a>ï¼ˆ2ï¼‰NUMA è°ƒä¼˜</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># numactl --hardware</span></span><br><span class="line"></span><br><span class="line">available: 2 nodes (0-1)</span><br><span class="line"></span><br><span class="line">node 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53</span><br><span class="line"></span><br><span class="line">node 0 size: 128491 MB</span><br><span class="line"></span><br><span class="line">node 0 free: 112157 MB</span><br><span class="line"></span><br><span class="line">node 1 cpus: 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71</span><br><span class="line"></span><br><span class="line">node 1 size: 128994 MB</span><br><span class="line"></span><br><span class="line">node 1 free: 124120 MB</span><br><span class="line"></span><br><span class="line">node distances:</span><br><span class="line"></span><br><span class="line">node  0  1</span><br><span class="line"></span><br><span class="line"> 0: 10 21</span><br><span class="line"></span><br><span class="line"> 1: 21 10</span><br></pre></td></tr></table></figure><p>ä¸¤é¢— CPUï¼Œæ¯é¢— CPU å„æœ‰ 128GB å†…å­˜ï¼Œåˆ†åˆ«æ˜¯ node 0 å’Œ node 1ã€‚</p><h2 id="ï¼ˆ3ï¼‰å†…å­˜å¤§é¡µ-HugePage-ä»¥åŠé€æ˜å¤§é¡µ"><a href="#ï¼ˆ3ï¼‰å†…å­˜å¤§é¡µ-HugePage-ä»¥åŠé€æ˜å¤§é¡µ" class="headerlink" title="ï¼ˆ3ï¼‰å†…å­˜å¤§é¡µ HugePage ä»¥åŠé€æ˜å¤§é¡µ"></a>ï¼ˆ3ï¼‰å†…å­˜å¤§é¡µ HugePage ä»¥åŠé€æ˜å¤§é¡µ</h2><p><code> </code>cat /proc/meminfo | grep HugePages æŸ¥çœ‹å½“å‰ç³»ç»Ÿæœ‰å¤šå°‘ä¸ªå¤§é¡µï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cat /proc/meminfo | grep Huge</span></span><br><span class="line"></span><br><span class="line">AnonHugePages:   1685504 kB</span><br><span class="line"></span><br><span class="line">HugePages_Total:      64</span><br><span class="line"></span><br><span class="line">HugePages_Free:       60</span><br><span class="line"></span><br><span class="line">HugePages_Rsvd:        0</span><br><span class="line"></span><br><span class="line">HugePages_Surp:        0</span><br><span class="line"></span><br><span class="line">Hugepagesize:    1048576 kB</span><br></pre></td></tr></table></figure><p>åœ¨ç³»ç»Ÿè¿è¡Œæ—¶ä¿®æ”¹å¤§é¡µæ•°é‡ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># cat /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages</span></span><br><span class="line"></span><br><span class="line">16</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># echo 32 &gt; /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages</span></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># echo 32 &gt; /sys/devices/system/node/node1/hugepages/hugepages-1048576kB/nr_hugepages</span></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment">#</span></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># numastat -cm | egrep &#x27;Node|Huge&#x27;</span></span><br><span class="line"></span><br><span class="line">`                 `Node 0 Node 1  Total</span><br><span class="line"></span><br><span class="line">AnonHugePages     10962   1528  12490</span><br><span class="line"></span><br><span class="line">HugePages_Total   32768  32768  65536</span><br><span class="line"></span><br><span class="line">HugePages_Free    32768  32768  65536</span><br><span class="line"></span><br><span class="line">HugePages_Surp        0      0      0</span><br></pre></td></tr></table></figure><p>æ£€æŸ¥é€æ˜å¤§é¡µå‚æ•°ï¼Œåœ¨ CentOS7 ä¸Šç¼ºçœå¼€å¯ï¼›å¼€å¯äº†é€æ˜å¤§é¡µï¼Œä¸å½±å“é™æ€å¤§é¡µçš„ä½¿ç”¨ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line"></span><br><span class="line">[always] madvise never</span><br></pre></td></tr></table></figure><h2 id="ï¼ˆ4ï¼‰vCPU-é’‰é€‰"><a href="#ï¼ˆ4ï¼‰vCPU-é’‰é€‰" class="headerlink" title="ï¼ˆ4ï¼‰vCPU é’‰é€‰"></a>ï¼ˆ4ï¼‰vCPU é’‰é€‰</h2><p>è®¾ç½® CPU Affinity çš„å¥½å¤„æ˜¯æé«˜ CPU ç¼“å­˜æ•ˆç‡ï¼Œé¿å…è¿›ç¨‹åœ¨å¤šä¸ª CPU æ ¸ä¹‹é—´è·³è·ƒï¼Œåˆ‡æ¢ CPU æ ¸å‡ä¼šå¯¼è‡´ç¼“å­˜ä¸­çš„æ•°æ®æ— æ•ˆï¼Œç¼“å­˜å‘½ä¸­ç‡å¤§å¹…é™ä½ï¼Œå¯¼è‡´æ•°æ®è·å–çš„å¼€é”€å±…é«˜ä¸ä¸‹ï¼ŒæŸå¤±æ€§èƒ½ã€‚</p><p><strong>virsh vcpuinfo csr1kv-1</strong> å¯ä»¥æŸ¥çœ‹ vCPU çš„åˆ†é…ã€‚</p><h2 id="ï¼ˆ5ï¼‰ç¼–è¾‘-CSR-1000v-çš„-XML-è°ƒä¼˜å‚æ•°"><a href="#ï¼ˆ5ï¼‰ç¼–è¾‘-CSR-1000v-çš„-XML-è°ƒä¼˜å‚æ•°" class="headerlink" title="ï¼ˆ5ï¼‰ç¼–è¾‘ CSR 1000v çš„ XML è°ƒä¼˜å‚æ•°"></a>ï¼ˆ5ï¼‰ç¼–è¾‘ CSR 1000v çš„ XML è°ƒä¼˜å‚æ•°</h2><p>virsh edit csr1kv-1 å¯ä»¥ç¼–è¾‘ XML çš„å‚æ•°ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">memoryBacking</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">hugepages</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">page</span> <span class="attr">size</span>=<span class="string">&#x27;1048576&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">hugepages</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">locked</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">nosharepages</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">memoryBacking</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">vcpu</span> <span class="attr">placement</span>=<span class="string">&#x27;static&#x27;</span>&gt;</span>8<span class="tag">&lt;/<span class="name">vcpu</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">cputune</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;3&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;4&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;5&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;5&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;6&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;6&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;7&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;7&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;8&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">emulatorpin</span> <span class="attr">cpuset</span>=<span class="string">&#x27;45-52&#x27;</span>/&gt;</span> <span class="comment">&lt;!-- If Hyper-threading were enabled --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cputune</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">numatune</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">memory</span> <span class="attr">mode</span>=<span class="string">&#x27;strict&#x27;</span> <span class="attr">nodeset</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">numatune</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">cpu</span> <span class="attr">mode</span>=<span class="string">&#x27;host-passthrough&#x27;</span> <span class="attr">check</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">memballoon</span> <span class="attr">model</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>æ³¨ï¼š**<emulatorpin cpuset='37-44'/>** å‚æ•°ï¼Œä»…å½“ Hyper-Threating å¼€å¯æ—¶ä½¿ç”¨ï¼›æœ‰ä¸€äº›å¹³å°å¹¶æœªå…³é—­è¶…çº¿ç¨‹ï¼Œä¾‹å¦‚ Cisco ä¸“é—¨çš„ NFV å¹³å° CSPã€‚é€šè¿‡ virsh chapabilities æŸ¥çœ‹ siblings=â€™1,37â€™ï¼Œå½“ core 1 è®¾ç½®ä¸º vcpupin æ—¶ï¼Œcore 37 åº”è®¾ç½®åˆ° emulatorpin cpuset ä¸­ã€‚</p><p>ä»¥ä¸‹å…³äº CPU å’Œå†…å­˜çš„å‚æ•°è®¾å®šå»ºè®®æ¥è‡ªäº<a href="https://libvirt.org/formatdomain.html">https://libvirt.org/formatdomain.html</a> å’Œ <a href="https://libvirt.org/kbase/kvm-realtime.html">https://libvirt.org/kbase/kvm-realtime.html</a></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">domain</span> <span class="attr">type</span>=<span class="string">&#x27;kvm&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>csr1kv-1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>59581018-6387-49df-ab09-2bcf40fc12ba<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">memory</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>&gt;</span>8388608<span class="tag">&lt;/<span class="name">memory</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">currentMemory</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>&gt;</span>8388608<span class="tag">&lt;/<span class="name">currentMemory</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">memoryBacking</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hugepages</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">page</span> <span class="attr">size</span>=<span class="string">&#x27;1048576&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">hugepages</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">locked</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">nosharepages</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">memoryBacking</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpu</span> <span class="attr">placement</span>=<span class="string">&#x27;static&#x27;</span>&gt;</span>8<span class="tag">&lt;/<span class="name">vcpu</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">cputune</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;3&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;4&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;5&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;5&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;6&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;6&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;7&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;7&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;8&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">emulatorpin</span> <span class="attr">cpuset</span>=<span class="string">&#x27;37-44&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">cputune</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">numatune</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">memory</span> <span class="attr">mode</span>=<span class="string">&#x27;strict&#x27;</span> <span class="attr">nodeset</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">numatune</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">os</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span> <span class="attr">arch</span>=<span class="string">&#x27;x86_64&#x27;</span> <span class="attr">machine</span>=<span class="string">&#x27;pc-i440fx-rhel7.0.0&#x27;</span>&gt;</span>hvm<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">boot</span> <span class="attr">dev</span>=<span class="string">&#x27;hd&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">os</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">features</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">acpi</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">apic</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">features</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">cpu</span> <span class="attr">mode</span>=<span class="string">&#x27;host-passthrough&#x27;</span> <span class="attr">check</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">clock</span> <span class="attr">offset</span>=<span class="string">&#x27;utc&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">timer</span> <span class="attr">name</span>=<span class="string">&#x27;rtc&#x27;</span> <span class="attr">tickpolicy</span>=<span class="string">&#x27;catchup&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">timer</span> <span class="attr">name</span>=<span class="string">&#x27;pit&#x27;</span> <span class="attr">tickpolicy</span>=<span class="string">&#x27;delay&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">timer</span> <span class="attr">name</span>=<span class="string">&#x27;hpet&#x27;</span> <span class="attr">present</span>=<span class="string">&#x27;no&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">clock</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">on_poweroff</span>&gt;</span>destroy<span class="tag">&lt;/<span class="name">on_poweroff</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">on_reboot</span>&gt;</span>restart<span class="tag">&lt;/<span class="name">on_reboot</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">on_crash</span>&gt;</span>destroy<span class="tag">&lt;/<span class="name">on_crash</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">pm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">suspend-to-mem</span> <span class="attr">enabled</span>=<span class="string">&#x27;no&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">suspend-to-disk</span> <span class="attr">enabled</span>=<span class="string">&#x27;no&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">pm</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">devices</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">emulator</span>&gt;</span>/usr/libexec/qemu-kvm<span class="tag">&lt;/<span class="name">emulator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;file&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;disk&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;qcow2&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">&#x27;/home/root/images/csr1000v-universalk9.17.02.01v.qcow2&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;vda&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x07&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;ich9-ehci1&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x05&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x7&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;ich9-uhci1&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">master</span> <span class="attr">startport</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x05&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span> <span class="attr">multifunction</span>=<span class="string">&#x27;on&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;ich9-uhci2&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">master</span> <span class="attr">startport</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x05&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;ich9-uhci3&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">master</span> <span class="attr">startport</span>=<span class="string">&#x27;4&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x05&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pci-root&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;virtio-serial&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x06&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;direct&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;52:54:00:36:95:f0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">dev</span>=<span class="string">&#x27;eno1&#x27;</span> <span class="attr">mode</span>=<span class="string">&#x27;bridge&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x03&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;network&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;52:54:00:2d:87:99&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">network</span>=<span class="string">&#x27;eno2_sriov_pool&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x04&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">serial</span> <span class="attr">type</span>=<span class="string">&#x27;pty&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;isa-serial&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;isa-serial&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">serial</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">console</span> <span class="attr">type</span>=<span class="string">&#x27;pty&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;serial&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">console</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">channel</span> <span class="attr">type</span>=<span class="string">&#x27;unix&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;org.qemu.guest_agent.0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;virtio-serial&#x27;</span> <span class="attr">controller</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">channel</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">channel</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;com.redhat.spice.0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;virtio-serial&#x27;</span> <span class="attr">controller</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">channel</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;tablet&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;mouse&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;ps2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;keyboard&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;ps2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">graphics</span> <span class="attr">type</span>=<span class="string">&#x27;spice&#x27;</span> <span class="attr">autoport</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">listen</span> <span class="attr">type</span>=<span class="string">&#x27;address&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">image</span> <span class="attr">compression</span>=<span class="string">&#x27;off&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">graphics</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">video</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;qxl&#x27;</span> <span class="attr">ram</span>=<span class="string">&#x27;65536&#x27;</span> <span class="attr">vram</span>=<span class="string">&#x27;65536&#x27;</span> <span class="attr">vgamem</span>=<span class="string">&#x27;16384&#x27;</span> <span class="attr">heads</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">primary</span>=<span class="string">&#x27;yes&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;3&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">memballoon</span> <span class="attr">model</span>=<span class="string">&#x27;none&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rng</span> <span class="attr">model</span>=<span class="string">&#x27;virtio&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">backend</span> <span class="attr">model</span>=<span class="string">&#x27;random&#x27;</span>&gt;</span>/dev/urandom<span class="tag">&lt;/<span class="name">backend</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x09&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rng</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">devices</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸Šè¿°å‚æ•°æ•´ç†è‡ª<a href="https://www.cisco.com/c/en/us/td/docs/routers/csr1000/software/configuration/b_CSR1000v_Configuration_Guide/b_CSR1000v_Configuration_Guide_chapter_0101.html">ã€ŠCisco CSR 1000v and Cisco ISRv Software Configuration Guideã€‹</a></p><p>å®Œæˆä¸Šè¿° XML æ–‡ä»¶çš„ç¼–è¾‘åï¼Œæ‰§è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/libvirtd/qemu</span><br><span class="line"></span><br><span class="line">virsh define csr1kv-1.xml</span><br><span class="line"></span><br><span class="line">virsh start csr1kv-1</span><br></pre></td></tr></table></figure><h2 id="ï¼ˆ6ï¼‰åœ¨-KVM-ä¸»æœºä¸Šè®¿é—®-CSR1000v-çš„-Console"><a href="#ï¼ˆ6ï¼‰åœ¨-KVM-ä¸»æœºä¸Šè®¿é—®-CSR1000v-çš„-Console" class="headerlink" title="ï¼ˆ6ï¼‰åœ¨ KVM ä¸»æœºä¸Šè®¿é—® CSR1000v çš„ Console"></a>ï¼ˆ6ï¼‰åœ¨ KVM ä¸»æœºä¸Šè®¿é—® CSR1000v çš„ Console</h2><p>åœ¨ virt-manager åˆ›å»º CSR1000v è™šæ‹Ÿæœºçš„æ—¶å€™ï¼Œç¼ºçœä¼šæ·»åŠ ä¸€ä¸ª Serial Deviceã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 qemu]<span class="comment"># virsh console 20</span></span><br><span class="line"></span><br><span class="line">Connected to domain CSR1000v-1</span><br><span class="line"></span><br><span class="line">Escape character is ^]</span><br></pre></td></tr></table></figure><p>CSR 1000v æš‚æ—¶ä¸èƒ½é€šè¿‡ Console é…ç½®ï¼Œéœ€è¦é€šè¿‡ virt-manager çš„å›¾å½¢åŒ–ç•Œé¢è¿›è¡Œåˆå§‹åŒ–é…ç½®ã€‚</p><p>vCloud çš„ Console è®¿é—®æ­£å¸¸ã€‚</p><h2 id="ï¼ˆ7ï¼‰æ£€éªŒ-CSR1000v-çš„è°ƒä¼˜é…ç½®"><a href="#ï¼ˆ7ï¼‰æ£€éªŒ-CSR1000v-çš„è°ƒä¼˜é…ç½®" class="headerlink" title="ï¼ˆ7ï¼‰æ£€éªŒ CSR1000v çš„è°ƒä¼˜é…ç½®"></a>ï¼ˆ7ï¼‰æ£€éªŒ CSR1000v çš„è°ƒä¼˜é…ç½®</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# virsh list</span><br><span class="line"></span><br><span class="line">Id  Name              State</span><br><span class="line"></span><br><span class="line">----------------------------------------------------</span><br><span class="line"></span><br><span class="line"> 6   csr1kv-1            running</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# virsh vcpuinfo 6</span><br><span class="line"></span><br><span class="line">VCPU:      0</span><br><span class="line"></span><br><span class="line">CPU:      1</span><br><span class="line"></span><br><span class="line">State:     running</span><br><span class="line"></span><br><span class="line">CPU time:    34.5s</span><br><span class="line"></span><br><span class="line">CPU Affinity:  -y----------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VCPU:      1</span><br><span class="line"></span><br><span class="line">CPU:      2</span><br><span class="line"></span><br><span class="line">State:     running</span><br><span class="line"></span><br><span class="line">CPU time:    32.0s</span><br><span class="line"></span><br><span class="line">CPU Affinity:  --y---------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VCPU:      2</span><br><span class="line"></span><br><span class="line">CPU:      3</span><br><span class="line"></span><br><span class="line">State:     running</span><br><span class="line"></span><br><span class="line">CPU time:    23.8s</span><br><span class="line"></span><br><span class="line">CPU Affinity:  ---y--------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VCPU:      3</span><br><span class="line"></span><br><span class="line">CPU:      4</span><br><span class="line"></span><br><span class="line">State:     running</span><br><span class="line"></span><br><span class="line">CPU time:    19.8s</span><br><span class="line"></span><br><span class="line">CPU Affinity:  ----y-------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VCPU:      4</span><br><span class="line"></span><br><span class="line">CPU:      5</span><br><span class="line"></span><br><span class="line">State:     running</span><br><span class="line"></span><br><span class="line">CPU time:    23.0s</span><br><span class="line"></span><br><span class="line">CPU Affinity:  -----y------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VCPU:      5</span><br><span class="line"></span><br><span class="line">CPU:      6</span><br><span class="line"></span><br><span class="line">State:     running</span><br><span class="line"></span><br><span class="line">CPU time:    23.4s</span><br><span class="line"></span><br><span class="line">CPU Affinity:  ------y-----------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VCPU:      6</span><br><span class="line"></span><br><span class="line">CPU:      7</span><br><span class="line"></span><br><span class="line">State:     running</span><br><span class="line"></span><br><span class="line">CPU time:    28.5s</span><br><span class="line"></span><br><span class="line">CPU Affinity:  -------y----------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VCPU:      7</span><br><span class="line"></span><br><span class="line">CPU:      8</span><br><span class="line"></span><br><span class="line">State:     running</span><br><span class="line"></span><br><span class="line">CPU time:    28.2s</span><br><span class="line"></span><br><span class="line">CPU Affinity:  --------y---------------------------------------------------------------</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šæ˜¾ç¤º CSR1000v è™šæ‹Ÿæœºçš„ CPU äº²å’Œæ€§åœ¨ 1-8 æ ¸ä¸Šã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># numastat -c qemu-kvm</span></span><br><span class="line"></span><br><span class="line">Per-node process memory usage (<span class="keyword">in</span> MBs) <span class="keyword">for</span> PID 46895 (qemu-kvm)</span><br><span class="line"></span><br><span class="line">     Node 0 Node 1 Total</span><br><span class="line"></span><br><span class="line">     ------ ------ -----</span><br><span class="line"></span><br><span class="line">Huge    8192   0 8192</span><br><span class="line"></span><br><span class="line">Heap    118   0  118</span><br><span class="line"></span><br><span class="line">Stack     0   0   0</span><br><span class="line"></span><br><span class="line">Private   144   7  151</span><br><span class="line"></span><br><span class="line">------- ------ ------ -----</span><br><span class="line"></span><br><span class="line">Total   8455   7 8461</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šæ˜¾ç¤ºï¼Œå†…å­˜ä¸»è¦ä½¿ç”¨ Node 0ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># numastat -vm -p 13428 | grep HugePage</span></span><br><span class="line"></span><br><span class="line">AnonHugePages       956.00     494.00     1450.00</span><br><span class="line"></span><br><span class="line">HugePages_Total     16384.00    16384.00    32768.00</span><br><span class="line"></span><br><span class="line">HugePages_Free      8192.00    16384.00    24576.00</span><br><span class="line"></span><br><span class="line">HugePages_Surp       0.00       0.00      0.00</span><br></pre></td></tr></table></figure><h2 id="ï¼ˆ8ï¼‰åœ¨-CSR1KV-ä¸Šæ£€æŸ¥è™šæ‹Ÿç½‘å¡"><a href="#ï¼ˆ8ï¼‰åœ¨-CSR1KV-ä¸Šæ£€æŸ¥è™šæ‹Ÿç½‘å¡" class="headerlink" title="ï¼ˆ8ï¼‰åœ¨ CSR1KV ä¸Šæ£€æŸ¥è™šæ‹Ÿç½‘å¡"></a>ï¼ˆ8ï¼‰åœ¨ CSR1KV ä¸Šæ£€æŸ¥è™šæ‹Ÿç½‘å¡</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">csr1kv-1#show platform software vnic-if interface-mapping</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"> Interface Name    Driver Name     Mac Addr</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"> GigabitEthernet2    net_ixgbe_vf    5254.002d.8799</span><br><span class="line"></span><br><span class="line"> GigabitEthernet1    net_virtio     5254.0036.95f0</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°é©±åŠ¨åæ˜¾ç¤ºä¸º net_ixgbe_vf è¡¨æ˜è¯¥è™šæ‹Ÿç½‘å¡æ˜¯ä¸€ä¸ª SR-IOV æ± ä¸­åˆ†é…çš„ VF è®¾å¤‡ã€‚</p><h1 id="Linux-ä¸ŠæŠ“å–è™šæ‹Ÿç½‘å¡çš„æŠ¥æ–‡ï¼ˆå‚è€ƒï¼‰"><a href="#Linux-ä¸ŠæŠ“å–è™šæ‹Ÿç½‘å¡çš„æŠ¥æ–‡ï¼ˆå‚è€ƒï¼‰" class="headerlink" title="Linux ä¸ŠæŠ“å–è™šæ‹Ÿç½‘å¡çš„æŠ¥æ–‡ï¼ˆå‚è€ƒï¼‰"></a>Linux ä¸ŠæŠ“å–è™šæ‹Ÿç½‘å¡çš„æŠ¥æ–‡ï¼ˆå‚è€ƒï¼‰</h1><p>æŸ¥æ‰¾è™šæ‹Ÿæœºçš„ç½‘å¡åˆ—è¡¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># virsh domiflist 10</span></span><br><span class="line"></span><br><span class="line">Interface Type    Source   Model    MAC</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------</span><br><span class="line"></span><br><span class="line">vnet0   network  default  virtio   52:54:00:38:71:4a</span><br><span class="line"></span><br><span class="line">macvtap0  direct   eno1    virtio   52:54:00:b2:70:90</span><br><span class="line"></span><br><span class="line">vnet5   bridge   net-br1  virtio   52:54:00:69:93:23</span><br></pre></td></tr></table></figure><p>æŠ“å– vnet5 çš„æŠ¥æ–‡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># tcpdump -i vnet5 -w ping.pcap</span></span><br><span class="line"></span><br><span class="line">tcpdump: listening on vnet5, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line"></span><br><span class="line">^C49 packets captured</span><br><span class="line"></span><br><span class="line">51 packets received by filter</span><br><span class="line"></span><br><span class="line">0 packets dropped by kernel</span><br></pre></td></tr></table></figure><p>æ³¨ï¼šVF å¦‚æœè¢«åˆ†é…ç»™è™šæ‹Ÿæœºï¼Œé‚£ä¹ˆåœ¨ Linux ä¸»æœºé‡Œï¼Œé€šè¿‡ ip link åˆ™æŸ¥çœ‹ä¸åˆ°è¯¥è®¾å¤‡ï¼Œæ— æ³•é€šè¿‡ä¸Šè¿°åŠæ³•æŠ“åŒ…ã€‚</p><h1 id="CSR-1000v-çš„åˆå§‹åŒ–é…ç½®åŠ-Smart-License-æ³¨å†Œ"><a href="#CSR-1000v-çš„åˆå§‹åŒ–é…ç½®åŠ-Smart-License-æ³¨å†Œ" class="headerlink" title="CSR 1000v çš„åˆå§‹åŒ–é…ç½®åŠ Smart License æ³¨å†Œ"></a>CSR 1000v çš„åˆå§‹åŒ–é…ç½®åŠ Smart License æ³¨å†Œ</h1><h2 id="ï¼ˆ1ï¼‰CSR-1000v-åˆå§‹åŒ–é…ç½®ç¤ºä¾‹"><a href="#ï¼ˆ1ï¼‰CSR-1000v-åˆå§‹åŒ–é…ç½®ç¤ºä¾‹" class="headerlink" title="ï¼ˆ1ï¼‰CSR 1000v åˆå§‹åŒ–é…ç½®ç¤ºä¾‹"></a>ï¼ˆ1ï¼‰CSR 1000v åˆå§‹åŒ–é…ç½®ç¤ºä¾‹</h2><p>éƒ¨åˆ†èŠ‚ç•¥ï¼Œå…¶ä»–ä¸ºç¼ºçœé…ç½®ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">CSR1000v-1#show sdwan running-config</span><br><span class="line"></span><br><span class="line">system</span><br><span class="line"></span><br><span class="line"> system-ip       1.1.10.1</span><br><span class="line"></span><br><span class="line"> site-id        101</span><br><span class="line"></span><br><span class="line"> sp-organization-name CiscoBJ</span><br><span class="line"></span><br><span class="line"> organization-name   CiscoBJ</span><br><span class="line"></span><br><span class="line"> vbond 10.75.58.51 port 12346</span><br><span class="line"></span><br><span class="line">!</span><br><span class="line"></span><br><span class="line">hostname CSR1000v-1</span><br><span class="line"></span><br><span class="line">username admin privilege 15 secret 9 $9$4&#x2F;QL2V2K4&#x2F;6H1k$XUmRNf.T7t3KDOj&#x2F;FmoNexpEypCxr482dExXHDnohSI</span><br><span class="line"></span><br><span class="line">ip name-server 64.104.123.245</span><br><span class="line"></span><br><span class="line">ip route 0.0.0.0 0.0.0.0 10.75.59.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">interface GigabitEthernet1</span><br><span class="line"></span><br><span class="line"> no shutdown</span><br><span class="line"></span><br><span class="line"> arp timeout 1200</span><br><span class="line"></span><br><span class="line"> ip address 10.75.59.35 255.255.255.0</span><br><span class="line"></span><br><span class="line"> no ip redirects</span><br><span class="line"></span><br><span class="line"> ip mtu  1500</span><br><span class="line"></span><br><span class="line"> mtu 1500</span><br><span class="line"></span><br><span class="line"> negotiation auto</span><br><span class="line"></span><br><span class="line">exit</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">interface Tunnel1</span><br><span class="line"></span><br><span class="line"> no shutdown</span><br><span class="line"></span><br><span class="line"> ip unnumbered GigabitEthernet1</span><br><span class="line"></span><br><span class="line"> no ip redirects</span><br><span class="line"></span><br><span class="line"> ipv6 unnumbered GigabitEthernet1</span><br><span class="line"></span><br><span class="line"> no ipv6 redirects</span><br><span class="line"></span><br><span class="line"> tunnel source GigabitEthernet1</span><br><span class="line"></span><br><span class="line"> tunnel mode sdwan</span><br><span class="line"></span><br><span class="line">exit</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">clock timezone CST 8 0</span><br><span class="line"></span><br><span class="line">ntp server 10.75.58.1 version 4</span><br><span class="line"></span><br><span class="line">sdwan</span><br><span class="line"></span><br><span class="line"> interface GigabitEthernet1</span><br><span class="line"></span><br><span class="line"> tunnel-interface</span><br><span class="line"></span><br><span class="line">  encapsulation ipsec</span><br><span class="line"></span><br><span class="line">  allow-service sshd</span><br><span class="line"></span><br><span class="line"> exit</span><br></pre></td></tr></table></figure><h2 id="ï¼ˆ2ï¼‰å¸¸ç”¨å‘½ä»¤"><a href="#ï¼ˆ2ï¼‰å¸¸ç”¨å‘½ä»¤" class="headerlink" title="ï¼ˆ2ï¼‰å¸¸ç”¨å‘½ä»¤"></a>ï¼ˆ2ï¼‰å¸¸ç”¨å‘½ä»¤</h2><ul><li>show sdwan control local-properties</li><li>show sdwan control connections</li><li>show sdwan control connection-history</li><li>show sdwan running-config</li><li>show sdwan bfd sessions</li><li>show sdwan omp peers</li><li>show sdwan omp routes</li></ul><h2 id="ï¼ˆ3ï¼‰CSR-1000v-Smart-License-æ³¨å†Œ"><a href="#ï¼ˆ3ï¼‰CSR-1000v-Smart-License-æ³¨å†Œ" class="headerlink" title="ï¼ˆ3ï¼‰CSR 1000v Smart License æ³¨å†Œ"></a>ï¼ˆ3ï¼‰CSR 1000v Smart License æ³¨å†Œ</h2><p>CSR 1000v é»˜è®¤é™é€Ÿä¸º 250Mbpsï¼Œéœ€è¦æ³¨å†Œ Smart License æ‰å¯è§£å¼€é™é€Ÿã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CSR1000v-2#show platform hardware throughput level</span><br><span class="line"></span><br><span class="line">The current throughput level is 250000 kb&#x2F;s</span><br></pre></td></tr></table></figure><p>æ³¨å†Œ Smart License éœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š</p><p>1ã€ CSR 1000v å·²ç»æ³¨å†Œåˆ° vManageï¼Œæ§åˆ¶é¢è¿æ¥æ­£å¸¸ï¼›</p><p>2ã€ é…ç½® ip http client source-interface GigabitEthernet2</p><p>3ã€ sdwan interface GigabitEthernet2 tunnel-interface allow-service all â€”é’ˆå¯¹ 16.12.x ç‰ˆæœ¬ï¼›åœ¨æ–°ç‰ˆæœ¬ä¸­ä»…éœ€è¦ allow https</p><p>4ã€ CSR 1000v å¯ä»¥è®¿é—® URLï¼š<a href="https://tools.cisco.com/its/service/oddce/services/DDCEService">https://tools.cisco.com/its/service/oddce/services/DDCEService</a></p><p>å…è®¸è®¿é—® 114.114.114.114ï¼ŒCSR 1000v å¯è§£æåŸŸå tools.cisco.com</p><p>æ›¿ä»£åŠæ³•ï¼Œå¢åŠ ä¸€æ¡å‘½ä»¤ ip host tools.cisco.com 72.163.4.38</p><p>æ‰§è¡Œ license smart register idtoken xxxxxx è¿›è¡Œæ³¨å†Œ</p><p>show license status æŸ¥çœ‹æ³¨å†Œç»“æœ</p><p>æ³¨å†Œå®Œæˆåï¼Œç³»ç»Ÿè§£å¼€é™é€Ÿï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CSR1000v-1#show platform hardware throughput level</span><br><span class="line"></span><br><span class="line">The current throughput level is 200000000 kb&#x2F;s</span><br></pre></td></tr></table></figure><h1 id="æ€§èƒ½å’Œç›¸å…³é™åˆ¶"><a href="#æ€§èƒ½å’Œç›¸å…³é™åˆ¶" class="headerlink" title="æ€§èƒ½å’Œç›¸å…³é™åˆ¶"></a>æ€§èƒ½å’Œç›¸å…³é™åˆ¶</h1><h2 id="ï¼ˆ1ï¼‰SRIOV-çš„æ€§èƒ½"><a href="#ï¼ˆ1ï¼‰SRIOV-çš„æ€§èƒ½" class="headerlink" title="ï¼ˆ1ï¼‰SRIOV çš„æ€§èƒ½"></a>ï¼ˆ1ï¼‰SRIOV çš„æ€§èƒ½</h2><p>åœ¨ä¸Šè¿° CSR1KV-1 å®‰è£…å¥½åï¼Œä½¿ç”¨æµ‹è¯•ä»ªè¿›è¡Œæ€§èƒ½æµ‹è¯•ï¼Œæµ‹è¯•æ¡ä»¶ä¸­ï¼Œè®¾ç½®ä¸¢åŒ…ç‡ä¸º 0%ï¼Œå…¶æ€§èƒ½å¦‚ä¸‹ï¼š</p><table><thead><tr><th align="left">Packet Site</th><th align="center">SDWAN Performance (Mbps)</th><th align="center">CEF Performance (Mbps)</th></tr></thead><tbody><tr><td align="left">128Byte</td><td align="center">800</td><td align="center">2843.75</td></tr><tr><td align="left">256Byte</td><td align="center">1431.26</td><td align="center">6500.00</td></tr><tr><td align="left">512Byte</td><td align="center">2581.26</td><td align="center">10578.13</td></tr><tr><td align="left">1024Byte</td><td align="center">3731.26</td><td align="center">15500.00</td></tr><tr><td align="left">1400Byte</td><td align="center">4306.26</td><td align="center">18171.88</td></tr></tbody></table><img src="/csr1kv-kvm-CentOS7/line-chart-009.png" class="" title="æ€§èƒ½ç°çŠ¶å›¾è¡¨"><p>æ³¨ï¼šä¸Šè¿°æµ‹è¯•ç»“æœéå®˜æ–¹ç»“æœï¼Œä¸åŒæœåŠ¡å™¨å’Œç½‘å¡å¯èƒ½æµ‹è¯•ç»“æœæœ‰åŒºåˆ«ï¼Œä¸Šè¿°æ€§èƒ½æ•°æ®ä»…ä¾›å‚è€ƒã€‚</p><h2 id="ï¼ˆ2ï¼‰SRIOV-çš„é™åˆ¶"><a href="#ï¼ˆ2ï¼‰SRIOV-çš„é™åˆ¶" class="headerlink" title="ï¼ˆ2ï¼‰SRIOV çš„é™åˆ¶"></a>ï¼ˆ2ï¼‰SRIOV çš„é™åˆ¶</h2><p>SRIOV çš„ä¸»è¦é™åˆ¶æ˜¯æ¯ä¸€ä¸ª VF è®¾å¤‡æ”¯æŒçš„ VLAN æ•°ï¼Œixgbevf æ‰€æ”¯æŒçš„æœ€å¤§ VLAN æ•°ä¸º 64ï¼›å› æ­¤ï¼Œåœ¨ CSR1KV ä¸­å¯¹åº”çš„è™šæ‹Ÿæ¥å£é…ç½®çš„æ´»è·ƒå­æ¥å£æ•°æœ€å¤§ä¸º 64ã€‚</p><p>é…ç½®æŒ‡å—ä¸­æœ‰å…³äº SRIOV å­æ¥å£é™åˆ¶çš„è¯´æ˜ï¼š</p><p><code> </code><a href="https://www.cisco.com/c/en/us/td/docs/routers/csr1000/software/configuration/b_CSR1000v_Configuration_Guide/b_CSR1000v_Configuration_Guide_chapter_0101.html">Cisco CSR 1000v and Cisco ISRv Software Configuration Guide</a>:</p><blockquote><p>SR-IOV (ixgbevf)</p><p>Maximum VLANs: The maximum number of VLANs supported on PF is 64. Together, all VFs can have a total of 64 VLANs. (Intel limitation.)</p><p>SR-IOV (i40evf)</p><p>Maximum VLANs: The maximum number of VLANs supported on PF is 512. Together, all VFs can have a total of 512 VLANs. (Intel limitation.) Per-VF resources are managed by the PF (host) device driver.</p></blockquote><h1 id="é™„å½•"><a href="#é™„å½•" class="headerlink" title="é™„å½•"></a>é™„å½•</h1><h2 id="ï¼ˆ1ï¼‰Virt-manager-è®¾ç½®è™šæœºçš„-CPU-æ¨¡å¼è¯´æ˜"><a href="#ï¼ˆ1ï¼‰Virt-manager-è®¾ç½®è™šæœºçš„-CPU-æ¨¡å¼è¯´æ˜" class="headerlink" title="ï¼ˆ1ï¼‰Virt-manager è®¾ç½®è™šæœºçš„ CPU æ¨¡å¼è¯´æ˜"></a>ï¼ˆ1ï¼‰Virt-manager è®¾ç½®è™šæœºçš„ CPU æ¨¡å¼è¯´æ˜</h2><p>Libvirt ä¸»è¦æ”¯æŒä¸‰ç§ CPU modeï¼š</p><ul><li>host-passthrough: libvirt ä»¤ KVM æŠŠå®¿ä¸»æœºçš„ CPU æŒ‡ä»¤é›†å…¨éƒ¨é€ä¼ ç»™è™šæ‹Ÿæœºã€‚å› æ­¤è™šæ‹Ÿæœºèƒ½å¤Ÿæœ€å¤§é™åº¦çš„ä½¿ç”¨å®¿ä¸»æœº CPU æŒ‡ä»¤é›†ï¼Œæ•…æ€§èƒ½æ˜¯æœ€å¥½çš„ã€‚ä½†æ˜¯åœ¨çƒ­è¿ç§»æ—¶ï¼Œå®ƒè¦æ±‚ç›®çš„èŠ‚ç‚¹çš„ CPU å’ŒæºèŠ‚ç‚¹çš„ä¸€è‡´ã€‚</li><li>host-model: libvirt æ ¹æ®å½“å‰å®¿ä¸»æœº CPU æŒ‡ä»¤é›†ä»é…ç½®æ–‡ä»¶ /usr/share/libvirt/cpu_map.xml é€‰æ‹©ä¸€ç§æœ€ç›¸é…çš„ CPU å‹å·ã€‚åœ¨è¿™ç§ mode ä¸‹ï¼Œè™šæ‹Ÿæœºçš„æŒ‡ä»¤é›†å¾€å¾€æ¯”å®¿ä¸»æœºå°‘ï¼Œæ€§èƒ½ç›¸å¯¹ host-passthrough è¦å·®ä¸€ç‚¹ï¼Œä½†æ˜¯çƒ­è¿ç§»æ—¶ï¼Œå®ƒå…è®¸ç›®çš„èŠ‚ç‚¹ CPU å’ŒæºèŠ‚ç‚¹çš„å­˜åœ¨ä¸€å®šçš„å·®å¼‚ã€‚</li><li>custom: è¿™ç§æ¨¡å¼ä¸‹è™šæ‹Ÿæœº CPU æŒ‡ä»¤é›†æ•°æœ€å°‘ï¼Œæ•…æ€§èƒ½ç›¸å¯¹æœ€å·®ï¼Œä½†æ˜¯å®ƒåœ¨çƒ­è¿ç§»æ—¶è·¨ä¸åŒå‹å· CPU çš„èƒ½åŠ›æœ€å¼ºã€‚æ­¤å¤–ï¼Œcustom æ¨¡å¼ä¸‹æ”¯æŒç”¨æˆ·æ·»åŠ é¢å¤–çš„æŒ‡ä»¤é›†ã€‚</li></ul><p>ä¸‰ç§ mode çš„æ€§èƒ½æ’åºæ˜¯ï¼šhost-passthrough &gt; host-model &gt; custom</p><p>å®é™…æ€§èƒ½å·®å¼‚ä¸å¤§ï¼š100%&gt; 95.84%&gt;94.73%</p><p>å¼•è‡ªï¼š<a href="http://wsfdl.com/openstack/2018/01/02/libvirt_cpu_mode.html">http://wsfdl.com/openstack/2018/01/02/libvirt_cpu_mode.html</a></p><h2 id="ï¼ˆ2ï¼‰æœ‰å…³ç½‘å¡æ¨¡å¼çš„è¯´æ˜"><a href="#ï¼ˆ2ï¼‰æœ‰å…³ç½‘å¡æ¨¡å¼çš„è¯´æ˜" class="headerlink" title="ï¼ˆ2ï¼‰æœ‰å…³ç½‘å¡æ¨¡å¼çš„è¯´æ˜"></a>ï¼ˆ2ï¼‰æœ‰å…³ç½‘å¡æ¨¡å¼çš„è¯´æ˜</h2><p>ä½¿ç”¨ virt-manager åˆ›å»ºè™šæ‹Ÿæœºï¼Œåœ¨æ·»åŠ ç½‘å¡æ—¶ï¼Œæœ‰ 3 ä¸­é€‰æ‹©ï¼Œåˆ†åˆ«æ˜¯ e1000, rtl8139, virtioã€‚</p><p>â€œrtl8139â€è¿™ä¸ªç½‘å¡æ¨¡å¼æ˜¯ qemu-kvm é»˜è®¤çš„æ¨¡æ‹Ÿç½‘å¡ç±»å‹ï¼ŒRTL8139 æ˜¯ Realtek åŠå¯¼ä½“å…¬å¸çš„ä¸€ä¸ª 10/100M ç½‘å¡ç³»åˆ—ï¼Œæ˜¯æ›¾ç»éå¸¸æµè¡Œï¼ˆå½“ç„¶ç°åœ¨çœ‹æ¥æœ‰ç‚¹å¤è€ï¼‰ä¸”å…¼å®¹æ€§å¥½çš„ç½‘å¡ï¼Œå‡ ä¹æ‰€æœ‰çš„ç°ä»£æ“ä½œç³»ç»Ÿéƒ½å¯¹ RTL8139 ç½‘å¡é©±åŠ¨çš„æä¾›æ”¯æŒã€‚</p><p>â€œe1000â€ç³»åˆ—æä¾› Intel e1000 ç³»åˆ—çš„ç½‘å¡æ¨¡æ‹Ÿï¼Œçº¯çš„ QEMUï¼ˆé qemu-kvmï¼‰é»˜è®¤å°±æ˜¯æä¾› Intel e1000 ç³»åˆ—çš„è™šæ‹Ÿç½‘å¡ã€‚</p><p>â€œvirtioâ€ ç±»å‹æ˜¯ qemu-kvm å¯¹åŠè™šæ‹ŸåŒ– IOï¼ˆvirtioï¼‰é©±åŠ¨çš„æ”¯æŒã€‚</p><p>è¿™ä¸‰ä¸ªç½‘å¡çš„æœ€å¤§åŒºåˆ«(æ­¤å¤„æŒ‡æœ€éœ€è¦å…³æ³¨çš„åœ°æ–¹)æ˜¯é€Ÿåº¦ï¼š</p><ul><li><p>rtl8139 10/100Mb/s</p></li><li><p>e1000 1Gb/s</p></li><li><p>virtio 10Gb/s</p></li></ul><p>æ³¨æ„ virtio æ˜¯å”¯ä¸€å¯ä»¥è¾¾åˆ° 10Gb/s çš„ã€‚</p><p>virtio æ˜¯ä¸€ç§ I/O åŠè™šæ‹ŸåŒ–è§£å†³æ–¹æ¡ˆï¼Œæ˜¯ä¸€å¥—é€šç”¨ I/O è®¾å¤‡è™šæ‹ŸåŒ–çš„ç¨‹åºï¼Œæ˜¯å¯¹åŠè™šæ‹ŸåŒ– Hypervisor ä¸­çš„ä¸€ç»„é€šç”¨ I/O è®¾å¤‡çš„æŠ½è±¡ã€‚æä¾›äº†ä¸€å¥—ä¸Šå±‚åº”ç”¨ä¸å„ Hypervisor è™šæ‹ŸåŒ–è®¾å¤‡ï¼ˆKVMï¼ŒXenï¼ŒVMware ç­‰ï¼‰ä¹‹é—´çš„é€šä¿¡æ¡†æ¶å’Œç¼–ç¨‹æ¥å£ï¼Œå‡å°‘è·¨å¹³å°æ‰€å¸¦æ¥çš„å…¼å®¹æ€§é—®é¢˜ï¼Œå¤§å¤§æé«˜é©±åŠ¨ç¨‹åºå¼€å‘æ•ˆç‡ã€‚</p><h2 id="ï¼ˆ3ï¼‰æœ‰å…³-MACVTAP"><a href="#ï¼ˆ3ï¼‰æœ‰å…³-MACVTAP" class="headerlink" title="ï¼ˆ3ï¼‰æœ‰å…³ MACVTAP"></a>ï¼ˆ3ï¼‰æœ‰å…³ MACVTAP</h2><p>ä»¥ä¸‹å†…å®¹æ¥è‡ªï¼š<a href="https://www.ibm.com/developerworks/cn/linux/1312_xiawc_linuxvirtnet/index.html">https://www.ibm.com/developerworks/cn/linux/1312_xiawc_linuxvirtnet/index.html</a></p><p>MACVTAP çš„å®ç°åŸºäºä¼ ç»Ÿçš„ MACVLANã€‚å’Œ TAP è®¾å¤‡ä¸€æ ·ï¼Œæ¯ä¸€ä¸ª MACVTAP è®¾å¤‡æ‹¥æœ‰ä¸€ä¸ªå¯¹åº”çš„ Linux å­—ç¬¦è®¾å¤‡ï¼Œå¹¶æ‹¥æœ‰å’Œ TAP è®¾å¤‡ä¸€æ ·çš„ IOCTL æ¥å£ï¼Œå› æ­¤èƒ½ç›´æ¥è¢« KVM/Qemu ä½¿ç”¨ï¼Œæ–¹ä¾¿åœ°å®Œæˆç½‘ç»œæ•°æ®äº¤æ¢å·¥ä½œã€‚å¼•å…¥ MACVTAP è®¾å¤‡çš„ç›®æ ‡æ˜¯ï¼šç®€åŒ–è™šæ‹ŸåŒ–ç¯å¢ƒä¸­çš„äº¤æ¢ç½‘ç»œï¼Œä»£æ›¿ä¼ ç»Ÿçš„ Linux TAP è®¾å¤‡åŠ  Bridge è®¾å¤‡ç»„åˆï¼ŒåŒæ—¶æ”¯æŒæ–°çš„è™šæ‹ŸåŒ–ç½‘ç»œæŠ€æœ¯ï¼Œå¦‚ 802.1 Qbgã€‚</p><p>MACVTAP è®¾å¤‡å’Œ VLAN è®¾å¤‡ç±»ä¼¼ï¼Œæ˜¯ä»¥ä¸€å¯¹å¤šçš„æ¯å­å…³ç³»å‡ºç°çš„ã€‚åœ¨ä¸€ä¸ªæ¯è®¾å¤‡ä¸Šå¯ä»¥åˆ›å»ºå¤šä¸ª MACVTAP å­è®¾å¤‡ï¼Œä¸€ä¸ª MACVTAP è®¾å¤‡åªæœ‰ä¸€ä¸ªæ¯è®¾å¤‡ï¼ŒMACVTAP å­è®¾å¤‡å¯ä»¥åšä¸ºæ¯è®¾å¤‡ï¼Œå†ä¸€æ¬¡åµŒå¥—çš„åˆ›å»º MACVTAP å­è®¾å¤‡ã€‚æ¯å­è®¾å¤‡ä¹‹é—´è¢«éšå«çš„æ¡¥æ¥èµ·æ¥ï¼Œæ¯è®¾å¤‡ç›¸å½“äºç°å®ä¸–ç•Œä¸­çš„äº¤æ¢æœº TRUNK å£ã€‚å®é™…ä¸Šå½“ MACVTAP è®¾å¤‡è¢«åˆ›å»ºå¹¶ä¸”æ¨¡å¼ä¸ä¸º Passthrough æ—¶ï¼Œå†…æ ¸éšå«çš„åˆ›å»ºäº† MACVLAN ç½‘ç»œï¼Œå®Œæˆè½¬å‘åŠŸèƒ½ã€‚MACVTAP è®¾å¤‡æœ‰å››ç§å·¥ä½œæ¨¡å¼ï¼šBridgeã€VEPAã€Privateï¼ŒPassthroughã€‚</p><p>Bridge æ¨¡å¼ä¸‹ï¼Œå®ƒå®Œæˆä¸ Bridge è®¾å¤‡ç±»ä¼¼åŠŸèƒ½ï¼Œæ•°æ®å¯ä»¥åœ¨å±äºåŒä¸€ä¸ªæ¯è®¾å¤‡çš„å­è®¾å¤‡é—´äº¤æ¢è½¬å‘ï¼Œè™šæ‹Ÿæœºç›¸å½“äºç®€å•æ¥å…¥äº†ä¸€ä¸ªäº¤æ¢æœºã€‚å½“å‰çš„ Linux å®ç°æœ‰ä¸€ä¸ªç¼ºé™·ï¼Œæ­¤æ¨¡å¼ä¸‹ MACVTAP å­è®¾å¤‡æ— æ³•å’Œ Linux Host é€šè®¯ï¼Œå³è™šæ‹Ÿæœºæ— æ³•å’Œ Host é€šè®¯ã€‚â€”-ç»éªŒè¯ï¼Œå±å®ã€‚</p><p>Passthrough æ¨¡å¼ä¸‹ï¼Œå†…æ ¸çš„ MACVLAN æ•°æ®å¤„ç†é€»è¾‘è¢«è·³è¿‡ï¼Œç¡¬ä»¶å†³å®šæ•°æ®å¦‚ä½•å¤„ç†ï¼Œä»è€Œé‡Šæ”¾äº† Host CPU èµ„æºã€‚</p><img src="/csr1kv-kvm-CentOS7/macvtap-ibm.png" class="" title="MACVTAP ç›´é€š vs PCI ç›´é€š"><p>MACVTAP Passthrough æ¦‚å¿µä¸ PCI Passthrough æ¦‚å¿µä¸åŒï¼Œä¸Šå›¾è¯¦ç»†è§£é‡Šäº†ä¸¤ç§æƒ…å†µçš„åŒºåˆ«ã€‚</p><p>PCI Passthrough é’ˆå¯¹çš„æ˜¯ä»»æ„ PCI è®¾å¤‡ï¼Œä¸ä¸€å®šæ˜¯ç½‘ç»œè®¾å¤‡ï¼Œç›®çš„æ˜¯è®© Guest OS ç›´æ¥ä½¿ç”¨ Host ä¸Šçš„ PCI ç¡¬ä»¶ä»¥æé«˜æ•ˆç‡ã€‚ä»¥ X86 å¹³å°ä¸ºä¾‹ï¼Œæ•°æ®å°†é€šè¿‡éœ€è¦ç¡¬ä»¶æ”¯æŒçš„ VT-D æŠ€æœ¯ä» Guest OS ç›´æ¥ä¼ é€’åˆ° Host ç¡¬ä»¶ä¸Šã€‚è¿™æ ·åšå›ºç„¶æ•ˆç‡å¾ˆé«˜ï¼Œä½†å› ä¸ºæ¨¡æ‹Ÿå™¨å¤±å»äº†å¯¹è™šæ‹Ÿç¡¬ä»¶çš„æ§åˆ¶ï¼Œéš¾ä»¥åŒæ­¥ä¸åŒ Host ä¸Šçš„ç¡¬ä»¶çŠ¶æ€ï¼Œå› æ­¤å½“å‰åœ¨ä½¿ç”¨ PCI Passthrough çš„æƒ…å†µä¸‹éš¾ä»¥åšåŠ¨æ€è¿ç§»ã€‚</p><p>MACVTAP Passthrough ä»…ä»…é’ˆå¯¹ MACVTAP ç½‘ç»œè®¾å¤‡ï¼Œç›®çš„æ˜¯ç»•è¿‡å†…æ ¸é‡Œ MACVTAP çš„éƒ¨åˆ†è½¯ä»¶å¤„ç†è¿‡ç¨‹ï¼Œè½¬è€Œäº¤ç»™ç¡¬ä»¶å¤„ç†ã€‚åœ¨è™šæ‹ŸåŒ–æ¡ä»¶ä¸‹ï¼Œæ•°æ®è¿˜æ˜¯ä¼šå…ˆåˆ°è¾¾æ¨¡æ‹Ÿå™¨ I/O å±‚ï¼Œå†è½¬å‘åˆ°ç¡¬ä»¶ä¸Šã€‚è¿™æ ·åšæ•ˆç‡æœ‰æŸå¤±ï¼Œä½†æ¨¡æ‹Ÿå™¨ä»ç„¶æ§åˆ¶è™šæ‹Ÿç¡¬ä»¶çš„çŠ¶æ€åŠæ•°æ®çš„èµ°å‘ï¼Œå¯ä»¥åšåŠ¨æ€è¿ç§»ã€‚</p><h2 id="ï¼ˆ4ï¼‰SR-IOV-ä»‹ç»"><a href="#ï¼ˆ4ï¼‰SR-IOV-ä»‹ç»" class="headerlink" title="ï¼ˆ4ï¼‰SR-IOV ä»‹ç»"></a>ï¼ˆ4ï¼‰SR-IOV ä»‹ç»</h2><p>å¦‚æœç½‘å¡æ”¯æŒ SRIOVï¼Œè¯·ä½¿ç”¨ SRIOV PCI Passthroughã€‚</p><img src="/csr1kv-kvm-CentOS7/nic-type-010.png" class="" title="nic-type-010"><p>è½¯ä»¶æ¨¡æ‹Ÿæ˜¯é€šè¿‡ Hypervisor å±‚æ¨¡æ‹Ÿè™šæ‹Ÿç½‘å¡ï¼Œå®ç°ä¸ç‰©ç†è®¾å¤‡å®Œå…¨ä¸€æ ·çš„æ¥å£ï¼Œè™šæ‹Ÿæœºæ“ä½œç³»ç»Ÿæ— é¡»ä¿®æ”¹å°±èƒ½ç›´æ¥é©±åŠ¨è™šæ‹Ÿç½‘å¡ï¼Œå…¶æœ€å¤§çš„ç¼ºç‚¹æ˜¯æ€§èƒ½ç›¸å¯¹è¾ƒå·®ï¼›</p><p>ç½‘å¡ç›´é€šæ”¯æŒè™šæ‹Ÿæœºç»•è¿‡ Hypervisor å±‚ï¼Œç›´æ¥è®¿é—®ç‰©ç† I/O è®¾å¤‡ï¼Œå…·æœ‰æœ€é«˜çš„æ€§èƒ½ï¼Œä½†æ˜¯åœ¨åŒä¸€æ—¶åˆ»ç‰©ç† I/O è®¾å¤‡åªèƒ½è¢«ä¸€ä¸ªè™šæ‹Ÿæœºç‹¬äº«ï¼›</p><p>SR-IOV æ˜¯ Intel åœ¨ 2007 å¹´æå‡ºçš„è§£å†³è™šæ‹ŸåŒ–ç½‘ç»œ I/O çš„ç¡¬ä»¶æŠ€æœ¯æ–¹æ¡ˆï¼Œè¯¥æŠ€æœ¯ä¸ä»…èƒ½å¤Ÿç»§æ‰¿ç½‘å¡ç›´é€šçš„é«˜æ€§èƒ½ä¼˜åŠ¿ï¼Œè€Œä¸”åŒæ—¶æ”¯æŒç‰©ç† I/O è®¾å¤‡çš„è·¨è™šæ‹Ÿæœºå…±äº«ï¼Œå…·æœ‰è¾ƒå¥½çš„åº”ç”¨å‰æ™¯ã€‚</p><p>åŸæ–‡é“¾æ¥ï¼š<a href="https://blog.csdn.net/lsz137105/article/details/100752930">https://blog.csdn.net/lsz137105/article/details/100752930</a></p><p>SR-IOVï¼ˆSingle Root I/O Virtualizationï¼‰æ˜¯ä¸€ä¸ªå°† PCIe è®¾å¤‡ï¼ˆå¦‚ç½‘å¡ï¼‰å…±äº«ç»™è™šæ‹Ÿæœºçš„æ ‡å‡†ï¼Œé€šè¿‡ä¸ºè™šæ‹Ÿæœºæä¾›ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ã€ä¸­æ–­ã€DMA æµï¼Œæ¥ç»•è¿‡ VMM å®ç°æ•°æ®è®¿é—®ã€‚</p><p>SR-IOV å¼•å…¥äº†ä¸¤ç§ PCIe functionsï¼š</p><ul><li>PFï¼ˆPhysical Functionï¼‰ï¼šåŒ…å«å®Œæ•´çš„ PCIe åŠŸèƒ½ï¼ŒåŒ…æ‹¬ SR-IOV çš„æ‰©å¼ èƒ½åŠ›ï¼Œè¯¥åŠŸèƒ½ç”¨äº SR-IOV çš„é…ç½®å’Œç®¡ç†ã€‚</li><li>VFï¼ˆVirtual Functionï¼‰ï¼šåŒ…å«è½»é‡çº§çš„ PCIe åŠŸèƒ½ã€‚æ¯ä¸€ä¸ª VF æœ‰å®ƒè‡ªå·±ç‹¬äº«çš„ PCI é…ç½®åŒºåŸŸï¼Œå¹¶ä¸”å¯èƒ½ä¸å…¶ä»– VF å…±äº«ç€åŒä¸€ä¸ªç‰©ç†èµ„æºã€‚</li></ul><p>SR-IOV ç½‘å¡é€šè¿‡å°† SR-IOV åŠŸèƒ½é›†æˆåˆ°ç‰©ç†ç½‘å¡ä¸Šï¼Œå°†å•ä¸€çš„ç‰©ç†ç½‘å¡è™šæ‹Ÿæˆå¤šä¸ª VF æ¥å£ï¼Œæ¯ä¸ª VF æ¥å£éƒ½æœ‰å•ç‹¬çš„è™šæ‹Ÿ PCIe é€šé“ï¼Œè¿™äº›è™šæ‹Ÿçš„ PCIe é€šé“å…±ç”¨ç‰©ç†ç½‘å¡çš„ PCIe é€šé“ã€‚æ¯ä¸ªè™šæ‹Ÿæœºå¯å ç”¨ä¸€ä¸ªæˆ–å¤šä¸ª VF æ¥å£ï¼Œè¿™æ ·è™šæ‹Ÿæœºå°±å¯ä»¥ç›´æ¥è®¿é—®è‡ªå·±çš„ VF æ¥å£ï¼Œè€Œä¸éœ€è¦ Hypervisor çš„åè°ƒå¹²é¢„ï¼Œä»è€Œå¤§å¹…æå‡ç½‘ç»œååæ€§èƒ½ã€‚</p><h2 id="ï¼ˆ5ï¼‰æ¢ç´¢è™šæ‹Ÿæœºè¿›ç¨‹"><a href="#ï¼ˆ5ï¼‰æ¢ç´¢è™šæ‹Ÿæœºè¿›ç¨‹" class="headerlink" title="ï¼ˆ5ï¼‰æ¢ç´¢è™šæ‹Ÿæœºè¿›ç¨‹"></a>ï¼ˆ5ï¼‰æ¢ç´¢è™šæ‹Ÿæœºè¿›ç¨‹</h2><p>æ¯ä¸€ä¸ªå®¢æˆ·æœºå°±æ˜¯å®¿ä¸»æœºä¸­çš„ä¸€ä¸ª QEMU è¿›ç¨‹ï¼Œè€Œä¸€ä¸ªå®¢æˆ·æœºçš„å¤šä¸ª vCPU å°±æ˜¯ä¸€ä¸ª QEMU è¿›ç¨‹ä¸­çš„å¤šä¸ªçº¿ç¨‹ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># ps -ef | grep qemu</span></span><br><span class="line"></span><br><span class="line">qemu      52595      1 99 10:37 ?        01:24:12 /usr/libexec/qemu-kvm -name csr1kv-1 -S -machine pc-i440fx-rhel7.0.0,accel=kvm,usb=off,dump-guest-core=off,mem-merge=off -cpu host -m 8192 -mem-prealloc -mem-path /dev/hugepages/libvirt/qemu/7-csr1kv-1 -realtime mlock=on -smp 8,sockets=8,cores=1,threads=1 -uuid 59581018-6387-49df-ab09-2bcf40fc12ba -no-user-config -nodefaults -chardev socket,id=charmonitor,path=/var/lib/libvirt/qemu/domain-7-csr1kv-1/monitor.sock,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=utc,driftfix=slew -global kvm-pit.lost_tick_policy=delay -no-hpet -no-shutdown -global PIIX4_PM.disable_s3=1 -global PIIX4_PM.disable_s4=1 -boot strict=on -device piix3-usb-uhci,id=usb,bus=pci.0,addr=0x1.0x2 -device virtio-serial-pci,id=virtio-serial0,bus=pci.0,addr=0x6 -drive file=/home/root/images/csr1000v-universalk9.17.02.01v.qcow2,format=qcow2,<span class="keyword">if</span>=none,id=drive-virtio-disk0 -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x7,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 -netdev tap,fd=26,id=hostnet0,vhost=on,vhostfd=28 -device virtio-net-pci,netdev=hostnet0,id=net0,mac=52:54:00:36:95:f0,bus=pci.0,addr=0x3 -chardev pty,id=charserial0 -device isa-serial,chardev=charserial0,id=serial0 -chardev socket,id=charchannel0,path=/var/lib/libvirt/qemu/channel/target/domain-7-csr1kv-1/org.qemu.guest_agent.0,server,nowait -device virtserialport,bus=virtio-serial0.0,nr=1,chardev=charchannel0,id=channel0,name=org.qemu.guest_agent.0 -chardev spicevmc,id=charchannel1,name=vdagent -device virtserialport,bus=virtio-serial0.0,nr=2,chardev=charchannel1,id=channel1,name=com.redhat.spice.0 -spice port=5900,addr=127.0.0.1,disable-ticketing,image-compression=off,seamless-migration=on -vga qxl -global qxl-vga.ram_size=67108864 -global qxl-vga.vram_size=67108864 -global qxl-vga.vgamem_mb=16 -global qxl-vga.max_outputs=1 -device vfio-pci,host=1d:00.0,id=hostdev1,bus=pci.0,addr=0x8 -device vfio-pci,host=3b:10.1,id=hostdev0,bus=pci.0,addr=0x4 -msg timestamp=on</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ virsh å‘½ä»¤æˆ– virt-manager å¼€å¯è™šæ‹Ÿæœºï¼Œæ˜¯é€šè¿‡è°ƒç”¨/usr/libexec/qemu-kvm å¹¶é™„å¸¦è™šæ‹Ÿé…ç½®çš„å‚æ•°ï¼Œæ¥å¼€å¯ qemu-kvm çš„è¿›ç¨‹ã€‚å¯ä»¥çœ‹åˆ°ä¸Šè¿°çš„å‚æ•°æ˜¯éå¸¸å¤æ‚çš„ï¼Œlibvirt æä¾› XML å‚æ•°è¿›è¡Œç®€åŒ–ã€‚</p><p>ps -efL | grep qemu å¯ä»¥åˆ—å‡ºæ‰€æœ‰çš„çº¿ç¨‹ï¼Œä½†æ˜¯è¾“å‡ºç¯‡å¹…å¾ˆé•¿ï¼Œä¸åœ¨æ­¤åˆ—å‡ºï¼›ä½¿ç”¨ pstree å¯åˆ—å‡ºå…¶çˆ¶è¿›ç¨‹ã€çº¿ç¨‹å…³ç³»ï¼Œå¦‚ä¸‹ï¼š</p><img src="/csr1kv-kvm-CentOS7/pstree-011.png" class="" title="Pstree"><p>virt-top å¯æŸ¥çœ‹è™šæœºè¿è¡ŒçŠ¶æ€å’Œèµ„æºåˆ©ç”¨ç‡ï¼š</p><p>[root@centos7 ~]# virt-top -1</p><img src="/csr1kv-kvm-CentOS7/virt-top-012.png" class="" title="Virt-top"><h1 id="å‚è€ƒèµ„æ–™è¿æ¥"><a href="#å‚è€ƒèµ„æ–™è¿æ¥" class="headerlink" title="å‚è€ƒèµ„æ–™è¿æ¥"></a>å‚è€ƒèµ„æ–™è¿æ¥</h1><ul><li><a href="https://cloud.tencent.com/developer/article/1703094">https://cloud.tencent.com/developer/article/1703094</a></li><li><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/performance_tuning_guide/index">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/performance_tuning_guide/index</a></li><li><a href="https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html-single/virtualization_tuning_and_optimization_guide/index">https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html-single/virtualization_tuning_and_optimization_guide/index</a></li><li><a href="https://computingforgeeks.com/how-to-create-and-configure-bridge-networking-for-kvm-in-linux/">https://computingforgeeks.com/how-to-create-and-configure-bridge-networking-for-kvm-in-linux/</a></li><li><a href="https://software.intel.com/content/www/us/en/develop/articles/configure-sr-iov-network-virtual-functions-in-linux-kvm.html">https://software.intel.com/content/www/us/en/develop/articles/configure-sr-iov-network-virtual-functions-in-linux-kvm.html</a></li></ul>]]></content>
    
    
    <summary type="html">æœ¬æ–‡æä¾›åœ¨ CentOS 7 ç‰ˆæœ¬ä¸Šå®‰è£… KVMï¼Œå¹¶å®‰è£…å’Œè®¾ç½® CSR 1000v/Catalyst 8000v çš„æŒ‡å—ï¼Œå†…å®¹åŒ…æ‹¬ SRIOVï¼ŒKVM è°ƒä¼˜ä»¥åŠ CSR1KV åˆå§‹åŒ–é…ç½®ç­‰å†…å®¹ã€‚</summary>
    
    
    
    
    <category term="CSR1000v" scheme="https://weiborao.github.io/tags/CSR1000v/"/>
    
    <category term="KVM" scheme="https://weiborao.github.io/tags/KVM/"/>
    
    <category term="SRIOV" scheme="https://weiborao.github.io/tags/SRIOV/"/>
    
    <category term="NetworkManager" scheme="https://weiborao.github.io/tags/NetworkManager/"/>
    
    <category term="Cisco" scheme="https://weiborao.github.io/tags/Cisco/"/>
    
  </entry>
  
</feed>
