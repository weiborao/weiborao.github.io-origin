{"meta":{"title":"Rao Weiboçš„åšå®¢","subtitle":"","description":"è®°å½•ä¸€äº›å·¥ä½œã€å­¦ä¹ ç›¸å…³çš„ç¬”è®°","author":"Rao Weibo","url":"https://weiborao.link","root":"/"},"pages":[],"posts":[{"title":"Traceroute æ¼æ´ï¼Ÿ","slug":"traceroute-vulnerability","date":"2021-12-16T13:25:41.000Z","updated":"2021-12-17T00:23:49.571Z","comments":true,"path":"traceroute-vulnerability.html","link":"","permalink":"https://weiborao.link/traceroute-vulnerability.html","excerpt":"","text":"æœ¬æ–‡å°†åˆ†æä¸€ç§åä¸ºå…è®¸Tracerouteæ¢æµ‹çš„æ¼æ´ï¼Œå¯¹å…¶åˆ¤å®šæ–¹æ³•è¿›è¡Œè¿½æŸ¥ï¼Œå¹¶æå‡ºå»ºè®®ã€‚ èƒŒæ™¯æœ€è¿‘ï¼Œç¬”è€…åœ¨åšä¸€ä¸ªç½‘ç»œè®¾å¤‡æ–¹é¢çš„å®‰å…¨åˆè§„æ€§çš„æµ‹è¯•ï¼Œå…¶ä¸­æœ‰ä¸€é¡¹æ˜¯éœ€è¦ä½¿ç”¨æ¼æ´æ‰«æè®¾å¤‡å¯¹è¢«æµ‹è¯•çš„è®¾å¤‡è¿›è¡Œå…¨é¢çš„å®‰å…¨æ¼æ´æ‰«æã€‚åœ¨ç¬”è€…å¯¹è¢«æµ‹è®¾å¤‡è¿›è¡Œäº†é’ˆå¯¹æ€§çš„å®‰å…¨åŠ å›ºåï¼Œæ¼æ´æ‰«ææŠ¥å‘Šä»ç„¶æœ‰ä¸€ä¸ªä½å±æ¼æ´ï¼šå…è®¸Tracerouteæ¢æµ‹ã€‚è¯¥ä½å±æ¼æ´çš„è¯¦ç»†ä¿¡æ¯å¦‚ä¸‹ï¼š éœ€è¦è¯´æ˜çš„ä¸€ç‚¹æ˜¯ï¼Œæ‰«æå™¨å¦‚éœ€æˆåŠŸæ‰«æåˆ°è¯¥è®¾å¤‡ï¼Œè¿™ä¸ªè®¾å¤‡çš„IPåœ°å€è¦æ±‚èƒ½è¢«æ‰«æå™¨æ¢æµ‹åˆ°ï¼Œå¦åˆ™æ‰«æå™¨ä¼šè®¤ä¸ºè®¾å¤‡ä¸åœ¨çº¿ã€‚é€šå¸¸çš„åšæ³•å°±æ˜¯å…è®¸Pingï¼Œå…·ä½“è€Œè¨€ï¼Œè¢«æµ‹è®¾å¤‡è‡³å°‘è¦å…è®¸ICMP Echo Requestè¯·æ±‚ï¼Œå¹¶åº”ç­”ICMP Echo Replyã€‚ ç¬”è€…åœ¨è¢«æµ‹è¯•è®¾å¤‡çš„æ¥å£ä¸Šé…ç½®äº†ACLï¼Œå…¥å‘ä»…å…è®¸ICMP Echo RequestæŠ¥æ–‡ï¼Œå‡ºå‘ä»…å…è®¸ICMP Echo Replyï¼Œä½†æ˜¯æ‰«æç»“æœä¾ç„¶åˆ¤æ–­è¢«æµ‹è®¾å¤‡å…è®¸Tracerouteæ¢æµ‹ã€‚ å¯¹æ­¤ï¼Œç¬”è€…ç–‘æƒ‘ä¸å·²ï¼Œä¸‹æ–‡å°†å±•å¼€æ€è€ƒå’Œåˆ†æã€‚ å¯¹æ¼æ´çš„è§£è¯» è¯¦ç»†æè¿°ï¼šä½¿ç”¨Tracerouteæ¢æµ‹æ¥è·å–æ‰«æå™¨ä¸è¿œç¨‹ä¸»æœºä¹‹é—´çš„è·¯ç”±ä¿¡æ¯ã€‚æ”»å‡»è€…ä¹Ÿå¯ä»¥åˆ©ç”¨è¿™äº›ä¿¡æ¯æ¥äº†è§£ç›®æ ‡ç½‘ç»œçš„ç½‘ç»œæ‹“æ‰‘ã€‚ è§£è¯»ï¼šå¦‚æœæ‰«æå™¨ä¸è¢«æµ‹è¯•è®¾å¤‡å¤„äºåŒä¸€ç½‘æ®µï¼Œé‚£ä¹ˆæ‰«æå™¨ï¼ˆå……å½“æ”»å‡»è€…è§’è‰²ï¼‰ä¸è¢«æµ‹è®¾å¤‡ä¹‹é—´çš„ç½‘ç»œæ‹“æ‰‘å®é™…æ˜¯å·²çŸ¥çš„ï¼Œå³é€šè¿‡äºŒå±‚äº¤æ¢ç½‘ç»œäº’è”ï¼›æ ¹æœ¬ä¸éœ€è¦ä½¿ç”¨Tracerouteæ¥è·å–è·¯ç”±ä¿¡æ¯ã€ç½‘ç»œæ‹“æ‰‘ã€‚æŒ‰ç…§ç¬”è€…ä¹‹å‰çš„æ–‡ç« ã€Šé€šè¿‡Wiresharké‡æ–°è®¤è¯†Tracerouteã€‹çš„åˆ†æï¼Œå¦‚æœé’ˆå¯¹åŒä¸€ä¸ªç½‘æ®µçš„ä¸»æœºè¿›è¡ŒTracerouteï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªTTL=1çš„UDPæŠ¥æ–‡å‘é€åˆ°è¯¥åœ°å€åï¼Œç«‹åˆ»ä¼šæ”¶åˆ°Port-Unreachableçš„ICMPæŠ¥æ–‡ã€‚å¦‚æœæ˜¯Windowsç³»ç»Ÿï¼Œtracertä¼šå‘é€TTL=1 çš„ICMP Echo Requestï¼Œä½†æ˜¯åŒä¸€ç½‘æ®µçš„åœ°å€åªæ˜¯ä¼šç®€å•çš„å›å¤ä¸€ä¸ªICMP Echo Replyçš„æŠ¥æ–‡ï¼Œå°±å®£å‘Šç»“æŸã€‚ä¸ç®¡å‘é€UDPæŠ¥æ–‡è¿˜æ˜¯ICMPæŠ¥æ–‡ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¸ä¼šå‡ºç°TTLè¶…æ—¶çš„æƒ…å†µï¼Œä¹Ÿå°±ä¸ä¼šæ”¶åˆ°TTL Exceededçš„ICMPæŠ¥æ–‡ã€‚ è§£å†³åŠæ³•ï¼šåœ¨é˜²ç«å¢™ä¸­ç¦ç”¨Time Exceededç±»å‹çš„ICMPåŒ…ã€‚ æ¨ç†ï¼šæ ¹æ®è§£å†³åŠæ³•çš„å®šä¹‰æ¨ç†ï¼šå¦‚æœé˜²ç«å¢™ç¦ç”¨äº†Time Exceededç±»å‹çš„ICMPæŠ¥æ–‡ï¼Œè¯¥æ¼æ´å°±å¾—åˆ°è§£å†³ï¼Œé‚£ä¹ˆæ‰«æç»“æœä¸­å°±ä¸ä¼šå‡ºç°å…è®¸Tracerouteæ¢æµ‹çš„æ¼æ´ã€‚ä¹Ÿå¯ä»¥è¯´ï¼Œå¦‚æœæ‰«æå™¨æ²¡æœ‰æ¥æ”¶åˆ°Time Exceededç±»å‹çš„ICMPåŒ…ï¼Œä¹Ÿå°±æ²¡æœ‰å‘ç°Tracerouteçš„è¯æ®ï¼Œé‚£ä¹ˆï¼Œæ‰«æç»“æœä¸­ä¸èƒ½å‡ºç°å…è®¸Tracerouteæ¢æµ‹çš„æ¼æ´ã€‚ ç»¼åˆä¸Šè¿°çš„åˆ†æï¼Œç¬”è€…è®¤ä¸ºï¼Œä¾æ®æ¼æ´çš„è§£å†³åŠæ³•è¿›è¡Œæ¨ç†ï¼Œå¦‚æœæ‰«æå™¨ä¸è¢«æµ‹è®¾å¤‡åœ¨åŒä¸€ç½‘æ®µï¼Œæ‰«æè¿‡ç¨‹ä¸­ä¸ä¼šæ”¶åˆ°TTL Exceededçš„ICMPåŒ…ï¼Œä¸èƒ½å¾—å‡ºè¢«æµ‹è®¾å¤‡å…è®¸Tracerouteæ¢æµ‹è¿™ä¸ªç»“è®ºçš„ã€‚ ç®€è¨€ä¹‹ï¼Œæ‰«æå™¨å¯¹äºè¯¥æ¼æ´çš„åˆ¤å®šåŸåˆ™ä¸å…¶æä¾›çš„è§£å†³åŠæ³•å¹¶ä¸åŒ¹é…ã€‚ æ¼æ´åˆ¤å®šæ–¹æ³•çš„è¿½æŸ¥ä¸ºäº†è¿½æŸ¥æ‰«æå™¨åˆ°åº•å¦‚ä½•åˆ¤å®šè¯¥æ¼æ´ï¼Œç¬”è€…è¯·è´Ÿè´£æ¼æ´æ‰«æçš„å·¥ç¨‹å¸ˆè®¾æ³•è¿›è¡ŒæŠ“åŒ…ï¼Œå°†æ‰«æè¿‡ç¨‹ä¸­æ‰«æå™¨å‘é€/æ¥æ”¶çš„æŠ¥æ–‡è¿›è¡Œå…¨é‡æŠ“å–ã€‚å°†æŠ“å–åˆ°çš„æŠ¥æ–‡è¿›è¡Œåˆ†æï¼Œæœ‰å¦‚ä¸‹å‘ç°ï¼š æ‰«æå™¨å¯¹è¢«æµ‹è®¾å¤‡å‘èµ·éšæœºçš„TCPç«¯å£æ‰«æï¼Œå› ç¬”è€…è¿›è¡Œäº†å®‰å…¨åŠ å›ºï¼Œè¢«æµ‹è®¾å¤‡æ²¡æœ‰å›å¤ä»»ä½•ä¸€ä¸ªTCPæŠ¥æ–‡ï¼› æ‰«æå™¨å¯¹è¢«æµ‹è®¾å¤‡å‘èµ·å…¶ä»–å¸¸è§åè®®çš„æ‰«æï¼Œä¾‹å¦‚SNMPã€SIPã€NTPã€TFTPç­‰ï¼Œå‡æœªå¾—åˆ°å“åº”ï¼› æ‰«æå™¨å¯¹è¢«æµ‹è®¾å¤‡å‘èµ·åŸºäºUDPæŠ¥æ–‡çš„Tracerouteæ¢æµ‹ï¼Œé€ä¸€å‘é€TTL=1ã€2ã€3çš„UDPæŠ¥æ–‡ï¼ŒUDPç«¯å£å·ä¸º32768ï¼Œæœªå¾—åˆ°å“åº”ï¼› æ‰«æå™¨å¯¹è¢«æµ‹è®¾å¤‡å‘èµ·åŸºäºICMPçš„Tracerouteæ¢æµ‹ï¼Œå¾—åˆ°ICMP Echo Replyçš„å›åŒ…ï¼Œå¦‚ä¸‹å›¾ï¼š æ³¨ï¼šæ‰«æå™¨åœ°å€ä¸º192.168.100.11ï¼Œè¢«æµ‹è®¾å¤‡åœ°å€ä¸º192.168.99.101ï¼Œå…¶ä¸­éš”ç€ä¸€ä¸ªè®¾å¤‡192.168.100.101ï¼Œå‡ä¸ºåŒä¸€ç³»åˆ—çš„ä¸¤ä¸ªä¸åŒå‹å·çš„äº§å“ï¼Œä¸¤ä¸ªè®¾å¤‡çš„è½¯ä»¶ç‰ˆæœ¬ç›¸åŒã€‚ ç¬”è€…è®¾æ³•å°†TTL=1å’ŒTTL=2çš„æŠ¥æ–‡è¿›è¡Œäº†è¿‡æ»¤ï¼Œä½†æ˜¯è¿˜æœ‰TTL=3çš„æŠ¥æ–‡ç»§ç»­å‘é€è¿‡æ¥ã€‚ æŒ‰ç…§ä¸Šè¿°çš„æŠ“åŒ…åˆ†ææ¥åˆ†æï¼Œåˆ¤å®šåŸåˆ™ä¼¼ä¹æ˜¯é€ä¸€å‘é€TTL=1ã€2ã€â€¦â€¦Nï¼Œï¼ˆN&gt;=3ï¼‰çš„ICMP Echo RequestæŠ¥æ–‡ï¼ŒæœŸæœ›å›å¤TTL Exceededçš„æŠ¥æ–‡ï¼Œå®é™…å›å¤ICMP Echo ReplyæŠ¥æ–‡ï¼Œç«Ÿç„¶ä¹Ÿåˆ¤å®šä¸ºå…è®¸Tracerouteæ¢æµ‹ã€‚ ç¬”è€…å»æ‰å®‰å…¨åŠ å›ºçš„ç­–ç•¥ï¼Œé‡æ–°è¿›è¡Œæ‰«æï¼ŒæŠ“å–æ‰«æå™¨çš„æ”¶å‘æŠ¥æ–‡ï¼Œå¦‚ä¸‹ï¼š åœ¨è¯¥å›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ™°çš„çœ‹åˆ°ä¸­é—´çš„è®¾å¤‡192.168.100.101å‘é€çš„TTL ExceededæŠ¥æ–‡ï¼Œä»è€Œè®©æ‰«æå™¨æ¢æµ‹åˆ°å…¶ä¸è¿œç¨‹ä¸»æœºä¹‹é—´çš„è·¯ç”±ä¿¡æ¯ï¼Œç½‘ç»œæ‹“æ‰‘ä¿¡æ¯ï¼ˆå‘ç°äº†ä¸­é—´è®¾å¤‡ï¼‰ã€‚ ##å»ºè®® é€šè¿‡ä¸Šè¿°çš„åˆ†æï¼Œæˆ‘ä»¬å¾—å‡ºç»“è®ºï¼š è¯¥æ¼æ´æ‰«æç¨‹åºçš„åˆ¤å®šåŸåˆ™ä¸å…¶æä¾›çš„è§£å†³åŠæ³•ä¸åŒ¹é…ï¼Œå³æŒ‰ç…§è§£å†³åŠæ³•æ•´æ”¹åï¼Œä¾ç„¶ä¼šæ‰«æå‡ºå…è®¸Tracerouteæ¢æµ‹çš„æ¼æ´ã€‚ é€šè¿‡æŠ“åŒ…åˆ†æï¼Œæˆ‘ä»¬å‘ç°å…¶åˆ¤å®šåŸåˆ™å­˜åœ¨ä¸åˆç†ä¹‹å¤„ï¼Œå³æ‰«æè¿‡ç¨‹ä¸­é€šè¿‡å‘é€TTL=1ã€2ã€3â€¦â€¦çš„æŠ¥æ–‡ï¼ŒæœŸæœ›å›å¤ICMP TTL Exceededï¼Œç„¶è€Œåœ¨å›å¤äº†ICMP Echo Replyï¼Œä»ç„¶ä¼šåˆ¤å®šä¸ºæœ‰è¯¥æ¼æ´ã€‚ æ‰§è¡Œè¯¥æ¼æ´æ‰«ææ—¶ï¼Œä¸èƒ½å°†æ‰«æå™¨ä¸è¢«æµ‹è®¾å¤‡è¿›è¡ŒåŒç½‘æ®µç›´è¿ï¼Œè¿™æ ·è¢«æµ‹è®¾å¤‡ä¸ä¼šè¿”å›ICMP TTL ExceededæŠ¥æ–‡ã€‚ å»ºè®®ï¼š ä¿®æ”¹åˆ¤å®šåŸåˆ™ï¼Œä½¿å…¶ä¸è§£å†³åŠæ³•ç›¸åŒ¹é…ï¼› æ‰§è¡Œè¯¥æ¼æ´æ‰«ææ—¶ï¼Œéœ€è¦åœ¨æ‰«æå™¨å’Œè¢«æµ‹è®¾å¤‡ä¹‹é—´è‡³å°‘å¢åŠ ä¸€ä¸ªè·¯ç”±è®¾å¤‡ï¼ˆå¯ä¸ºåŒæ¬¾æµ‹è¯•è®¾å¤‡ï¼‰ï¼Œä»¥ä¾¿çœŸå®çš„åæ˜ å‡ºTracerouteçš„åŠŸèƒ½ã€‚","categories":[],"tags":[{"name":"traceroute","slug":"traceroute","permalink":"https://weiborao.link/tags/traceroute/"},{"name":"icmp","slug":"icmp","permalink":"https://weiborao.link/tags/icmp/"}]},{"title":"æœ‰å…³AnyCast","slug":"anycast-brief","date":"2021-07-06T06:00:00.000Z","updated":"2021-07-06T06:10:58.348Z","comments":true,"path":"anycast-brief.html","link":"","permalink":"https://weiborao.link/anycast-brief.html","excerpt":"","text":"AnyCastï¼Œä¸€ç»„æœåŠ¡å™¨æ‹¥æœ‰ç›¸åŒçš„IPåœ°å€ï¼Œå½“å®¢æˆ·ç«¯è®¿é—®è¯¥ç»„æœåŠ¡å™¨æ—¶ï¼Œç½‘ç»œä¼šå°†è¯·æ±‚å‘é€è‡³æœ€è¿‘çš„æœåŠ¡å™¨è¿›è¡Œå¤„ç†ï¼Œä»è€Œæå¤§çš„ç¼©çŸ­é€”å¾„çš„å…¬ç½‘è·¯å¾„ï¼Œå‡å°‘å»¶æ—¶ã€æŠ–åŠ¨ã€ä¸¢åŒ…çš„æƒ…å†µã€‚ AnyCasté€šå¸¸å’ŒBGPè·¯ç”±åè®®å…³è”åœ¨ä¸€èµ·ï¼Œå…¶å®ç°çš„ä¸»è¦åŸç†æ˜¯ï¼šä½äºä¸åŒåœ°ç†ä½ç½®çš„è·¯ç”±å™¨å‘å¤–å‘å¸ƒåŒä¸€æ®µIPç½‘æ®µçš„BGPè·¯ç”±ï¼Œè·¯ç”±åœ¨Internetä¸­ä¼ æ’­åï¼Œè®¿é—®å‘èµ·ç«¯æ‰€å¤„ç½‘ç»œçš„è·¯ç”±å™¨ä¼šé€‰æ‹©æœ€çŸ­çš„BGP AS Pathè·¯ç”±ï¼Œä»è€Œå®ç°æœ€çŸ­è·¯å¾„çš„è®¿é—®ã€‚å¦‚æœBGPé€‰è·¯åŒºåˆ†ä¸å‡ºæœ€è¿‘çš„è·¯å¾„ï¼Œé‚£å°±ç”±IGPæœ€çŸ­è·¯å¾„è¿›è¡Œè½¬å‘ã€‚ AnyCastçš„å¥½å¤„ï¼š å°±è¿‘è®¿é—®ï¼Œå‡å°‘æ—¶å»¶ã€æå‡æ€§èƒ½ è·å¾—é«˜å†—ä½™æ€§å’Œå¯ç”¨æ€§ï¼Œå³å½“ä»»æ„ç›®çš„èŠ‚ç‚¹å¼‚å¸¸æ—¶ï¼Œå¯è‡ªåŠ¨è·¯ç”±åˆ°å°±è¿‘ç›®çš„èŠ‚ç‚¹ å®ç°è´Ÿè½½å‡è¡¡ï¼Œä¸”å¯¹å®¢æˆ·ç«¯æ˜¯é€æ˜çš„ï¼ˆç”±ç½‘ç»œè·¯ç”±å®ç°ï¼‰ ç¼“è§£DDOSæ”»å‡»ï¼ŒAnyCastå°†DDOSæ”»å‡»æµé‡å¼•å¯¼è‡³æœ¬åœ°æœåŠ¡å™¨ï¼Œæå¤§çš„å‡å°‘äº†DDOSæµé‡çš„èŒƒå›´ä»¥åŠè§„æ¨¡ Office 365 çš„SharePointä½¿ç”¨äº†AnyCastï¼Œä¾‹å¦‚nslookup è§£æcisco.sharepoint.comã€citrix.sharepoint.comã€intel.sharepoint.com å¾—åˆ°ç›¸åŒçš„åœ°å€ 12345678910âœ ~ nslookup cisco.sharepoint.com | tail -n 2 | grep AddressAddress: 13.107.136.9âœ ~ nslookup citrix.sharepoint.com | tail -n 2 | grep AddressAddress: 13.107.136.9âœ ~ nslookup intel.sharepoint.com | tail -n 2 | grep AddressAddress: 13.107.136.9âœ ~ nslookup nike.sharepoint.com | tail -n 2 | grep AddressAddress: 13.107.136.9âœ ~ nslookup bmw.sharepoint.com | tail -n 2 | grep AddressAddress: 13.107.136.9 Telnet è‡³ route-views3.routeviews.org æŸ¥è¯¢13.107.136.9çš„è·¯ç”±ï¼Œå‘ç°è¯¥åœ°å€å‘½ä¸­çš„è·¯ç”±æ˜¯13.107.136.0/24ï¼Œä»AS 8068 â€“ AS 8075å‘å¸ƒå‡ºæ¥ï¼Œè¿™éƒ½æ˜¯Microsoftçš„ASå·ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194route-views3.routeviews.org&gt; show bgp ipv4 13.107.136.9BGP routing table entry for 13.107.136.0&#x2F;24Paths: (40 available, best #33, table default) Not advertised to any peer 61568 8075 8068 190.15.124.18 from 190.15.124.18 (190.15.124.18) Origin IGP, valid, external Last update: Mon Jul 5 21:13:03 2021 202365 49697 8075 8068 194.50.19.4 from 194.50.19.4 (185.1.166.50) Origin IGP, valid, external Community: 49697:3000 65101:1002 65102:1000 65103:276 65104:150 Last update: Sun Jul 4 17:31:02 2021 39120 8075 8068 89.21.210.85 from 89.21.210.85 (195.60.191.13) Origin IGP, valid, external Last update: Sat Jul 3 20:46:17 2021 40630 6939 8075 8068 208.94.118.10 from 208.94.118.10 (208.94.118.10) Origin IGP, valid, external Community: 40630:100 40630:11701 Last update: Mon Jul 5 19:14:13 2021 54574 8075 8068 154.18.7.114 from 154.18.7.114 (193.41.248.191) Origin IGP, valid, external Community: 54574:1000 Last update: Wed Jun 30 02:40:58 2021 39120 8075 8068 89.21.210.86 from 89.21.210.86 (195.60.190.28) Origin IGP, valid, external Last update: Mon Jun 28 17:54:55 2021 64116 7195 8075 8068 45.183.45.1 from 45.183.45.1 (10.7.1.1) Origin IGP, valid, external Community: 7195:1000 7195:1001 7195:1300 7195:1302 Last update: Fri Jul 2 00:44:52 2021 54574 6461 8075 8068 38.19.140.162 from 38.19.140.162 (193.41.248.193) Origin IGP, valid, external Community: 6461:5997 54574:2000 54574:6461 Last update: Mon Jun 28 07:19:51 2021 39351 8075 8068 193.138.216.164 from 193.138.216.164 (193.138.216.164) Origin IGP, valid, external Last update: Fri Jun 25 20:17:33 2021 202365 57866 8075 8068 5.255.90.109 from 5.255.90.109 (185.255.155.66) Origin IGP, metric 0, valid, external Community: 57866:12 57866:304 57866:501 Large Community: 57866:41441:41441 Last update: Sun Jun 27 19:25:03 2021 3216 12389 8075 8068 195.239.252.124 from 195.239.252.124 (195.239.252.124) Origin IGP, valid, external Community: 3216:1000 3216:1077 3216:1101 Last update: Thu Jun 24 09:16:54 2021 3216 12389 8075 8068 195.239.77.236 from 195.239.77.236 (195.239.77.236) Origin IGP, valid, external Community: 3216:1000 3216:1077 3216:1101 Last update: Thu Jun 24 09:14:17 2021 11537 8075 8068 64.57.28.241 from 64.57.28.241 (64.57.28.241) Origin IGP, metric 17, valid, external Community: 11537:254 11537:3500 11537:5000 11537:5002 11537:5014 Last update: Thu Jun 24 08:50:42 2021 19653 8075 8068 67.219.192.5 from 67.219.192.5 (67.219.192.5) Origin IGP, valid, external Last update: Wed Jun 30 11:14:51 2021 14315 6453 6453 8075 8068 104.251.122.1 from 104.251.122.1 (104.251.122.1) Origin IGP, valid, external Community: 14315:5000 Last update: Tue Jun 22 10:36:25 2021 38136 38008 8075 8068 103.152.35.22 from 103.152.35.22 (103.152.35.22) Origin IGP, valid, external Community: 38008:103 65521:10 Large Community: 38136:1000:11 Last update: Tue Jun 22 07:22:58 2021 17920 6939 8075 8068 103.149.144.251 from 103.149.144.251 (103.149.144.251) Origin IGP, valid, external Community: 17920:1000 17920:1008 Last update: Sat Jun 19 01:43:19 2021 50236 34549 8075 8068 2.56.9.2 from 2.56.9.2 (2.56.9.2) Origin IGP, valid, external Community: 34549:200 34549:10000 50236:10010 Last update: Thu Jun 17 16:09:18 2021 3280 39737 8075 8068 77.83.243.7 from 77.83.243.7 (77.83.243.7) Origin IGP, valid, external Community: 39737:80 39737:2040 Last update: Sat Jul 3 23:45:54 2021 39120 8075 8068 94.101.60.146 from 94.101.60.146 (94.161.60.146) Origin IGP, valid, external Last update: Fri Jun 18 15:06:50 2021 207740 58057 8075 8068 136.243.0.23 from 136.243.0.23 (136.243.0.23) Origin IGP, valid, external Last update: Tue Jun 22 18:11:37 2021 38136 50131 53340 174 8075 8068 172.83.155.50 from 172.83.155.50 (172.83.155.50) Origin IGP, valid, external Large Community: 38136:1000:17 Last update: Tue Jun 8 08:24:12 2021 40387 11537 8075 8068 72.36.126.8 from 72.36.126.8 (72.36.126.8) Origin IGP, valid, external Community: 40387:1400 Last update: Tue Jun 8 07:02:44 2021 38136 57695 8075 8068 170.39.224.212 from 170.39.224.212 (170.39.224.212) Origin IGP, valid, external Community: 57695:12000 57695:12002 Large Community: 38136:1000:1 Last update: Thu May 27 15:18:00 2021 3561 209 3356 8075 8068 206.24.210.80 from 206.24.210.80 (206.24.210.80) Origin IGP, valid, external Last update: Thu May 27 09:50:45 2021 29479 50304 8075 8068 109.233.62.1 from 109.233.62.1 (109.233.62.2) Origin IGP, valid, external Last update: Thu May 27 09:50:11 2021 209 3356 8075 8068 205.171.8.123 from 205.171.8.123 (205.171.8.123) Origin IGP, metric 8000051, valid, external Community: 209:88 209:888 3356:3 3356:22 3356:86 3356:575 3356:666 3356:901 3356:2057 3356:12341 Last update: Thu May 27 09:48:26 2021 14840 8075 8068 186.211.128.32 from 186.211.128.32 (201.16.22.1) Origin IGP, valid, external Community: 14840:10 14840:40 14840:6004 14840:7110 Last update: Wed Jun 23 00:56:13 2021 209 3356 8075 8068 205.171.200.245 from 205.171.200.245 (205.171.200.245) Origin IGP, metric 0, valid, external Community: 209:88 209:888 3356:3 3356:22 3356:86 3356:575 3356:666 3356:901 3356:2059 3356:10327 Last update: Thu May 27 09:48:23 2021 209 3356 8075 8068 205.171.3.54 from 205.171.3.54 (205.171.3.54) Origin IGP, metric 8000036, valid, external Community: 209:88 209:888 3356:3 3356:22 3356:86 3356:575 3356:666 3356:901 3356:2011 3356:11918 Last update: Thu May 27 09:48:17 2021 23367 8075 8068 64.250.124.251 from 64.250.124.251 (64.250.124.251) Origin IGP, valid, external Last update: Thu May 27 09:48:06 2021 5650 8075 8068 74.40.7.35 from 74.40.7.35 (74.40.0.100) Origin IGP, metric 0, valid, external Last update: Tue May 25 23:52:37 2021 38001 8075 8068 202.150.221.33 from 202.150.221.33 (10.11.33.29) Origin IGP, valid, external, best (Older Path) Community: 38001:420 38001:2406 38001:3001 38001:8009 Last update: Fri May 21 11:01:01 2021 6939 8075 8068 64.71.137.241 from 64.71.137.241 (216.218.252.164) Origin IGP, valid, external Last update: Fri May 21 10:58:51 2021 45352 8075 8068 210.5.41.225 from 210.5.41.225 (210.5.40.186) Origin IGP, valid, external Last update: Fri May 21 10:57:46 2021 3292 8075 8068 195.215.109.247 from 195.215.109.247 (83.88.49.1) Origin IGP, valid, external Community: 3292:1100 3292:24500 3292:24580 Last update: Wed Jun 9 23:59:27 2021 3257 8075 8068 89.149.178.10 from 89.149.178.10 (213.200.83.26) Origin IGP, metric 10, valid, external Community: 3257:4000 3257:8052 3257:50001 3257:50110 3257:54900 3257:54901 Last update: Fri Jul 2 03:36:10 2021 46450 8075 8068 158.106.197.135 from 158.106.197.135 (158.106.197.135) Origin IGP, valid, external Community: 46450:31111 Last update: Fri May 21 10:53:55 2021 5645 8075 8068 206.248.155.130 from 206.248.155.130 (206.248.155.130) Origin IGP, valid, external Community: no-advertise Last update: Fri May 21 10:53:54 2021 55222 8075 8068 162.211.99.255 from 162.211.99.255 (162.211.99.255) Origin IGP, valid, external Community: 55222:101 55222:200 55222:6001 55222:20020 Last update: Fri May 21 10:53:45 2021 AnyCast å…¸å‹åº”ç”¨åœºæ™¯ï¼š DNSï¼š CDN è´Ÿè½½å‡è¡¡ åˆ†æ•£DDOSæ”»å‡» Referenceï¼š https://www.cnblogs.com/itzgr/p/10192799.html https://www.imperva.com/blog/how-anycast-works/","categories":[],"tags":[{"name":"anycast","slug":"anycast","permalink":"https://weiborao.link/tags/anycast/"}]},{"title":"åœ¨Dockerå®¹å™¨ä¸­tcpdumpæŠ“åŒ…æ¢ç§˜Traceroute","slug":"docker-traceroute-tcpdump","date":"2021-06-29T07:20:00.000Z","updated":"2021-06-29T14:19:26.631Z","comments":true,"path":"docker-traceroute-tcpdump.html","link":"","permalink":"https://weiborao.link/docker-traceroute-tcpdump.html","excerpt":"","text":"åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ã€Šé€šè¿‡Wiresharké‡æ–°è®¤è¯†Tracerouteã€‹ä¸­ï¼Œæˆ‘åœ¨MACç”µè„‘ä¸Šè¿›è¡ŒæŠ“åŒ…æ¥å¯¹MACä¸Šçš„Tracerouteè¿‡ç¨‹è¿›è¡Œåˆ†æã€‚ä½†æ˜¯MACç”µè„‘ä¸Šè¿è¡Œäº†å¤šä¸ªåº”ç”¨ï¼Œæˆ‘åœ¨æŠ“å®ŒæŠ¥æ–‡åï¼Œä½¿ç”¨è¿‡æ»¤å™¨å°†å…¶ä»–æŠ¥æ–‡è¿‡æ»¤æ‰äº†ï¼Œä½†æ˜¯ä¹Ÿå¾ˆå¯èƒ½æŠŠTracerouteäº§ç”Ÿçš„æŠ¥æ–‡ç»™åˆ æ‰äº†ã€‚ ä¸ºäº†æ‰“é€ ä¸€ä¸ªçº¯å‡€çš„Tracerouteç¯å¢ƒï¼Œæˆ‘åˆä½¿ç”¨å®¹å™¨æ¥åšä¸€æ¬¡æµ‹è¯•ã€‚ æœ¬æ–‡è®°å½•ä»¥ä¸‹å†…å®¹ï¼š åˆ›å»ºä¸€ä¸ªåŒ…å«tracerouteã€pingã€whoisç­‰å·¥å…·çš„å®¹å™¨ï¼Œå–åtraceroute åˆ›å»ºä¸€ä¸ªåªåŒ…å«tcpdumpçš„å®¹å™¨ï¼Œå¯¹tracerouteå®¹å™¨æŠ“åŒ… ç®€ç•¥çš„åˆ†ææŠ“åŒ…æ–‡ä»¶â€”-ä¸æ˜¯æœ¬æ–‡é‡ç‚¹ åˆ›å»ºTracerouteå®¹å™¨é•œåƒDockerfileå‡†å¤‡å¦‚æœæˆ‘ä»¬æ‰§è¡Œdocker run -it ubuntuï¼Œæƒ³åœ¨è¯¥å®¹å™¨ä¸­æ‰§è¡Œpingã€tracerouteå‘½ä»¤ï¼ŒæŠ±æ­‰ï¼Œæ‰¾ä¸åˆ°è¯¥å‘½ä»¤ã€‚ 1234567âœ docker pull ubuntuâœ docker run -it --rm ubunturoot@631c227046f7:/# ping 8.8.8.8bash: ping: command not foundroot@631c227046f7:/# traceroute 8.8.8.8bash: traceroute: command not foundroot@631c227046f7:/# è¿™æ—¶å€™ï¼Œæ‚¨å¯ä»¥ç›´æ¥åœ¨å®¹å™¨é‡Œæ‰§è¡Œï¼š 1root@631c227046f7:/# apt-get update &amp;&amp; apt-get install traceroute iputils-ping --no-install-recommends å½“ç„¶ï¼Œæ‚¨ä¹Ÿå¯ä»¥åˆ›å»ºä¸€ä¸ªå®¹å™¨é•œåƒï¼Œå¦‚ä¸‹ï¼š 123mkdir traceroutecd traceroutetouch Dockerfile Dockerfile å†…å®¹å¦‚ä¸‹ï¼š 12345678910FROM ubuntu:latestRUN apt-get update &amp;&amp; apt-get install -y \\ traceroute \\ iputils-ping \\ whois \\ netbase \\ iproute2 \\ --no-install-recommends \\ &amp;&amp; rm -rf &#x2F;var&#x2F;lib&#x2F;apt&#x2F;lists&#x2F;* æ³¨ï¼šä¸Šè¿°è¦å®‰è£…çš„è½¯ä»¶åŒ…ï¼Œæ˜¯æˆ‘ç»è¿‡å°è¯•åï¼Œä¸€ä¸ªä¸ªå¢åŠ çš„ã€‚ æœ€å¼€å§‹æˆ‘åªå®‰è£…äº†tracerouteï¼Œå½“æˆ‘æ‰§è¡Œtraceroute -A 8.8.8.8æ—¶ï¼Œæç¤ºå¦‚ä¸‹é”™è¯¯ä¿¡æ¯ï¼š 1whois.radb.net/nicname: Servname not supported for ai_socktype æˆ‘æƒ³èµ·tracerouteå¯èƒ½éœ€è¦è°ƒç”¨whoisæ¥æŸ¥è¯¢BGP ASå·ï¼Œäºæ˜¯æˆ‘ç»§ç»­å®‰è£…whoisï¼Œä»ç„¶æŠ¥é”™ã€‚â€”-ç»è¿‡éªŒè¯ï¼Œå¦‚æœä¸å®‰è£…whoisè½¯ä»¶åŒ…ï¼Œtraceroute -A 8.8.8.8 å¯æ­£å¸¸å·¥ä½œã€‚ åªèƒ½åœ¨ç½‘ä¸Šæœç´¢ç­”æ¡ˆäº†ï¼Œæœç„¶æœ‰äººé‡åˆ°è¿‡ç±»ä¼¼é—®é¢˜ï¼š 123https://stackoverflow.com/questions/56430294/bash-script-that-uses-whois-command-gets-servname-not-supported-error-on-doè§£å†³åŠæ³•ï¼šapt-get update &amp;&amp; apt-get install -y --no-install-recommends netbase å®‰è£…iproute2çš„ç›®çš„æ˜¯ä¸ºäº†æ‰§è¡Œip a, ip link è¿™äº›å‘½ä»¤ã€‚ æ ¹æ®Dockerfileåˆ›å»ºå®¹å™¨é•œåƒæ ¹æ®ä¸Šè¿°çš„Dockerfileåˆ›å»ºå®¹å™¨é•œåƒï¼Œæ‰§è¡Œå‘½ä»¤ï¼šdocker image build -t traceroute:latest . æ³¨æ„æœ«å°¾çš„å°ç‚¹ï¼Œè¡¨ç¤ºå½“å‰ç›®å½•ã€‚ 1234567891011121314151617âœ traceroute docker image build -t traceroute:latest .[+] Building 48.7s (6/6) FINISHED =&gt; [internal] load build definition from Dockerfile 0.0s =&gt; =&gt; transferring dockerfile: 274B 0.0s =&gt; [internal] load .dockerignore 0.0s =&gt; =&gt; transferring context: 2B 0.0s =&gt; [internal] load metadata for docker.io/library/ubuntu:latest 0.0s =&gt; CACHED [1/2] FROM docker.io/library/ubuntu:latest 0.0s =&gt; [2/2] RUN apt-get update &amp;&amp; apt-get install -y traceroute iputils-ping whois netbase iproute2 --no-ins 48.5s =&gt; exporting to image 0.1s =&gt; =&gt; exporting layers 0.1s =&gt; =&gt; writing image sha256:bbf499e59136872e8d171fddcd1548497a9e76b96d154dcb340b8326252d97d5 0.0s =&gt; =&gt; naming to docker.io/library/traceroute:latest 0.0s âœ traceroute docker imagesREPOSITORY TAG IMAGE ID CREATED SIZEtraceroute latest bbf499e59136 5 seconds ago 77.4MB å¦‚ä½•æŠ“å–å®¹å™¨çš„ç½‘ç»œæŠ¥æ–‡æ¥ä¸‹æ¥ï¼Œéœ€è¦è€ƒè™‘çš„é—®é¢˜æ˜¯åœ¨MACç”µè„‘ä¸Šå¦‚ä½•æŠ“å–å®¹å™¨çš„ç½‘ç»œæŠ¥æ–‡å‘¢ï¼Ÿ Wireshark on macOSå¦‚ä½•æŠ“åŒ…ï¼Ÿæˆ‘æ‰§è¡Œäº†docker run -it â€“name traceroute traceroute å¯åŠ¨äº†ä¸€ä¸ªåä¸ºtracertouteçš„å®¹å™¨ï¼Œæ‰“å¼€Wiresharkï¼Œå“ªä¸€ä¸ªæ¥å£å¯¹åº”çš„æ˜¯è¿™ä¸ªå®¹å™¨çš„æ¥å£å‘¢ï¼Ÿ ä¸Šé¢çš„æ¥å£çœ¼èŠ±ç¼­ä¹±çš„ï¼Œæ‰¾ä¸å‡ºæ˜¯å“ªä¸€ä¸ªæ¥å£ï¼Œen0å’Œlo0ä¸Šæœ‰æµé‡ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯å®¹å™¨è¿æ¥çš„ç«¯å£ï¼Œåªå¾—å¯»æ±‚å…¶ä»–æ–¹æ³•ã€‚ åŸºäº Container ç½‘ç»œå…±äº«æœºåˆ¶æ¥æŠ“åŒ…é€šè¿‡æœç´¢â€how to tcpdump in dockerâ€ï¼Œæ‰¾åˆ°ä¸€ç¯‡æ–‡ç« How to TCPdump effectively in Dockerï¼Œè·ç›ŠåŒªæµ…ã€‚ è¯¥æ–‡ç« ä»‹ç»äº†ä¸€ç§Dockerçš„ç½‘ç»œæ¨¡å¼ï¼Œcontaineræ¨¡å¼ã€‚ In the --net=container:id all traffic in/out a specific container (or group of containers) can be captured. å¦ä¸€ç¯‡æ–‡ç« ï¼šhttps://www.freeaihub.com/article/container-module-in-docker-network.html Dockerç½‘ç»œcontaineræ¨¡å¼æ˜¯æŒ‡ï¼Œåˆ›å»ºæ–°å®¹å™¨çš„æ—¶å€™ï¼Œé€šè¿‡--net containerå‚æ•°ï¼ŒæŒ‡å®šå…¶å’Œå·²ç»å­˜åœ¨çš„æŸä¸ªå®¹å™¨å…±äº«ä¸€ä¸ª Network Namespaceã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå³æ–¹é»„è‰²æ–°åˆ›å»ºçš„containerï¼Œå…¶ç½‘å¡å…±äº«å·¦è¾¹å®¹å™¨ã€‚å› æ­¤å°±ä¸ä¼šæ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„ IPï¼Œè€Œæ˜¯å…±äº«å·¦è¾¹å®¹å™¨çš„ IP 172.17.0.2,ç«¯å£èŒƒå›´ç­‰ç½‘ç»œèµ„æºï¼Œä¸¤ä¸ªå®¹å™¨çš„è¿›ç¨‹é€šè¿‡ lo ç½‘å¡è®¾å¤‡é€šä¿¡ã€‚ ä½†è¿™ä¸¤ä¸ªå®¹å™¨åœ¨å…¶ä»–çš„èµ„æºä¸Šï¼Œå¦‚æ–‡ä»¶ç³»ç»Ÿã€è¿›ç¨‹åˆ—è¡¨ç­‰è¿˜æ˜¯éš”ç¦»çš„ã€‚ ä¸“é—¨åˆ›å»ºä¸€ä¸ªå®‰è£…äº†tcpdumpçš„å®¹å™¨ï¼Œå¯¹ä¸Šæ–‡åˆ›å»ºçš„tracerouteå®¹å™¨è¿›è¡ŒæŠ“åŒ…ã€‚ å‚è€ƒHow to TCPdump effectively in Dockerï¼Œåœ¨Terminalä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œåˆ›å»ºä¸€ä¸ªtcpdumpçš„å®¹å™¨é•œåƒ 12345docker build -t tcpdump - &lt;&lt;EOF FROM ubuntu RUN apt-get update &amp;&amp; apt-get install -y tcpdump CMD tcpdump -i eth0 -w /var/traceroute-ubuntu.pcapngEOF åˆ›å»ºè¿‡ç¨‹å¦‚ä¸‹ï¼š 123456789101112[+] Building 0.1s (6&#x2F;6) FINISHED &#x3D;&gt; [internal] load build definition from Dockerfile 0.0s &#x3D;&gt; &#x3D;&gt; transferring dockerfile: 159B 0.0s &#x3D;&gt; [internal] load .dockerignore 0.0s &#x3D;&gt; &#x3D;&gt; transferring context: 2B 0.0s &#x3D;&gt; [internal] load metadata for docker.io&#x2F;library&#x2F;ubuntu:latest 0.0s &#x3D;&gt; [1&#x2F;2] FROM docker.io&#x2F;library&#x2F;ubuntu 0.0s &#x3D;&gt; CACHED [2&#x2F;2] RUN apt-get update &amp;&amp; apt-get install -y tcpdump 0.0s &#x3D;&gt; exporting to image 0.0s &#x3D;&gt; &#x3D;&gt; exporting layers 0.0s &#x3D;&gt; &#x3D;&gt; writing image sha256:d5d8942d4836fabbb0343a082d9aa0009c6dd5071c70a54ae57baf6728462562 0.0s &#x3D;&gt; &#x3D;&gt; naming to docker.io&#x2F;library&#x2F;tcpdump 0.0s é•œåƒåˆ—è¡¨ï¼š 12345âœ traceroute docker imagesREPOSITORY TAG IMAGE ID CREATED SIZEtcpdump latest d5d8942d4836 3 minutes ago 109MBtraceroute latest bbf499e59136 35 minutes ago 77.4MBubuntu latest 9873176a8ff5 11 days ago 72.7MB å¯åŠ¨tracerouteå®¹å™¨ï¼š 12âœ docker run -it --name traceroute tracerouteroot@fbe3eb98ae63:/# å¯åŠ¨tcpdumpå®¹å™¨ï¼Œè¿›è¡ŒæŠ“åŒ…ï¼š 12âœ ~ docker run -it --net=container:traceroute tcpdumptcpdump: listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes åœ¨tracerouteå®¹å™¨å‘èµ·tracerouteï¼š 1234567891011121314151617root@fbe3eb98ae63:/# traceroute -A -q 1 -N 1 -z 500 -e 8.8.8.8traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets 1 localhost (172.17.0.1) [*] 0.129 ms 2 localhost (10.39.101.1) [*] 3.716 ms 3 localhost (192.168.1.1) [*] 3.926 ms 4 222.129.32.1 (222.129.32.1) [AS4808] 6.837 ms 5 61.148.163.181 (61.148.163.181) [AS4808] 9.247 ms 6 219.232.11.65 (219.232.11.65) [AS17431] 7.049 ms 7 61.149.203.205 (61.149.203.205) [AS4808] 7.650 ms 8 219.158.7.22 (219.158.7.22) [AS4837] 40.815 ms 9 219.158.103.218 (219.158.103.218) [AS4837] 64.771 ms10 219.158.103.30 (219.158.103.30) [AS4837] 50.402 ms11 219.158.10.30 (219.158.10.30) [AS4837] 53.261 ms12 219.158.33.174 (219.158.33.174) [AS4837] 55.503 ms13 108.170.241.65 (108.170.241.65) [AS15169] 54.876 ms14 142.251.64.173 (142.251.64.173) [AS15169] 45.966 ms15 dns.google (8.8.8.8) [AS15169] 52.492 ms traceroute -A -q 1 -N 1 -z 500 -e 8.8.8.8 å‚æ•°è§£é‡Šå¦‚ä¸‹ï¼š -Aï¼š å‘radb.netæŸ¥æ‰¾å¯¹åº”èŠ‚ç‚¹IPæ‰€åœ¨çš„AS Pathä¿¡æ¯ï¼Œå¹¶å°†æŸ¥è¯¢ä¿¡æ¯è¾“å‡º -q 1ï¼š å°†ç¼ºçœå‘é€3ä¸ªæ¢æµ‹åŒ…æ”¹ä¸º1ä¸ª -N 1ï¼š å°†å¹¶å‘16ä¸ªæ¢æµ‹æ”¹ä¸ºä¸€æ¬¡ä¸€ä¸ªï¼Œä»¥ä¾¿äºé€ä¸ªåˆ†æ -z 500ï¼š è¡¨ç¤ºæ¯æ¬¡ç­‰å¾…500æ¯«ç§’å†å‘å‡ºä¸‹ä¸€ä¸ªæ¢æµ‹ -eï¼š æ˜¾ç¤ºICMPçš„æ‰©å±•æ¶ˆæ¯ï¼Œå¦‚æœæœ‰çš„è¯ æŒ‰ä¸‹CTRL+Cï¼Œåœæ­¢tcpdumpå®¹å™¨çš„æŠ“åŒ…ï¼š 12345âœ ~ docker run -it --net=container:traceroute tcpdumptcpdump: listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes^C237 packets captured237 packets received by filter0 packets dropped by kernel è¯¥å®¹å™¨åœ¨æŠ“å®ŒåŒ…åè‡ªåŠ¨åœæ­¢ï¼Œå¹¶å°†æŠ“åŒ…æ–‡ä»¶å­˜å‚¨åœ¨å®¹å™¨å†…éƒ¨çš„/var/traceroute-ubuntu.pcapngï¼Œé€šè¿‡docker cpå‘½ä»¤å°†æŠ“åŒ…æ–‡ä»¶æ‹·è´å‡ºæ¥ã€‚ 12345âœ ~ docker ps -aCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMESf397f50267ae tcpdump &quot;/bin/sh -c &#x27;tcpdumpâ€¦&quot; 2 minutes ago Exited (130) 20 seconds ago condescending_corifbe3eb98ae63 traceroute &quot;bash&quot; 48 minutes ago Up 48 minutes tracerouteâœ ~ docker cp f397f50267ae:/var/traceroute-ubuntu.pcapng ./ ç®€ç•¥åˆ†ææŠ“åŒ…æ–‡ä»¶ä»¥ä¸‹æ˜¯æœ¬æ¬¡æŠ“å–çš„237ä¸ªæŠ¥æ–‡çš„å¤´36ä¸ªæŠ¥æ–‡ï¼Œå¦‚ä¸‹ï¼š ä¸Šå›¾ä¸­ï¼ŒWireshareç›´æ¥åˆ†æå‡ºæ¥WhoisæŠ¥æ–‡ã€‚ è¿‡ç¨‹æ¦‚è¿°å¦‚ä¸‹ï¼š å‘8.8.8.8å‘èµ·UDPæŠ¥æ–‡ï¼Œç›®çš„ç«¯å£ä¸º33434ï¼ŒTTLè®¾ç½®ä¸º1 æ”¶åˆ°è·¯ç”±å™¨çš„ICMP TTLè¶…æ—¶æ¶ˆæ¯ï¼Œè·å–è·¯ç”±å™¨å¯¹åº”çš„IPåœ°å€ å°è¯•å‘DNSæœåŠ¡å™¨æŸ¥è¯¢è·¯ç”±å™¨IPåœ°å€çš„åå‘åŸŸåè§£æï¼Œå¦‚æœå¾—åˆ°åŸŸåï¼Œå°±å°†å…¶æ˜¾ç¤ºåœ¨Tracerouteçš„è¾“å‡ºç»“æœä¸­ã€‚ å‘èµ·DNSæŸ¥è¯¢ï¼ŒæŸ¥è¯¢whois.radb.netåŸŸåï¼Œå¾—åˆ°åº”ç­”ä¸º198.108.0.18 å‘èµ·TCPè¿æ¥è¯·æ±‚ï¼Œä¸198.108.0.18å»ºç«‹TCPè¿æ¥ã€‚ å‘whois.radb.netå‘èµ·æŸ¥è¯¢ï¼Œè¯¢é—®è·¯ç”±å™¨IPåœ°å€å¯¹åº”çš„ASå·ï¼Œå¹¶å¾—åˆ°å›åº”ï¼Œå¦‚æœæ˜¯ç§æœ‰åœ°å€ï¼Œå…¶ASå·ä¸º0ã€‚ é‡å¤ä¸Šè¿°ç¬¬1ã€2ã€3ã€6æ­¥ï¼Œæ¯æ¬¡å°†TTLåŠ 1ï¼Œç›´è‡³ç›®æ ‡åœ°å€æ¥æ”¶åˆ°æ¢æµ‹æŠ¥æ–‡ï¼Œå¹¶è¿”å›ICMP Port Unreachableæ¶ˆæ¯ã€‚ æŠ“åŒ…æ–‡ä»¶ä¸‹è½½ ç•ªå¤–ç¯‡ThousandEyesçš„ä»‹ç»å¯å‚è€ƒè¿™ç¯‡æ–‡ç« ã€Šåœ¨AWSä¸Šéƒ¨ç½²TE Agentå¹¶è¿›è¡Œæµ‹è¯•ã€‹ã€‚ ThousandEyeså¯å°†æ¢é’ˆéƒ¨ç½²åˆ°å®¹å™¨ä¸­ï¼Œè€Œä¸”å®‰è£…ååˆ†ç®€å•ï¼Œä»ThousandEyesçš„Cloud &amp; Enterprise Agentsä¸­ï¼Œé€‰æ‹©Agent Settingsï¼Œå†é€‰æ‹©Enterprise Agentsï¼Œå†ç‚¹å‡»Add New Enterprise Agentï¼Œåˆ‡æ¢åˆ°Dockerè¿™ä¸ªTABã€‚ å°†ä¸‹é¢çš„æ–‡å­—å¤åˆ¶ç²˜è´´åˆ°Terminalç»ˆç«¯ï¼š 1234567891011121314151617181920docker pull thousandeyes/enterprise-agent &gt; /dev/null 2&gt;&amp;1docker stop &#x27;TEagent&#x27; &gt; /dev/null 2&gt;&amp;1docker rm &#x27;TEagent&#x27; &gt; /dev/null 2&gt;&amp;1docker run \\ --hostname=&#x27;TEagent&#x27; \\ --memory=2g \\ --memory-swap=2g \\ --detach=true \\ --tty=true \\ --shm-size=512M \\ -e TEAGENT_ACCOUNT_TOKEN=lje1co39qi 8b5oviy \\ -e TEAGENT_INET=4 \\ -v &#x27;/Users/werao/thousandeyes/TEagent/te-agent&#x27;:/var/lib/te-agent \\ -v &#x27;/Users/werao/thousandeyes/TEagent/te-browserbot&#x27;:/var/lib/te-browserbot \\ -v &#x27;/Users/werao/thousandeyes/TEagent/log/&#x27;:/var/log/agent \\ --cap-add=NET_ADMIN \\ --cap-add=SYS_ADMIN \\ --name &#x27;TEagent&#x27; \\ --restart=unless-stopped \\ thousandeyes/enterprise-agent /sbin/my_init å®‰è£…å®Œåï¼ŒThousandEyeså³å¯ä½¿ç”¨è¯¥Agentè¿›è¡Œæµ‹è¯•äº†ã€‚ åˆ›å»ºä¸€ä¸ªç®€å•çš„æ¢æµ‹å¦‚ä¸‹ï¼š åœ¨ThousandEyesçš„ç•Œé¢ï¼Œå¯è§‚æµ‹ä¸Šè¿°çš„æ¢æµ‹ç»“æœï¼š æ—¶å»¶æ¯”è¾ƒç¨³å®šï¼Œç»´æŒåœ¨50mså·¦å³ã€‚ è·¯å¾„å¯è§†åŒ–åˆ†æä¸­ï¼Œå½“æˆ‘ä»¬æŠŠé¼ æ ‡è½åœ¨æŸä¸ªèŠ‚ç‚¹ä¸Šï¼Œç½‘é¡µä¼šå¼¹å‡ºäº¤äº’å¼çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š ç½‘ç»œå‰ç¼€ä¿¡æ¯ï¼Œå¦‚ï¼š124.65.192.0/18 è¿è¥å•†ASä¿¡æ¯ï¼Œå¦‚ï¼šCNCGROUP Beijing Province (AS 4808) åœ°ç†ä½ç½®ï¼Œå¦‚ï¼šBeijing, Beijing, China DSCP å¹³å‡æ—¶å»¶ï¼ŒæŒ‡ä»æ¢æµ‹çš„Agentåˆ°å¯¹åº”èŠ‚ç‚¹çš„å¹³å‡æ—¶å»¶ ThousandEyesçš„æ¢é’ˆæ‰€æ”¶é›†çš„æ•°æ®æ˜¯å¸¸è§„çš„ç½‘ç»œå·¥å…·éƒ½èƒ½æ”¶é›†åˆ°çš„ï¼ŒThousandEyesçš„å¹³å°å¯¹æ”¶é›†åˆ°çš„æ•°æ®è¿›è¡Œå­˜å‚¨ã€åˆ†æã€äº¤å‰å…³è”ï¼Œä¸ºç”¨æˆ·çš„æ•°å­—ä½“éªŒæä¾›å…¨æ–¹ä½çš„æ´è§ã€‚ æœ¬èŠ‚æ˜¯çªå‘å¥‡æƒ³çš„å†…å®¹ï¼Œæ•…è€Œæ”¾åˆ°ç•ªå¤–ç¯‡ã€‚ å…¨æ–‡å®Œã€‚","categories":[],"tags":[{"name":"traceroute","slug":"traceroute","permalink":"https://weiborao.link/tags/traceroute/"},{"name":"docker","slug":"docker","permalink":"https://weiborao.link/tags/docker/"},{"name":"tcpdump","slug":"tcpdump","permalink":"https://weiborao.link/tags/tcpdump/"}]},{"title":"é€šè¿‡Wiresharké‡æ–°è®¤è¯†Traceroute","slug":"get-known-traceroute-by-wireshark","date":"2021-06-27T06:50:00.000Z","updated":"2021-06-28T06:15:06.568Z","comments":true,"path":"get-known-traceroute-by-wireshark.html","link":"","permalink":"https://weiborao.link/get-known-traceroute-by-wireshark.html","excerpt":"","text":"åˆè¯†TracerouteTracerouteæ˜¯ä¸€ç§å¸¸è§çš„ç½‘ç»œåˆ†æå·¥å…·ï¼Œç”¨äºæ¢æµ‹æ•°æ®åŒ…ä»æºåœ°å€åˆ°ç›®çš„åœ°å€ç»è¿‡çš„è·¯ç”±å™¨çš„IPåœ°å€ã€‚ ä»¥ä¸‹çš„ç¤ºä¾‹æ˜¾ç¤ºä»ä¸€ä¸ªMACç”µè„‘åˆ°8.8.8.8çš„è·¯å¾„æ¢æµ‹ç»“æœï¼š 123456789101112131415161718192021222324252627282930313233343536373839âœ ~ traceroute 8.8.8.8traceroute to 8.8.8.8 (8.8.8.8), 64 hops max, 52 byte packets 1 localhost (10.39.101.1) 8.662 ms 1.307 ms 1.155 ms 2 localhost (192.168.1.1) 2.287 ms 2.157 ms 1.897 ms 3 222.129.32.1 (222.129.32.1) 5.844 ms 13.092 ms 10.332 ms 4 114.244.95.105 (114.244.95.105) 7.541 ms 61.51.101.101 (61.51.101.101) 7.420 ms 61.148.163.81 (61.148.163.81) 7.075 ms 5 61.148.4.213 (61.148.4.213) 7.759 ms 219.232.11.65 (219.232.11.65) 5.976 ms bt-230-081.bta.net.cn (202.106.230.81) 6.021 ms 6 202.96.12.13 (202.96.12.13) 7.828 ms * * 7 219.158.112.26 (219.158.112.26) 39.486 ms * 219.158.7.22 (219.158.7.22) 45.959 ms 8 219.158.103.218 (219.158.103.218) 48.469 ms 219.158.97.2 (219.158.97.2) 47.146 ms 219.158.103.218 (219.158.103.218) 50.320 ms 9 219.158.103.30 (219.158.103.30) 50.739 ms 50.382 ms 48.348 ms10 219.158.10.30 (219.158.10.30) 49.927 ms 44.264 ms 56.353 ms11 219.158.33.174 (219.158.33.174) 54.123 ms 61.131 ms 47.302 ms12 108.170.241.97 (108.170.241.97) 56.082 ms 108.170.241.33 (108.170.241.33) 52.942 ms 54.393 ms13 142.250.58.189 (142.250.58.189) 48.958 ms 209.85.143.37 (209.85.143.37) 51.217 ms 108.170.226.115 (108.170.226.115) 141.544 ms14 dns.google (8.8.8.8) 48.935 ms 46.364 ms 51.043 msâœ ~ ping 8.8.8.8PING 8.8.8.8 (8.8.8.8): 56 data bytes64 bytes from 8.8.8.8: icmp_seq=0 ttl=113 time=52.060 ms64 bytes from 8.8.8.8: icmp_seq=1 ttl=113 time=44.845 ms64 bytes from 8.8.8.8: icmp_seq=2 ttl=113 time=52.393 ms64 bytes from 8.8.8.8: icmp_seq=3 ttl=113 time=51.059 ms64 bytes from 8.8.8.8: icmp_seq=4 ttl=113 time=44.437 ms64 bytes from 8.8.8.8: icmp_seq=5 ttl=113 time=44.534 ms^C--- 8.8.8.8 ping statistics ---6 packets transmitted, 6 packets received, 0.0% packet lossround-trip min/avg/max/stddev = 44.437/48.221/52.393/3.640 ms è¾“å‡ºç»“æœè¡¨æ˜ï¼š ä»MACç”µè„‘åˆ°8.8.8.8çš„è·¯å¾„åŒ…å«14ä¸ªç½‘ç»œèŠ‚ç‚¹ã€‚ æ¯ä¸ªèŠ‚ç‚¹åé¢éƒ½æ˜¾ç¤ºæ—¶å»¶ä¿¡æ¯ï¼Œè¡¨æ˜ä»MACç”µè„‘åˆ°è¯¥èŠ‚ç‚¹çš„å¾€è¿”æ—¶å»¶ã€‚æ‚¨å¯èƒ½ä¼šå‘ç°ï¼Œä¸­é—´çš„æŸäº›èŠ‚ç‚¹å¾€è¿”æ—¶å»¶å¯èƒ½è¦é«˜äºæ›´è¿œçš„èŠ‚ç‚¹çš„å¾€è¿”æ—¶å»¶ã€‚è¿™æ˜¯ç”±äºè¯¥æ—¶å»¶åŒ…å«äº†è·¯ç”±å™¨å°†TTL=0çš„æŠ¥æ–‡äº¤ç»™æ§åˆ¶é¢å¤„ç†çš„æ—¶å»¶ï¼Œå› è€Œå¾€å¾€æ¯”è·¯å¾„ä¸Šçš„ä¼ æ’­æ—¶å»¶è¦é«˜ï¼Œå°¤å…¶æ˜¯å½“æ§åˆ¶é¢CPUç¹å¿™æ—¶ã€‚Tracerouteå¯¹æ¯ä¸€ä¸ªèŠ‚ç‚¹å‘å‡º3ä¸ªæ¢æµ‹æŠ¥æ–‡ï¼Œæ¯ä¸ªæŠ¥æ–‡çš„è·¯å¾„ä¸å°½ç›¸åŒï¼Œä¾‹å¦‚åœ¨ç¬¬4ã€5ã€7ã€8ã€12ã€13è·³ç»è¿‡ä¸åŒçš„è·¯ç”±å™¨è½¬å‘ã€‚ æœ‰çš„æ¢æµ‹æ²¡æœ‰å¾—åˆ°å›åº”ï¼Œå› æ­¤åœ¨æœ‰çš„èŠ‚ç‚¹æœ¬åº”æ˜¾ç¤ºæ—¶å»¶ä¿¡æ¯çš„ï¼Œæ˜¾ç¤ºäº†*ã€‚è¿™å¹¶ä¸èƒ½æ–­å®šä¸­é—´çš„ç½‘ç»œä¸å¯è¾¾ï¼Œå¾ˆå¯èƒ½çš„åŸå› æ˜¯è¯¥èŠ‚ç‚¹çš„è·¯ç”±å™¨åœ¨æ¥å£ä¸Šé…ç½®äº† no ip unreachable å‘½ä»¤ï¼Œè¯¥æ¥å£ä¸å›åº”ICMP Unreachableæ¶ˆæ¯ï¼Œè€Œè¯¥æ¶ˆæ¯æ­£æ˜¯Tracerouteæ¢æµ‹è·¯å¾„æ‰€ä¾èµ–çš„ä¿¡æ¯æ¥æºã€‚ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç®€è¦æè¿°ä¸€ä¸‹ï¼Œåœ¨MACç”µè„‘ä¸‹ï¼ŒTracerouteçš„å·¥ä½œåŸç†ï¼Œå¹¶ä½¿ç”¨Wiresharkè¿›ä¸€æ­¥çš„æ¢ç©¶Tracerouteçš„å·¥ä½œè¿‡ç¨‹ã€‚ Tracerouteçš„å·¥ä½œåŸç†æ¯å½“IPæ•°æ®åŒ…ç»è¿‡ä¸€ä¸ªè·¯ç”±å™¨ï¼Œå…¶å­˜æ´»æ—¶é—´TTLå°±ä¼šå‡1ã€‚å½“å…¶å­˜æ´»æ—¶é—´æ˜¯0æ—¶ï¼Œä¸»æœºä¾¿å–æ¶ˆæ•°æ®åŒ…ï¼Œå¹¶å‘é€ä¸€ä¸ªICMP TTLè¶…æ—¶æ•°æ®åŒ…ç»™åŸæ•°æ®åŒ…çš„å‘å‡ºè€…ã€‚Tracerouteç¨‹åºé€šè¿‡å‘ç›®çš„åœ°å€å‘é€ä¸€ç³»åˆ—çš„æ¢æµ‹åŒ…ï¼Œè®¾ç½®æ¢æµ‹åŒ…çš„TTLåˆå§‹å€¼åˆ†åˆ«ä¸º1,2,3â€¦ï¼Œæ ¹æ®è¿”å›çš„è¶…æ—¶é€šçŸ¥ï¼ˆICMP Time Exceeded Messageï¼‰å¾—åˆ°æºåœ°å€ä¸ç›®çš„åœ°å€ä¹‹é—´çš„æ¯ä¸€è·³è·¯ç”±ä¿¡æ¯ã€‚ ä»æºåœ°å€å‘å‡ºä¸€ä¸ªUDPæ¢æµ‹åŒ…åˆ°ç›®çš„åœ°å€ï¼Œå¹¶å°†TTLè®¾ç½®ä¸º1ï¼› åˆ°è¾¾è·¯ç”±å™¨æ—¶ï¼Œå°†TTLå‡1ï¼› å½“TTLå˜ä¸º0æ—¶ï¼ŒåŒ…è¢«ä¸¢å¼ƒï¼Œè·¯ç”±å™¨å‘æºåœ°å€å‘å›ä¸€ä¸ªICMPè¶…æ—¶é€šçŸ¥ï¼ˆICMP Time Exceeded Messageï¼‰ï¼Œå†…å«å‘é€IPåŒ…çš„æºåœ°å€ï¼ŒIPåŒ…çš„æ‰€æœ‰å†…å®¹åŠè·¯ç”±å™¨çš„IPåœ°å€ï¼› å½“æºåœ°å€æ”¶åˆ°è¯¥ICMPåŒ…æ—¶ï¼Œæ˜¾ç¤ºè¿™ä¸€è·³è·¯ç”±ä¿¡æ¯ï¼› é‡å¤1ï½5ï¼Œå¹¶æ¯æ¬¡è®¾ç½®TTLåŠ 1ï¼› ç›´è‡³ç›®æ ‡åœ°å€æ”¶åˆ°æ¢æµ‹æ•°æ®åŒ…ï¼Œå¹¶è¿”å›ç«¯å£ä¸å¯è¾¾é€šçŸ¥ï¼ˆICMP Port Unreachableï¼‰ï¼› å½“æºåœ°å€æ”¶åˆ°ICMP Port UnreachableåŒ…æ—¶åœæ­¢tracerouteã€‚ ä»¥ä¸Šå†…å®¹å¼•è‡ªTraceroute/tracertåŸç†å’Œå®è·µ é€šè¿‡Wiresharkæ¢ç©¶Tracerouteåœ¨Tracerouteè¾“å‡ºç»“æœä¸­æ˜¾ç¤ºASå·åœ¨Macç”µè„‘çš„Tracerouteå‘½ä»¤ä¸­ï¼Œé€šè¿‡â€™-aâ€™çš„å‚æ•°å¯ä»¥å¼€å¯è·¯å¾„ä¸­é‡åˆ°çš„IPåœ°å€æ‰€åœ¨çš„BGP ASå·ï¼Œä»¥ä¾¿äºè·çŸ¥è·¯å¾„ä¸­æ¯ä¸€è·³æ‰€å½’å±çš„è¿è¥å•†ï¼Œé€šè¿‡â€™-q 1â€™å¯å°†ç¼ºçœå‘é€3ä¸ªæ¢æµ‹æŠ¥æ–‡æ”¹ä¸ºå‘é€1ä¸ªæ¢æµ‹æŠ¥æ–‡ï¼Œè¾“å‡ºç¤ºä¾‹å¦‚ä¸‹ï¼š 12345678910111213141516âœ ~ traceroute -aq 1 8.8.8.8traceroute to 8.8.8.8 (8.8.8.8), 64 hops max, 52 byte packets 1 [AS0] bogon (10.39.101.1) 2.424 ms 2 [AS0] localhost (192.168.1.1) 3.031 ms 3 [AS4808] 222.129.32.1 (222.129.32.1) 6.496 ms 4 [AS4808] 61.51.101.101 (61.51.101.101) 8.114 ms 5 [AS17431] 219.232.11.29 (219.232.11.29) 5.865 ms 6 [AS4808] 202.96.12.13 (202.96.12.13) 6.558 ms 7 [AS4837] 219.158.112.46 (219.158.112.46) 44.826 ms 8 [AS4837] 219.158.103.218 (219.158.103.218) 52.181 ms 9 [AS4837] 219.158.103.30 (219.158.103.30) 47.851 ms10 [AS4837] 219.158.10.30 (219.158.10.30) 56.963 ms11 [AS4837] 219.158.33.174 (219.158.33.174) 46.523 ms12 [AS15169] 108.170.241.1 (108.170.241.1) 48.503 ms13 [AS15169] 172.253.64.111 (172.253.64.111) 142.926 ms14 [AS15169] dns.google (8.8.8.8) 52.208 ms ä¸Šè¿°çš„ASç¼–å·ä¿¡æ¯æ˜¯å¦‚ä½•è·å¾—çš„ï¼Ÿä¸‹é¢æˆ‘ä»¬é€šè¿‡WiresharkæŠ“å–æŠ¥æ–‡è¿›è¡Œåˆ†æã€‚ ä¸Šè¿°Tracerouteçš„æ”¶å‘åŒ…è¿‡ç¨‹ç®€è¿°å¼€å¯Wiresharkï¼Œå¹¶è¿…é€Ÿæ‰§è¡Œtraceroute -aq 1 8.8.8.8ï¼ŒTracerouteå®Œæ•´è¾“å‡ºåï¼Œåœæ­¢Wiresharkçš„æŠ¥æ–‡æŠ“å–ã€‚é’ˆå¯¹æŠ“å–çš„æŠ¥æ–‡è¿›è¡Œè¿‡æ»¤ï¼Œåœ¨è¿‡æ»¤æ¡†ä¸­è¾“å…¥ udp or icmp or ip.addr == 198.108.0.18ç»è¿‡Wiresharkçš„æŠ¥æ–‡åˆ†æï¼Œä»¥ä¸‹ä¸ºTracerouteçš„ç®€è¦çš„æ”¶å‘åŒ…è¿‡ç¨‹ï¼š å‘èµ·DNSæŸ¥è¯¢ï¼ŒæŸ¥è¯¢whois.radb.netåŸŸåï¼Œå¾—åˆ°åº”ç­”ä¸º198.108.0.18â€”-ä¸Šè¿°è¿‡æ»¤å™¨ä¸­IPåœ°å€æ¥æºäºæ­¤ã€‚ å‘èµ·TCPè¿æ¥è¯·æ±‚ï¼Œä¸198.108.0.18å»ºç«‹TCPè¿æ¥ã€‚ å‘8.8.8.8å‘èµ·UDPæŠ¥æ–‡ï¼Œç›®çš„ç«¯å£ä¸º33435ï¼ŒTTLè®¾ç½®ä¸º1 æ”¶åˆ°è·¯ç”±å™¨çš„ICMP TTLè¶…æ—¶æ¶ˆæ¯ï¼Œè·å–è·¯ç”±å™¨å¯¹åº”çš„IPåœ°å€ å‘whois.radb.netå‘èµ·æŸ¥è¯¢ï¼Œè¯¢é—®è·¯ç”±å™¨IPåœ°å€å¯¹åº”çš„ASå·ï¼Œå¹¶å¾—åˆ°å›åº”ï¼Œå¦‚æœæ˜¯ç§æœ‰åœ°å€ï¼Œå…¶ASå·ä¸º0ã€‚ å°è¯•å‘DNSæœåŠ¡å™¨æŸ¥è¯¢è·¯ç”±å™¨IPåœ°å€çš„åå‘åŸŸåè§£æï¼Œå¦‚æœå¾—åˆ°åŸŸåï¼Œå°±å°†å…¶æ˜¾ç¤ºåœ¨Tracerouteçš„è¾“å‡ºç»“æœä¸­ã€‚ é‡å¤ä¸Šè¿°ç¬¬3~6æ­¥ï¼Œæ¯æ¬¡å°†TTLåŠ 1ï¼Œç›´è‡³ç›®æ ‡åœ°å€æ¥æ”¶åˆ°æ¢æµ‹æŠ¥æ–‡ï¼Œå¹¶è¿”å›ICMP Port Unreachableæ¶ˆæ¯ã€‚ WiresharkæŠ“åŒ…è¯¦ç»†åˆ†æä¸‹å›¾ä¸ºWiresharkæŠ“å–çš„æŠ¥æ–‡çš„å‰36ä¸ªï¼š ç¬¬1å’Œç¬¬2ä¸ªæŠ¥æ–‡ä¸ºDNSæŸ¥è¯¢ï¼ŒæŸ¥è¯¢whois.radb.netçš„åœ°å€ä¸º198.108.0.18ã€‚ ç¬¬3~5çš„æŠ¥æ–‡ä¸ºTCPä¸‰æ¬¡æ¡æ‰‹ï¼Œå¹¶æˆåŠŸå»ºç«‹TCP è¿æ¥10.39.101.141:51705&lt;â€”&gt;198.108.0.18:43ï¼ŒTCP 43ç«¯å£é€šå¸¸æ˜¯whois serverçš„ç«¯å£ã€‚ ç¬¬6ä¸ªæŠ¥æ–‡ç”±10.39.101.141å‘å‘198.108.0.18ï¼Œå¹¶å°†PSHç½®ä½ï¼Œè¯·æ±‚æ¥æ”¶ç«¯ä¸€æ”¶åˆ°å°±è¿›è¡Œå‘ä¸Šäº¤ä»˜ï¼Œä»¥ç¼©çŸ­Tracerouteçš„ç­‰å¾…æ—¶é—´ã€‚ ç¬¬7ä¸ªæŠ¥æ–‡å‘å‡ºç¬¬ä¸€ä¸ªUDPçš„æ¢æµ‹æŠ¥æ–‡ï¼Œç›®æ ‡ç«¯å£å·ä¸º33435ï¼ŒTTL=1ï¼Œå…·ä½“å¦‚ä¸‹ï¼š ç¬¬8ä¸ªæŠ¥æ–‡ä¸ºç½‘å…³å›å¤çš„ICMP Time-to-live exceeded (Time to live exceeded in transit)æŠ¥æ–‡ï¼ŒTracerouteä»IPæŠ¥æ–‡ä¸­çš„æºåœ°å€è·å–è·¯ç”±å™¨çš„IPåœ°å€10.39.101.1ã€‚è¯¥æŠ¥æ–‡åŒ…å«åŸå§‹çš„UDPæŠ¥æ–‡ä¿¡æ¯ï¼Œå…·ä½“å¦‚ä¸‹ï¼š ç¬¬9ä¸ªæŠ¥æ–‡ä¸ºç¬¬6ä¸ªæŠ¥æ–‡çš„TCPç¡®è®¤æŠ¥æ–‡ï¼Œç¬¬10ä¸ªæŠ¥æ–‡ä¸ºå‘whois.radb.netæŸ¥è¯¢ç½‘å…³10.39.101.1/32æ‰€åœ¨çš„ASå·ã€‚ç¬¬11ä¸ªæŠ¥æ–‡ä¸ºç¬¬10ä¸ªæŠ¥æ–‡çš„TCPç¡®è®¤ï¼Œç¬¬12ä¸ªæŠ¥æ–‡ç­”å¤æŸ¥è¯¢ç»“æœï¼Œç”±äºè¯¥åœ°å€ä¸ºç§æœ‰IPåœ°å€æ®µï¼Œæ²¡æœ‰æŸ¥è¯¢åˆ°ç»“æœï¼Œå› æ­¤Traceroute å°†ASå·æ˜¾ç¤ºä¸º[AS0]ã€‚ä»¥ä¸‹ä½¿ç”¨ç¬¬29å’Œ30æŠ¥æ–‡ï¼Œç”¨äºå±•ç¤ºASå·æŸ¥è¯¢çš„æŠ¥æ–‡ï¼Œå¦‚ä¸‹ï¼š æŸ¥è¯¢ç»“æœçš„æ–‡æœ¬å†…å®¹å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223route: 222.129.0.0/18descr: CMI (Customer Route)origin: AS4808mnt-by: MAINT-AS58453changed: qas_support@cmi.chinamobile.com 20160525source: RADBroute: 222.128.0.0/14descr: China Unicom Beijing Province Networkcountry: CNorigin: AS4808mnt-by: MAINT-CNCGROUP-RRchanged: abuse@cnc-noc.net 20160516source: APNICroute: 222.129.0.0/18descr: CMI IP Transitorigin: AS4808admin-c: MAINT-CMI-INT-HKtech-c: MAINT-CMI-INT-HKmnt-by: MAINT-CMI-INT-HKchanged: qas_support@cmi.chinamobile.com 20160525source: NTTCOM ç¬¬14~17æŠ¥æ–‡æ˜¯DNSè§£ææŠ¥æ–‡ï¼Œåˆ†åˆ«å¯¹ä¸»æœºåWERAO-M-40KAè¿›è¡ŒåŸŸåè§£æï¼Œä»¥åŠå¯¹ç½‘å…³IP 10.39.101.1è¿›è¡Œåå‘åŸŸåè§£æï¼Œç”±äºæ˜¯ç§æœ‰ä¸»æœºåå’Œç§æœ‰åœ°å€ï¼Œè‡ªç„¶å…¬ç½‘DNSæ˜¯è§£æä¸å‡ºæ¥ã€‚ä»¥ä¸‹å°†é’ˆå¯¹8.8.8.8è¿›è¡Œåå‘åŸŸåè§£æä¸ºdns.googleçš„æˆªå›¾ä½œä¸ºç¤ºä¾‹ï¼š æŠ¥æ–‡18~26é‡å¤æŠ¥æ–‡7~17çš„è¿‡ç¨‹ï¼Œå…¶ä¸­æŠ¥æ–‡18çš„TTLä¸º2ï¼Œå¦‚ä¸‹ï¼š è¿‡ç¨‹æŒç»­è‡³8.8.8.8è¿”å›Code: 3 (Port unreachable)çš„æ¶ˆæ¯ï¼Œå¹¶å¯¹8.8.8.8è¿›è¡Œåå‘åŸŸåè§£æã€‚ ä»¥ä¸Šè¯¦ç»†çš„åˆ†æäº†traceroute -aq 1 8.8.8.8çš„æŠ¥æ–‡æ”¶å‘è¿‡ç¨‹ã€‚ åè®°åœ¨ä¸Šè¿°çš„Tracerouteå®Œæˆè¾“å‡ºåï¼ŒWiresharkæˆåŠŸçš„å°†Whoisçš„äº¤äº’æŠ¥æ–‡è¿›è¡Œé‡æ–°ç»„è£…ï¼Œå¹¶å®Œæˆå†…å®¹çš„è§£æã€‚ åœ¨Wiresharkåˆ†æå®Œç¬¬133ä¸ªæŠ¥æ–‡åï¼ŒWiresharkæˆåŠŸçš„ç»„è£…å‡ºwhoisçš„æŸ¥è¯¢æŠ¥æ–‡ï¼Œå¦‚ä¸‹ï¼š åœ¨Wiresharkåˆ†æå®Œç¬¬135ä¸ªæŠ¥æ–‡åï¼ŒWiresharkæˆåŠŸçš„ç»„è£…å‡ºWhoisçš„åº”ç­”æŠ¥æ–‡ï¼Œå¦‚ä¸‹ï¼š åœ¨Terminalæ‰§è¡Œwhois 8.8.8.8/32ï¼Œå¹¶è¿›è¡ŒæŠ¥æ–‡æŠ“å–ï¼Œè§£æå‡ºWhoisçš„æŠ¥æ–‡åº”ç­”å¦‚ä¸‹ï¼š è¯¥æŠ¥æ–‡ä¹Ÿæ˜¯Wireshark æ‹¼è£…äº†å¤šä¸ªTCP Segmentï¼Œ#101ã€#103ã€#104ã€#106ã€#109åè§£æå‡ºæ¥çš„ã€‚å¯¹æ¯”è¯¥è§£æç»“æœå’Œä¸Šæ–‡ä¸­ï¼ŒTracerouteè¿‡ç¨‹ä¸­çš„æŸ¥è¯¢ç»“æœï¼Œå¯ä»¥å‘ç°ï¼ŒæŠ¥æ–‡ç»“æ„æ˜¯ä¸€è‡´çš„ï¼Œéƒ½è¢«Wiresharkè§£ææˆWhoisçš„æŠ¥æ–‡ã€‚ æ®æ­¤ï¼Œæˆ‘æ¨æµ‹ï¼ŒMACç”µè„‘ä¸Šçš„Traceroute åœ¨å¢åŠ äº†-açš„å‚æ•°åï¼Œä¼šä¸»åŠ¨å‘èµ·WhoisæŸ¥è¯¢ï¼Œç¼ºçœçš„WhoisæœåŠ¡å™¨æ˜¯whois.radb.netã€‚ æ­¤éƒ¨åˆ†å†…å®¹æ˜¯åœ¨Tracerouteæ”¶å‘åŒ…è¿‡ç¨‹åˆ†æå®Œæˆåï¼Œå†åçŸ¥åè§‰å‘ç°çš„ï¼Œå› æ­¤å°†æ­¤éƒ¨åˆ†å†…å®¹ä½œä¸ºâ€œåè®°â€è¿›è¡Œè®°å½•ã€‚ Traceroute è¿›é˜¶ç‰ˆå·¥å…·MTRMTR ï¼ˆMy Tracerouteï¼‰å·¥å…·å°†pingå’Œtracerouteå‘½ä»¤çš„åŠŸèƒ½å¹¶å…¥äº†åŒä¸€ä¸ªå·¥å…·ä¸­ï¼Œå®ç°æ›´å¼ºå¤§çš„åŠŸèƒ½ã€‚ç›¸å¯¹äºtracerouteå‘½ä»¤åªä¼šåšä¸€æ¬¡é“¾è·¯è·Ÿè¸ªæµ‹è¯•ï¼Œmtrå‘½ä»¤ä¼šå¯¹é“¾è·¯ä¸Šçš„ç›¸å…³èŠ‚ç‚¹åšæŒç»­æ¢æµ‹å¹¶ç»™å‡ºç›¸åº”çš„ç»Ÿè®¡ä¿¡æ¯ã€‚ å¦‚ä¸‹ä¸ºMTRçš„è¾“å‡ºï¼š 1234567891011121314151617âœ ~ sudo mtr -ry 4 8.8.8.8Start: 2021-06-27T23:37:21+0800HOST: WERAO-M-40KA Loss% Snt Last Avg Best Wrst StDev 1. ??? localhost 0.0% 10 1.8 2.2 1.2 10.1 2.8 2. ??? bogon 0.0% 10 2.2 2.3 1.9 3.3 0.5 3. 2003-11-19 222.129.32.1 0.0% 10 6.3 9.5 5.0 29.2 7.7 4. 2000-03-14 61.148.163.181 0.0% 10 5.3 7.4 5.3 8.7 1.2 5. 2002-04-17 219.232.11.65 70.0% 10 5.4 6.1 5.4 6.8 0.7 6. 2006-01-09 124.65.194.153 30.0% 10 28.9 9.6 5.7 28.9 8.5 7. 2002-03-21 219.158.112.26 40.0% 10 38.9 44.2 38.5 63.7 9.7 8. 2002-03-21 219.158.19.66 0.0% 10 74.4 64.1 46.4 74.4 8.8 9. 2002-03-21 219.158.97.25 0.0% 10 90.8 90.8 82.2 96.7 4.3 10. 2002-03-21 219.158.20.94 0.0% 10 97.5 89.8 74.1 104.6 11.8 11. 2002-03-21 219.158.33.174 0.0% 10 73.0 62.1 49.7 74.0 8.5 12. 2012-02-07 108.170.241.65 0.0% 10 59.0 67.3 53.1 75.4 7.2 13. 2013-04-04 172.253.69.229 10.0% 10 62.9 68.3 54.5 76.6 6.5 14. 1992-12-01 dns.google 0.0% 10 71.0 65.6 56.4 71.0 5.7 MTRå‘½ä»¤ï¼Œé€šè¿‡-r è¾“å‡ºæŠ¥å‘Šï¼Œ-z å¯è¾“å‡ºåœ°å€æ‰€åœ¨çš„ASå·ï¼Œ-y 4 å¯è¾“å‡ºè¯¥åœ°å€çš„åˆ†é…æ—¶é—´ã€‚ è¾“å‡ºä¿¡æ¯è§£é‡Šå¦‚ä¸‹ï¼š ç¬¬ä¸€åˆ—ï¼ˆHostï¼‰ï¼šèŠ‚ç‚¹IPåœ°å€å’ŒåŸŸåã€‚ ç¬¬äºŒåˆ—ï¼ˆLoss%ï¼‰ï¼šèŠ‚ç‚¹ä¸¢åŒ…ç‡ã€‚ ç¬¬ä¸‰åˆ—ï¼ˆSntï¼‰ï¼šå‘é€çš„PingåŒ…æ•°ã€‚é»˜è®¤å€¼æ˜¯10ï¼Œå¯ä»¥é€šè¿‡å‚æ•°â€œ-câ€æŒ‡å®šã€‚ ç¬¬å››åˆ—ï¼ˆLastï¼‰ï¼šæœ€è¿‘ä¸€æ¬¡çš„æ¢æµ‹å»¶è¿Ÿå€¼ã€‚ ç¬¬äº”ã€å…­ã€ä¸ƒåˆ—ï¼ˆAvgã€Bestã€Wrstï¼‰ï¼šåˆ†åˆ«æ˜¯æ¢æµ‹å»¶è¿Ÿçš„å¹³å‡å€¼ã€æœ€å°å€¼å’Œæœ€å¤§å€¼ã€‚ ç¬¬å…«åˆ—ï¼ˆStDevï¼‰ï¼šæ ‡å‡†åå·®ã€‚è¶Šå¤§è¯´æ˜ç›¸åº”èŠ‚ç‚¹è¶Šä¸ç¨³å®šã€‚ ä¸Šè¿°è§£é‡Šå¼•ç”¨è‡ªï¼šMTRå·¥å…·ä½¿ç”¨è¯´æ˜ä¸ç»“æœåˆ†æï¼Œç•¥æœ‰æ”¹åŠ¨ã€‚ Q&amp;A David Tian: èµï¼Œè¯·æ•™ä¸‹ï¼Œä¸ºä»€ä¹ˆipv4çš„traceroute ä¼šè§¦å‘ç”¨ipv6å»æŸ¥dnså‘¢ï¼Ÿ ç­”ï¼šå¥½çœ¼åŠ›ï¼Œå¥½é—®é¢˜~~å®é™…ä¸Šï¼Œæˆ‘æŠ“å–çš„æŠ¥æ–‡ä¸­ï¼Œæ¯æ¬¡å¾—åˆ°ICMPæŠ¥æ–‡åï¼ŒTracerouteä¹Ÿä¼šå‘208.67.222.222å‘é€DNSè¯·æ±‚ã€‚ä½†æ˜¯æŠ¥æ–‡æ˜¯åŠ å¯†çš„ï¼Œçœ‹ä¸å‡ºæ˜¯ä»€ä¹ˆå†…å®¹ï¼Œä¸èƒ½çŒœæµ‹ï¼Œæ‰€ä»¥æˆ‘å°†è¿™äº›ä¸ç¡®å®šçš„æŠ¥æ–‡åˆ é™¤äº†ã€‚208.67.222.222æ˜¯OpenDNSçš„DNSæœåŠ¡å™¨ï¼Œè¿™æ˜¯Cisco ITè®¾ç½®çš„DNSæœåŠ¡å™¨ã€‚ğŸ˜„ é™„å½•ä»¥ä¸‹æ˜¯WiresharkæŠ“åŒ…æ–‡ä»¶çš„å‰60ä¸ªæŠ¥æ–‡çš„æ¦‚è§ˆã€‚ No. Source Destination Protocol Info 1 fe80::1c7a:24fd:c837:3017 fe80::1 DNS Standard query 0xc7d5 A whois.radb.net 2 fe80::1 fe80::1c7a:24fd:c837:3017 DNS Standard query response 0xc7d5 A whois.radb.net A 198.108.0.18 3 10.39.101.141 198.108.0.18 TCP 51705 â†’ 43 [SYN] Seq=0 Win=65535 Len=0 MSS=1460 WS=64 TSval=2785245374 TSecr=0 SACK_PERM=1 4 198.108.0.18 10.39.101.141 TCP 43 â†’ 51705 [SYN, ACK] Seq=0 Ack=1 Win=28960 Len=0 MSS=1412 TSval=3642352050 TSecr=2785245374 WS=256 5 10.39.101.141 198.108.0.18 TCP 51705 â†’ 43 [ACK] Seq=1 Ack=1 Win=131584 Len=0 TSval=2785245692 TSecr=3642352050 6 10.39.101.141 198.108.0.18 TCP 51705 â†’ 43 [PSH, ACK] Seq=1 Ack=1 Win=131584 Len=3 TSval=2785245692 TSecr=3642352050 [TCP segment of a reassembled PDU] 7 10.39.101.141 8.8.8.8 UDP 36904 â†’ 33435 Len=24 8 10.39.101.1 10.39.101.141 ICMP Time-to-live exceeded (Time to live exceeded in transit) 9 198.108.0.18 10.39.101.141 TCP 43 â†’ 51705 [ACK] Seq=1 Ack=4 Win=29184 Len=0 TSval=3642352370 TSecr=2785245692 10 10.39.101.141 198.108.0.18 TCP 51705 â†’ 43 [PSH, ACK] Seq=4 Ack=1 Win=131584 Len=19 TSval=2785246039 TSecr=3642352370 [TCP segment of a reassembled PDU] 11 198.108.0.18 10.39.101.141 TCP 43 â†’ 51705 [ACK] Seq=1 Ack=23 Win=29184 Len=0 TSval=3642352717 TSecr=2785246039 12 198.108.0.18 10.39.101.141 TCP 43 â†’ 51705 [PSH, ACK] Seq=1 Ack=23 Win=29184 Len=2 TSval=3642352717 TSecr=2785246039 [TCP segment of a reassembled PDU] 13 10.39.101.141 198.108.0.18 TCP 51705 â†’ 43 [ACK] Seq=23 Ack=3 Win=131584 Len=0 TSval=2785246448 TSecr=3642352717 14 fe80::1c7a:24fd:c837:3017 fe80::1 DNS Standard query 0x93fc A WERAO-M-40KA 15 fe80::1 fe80::1c7a:24fd:c837:3017 DNS Standard query response 0x93fc No such name A WERAO-M-40KA 16 fe80::1c7a:24fd:c837:3017 fe80::1 DNS Standard query 0xbcf9 PTR 1.101.39.10.in-addr.arpa 17 fe80::1 fe80::1c7a:24fd:c837:3017 DNS Standard query response 0xbcf9 PTR 1.101.39.10.in-addr.arpa PTR bogon 18 10.39.101.141 8.8.8.8 UDP 36904 â†’ 33436 Len=24 19 192.168.1.1 10.39.101.141 ICMP Time-to-live exceeded (Time to live exceeded in transit) 20 10.39.101.141 198.108.0.18 TCP 51705 â†’ 43 [PSH, ACK] Seq=23 Ack=3 Win=131584 Len=19 TSval=2785248590 TSecr=3642352717 [TCP segment of a reassembled PDU] 21 10.39.101.141 10.39.101.1 DNS Standard query 0xc81a A WERAO-M-40KA 22 10.39.101.1 10.39.101.141 DNS Standard query response 0xc81a A WERAO-M-40KA A 10.39.101.141 23 198.108.0.18 10.39.101.141 TCP 43 â†’ 51705 [PSH, ACK] Seq=3 Ack=42 Win=29184 Len=2 TSval=3642355278 TSecr=2785248590 [TCP segment of a reassembled PDU] 24 10.39.101.141 198.108.0.18 TCP 51705 â†’ 43 [ACK] Seq=42 Ack=5 Win=131584 Len=0 TSval=2785248902 TSecr=3642355278 25 fe80::1c7a:24fd:c837:3017 fe80::1 DNS Standard query 0x7504 PTR 1.1.168.192.in-addr.arpa 26 fe80::1 fe80::1c7a:24fd:c837:3017 DNS Standard query response 0x7504 PTR 1.1.168.192.in-addr.arpa PTR localhost 27 10.39.101.141 8.8.8.8 UDP 36904 â†’ 33437 Len=24 28 222.129.32.1 10.39.101.141 ICMP Time-to-live exceeded (Time to live exceeded in transit) 29 10.39.101.141 198.108.0.18 TCP 51705 â†’ 43 [PSH, ACK] Seq=42 Ack=5 Win=131584 Len=20 TSval=2785249974 TSecr=3642355278 [TCP segment of a reassembled PDU] 30 198.108.0.18 10.39.101.141 TCP 43 â†’ 51705 [PSH, ACK] Seq=5 Ack=62 Win=29184 Len=643 TSval=3642356666 TSecr=2785249974 [TCP segment of a reassembled PDU] 31 10.39.101.141 198.108.0.18 TCP 51705 â†’ 43 [ACK] Seq=62 Ack=648 Win=130944 Len=0 TSval=2785250324 TSecr=3642356666 32 fe80::1c7a:24fd:c837:3017 fe80::1 DNS Standard query 0x4f56 PTR 1.32.129.222.in-addr.arpa 33 fe80::1 fe80::1c7a:24fd:c837:3017 DNS Standard query response 0x4f56 No such name PTR 1.32.129.222.in-addr.arpa 34 10.39.101.141 8.8.8.8 UDP 36904 â†’ 33438 Len=24 35 61.51.101.101 10.39.101.141 ICMP Time-to-live exceeded (Time to live exceeded in transit) 36 10.39.101.141 198.108.0.18 TCP 51705 â†’ 43 [PSH, ACK] Seq=62 Ack=648 Win=131072 Len=21 TSval=2785251389 TSecr=3642356666 [TCP segment of a reassembled PDU] 37 198.108.0.18 10.39.101.141 TCP 43 â†’ 51705 [PSH, ACK] Seq=648 Ack=83 Win=29184 Len=639 TSval=3642358087 TSecr=2785251389 [TCP segment of a reassembled PDU] 38 10.39.101.141 198.108.0.18 TCP 51705 â†’ 43 [ACK] Seq=83 Ack=1287 Win=130432 Len=0 TSval=2785251697 TSecr=3642358087 39 10.39.101.141 10.39.101.1 DNS Standard query 0x521b PTR 1.32.129.222.in-addr.arpa 40 10.39.101.1 10.39.101.141 DNS Standard query response 0x521b No such name PTR 1.32.129.222.in-addr.arpa 41 fe80::1c7a:24fd:c837:3017 fe80::1 DNS Standard query 0x5931 PTR 101.101.51.61.in-addr.arpa 42 fe80::1 fe80::1c7a:24fd:c837:3017 DNS Standard query response 0x5931 No such name PTR 101.101.51.61.in-addr.arpa 43 10.39.101.141 8.8.8.8 UDP 36904 â†’ 33439 Len=24 44 219.232.11.29 10.39.101.141 ICMP Time-to-live exceeded (Time to live exceeded in transit) 45 10.39.101.141 198.108.0.18 TCP 51705 â†’ 43 [PSH, ACK] Seq=83 Ack=1287 Win=131072 Len=21 TSval=2785252732 TSecr=3642358087 [TCP segment of a reassembled PDU] 46 198.108.0.18 10.39.101.141 TCP 43 â†’ 51705 [PSH, ACK] Seq=1287 Ack=104 Win=29184 Len=418 TSval=3642359437 TSecr=2785252732 [TCP segment of a reassembled PDU] 47 10.39.101.141 198.108.0.18 TCP 51705 â†’ 43 [ACK] Seq=104 Ack=1705 Win=130624 Len=0 TSval=2785253042 TSecr=3642359437 48 fe80::1c7a:24fd:c837:3017 fe80::1 DNS Standard query 0x7d09 PTR 29.11.232.219.in-addr.arpa 49 fe80::1 fe80::1c7a:24fd:c837:3017 DNS Standard query response 0x7d09 No such name PTR 29.11.232.219.in-addr.arpa 50 10.39.101.141 8.8.8.8 UDP 36904 â†’ 33440 Len=24 51 202.96.12.13 10.39.101.141 ICMP Time-to-live exceeded (Time to live exceeded in transit) 52 10.39.101.141 198.108.0.18 TCP 51705 â†’ 43 [PSH, ACK] Seq=104 Ack=1705 Win=131072 Len=20 TSval=2785254068 TSecr=3642359437 [TCP segment of a reassembled PDU] 53 10.39.101.141 10.39.101.1 DNS Standard query 0x961b PTR 101.101.51.61.in-addr.arpa 54 10.39.101.1 10.39.101.141 DNS Standard query response 0x961b No such name PTR 101.101.51.61.in-addr.arpa 55 198.108.0.18 10.39.101.141 TCP 43 â†’ 51705 [PSH, ACK] Seq=1705 Ack=124 Win=29184 Len=642 TSval=3642360779 TSecr=2785254068 [TCP segment of a reassembled PDU] 56 10.39.101.141 198.108.0.18 TCP 51705 â†’ 43 [ACK] Seq=124 Ack=2347 Win=130368 Len=0 TSval=2785254400 TSecr=3642360779 57 fe80::1c7a:24fd:c837:3017 fe80::1 DNS Standard query 0xb016 PTR 13.12.96.202.in-addr.arpa 58 fe80::1 fe80::1c7a:24fd:c837:3017 DNS Standard query response 0xb016 No such name PTR 13.12.96.202.in-addr.arpa SOA beijing.cn.net 59 10.39.101.141 8.8.8.8 UDP 36904 â†’ 33441 Len=24 60 219.158.112.46 10.39.101.141 ICMP Time-to-live exceeded (Time to live exceeded in transit) æŠ“åŒ…æ–‡ä»¶ä¸‹è½½","categories":[],"tags":[{"name":"traceroute","slug":"traceroute","permalink":"https://weiborao.link/tags/traceroute/"},{"name":"wireshark","slug":"wireshark","permalink":"https://weiborao.link/tags/wireshark/"}]},{"title":"åœ¨AWSä¸Šéƒ¨ç½²TE Agentå¹¶è¿›è¡Œæµ‹è¯•","slug":"deploy-thousandeyes-agent-on-aws","date":"2021-06-17T13:00:00.000Z","updated":"2021-06-17T13:06:53.306Z","comments":true,"path":"deploy-thousandeyes-agent-on-aws.html","link":"","permalink":"https://weiborao.link/deploy-thousandeyes-agent-on-aws.html","excerpt":"","text":"ThousandEyes ç®€ä»‹ThousandEyesæ˜¯ä¸€ä¸ªç½‘ç»œæ€§èƒ½ç›‘æ§çš„SAASäº‘æœåŠ¡ï¼Œç»“åˆäº†å„ç§ä¸»åŠ¨å’Œè¢«åŠ¨çš„ç›‘æ§æŠ€æœ¯ï¼Œè®©æ‚¨æ·±å…¥äº†è§£æ‚¨æä¾›çš„ä»¥åŠæ‚¨æ¶ˆè´¹çš„åº”ç”¨å’ŒæœåŠ¡çš„ç”¨æˆ·ä½“éªŒã€‚ThousandEyesä½¿ç”¨çš„ç›‘æ§æŠ€æœ¯åŒ…æ‹¬ç½‘ç»œçš„å¯è¾¾æ€§æ¢æµ‹ã€æ—¶å»¶ã€ä¸¢åŒ…ã€æŠ–åŠ¨ã€å¯è§†åŒ–çš„é€è·³è·¯å¾„åˆ†æã€å¯è§†åŒ–çš„BGPè·¯ç”±åˆ†æã€DNSç›‘æ§ã€HTTPæœåŠ¡ç›‘æ§ç­‰ã€‚ThousandEyeså¹³å°å¯¹è¿™äº›ç›‘æ§æ”¶é›†è€Œæ¥çš„æ•°æ®è¿›è¡Œåˆ†æã€äº¤å‰å…³è”ï¼Œå°†æ¶‰åŠç”¨æˆ·ä½“éªŒçš„æ–¹æ–¹é¢é¢ï¼ŒåŒ…æ‹¬ç½‘ç»œå’Œåº”ç”¨çš„çŠ¶å†µç»Ÿä¸€çš„å‘ˆç°åœ¨åŒä¸€ä¸ªç•Œé¢ä¹‹ä¸‹ï¼Œè®©æ‚¨èƒ½å¤Ÿè½»æ¾çš„éš”ç¦»é—®é¢˜ï¼Œé‡‡å–è¡ŒåŠ¨ï¼Œä»è€Œå¿«é€Ÿçš„è§£å†³é—®é¢˜ã€‚ ThousandEyesæä¾›äº†ä¸‰ç§Agentè¿›è¡Œç½‘ç»œå’Œåº”ç”¨çš„æ¢æµ‹ï¼Œåˆ†åˆ«æ˜¯Cloud Agentã€Enterprise Agentå’ŒEndpoint Agentã€‚Cloud Agent ç”±ThousandEyesåœ¨å…¨çƒéƒ¨ç½²å’Œç»´æŠ¤ï¼Œå½“å‰ï¼ŒThousandEyesåœ¨å…¨çƒ200å¤šä¸ªåŸå¸‚å…±éƒ¨ç½²äº†400å¤šä¸ªCloud Agentï¼Œå¯ä¾›å…¨çƒç”¨æˆ·ä½¿ç”¨ã€‚Enterprise Agentç”±ç”¨æˆ·è‡ªå·±éƒ¨ç½²ï¼Œå¯ä»¥éƒ¨ç½²ä¸ºè™šæ‹Ÿæœºæˆ–è€…å®¹å™¨ï¼Œå¯ä»¥å®‰è£…åœ¨ç‰©ç†ç¡¬ä»¶ï¼Œå¦‚Intel NCUæˆ–è€…æ ‘è“æ´¾ä¸­ï¼Œæ”¯æŒWindowsã€Linuxç³»ç»Ÿï¼Œè¿˜å¯ä»¥éƒ¨ç½²åœ¨æ€ç§‘æˆ–Juniperçš„ç½‘ç»œè®¾å¤‡ä¸­ï¼Œä¹Ÿèƒ½é€šè¿‡CloudFormationåœ¨AWSäº‘ä¸­è‡ªåŠ¨éƒ¨ç½²ã€‚Endpoint Agentæ˜¯æµè§ˆå™¨æ’ä»¶ï¼Œç”¨æˆ·åœ¨è®¿é—®ç½‘ç«™æ—¶ï¼Œå¯ä»¥è‡ªåŠ©çš„ä½¿ç”¨Endpoint Agentè¿›è¡Œæµ‹è¯•ï¼Œç”±ThousandEyesè¿›è¡Œæ•°æ®åˆ†æï¼Œä»è€Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿäº†è§£å…¶æ•°å­—ä½“éªŒï¼Œä»¥åŠå¿«é€Ÿå®šä½é—®é¢˜æ‰€åœ¨ã€‚ç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦æ¥é€‰æ‹©ä¸€ç§æˆ–å¤šç§Agentè¿›è¡Œæ¢æµ‹ï¼ŒThousandEyeså¹³å°ä¼šè‡ªåŠ¨å®Œæˆåˆ†æå’Œå±•ç°ï¼Œæä¾›ç½‘ç»œå’Œåº”ç”¨çŠ¶å†µçš„æ´è§åˆ†æã€‚ åœ¨AWSä¸Šéƒ¨ç½²TE Agentäº†è§£éƒ¨ç½²è¿‡ç¨‹åœ¨æ­£å¼éƒ¨ç½²ä¹‹å‰ï¼Œå¿«é€Ÿé˜…è¯»äº†ä¸€ä¸‹AWS Deployment Guideï¼Œéƒ¨ç½²è¿‡ç¨‹æ˜¯é€šè¿‡AWSçš„CloudFormationåˆ›å»ºä¸€ä¸ªStackï¼Œæ•´ä¸ªè¿‡ç¨‹å…¨éƒ¨è‡ªåŠ¨åŒ–ã€‚ éƒ¨ç½²çš„å‰ææ˜¯éœ€è¦è®¾ç½®å¥½SSH Key-pairï¼ŒVPCç½‘ç»œã€å…¬å…±å­ç½‘ã€ä»¥åŠä½¿ç”¨CloudFormationéƒ¨ç½²EC2çš„æƒé™ã€‚ éƒ¨ç½²çš„å†…å®¹åŒ…æ‹¬ï¼šå¯åŠ¨åŸºäºUbuntuçš„EC2å®ä¾‹ï¼Œå¹¶è‡ªåŠ¨å®‰è£…TE Agentï¼Œåˆ›å»ºSecurity Groupï¼Œå¹¶åŸºäºæœ€å°æƒé™é…ç½®Inbound Rulesã€‚ å‡†å¤‡SSH Key-pairé¦–å…ˆï¼Œåœ¨MACç”µè„‘ä¸­ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œç”¨äºåˆ›å»ºä¸€ä¸ªRSAçš„ç§˜é’¥å¯¹ï¼Œå¹¶å°†å…¬é’¥æ‹·è´è‡³æ¡Œé¢ã€‚ 1234ssh-keygen -t rsa -b 4096 -f .ssh/aws_kp -m PEMmv .ssh/aws_kp .ssh/aws_kp.pemchmod 400 .ssh/aws_kp.pemcp .ssh/aws_kp.pub ~/Desktop ç™»å½•AWSçš„Consoleç®¡ç†ç•Œé¢åï¼Œé€‰æ‹©Regionï¼Œæ¯”å¦‚us-east-1ï¼Œå®šä½åˆ°EC2â€”Network Securityâ€”Key Pairï¼Œåœ¨ç•Œé¢å³ä¸Šä¾§çš„Actionsä¸‹æ‹‰æ¡†ä¸­ï¼Œé€‰æ‹©Import key pairï¼Œå°†aws_kp.pubä¸Šä¼ ã€‚ åœ¨å…¶ä»–çš„Regionï¼Œé‡å¤ä¸Šè¿°åŠ¨ä½œï¼Œå°†key pairä¸Šä¼ ï¼Œè¿™æ ·åœ¨å¤šä¸ªRegionåˆ›å»ºçš„EC2å¯ä»¥ä½¿ç”¨åŒä¸€ä¸ªç§é’¥è¿›è¡Œç™»å½•ã€‚ åœ¨AWSä¸Šéƒ¨ç½²TE Agentéƒ¨ç½²TE Agentçš„æ“ä½œè·¯å¾„ä¸ºï¼šåœ¨ThousandEyesçš„ç•Œé¢ä¸­ï¼Œé€‰æ‹©Cloud &amp; Enterprise Agentsï¼Œå†é€‰æ‹©Agent Settingsï¼Œè¿›ä¸€æ­¥é€‰æ‹©Enterprise Agentsï¼Œç‚¹å‡»Add New Enterprise Agentã€‚åœ¨å³ä¾§å‡ºç°çš„ç•Œé¢ä¸­ï¼Œé€‰æ‹©IaaS Marketplacesï¼Œåœ¨è¯¥ç•Œé¢ä¸­ç‚¹å‡»Launch in AWSï¼Œè·³è½¬åˆ°AWSçš„ç™»å½•ç•Œé¢ï¼Œå¹¶è‡ªåŠ¨è¿›å…¥CloudFormationçš„ç•Œé¢ï¼Œè¯¥ç•Œé¢å·²å°†Stackæ¨¡æ¿é€‰æ‹©å¥½äº†ã€‚ Stackæ¨¡æ¿çš„é“¾æ¥ï¼š https://s3-us-west-1.amazonaws.com/oneclick-ea.aws.thousandeyes/aws-ea-oneclick.yaml è¯¥æ¨¡æ¿åŒ…å«ä¸¤ä¸ªç»„ä»¶ï¼šEC2 Instance å’Œ Security Groupã€‚ æŒ‰ç…§ä¸Šæ–‡çš„éƒ¨ç½²æŒ‡å—å¡«å†™è¡¨å•ï¼Œå¹¶ç‚¹å‡»ä¸‹ä¸€æ­¥ï¼Œç›´è‡³å®Œæˆéƒ¨ç½²ã€‚ åœ¨å®Œæˆå®‰è£…åï¼Œå¯ä»¥ä½¿ç”¨ç§é’¥ç™»å½•åˆ°è™šæœºï¼Œæ³¨æ„ï¼šç”¨æˆ·åä¸º ubuntuï¼Œä¸æ˜¯ec2-user æˆ– rootã€‚ 1ssh -i .ssh/aws_kp.pem -v [ubuntu@](mailto:ubuntu@18.141.230.240)x.x.x.x åœ¨ä¸¤ä¸ªä¸åŒçš„Regionï¼Œus-east-1 å’Œ ap-southeast-1 åˆ†åˆ«éƒ¨ç½²ä¸€ä¸ªTE Agentã€‚ å¤§çº¦5åˆ†é’Ÿåï¼Œå³å¯åœ¨app.thousandeyes.comçš„ç•Œé¢ä¸­çœ‹åˆ°ä¸¤ä¸ªTE Agentä¸Šçº¿ã€‚ æ‰§è¡ŒAgent to Agent æµ‹è¯•åˆ†åˆ«æ‰§è¡Œä¸¤ç§æµ‹è¯•ï¼Œä¸€ä¸ªæ˜¯é€šè¿‡å…¬ç½‘IPè¿›è¡ŒåŒå‘æµ‹è¯•ï¼Œä¸€ä¸ªæ˜¯åˆ›å»ºVPC Peeringåï¼Œä½¿ç”¨ç§æœ‰åœ°å€è¿›è¡Œæµ‹è¯•ï¼Œæ¯”è¾ƒä¸¤è€…ä¹‹é—´çš„å·®å¼‚ã€‚ é€šè¿‡å…¬ç½‘IPåœ°å€è¿›è¡ŒåŒå‘æµ‹è¯•åœ¨ThousandEyesçš„Agent Settingsç•Œé¢ä¸­ï¼Œç‚¹å‡»Agentï¼Œåœ¨å³ä¾§çš„ç½‘é¡µä¸­ï¼Œé€‰æ‹©Advanced Settingsï¼Œå°†åœ°å€è®¾ç½®ä¸ºAgentçš„å…¬ç½‘IPåœ°å€ã€‚ åœ¨Test Settingsä¸­ï¼Œé€‰æ‹©Add New Testï¼ŒLayeré€‰æ‹©Networkï¼ŒTest Typeé€‰æ‹©Agent to Agentã€‚ é€‰æ‹©ä¸€ä¸ªAgentä½œä¸ºTargetï¼Œå¦ä¸€ä¸ªAgentä½œä¸ºæºï¼Œæµ‹è¯•æ–¹å‘é€‰æ‹©åŒå‘ã€‚ ç»è¿‡ä¸€æ®µæ—¶é—´åï¼ŒThousandEyesä¸Šå³å¯å‘ˆç°æµ‹è¯•ç»“æœã€‚ æµ‹è¯•æŒç»­äº†ä¸€ä¸ªå°æ—¶å·¦å³ï¼Œæµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š AWS us-east-1 to ap-southeast-1 Using Public IP Items Result Loss 0% Latency 212ms Jitter &lt;1ms Throughput 55Mbps åœ¨å¯è§†åŒ–çš„è·¯å¾„åˆ†æå›¾ä¸­ï¼Œè§‚å¯Ÿåˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š ä»us-east-1åˆ°ap-southeast-1å¾€è¿”ï¼Œè‡³å°‘å„æœ‰ä¸‰æ¡è·¯å¾„ï¼Œæ¯æ¡è·¯å¾„æ˜¾ç¤ºçš„è·³æ•°çº¦æœ‰20è·³ã€‚ è¯¥æµ‹è¯•æ¯éš”2åˆ†é’Ÿæµ‹è¯•ä¸€æ¬¡ï¼Œå…±æµ‹è¯•äº†25æ¬¡ã€‚åœ¨è¿™25æ¬¡ä¸­ï¼Œé²œæœ‰è·¯å¾„ä¸€è‡´çš„ï¼Œæœ‰æ—¶å€™å…¨ç¨‹æ²¡æœ‰å…¬å…±èŠ‚ç‚¹ï¼Œæœ‰æ—¶å€™ä¸¤æ¡ã€ç”šè‡³ä¸‰æ¡è·¯å¾„ä¸­é—´æœ‰å…¬å…±èŠ‚ç‚¹ã€‚ å¯è§†åŒ–è·¯å¾„ä¸­ï¼Œä»ä¸¤ä¾§çš„Agentå‡ºå‘ï¼Œå‡æœ‰è¿ç»­çš„5ä¸ªæˆ–6ä¸ªè¿ç»­æœªçŸ¥èŠ‚ç‚¹ã€‚è¿™æ˜¯ç”±äºè¿™äº›èŠ‚ç‚¹ä¸å¯¹Tracerouteä½œå‡ºå›åº”ï¼Œå¯¼è‡´è·¯å¾„ä¸­ä¸å¯è§ã€‚ åœ¨æ•´ä¸ªå¯è§†åŒ–è·¯å¾„ä¸­ï¼Œå¯è§çš„å…¬ç½‘èŠ‚ç‚¹çš„IPåœ°å€å±äºAS 16509æˆ–è€…AS 14618ï¼Œè¿™ä¸¤ä¸ªéƒ½æ˜¯AWSçš„BGP ASåŸŸã€‚å…¶ä»–èŠ‚ç‚¹çš„åœ°å€ä¸º100.65.x.xæˆ–100.100.x.xï¼Œè¿™æ®µåœ°å€å±äº100.64.0.0/10ï¼Œä¸ºIANAä¿ç•™åœ°å€ï¼Œç”¨äºç»™è¿è¥å•†ä½¿ç”¨ã€‚ç”±æ­¤å¯ä»¥æ¨æ–­ï¼Œä¸¤ä¸ªAgentä¹‹é—´é€šè®¯çš„æŠ¥æ–‡å¹¶æœªç¦»å¼€è¿‡AWSçš„ç½‘ç»œï¼Œè¿™ä¹Ÿè§£é‡Šäº†ä¸ºä½•ä¸Šè¿°çš„æ—¶å»¶ã€æŠ–åŠ¨æ˜¯å¾ˆç¨³å®šçš„å€¼ï¼Œå¹¶ä¸”æ•´ä¸ªæµ‹è¯•æœŸé—´ï¼Œæ²¡æœ‰ä¸¢åŒ…ã€‚ åœ¨å¯è§†åŒ–è·¯å¾„ä¸­ï¼Œæˆ‘è¿˜èƒ½å‘ç°æœ‰çš„è·¯å¾„æ˜¯ä¸€æ®µMPLS éš§é“ï¼Œå¹¶ç»™å‡ºäº†è½¬å‘æ—¶ç”¨åˆ°çš„Labelå€¼ã€‚ThousandEyesæ˜¯å¦‚ä½•å‘ç°è·¯å¾„ä¸­é—´æœ‰MPLS Tunnelå‘¢ï¼Ÿè¿™ä¸ªæ˜¯å€¼å¾—ä»”ç»†æ€è€ƒçš„é—®é¢˜ã€‚ç»æŸ¥è¯¢ï¼Œè¿™æ˜¯é€šè¿‡ThousandEyesçš„ä¸“åˆ©æŠ€æœ¯Deep Path Analysis (DPA)å®ç°çš„ã€‚ é€šè¿‡ç§ç½‘IPåœ°å€è¿›è¡ŒåŒå‘æµ‹è¯•æœ¬æ¬¡æµ‹è¯•çš„æ–¹æ³•åŒä¸Šï¼Œåªæ˜¯éœ€è¦å°†Agentçš„IPåœ°å€ä¿®æ”¹ä¸ºä½¿ç”¨ç§æœ‰IPåœ°å€ï¼Œä¸¤ä¸ªRegionçš„VPCä¹‹é—´å»ºç«‹VPC Peeringã€‚ æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š AWS us-east-1 to ap-southeast-1 Using Private IP Items Result Loss 0% Latency 212ms Jitter &lt;1ms Throughput 56Mbps åœ¨å¯è§†åŒ–çš„è·¯å¾„åˆ†æå›¾ä¸­ï¼Œè§‚å¯Ÿåˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š ä¸¤ä¸ªAgentä¹‹é—´æ˜¯ç›´è¿çš„ï¼Œæ²¡æœ‰ä»»ä½•ä¸­é—´èŠ‚ç‚¹ï¼Œä¸¤è€…ä¹‹é—´æ—¶å»¶ä¸º211msã€‚ åšå®Œä¸¤æ¬¡æµ‹è¯•ï¼Œç¬¬äºŒå¤©æ£€æŸ¥äº†ä¸€ä¸‹AWSçš„è´¦å•ï¼Œé¢„è®¡èŠ±è´¹äº†0.29ç¾é‡‘ã€‚ æµ‹è¯•ç»“æœçš„å…±äº«é“¾æ¥https://zwskwtsea.share.thousandeyes.com/ https://aieajezsh.share.thousandeyes.com/","categories":[],"tags":[{"name":"ThousandEyes","slug":"ThousandEyes","permalink":"https://weiborao.link/tags/ThousandEyes/"},{"name":"AWS","slug":"AWS","permalink":"https://weiborao.link/tags/AWS/"}]},{"title":"Mastering KVM Virtualization å­¦ä¹ ç¬”è®°(1)","slug":"master-kvm-notes-1","date":"2021-02-22T06:23:47.000Z","updated":"2021-02-22T06:30:40.658Z","comments":true,"path":"master-kvm-notes-1.html","link":"","permalink":"https://weiborao.link/master-kvm-notes-1.html","excerpt":"","text":"ç¬¬ä¸€ç« å’Œç¬¬äºŒç« ä¹‹å‰å¿«é€Ÿé˜…è¯»è¿‡äº†ï¼Œæ²¡æœ‰ç¬”è®°ï¼Œç­‰å›å¤´å†å›æ¥æ•´ç†ã€‚ Chapter 3 KVMã€virshã€oVirtç­‰CentOS 8 çš„KVMå®‰è£…123yum module install virtdnf install qemu-img qemu-kvm libvirt libvirt-client virt-manager \\virt-install virt-viewer -y å®‰è£…å®Œåï¼Œä½¿ç”¨virt-host-validateéªŒè¯12345678910111213141516171819202122232425262728293031323334353637383940[root@centos7 ~]# virt-host-validate QEMU: Checking for hardware virtualization : PASS QEMU: Checking if device /dev/kvm exists : PASS QEMU: Checking if device /dev/kvm is accessible : PASS QEMU: Checking if device /dev/vhost-net exists : PASS QEMU: Checking if device /dev/net/tun exists : PASS QEMU: Checking for cgroup &#x27;memory&#x27; controller support : PASS QEMU: Checking for cgroup &#x27;memory&#x27; controller mount-point : PASS QEMU: Checking for cgroup &#x27;cpu&#x27; controller support : PASS QEMU: Checking for cgroup &#x27;cpu&#x27; controller mount-point : PASS QEMU: Checking for cgroup &#x27;cpuacct&#x27; controller support : PASS QEMU: Checking for cgroup &#x27;cpuacct&#x27; controller mount-point : PASS QEMU: Checking for cgroup &#x27;cpuset&#x27; controller support : PASS QEMU: Checking for cgroup &#x27;cpuset&#x27; controller mount-point : PASS QEMU: Checking for cgroup &#x27;devices&#x27; controller support : PASS QEMU: Checking for cgroup &#x27;devices&#x27; controller mount-point : PASS QEMU: Checking for cgroup &#x27;blkio&#x27; controller support : PASS QEMU: Checking for cgroup &#x27;blkio&#x27; controller mount-point : PASS QEMU: Checking for device assignment IOMMU support : PASS QEMU: Checking if IOMMU is enabled by kernel : PASS LXC: Checking for Linux &gt;= 2.6.26 : PASS LXC: Checking for namespace ipc : PASS LXC: Checking for namespace mnt : PASS LXC: Checking for namespace pid : PASS LXC: Checking for namespace uts : PASS LXC: Checking for namespace net : PASS LXC: Checking for namespace user : PASS LXC: Checking for cgroup &#x27;memory&#x27; controller support : PASS LXC: Checking for cgroup &#x27;memory&#x27; controller mount-point : PASS LXC: Checking for cgroup &#x27;cpu&#x27; controller support : PASS LXC: Checking for cgroup &#x27;cpu&#x27; controller mount-point : PASS LXC: Checking for cgroup &#x27;cpuacct&#x27; controller support : PASS LXC: Checking for cgroup &#x27;cpuacct&#x27; controller mount-point : PASS LXC: Checking for cgroup &#x27;cpuset&#x27; controller support : PASS LXC: Checking for cgroup &#x27;cpuset&#x27; controller mount-point : PASS LXC: Checking for cgroup &#x27;devices&#x27; controller support : PASS LXC: Checking for cgroup &#x27;devices&#x27; controller mount-point : PASS LXC: Checking for cgroup &#x27;blkio&#x27; controller support : PASS LXC: Checking for cgroup &#x27;blkio&#x27; controller mount-point : PASS LXC: Checking if device /sys/fs/fuse/connections exists : PASS ä½¿ç”¨virt-install å®‰è£…è™šæ‹Ÿæœºç¼–è¾‘anaconda-ks.cfgæ–‡ä»¶ï¼Œä½¿ç”¨ä»¥ä¸‹å‚æ•°å¯ä»¥å®ç°è™šæœºéƒ¨ç½²çš„é™é»˜å®‰è£…ã€‚ 1234virt-install --virt-type=kvm --name=MasteringKVM02 --ram=4096--vcpus=4 --os-variant=rhel8.0 --location=/var/lib/libvirt/images/ CentOS-8-x86_64-1905-dvd1.iso --network=default--graphics vnc --disk size=16 -x &quot;ks=http://10.10.48.1/ks.cfg&quot; oVirtoVirtï¼ˆOpen Virtualization Managerï¼‰æ˜¯ä¸€æ¬¾å…è´¹å¼€æºè™šæ‹ŸåŒ–è½¯ä»¶ï¼Œæ˜¯RedHatå•†ä¸šç‰ˆæœ¬è™šæ‹ŸåŒ–è½¯ä»¶RHEVçš„å¼€æºç‰ˆæœ¬ã€‚ oVirtåŸºäºkvmï¼Œå¹¶æ•´åˆä½¿ç”¨äº†libvirtã€glusterã€patternflyã€ansibleç­‰ä¸€ç³»åˆ—ä¼˜ç§€çš„å¼€æºè½¯ä»¶ã€‚ æ¢ç´¢è™šæ‹ŸæœºQemu-kvmè¿›ç¨‹12root@ubuntu-kvm:/home/ubuntu# ps aux | grep qemulibvirt+ 8526 255 0.1 13876708 653744 ? SLl Feb01 61850:36 /usr/bin/qemu-system-x86_64 -name guest=csr1kv-1,debug-threads=on -S -object secret,id=masterKey0,format=raw,file=/var/lib/libvirt/qemu/domain-4-csr1kv-1/master-key.aes -machine pc-q35-4.2,accel=kvm,usb=off,vmport=off,dump-guest-core=off,mem-merge=off -cpu host -m 8192 -mem-prealloc -mem-path /dev/hugepages/libvirt/qemu/4-csr1kv-1 -overcommit mem-lock=on -smp 8,sockets=8,cores=1,threads=1 -uuid 83f90c1c-f0ea-4298-bcdf-3d676de2aeb4 -no-user-config -nodefaults -chardev socket,id=charmonitor,fd=31,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=utc,driftfix=slew -global kvm-pit.lost_tick_policy=delay -no-hpet -no-shutdown -global ICH9-LPC.disable_s3=1 -global ICH9-LPC.disable_s4=1 -boot strict=on -device pcie-root-port,port=0x10,chassis=1,id=pci.1,bus=pcie.0,multifunction=on,addr=0x2 -device pcie-root-port,port=0x11,chassis=2,id=pci.2,bus=pcie.0,addr=0x2.0x1 -device pcie-root-port,port=0x12,chassis=3,id=pci.3,bus=pcie.0,addr=0x2.0x2 -device pcie-root-port,port=0x13,chassis=4,id=pci.4,bus=pcie.0,addr=0x2.0x3 -device pcie-root-port,port=0x14,chassis=5,id=pci.5,bus=pcie.0,addr=0x2.0x4 -device pcie-root-port,port=0x15,chassis=6,id=pci.6,bus=pcie.0,addr=0x2.0x5 -device pcie-root-port,port=0x16,chassis=7,id=pci.7,bus=pcie.0,addr=0x2.0x6 -device pcie-root-port,port=0x17,chassis=8,id=pci.8,bus=pcie.0,addr=0x2.0x7 -device qemu-xhci,p2=15,p3=15,id=usb,bus=pci.3,addr=0x0 -device virtio-serial-pci,id=virtio-serial0,bus=pci.4,addr=0x0 -blockdev &#123;&quot;driver&quot;:&quot;file&quot;,&quot;filename&quot;:&quot;/var/lib/libvirt/images/csr1000v-universalk9.17.02.01v.qcow2&quot;,&quot;node-name&quot;:&quot;libvirt-1-storage&quot;,&quot;auto-read-only&quot;:true,&quot;discard&quot;:&quot;unmap&quot;&#125; -blockdev &#123;&quot;node-name&quot;:&quot;libvirt-1-format&quot;,&quot;read-only&quot;:false,&quot;driver&quot;:&quot;qcow2&quot;,&quot;file&quot;:&quot;libvirt-1-storage&quot;,&quot;backing&quot;:null&#125; -device virtio-blk-pci,scsi=off,bus=pci.5,addr=0x0,drive=libvirt-1-format,id=virtio-disk0,bootindex=1 -netdev tap,fd=33,id=hostnet0,vhost=on,vhostfd=34 -device virtio-net-pci,netdev=hostnet0,id=net0,mac=52:54:00:69:ec:73,bus=pci.1,addr=0x0 -chardev pty,id=charserial0 -device isa-serial,chardev=charserial0,id=serial0 -chardev socket,id=charchannel0,fd=35,server,nowait -device virtserialport,bus=virtio-serial0.0,nr=1,chardev=charchannel0,id=channel0,name=org.qemu.guest_agent.0 -chardev spicevmc,id=charchannel1,name=vdagent -device virtserialport,bus=virtio-serial0.0,nr=2,chardev=charchannel1,id=channel1,name=com.redhat.spice.0 -spice port=5900,addr=127.0.0.1,disable-ticketing,image-compression=off,seamless-migration=on -device qxl-vga,id=video0,ram_size=67108864,vram_size=67108864,vram64_size_mb=0,vgamem_mb=16,max_outputs=1,bus=pcie.0,addr=0x1 -device vfio-pci,host=0000:5e:02.0,id=hostdev0,bus=pci.2,addr=0x0 -device vfio-pci,host=0000:5e:0a.0,id=hostdev1,bus=pci.8,addr=0x0 -sandbox on,obsolete=deny,elevateprivileges=deny,spawn=deny,resourcecontrol=deny -msg timestamp=on ä½¿ç”¨pstreeæ£€æŸ¥çº¿ç¨‹ä¿¡æ¯ï¼š 123456789101112root@ubuntu-kvm:/home/ubuntu# pstree -p 8526qemu-system-x86(8526)â”€â”¬â”€&#123;qemu-system-x86&#125;(8530) â”œâ”€&#123;qemu-system-x86&#125;(8534) â”œâ”€&#123;qemu-system-x86&#125;(8535) â”œâ”€&#123;qemu-system-x86&#125;(8536) â”œâ”€&#123;qemu-system-x86&#125;(8537) â”œâ”€&#123;qemu-system-x86&#125;(8538) â”œâ”€&#123;qemu-system-x86&#125;(8539) â”œâ”€&#123;qemu-system-x86&#125;(8540) â”œâ”€&#123;qemu-system-x86&#125;(8541) â”œâ”€&#123;qemu-system-x86&#125;(8542) â”œâ”€&#123;qemu-system-x86&#125;(8552) ä½¿ç”¨gbd è°ƒè¯•è¿›ç¨‹ï¼Œè¿™é‡Œå‚è€ƒhttps://www.cnblogs.com/hukey/p/11138768.html 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051root@ubuntu-kvm:/home/ubuntu# gdb attach 8526GNU gdb (Ubuntu 9.2-0ubuntu1~20.04) 9.2Copyright (C) 2020 Free Software Foundation, Inc.License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;This is free software: you are free to change and redistribute it.There is NO WARRANTY, to the extent permitted by law.Type &quot;show copying&quot; and &quot;show warranty&quot; for details.This GDB was configured as &quot;x86_64-linux-gnu&quot;.Type &quot;show configuration&quot; for configuration details.For bug reporting instructions, please see:&lt;http://www.gnu.org/software/gdb/bugs/&gt;.Find the GDB manual and other documentation resources online at: &lt;http://www.gnu.org/software/gdb/documentation/&gt;.For help, type &quot;help&quot;.Type &quot;apropos word&quot; to search for commands related to &quot;word&quot;.Attaching to process 8526[New LWP 8530][New LWP 8534][New LWP 8535][New LWP 8536][New LWP 8537][New LWP 8538][New LWP 8539][New LWP 8540][New LWP 8541][New LWP 8542][New LWP 8552][New LWP 250213]warning: &quot;target:/usr/bin/qemu-system-x86_64 (deleted)&quot;: could not open as an executable file: No such file or directory.warning: `target:/usr/bin/qemu-system-x86_64 (deleted)&#x27;: can&#x27;t open to read symbols: No such file or directory.warning: Could not load vsyscall page because no executable was specified0x00007fdcda986bf6 in ?? ()(gdb) info threads Id Target Id Frame* 1 LWP 8526 &quot;qemu-system-x86&quot; 0x00007fdcda986bf6 in ?? () 2 LWP 8530 &quot;call_rcu&quot; 0x00007fdcda98c89d in ?? () 3 LWP 8534 &quot;IO mon_iothread&quot; 0x00007fdcda986aff in ?? () 4 LWP 8535 &quot;CPU 0/KVM&quot; 0x00007fdcda98850b in ?? () 5 LWP 8536 &quot;CPU 1/KVM&quot; 0x00007fdcda98850b in ?? () 6 LWP 8537 &quot;CPU 2/KVM&quot; 0x00007fdcda98850b in ?? () 7 LWP 8538 &quot;CPU 3/KVM&quot; 0x00007fdcda98850b in ?? () 8 LWP 8539 &quot;CPU 4/KVM&quot; 0x00007fdcda98850b in ?? () 9 LWP 8540 &quot;CPU 5/KVM&quot; 0x00007fdcda98850b in ?? () 10 LWP 8541 &quot;CPU 6/KVM&quot; 0x00007fdcda98850b in ?? () 11 LWP 8542 &quot;CPU 7/KVM&quot; 0x00007fdcda98850b in ?? () 12 LWP 8552 &quot;SPICE Worker&quot; 0x00007fdcda986aff in ?? () 13 LWP 250213 &quot;worker&quot; 0x00007fdcdaa76618 in ?? () Chapter 4 KVM ç½‘ç»œæœ¬ç« èŠ‚ä»‹ç»äº†ä»¥ä¸‹å†…å®¹ Virtual Network â€“ é˜è¿°ä¸ºä»€ä¹ˆéœ€è¦è™šæ‹Ÿç½‘ç»œã€‚ä»è™šæ‹Ÿäº¤æ¢æœºå¼€å§‹ï¼Œè®¾æƒ³ä¸€ä¸‹å¦‚æœæ²¡æœ‰è™šæ‹Ÿäº¤æ¢æœºï¼Œæœ‰20ä¸ªè™šæ‹Ÿæœºéœ€è¦20ä¸ªç‰©ç†æ¥å£è¿æ¥è‡³20ä¸ªç‰©ç†äº¤æ¢æœºçš„ç«¯å£ã€‚å¼•å…¥è™šæ‹Ÿäº¤æ¢æœºï¼Œå‡å°‘æœåŠ¡å™¨çš„ç‰©ç†æ¥å£å’Œç‰©ç†äº¤æ¢æœºçš„æ¥å£éœ€æ±‚ã€‚ Libvirt çš„ä¸‰ç±»ç½‘ç»œï¼šNATã€Routed(Bridged)ã€Isolatedï¼›ä½¿ç”¨virsh net-dumpxml defaultè¾“å‡ºxmlæ–‡ä»¶ã€‚ TUN/TAPè®¾å¤‡ï¼šå±äºç”¨æˆ·ç©ºé—´çš„è®¾å¤‡ï¼Œan application can open /dev/net/tun and use an ioctl() function to register a network device in the kernel, which, in turn, presents itself as a tunXX or tapXX device. TUNè®¾å¤‡æ˜¯ä¸€ä¸ª3å±‚è®¾å¤‡ï¼ŒTAPè®¾å¤‡æ˜¯ä¸€ä¸ª2å±‚è®¾å¤‡ã€‚ ç®€å•ä»‹ç»äº†Linux Bridgeï¼Œæ­¤å¤„å¯ä»¥ä½¿ç”¨ip link å‘½ä»¤æ›¿ä»£brctlå‘½ä»¤ï¼Œå¹¶ä½¿ç”¨NetworkManageræ¥æŒä¹…åŒ–é…ç½®ã€‚ Open vSwitchç®€å•ä»‹ç» SR-IOVçš„ä»‹ç»ï¼šæ­¤å¤„å¯ä»¥å‚è€ƒæˆ‘è‡ªå·±çš„æ–‡æ¡£ã€‚ MACVTAPä»‹ç»ï¼šItâ€™s a newer driver that should simplify our virtualized networking by completely removing tun/tap and bridge drivers with a single module. æœ‰å››ç§æ¨¡å¼ï¼ŒVEPAï¼ŒBridgeï¼ŒPrivateå’ŒPass-throughã€‚ Chapter 5 KVM å­˜å‚¨æœ¬ç« å±äºå›«å›µåæ£çš„çœ‹å®Œäº†ï¼Œä¸€çŸ¥åŠè§£çš„è®°å½•ä¸€ä¸‹ï¼Œå¤§è‡´äº†è§£äº†ä¸€äº›å­˜å‚¨æ–¹é¢çš„æ¦‚å¿µå’Œå­˜å‚¨çš„æœ€æ–°å‘å±•ã€‚ å­˜å‚¨èµ„æºæ± CentOSæ”¯æŒçš„å­˜å‚¨æ± ç§ç±»å¦‚ä¸‹ï¼š Logical Volume Manager (LVM)-based storage pools Directory-based storage pools Partition-based storage pools GlusterFS-based storage pools iSCSI-based storage pools Disk-based storage pools HBA-based storage pools, which use SCSI devices å¯¹äºlibvirtæ¥è¯´ï¼Œå­˜å‚¨èµ„æºæ± å¯èƒ½æ˜¯ä¸€ä¸ªç›®å½•ï¼Œä¸€ä¸ªå­˜å‚¨è®¾å¤‡ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªæ–‡ä»¶ã€‚ ä»‹ç»äº†ä¸¤ç§æ–‡ä»¶ç³»ç»Ÿï¼š Brtfs is a type of filesystem that supports snapshots, RAID and LVM-like functionality, compression, defragmentation, online resizing, and many other advanced features. It was deprecated after it was discovered that its RAID5/6 can easily lead to a loss of data. â€“è¿™é‡Œè¯´çš„æ˜¯Red Hat ZFS is a type of filesystem that supports everything that Brtfs does, plus read and write caching. ZFS is not a part of the Linux kernel. æœ¬åœ°å­˜å‚¨æ± Stratisæ˜¯éšRHEL 8å¼•å…¥çš„æœ¬åœ°ç®¡ç†å­˜å‚¨è§£å†³æ–¹æ¡ˆï¼Œå®ƒä½¿ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥é…ç½®é«˜çº§å­˜å‚¨åŠŸèƒ½ï¼š Pool-based management Thin provisioning File system snapshots Monitoring Stratisä½¿ç”¨ç¤ºä¾‹ï¼š 123456mdadm --create /dev/md0 --verbose --level=10 --raid-devices=4 /dev/sdb /dev/sdc /dev/sdd /dev/sde --spare-devices=1 /dev/sdf2stratis pool create PacktStratisPool01 /dev/md0stratis pool add-cache PacktStratisPool01 /dev/sdgstratis fs create PackStratisPool01 PacktStratisXFS01mkdir /mnt/packtStratisXFS01mount /stratis/PacktStratisPool01/PacktStratisXFS01 /mnt/packtStratisXFS01 Libvirt Storage PoolLibvirt æ”¯æŒå¤šç§Storage Poolï¼Œè¯¦è§https://libvirt.org/storage.html Directory pool Filesystem pool Network filesystem pool Logical volume pool Disk pool iSCSI pool iSCSI direct pool SCSI pool Multipath pool RBD pool Sheepdog pool Gluster pool ZFS pool Vstorage pool NFS Storage PoolNFSè‡ªä¸Šä¸–çºª80å¹´ä»£å°±å‡ºç°äº†ï¼Œè‡³ä»Šä¾ç„¶æ´»è·ƒï¼Œå°¤å…¶æ˜¯4.2ç‰ˆæœ¬ä»¥åå¢å¼ºäº†ä¸å°‘åŠŸèƒ½ï¼›VMware Virtual Volume 6.0 å¯ä»¥æä¾›åŸºäºBlockå’ŒNFSçš„ä¸¤ç§å­˜å‚¨è®¿é—®ã€‚ Libvirt ä½¿ç”¨NFS Storage Poolç¤ºä¾‹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨virt-manager å›¾å½¢ç•Œé¢åˆ›å»ºï¼š 1234567891011121314151617&lt;pool type=&#x27;netfs&#x27;&gt; &lt;name&gt;NFSpooll&lt;/name&gt; &lt;source&gt; &lt;host name=&#x27;192.168.159.144&#x27; /&gt; &lt;dir path=&#x27;/mnt/packtStratisXF501&#x27; /&gt; &lt;format type=&#x27;auto&#x27;/&gt; &lt;/source&gt; &lt;target&gt; &lt;path&gt;/var/lib/libvirt/images/NFSpooll&lt;/path&gt; &lt;permissions&gt; &lt;mode&gt;0755&lt;/mode&gt; &lt;owner&gt;0&lt;/owner&gt; &lt;group&gt;0&lt;/group&gt; &lt;label&gt;system_u:object r:nfs t:s0&lt;/label&gt; &lt;/permissions&gt; &lt;/target&gt;&lt;/pool&gt; iSCIS å’Œ SAN å­˜å‚¨iSCISåè®®æœ‰ä¸¤ä¸ªä¸»è¦åŸå› å½±å“å…¶é«˜æ•ˆæ€§ï¼š IPåè®®å°è£… iSCSI encapsulates SCSI commands into regular IP packages, which means segmentation and overhead as IP packages have a pretty large header, which means less efficiency. åŸºäºTCPä¼ è¾“ Even worse, itâ€™s TCP-based, which means that there are sequence numbers and retransmissions, which can lead to queueing and latency, and the bigger the environment is, the more you usually feel these effects affect your virtual machine performance. The iSCSI and FC architectures are very similarâ€”they both need a target (an iSCSI target and an FC target) and an initiator (an iSCS initiator and an FC initiator)ï¼Œthe initiator connects to a target to get access to block storage thatâ€™s presented via that target. LUNçš„æ¦‚å¿µLUNs are just raw, block capacities that we export via an iSCSI target toward initiators. LUNs are indexed, or numbered, usually from 0 onward. Every LUN number represents a different storage capacity that an initiator can connect to. For example, we can have an iSCSI target with three different LUNsâ€”LUN0 with 20 GB, LUN1 with 40 GB, and LUN2 with 60 GB. These will all be hosted on the same storage systemâ€™s iSCSI target. We can then configure the iSCSI target to accept an IQN to see all the LUNs, another IQN to only see LUN1, and another IQN to only see LUN1 and LUN2. ä½¿ç”¨ targetcliå‘½ä»¤åˆ›å»ºiSCIS targetï¼Œæ­¥éª¤ç®€è¦è¯´æ˜å¦‚ä¸‹ï¼š åˆ›å»º/dev/sdb1åˆ†åŒºå’ŒXFSæ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶mount /dev/sdb1 /LUN0ï¼Œç”¨targetcliåˆ›å»ºä¸€ä¸ªfileio ç±»å‹çš„targetåç«¯ åˆ›å»º/dev/sdc1åˆ†åŒºï¼Œå¹¶ç›´æ¥ä½¿ç”¨targetcliåˆ›å»ºä¸€ä¸ªblockç±»å‹çš„targetåç«¯ åŸºäº/dev/sddåˆ›å»ºLVMï¼Œå¹¶ä½¿ç”¨targetcliåˆ›å»ºä¸€ä¸ªblockç±»å‹çš„targetåç«¯ åœ¨KVMä¸»æœºä¸Šè®¾ç½®å¥½iscsiçš„initiatorå‚æ•° å›åˆ°iSCSIä¸Šï¼Œåˆ›å»ºACLï¼Œå…è®¸KVM hostï¼ŒåŸºäº1~3åˆ›å»ºçš„targetå‘å¸ƒLUNs åœ¨KVM Hostä¸Šå®šä¹‰Storage Poolçš„XMLæ–‡ä»¶ï¼Œç”¨virsh pool-defineåˆ›å»ºStorage Pool Storage redundancy and multipathingé¿å…å•ç‚¹æ•…éšœSPOFï¼Œç½‘å¡ã€çº¿ç¼†ã€äº¤æ¢æœºã€å­˜å‚¨æ§åˆ¶å™¨ç­‰ç­‰ã€‚ KVM HoståŸºäºiSCSIåšå†—ä½™å’Œå¤šè·¯å¾„çš„é…ç½®è¾ƒä¸ºå¤æ‚ï¼Œå¹¶ä¸”ç¼ºå°‘æ”¯æŒï¼Œæ–‡ç« å»ºè®®ä½¿ç”¨oVirtæˆ–è€…RHEV-H(Red Hat Enterprise Virtualization Hypervisor. ) ä½¿ç”¨oVirt åˆ›å»ºä¸€ä¸ªiSCSI Bondæ¥å®ç°å†—ä½™å’Œå¤šè·¯å¾„ã€‚ GlusterGluster æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼Œå…¶çªå‡ºä¼˜åŠ¿æ˜¯å¯æ‰©å±•æ€§ï¼Œæ•°æ®å¤åˆ¶å’Œå¿«ç…§åŠŸèƒ½ï¼›æ³¨æ„Glusteræ˜¯ä¸€ä¸ªæ–‡ä»¶å­˜å‚¨æœåŠ¡ã€‚ ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒGlusterè‡³å°‘é…ç½®ä¸‰å°æœåŠ¡å™¨ã€‚ é…ç½®æ­¥éª¤ç®€è¦è¯´æ˜å¦‚ä¸‹ï¼š åˆ›å»ºç£ç›˜åˆ†åŒºä»¥åŠæ–‡ä»¶ç³»ç»Ÿ 123456mkfs.xfs /dev/sdbmkdir /gluster/bricks/1 -pecho &#x27;/dev/sdb /gluster/bricks/1 xfs defaults 0 0&#x27; &gt;&gt; /etc/fstabmount -amkdir /gluster/bricks/1/brick åˆ›å»ºGlusteråˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ 12345678gluster volume create kvmgluster replica 3 \\ gluster1:/gluster/bricks/1/brick gluster2:/gluster/bricks/1/brick \\ gluster3:/gluster/bricks/1/brickgluster volume start kvmglustergluster volume set kvmgluster auth.allow 192.168.159.0/24gluster volume set kvmgluster allow-insecure ongluster volume set kvmgluster storage.owner-uid 107gluster volume set kvmgluster storage.owner-gid 107 æŒ‚åœ¨Glusteræ–‡ä»¶ç³»ç»Ÿä¸ºNFSæœåŠ¡ 123echo &#x27;localhost:/kvmgluster /mnt glusterfs \\ defaults,_netdev,backupvolfile-server=localhost 0 0&#x27; &gt;&gt; /etc/fstabmount.glusterfs localhost:/kvmgluster /mnt åœ¨KVMä¸»æœºä¸ŠæŒ‚åœ¨Gluster 123456wget \\ https://download.gluster.org/pub/gluster/glusterfs/6/LATEST/CentOS/gl\\ usterfs-rhel8.repo -P /etc/yum.repos.dyum install glusterfs glusterfs-fuse attr -ymount -t glusterfs -o context=&quot;system_u:object_r:virt_image_t:s0&quot; \\ gluster1:/kvmgluster /var/lib/libvirt/images/GlusterFS åœ¨KVMä¸Šå®šä¹‰å­˜å‚¨èµ„æºæ± ï¼š 123456789101112&lt;pool type=&#x27;dir&#x27;&gt; &lt;name&gt;glusterfs-pool&lt;/name&gt; &lt;target&gt; &lt;path&gt;/var/lib/libvirt/images/GlusterFS&lt;/path&gt; &lt;permissions&gt; &lt;mode&gt;0755&lt;/mode&gt; &lt;owner&gt;107&lt;/owner&gt; &lt;group&gt;107&lt;/group&gt; &lt;label&gt;system_u:object_r:virt_image_t:s0&lt;/label&gt; &lt;/permissions&gt; &lt;/target&gt;&lt;/pool&gt; 123virsh pool-define --file gluster.xmlvirsh pool-start --pool glusterfs-poolvirsh pool-autostart --pool glusterfs-pool å°†GlusteræŒ‚åœ¨ä¸ºç›®å½•ï¼Œå¯ä»¥é¿å…Libvirtåœ¨ä½¿ç”¨Glusterçš„ä¸¤ä¸ªé—®é¢˜ï¼š We can use Glusterâ€™s failover capability, which will be managed automatically by the Gluster utilities that we installed directly, as libvirt doesnâ€™t support them yet. We will avoid creating virtual machine disks manually, which is another limitation of libvirtâ€™s implementation of Gluster support, while directory-based storage pools support it without any issues. CephCeph offers block and object-based storage. Object-based storage for block-based devices means direct, binary storage, directly to a LUN. There are no filesystems involved, which theoretically means less overhead as thereâ€™s no filesystem, filesystem tables, and other constructs that might slow the I/O process down. Architecture-wise, Ceph has three main services: ceph-mon : Used for cluster monitoring, CRUSH maps, and Object Storage Daemon (OSD) maps. ceph-osd: This handles actual data storage, replication, and recovery. It requires at least two nodes; weâ€™ll use three for clustering reasons. ceph-mds: Metadata server, used when Ceph needs filesystem access. Ceph é›†ç¾¤ä¸­ï¼Œæ‰€æœ‰çš„æ•°æ®èŠ‚ç‚¹è¦æ±‚é‡‡ç”¨ç›¸åŒçš„ç¡¬ä»¶é…ç½®ï¼Œç›¸åŒçš„CPUã€å†…å­˜ã€ç¡¬ç›˜ï¼Œä¸é€‚ç”¨RAIDæ§åˆ¶å™¨ï¼Œä»…ä»…ä½¿ç”¨HBAã€‚ 1234567891011ceph-deploy install ceph-admin ceph-monitor ceph-osd1 ceph-osd2ceph-osd3ceph-deploy mon create-initialceph-deploy gatherkeys ceph-monitorceph-deploy disk list ceph-osd1 ceph-osd2 ceph-osd3ceph-deploy disk zap ceph-osd1:/dev/sdb ceph-osd2:/dev/sdbceph-osd3:/dev/sdbceph-deploy osd prepare ceph-osd1:/dev/sdb ceph-osd2:/dev/sdbceph-osd3:/dev/sdbceph-deploy osd activate ceph-osd1:/dev/sdb1 ceph-osd2:/dev/sdb1 ceph-osd3:/dev/sdb1 å¯¹ä¸Šè¿°å‘½ä»¤çš„è¯´æ˜ï¼š The first command starts the actual deployment processâ€”for the admin, monitor, and OSD nodes, with the installation of all the necessary packages. The second and third commands configure the monitor host so that itâ€™s ready to accept external connections. The two disk commands are all about disk preparationâ€”Ceph will clear the disks that we assigned to it (/dev/sdb per OSD host) and create two partitions on them, one for Ceph data and one for the Ceph journal. The last two commands prepare these filesystems for use and activate Ceph. If at any time your ceph-deploy script stops, check your DNS and /etc/hosts and firewalld configuration, as thatâ€™s where the problems usually are. ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°†Cephå­˜å‚¨å‘å¸ƒç»™KVMä¸»æœºä½œä¸ºå­˜å‚¨æ± ï¼š 1ceph osd pool create KVMpool 128 128 è¿˜éœ€è¦å‡ ä¸ªæ­¥éª¤æ¥å®ç°å®‰å…¨çš„è®¿é—®ï¼Œä¸ºCephçš„è®¿é—®å¢åŠ å¯†ç éªŒè¯ã€‚ Cephç”ŸæˆéªŒè¯çš„å¯†ç  Key 123456ceph auth get-or-create client.KVMpool mon &#x27;allow r&#x27; osd &#x27;allowrwx pool=KVMpool&#x27;#It&#x27;s going to throw us a status message, something like this:key = AQB9p8RdqS09CBAA1DHsiZJbehb7ZBffhfmFJQ== å®šä¹‰ä¸€ä¸ªSecret 123456&lt;secret ephemeral=&#x27;no&#x27; private=&#x27;no&#x27;&gt; &lt;usage type=&#x27;ceph&#x27;&gt; &lt;name&gt;client.KVMpool secret&lt;/name&gt; &lt;/usage&gt;&lt;/secret&gt; å°†Secretçš„UUIDä¸Cephç”Ÿæˆçš„Keyè¿›è¡Œå…³è”ã€‚ 123456virsh secret-define --file secret.xmlSecret 95b1ed29-16aa-4e95-9917-c2cd4f3b2791 createdvirsh secret-set-value 95b1ed29-16aa-4e95-9917-c2cd4f3b2791AQB9p8RdqS09CBAA1DHsiZJbehb7ZBffhfmFJQ== å®šä¹‰Cephå­˜å‚¨æ±  123456789&lt;pool type=&quot;rbd&quot;&gt; &lt;source&gt; &lt;name&gt;KVMpool&lt;/name&gt; &lt;host name=&#x27;192.168.159.151&#x27; port=&#x27;6789&#x27;/&gt; &lt;auth username=&#x27;KVMpool&#x27; type=&#x27;ceph&#x27;&gt; &lt;secret uuid=&#x27;95b1ed29-16aa-4e95-9917-c2cd4f3b2791&#x27;/&gt; &lt;/auth&gt; &lt;/source&gt;&lt;/pool&gt; 1234virsh pool-define --file ceph.xmlvirsh pool-start KVMpoolvirsh pool-autostart KVMpoolvirsh pool-list --details è™šæ‹Ÿç£ç›˜é•œåƒå’ŒKVMå­˜å‚¨åŸºæœ¬æ“ä½œ æ–‡ç« ä»‹ç»äº†ä½¿ç”¨ddå‘½ä»¤ç”Ÿæˆç£ç›˜é•œåƒæ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š ç”Ÿæˆ10Gçš„é¢„åˆ†é…ç£ç›˜æ–‡ä»¶ï¼š 1dd if=/dev/zero of=/vms/dbvm_disk2.img bs=1G count=10 ç”Ÿæˆ10Gçš„ç£ç›˜æ–‡ä»¶ï¼Œä½¿ç”¨seekå…³é”®å­—ï¼Œä¸åšé¢„åˆ†é… 1dd if=/dev/zero of=/vms/dbvm_disk2_seek.imgbs=1G seek=10 count=0 qemu-img å‘½ä»¤ä½¿ç”¨qemu-img infoæŸ¥çœ‹ç£ç›˜æ–‡ä»¶çš„ä¿¡æ¯ï¼Œå¦‚ä¸‹ï¼š 12345678910# qemu-img info /vms/dbvm_disk2.imgimage: /vms/dbvm_disk2.imgfile format: rawvirtual size: 10G (10737418240 bytes)disk size: 10G# qemu-img info /vms/dbvm_disk2_seek.imgimage: /vms/dbvm_disk2_seek.imgfile format: rawvirtual size: 10G (10737418240 bytes)disk size: 10M ä½¿ç”¨virshå‘½ä»¤åŠ è½½ç¡¬ç›˜1virsh attach-disk CentOS8 /vms/dbvm_disk2.img vdb --live --config è¯´æ˜å¦‚ä¸‹ï¼š CentOS8 is the virtual machine to which a disk attachment is executed. Then, there is the path of the disk image, /vms/dbvm_disk2.img vdb is the target disk name that would be visible inside the guest operating system. â€“live means performing the action while the virtual machine is running. â€“config means attaching it persistently across reboot. Not adding a â€“config switch will keep the disk attached only until reboot. æŸ¥çœ‹è™šæ‹Ÿæœºçš„ç¡¬ç›˜ä¿¡æ¯ï¼š 123456virsh domblklist CentOS8 --detailsType Device Target Source------------------------------------------------file disk vda /var/lib/libvirt/images/fedora21.qcow2file disk vdb /vms/dbvm_disk2_seek.img è¿˜æœ‰å…¶ä»–ç« èŠ‚ï¼Œæ¯”å¦‚åˆ›å»ºISOåº“ã€åˆ é™¤å­˜å‚¨æ± ã€åˆ›å»ºå·å’Œåˆ é™¤å·ã€‚ æœ‰å…³NVMeå’ŒNVMe over FabricSSDå­˜å‚¨çš„å­˜å–æ–¹å¼å‘ç”Ÿæ”¹å˜ï¼Œä¸»è¦ä½“ç°åœ¨æ€§èƒ½å’Œå»¶æ—¶è¿™ä¸¤æ–¹é¢ã€‚ä¼ ç»ŸAHCI (Advanced Host Controller Interface) å·²ä¸èƒ½æ»¡è¶³SSDçš„æ€§èƒ½è¦æ±‚ã€‚ NVMe (Non-Volatile Memory Express) æ˜¯ä¸€ä¸ªå…¨æ–°çš„åè®®ï¼ŒåŸºäºPCIeæŠ€æœ¯ï¼Œç›®çš„åœ¨äºæ»¡è¶³SSDçš„é«˜æ€§èƒ½ã€ä½æ—¶å»¶çš„è®¿é—®è¦æ±‚ã€‚è¶Šæ¥è¶Šå¤šçš„å­˜å‚¨è®¾å¤‡å·²ç»é›†æˆäº†SSDå’ŒNVMeï¼Œä¸»è¦ç”¨äºç¼“å­˜ï¼ŒåŒæ—¶ä¹Ÿæœ‰ç”¨äºæ•°æ®å­˜å‚¨çš„ã€‚ Fiber Channelï¼Œè™½ç„¶10å¤šå¹´è¢«äººäº‰æ‰§è¯´è¦ä»å¸‚åœºæ¶ˆå¤±ï¼Œä¸»è¦åŸå› æ— å¤–ä¹ï¼šFCéœ€è¦ä¸“ç”¨çš„äº¤æ¢æœºã€ä¸“é—¨çš„ç½‘å¡å’Œçº¿ç¼†ï¼ŒFCè®¾å¤‡è´µï¼Œéœ€è¦ä¸“é—¨çš„çŸ¥è¯†ï¼Œè€Œä¸”FCçš„é€Ÿç‡æ²¡æœ‰ä»¥å¤ªç½‘å‘å±•å¿«ã€‚ ä½†æ˜¯ï¼Œç›®å‰å¸‚åœºä¸Šå‘ç”Ÿçš„æƒ…å†µæœ‰æ‰€ä¸åŒï¼ŒFCå¯ä»¥æ»¡è¶³NVMe SSDå¸¦æ¥çš„æ€§èƒ½æå‡çš„éœ€æ±‚ã€‚ Two of these concepts derived from Intel Optaneâ€”Storage Class Memory (SCM) and Persistent Memory (PM) are the latest technologies that storage companies and customers want adopted into their storage systems, and fast. å°†å·¥ä½œè´Ÿè½½ç§»åˆ°å†…å­˜å½“ä¸­æ˜¯ç¬¦åˆé€»è¾‘çš„ï¼Œè®¾æƒ³ä¸€ä¸‹å†…å­˜å‹æ•°æ®åº“(Microsoft SQL, SAP HANA, Oracle). å¦‚æœä¸€ä¸ªå­˜å‚¨å‚å•†ç”Ÿäº§äº†ä½¿ç”¨SCM SSDçš„å­˜å‚¨è®¾å¤‡ï¼Œé‚£ä¹ˆåªæœ‰å†…å­˜å¯ç”¨äºç¼“å­˜(Cache).","categories":[],"tags":[{"name":"kvm","slug":"kvm","permalink":"https://weiborao.link/tags/kvm/"}]},{"title":"Cisco NFVIS CSR1Kv ZTP Onboarding for SDWAN","slug":"csr1kv-nfvis-ztp-demo","date":"2021-02-08T03:02:43.000Z","updated":"2021-09-17T06:27:54.266Z","comments":true,"path":"csr1kv-nfvis-ztp-demo.html","link":"","permalink":"https://weiborao.link/csr1kv-nfvis-ztp-demo.html","excerpt":"","text":"","categories":[],"tags":[{"name":"ztp","slug":"ztp","permalink":"https://weiborao.link/tags/ztp/"},{"name":"nfvis","slug":"nfvis","permalink":"https://weiborao.link/tags/nfvis/"}]},{"title":"Cisco CSR 1000v & Catalyst 8000v KVM SRIOVå®‰è£…è®¾ç½®æ¼”ç¤º","slug":"csr1kv-kvm-sriov-ubuntu-demo","date":"2021-02-08T02:36:08.000Z","updated":"2021-09-17T06:29:03.172Z","comments":true,"path":"csr1kv-kvm-sriov-ubuntu-demo.html","link":"","permalink":"https://weiborao.link/csr1kv-kvm-sriov-ubuntu-demo.html","excerpt":"","text":"é¸£è°¢ï¼šJohnny Rong Hexoåšå®¢ä¸­æ·»åŠ Bç«™è§†é¢‘æ’­æ”¾å™¨","categories":[],"tags":[{"name":"sriov","slug":"sriov","permalink":"https://weiborao.link/tags/sriov/"},{"name":"csr1000v","slug":"csr1000v","permalink":"https://weiborao.link/tags/csr1000v/"},{"name":"ztp","slug":"ztp","permalink":"https://weiborao.link/tags/ztp/"}]},{"title":"Hexo å®‰è£…è®¾ç½®é‡åˆ°çš„é—®é¢˜åŠè§£å†³åŠæ³•","slug":"hexo-setup-log-md","date":"2021-02-07T15:36:19.000Z","updated":"2021-02-08T15:43:30.966Z","comments":true,"path":"hexo-setup-log-md.html","link":"","permalink":"https://weiborao.link/hexo-setup-log-md.html","excerpt":"","text":"é‡åˆ°çš„é—®é¢˜æ­£å¸¸æŒ‰ç…§brew install node ä»¥åŠ npm install -g hexo-cli å®‰è£…å®Œä»¥åï¼Œè¿è¡Œhexo deployæŠ¥é”™ï¼Œå¦‚ä¸‹ï¼š 12345678910âœ blog hexo dINFO Validating configINFO Deploying: gitINFO Clearing .deploy_git folder...INFO Copying files from public folder...FATAL &#123; err: TypeError [ERR_INVALID_ARG_TYPE]: The &quot;mode&quot; argument must be integer. Received an instance of Object at copyFile (node:fs:2019:10) at tryCatcher (/Users/werao/blog/node_modules/bluebird/js/release/util.js:16:23) at ret (eval at makeNodePromisifiedEval (/usr/local/lib/node_modules/hexo-cli/node_modules/bluebird/js/release/promisify.js:184:12), &lt;anonymous&gt;:13:39) ç½‘ä¸ŠæŸ¥æ‰¾äº†ä¸€ä¸‹ï¼ŒæŠ¥é”™çš„åŸå› æ˜¯Hexoä¸Node.jsçš„å…¼å®¹æ€§é—®é¢˜ã€‚ è§£å†³åŠæ³•éå¸¸å¹¸è¿ï¼Œæ‰¾åˆ°ä¸€ç¯‡æ–‡ç« ï¼šé‡è£…Hexoé‡åˆ°çš„å‘ ä½œè€… æˆç™¾å·ã€‚ ç®€è¦è®°å½•æ­¥éª¤å¦‚ä¸‹ï¼š å¸è½½nodebrew uninstall node å®‰è£…nvmbrew install nvmè®°å¾—æŒ‰æç¤ºä¿®æ”¹**~/.zshrcæ–‡ä»¶ï¼Œå¦åˆ™ä¸‹æ¬¡å¯åŠ¨ä¼šæ‰¾ä¸åˆ°nvm**ã€‚ ä½¿ç”¨nvmå®‰è£…ä½äº14.0ç‰ˆæœ¬çš„node.jsâ€“å¦‚æœåç»­ç‰ˆæœ¬å‡çº§ï¼Œè¿˜å¯ä»¥ä½¿ç”¨nvmå®‰è£…æ–°ç‰ˆæœ¬ã€‚nvm install v13.14.0 12Now using node v13.14.0 (npm v6.14.4)Creating default alias: default -&gt; v13.14.0 é‡æ–°è¿è¡Œhexo deploy -g å‘å¸ƒæœ¬æ–‡ã€‚ é¸£è°¢æˆç™¾å·ã€‚","categories":[],"tags":[{"name":"hexo","slug":"hexo","permalink":"https://weiborao.link/tags/hexo/"}]},{"title":"Cisco CSR1000v KVM SRIOV Setting Guide on Ubuntu 20.04 With NetworkManager","slug":"csr1kv-kvm-Ubuntu20-04-md","date":"2021-02-03T14:37:33.000Z","updated":"2021-02-08T03:38:30.670Z","comments":true,"path":"csr1kv-kvm-Ubuntu20-04-md.html","link":"","permalink":"https://weiborao.link/csr1kv-kvm-Ubuntu20-04-md.html","excerpt":"","text":"Last Update: February 3, 2021 Author: Rao Weibo Version: 1.0 This guide provides the steps on how to install CSR1000v/Catalyst 8000v on KVM, the setting of SRIOV and KVM tuning. Ubuntu 20.04 Installation and Settings(1) BIOS settings Configuration Recommended Setting Intel Hyper-Threading Technology Disabled Number of Enable Cores ALL Execute Disable Enabled Intel VT Enabled Intel VT-D Enabled Intel VT-D coherency support Enabled Intel VT-D ATS support Enabled CPU Performance High throughput Hardware Perfetcher Disabled Adjacent Cache Line Prefetcher Disabled DCU Streamer Prefetch Disable Power Technology Custom Enhanced Intel Speedstep Technology Disabled Intel Turbo Boost Technology Enabled Processor Power State C6 Disabled Processor Power State C1 Enhanced Disabled Frequency Poor Override Enabled P-State Coordination HW_ALL Energy Performance Performance The above settings are from the Installation guide from Cisco CSR 1000v and Cisco ISRv Software Configuration Guide.Note: some platform such as Cisco NFVIS, does not disable the Hyper-Threading. (2) Ubuntu 20.04 installation tipsIf you need the Gnome GUI, you can install the Ubuntu 20.04 Desktop.After the system bootup, â€˜apparmorâ€™ is recommended to be disabled, otherwise, you may meet permission denied when you assign SRIOV devices to the CSR1kV. You need to reboot to take effect. 12sudo systemctl disable apparmoregrep -o &#x27;(vmx|svm)&#x27; /proc/cpuinfo | sort | uniq You can find the vmx on Intel platform, or svm on AMD platform. 12sudo systemctl stop ufwsystemctl disable ufw cat /etc/sysctl.conf 1234net.ipv4.ip_forward = 1net.bridge.bridge-nf-call-ip6tables = 0net.bridge.bridge-nf-call-iptables = 0net.bridge.bridge-nf-call-arptables = 0 1$ sudo apt install qemu-kvm libvirt-clients libvirt-daemon-system bridge-utils virt-manager numactl virt-top After installation, you can check the version 123456789101112ubuntu@ubuntu-kvm:~$ libvirtd -Vlibvirtd (libvirt) 6.0.0ubuntu@ubuntu-kvm:~$ qemu-system-x86_64 --versionQEMU emulator version 4.2.1 (Debian 1:4.2-3ubuntu6.11)Copyright (c) 2003-2019 Fabrice Bellard and the QEMU Project developersubuntu@ubuntu-kvm:~$ virt-manager --version2.2.1ubuntu@ubuntu-kvm:~$ modinfo kvm-intelfilename: /lib/modules/5.4.0-62-generic/kernel/arch/x86/kvm/kvm-intel.koubuntu@ubuntu-kvm:~$ modinfo i40evffilename: /lib/modules/5.4.0-62-generic/kernel/drivers/net/ethernet/intel/iavf/iavf.koversion: 3.2.3-k (3) NIC SettingIn Ubuntu 20.04, we use NetworkManager to config the NIC, you can use nmtui on the terminal, or nmcli.First, check the netplan. cat /etc/netplan/ 00-installer-config.yaml Edit the yaml file: 1234# Let NetworkManager manage all devices on this systemnetwork: version: 2 renderer: NetworkManager 1sudo netplan apply Then you can set the network config with nmcli or nmtui. 123456789101112131415161718192021222324252627282930313233ubuntu@ubuntu-kvm:~$ sudo nmcli connection modify netplan-eno1 ipv4.method manual ipv4.addresses 10.75.59.50/24 ipv4.gateway 10.75.59.1 ipv4.dns 64.104.123.245ubuntu@ubuntu-kvm:~$ sudo nmcli connection modify netplan-eno1 connection.id eno1ubuntu@ubuntu-kvm:~$ sudo nmcli connection up eno1# Change the connections name to the devices name.sudo nmcli connectionubuntu@ubuntu-kvm:~$ sudo nmcli connectionNAME UUID TYPE DEVICEeno1 10838d80-caeb-349e-ba73-08ed16d4d666 ethernet eno1enp216s0f0 6556c191-c253-3a5e-b440-c5b071ec29a4 ethernet enp216s0f0enp216s0f1 8080672c-5784-375f-8eb9-a6ef57cbd4f7 ethernet enp216s0f1ens1f0 58fb5b1f-c10a-3e7a-9ab9-a8c449840ce6 ethernet ens1f0ens1f1 2a06a9d9-b761-3bdf-aa0b-3d44fff2158f ethernet ens1f1virbr0 ca7d1e11-a82f-429c-9d91-fc985776232c bridge virbr0#Set the MTU and disable ipv4 for the NIC to enable SRIOV. sudo nmcli connection modify ens1f0 ethernet.mtu 9216sudo nmcli connection modify ens1f0 ipv4.method disabledsudo nmcli connection up ens1f0sudo ip link show ens1f02: ens1f0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9216 qdisc mq state UP mode DEFAULT group default qlen 1000link/ether 40:a6:b7:0f:a7:74 brd ff:ff:ff:ff:ff:ff# Note: This value 9216 of MTU is derived from Cisco NFVIS.CSP5228-1# show pnic-detail mtuName MTU=============================eth0-1 9216eth0-2 9216eth1-1 9216eth1-2 9216 SR-IOV Configuration(1) Check the NIC to support SR-IOVCheck the NIC hardware infor. 1234567891011sudo lshw -c network -businfoBus info Device Class Description========================================================pci@0000:3b:00.0 eno1 network Ethernet Controller 10G X550Tpci@0000:3b:00.1 eno2 network Ethernet Controller 10G X550Tpci@0000:5e:00.0 ens1f0 network Ethernet Controller XXV710 for 25GbE SFP28pci@0000:5e:00.1 ens1f1 network Ethernet Controller XXV710 for 25GbE SFP28pci@0000:d8:00.0 enp216s0f0 network Ethernet Controller XXV710 for 25GbE SFP28pci@0000:d8:00.1 enp216s0f1 network Ethernet Controller XXV710 for 25GbE SFP28 Check the capabilities of NIC 1234567sudo lspci -vv -s 5e:00.0 | grep -A 5 -i SR-IOV Capabilities: [160 v1] Single Root I/O Virtualization (SR-IOV) IOVCap: Migration-, Interrupt Message Number: 000 IOVCtl: Enable+ Migration- Interrupt- MSE+ ARIHierarchy+ IOVSta: Migration- Initial VFs: 64, Total VFs: 64, Number of VFs: 2, Function Dependency Link: 00 VF offset: 16, stride: 1, Device ID: 154c (2) Change the GRUB parameters12sudo vi /etc/default/grub GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet hugepagesz=1G hugepages=64 default_hugepagesz=1G intel_iommu=on iommu=pt isolcpus=1-8,45-52&quot; Noteï¼šThe hugepages should be no more than the physical memory, otherwise, it will fail to bootup. default_hugepagesz=1G hugepagesz=1G hugepages=64 will allocate 64 1GB huge pages at boot, which are static huge pages. CSR 1000v will use these static huge pages for best performance. isolcpus=1-8,45-52 will isolate the CPUs cores reserved for CSR 1000v, prevent other processes running on these cores, this can reduce latency for CSR 1000v. You can refer to [Check the capability of the platform][1] to get the CPU information. 1sudo update-grub After reboot, check the /proc/cmdline. 123456789cat /proc/cmdline |grep intel_iommu=ondmesg |grep -e DMAR -e IOMMUdmesg | grep -e DMAR -e IOMMU -e AMD-Viubuntu@ubuntu-kvm:~$ cat /proc/cmdline |grep intel_iommu=onBOOT_IMAGE=/vmlinuz-5.4.0-62-generic root=/dev/mapper/ubuntu--vg-ubuntu--lv ro quiet hugepagesz=1G hugepages=64 default_hugepagesz=1G intel_iommu=on iommu=pt isolcpus=1-8,45-52ubuntu@ubuntu-kvm:~ $ dmesg |grep -e DMAR -e IOMMU[ 0.020313] ACPI: DMAR 0x000000005DA8EB80 000270 (v01 Cisco0 CiscoUCS 00000001 INTL 20091013)[ 1.954441] DMAR: IOMMU enabled Check the CPU info, all the CPU cores and isolated CPU cores. 1234ubuntu@ubuntu-kvm:~$ cat /sys/devices/system/cpu/isolated1-8,45-52ubuntu@ubuntu-kvm:~$ cat /sys/devices/system/cpu/present0-87 (3) VFs PersistenceNetworkManager way: 123456789# nmcli can set the SRIOV, as follow:sudo nmcli connection modify ens1f0 sriov.total-vfs 2sudo nmcli connection modify ens1f1 sriov.total-vfs 2# We can set the MAC address and set the trust on:sudo nmcli connection modify ens1f0 sriov.vfs &#x27;0 mac=b6:4f:02:37:5a:d8 trust=true, 1 mac=26:04:1d:1f:3d:a9 trust=true&#x27;sudo nmcli connection modify ens1f1 sriov.vfs &#x27;0 mac=76:6c:4e:16:7f:e2 trust=true, 1 mac=6a:f2:bd:97:71:65 trust=true&#x27;sudo nmcli connection up ens1f0sudo nmcli connection up ens1f1 After reboot, check the dmesg. 1234567891011121314151617sudo dmesg | grep -i vf[ 6.599304] i40e 0000:5e:00.0: Allocating 2 VFs.[ 6.680111] i40e 0000:5e:00.1: Allocating 2 VFs.[ 6.730167] iavf: Intel(R) Ethernet Adaptive Virtual Function Network Driver - version 3.2.3-k&lt;&lt; snip &gt;&gt;[ 17.931493] i40e 0000:5e:00.0: Setting MAC b6:4f:02:37:5a:d8 on VF 0[ 18.111781] i40e 0000:5e:00.0: VF 0 is now trusted[ 18.112559] i40e 0000:5e:00.0: Setting MAC 26:04:1d:1f:3d:a9 on VF 1[ 18.291464] i40e 0000:5e:00.0: VF 1 is now trusted[ 18.292231] i40e 0000:5e:00.1: Setting MAC 76:6c:4e:16:7f:e2 on VF 0[ 18.475259] i40e 0000:5e:00.1: VF 0 is now trusted[ 18.475929] i40e 0000:5e:00.1: Setting MAC 6a:f2:bd:97:71:65 on VF 1[ 18.659465] i40e 0000:5e:00.1: VF 1 is now trusted[ 18.728124] iavf 0000:5e:02.0 ens1f0v0: NIC Link is Up Speed is 25 Gbps Full Duplex[ 18.752275] iavf 0000:5e:02.1 ens1f0v1: NIC Link is Up Speed is 25 Gbps Full Duplex[ 18.776329] iavf 0000:5e:0a.0 ens1f1v0: NIC Link is Up Speed is 25 Gbps Full Duplex[ 18.800569] iavf 0000:5e:0a.1 ens1f1v1: NIC Link is Up Speed is 25 Gbps Full Duplex (4) Check the VFsYou can check the VFs from lspci or ip link commands. 12ubuntu@ubuntu-kvm:~$ sudo lspci | grep -i Virtualubuntu@ubuntu-kvm:~$ sudo ip link show | grep -B2 vf Good news is that the VFs names are well related to the physical NICs. For example, ens1f0v1 is one of the VFs of the physical NIC ens1f0 . 123456789ubuntu@ubuntu-kvm:~$ ip link show | grep -E ens1f[0,1]v[0,1] -A 19: ens1f0v1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000 link/ether 26:04:1d:1f:3d:a9 brd ff:ff:ff:ff:ff:ff10: ens1f1v1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000 link/ether 6a:f2:bd:97:71:65 brd ff:ff:ff:ff:ff:ff15: ens1f0v0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000 link/ether b6:4f:02:37:5a:d8 brd ff:ff:ff:ff:ff:ff16: ens1f1v0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000link/ether 76:6c:4e:16:7f:e2 brd ff:ff:ff:ff:ff:ff We can change the MTU to 9216 (or you may not need 9216, 1504 is enough). 12345678sudo nmcli connection modify ens1f0v0 ethernet.mtu 9216 ipv4.method disabledsudo nmcli connection modify ens1f0v1 ethernet.mtu 9216 ipv4.method disabledsudo nmcli connection modify ens1f1v0 ethernet.mtu 9216 ipv4.method disabledsudo nmcli connection modify ens1f1v1 ethernet.mtu 9216 ipv4.method disabledsudo nmcli connection up ens1f0v0 sudo nmcli connection up ens1f0v1sudo nmcli connection up ens1f1v0sudo nmcli connection up ens1f1v1 The above configs will survive after reboot. Create SR-IOV Virtual Network Adapter PoolUsing this method, KVM creates a pool of network devices that can be inserted into VMs, and the size of that pool is determined by how many VFs were created on the physical function when they were initialized. (1) Create an xml fileubuntu@ubuntu-kvm:~/kvm$ cat ens1f0_sriov_pool.xml 123456&lt;network&gt; &lt;name&gt;ens1f0_sriov_pool&lt;/name&gt; &lt;!-- This is the name of the file you created --&gt; &lt;forward mode=&#x27;hostdev&#x27; managed=&#x27;yes&#x27;&gt; &lt;pf dev=&#x27;ens1f0&#x27;/&gt; &lt;!-- Use the netdev name of your SR-IOV devices PF here --&gt; &lt;/forward&gt;&lt;/network&gt; (2) Define a network and set to auto start.1234virsh net-define ens1f0_sriov_pool.xmlSleep 1virsh net-start ens1f0_sriov_poolvirsh net-autostart ens1f0_sriov_pool ubuntu@ubuntu-kvm:~/kvm$ virsh net-dumpxml ens1f0_sriov_pool 123456789&lt;network connections=&#x27;1&#x27;&gt; &lt;name&gt;ens1f0_sriov_pool&lt;/name&gt; &lt;uuid&gt;9125a600-6620-4ab6-9a47-8844a61b0918&lt;/uuid&gt; &lt;forward mode=&#x27;hostdev&#x27; managed=&#x27;yes&#x27;&gt; &lt;pf dev=&#x27;ens1f0&#x27;/&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x5e&#x27; slot=&#x27;0x02&#x27; function=&#x27;0x0&#x27;/&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x5e&#x27; slot=&#x27;0x02&#x27; function=&#x27;0x1&#x27;/&gt; &lt;/forward&gt;&lt;/network&gt; (3) Select the virtual adapter from the poolIt is simple to add an SR-IOV NIC, as follow: This is equivalent to the following XML: 123456&lt;interface type=&#x27;network&#x27;&gt; &lt;mac address=&#x27;52:54:00:0b:a5:2e&#x27;/&gt; &lt;source network=&#x27;ens1f0_sriov_pool&#x27;/&gt; &lt;model type=&#x27;virtio&#x27;/&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x02&#x27; slot=&#x27;0x00&#x27; function=&#x27;0x0&#x27;/&gt;&lt;/interface&gt; After the VM powered on, the network info is as follow:virsh dumpxml CSR1KV-1 12345678910&lt;interface type=&#x27;hostdev&#x27; managed=&#x27;yes&#x27;&gt; &lt;mac address=&#x27;52:54:00:0b:a5:2e&#x27;/&gt; &lt;driver name=&#x27;vfio&#x27;/&gt; &lt;source&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x5e&#x27; slot=&#x27;0x02&#x27; function=&#x27;0x0&#x27;/&gt; &lt;/source&gt; &lt;model type=&#x27;virtio&#x27;/&gt; &lt;alias name=&#x27;hostdev0&#x27;/&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x02&#x27; slot=&#x27;0x00&#x27; function=&#x27;0x0&#x27;/&gt;&lt;/interface&gt; Create the CSR1KV VM from virt-managerFrom the virt-manager, create a CSR1KV virtual machine step by step, and choose the virtual network interface from the SR-IOV pool. Note: The first interface of csr1kv-1 is configured to macvtap Bridge mode, so you do not need to create a Linux bridge. However, csr1kv-1 can not communicate to the Linux host through this interface, but it can go out of the Linux host through the eno1. This is a known issue with macvtap. After select the Virtual Network Interface, click the Begin Installation, and you can shut down the virtual machine.The actions above will create the csr1kv-1.xml file under the directory: /etc/libvirtd/qemu/ KVM Performance TunningKVM performance tuning are related to NUMA, Memory Hugepage and vCPU pinning. The main reference is Redhat Linux 7 PERFORMANCE TUNING GUIDE We will use virsh edit csr1kv-1 to do the performance tuning. (1) Check the capability of the platform123456789ubuntu@ubuntu-kvm:~$ virsh nodeinfoCPU model: x86_64CPU(s): 88CPU frequency: 1000 MHzCPU socket(s): 1Core(s) per socket: 22Thread(s) per core: 2NUMA cell(s): 2Memory size: 394929928 KiB [1]:ubuntu@ubuntu-kvm:~$ virsh capabilities 123456789101112&lt;capabilities&gt; &lt;host&gt; &lt;uuid&gt;a24f9760-48f1-f34e-a001-a848f08df7bb&lt;/uuid&gt; &lt;cpu&gt; &lt;arch&gt;x86_64&lt;/arch&gt; &lt;model&gt;Cascadelake-Server-noTSX&lt;/model&gt; &lt;vendor&gt;Intel&lt;/vendor&gt; &lt;microcode version=&#x27;83898371&#x27;/&gt; &lt;counter name=&#x27;tsc&#x27; frequency=&#x27;2095078000&#x27; scaling=&#x27;no&#x27;/&gt; &lt;topology sockets=&#x27;1&#x27; cores=&#x27;22&#x27; threads=&#x27;2&#x27;/&gt;... From the outputs, we can get the cores of CPU, the NUMA info and the hugepages. (2) NUMA Info123456789101112ubuntu@ubuntu-kvm:~$ numactl --hardwareavailable: 2 nodes (0-1)node 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65node 0 size: 192172 MBnode 0 free: 152956 MBnode 1 cpus: 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87node 1 size: 193500 MBnode 1 free: 158037 MBnode distances:node 0 1 0: 10 21 1: 21 10 Two CPUs, each has 192GB memory, the NUMA node are node 0 and node 1. You can also check the NUMA info of the NIC, as follow: 12345678910111213ubuntu@ubuntu-kvm:~$ sudo lspci -vv | grep Ethernet -A 65e:00.0 Ethernet controller: Intel Corporation Ethernet Controller XXV710 for 25GbE SFP28 (rev 02) Subsystem: Cisco Systems Inc Ethernet Network Adapter XXV710 Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr+ Stepping- SERR+ FastB2B- DisINTx+ Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx- Latency: 0, Cache Line Size: 32 bytes Interrupt: pin A routed to IRQ 137 NUMA node: 0#Or you can find the numa infor from udevadm.ubuntu@ubuntu-kvm:~$ sudo udevadm info -ap /sys/class/net/ens1f0 | grep numa ATTRS&#123;numa_node&#125;==&quot;0&quot; ATTRS&#123;numa_node&#125;==&quot;0&quot; If the memory and NICs are all on numa_node 0, that would be more efficient. Please check the serverâ€™s PCI-E slots mapping with the CPU slots. (3) HugePage and Transparent HugepageTo check the memory info 12345678910ubuntu@ubuntu-kvm:~$ cat /proc/meminfo | grep HugeAnonHugePages: 133120 kBShmemHugePages: 0 kBFileHugePages: 0 kBHugePages_Total: 64HugePages_Free: 56HugePages_Rsvd: 0HugePages_Surp: 0Hugepagesize: 1048576 kBHugetlb: 67108864 kB You can change the hugepages on the run timeï¼š 12345ubuntu@ubuntu-kvm:~$ cat /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages32sudo su - // switch to root user.root@ubuntu-kvm:~# echo 64 &gt; /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepagesroot@ubuntu-kvm:~# echo 64 &gt; /sys/devices/system/node/node1/hugepages/hugepages-1048576kB/nr_hugepages Check and configure the transparent_hugepage: 123root@ubuntu-kvm:~# echo always &gt; /sys/kernel/mm/transparent_hugepage/enabledcat /sys/kernel/mm/transparent_hugepage/enabled[always] madvise never (4) vCPU PinningvCPU pinning can improve the cache meet rate and improve the performance.You can check the vcpu pinning.virsh vcpuinfo csr1kv-1 (5) Edit the XML file of the CSR1KVRun virsh edit csr1kv-1 to edit the parameters.Please pay attention to the following texts, other parameters might be different. 123456789101112131415161718192021222324&lt;memoryBacking&gt; &lt;hugepages&gt; &lt;page size=&#x27;1048576&#x27; unit=&#x27;KiB&#x27;/&gt; &lt;/hugepages&gt; &lt;locked/&gt; &lt;nosharepages/&gt;&lt;/memoryBacking&gt;&lt;vcpu placement=&#x27;static&#x27;&gt;8&lt;/vcpu&gt;&lt;cputune&gt; &lt;vcpupin vcpu=&#x27;0&#x27; cpuset=&#x27;1&#x27;/&gt; &lt;vcpupin vcpu=&#x27;1&#x27; cpuset=&#x27;2&#x27;/&gt; &lt;vcpupin vcpu=&#x27;2&#x27; cpuset=&#x27;3&#x27;/&gt; &lt;vcpupin vcpu=&#x27;3&#x27; cpuset=&#x27;4&#x27;/&gt; &lt;vcpupin vcpu=&#x27;4&#x27; cpuset=&#x27;5&#x27;/&gt; &lt;vcpupin vcpu=&#x27;5&#x27; cpuset=&#x27;6&#x27;/&gt; &lt;vcpupin vcpu=&#x27;6&#x27; cpuset=&#x27;7&#x27;/&gt; &lt;vcpupin vcpu=&#x27;7&#x27; cpuset=&#x27;8&#x27;/&gt; &lt;emulatorpin cpuset=&#x27;45-52&#x27;/&gt; &lt;!-- If Hyper-threading were enabled --&gt;&lt;/cputune&gt;&lt;numatune&gt; &lt;memory mode=&#x27;strict&#x27; nodeset=&#x27;0&#x27;/&gt;&lt;/numatune&gt;&lt;cpu mode=&#x27;host-passthrough&#x27; check=&#x27;none&#x27;/&gt; &lt;memballoon model=&#x27;none&#x27;/&gt; Please note that, if hyper-threading is enabled in BIOS setting, the parameter â€œemulatorpinâ€ should be set, the cpuset are from the â€œvirsh capabilitiesâ€, for example, siblings=â€™1,45â€™. When the core 1 is pinned, core 45 should be set in emulatorpin. From the guide https://libvirt.org/formatdomain.html and https://libvirt.org/kbase/kvm-realtime.html we set the CPU and memory tuning parameters as the highlighted text. 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165&lt;domain type=&#x27;kvm&#x27;&gt; &lt;name&gt;csr1kv-1&lt;/name&gt; &lt;uuid&gt;83f90c1c-f0ea-4298-bcdf-3d676de2aeb4&lt;/uuid&gt; &lt;metadata&gt; &lt;libosinfo:libosinfo xmlns:libosinfo=&quot;http://libosinfo.org/xmlns/libvirt/domain/1.0&quot;&gt; &lt;libosinfo:os id=&quot;http://centos.org/centos/7.0&quot;/&gt; &lt;/libosinfo:libosinfo&gt; &lt;/metadata&gt; &lt;memory unit=&#x27;KiB&#x27;&gt;8388608&lt;/memory&gt; &lt;currentMemory unit=&#x27;KiB&#x27;&gt;8388608&lt;/currentMemory&gt; &lt;memoryBacking&gt; &lt;hugepages&gt; &lt;page size=&#x27;1048576&#x27; unit=&#x27;KiB&#x27;/&gt; &lt;/hugepages&gt; &lt;locked/&gt; &lt;nosharepages/&gt; &lt;/memoryBacking&gt; &lt;vcpu placement=&#x27;static&#x27;&gt;8&lt;/vcpu&gt; &lt;cputune&gt; &lt;vcpupin vcpu=&#x27;0&#x27; cpuset=&#x27;1&#x27;/&gt; &lt;vcpupin vcpu=&#x27;1&#x27; cpuset=&#x27;2&#x27;/&gt; &lt;vcpupin vcpu=&#x27;2&#x27; cpuset=&#x27;3&#x27;/&gt; &lt;vcpupin vcpu=&#x27;3&#x27; cpuset=&#x27;4&#x27;/&gt; &lt;vcpupin vcpu=&#x27;4&#x27; cpuset=&#x27;5&#x27;/&gt; &lt;vcpupin vcpu=&#x27;5&#x27; cpuset=&#x27;6&#x27;/&gt; &lt;vcpupin vcpu=&#x27;6&#x27; cpuset=&#x27;7&#x27;/&gt; &lt;vcpupin vcpu=&#x27;7&#x27; cpuset=&#x27;8&#x27;/&gt; &lt;emulatorpin cpuset=&#x27;45-52&#x27;/&gt; &lt;!-- If Hyper-threading were enabled --&gt; &lt;/cputune&gt; &lt;numatune&gt; &lt;memory mode=&#x27;strict&#x27; nodeset=&#x27;0&#x27;/&gt; &lt;/numatune&gt; &lt;os&gt; &lt;type arch=&#x27;x86_64&#x27; machine=&#x27;pc-q35-4.2&#x27;&gt;hvm&lt;/type&gt; &lt;boot dev=&#x27;hd&#x27;/&gt; &lt;/os&gt; &lt;features&gt; &lt;acpi/&gt; &lt;apic/&gt; &lt;vmport state=&#x27;off&#x27;/&gt; &lt;/features&gt; &lt;cpu mode=&#x27;host-passthrough&#x27; check=&#x27;none&#x27;/&gt; &lt;clock offset=&#x27;utc&#x27;&gt; &lt;timer name=&#x27;rtc&#x27; tickpolicy=&#x27;catchup&#x27;/&gt; &lt;timer name=&#x27;pit&#x27; tickpolicy=&#x27;delay&#x27;/&gt; &lt;timer name=&#x27;hpet&#x27; present=&#x27;no&#x27;/&gt; &lt;/clock&gt; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt; &lt;on_reboot&gt;restart&lt;/on_reboot&gt; &lt;on_crash&gt;destroy&lt;/on_crash&gt; &lt;pm&gt; &lt;suspend-to-mem enabled=&#x27;no&#x27;/&gt; &lt;suspend-to-disk enabled=&#x27;no&#x27;/&gt; &lt;/pm&gt; &lt;devices&gt; &lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt; &lt;disk type=&#x27;file&#x27; device=&#x27;disk&#x27;&gt; &lt;driver name=&#x27;qemu&#x27; type=&#x27;qcow2&#x27;/&gt; &lt;source file=&#x27;/var/lib/libvirt/images/csr1000v-universalk9.17.02.01v.qcow2&#x27;/&gt; &lt;target dev=&#x27;vda&#x27; bus=&#x27;virtio&#x27;/&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x05&#x27; slot=&#x27;0x00&#x27; function=&#x27;0x0&#x27;/&gt; &lt;/disk&gt; &lt;controller type=&#x27;usb&#x27; index=&#x27;0&#x27; model=&#x27;qemu-xhci&#x27; ports=&#x27;15&#x27;&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x03&#x27; slot=&#x27;0x00&#x27; function=&#x27;0x0&#x27;/&gt; &lt;/controller&gt; &lt;controller type=&#x27;sata&#x27; index=&#x27;0&#x27;&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x1f&#x27; function=&#x27;0x2&#x27;/&gt; &lt;/controller&gt; &lt;controller type=&#x27;pci&#x27; index=&#x27;0&#x27; model=&#x27;pcie-root&#x27;/&gt; &lt;controller type=&#x27;pci&#x27; index=&#x27;1&#x27; model=&#x27;pcie-root-port&#x27;&gt; &lt;model name=&#x27;pcie-root-port&#x27;/&gt; &lt;target chassis=&#x27;1&#x27; port=&#x27;0x10&#x27;/&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x02&#x27; function=&#x27;0x0&#x27; multifunction=&#x27;on&#x27;/&gt; &lt;/controller&gt; &lt;controller type=&#x27;pci&#x27; index=&#x27;2&#x27; model=&#x27;pcie-root-port&#x27;&gt; &lt;model name=&#x27;pcie-root-port&#x27;/&gt; &lt;target chassis=&#x27;2&#x27; port=&#x27;0x11&#x27;/&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x02&#x27; function=&#x27;0x1&#x27;/&gt; &lt;/controller&gt; &lt;controller type=&#x27;pci&#x27; index=&#x27;3&#x27; model=&#x27;pcie-root-port&#x27;&gt; &lt;model name=&#x27;pcie-root-port&#x27;/&gt; &lt;target chassis=&#x27;3&#x27; port=&#x27;0x12&#x27;/&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x02&#x27; function=&#x27;0x2&#x27;/&gt; &lt;/controller&gt; &lt;controller type=&#x27;pci&#x27; index=&#x27;4&#x27; model=&#x27;pcie-root-port&#x27;&gt; &lt;model name=&#x27;pcie-root-port&#x27;/&gt; &lt;target chassis=&#x27;4&#x27; port=&#x27;0x13&#x27;/&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x02&#x27; function=&#x27;0x3&#x27;/&gt; &lt;/controller&gt; &lt;controller type=&#x27;pci&#x27; index=&#x27;5&#x27; model=&#x27;pcie-root-port&#x27;&gt; &lt;model name=&#x27;pcie-root-port&#x27;/&gt; &lt;target chassis=&#x27;5&#x27; port=&#x27;0x14&#x27;/&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x02&#x27; function=&#x27;0x4&#x27;/&gt; &lt;/controller&gt; &lt;controller type=&#x27;pci&#x27; index=&#x27;6&#x27; model=&#x27;pcie-root-port&#x27;&gt; &lt;model name=&#x27;pcie-root-port&#x27;/&gt; &lt;target chassis=&#x27;6&#x27; port=&#x27;0x15&#x27;/&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x02&#x27; function=&#x27;0x5&#x27;/&gt; &lt;/controller&gt; &lt;controller type=&#x27;pci&#x27; index=&#x27;7&#x27; model=&#x27;pcie-root-port&#x27;&gt; &lt;model name=&#x27;pcie-root-port&#x27;/&gt; &lt;target chassis=&#x27;7&#x27; port=&#x27;0x16&#x27;/&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x02&#x27; function=&#x27;0x6&#x27;/&gt; &lt;/controller&gt; &lt;controller type=&#x27;pci&#x27; index=&#x27;8&#x27; model=&#x27;pcie-root-port&#x27;&gt; &lt;model name=&#x27;pcie-root-port&#x27;/&gt; &lt;target chassis=&#x27;8&#x27; port=&#x27;0x17&#x27;/&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x02&#x27; function=&#x27;0x7&#x27;/&gt; &lt;/controller&gt; &lt;controller type=&#x27;virtio-serial&#x27; index=&#x27;0&#x27;&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x04&#x27; slot=&#x27;0x00&#x27; function=&#x27;0x0&#x27;/&gt; &lt;/controller&gt; &lt;interface type=&#x27;direct&#x27;&gt; &lt;mac address=&#x27;52:54:00:69:ec:73&#x27;/&gt; &lt;source dev=&#x27;eno1&#x27; mode=&#x27;bridge&#x27;/&gt; &lt;model type=&#x27;virtio&#x27;/&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x01&#x27; slot=&#x27;0x00&#x27; function=&#x27;0x0&#x27;/&gt; &lt;/interface&gt; &lt;interface type=&#x27;network&#x27;&gt; &lt;mac address=&#x27;52:54:00:0b:a5:2e&#x27;/&gt; &lt;source network=&#x27;ens1f0_sriov_pool&#x27;/&gt; &lt;model type=&#x27;virtio&#x27;/&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x02&#x27; slot=&#x27;0x00&#x27; function=&#x27;0x0&#x27;/&gt; &lt;/interface&gt; &lt;interface type=&#x27;network&#x27;&gt; &lt;mac address=&#x27;52:54:00:bd:9f:54&#x27;/&gt; &lt;source network=&#x27;ens1f1_sriov_pool&#x27;/&gt; &lt;model type=&#x27;virtio&#x27;/&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x08&#x27; slot=&#x27;0x00&#x27; function=&#x27;0x0&#x27;/&gt; &lt;/interface&gt; &lt;serial type=&#x27;pty&#x27;&gt; &lt;target type=&#x27;isa-serial&#x27; port=&#x27;0&#x27;&gt; &lt;model name=&#x27;isa-serial&#x27;/&gt; &lt;/target&gt; &lt;/serial&gt; &lt;console type=&#x27;pty&#x27;&gt; &lt;target type=&#x27;serial&#x27; port=&#x27;0&#x27;/&gt; &lt;/console&gt; &lt;channel type=&#x27;unix&#x27;&gt; &lt;target type=&#x27;virtio&#x27; name=&#x27;org.qemu.guest_agent.0&#x27;/&gt; &lt;address type=&#x27;virtio-serial&#x27; controller=&#x27;0&#x27; bus=&#x27;0&#x27; port=&#x27;1&#x27;/&gt; &lt;/channel&gt; &lt;channel type=&#x27;spicevmc&#x27;&gt; &lt;target type=&#x27;virtio&#x27; name=&#x27;com.redhat.spice.0&#x27;/&gt; &lt;address type=&#x27;virtio-serial&#x27; controller=&#x27;0&#x27; bus=&#x27;0&#x27; port=&#x27;2&#x27;/&gt; &lt;/channel&gt; &lt;input type=&#x27;mouse&#x27; bus=&#x27;ps2&#x27;/&gt; &lt;input type=&#x27;keyboard&#x27; bus=&#x27;ps2&#x27;/&gt; &lt;graphics type=&#x27;spice&#x27; autoport=&#x27;yes&#x27;&gt; &lt;listen type=&#x27;address&#x27;/&gt; &lt;image compression=&#x27;off&#x27;/&gt; &lt;/graphics&gt; &lt;video&gt; &lt;model type=&#x27;qxl&#x27; ram=&#x27;65536&#x27; vram=&#x27;65536&#x27; vgamem=&#x27;16384&#x27; heads=&#x27;1&#x27; primary=&#x27;yes&#x27;/&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x01&#x27; function=&#x27;0x0&#x27;/&gt; &lt;/video&gt; &lt;redirdev bus=&#x27;usb&#x27; type=&#x27;spicevmc&#x27;&gt; &lt;address type=&#x27;usb&#x27; bus=&#x27;0&#x27; port=&#x27;2&#x27;/&gt; &lt;/redirdev&gt; &lt;redirdev bus=&#x27;usb&#x27; type=&#x27;spicevmc&#x27;&gt; &lt;address type=&#x27;usb&#x27; bus=&#x27;0&#x27; port=&#x27;3&#x27;/&gt; &lt;/redirdev&gt; &lt;memballoon model=&#x27;none&#x27;/&gt; &lt;/devices&gt;&lt;/domain&gt; The parameters are from Cisco CSR 1000v and Cisco ISRv Software Configuration GuideAfter you install the CSR1000v, and edit the XML file, you can run virsh to create the csr1kv. 123cd /etc/libvirtd/qemuvirsh define csr1kv-1.xmlvirsh start csr1kv-1 (6) Check CSR1000vâ€™s tunningubuntu@ubuntu-kvm:/etc/libvirt/qemu$ virsh list 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253 Id Name State-------------------------- 1 csr1kv-1 runningubuntu@ubuntu-kvm:/etc/libvirt/qemu$ virsh vcpuinfo 1VCPU: 0CPU: 1State: runningCPU time: 167.0sCPU Affinity: -y--------------------------------------------------------------------------------------VCPU: 1CPU: 2State: runningCPU time: 193.3sCPU Affinity: --y-------------------------------------------------------------------------------------VCPU: 2CPU: 3State: runningCPU time: 152.5sCPU Affinity: ---y------------------------------------------------------------------------------------VCPU: 3CPU: 4State: runningCPU time: 174.3sCPU Affinity: ----y-----------------------------------------------------------------------------------VCPU: 4CPU: 5State: runningCPU time: 260.6sCPU Affinity: -----y----------------------------------------------------------------------------------VCPU: 5CPU: 6State: runningCPU time: 386.0sCPU Affinity: ------y---------------------------------------------------------------------------------VCPU: 6CPU: 7State: runningCPU time: 2189.9sCPU Affinity: -------y--------------------------------------------------------------------------------VCPU: 7CPU: 8State: runningCPU time: 2192.2sCPU Affinity: --------y------------------------------------------------------------------------------- From the above outputs, we can find that the vCPUa are pinned to NO. 1 to 8 CPU cores. 12345678910111213141516171819202122232425ubuntu@ubuntu-kvm:~$ sudo numastat -c qemuPer-node process memory usage (in MBs)PID Node 0 Node 1 Total--------------- ------ ------ -----4391 (qemu-syste 8373 0 83735891 (sudo) 4 1 5--------------- ------ ------ -----Total 8377 1 8377ubuntu@ubuntu-kvm:~$ sudo numastat -p 4391Per-node process memory usage (in MBs) for PID 4391 (qemu-system-x86) Node 0 Node 1 Total --------------- --------------- ---------------Huge 8192.00 0.00 8192.00Heap 10.00 0.00 10.00Stack 0.03 0.00 0.03Private 170.70 0.15 170.85---------------- --------------- --------------- ---------------Total 8372.73 0.16 8372.88 From the above outputs, the csr1kv-1 are using the memories from node 0. (7) Check the vNIC in CSR1KV123456789csr1kv-1#show platform software vnic-if interface-mapping------------------------------------------------------------- Interface Name Driver Name Mac Addr------------------------------------------------------------- GigabitEthernet3 net_i40e_vf 5254.00bd.9f54 GigabitEthernet2 net_i40e_vf 5254.000b.a52e GigabitEthernet1 net_virtio 5254.0069.ec73 The Driver Name net_i40e_vf indicates that the vNIC is a VF from the SR-IOV pool. CSR 1000v initial configuration and Smart License registration(1) CSR 1000v initial config examplePart of the configuration: 123456789101112131415161718192021222324252627282930313233343536373839404142CSR1000v-1#show sdwan running-configsystem system-ip 1.1.10.1 site-id 101 sp-organization-name CiscoBJ organization-name CiscoBJ vbond 10.75.58.51 port 12346!hostname CSR1000v-1username admin privilege 15 secret 9 $9$4&#x2F;QL2V2K4&#x2F;6H1k$XUmRNf.T7t3KDOj&#x2F;FmoNexpEypCxr482dExXHDnohSIip name-server 64.104.123.245ip route 0.0.0.0 0.0.0.0 10.75.59.1interface GigabitEthernet1 no shutdown arp timeout 1200 ip address 10.75.59.35 255.255.255.0 no ip redirects ip mtu 1500 mtu 1500 negotiation autoexitinterface Tunnel1 no shutdown ip unnumbered GigabitEthernet1 no ip redirects ipv6 unnumbered GigabitEthernet1 no ipv6 redirects tunnel source GigabitEthernet1 tunnel mode sdwanexitclock timezone CST 8 0ntp server x.x.x.x version 4sdwan interface GigabitEthernet1 tunnel-interface encapsulation ipsec allow-service sshd exit (2) Commands to check the status1234567show sdwan control local-propertiesshow sdwan control connectionsshow sdwan control connection-historyshow sdwan running-configshow sdwan bfd sessionsshow sdwan omp peersshow sdwan omp routes (3) CSR 1000v Smart License RegistrationBefore Smart License registration, you need ï¼š CSR 1000vâ€™s control connections are upï¼› Configure ip http client source-interface GigabitEthernet2 If the version is 16.12.x and bellow, you need to allow service allsdwan interface GigabitEthernet2 tunnel-interface allow-service all In the 17.2.x and above versions, there is an allow-service https CSR 1000v can access URLï¼šhttps://tools.cisco.com/its/service/oddce/services/DDCEServiceThe command license smart register idtoken xxxxxx will do the registration.You can find the idtoken from your Smart Account smart license inventory.show license status to check the status. 12CSR1000v-1#show platform hardware throughput levelThe current throughput level is 200000000 kb&#x2F;s Performances and limitations(1) The performance of the SR-IOVA performance test was done after the SR-IOV setup, the CSR1KV was configured as 8vCPU and 8G Memory, the packet drop rate was 0%. Packet Site SDWAN Performance (Mbps) CEF Performance (Mbps) 128Bytes 800 2843.75 256Bytes 1431.26 6500.00 512Bytes 2581.26 10578.13 1024Bytes 3731.26 15500.00 1400Bytes 4306.26 18171.88 Note: These test results are not to represent the official performance data. Different servers and network cards may have different test results. The above data is for demo only. (2) The limitation of the SR-IOVThe main limitation of the SR-IOV is the number of VLANs on each VF, the maximum VLAN of an VF is limited to 63 in ixgbevf.So, the active number of sub-interfaces on an interface of the CSR1KV that uses the SRIOV VFs is limited to 63.There is some notes in the Cisco CSR 1000v and Cisco ISRv Software Configuration Guide: SR-IOV (ixgbevf)Maximum VLANs: The maximum number of VLANs supported on PF is 64. Together, all VFs can have a total of 64 VLANs. (Intel limitation.) SR-IOV (i40evf)Maximum VLANs: The maximum number of VLANs supported on PF is 512. Together, all VFs can have a total of 512 VLANs. (Intel limitation.) Per-VF resources are managed by the PF (host) device driver. Referenceshttps://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/performance_tuning_guide/index https://computingforgeeks.com/how-to-create-and-configure-bridge-networking-for-kvm-in-linux/ https://software.intel.com/content/www/us/en/develop/articles/configure-sr-iov-network-virtual-functions-in-linux-kvm.html https://linuxconfig.org/install-and-set-up-kvm-on-ubuntu-20-04-focal-fossa-linux https://kifarunix.com/how-to-fix-qemu-kvm-not-connected-error-on-ubuntu-20-04/ https://linuxconfig.org/how-to-disable-apparmor-on-ubuntu-20-04-focal-fossa-linux CSR1000v SD-WAN Installation on KVM by Jean-Marc Barozet Scripts and XML Example Files Ubuntu and KVM installation and setting NIC Settings with nmcli Check NIC SRIOV Capabilities GRUB Settings SRIOV Settings Check VFs Create SRIOV Adapter Pool KVM Tuning Check CSR1000v Tuning ens1f0_sriov_pool.xml csr1kv-1.xml","categories":[],"tags":[{"name":"CSR1000v","slug":"CSR1000v","permalink":"https://weiborao.link/tags/CSR1000v/"},{"name":"KVM","slug":"KVM","permalink":"https://weiborao.link/tags/KVM/"},{"name":"SRIOV","slug":"SRIOV","permalink":"https://weiborao.link/tags/SRIOV/"},{"name":"NetworkManager","slug":"NetworkManager","permalink":"https://weiborao.link/tags/NetworkManager/"}]},{"title":"CSR 1000v KVM SRIOV CentOS 7å®‰è£…è®¾ç½®æŒ‡å—","slug":"csr1kv-kvm-CentOS7","date":"2021-02-03T05:58:32.000Z","updated":"2021-02-05T05:57:29.431Z","comments":true,"path":"csr1kv-kvm-CentOS7.html","link":"","permalink":"https://weiborao.link/csr1kv-kvm-CentOS7.html","excerpt":"","text":"ä½œè€…ï¼šRao Weibo ç‰ˆæœ¬ï¼š1.0 æ›´æ–°æ—¥æœŸï¼š20210203 æœ¬æ–‡æä¾›åœ¨ CentOS 7 ç‰ˆæœ¬ä¸Šå®‰è£… KVMï¼Œå¹¶å®‰è£…å’Œè®¾ç½® CSR 1000v/Catalyst 8000v çš„æŒ‡å—ï¼Œå†…å®¹åŒ…æ‹¬ SRIOVï¼ŒKVM è°ƒä¼˜ä»¥åŠ CSR1KV åˆå§‹åŒ–é…ç½®ç­‰å†…å®¹ã€‚ CentOS7 å®‰è£…åŠè®¾ç½®ï¼ˆ1ï¼‰BIOS è®¾ç½®å»ºè®® Configuration Recommended Setting Intel Hyper-Threading Technology Disabled Number of Enable Cores ALL Execute Disable Enabled Intel VT Enabled Intel VT-D Enabled Intel VT-D coherency support Enabled Intel VT-D ATS support Enabled CPU Performance High throughput Hardware Perfetcher Disabled Adjacent Cache Line Prefetcher Disabled DCU Streamer Prefetch Disable Power Technology Custom Enhanced Intel Speedstep Technology Disabled Intel Turbo Boost Technology Enabled Processor Power State C6 Disabled Processor Power State C1 Enhanced Disabled Frequency Poor Override Enabled P-State Coordination HW_ALL Energy Performance Performance ä»¥ä¸Šå»ºè®®æ¥è‡ª CSR 1000v çš„å®‰è£…æŒ‡å—ã€‚ ï¼ˆ2ï¼‰CentOS 7 çš„å®‰è£…åœ¨å®‰è£…çš„æ—¶å€™é€‰æ‹© Server with GUI Virtualization Client Virtualization Hypervisor Virtualization Tools å¯åŠ¨å®Œæ¯•ä»¥åå…³é—­ selinuxï¼Œé‡å¯ç”Ÿæ•ˆã€‚ 123sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/configgetenforce //ç»“æœä¸ºï¼šEnforcingï¼ˆå¼€å¯çŠ¶æ€ï¼‰disabled(å…³é—­çŠ¶æ€) 123456789101112131415# å®‰è£…å®Œåï¼ŒSSHç™»å½•å¯èƒ½æ˜¾ç¤ºä¸­æ–‡ï¼Œå¯ä¿®æ”¹ .bash_profileLANG=&quot;en_US.UTF-8&quot;export LANGsource .bash_profileegrep -o &#x27;(vmx|svm)&#x27; /proc/cpuinfo | sort | uniq# æ³¨ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œéœ€è¦åœ¨æœåŠ¡å™¨è¿æ¥çš„äº¤æ¢æœºä»¥åŠå‡ºå£é˜²ç«å¢™ä¸Šåšå¥½å®‰å…¨ç­–ç•¥ã€‚systemctl stop firewalldsystemctl disable firewalld æœ¬æ–‡æ¡£é‡‡ç”¨ NetworkManager é…ç½®ï¼Œæ•…åœ¨æ­¤å¹¶ä¸åœç”¨ NetworkManagerã€‚ 123456789cat /etc/sysctl.confnet.ipv4.ip_forward = 1net.bridge.bridge-nf-call-ip6tables = 0net.bridge.bridge-nf-call-iptables = 0net.bridge.bridge-nf-call-arptables = 0 æ£€æŸ¥ KVM ç»„ä»¶ç‰ˆæœ¬ï¼š 123456789101112131415161718192021[root@centos7 ~]# libvirtd -Vlibvirtd (libvirt) 4.5.0[root@centos7 ~]# /usr/libexec/qemu-kvm --versionQEMU emulator version 1.5.3 (qemu-kvm-1.5.3-173.el7_8.3), Copyright (c) 2003-2008 Fabrice Bellard[root@centos7 ~]# virt-manager --version1.5.0[root@centos7 ~]# modinfo kvm-intelfilename: /lib/modules/3.10.0-1127.18.2.el7.x86_64/kernel/arch/x86/kvm/kvm-intel.ko.xz[root@centos7 ~]# modinfo ixgbevffilename: /lib/modules/3.10.0-1127.18.2.el7.x86_64/kernel/drivers/net/ethernet/intel/ixgbevf/ixgbevf.ko.xzversion: 4.1.0-k-rh7.7 ï¼ˆ3ï¼‰åˆ›å»ºæœ¬åœ° Yum æºï¼ˆå¯é€‰ï¼‰12345678910111213141516171819202122232425262728293031323334353637383940414243# 1ã€å¤‡ä»½æœ¬åœ°/etc/yum.repos.d ç›®å½•ä¸‹çš„yumæºcd /etc/yum.repos.d/mkdir bakmv C* bak/# 2ã€ä¸Šä¼ CentOS-7-x86_64-Everything-2009.isoé•œåƒåˆ°/opt# 3ã€æŒ‚è½½é•œåƒmkdir -p /media/cdrommount -t iso9660 -o loop /opt/CentOS-7-x86_64-Everything-2009.iso /media/cdrom/mount //æŸ¥çœ‹æŒ‚è½½ä¿¡æ¯df -hvi /etc/fstab/opt/CentOS-7-x86_64-Everything-2009.iso /media/cdrom iso9660 loop 0 0tail -1 /etc/fstab //æŸ¥çœ‹æ˜¯å¦å†™å…¥/etc/fstab# 4ã€é…ç½®æœ¬åœ°yumæºcd /etc/yum.repos.d/vi local.repo[local]name=localbaseurl=file:///media/cdrom //å‰é¢çš„file://æ˜¯åè®®,åé¢çš„/media/cdromæ˜¯å…‰ç›˜æŒ‚è½½ç‚¹gpgcheck=0 //1ä½¿ç”¨å…¬é’¥éªŒè¯rpmåŒ…çš„æ­£ç¡®æ€§,0ä¸éªŒè¯enabled=1 //1å¯ç”¨yumæº,0ç¦ç”¨yumæºyum install -y numactl telnet è¿è¡Œ virt-manager å¯åŠ¨å›¾å½¢åŒ–ç•Œé¢ã€‚ å¦‚æœå¯¹ virsh CLI å‘½ä»¤ç†Ÿæ‚‰ï¼Œå¯ä»¥ä½¿ç”¨ virsh å‘½ä»¤åˆ›å»ºè™šæ‹Ÿæœºã€‚ ï¼ˆ4ï¼‰æœåŠ¡å™¨ç½‘å¡é…ç½®â€”NetworkManager é…ç½®åœ¨ç»ˆç«¯ç•Œé¢ï¼Œå¯ä»¥é€šè¿‡ nmtui æ‰“å¼€å›¾å½¢åŒ–ç•Œé¢è¿›è¡Œè®¾ç½®ï¼›ä»¥ä¸‹ä½¿ç”¨ nmcli è¿›è¡Œè®¾ç½®ã€‚ 123456789nmcli connection add con-name eno1 type ethernet autoconnect yes ifname eno1nmcli connection modify eno1 ipv4.method manual ipv4.addresses 10.75.58.43/24 ipv4.gateway 10.75.58.1 ipv4.dns 64.104.123.245nmcli connection up eno1nmcli connection show eno1ping 10.75.58.1 ä¸Šè¿°å‘½ä»¤å®Œæˆåï¼Œåœ¨/etc/sysconfig/network-scripts ä¸­ä¼šç”Ÿæˆç½‘å¡çš„ ifcfg é…ç½®æ–‡ä»¶ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243cat /etc/sysconfig/network-scripts/ifcfg-eno1HWADDR=70:7D:B9:59:5B:AETYPE=EthernetPROXY_METHOD=noneBROWSER_ONLY=noBOOTPROTO=noneIPADDR=10.75.58.43PREFIX=24GATEWAY=10.75.58.1DNS1=64.104.123.245DEFROUTE=yesIPV4_FAILURE_FATAL=noIPV6INIT=yesIPV6_AUTOCONF=yesIPV6_DEFROUTE=yesIPV6_FAILURE_FATAL=noIPV6_ADDR_GEN_MODE=stable-privacyNAME=eno1UUID=2a1c8b39-7f44-321b-a65f-a93e70ab0616ONBOOT=yesAUTOCONNECT_PRIORITY=-999DEVICE=eno1 æ­¤æ—¶ï¼Œå¯ä»¥å°† network.service åœæ­¢å’Œå…³é—­ã€‚ 123systemctl stop networksystemctl disable network æ³¨æ„ï¼Œå¦‚æœ NetworkManager æœªè®¾ç½®å¦¥å½“ï¼Œæ‰§è¡Œ systemctl stop network åï¼Œä¼šå¯¼è‡´æœåŠ¡å™¨æ— æ³•ç®¡ç†ã€‚ å‡†å¤‡å¼€å¯ SRIOV çš„ç½‘å¡è®¾ç½®ï¼Œä»¥ eno2 ä¸ºä¾‹ï¼š 123456789nmcli connection add con-name eno2 type ethernet autoconnect yes ifname eno2nmcli connection modify eno2 ethernet.mtu 9216 ipv4.method disablednmcli connection up eno2nmcli connection show eno2ip link show dev eno2 æ³¨ï¼šä¸Šè¿° MTU å€¼è®¾ç½®ä¸º 9216 æ˜¯å€Ÿé‰´è‡ª Cisco NFVIS å¹³å°ï¼Œå¦‚ä¸‹ï¼š 12345678910111213CSP5228-1# show pnic-detail mtuName MTU&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;eth0-1 9216eth0-2 9216eth1-1 9216eth1-2 9216 ï¼ˆ5ï¼‰é…ç½® Linux ç½‘æ¡¥ ï¼ˆå¯é€‰ï¼‰ç½‘æ¡¥ br1 é…ç½®ç¤ºä¾‹ï¼š 12345nmcli connection add con-name br1 type bridge autoconnect yes ipv4.method disabled ethernet.mtu 9216 ifname br1nmcli connection up br1ip link show dev br1 ç½‘æ¡¥ br1 çš„ç‰©ç†ç½‘å¡é…ç½® 1234567nmcli connection add con-name eno5 type ethernet autoconnect yes ifname eno5nmcli connection modify eno5 ethernet.mtu 9216 ipv4.method disabled master br1nmcli connection up eno5ip link show dev eno5 åˆ›å»º net-br1 ç½‘ç»œ [root@centos7 ~]# cat net-br1.xml 123456789&lt;network&gt; &lt;name&gt;net-br1&lt;/name&gt; &lt;forward mode=&quot;bridge&quot;/&gt; &lt;bridge name=&quot;br1&quot;/&gt;&lt;/network&gt; 1234567891011[root@centos7 ~]# virsh net-define net-br1.xmlNetwork net-br1 defined from net-br1.xml[root@centos7 ~]# virsh net-start net-br1Network net-br1 started[root@centos7 ~]# virsh net-autostart net-br1Network net-br1 marked as autostarted é…ç½® SR-IOVï¼ˆ1ï¼‰æ£€æŸ¥ç½‘å¡å¯¹ SR-IOV çš„æ”¯æŒï¼Œå¹¶é…ç½®ç½‘å¡å¯ä½¿ç”¨ lshw å’Œ lspci æ£€æŸ¥ç½‘å¡å¯¹ SR-IOV çš„æ”¯æŒ lshw -c network -businfo 123456789101112131415Bus info Device Class Description========================================================pci@0000:1d:00.0 eno5 network VIC Ethernet NICpci@0000:1d:00.1 eno6 network VIC Ethernet NICpci@0000:1d:00.2 eno7 network VIC Ethernet NICpci@0000:1d:00.3 eno8 network VIC Ethernet NICpci@0000:3b:00.0 eno1 network Ethernet Controller 10G X550Tpci@0000:3b:00.1 eno2 network Ethernet Controller 10G X550T lspci -vv -s 3b:00.1 | grep -A 5 -i SR-IOV 1234567891011Capabilities: [160 v1] Single Root I/O Virtualization (SR-IOV) IOVCap: Migration-, Interrupt Message Number: 000 IOVCtl: Enable+ Migration- Interrupt- MSE+ ARIHierarchy- IOVSta: Migration- Initial VFs: 64, Total VFs: 64, Number of VFs: 8, Function Dependency Link: 01 VF offset: 128, stride: 2, Device ID: 1565 ï¼ˆ2ï¼‰è®¾ç½®å¯åŠ¨å‚æ•°1234567891011vi /etc/default/grubGRUB_CMDLINE_LINUX=&quot;crashkernel=auto spectre_v2=retpoline rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet hugepagesz=1G hugepages=32 default_hugepagesz=1G intel_iommu=on iommu=pt isolcpus=1-8,37-44&quot;æ³¨ï¼šé¡µé¢æ•°å­—ä¸è¦è¿‡å¤§ï¼Œä¸ç„¶å¯åŠ¨å¤±è´¥ï¼Œå¦‚æœåç»­ä¸å¤Ÿï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶æ·»åŠ ã€‚grub2-mkconfig -o /boot/grub2/grub.cfggrub2-mkconfig -o /boot/efi/EFI/centos/grub.cfgiommu=pt å‚æ•°æ˜¯å°†SRIOVè®¾å¤‡æ”¯æŒPCI Passthrough é‡å¯åéªŒè¯ 12345cat /proc/cmdline |grep intel_iommu=ondmesg |grep -e DMAR -e IOMMUdmesg | grep -e DMAR -e IOMMU -e AMD-Vi default_hugepagesz=1G hugepagesz=1G hugepages=32 å‚æ•°è®¾ç½®ä¸»æœºåœ¨å¯åŠ¨æ—¶åˆ†é… 32 ä¸ª 1GB çš„å†…å­˜å¤§é¡µï¼Œè¿™äº›æ˜¯é™æ€å†…å­˜å¤§é¡µã€‚ CSR 1000v è™šæ‹Ÿæœºå°†è¯•ç”¨è¿™äº›é™æ€å¤§é¡µä»¥è·å¾—æœ€ä¼˜æ€§èƒ½ã€‚ isolcpus=1-8,37-44 å‚æ•°è®¾ç½®çš„ä½œç”¨æ˜¯éš”ç¦» 1-8ï¼Œ37-44 çš„ CPU æ ¸ï¼Œä½¿å…¶ç‹¬ç«‹äºå†…æ ¸çš„å¹³è¡¡è°ƒåº¦ç®—æ³•ï¼Œä¹Ÿå°±æ˜¯å†…æ ¸æœ¬èº«ä¸ä¼šå°†è¿›ç¨‹åˆ†é…åˆ°è¢«éš”ç¦»çš„ CPUã€‚ä¹‹åæˆ‘ä»¬å¯å°†æŒ‡å®šçš„è¿›ç¨‹ CSR 1000v è™šæ‹Ÿæœºç»‘å®šåˆ°è¢«éš”ç¦»çš„ CPU ä¸Šè¿è¡Œï¼Œè®©è¿›ç¨‹ç‹¬å  CPUï¼Œä½¿å…¶å®æ—¶æ€§å¯å¾—åˆ°ä¸€å®šç¨‹åº¦çš„æé«˜ã€‚ å¯å‚è€ƒ è¿™ä¸ªç« èŠ‚è·å–ä¸»æœº CPU æ ¸çš„ç›¸å…³ä¿¡æ¯ã€‚ 123456789root@centos7 ~]# cat /proc/cmdline |grep intel_iommu=onBOOT_IMAGE=/vmlinuz-3.10.0-1127.el7.x86_64 root=/dev/mapper/centos-root ro crashkernel=auto spectre_v2=retpoline rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet hugepagesz=1G hugepages=32 default_hugepagesz=1G intel_iommu=on iommu=pt LANG=en_US.UTF-8[root@centos7 ~]# dmesg |grep -e DMAR -e IOMMU[ 0.000000] ACPI: DMAR 000000005d6f5d70 00250 (v01 Cisco0 CiscoUCS 00000001 INTL 20091013)[ 0.000000] DMAR: IOMMU enabled æŸ¥çœ‹éš”ç¦»çš„ CPU æ ¸ä»¥åŠæ‰€æœ‰çš„ CPU æ ¸ã€‚ 1234567[root@centos7 ~]# cat /sys/devices/system/cpu/isolated1-8,37-44[root@centos7 ~]# cat /sys/devices/system/cpu/present0-71 ï¼ˆ3ï¼‰é€šè¿‡ nmcli æŒä¹…åŒ– VFs é…ç½®nmcli å¯ä»¥è®¾ç½®ç½‘å¡çš„ sriov å‚æ•°ï¼Œå¦‚ä¸‹ï¼š 1nmcli connection modify eno2 sriov.total-vfs 4 è¿˜å¯ä»¥è®¾ç½®æ¯ä¸€ä¸ª VF è®¾å¤‡çš„ MAC åœ°å€ï¼Œä¾¿äºç®¡ç†ï¼š 1nmcli connection modify eno2 sriov.vfs &#x27;0 mac=8E:DF:08:C1:D1:DE trust=true, 1 mac=5A:B9:2F:99:A6:CE trust=true, 2 mac=46:78:69:E3:71:3D trust=true, 3 mac=7E:A7:DB:3B:1B:B3 trust=true&#x27; æ‰§è¡Œä¸Šè¿°å‘½ä»¤åï¼š cat /etc/sysconfig/network-scripts/ifcfg-eno2 1234567891011121314151617181920212223242526272829TYPE=EthernetNAME=eno2UUID=64ffa204-0158-40c8-ba86-2b7aebf27619DEVICE=eno2ONBOOT=yesMTU=9216HWADDR=70:7D:B9:59:5B:AFPROXY_METHOD=noneBROWSER_ONLY=noIPV6INIT=noSRIOV_TOTAL_VFS=4SRIOV_VF0=&quot;mac=8E:DF:08:C1:D1:DE trust=true&quot;SRIOV_VF1=&quot;mac=5A:B9:2F:99:A6:CE trust=true&quot;SRIOV_VF2=&quot;mac=46:78:69:E3:71:3D trust=true&quot;SRIOV_VF3=&quot;mac=7E:A7:DB:3B:1B:B3 trust=true&quot; é‡å¯åï¼Œæ£€æŸ¥ dmesgï¼š dmesg | grep -i vf | grep -i eno2 12345678910111213141516171819202122232425[ 11.953333] ixgbe 0000:3b:00.1 eno2: SR-IOV enabled with 4 VFs[ 12.541801] ixgbe 0000:3b:00.1: setting MAC 8e:df:08:c1:d1:de on VF 0[ 12.541805] ixgbe 0000:3b:00.1: Reload the VF driver to make this change effective.[ 12.541841] ixgbe 0000:3b:00.1 eno2: VF 0 is trusted[ 12.541846] ixgbe 0000:3b:00.1: setting MAC 5a:b9:2f:99:a6:ce on VF 1[ 12.541850] ixgbe 0000:3b:00.1: Reload the VF driver to make this change effective.[ 12.541883] ixgbe 0000:3b:00.1 eno2: VF 1 is trusted[ 12.541887] ixgbe 0000:3b:00.1: setting MAC 46:78:69:e3:71:3d on VF 2[ 12.541891] ixgbe 0000:3b:00.1: Reload the VF driver to make this change effective.[ 12.541923] ixgbe 0000:3b:00.1 eno2: VF 2 is trusted[ 12.541928] ixgbe 0000:3b:00.1: setting MAC 7e:a7:db:3b:1b:b3 on VF 3[ 12.541932] ixgbe 0000:3b:00.1: Reload the VF driver to make this change effective.[ 12.541965] ixgbe 0000:3b:00.1 eno2: VF 3 is trusted ï¼ˆ4ï¼‰æ£€æŸ¥ VFå¯é€šè¿‡ lspci å’Œ ip link æ£€æŸ¥ VFï¼Œå¦‚ä¸‹ï¼š 123[root@centos7 ~]# lspci | grep -i Virtual[root@centos7 ~]# ip link show | grep -B2 vf å¯»æ‰¾ Physical Function å’Œ Virtual Function ä¹‹é—´çš„å¯¹åº”å…³ç³»ï¼š 1[root@centos7 ~]# ls -l /sys/class/net/eno1/device/ | grep virtfn VF è¢«åˆ›å»ºåï¼ŒNetworkManager è‡ªåŠ¨ç»™æ–°çš„è®¾å¤‡åˆ›å»º Connectionï¼Œå¯ä»¥ä¿®æ”¹åç§°ï¼Œå¦‚ä¸‹ï¼š nmcli connection 12345678910111213NAME UUID TYPE DEVICEeno1 2a1c8b39-7f44-321b-a65f-a93e70ab0616 ethernet eno1eno2 64ffa204-0158-40c8-ba86-2b7aebf27619 ethernet eno2enp59s16f1 19c28a93-aa36-38e6-a556-55a922a0a332 ethernet enp59s16f1enp59s16f3 428d9707-1515-3475-b356-7eb229c3f937 ethernet enp59s16f3enp59s16f5 21a8dd5f-239f-37b2-9b09-24ce0e7413bc ethernet enp59s16f5enp59s16f7 0ca0da65-64c4-314d-89a4-4213f9e4f478 ethernet enp59s16f7 ä¿®æ”¹åç§°ï¼š 1nmcli connection modify uuid 19c28a93-aa36-38e6-a556-55a922a0a332 connection.id enp59s16f1 ä¿®æ”¹ MTU å€¼ï¼Œå¹¶ç¦ç”¨ IPv4 å’Œ IPv6ï¼Œç½‘å¡å¯åŠ¨æ›´å¿« 12345nmcli connection modify enp59s16f1 ifname enp59s16f1 ipv4.method disabled ipv6.method ignore ethernet.mtu 9216 ethernet.mac-address &quot;&quot;nmcli connection up enp59s16f1nmcli connection show enp59s16f1 ä¸Šè¿°å‘½ä»¤ç”Ÿæˆçš„ ifcfg é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š [root@centos7 ~]# cat /etc/sysconfig/network-scripts/ifcfg-enp59s16f1 12345678910111213141516171819202122232425262728293031TYPE=EthernetPROXY_METHOD=noneBROWSER_ONLY=noDEFROUTE=yesIPV4_FAILURE_FATAL=noIPV6INIT=noIPV6_AUTOCONF=noIPV6_DEFROUTE=yesIPV6_FAILURE_FATAL=noIPV6_ADDR_GEN_MODE=stable-privacyNAME=enp59s16f1UUID=19c28a93-aa36-38e6-a556-55a922a0a332ONBOOT=yesAUTOCONNECT_PRIORITY=-999DEVICE=enp59s16f1MTU=9216 è¿™æ ·ï¼Œå³ä¾¿ç³»ç»Ÿé‡å¯ï¼Œä¸Šè¿°é…ç½®ä¾ç„¶èƒ½ç”Ÿæ•ˆã€‚ ä½¿ç”¨ KVM çš„è™šæ‹Ÿç½‘ç»œé€‚é…å™¨æ± ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ª VF ç½‘ç»œè®¾å¤‡çš„èµ„æºæ± ï¼Œèµ„æºæ± å†…çš„è®¾å¤‡å¯ä»¥è‡ªåŠ¨åœ°åˆ†é…ç»™è™šæ‹Ÿæœºä½¿ç”¨ã€‚ ï¼ˆ1ï¼‰åˆ›å»ºä¸€ä¸ª xml æ–‡ä»¶ã€‚[root@centos7 ~]# cat eno2_sriov_pool.xml 1234567891011&lt;network&gt; &lt;name&gt;eno2_sriov_pool&lt;/name&gt; &lt;!-- This is the name of the file you created --&gt; &lt;forward mode=&#x27;hostdev&#x27; managed=&#x27;yes&#x27;&gt; &lt;pf dev=&#x27;eno2&#x27;/&gt; &lt;!-- Use the netdev name of your SR-IOV devices PF here --&gt; &lt;/forward&gt;&lt;/network&gt; ï¼ˆ2ï¼‰æ ¹æ® xml å®šä¹‰ä¸€ä¸ªç½‘ç»œï¼Œå¹¶è®¾ç½®ä¸ºè‡ªåŠ¨é‡å¯12345virsh net-define eno2_sriov_pool.xmlvirsh net-start eno2_sriov_poolvirsh net-autostart eno2_sriov_pool [root@centos7 ~]# virsh net-dumpxml eno2_sriov_pool 123456789101112131415161718192021&lt;network connections=&#x27;1&#x27;&gt; &lt;name&gt;eno2_sriov_pool&lt;/name&gt; &lt;uuid&gt;e0842451-0137-4255-8783-305ca27f082d&lt;/uuid&gt; &lt;forward mode=&#x27;hostdev&#x27; managed=&#x27;yes&#x27;&gt; &lt;pf dev=&#x27;eno2&#x27;/&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x3b&#x27; slot=&#x27;0x10&#x27; function=&#x27;0x1&#x27;/&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x3b&#x27; slot=&#x27;0x10&#x27; function=&#x27;0x3&#x27;/&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x3b&#x27; slot=&#x27;0x10&#x27; function=&#x27;0x5&#x27;/&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x3b&#x27; slot=&#x27;0x10&#x27; function=&#x27;0x7&#x27;/&gt; &lt;/forward&gt;&lt;/network&gt; ï¼ˆ3ï¼‰ä»ç½‘ç»œé€‚é…å™¨æ± ä¸­åˆ†é…ç½‘å¡ç»™è™šæ‹Ÿæœºç”¨è¿™ç§æ–¹æ³•æ·»åŠ  SRIOV ç½‘å¡æ¯”è¾ƒç®€å•ï¼š æŒ‰ç…§å¦‚ä¸Šæ–¹æ³•æ·»åŠ ç½‘å¡ï¼Œç­‰åŒäºä»¥ä¸‹ xml é…ç½®ï¼š 1234567891011&lt;interface type=&#x27;network&#x27;&gt; &lt;mac address=&#x27;52:54:00:2d:87:99&#x27;/&gt; &lt;source network=&#x27;eno2_sriov_pool&#x27;/&gt; &lt;model type=&#x27;virtio&#x27;/&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x04&#x27; function=&#x27;0x0&#x27;/&gt;&lt;/interface&gt; å¼€æœºå dumpxml å¦‚ä¸‹ï¼š 12345678910111213141516171819 &lt;interface type=&#x27;hostdev&#x27; managed=&#x27;yes&#x27;&gt; &lt;mac address=&#x27;52:54:00:2d:87:99&#x27;/&gt; &lt;driver name=&#x27;vfio&#x27;/&gt; &lt;source&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x3b&#x27; slot=&#x27;0x10&#x27; function=&#x27;0x1&#x27;/&gt; &lt;/source&gt; &lt;model type=&#x27;virtio&#x27;/&gt; &lt;alias name=&#x27;hostdev0&#x27;/&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x0f&#x27; function=&#x27;0x0&#x27;/&gt;&lt;/interface&gt; ä½¿ç”¨ Virt-manager å®‰è£… CSR1000våœ¨ CentOS å›¾å½¢ç•Œé¢ä¸­ï¼Œæ‰“å¼€ Terminalï¼Œè¿è¡Œ virt-managerï¼ŒæŒ‰ç…§ä»¥ä¸‹æ­¥éª¤åˆ›å»º CSR1000vï¼›æ·»åŠ ç½‘å¡ï¼Œå¹¶é€‰æ‹© en2_sriov_poolã€‚ æ³¨ï¼šcsr1kv-1 çš„ç¬¬ä¸€ä¸ªç½‘å£é€‰æ‹©macvtap Bridgeæ¨¡å¼ï¼Œè¿™æ ·å°±æ— éœ€åˆ›å»ºä¸€ä¸ª Linux ç½‘æ¡¥ã€‚ä½†æ˜¯ï¼Œcsr1kv-1 å¯åŠ¨ä»¥åä¸èƒ½é€šè¿‡è¯¥æ¥å£ä¸ Linux ä¸»æœºè¿›è¡Œé€šä¿¡ï¼Œä»…èƒ½é€šè¿‡è¯¥æ¥å£è®¿é—® Linux ä¸»æœºå¤–çš„ç½‘ç»œã€‚ æ·»åŠ å®Œç½‘å¡åï¼Œç‚¹å‡»å¼€å§‹å®‰è£…ï¼Œç„¶åå°±å¯ä»¥å…³é—­è™šæ‹Ÿæœºäº†ã€‚ä¸Šè¿°æ“ä½œå®Œæˆåï¼Œvirt-manager ä¼šåœ¨**/etc/libvirtd/qemu/ç›®å½•ä¸‹åˆ›å»ºcsr1kv-1.xml**ã€‚ KVM è°ƒä¼˜é…ç½®KVM çš„è°ƒä¼˜æ¯”è¾ƒå¤æ‚ï¼Œä¸»è¦æ˜¯ NUMAã€å†…å­˜å¤§é¡µã€vCPU PIN ç­‰ï¼Œå‚è€ƒèµ„æ–™ä¸º Redhat Linux 7 PERFORMANCE TUNING GUIDEã€‚ ï¼ˆ1ï¼‰æ£€æŸ¥å¹³å°çš„èƒ½åŠ›1234567891011121314151617[root@centos7 ~]# virsh nodeinfoCPU model: x86_64CPU(s): 72CPU frequency: 999 MHzCPU socket(s): 1Core(s) per socket: 18Thread(s) per core: 2NUMA cell(s): 2Memory size: 263665612 KiB 1234567891011121314151617181920212223[root@centos7 ~]# virsh capabilities&lt;capabilities&gt; &lt;host&gt; &lt;uuid&gt;4e53df1f-5b36-6842-99ee-1369d7c68730&lt;/uuid&gt; &lt;cpu&gt; &lt;arch&gt;x86_64&lt;/arch&gt; &lt;model&gt;Skylake-Server-IBRS&lt;/model&gt; &lt;vendor&gt;Intel&lt;/vendor&gt; &lt;microcode version=&#x27;33581318&#x27;/&gt; &lt;counter name=&#x27;tsc&#x27; frequency=&#x27;2294597000&#x27; scaling=&#x27;yes&#x27;/&gt; &lt;topology sockets=&#x27;1&#x27; cores=&#x27;18&#x27; threads=&#x27;2&#x27;/&gt;â€¦â€¦ å¯æ£€æŸ¥å¹³å°çš„ CPU æ ¸æ•°ã€åˆ†å¸ƒï¼Œå†…å­˜çš„ NUMA åˆ†å¸ƒç­‰ã€‚ ï¼ˆ2ï¼‰NUMA è°ƒä¼˜1234567891011121314151617181920212223[root@centos7 ~]# numactl --hardwareavailable: 2 nodes (0-1)node 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53node 0 size: 128491 MBnode 0 free: 112157 MBnode 1 cpus: 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71node 1 size: 128994 MBnode 1 free: 124120 MBnode distances:node 0 1 0: 10 21 1: 21 10 ä¸¤é¢— CPUï¼Œæ¯é¢— CPU å„æœ‰ 128GB å†…å­˜ï¼Œåˆ†åˆ«æ˜¯ node 0 å’Œ node 1ã€‚ ï¼ˆ3ï¼‰å†…å­˜å¤§é¡µ HugePage ä»¥åŠé€æ˜å¤§é¡µ cat /proc/meminfo | grep HugePages æŸ¥çœ‹å½“å‰ç³»ç»Ÿæœ‰å¤šå°‘ä¸ªå¤§é¡µï¼š 12345678910111213[root@centos7 ~]# cat /proc/meminfo | grep HugeAnonHugePages: 1685504 kBHugePages_Total: 64HugePages_Free: 60HugePages_Rsvd: 0HugePages_Surp: 0Hugepagesize: 1048576 kB åœ¨ç³»ç»Ÿè¿è¡Œæ—¶ä¿®æ”¹å¤§é¡µæ•°é‡ï¼š 123456789101112131415161718192021[root@centos7 ~]# cat /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages16[root@centos7 ~]# echo 32 &gt; /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages[root@centos7 ~]# echo 32 &gt; /sys/devices/system/node/node1/hugepages/hugepages-1048576kB/nr_hugepages[root@centos7 ~]#[root@centos7 ~]# numastat -cm | egrep &#x27;Node|Huge&#x27;` `Node 0 Node 1 TotalAnonHugePages 10962 1528 12490HugePages_Total 32768 32768 65536HugePages_Free 32768 32768 65536HugePages_Surp 0 0 0 æ£€æŸ¥é€æ˜å¤§é¡µå‚æ•°ï¼Œåœ¨ CentOS7 ä¸Šç¼ºçœå¼€å¯ï¼›å¼€å¯äº†é€æ˜å¤§é¡µï¼Œä¸å½±å“é™æ€å¤§é¡µçš„ä½¿ç”¨ã€‚ 123cat /sys/kernel/mm/transparent_hugepage/enabled[always] madvise never ï¼ˆ4ï¼‰vCPU é’‰é€‰è®¾ç½® CPU Affinity çš„å¥½å¤„æ˜¯æé«˜ CPU ç¼“å­˜æ•ˆç‡ï¼Œé¿å…è¿›ç¨‹åœ¨å¤šä¸ª CPU æ ¸ä¹‹é—´è·³è·ƒï¼Œåˆ‡æ¢ CPU æ ¸å‡ä¼šå¯¼è‡´ç¼“å­˜ä¸­çš„æ•°æ®æ— æ•ˆï¼Œç¼“å­˜å‘½ä¸­ç‡å¤§å¹…é™ä½ï¼Œå¯¼è‡´æ•°æ®è·å–çš„å¼€é”€å±…é«˜ä¸ä¸‹ï¼ŒæŸå¤±æ€§èƒ½ã€‚ virsh vcpuinfo csr1kv-1 å¯ä»¥æŸ¥çœ‹ vCPU çš„åˆ†é…ã€‚ ï¼ˆ5ï¼‰ç¼–è¾‘ CSR 1000v çš„ XML è°ƒä¼˜å‚æ•°virsh edit csr1kv-1 å¯ä»¥ç¼–è¾‘ XML çš„å‚æ•°ï¼Œå¦‚ä¸‹ï¼š 123456789101112131415161718192021222324&lt;memoryBacking&gt; &lt;hugepages&gt; &lt;page size=&#x27;1048576&#x27; unit=&#x27;KiB&#x27;/&gt; &lt;/hugepages&gt; &lt;locked/&gt; &lt;nosharepages/&gt;&lt;/memoryBacking&gt;&lt;vcpu placement=&#x27;static&#x27;&gt;8&lt;/vcpu&gt;&lt;cputune&gt; &lt;vcpupin vcpu=&#x27;0&#x27; cpuset=&#x27;1&#x27;/&gt; &lt;vcpupin vcpu=&#x27;1&#x27; cpuset=&#x27;2&#x27;/&gt; &lt;vcpupin vcpu=&#x27;2&#x27; cpuset=&#x27;3&#x27;/&gt; &lt;vcpupin vcpu=&#x27;3&#x27; cpuset=&#x27;4&#x27;/&gt; &lt;vcpupin vcpu=&#x27;4&#x27; cpuset=&#x27;5&#x27;/&gt; &lt;vcpupin vcpu=&#x27;5&#x27; cpuset=&#x27;6&#x27;/&gt; &lt;vcpupin vcpu=&#x27;6&#x27; cpuset=&#x27;7&#x27;/&gt; &lt;vcpupin vcpu=&#x27;7&#x27; cpuset=&#x27;8&#x27;/&gt; &lt;emulatorpin cpuset=&#x27;45-52&#x27;/&gt; &lt;!-- If Hyper-threading were enabled --&gt;&lt;/cputune&gt;&lt;numatune&gt; &lt;memory mode=&#x27;strict&#x27; nodeset=&#x27;0&#x27;/&gt;&lt;/numatune&gt;&lt;cpu mode=&#x27;host-passthrough&#x27; check=&#x27;none&#x27;/&gt; &lt;memballoon model=&#x27;none&#x27;/&gt; æ³¨ï¼š**** å‚æ•°ï¼Œä»…å½“ Hyper-Threating å¼€å¯æ—¶ä½¿ç”¨ï¼›æœ‰ä¸€äº›å¹³å°å¹¶æœªå…³é—­è¶…çº¿ç¨‹ï¼Œä¾‹å¦‚ Cisco ä¸“é—¨çš„ NFV å¹³å° CSPã€‚é€šè¿‡ virsh chapabilities æŸ¥çœ‹ siblings=â€™1,37â€™ï¼Œå½“ core 1 è®¾ç½®ä¸º vcpupin æ—¶ï¼Œcore 37 åº”è®¾ç½®åˆ° emulatorpin cpuset ä¸­ã€‚ ä»¥ä¸‹å…³äº CPU å’Œå†…å­˜çš„å‚æ•°è®¾å®šå»ºè®®æ¥è‡ªäºhttps://libvirt.org/formatdomain.html å’Œ https://libvirt.org/kbase/kvm-realtime.html 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129&lt;domain type=&#x27;kvm&#x27;&gt; &lt;name&gt;csr1kv-1&lt;/name&gt; &lt;uuid&gt;59581018-6387-49df-ab09-2bcf40fc12ba&lt;/uuid&gt; &lt;memory unit=&#x27;KiB&#x27;&gt;8388608&lt;/memory&gt; &lt;currentMemory unit=&#x27;KiB&#x27;&gt;8388608&lt;/currentMemory&gt; &lt;memoryBacking&gt; &lt;hugepages&gt; &lt;page size=&#x27;1048576&#x27; unit=&#x27;KiB&#x27;/&gt;&lt;/hugepages&gt;&lt;locked/&gt; &lt;nosharepages/&gt; &lt;/memoryBacking&gt; &lt;vcpu placement=&#x27;static&#x27;&gt;8&lt;/vcpu&gt; &lt;cputune&gt; &lt;vcpupin vcpu=&#x27;0&#x27; cpuset=&#x27;1&#x27;/&gt; &lt;vcpupin vcpu=&#x27;1&#x27; cpuset=&#x27;2&#x27;/&gt; &lt;vcpupin vcpu=&#x27;2&#x27; cpuset=&#x27;3&#x27;/&gt; &lt;vcpupin vcpu=&#x27;3&#x27; cpuset=&#x27;4&#x27;/&gt; &lt;vcpupin vcpu=&#x27;4&#x27; cpuset=&#x27;5&#x27;/&gt; &lt;vcpupin vcpu=&#x27;5&#x27; cpuset=&#x27;6&#x27;/&gt; &lt;vcpupin vcpu=&#x27;6&#x27; cpuset=&#x27;7&#x27;/&gt; &lt;vcpupin vcpu=&#x27;7&#x27; cpuset=&#x27;8&#x27;/&gt; &lt;emulatorpin cpuset=&#x27;37-44&#x27;/&gt; &lt;/cputune&gt; &lt;numatune&gt; &lt;memory mode=&#x27;strict&#x27; nodeset=&#x27;0&#x27;/&gt; &lt;/numatune&gt; &lt;os&gt; &lt;type arch=&#x27;x86_64&#x27; machine=&#x27;pc-i440fx-rhel7.0.0&#x27;&gt;hvm&lt;/type&gt; &lt;boot dev=&#x27;hd&#x27;/&gt; &lt;/os&gt; &lt;features&gt; &lt;acpi/&gt; &lt;apic/&gt; &lt;/features&gt; &lt;cpu mode=&#x27;host-passthrough&#x27; check=&#x27;none&#x27;/&gt; &lt;clock offset=&#x27;utc&#x27;&gt; &lt;timer name=&#x27;rtc&#x27; tickpolicy=&#x27;catchup&#x27;/&gt; &lt;timer name=&#x27;pit&#x27; tickpolicy=&#x27;delay&#x27;/&gt; &lt;timer name=&#x27;hpet&#x27; present=&#x27;no&#x27;/&gt; &lt;/clock&gt; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt; &lt;on_reboot&gt;restart&lt;/on_reboot&gt; &lt;on_crash&gt;destroy&lt;/on_crash&gt; &lt;pm&gt; &lt;suspend-to-mem enabled=&#x27;no&#x27;/&gt; &lt;suspend-to-disk enabled=&#x27;no&#x27;/&gt; &lt;/pm&gt; &lt;devices&gt; &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt; &lt;disk type=&#x27;file&#x27; device=&#x27;disk&#x27;&gt; &lt;driver name=&#x27;qemu&#x27; type=&#x27;qcow2&#x27;/&gt; &lt;source file=&#x27;/home/root/images/csr1000v-universalk9.17.02.01v.qcow2&#x27;/&gt; &lt;target dev=&#x27;vda&#x27; bus=&#x27;virtio&#x27;/&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x07&#x27; function=&#x27;0x0&#x27;/&gt; &lt;/disk&gt; &lt;controller type=&#x27;usb&#x27; index=&#x27;0&#x27; model=&#x27;ich9-ehci1&#x27;&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x05&#x27; function=&#x27;0x7&#x27;/&gt; &lt;/controller&gt; &lt;controller type=&#x27;usb&#x27; index=&#x27;0&#x27; model=&#x27;ich9-uhci1&#x27;&gt; &lt;master startport=&#x27;0&#x27;/&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x05&#x27; function=&#x27;0x0&#x27; multifunction=&#x27;on&#x27;/&gt; &lt;/controller&gt; &lt;controller type=&#x27;usb&#x27; index=&#x27;0&#x27; model=&#x27;ich9-uhci2&#x27;&gt; &lt;master startport=&#x27;2&#x27;/&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x05&#x27; function=&#x27;0x1&#x27;/&gt; &lt;/controller&gt; &lt;controller type=&#x27;usb&#x27; index=&#x27;0&#x27; model=&#x27;ich9-uhci3&#x27;&gt; &lt;master startport=&#x27;4&#x27;/&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x05&#x27; function=&#x27;0x2&#x27;/&gt; &lt;/controller&gt; &lt;controller type=&#x27;pci&#x27; index=&#x27;0&#x27; model=&#x27;pci-root&#x27;/&gt; &lt;controller type=&#x27;virtio-serial&#x27; index=&#x27;0&#x27;&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x06&#x27; function=&#x27;0x0&#x27;/&gt; &lt;/controller&gt; &lt;interface type=&#x27;direct&#x27;&gt; &lt;mac address=&#x27;52:54:00:36:95:f0&#x27;/&gt; &lt;source dev=&#x27;eno1&#x27; mode=&#x27;bridge&#x27;/&gt; &lt;model type=&#x27;virtio&#x27;/&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x03&#x27; function=&#x27;0x0&#x27;/&gt; &lt;/interface&gt; &lt;interface type=&#x27;network&#x27;&gt; &lt;mac address=&#x27;52:54:00:2d:87:99&#x27;/&gt; &lt;source network=&#x27;eno2_sriov_pool&#x27;/&gt; &lt;model type=&#x27;virtio&#x27;/&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x04&#x27; function=&#x27;0x0&#x27;/&gt; &lt;/interface&gt; &lt;serial type=&#x27;pty&#x27;&gt; &lt;target type=&#x27;isa-serial&#x27; port=&#x27;0&#x27;&gt; &lt;model name=&#x27;isa-serial&#x27;/&gt; &lt;/target&gt; &lt;/serial&gt; &lt;console type=&#x27;pty&#x27;&gt; &lt;target type=&#x27;serial&#x27; port=&#x27;0&#x27;/&gt; &lt;/console&gt; &lt;channel type=&#x27;unix&#x27;&gt; &lt;target type=&#x27;virtio&#x27; name=&#x27;org.qemu.guest_agent.0&#x27;/&gt; &lt;address type=&#x27;virtio-serial&#x27; controller=&#x27;0&#x27; bus=&#x27;0&#x27; port=&#x27;1&#x27;/&gt; &lt;/channel&gt; &lt;channel type=&#x27;spicevmc&#x27;&gt; &lt;target type=&#x27;virtio&#x27; name=&#x27;com.redhat.spice.0&#x27;/&gt; &lt;address type=&#x27;virtio-serial&#x27; controller=&#x27;0&#x27; bus=&#x27;0&#x27; port=&#x27;2&#x27;/&gt; &lt;/channel&gt; &lt;input type=&#x27;tablet&#x27; bus=&#x27;usb&#x27;&gt; &lt;address type=&#x27;usb&#x27; bus=&#x27;0&#x27; port=&#x27;1&#x27;/&gt; &lt;/input&gt; &lt;input type=&#x27;mouse&#x27; bus=&#x27;ps2&#x27;/&gt; &lt;input type=&#x27;keyboard&#x27; bus=&#x27;ps2&#x27;/&gt; &lt;graphics type=&#x27;spice&#x27; autoport=&#x27;yes&#x27;&gt; &lt;listen type=&#x27;address&#x27;/&gt; &lt;image compression=&#x27;off&#x27;/&gt; &lt;/graphics&gt; &lt;video&gt; &lt;model type=&#x27;qxl&#x27; ram=&#x27;65536&#x27; vram=&#x27;65536&#x27; vgamem=&#x27;16384&#x27; heads=&#x27;1&#x27; primary=&#x27;yes&#x27;/&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x02&#x27; function=&#x27;0x0&#x27;/&gt; &lt;/video&gt; &lt;redirdev bus=&#x27;usb&#x27; type=&#x27;spicevmc&#x27;&gt; &lt;address type=&#x27;usb&#x27; bus=&#x27;0&#x27; port=&#x27;2&#x27;/&gt; &lt;/redirdev&gt; &lt;redirdev bus=&#x27;usb&#x27; type=&#x27;spicevmc&#x27;&gt; &lt;address type=&#x27;usb&#x27; bus=&#x27;0&#x27; port=&#x27;3&#x27;/&gt; &lt;/redirdev&gt; &lt;memballoon model=&#x27;none&#x27;/&gt; &lt;rng model=&#x27;virtio&#x27;&gt; &lt;backend model=&#x27;random&#x27;&gt;/dev/urandom&lt;/backend&gt; &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x09&#x27; function=&#x27;0x0&#x27;/&gt; &lt;/rng&gt; &lt;/devices&gt;&lt;/domain&gt; ä¸Šè¿°å‚æ•°æ•´ç†è‡ªã€ŠCisco CSR 1000v and Cisco ISRv Software Configuration Guideã€‹ å®Œæˆä¸Šè¿° XML æ–‡ä»¶çš„ç¼–è¾‘åï¼Œæ‰§è¡Œ 12345cd /etc/libvirtd/qemuvirsh define csr1kv-1.xmlvirsh start csr1kv-1 ï¼ˆ6ï¼‰åœ¨ KVM ä¸»æœºä¸Šè®¿é—® CSR1000v çš„ Consoleåœ¨ virt-manager åˆ›å»º CSR1000v è™šæ‹Ÿæœºçš„æ—¶å€™ï¼Œç¼ºçœä¼šæ·»åŠ ä¸€ä¸ª Serial Deviceã€‚ 12345[root@centos7 qemu]# virsh console 20Connected to domain CSR1000v-1Escape character is ^] CSR 1000v æš‚æ—¶ä¸èƒ½é€šè¿‡ Console é…ç½®ï¼Œéœ€è¦é€šè¿‡ virt-manager çš„å›¾å½¢åŒ–ç•Œé¢è¿›è¡Œåˆå§‹åŒ–é…ç½®ã€‚ vCloud çš„ Console è®¿é—®æ­£å¸¸ã€‚ ï¼ˆ7ï¼‰æ£€éªŒ CSR1000v çš„è°ƒä¼˜é…ç½®123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105[root@centos7 ~]# virsh listId Name State---------------------------------------------------- 6 csr1kv-1 running[root@centos7 ~]# virsh vcpuinfo 6VCPU: 0CPU: 1State: runningCPU time: 34.5sCPU Affinity: -y----------------------------------------------------------------------VCPU: 1CPU: 2State: runningCPU time: 32.0sCPU Affinity: --y---------------------------------------------------------------------VCPU: 2CPU: 3State: runningCPU time: 23.8sCPU Affinity: ---y--------------------------------------------------------------------VCPU: 3CPU: 4State: runningCPU time: 19.8sCPU Affinity: ----y-------------------------------------------------------------------VCPU: 4CPU: 5State: runningCPU time: 23.0sCPU Affinity: -----y------------------------------------------------------------------VCPU: 5CPU: 6State: runningCPU time: 23.4sCPU Affinity: ------y-----------------------------------------------------------------VCPU: 6CPU: 7State: runningCPU time: 28.5sCPU Affinity: -------y----------------------------------------------------------------VCPU: 7CPU: 8State: runningCPU time: 28.2sCPU Affinity: --------y--------------------------------------------------------------- ä»¥ä¸Šæ˜¾ç¤º CSR1000v è™šæ‹Ÿæœºçš„ CPU äº²å’Œæ€§åœ¨ 1-8 æ ¸ä¸Šã€‚ 123456789101112131415161718192021[root@centos7 ~]# numastat -c qemu-kvmPer-node process memory usage (in MBs) for PID 46895 (qemu-kvm) Node 0 Node 1 Total ------ ------ -----Huge 8192 0 8192Heap 118 0 118Stack 0 0 0Private 144 7 151------- ------ ------ -----Total 8455 7 8461 ä»¥ä¸Šæ˜¾ç¤ºï¼Œå†…å­˜ä¸»è¦ä½¿ç”¨ Node 0ã€‚ 123456789[root@centos7 ~]# numastat -vm -p 13428 | grep HugePageAnonHugePages 956.00 494.00 1450.00HugePages_Total 16384.00 16384.00 32768.00HugePages_Free 8192.00 16384.00 24576.00HugePages_Surp 0.00 0.00 0.00 ï¼ˆ8ï¼‰åœ¨ CSR1KV ä¸Šæ£€æŸ¥è™šæ‹Ÿç½‘å¡1234567891011csr1kv-1#show platform software vnic-if interface-mapping------------------------------------------------------------- Interface Name Driver Name Mac Addr------------------------------------------------------------- GigabitEthernet2 net_ixgbe_vf 5254.002d.8799 GigabitEthernet1 net_virtio 5254.0036.95f0 ä¸Šè¿°é©±åŠ¨åæ˜¾ç¤ºä¸º net_ixgbe_vf è¡¨æ˜è¯¥è™šæ‹Ÿç½‘å¡æ˜¯ä¸€ä¸ª SR-IOV æ± ä¸­åˆ†é…çš„ VF è®¾å¤‡ã€‚ Linux ä¸ŠæŠ“å–è™šæ‹Ÿç½‘å¡çš„æŠ¥æ–‡ï¼ˆå‚è€ƒï¼‰æŸ¥æ‰¾è™šæ‹Ÿæœºçš„ç½‘å¡åˆ—è¡¨ 1234567891011[root@centos7 ~]# virsh domiflist 10Interface Type Source Model MAC-------------------------------------------------------vnet0 network default virtio 52:54:00:38:71:4amacvtap0 direct eno1 virtio 52:54:00:b2:70:90vnet5 bridge net-br1 virtio 52:54:00:69:93:23 æŠ“å– vnet5 çš„æŠ¥æ–‡ 123456789[root@centos7 ~]# tcpdump -i vnet5 -w ping.pcaptcpdump: listening on vnet5, link-type EN10MB (Ethernet), capture size 262144 bytes^C49 packets captured51 packets received by filter0 packets dropped by kernel æ³¨ï¼šVF å¦‚æœè¢«åˆ†é…ç»™è™šæ‹Ÿæœºï¼Œé‚£ä¹ˆåœ¨ Linux ä¸»æœºé‡Œï¼Œé€šè¿‡ ip link åˆ™æŸ¥çœ‹ä¸åˆ°è¯¥è®¾å¤‡ï¼Œæ— æ³•é€šè¿‡ä¸Šè¿°åŠæ³•æŠ“åŒ…ã€‚ CSR 1000v çš„åˆå§‹åŒ–é…ç½®åŠ Smart License æ³¨å†Œï¼ˆ1ï¼‰CSR 1000v åˆå§‹åŒ–é…ç½®ç¤ºä¾‹éƒ¨åˆ†èŠ‚ç•¥ï¼Œå…¶ä»–ä¸ºç¼ºçœé…ç½®ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081CSR1000v-1#show sdwan running-configsystem system-ip 1.1.10.1 site-id 101 sp-organization-name CiscoBJ organization-name CiscoBJ vbond 10.75.58.51 port 12346!hostname CSR1000v-1username admin privilege 15 secret 9 $9$4&#x2F;QL2V2K4&#x2F;6H1k$XUmRNf.T7t3KDOj&#x2F;FmoNexpEypCxr482dExXHDnohSIip name-server 64.104.123.245ip route 0.0.0.0 0.0.0.0 10.75.59.1interface GigabitEthernet1 no shutdown arp timeout 1200 ip address 10.75.59.35 255.255.255.0 no ip redirects ip mtu 1500 mtu 1500 negotiation autoexitinterface Tunnel1 no shutdown ip unnumbered GigabitEthernet1 no ip redirects ipv6 unnumbered GigabitEthernet1 no ipv6 redirects tunnel source GigabitEthernet1 tunnel mode sdwanexitclock timezone CST 8 0ntp server 10.75.58.1 version 4sdwan interface GigabitEthernet1 tunnel-interface encapsulation ipsec allow-service sshd exit ï¼ˆ2ï¼‰å¸¸ç”¨å‘½ä»¤ show sdwan control local-properties show sdwan control connections show sdwan control connection-history show sdwan running-config show sdwan bfd sessions show sdwan omp peers show sdwan omp routes ï¼ˆ3ï¼‰CSR 1000v Smart License æ³¨å†ŒCSR 1000v é»˜è®¤é™é€Ÿä¸º 250Mbpsï¼Œéœ€è¦æ³¨å†Œ Smart License æ‰å¯è§£å¼€é™é€Ÿã€‚ 123CSR1000v-2#show platform hardware throughput levelThe current throughput level is 250000 kb&#x2F;s æ³¨å†Œ Smart License éœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š 1ã€ CSR 1000v å·²ç»æ³¨å†Œåˆ° vManageï¼Œæ§åˆ¶é¢è¿æ¥æ­£å¸¸ï¼› 2ã€ é…ç½® ip http client source-interface GigabitEthernet2 3ã€ sdwan interface GigabitEthernet2 tunnel-interface allow-service all â€”é’ˆå¯¹ 16.12.x ç‰ˆæœ¬ï¼›åœ¨æ–°ç‰ˆæœ¬ä¸­ä»…éœ€è¦ allow https 4ã€ CSR 1000v å¯ä»¥è®¿é—® URLï¼šhttps://tools.cisco.com/its/service/oddce/services/DDCEService å…è®¸è®¿é—® 114.114.114.114ï¼ŒCSR 1000v å¯è§£æåŸŸå tools.cisco.com æ›¿ä»£åŠæ³•ï¼Œå¢åŠ ä¸€æ¡å‘½ä»¤ ip host tools.cisco.com 72.163.4.38 æ‰§è¡Œ license smart register idtoken xxxxxx è¿›è¡Œæ³¨å†Œ show license status æŸ¥çœ‹æ³¨å†Œç»“æœ æ³¨å†Œå®Œæˆåï¼Œç³»ç»Ÿè§£å¼€é™é€Ÿï¼š 123CSR1000v-1#show platform hardware throughput levelThe current throughput level is 200000000 kb&#x2F;s æ€§èƒ½å’Œç›¸å…³é™åˆ¶ï¼ˆ1ï¼‰SRIOV çš„æ€§èƒ½åœ¨ä¸Šè¿° CSR1KV-1 å®‰è£…å¥½åï¼Œä½¿ç”¨æµ‹è¯•ä»ªè¿›è¡Œæ€§èƒ½æµ‹è¯•ï¼Œæµ‹è¯•æ¡ä»¶ä¸­ï¼Œè®¾ç½®ä¸¢åŒ…ç‡ä¸º 0%ï¼Œå…¶æ€§èƒ½å¦‚ä¸‹ï¼š Packet Site SDWAN Performance (Mbps) CEF Performance (Mbps) 128Byte 800 2843.75 256Byte 1431.26 6500.00 512Byte 2581.26 10578.13 1024Byte 3731.26 15500.00 1400Byte 4306.26 18171.88 æ³¨ï¼šä¸Šè¿°æµ‹è¯•ç»“æœéå®˜æ–¹ç»“æœï¼Œä¸åŒæœåŠ¡å™¨å’Œç½‘å¡å¯èƒ½æµ‹è¯•ç»“æœæœ‰åŒºåˆ«ï¼Œä¸Šè¿°æ€§èƒ½æ•°æ®ä»…ä¾›å‚è€ƒã€‚ ï¼ˆ2ï¼‰SRIOV çš„é™åˆ¶SRIOV çš„ä¸»è¦é™åˆ¶æ˜¯æ¯ä¸€ä¸ª VF è®¾å¤‡æ”¯æŒçš„ VLAN æ•°ï¼Œixgbevf æ‰€æ”¯æŒçš„æœ€å¤§ VLAN æ•°ä¸º 64ï¼›å› æ­¤ï¼Œåœ¨ CSR1KV ä¸­å¯¹åº”çš„è™šæ‹Ÿæ¥å£é…ç½®çš„æ´»è·ƒå­æ¥å£æ•°æœ€å¤§ä¸º 64ã€‚ é…ç½®æŒ‡å—ä¸­æœ‰å…³äº SRIOV å­æ¥å£é™åˆ¶çš„è¯´æ˜ï¼š Cisco CSR 1000v and Cisco ISRv Software Configuration Guide: SR-IOV (ixgbevf) Maximum VLANs: The maximum number of VLANs supported on PF is 64. Together, all VFs can have a total of 64 VLANs. (Intel limitation.) SR-IOV (i40evf) Maximum VLANs: The maximum number of VLANs supported on PF is 512. Together, all VFs can have a total of 512 VLANs. (Intel limitation.) Per-VF resources are managed by the PF (host) device driver. é™„å½•ï¼ˆ1ï¼‰Virt-manager è®¾ç½®è™šæœºçš„ CPU æ¨¡å¼è¯´æ˜Libvirt ä¸»è¦æ”¯æŒä¸‰ç§ CPU modeï¼š host-passthrough: libvirt ä»¤ KVM æŠŠå®¿ä¸»æœºçš„ CPU æŒ‡ä»¤é›†å…¨éƒ¨é€ä¼ ç»™è™šæ‹Ÿæœºã€‚å› æ­¤è™šæ‹Ÿæœºèƒ½å¤Ÿæœ€å¤§é™åº¦çš„ä½¿ç”¨å®¿ä¸»æœº CPU æŒ‡ä»¤é›†ï¼Œæ•…æ€§èƒ½æ˜¯æœ€å¥½çš„ã€‚ä½†æ˜¯åœ¨çƒ­è¿ç§»æ—¶ï¼Œå®ƒè¦æ±‚ç›®çš„èŠ‚ç‚¹çš„ CPU å’ŒæºèŠ‚ç‚¹çš„ä¸€è‡´ã€‚ host-model: libvirt æ ¹æ®å½“å‰å®¿ä¸»æœº CPU æŒ‡ä»¤é›†ä»é…ç½®æ–‡ä»¶ /usr/share/libvirt/cpu_map.xml é€‰æ‹©ä¸€ç§æœ€ç›¸é…çš„ CPU å‹å·ã€‚åœ¨è¿™ç§ mode ä¸‹ï¼Œè™šæ‹Ÿæœºçš„æŒ‡ä»¤é›†å¾€å¾€æ¯”å®¿ä¸»æœºå°‘ï¼Œæ€§èƒ½ç›¸å¯¹ host-passthrough è¦å·®ä¸€ç‚¹ï¼Œä½†æ˜¯çƒ­è¿ç§»æ—¶ï¼Œå®ƒå…è®¸ç›®çš„èŠ‚ç‚¹ CPU å’ŒæºèŠ‚ç‚¹çš„å­˜åœ¨ä¸€å®šçš„å·®å¼‚ã€‚ custom: è¿™ç§æ¨¡å¼ä¸‹è™šæ‹Ÿæœº CPU æŒ‡ä»¤é›†æ•°æœ€å°‘ï¼Œæ•…æ€§èƒ½ç›¸å¯¹æœ€å·®ï¼Œä½†æ˜¯å®ƒåœ¨çƒ­è¿ç§»æ—¶è·¨ä¸åŒå‹å· CPU çš„èƒ½åŠ›æœ€å¼ºã€‚æ­¤å¤–ï¼Œcustom æ¨¡å¼ä¸‹æ”¯æŒç”¨æˆ·æ·»åŠ é¢å¤–çš„æŒ‡ä»¤é›†ã€‚ ä¸‰ç§ mode çš„æ€§èƒ½æ’åºæ˜¯ï¼šhost-passthrough &gt; host-model &gt; custom å®é™…æ€§èƒ½å·®å¼‚ä¸å¤§ï¼š100%&gt; 95.84%&gt;94.73% å¼•è‡ªï¼šhttp://wsfdl.com/openstack/2018/01/02/libvirt_cpu_mode.html ï¼ˆ2ï¼‰æœ‰å…³ç½‘å¡æ¨¡å¼çš„è¯´æ˜ä½¿ç”¨ virt-manager åˆ›å»ºè™šæ‹Ÿæœºï¼Œåœ¨æ·»åŠ ç½‘å¡æ—¶ï¼Œæœ‰ 3 ä¸­é€‰æ‹©ï¼Œåˆ†åˆ«æ˜¯ e1000, rtl8139, virtioã€‚ â€œrtl8139â€è¿™ä¸ªç½‘å¡æ¨¡å¼æ˜¯ qemu-kvm é»˜è®¤çš„æ¨¡æ‹Ÿç½‘å¡ç±»å‹ï¼ŒRTL8139 æ˜¯ Realtek åŠå¯¼ä½“å…¬å¸çš„ä¸€ä¸ª 10/100M ç½‘å¡ç³»åˆ—ï¼Œæ˜¯æ›¾ç»éå¸¸æµè¡Œï¼ˆå½“ç„¶ç°åœ¨çœ‹æ¥æœ‰ç‚¹å¤è€ï¼‰ä¸”å…¼å®¹æ€§å¥½çš„ç½‘å¡ï¼Œå‡ ä¹æ‰€æœ‰çš„ç°ä»£æ“ä½œç³»ç»Ÿéƒ½å¯¹ RTL8139 ç½‘å¡é©±åŠ¨çš„æä¾›æ”¯æŒã€‚ â€œe1000â€ç³»åˆ—æä¾› Intel e1000 ç³»åˆ—çš„ç½‘å¡æ¨¡æ‹Ÿï¼Œçº¯çš„ QEMUï¼ˆé qemu-kvmï¼‰é»˜è®¤å°±æ˜¯æä¾› Intel e1000 ç³»åˆ—çš„è™šæ‹Ÿç½‘å¡ã€‚ â€œvirtioâ€ ç±»å‹æ˜¯ qemu-kvm å¯¹åŠè™šæ‹ŸåŒ– IOï¼ˆvirtioï¼‰é©±åŠ¨çš„æ”¯æŒã€‚ è¿™ä¸‰ä¸ªç½‘å¡çš„æœ€å¤§åŒºåˆ«(æ­¤å¤„æŒ‡æœ€éœ€è¦å…³æ³¨çš„åœ°æ–¹)æ˜¯é€Ÿåº¦ï¼š rtl8139 10/100Mb/s e1000 1Gb/s virtio 10Gb/s æ³¨æ„ virtio æ˜¯å”¯ä¸€å¯ä»¥è¾¾åˆ° 10Gb/s çš„ã€‚ virtio æ˜¯ä¸€ç§ I/O åŠè™šæ‹ŸåŒ–è§£å†³æ–¹æ¡ˆï¼Œæ˜¯ä¸€å¥—é€šç”¨ I/O è®¾å¤‡è™šæ‹ŸåŒ–çš„ç¨‹åºï¼Œæ˜¯å¯¹åŠè™šæ‹ŸåŒ– Hypervisor ä¸­çš„ä¸€ç»„é€šç”¨ I/O è®¾å¤‡çš„æŠ½è±¡ã€‚æä¾›äº†ä¸€å¥—ä¸Šå±‚åº”ç”¨ä¸å„ Hypervisor è™šæ‹ŸåŒ–è®¾å¤‡ï¼ˆKVMï¼ŒXenï¼ŒVMware ç­‰ï¼‰ä¹‹é—´çš„é€šä¿¡æ¡†æ¶å’Œç¼–ç¨‹æ¥å£ï¼Œå‡å°‘è·¨å¹³å°æ‰€å¸¦æ¥çš„å…¼å®¹æ€§é—®é¢˜ï¼Œå¤§å¤§æé«˜é©±åŠ¨ç¨‹åºå¼€å‘æ•ˆç‡ã€‚ ï¼ˆ3ï¼‰æœ‰å…³ MACVTAPä»¥ä¸‹å†…å®¹æ¥è‡ªï¼šhttps://www.ibm.com/developerworks/cn/linux/1312_xiawc_linuxvirtnet/index.html MACVTAP çš„å®ç°åŸºäºä¼ ç»Ÿçš„ MACVLANã€‚å’Œ TAP è®¾å¤‡ä¸€æ ·ï¼Œæ¯ä¸€ä¸ª MACVTAP è®¾å¤‡æ‹¥æœ‰ä¸€ä¸ªå¯¹åº”çš„ Linux å­—ç¬¦è®¾å¤‡ï¼Œå¹¶æ‹¥æœ‰å’Œ TAP è®¾å¤‡ä¸€æ ·çš„ IOCTL æ¥å£ï¼Œå› æ­¤èƒ½ç›´æ¥è¢« KVM/Qemu ä½¿ç”¨ï¼Œæ–¹ä¾¿åœ°å®Œæˆç½‘ç»œæ•°æ®äº¤æ¢å·¥ä½œã€‚å¼•å…¥ MACVTAP è®¾å¤‡çš„ç›®æ ‡æ˜¯ï¼šç®€åŒ–è™šæ‹ŸåŒ–ç¯å¢ƒä¸­çš„äº¤æ¢ç½‘ç»œï¼Œä»£æ›¿ä¼ ç»Ÿçš„ Linux TAP è®¾å¤‡åŠ  Bridge è®¾å¤‡ç»„åˆï¼ŒåŒæ—¶æ”¯æŒæ–°çš„è™šæ‹ŸåŒ–ç½‘ç»œæŠ€æœ¯ï¼Œå¦‚ 802.1 Qbgã€‚ MACVTAP è®¾å¤‡å’Œ VLAN è®¾å¤‡ç±»ä¼¼ï¼Œæ˜¯ä»¥ä¸€å¯¹å¤šçš„æ¯å­å…³ç³»å‡ºç°çš„ã€‚åœ¨ä¸€ä¸ªæ¯è®¾å¤‡ä¸Šå¯ä»¥åˆ›å»ºå¤šä¸ª MACVTAP å­è®¾å¤‡ï¼Œä¸€ä¸ª MACVTAP è®¾å¤‡åªæœ‰ä¸€ä¸ªæ¯è®¾å¤‡ï¼ŒMACVTAP å­è®¾å¤‡å¯ä»¥åšä¸ºæ¯è®¾å¤‡ï¼Œå†ä¸€æ¬¡åµŒå¥—çš„åˆ›å»º MACVTAP å­è®¾å¤‡ã€‚æ¯å­è®¾å¤‡ä¹‹é—´è¢«éšå«çš„æ¡¥æ¥èµ·æ¥ï¼Œæ¯è®¾å¤‡ç›¸å½“äºç°å®ä¸–ç•Œä¸­çš„äº¤æ¢æœº TRUNK å£ã€‚å®é™…ä¸Šå½“ MACVTAP è®¾å¤‡è¢«åˆ›å»ºå¹¶ä¸”æ¨¡å¼ä¸ä¸º Passthrough æ—¶ï¼Œå†…æ ¸éšå«çš„åˆ›å»ºäº† MACVLAN ç½‘ç»œï¼Œå®Œæˆè½¬å‘åŠŸèƒ½ã€‚MACVTAP è®¾å¤‡æœ‰å››ç§å·¥ä½œæ¨¡å¼ï¼šBridgeã€VEPAã€Privateï¼ŒPassthroughã€‚ Bridge æ¨¡å¼ä¸‹ï¼Œå®ƒå®Œæˆä¸ Bridge è®¾å¤‡ç±»ä¼¼åŠŸèƒ½ï¼Œæ•°æ®å¯ä»¥åœ¨å±äºåŒä¸€ä¸ªæ¯è®¾å¤‡çš„å­è®¾å¤‡é—´äº¤æ¢è½¬å‘ï¼Œè™šæ‹Ÿæœºç›¸å½“äºç®€å•æ¥å…¥äº†ä¸€ä¸ªäº¤æ¢æœºã€‚å½“å‰çš„ Linux å®ç°æœ‰ä¸€ä¸ªç¼ºé™·ï¼Œæ­¤æ¨¡å¼ä¸‹ MACVTAP å­è®¾å¤‡æ— æ³•å’Œ Linux Host é€šè®¯ï¼Œå³è™šæ‹Ÿæœºæ— æ³•å’Œ Host é€šè®¯ã€‚â€”-ç»éªŒè¯ï¼Œå±å®ã€‚ Passthrough æ¨¡å¼ä¸‹ï¼Œå†…æ ¸çš„ MACVLAN æ•°æ®å¤„ç†é€»è¾‘è¢«è·³è¿‡ï¼Œç¡¬ä»¶å†³å®šæ•°æ®å¦‚ä½•å¤„ç†ï¼Œä»è€Œé‡Šæ”¾äº† Host CPU èµ„æºã€‚ MACVTAP Passthrough æ¦‚å¿µä¸ PCI Passthrough æ¦‚å¿µä¸åŒï¼Œä¸Šå›¾è¯¦ç»†è§£é‡Šäº†ä¸¤ç§æƒ…å†µçš„åŒºåˆ«ã€‚ PCI Passthrough é’ˆå¯¹çš„æ˜¯ä»»æ„ PCI è®¾å¤‡ï¼Œä¸ä¸€å®šæ˜¯ç½‘ç»œè®¾å¤‡ï¼Œç›®çš„æ˜¯è®© Guest OS ç›´æ¥ä½¿ç”¨ Host ä¸Šçš„ PCI ç¡¬ä»¶ä»¥æé«˜æ•ˆç‡ã€‚ä»¥ X86 å¹³å°ä¸ºä¾‹ï¼Œæ•°æ®å°†é€šè¿‡éœ€è¦ç¡¬ä»¶æ”¯æŒçš„ VT-D æŠ€æœ¯ä» Guest OS ç›´æ¥ä¼ é€’åˆ° Host ç¡¬ä»¶ä¸Šã€‚è¿™æ ·åšå›ºç„¶æ•ˆç‡å¾ˆé«˜ï¼Œä½†å› ä¸ºæ¨¡æ‹Ÿå™¨å¤±å»äº†å¯¹è™šæ‹Ÿç¡¬ä»¶çš„æ§åˆ¶ï¼Œéš¾ä»¥åŒæ­¥ä¸åŒ Host ä¸Šçš„ç¡¬ä»¶çŠ¶æ€ï¼Œå› æ­¤å½“å‰åœ¨ä½¿ç”¨ PCI Passthrough çš„æƒ…å†µä¸‹éš¾ä»¥åšåŠ¨æ€è¿ç§»ã€‚ MACVTAP Passthrough ä»…ä»…é’ˆå¯¹ MACVTAP ç½‘ç»œè®¾å¤‡ï¼Œç›®çš„æ˜¯ç»•è¿‡å†…æ ¸é‡Œ MACVTAP çš„éƒ¨åˆ†è½¯ä»¶å¤„ç†è¿‡ç¨‹ï¼Œè½¬è€Œäº¤ç»™ç¡¬ä»¶å¤„ç†ã€‚åœ¨è™šæ‹ŸåŒ–æ¡ä»¶ä¸‹ï¼Œæ•°æ®è¿˜æ˜¯ä¼šå…ˆåˆ°è¾¾æ¨¡æ‹Ÿå™¨ I/O å±‚ï¼Œå†è½¬å‘åˆ°ç¡¬ä»¶ä¸Šã€‚è¿™æ ·åšæ•ˆç‡æœ‰æŸå¤±ï¼Œä½†æ¨¡æ‹Ÿå™¨ä»ç„¶æ§åˆ¶è™šæ‹Ÿç¡¬ä»¶çš„çŠ¶æ€åŠæ•°æ®çš„èµ°å‘ï¼Œå¯ä»¥åšåŠ¨æ€è¿ç§»ã€‚ ï¼ˆ4ï¼‰SR-IOV ä»‹ç»å¦‚æœç½‘å¡æ”¯æŒ SRIOVï¼Œè¯·ä½¿ç”¨ SRIOV PCI Passthroughã€‚ è½¯ä»¶æ¨¡æ‹Ÿæ˜¯é€šè¿‡ Hypervisor å±‚æ¨¡æ‹Ÿè™šæ‹Ÿç½‘å¡ï¼Œå®ç°ä¸ç‰©ç†è®¾å¤‡å®Œå…¨ä¸€æ ·çš„æ¥å£ï¼Œè™šæ‹Ÿæœºæ“ä½œç³»ç»Ÿæ— é¡»ä¿®æ”¹å°±èƒ½ç›´æ¥é©±åŠ¨è™šæ‹Ÿç½‘å¡ï¼Œå…¶æœ€å¤§çš„ç¼ºç‚¹æ˜¯æ€§èƒ½ç›¸å¯¹è¾ƒå·®ï¼› ç½‘å¡ç›´é€šæ”¯æŒè™šæ‹Ÿæœºç»•è¿‡ Hypervisor å±‚ï¼Œç›´æ¥è®¿é—®ç‰©ç† I/O è®¾å¤‡ï¼Œå…·æœ‰æœ€é«˜çš„æ€§èƒ½ï¼Œä½†æ˜¯åœ¨åŒä¸€æ—¶åˆ»ç‰©ç† I/O è®¾å¤‡åªèƒ½è¢«ä¸€ä¸ªè™šæ‹Ÿæœºç‹¬äº«ï¼› SR-IOV æ˜¯ Intel åœ¨ 2007 å¹´æå‡ºçš„è§£å†³è™šæ‹ŸåŒ–ç½‘ç»œ I/O çš„ç¡¬ä»¶æŠ€æœ¯æ–¹æ¡ˆï¼Œè¯¥æŠ€æœ¯ä¸ä»…èƒ½å¤Ÿç»§æ‰¿ç½‘å¡ç›´é€šçš„é«˜æ€§èƒ½ä¼˜åŠ¿ï¼Œè€Œä¸”åŒæ—¶æ”¯æŒç‰©ç† I/O è®¾å¤‡çš„è·¨è™šæ‹Ÿæœºå…±äº«ï¼Œå…·æœ‰è¾ƒå¥½çš„åº”ç”¨å‰æ™¯ã€‚ åŸæ–‡é“¾æ¥ï¼šhttps://blog.csdn.net/lsz137105/article/details/100752930 SR-IOVï¼ˆSingle Root I/O Virtualizationï¼‰æ˜¯ä¸€ä¸ªå°† PCIe è®¾å¤‡ï¼ˆå¦‚ç½‘å¡ï¼‰å…±äº«ç»™è™šæ‹Ÿæœºçš„æ ‡å‡†ï¼Œé€šè¿‡ä¸ºè™šæ‹Ÿæœºæä¾›ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ã€ä¸­æ–­ã€DMA æµï¼Œæ¥ç»•è¿‡ VMM å®ç°æ•°æ®è®¿é—®ã€‚ SR-IOV å¼•å…¥äº†ä¸¤ç§ PCIe functionsï¼š PFï¼ˆPhysical Functionï¼‰ï¼šåŒ…å«å®Œæ•´çš„ PCIe åŠŸèƒ½ï¼ŒåŒ…æ‹¬ SR-IOV çš„æ‰©å¼ èƒ½åŠ›ï¼Œè¯¥åŠŸèƒ½ç”¨äº SR-IOV çš„é…ç½®å’Œç®¡ç†ã€‚ VFï¼ˆVirtual Functionï¼‰ï¼šåŒ…å«è½»é‡çº§çš„ PCIe åŠŸèƒ½ã€‚æ¯ä¸€ä¸ª VF æœ‰å®ƒè‡ªå·±ç‹¬äº«çš„ PCI é…ç½®åŒºåŸŸï¼Œå¹¶ä¸”å¯èƒ½ä¸å…¶ä»– VF å…±äº«ç€åŒä¸€ä¸ªç‰©ç†èµ„æºã€‚ SR-IOV ç½‘å¡é€šè¿‡å°† SR-IOV åŠŸèƒ½é›†æˆåˆ°ç‰©ç†ç½‘å¡ä¸Šï¼Œå°†å•ä¸€çš„ç‰©ç†ç½‘å¡è™šæ‹Ÿæˆå¤šä¸ª VF æ¥å£ï¼Œæ¯ä¸ª VF æ¥å£éƒ½æœ‰å•ç‹¬çš„è™šæ‹Ÿ PCIe é€šé“ï¼Œè¿™äº›è™šæ‹Ÿçš„ PCIe é€šé“å…±ç”¨ç‰©ç†ç½‘å¡çš„ PCIe é€šé“ã€‚æ¯ä¸ªè™šæ‹Ÿæœºå¯å ç”¨ä¸€ä¸ªæˆ–å¤šä¸ª VF æ¥å£ï¼Œè¿™æ ·è™šæ‹Ÿæœºå°±å¯ä»¥ç›´æ¥è®¿é—®è‡ªå·±çš„ VF æ¥å£ï¼Œè€Œä¸éœ€è¦ Hypervisor çš„åè°ƒå¹²é¢„ï¼Œä»è€Œå¤§å¹…æå‡ç½‘ç»œååæ€§èƒ½ã€‚ ï¼ˆ5ï¼‰æ¢ç´¢è™šæ‹Ÿæœºè¿›ç¨‹æ¯ä¸€ä¸ªå®¢æˆ·æœºå°±æ˜¯å®¿ä¸»æœºä¸­çš„ä¸€ä¸ª QEMU è¿›ç¨‹ï¼Œè€Œä¸€ä¸ªå®¢æˆ·æœºçš„å¤šä¸ª vCPU å°±æ˜¯ä¸€ä¸ª QEMU è¿›ç¨‹ä¸­çš„å¤šä¸ªçº¿ç¨‹ã€‚ 123[root@centos7 ~]# ps -ef | grep qemuqemu 52595 1 99 10:37 ? 01:24:12 /usr/libexec/qemu-kvm -name csr1kv-1 -S -machine pc-i440fx-rhel7.0.0,accel=kvm,usb=off,dump-guest-core=off,mem-merge=off -cpu host -m 8192 -mem-prealloc -mem-path /dev/hugepages/libvirt/qemu/7-csr1kv-1 -realtime mlock=on -smp 8,sockets=8,cores=1,threads=1 -uuid 59581018-6387-49df-ab09-2bcf40fc12ba -no-user-config -nodefaults -chardev socket,id=charmonitor,path=/var/lib/libvirt/qemu/domain-7-csr1kv-1/monitor.sock,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=utc,driftfix=slew -global kvm-pit.lost_tick_policy=delay -no-hpet -no-shutdown -global PIIX4_PM.disable_s3=1 -global PIIX4_PM.disable_s4=1 -boot strict=on -device piix3-usb-uhci,id=usb,bus=pci.0,addr=0x1.0x2 -device virtio-serial-pci,id=virtio-serial0,bus=pci.0,addr=0x6 -drive file=/home/root/images/csr1000v-universalk9.17.02.01v.qcow2,format=qcow2,if=none,id=drive-virtio-disk0 -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x7,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 -netdev tap,fd=26,id=hostnet0,vhost=on,vhostfd=28 -device virtio-net-pci,netdev=hostnet0,id=net0,mac=52:54:00:36:95:f0,bus=pci.0,addr=0x3 -chardev pty,id=charserial0 -device isa-serial,chardev=charserial0,id=serial0 -chardev socket,id=charchannel0,path=/var/lib/libvirt/qemu/channel/target/domain-7-csr1kv-1/org.qemu.guest_agent.0,server,nowait -device virtserialport,bus=virtio-serial0.0,nr=1,chardev=charchannel0,id=channel0,name=org.qemu.guest_agent.0 -chardev spicevmc,id=charchannel1,name=vdagent -device virtserialport,bus=virtio-serial0.0,nr=2,chardev=charchannel1,id=channel1,name=com.redhat.spice.0 -spice port=5900,addr=127.0.0.1,disable-ticketing,image-compression=off,seamless-migration=on -vga qxl -global qxl-vga.ram_size=67108864 -global qxl-vga.vram_size=67108864 -global qxl-vga.vgamem_mb=16 -global qxl-vga.max_outputs=1 -device vfio-pci,host=1d:00.0,id=hostdev1,bus=pci.0,addr=0x8 -device vfio-pci,host=3b:10.1,id=hostdev0,bus=pci.0,addr=0x4 -msg timestamp=on ä½¿ç”¨ virsh å‘½ä»¤æˆ– virt-manager å¼€å¯è™šæ‹Ÿæœºï¼Œæ˜¯é€šè¿‡è°ƒç”¨/usr/libexec/qemu-kvm å¹¶é™„å¸¦è™šæ‹Ÿé…ç½®çš„å‚æ•°ï¼Œæ¥å¼€å¯ qemu-kvm çš„è¿›ç¨‹ã€‚å¯ä»¥çœ‹åˆ°ä¸Šè¿°çš„å‚æ•°æ˜¯éå¸¸å¤æ‚çš„ï¼Œlibvirt æä¾› XML å‚æ•°è¿›è¡Œç®€åŒ–ã€‚ ps -efL | grep qemu å¯ä»¥åˆ—å‡ºæ‰€æœ‰çš„çº¿ç¨‹ï¼Œä½†æ˜¯è¾“å‡ºç¯‡å¹…å¾ˆé•¿ï¼Œä¸åœ¨æ­¤åˆ—å‡ºï¼›ä½¿ç”¨ pstree å¯åˆ—å‡ºå…¶çˆ¶è¿›ç¨‹ã€çº¿ç¨‹å…³ç³»ï¼Œå¦‚ä¸‹ï¼š virt-top å¯æŸ¥çœ‹è™šæœºè¿è¡ŒçŠ¶æ€å’Œèµ„æºåˆ©ç”¨ç‡ï¼š [root@centos7 ~]# virt-top -1 å‚è€ƒèµ„æ–™è¿æ¥ https://cloud.tencent.com/developer/article/1703094 https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/performance_tuning_guide/index https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html-single/virtualization_tuning_and_optimization_guide/index https://computingforgeeks.com/how-to-create-and-configure-bridge-networking-for-kvm-in-linux/ https://software.intel.com/content/www/us/en/develop/articles/configure-sr-iov-network-virtual-functions-in-linux-kvm.html","categories":[],"tags":[{"name":"CSR1000v","slug":"CSR1000v","permalink":"https://weiborao.link/tags/CSR1000v/"},{"name":"KVM","slug":"KVM","permalink":"https://weiborao.link/tags/KVM/"},{"name":"SRIOV","slug":"SRIOV","permalink":"https://weiborao.link/tags/SRIOV/"},{"name":"NetworkManager","slug":"NetworkManager","permalink":"https://weiborao.link/tags/NetworkManager/"},{"name":"Cisco","slug":"Cisco","permalink":"https://weiborao.link/tags/Cisco/"}]}],"categories":[],"tags":[{"name":"traceroute","slug":"traceroute","permalink":"https://weiborao.link/tags/traceroute/"},{"name":"icmp","slug":"icmp","permalink":"https://weiborao.link/tags/icmp/"},{"name":"anycast","slug":"anycast","permalink":"https://weiborao.link/tags/anycast/"},{"name":"docker","slug":"docker","permalink":"https://weiborao.link/tags/docker/"},{"name":"tcpdump","slug":"tcpdump","permalink":"https://weiborao.link/tags/tcpdump/"},{"name":"wireshark","slug":"wireshark","permalink":"https://weiborao.link/tags/wireshark/"},{"name":"ThousandEyes","slug":"ThousandEyes","permalink":"https://weiborao.link/tags/ThousandEyes/"},{"name":"AWS","slug":"AWS","permalink":"https://weiborao.link/tags/AWS/"},{"name":"kvm","slug":"kvm","permalink":"https://weiborao.link/tags/kvm/"},{"name":"ztp","slug":"ztp","permalink":"https://weiborao.link/tags/ztp/"},{"name":"nfvis","slug":"nfvis","permalink":"https://weiborao.link/tags/nfvis/"},{"name":"sriov","slug":"sriov","permalink":"https://weiborao.link/tags/sriov/"},{"name":"csr1000v","slug":"csr1000v","permalink":"https://weiborao.link/tags/csr1000v/"},{"name":"hexo","slug":"hexo","permalink":"https://weiborao.link/tags/hexo/"},{"name":"CSR1000v","slug":"CSR1000v","permalink":"https://weiborao.link/tags/CSR1000v/"},{"name":"KVM","slug":"KVM","permalink":"https://weiborao.link/tags/KVM/"},{"name":"SRIOV","slug":"SRIOV","permalink":"https://weiborao.link/tags/SRIOV/"},{"name":"NetworkManager","slug":"NetworkManager","permalink":"https://weiborao.link/tags/NetworkManager/"},{"name":"Cisco","slug":"Cisco","permalink":"https://weiborao.link/tags/Cisco/"}]}